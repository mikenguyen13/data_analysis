<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 22 Experimental Design | A Guide on Data Analysis</title>
<meta name="author" content="Mike Nguyen">
<meta name="description" content="Imagine you’re a marketing manager trying to decide whether a new advertising campaign will boost sales. Or perhaps you’re an economist investigating the impact of tax incentives on consumer...">
<meta name="generator" content="bookdown 0.35 with bs4_book()">
<meta property="og:title" content="Chapter 22 Experimental Design | A Guide on Data Analysis">
<meta property="og:type" content="book">
<meta property="og:url" content="https://bookdown.org/mike/data_analysis/sec-experimental-design.html">
<meta property="og:image" content="https://bookdown.org/mike/data_analysis//images/cover.jpg">
<meta property="og:description" content="Imagine you’re a marketing manager trying to decide whether a new advertising campaign will boost sales. Or perhaps you’re an economist investigating the impact of tax incentives on consumer...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 22 Experimental Design | A Guide on Data Analysis">
<meta name="twitter:description" content="Imagine you’re a marketing manager trying to decide whether a new advertising campaign will boost sales. Or perhaps you’re an economist investigating the impact of tax incentives on consumer...">
<meta name="twitter:image" content="https://bookdown.org/mike/data_analysis//images/cover.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.6.1/transition.js"></script><script src="libs/bs3compat-0.6.1/tabs.js"></script><script src="libs/bs3compat-0.6.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){window.dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-DMNX2X65HQ');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">A Guide on Data Analysis</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="prerequisites.html"><span class="header-section-number">2</span> Prerequisites</a></li>
<li class="book-part">I. BASIC</li>
<li><a class="" href="descriptive-statistics.html"><span class="header-section-number">3</span> Descriptive Statistics</a></li>
<li><a class="" href="basic-statistical-inference.html"><span class="header-section-number">4</span> Basic Statistical Inference</a></li>
<li class="book-part">II. REGRESSION</li>
<li><a class="" href="linear-regression.html"><span class="header-section-number">5</span> Linear Regression</a></li>
<li><a class="" href="non-linear-regression.html"><span class="header-section-number">6</span> Non-Linear Regression</a></li>
<li><a class="" href="generalized-linear-models.html"><span class="header-section-number">7</span> Generalized Linear Models</a></li>
<li><a class="" href="sec-linear-mixed-models.html"><span class="header-section-number">8</span> Linear Mixed Models</a></li>
<li><a class="" href="sec-nonlinear-and-generalized-linear-mixed-models.html"><span class="header-section-number">9</span> Nonlinear and Generalized Linear Mixed Models</a></li>
<li><a class="" href="sec-nonparametric-regression.html"><span class="header-section-number">10</span> Nonparametric Regression</a></li>
<li class="book-part">III. RAMIFICATIONS</li>
<li><a class="" href="data.html"><span class="header-section-number">11</span> Data</a></li>
<li><a class="" href="variable-transformation.html"><span class="header-section-number">12</span> Variable Transformation</a></li>
<li><a class="" href="imputation-missing-data.html"><span class="header-section-number">13</span> Imputation (Missing Data)</a></li>
<li><a class="" href="model-specification-tests.html"><span class="header-section-number">14</span> Model Specification Tests</a></li>
<li><a class="" href="variable-selection.html"><span class="header-section-number">15</span> Variable Selection</a></li>
<li><a class="" href="hypothesis-testing.html"><span class="header-section-number">16</span> Hypothesis Testing</a></li>
<li><a class="" href="sec-marginal-effects.html"><span class="header-section-number">17</span> Marginal Effects</a></li>
<li><a class="" href="moderation.html"><span class="header-section-number">18</span> Moderation</a></li>
<li><a class="" href="mediation.html"><span class="header-section-number">19</span> Mediation</a></li>
<li><a class="" href="prediction-and-estimation.html"><span class="header-section-number">20</span> Prediction and Estimation</a></li>
<li class="book-part">IV. CAUSAL INFERENCE</li>
<li><a class="" href="sec-causal-inference.html"><span class="header-section-number">21</span> Causal Inference</a></li>
<li class="book-part">A. EXPERIMENTAL DESIGN</li>
<li><a class="active" href="sec-experimental-design.html"><span class="header-section-number">22</span> Experimental Design</a></li>
<li><a class="" href="sampling.html"><span class="header-section-number">23</span> Sampling</a></li>
<li><a class="" href="sec-analysis-of-variance-anova.html"><span class="header-section-number">24</span> Analysis of Variance</a></li>
<li><a class="" href="sec-multivariate-methods.html"><span class="header-section-number">25</span> Multivariate Methods</a></li>
<li class="book-part">B. QUASI-EXPERIMENTAL DESIGN</li>
<li><a class="" href="sec-quasi-experimental.html"><span class="header-section-number">26</span> Quasi-Experimental Methods</a></li>
<li><a class="" href="sec-regression-discontinuity.html"><span class="header-section-number">27</span> Regression Discontinuity</a></li>
<li><a class="" href="temporal-discontinuity-designs.html"><span class="header-section-number">28</span> Temporal Discontinuity Designs</a></li>
<li><a class="" href="sec-synthetic-difference-in-differences.html"><span class="header-section-number">29</span> Synthetic Difference-in-Differences</a></li>
<li><a class="" href="sec-difference-in-differences.html"><span class="header-section-number">30</span> Difference-in-Differences</a></li>
<li><a class="" href="sec-changes-in-changes.html"><span class="header-section-number">31</span> Changes-in-Changes</a></li>
<li><a class="" href="sec-synthetic-control.html"><span class="header-section-number">32</span> Synthetic Control</a></li>
<li><a class="" href="sec-event-studies.html"><span class="header-section-number">33</span> Event Studies</a></li>
<li><a class="" href="sec-instrumental-variables.html"><span class="header-section-number">34</span> Instrumental Variables</a></li>
<li><a class="" href="sec-matching-methods.html"><span class="header-section-number">35</span> Matching Methods</a></li>
<li class="book-part">C. OTHER CONCERNS</li>
<li><a class="" href="endogeneity.html"><span class="header-section-number">36</span> Endogeneity</a></li>
<li><a class="" href="other-biases.html"><span class="header-section-number">37</span> Other Biases</a></li>
<li><a class="" href="controls.html"><span class="header-section-number">38</span> Controls</a></li>
<li><a class="" href="directed-acyclic-graph.html"><span class="header-section-number">39</span> Directed Acyclic Graph</a></li>
<li class="book-part">V. MISCELLANEOUS</li>
<li><a class="" href="report.html"><span class="header-section-number">40</span> Report</a></li>
<li><a class="" href="exploratory-data-analysis.html"><span class="header-section-number">41</span> Exploratory Data Analysis</a></li>
<li><a class="" href="sensitivity-analysis-robustness-check.html"><span class="header-section-number">42</span> Sensitivity Analysis/ Robustness Check</a></li>
<li><a class="" href="replication-and-synthetic-data.html"><span class="header-section-number">43</span> Replication and Synthetic Data</a></li>
<li class="book-part">APPENDIX</li>
<li><a class="" href="appendix.html"><span class="header-section-number">A</span> Appendix</a></li>
<li><a class="" href="bookdown-cheat-sheet.html"><span class="header-section-number">B</span> Bookdown cheat sheet</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/mikenguyen13/data_analysis">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="sec-experimental-design" class="section level1" number="22">
<h1>
<span class="header-section-number">22</span> Experimental Design<a class="anchor" aria-label="anchor" href="#sec-experimental-design"><i class="fas fa-link"></i></a>
</h1>
<p>Imagine you’re a marketing manager trying to decide whether a new advertising campaign will boost sales. Or perhaps you’re an economist investigating the impact of tax incentives on consumer spending. In both cases, you need a way to determine <strong>causal effects</strong>—not just correlations. This is where <strong>experimental design</strong> becomes essential.</p>
<p>At its core, experimental design ensures that studies are conducted efficiently and that valid conclusions can be drawn. In business applications, experiments help quantify the effects of pricing strategies, marketing tactics, and financial interventions. A well-designed experiment <strong>reduces bias</strong>, <strong>controls variability</strong>, and <strong>maximizes the accuracy of causal inferences</strong>.</p>
<hr>
<div id="principles-of-experimental-design" class="section level2" number="22.1">
<h2>
<span class="header-section-number">22.1</span> Principles of Experimental Design<a class="anchor" aria-label="anchor" href="#principles-of-experimental-design"><i class="fas fa-link"></i></a>
</h2>
<p>A well-designed experiment follows three key principles:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Randomization</strong>: Ensures that subjects or experimental units are assigned to different groups randomly, eliminating selection bias.</li>
<li>
<strong>Replication</strong>: Increases the precision of estimates by repeating the experiment on multiple subjects.</li>
<li>
<strong>Control</strong>: Isolates the effect of treatments by using control groups or baseline conditions to minimize confounding factors.</li>
</ol>
<p>In addition to these, <strong>blocking</strong> and <strong>factorial designs</strong> further refine experimental accuracy.</p>
<hr>
</div>
<div id="sec-the-gold-standard-randomized-controlled-trials" class="section level2" number="22.2">
<h2>
<span class="header-section-number">22.2</span> The Gold Standard: Randomized Controlled Trials<a class="anchor" aria-label="anchor" href="#sec-the-gold-standard-randomized-controlled-trials"><i class="fas fa-link"></i></a>
</h2>
<p>Randomized Controlled Trials (RCTs) are the <strong>holy grail of causal inference</strong>. Their power comes from <strong>random assignment</strong>, which ensures that any differences between treatment and control groups arise <strong>only</strong> due to the intervention.</p>
<p>RCTs provide:</p>
<ul>
<li>
<strong>Unbiased estimates</strong> of treatment effects</li>
<li>
<strong>Elimination of confounding factors on average</strong> (although covariate imbalance can occur, necessitating techniques like [Rerandomization] to achieve a “platinum standard” set by <span class="citation">Tukey (<a href="references.html#ref-tukey1993tightening">1993</a>)</span>)</li>
</ul>
<p>An RCT consists of two groups:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Treatment group</strong>: Receives the intervention (e.g., a new marketing campaign, drug, or financial incentive).</li>
<li>
<strong>Control group</strong>: Does not receive the intervention, serving as a baseline.</li>
</ol>
<p>Subjects from the same population are <strong>randomly assigned</strong> to either group. This randomization ensures that <strong>any observed differences in outcomes are due solely to the treatment</strong>—not external factors.</p>
<p>However, RCTs are easier to conduct in <strong>hard sciences</strong> (e.g., medicine or physics), where treatments and environments can be tightly controlled. In <strong>social sciences</strong>, challenges arise because:</p>
<ul>
<li>Human behavior is unpredictable.</li>
<li>Some treatments are impossible or unethical to introduce (e.g., assigning individuals to poverty).</li>
<li>Real-world environments are difficult to control.</li>
</ul>
<p>To address these challenges, social scientists use <a href="sec-quasi-experimental.html#sec-quasi-experimental">Quasi-Experimental Methods</a> to approximate experimental conditions.</p>
<p>RCTs establish <a href="sec-causal-inference.html#sec-internal-validity">internal validity</a>, meaning that the observed treatment effects are <strong>causally interpretable</strong>. Even though <strong>random assignment is not the same as <em>ceteris paribus</em></strong> (holding everything else constant), it achieves a similar effect: <strong>on average</strong>, treatment and control groups should be comparable.</p>
<hr>
</div>
<div id="selection-problem" class="section level2" number="22.3">
<h2>
<span class="header-section-number">22.3</span> Selection Problem<a class="anchor" aria-label="anchor" href="#selection-problem"><i class="fas fa-link"></i></a>
</h2>
<p>A fundamental challenge in causal inference is that we never observe both potential outcomes for the same individual—only one or the other. This creates the selection problem, which we formalize below.</p>
<p>Assume we have:</p>
<ul>
<li>A <strong>binary treatment variable</strong>:<br><span class="math inline">\(D_i \in \{0,1\}\)</span>, where:
<ul>
<li>
<span class="math inline">\(D_i = 1\)</span> indicates that individual <span class="math inline">\(i\)</span> receives the treatment.</li>
<li>
<span class="math inline">\(D_i = 0\)</span> indicates that individual <span class="math inline">\(i\)</span> does <strong>not</strong> receive the treatment.</li>
</ul>
</li>
<li>The <strong>outcome of interest</strong>:<br><span class="math inline">\(Y_i\)</span>, which depends on whether the individual is treated or not:
<ul>
<li>
<span class="math inline">\(Y_{0i}\)</span>: The outcome <strong>if not treated</strong>.</li>
<li>
<span class="math inline">\(Y_{1i}\)</span>: The outcome <strong>if treated</strong>.</li>
</ul>
</li>
</ul>
<p>Thus, the <strong>potential outcomes framework</strong> is defined as:</p>
<p><span class="math display">\[
\text{Potential Outcome} =
\begin{cases}
Y_{1i}, &amp; \text{if } D_i = 1 \quad (\text{Treated}) \\
Y_{0i}, &amp; \text{if } D_i = 0 \quad (\text{Untreated})
\end{cases}
\]</span></p>
<p>However, we only <strong>observe</strong> one outcome per individual:</p>
<p><span class="math display">\[
Y_i = Y_{0i} + (Y_{1i} - Y_{0i})D_i
\]</span></p>
<p>This means that for any given person, we either observe <span class="math inline">\(Y_{1i}\)</span> or <span class="math inline">\(Y_{0i}\)</span>, but <strong>never both</strong>. Since we cannot observe counterfactuals (unless we invent a time machine), we must rely on statistical inference to estimate treatment effects.</p>
<div id="the-observed-difference-in-outcomes" class="section level3" number="22.3.1">
<h3>
<span class="header-section-number">22.3.1</span> The Observed Difference in Outcomes<a class="anchor" aria-label="anchor" href="#the-observed-difference-in-outcomes"><i class="fas fa-link"></i></a>
</h3>
<p>The goal is to estimate the difference in expected outcomes between treated and untreated individuals:</p>
<p><span class="math display">\[
E[Y_i | D_i = 1] - E[Y_i | D_i = 0]
\]</span></p>
<p>Expanding this equation:</p>
<p><span class="math display">\[
\begin{aligned}
E[Y_i | D_i = 1] - E[Y_i | D_i = 0] &amp;= (E[Y_{1i} | D_i = 1] - E[Y_{0i}|D_i = 1] ) \\
&amp;+ (E[Y_{0i} |D_i = 1] - E[Y_{0i} |D_i = 0]) \\
&amp;= (E[Y_{1i}-Y_{0i}|D_i = 1] ) \\
&amp;+ (E[Y_{0i} |D_i = 1] - E[Y_{0i} |D_i = 0])
\end{aligned}
\]</span></p>
<p>This equation decomposes the <strong>observed difference</strong> into two components:</p>
<ul>
<li><p>Treatment Effect on the Treated: <span class="math inline">\(E[Y_{1i} - Y_{0i} |D_i = 1]\)</span>, which represents the causal impact of the treatment on those who are treated.</p></li>
<li><p><strong>Selection Bias</strong>:<br><span class="math inline">\(E[Y_{0i} |D_i = 1] - E[Y_{0i} |D_i = 0]\)</span>, which captures systematic differences between treated and untreated groups <strong>even in the absence of treatment</strong>.</p></li>
</ul>
<p>Thus, the <strong>observed difference in outcomes</strong> is:</p>
<p><span class="math display">\[
\text{Observed Difference} = \text{ATT} + \text{Selection Bias}
\]</span></p>
</div>
<div id="eliminating-selection-bias-with-random-assignment" class="section level3" number="22.3.2">
<h3>
<span class="header-section-number">22.3.2</span> Eliminating Selection Bias with Random Assignment<a class="anchor" aria-label="anchor" href="#eliminating-selection-bias-with-random-assignment"><i class="fas fa-link"></i></a>
</h3>
<p>With <strong>random assignment</strong> of treatment, <span class="math inline">\(D_i\)</span> is independent of potential outcomes:</p>
<p><span class="math display">\[
E[Y_i | D_i = 1] - E[Y_i|D_i = 0] = E[Y_{1i} - Y_{0i}]
\]</span></p>
<p>This works because, under true randomization:</p>
<p><span class="math display">\[
E[Y_{0i} | D_i = 1] = E[Y_{0i} | D_i = 0]
\]</span></p>
<p>which eliminates selection bias. Consequently, the observed difference now <strong>directly estimates the true causal effect</strong>:</p>
<p><span class="math display">\[
E[Y_i | D_i = 1] - E[Y_i | D_i = 0] = E[Y_{1i} - Y_{0i}]
\]</span></p>
<p>Thus, <a href="sec-experimental-design.html#sec-the-gold-standard-randomized-controlled-trials">randomized controlled trials</a> provide an unbiased estimate of the <a href="sec-causal-inference.html#sec-average-treatment-effect">average treatment effect</a>.</p>
<hr>
</div>
<div id="another-representation-under-regression" class="section level3" number="22.3.3">
<h3>
<span class="header-section-number">22.3.3</span> Another Representation Under Regression<a class="anchor" aria-label="anchor" href="#another-representation-under-regression"><i class="fas fa-link"></i></a>
</h3>
<p>So far, we have framed the selection problem using expectations and potential outcomes. Another way to represent treatment effects is through <strong>regression models</strong>, which provide a practical framework for estimation.</p>
<p>Suppose the treatment effect is constant across individuals:</p>
<p><span class="math display">\[
Y_{1i} - Y_{0i} = \rho
\]</span></p>
<p>This implies that each treated individual experiences the same treatment effect (<span class="math inline">\(\rho\)</span>), though their baseline outcomes (<span class="math inline">\(Y_{0i}\)</span>) may vary.</p>
<p>Since we only observe <strong>one</strong> of the potential outcomes, the observed outcome can be expressed as:</p>
<p><span class="math display">\[
\begin{aligned}
Y_i &amp;= E(Y_{0i}) + (Y_{1i} - Y_{0i}) D_i + [Y_{0i} - E(Y_{0i})] \\
&amp;= \alpha + \rho D_i + \eta_i
\end{aligned}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(\alpha = E(Y_{0i})\)</span>, the expected outcome for untreated individuals.</li>
<li>
<span class="math inline">\(\rho\)</span> represents the <strong>causal treatment effect</strong>.</li>
<li>
<span class="math inline">\(\eta_i = Y_{0i} - E(Y_{0i})\)</span>, capturing individual deviations from the mean untreated outcome.</li>
</ul>
<p>Thus, the regression model provides an intuitive way to express treatment effects.</p>
<div id="conditional-expectations-and-selection-bias" class="section level4" number="22.3.3.1">
<h4>
<span class="header-section-number">22.3.3.1</span> Conditional Expectations and Selection Bias<a class="anchor" aria-label="anchor" href="#conditional-expectations-and-selection-bias"><i class="fas fa-link"></i></a>
</h4>
<p>Taking expectations conditional on treatment status:</p>
<p><span class="math display">\[
\begin{aligned}
E[Y_i |D_i = 1] &amp;= \alpha + \rho + E[\eta_i |D_i = 1] \\
E[Y_i |D_i = 0] &amp;= \alpha + E[\eta_i |D_i = 0]
\end{aligned}
\]</span></p>
<p>The observed difference in means between treated and untreated groups is:</p>
<p><span class="math display">\[
E[Y_i |D_i = 1] - E[Y_i |D_i = 0] = \rho + E[\eta_i |D_i = 1] - E[\eta_i |D_i = 0]
\]</span></p>
<p>Here, the term <span class="math inline">\(E[\eta_i |D_i = 1] -E[\eta_i |D_i = 0]\)</span> represents <strong>selection bias</strong>—the correlation between the regression error term (<span class="math inline">\(\eta_i\)</span>) and the treatment variable (<span class="math inline">\(D_i\)</span>).</p>
<p>Under random assignment, we assume that potential outcomes are <strong>independent</strong> of treatment (<span class="math inline">\(D_i\)</span>):</p>
<p><span class="math display">\[
E[\eta_i |D_i = 1] -E[\eta_i |D_i = 0] = E[Y_{0i} |D_i = 1] -E[Y_{0i}|D_i = 0] = 0
\]</span></p>
<p>Thus, under true <strong>randomization</strong>, selection bias disappears, and the observed difference directly estimates the <strong>causal effect</strong> <span class="math inline">\(\rho\)</span>.</p>
<hr>
</div>
<div id="controlling-for-additional-variables" class="section level4" number="22.3.3.2">
<h4>
<span class="header-section-number">22.3.3.2</span> Controlling for Additional Variables<a class="anchor" aria-label="anchor" href="#controlling-for-additional-variables"><i class="fas fa-link"></i></a>
</h4>
<p>In many real-world scenarios, <strong>random assignment is imperfect</strong>, and selection bias may still exist. To mitigate this, we introduce <strong>control variables</strong> (<span class="math inline">\(X_i\)</span>), such as demographic characteristics, firm size, or prior purchasing behavior.</p>
<p>If <span class="math inline">\(X_i\)</span> is <strong>uncorrelated with treatment</strong> (<span class="math inline">\(D_i\)</span>), including it in our regression model does not bias the estimate of <span class="math inline">\(\rho\)</span> but has two advantages:</p>
<ol style="list-style-type: decimal">
<li>
<strong>It reduces residual variance</strong> (<span class="math inline">\(\eta_i\)</span>), improving the precision of <span class="math inline">\(\rho\)</span>.</li>
<li>
<strong>It accounts for additional sources of variability</strong>, making the model more robust.</li>
</ol>
<p>Thus, our regression model extends to:</p>
<p><span class="math display">\[
Y_i = \alpha + \rho D_i + X_i'\gamma + \eta_i
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(X_i\)</span> represents a vector of control variables.</li>
<li>
<span class="math inline">\(\gamma\)</span> captures the effect of <span class="math inline">\(X_i\)</span> on the outcome.</li>
</ul>
</div>
<div id="example-racial-discrimination-in-hiring" class="section level4" number="22.3.3.3">
<h4>
<span class="header-section-number">22.3.3.3</span> Example: Racial Discrimination in Hiring<a class="anchor" aria-label="anchor" href="#example-racial-discrimination-in-hiring"><i class="fas fa-link"></i></a>
</h4>
<p>A famous study by <span class="citation">Bertrand and Mullainathan (<a href="references.html#ref-bertrand2004emily">2004</a>)</span> examined racial discrimination in hiring by randomly assigning Black- and White-sounding names to identical job applications. By ensuring that names were assigned randomly, the authors eliminated confounding factors like education and experience, allowing them to estimate the causal effect of race on callback rates.</p>
</div>
</div>
</div>
<div id="classical-experimental-designs" class="section level2" number="22.4">
<h2>
<span class="header-section-number">22.4</span> Classical Experimental Designs<a class="anchor" aria-label="anchor" href="#classical-experimental-designs"><i class="fas fa-link"></i></a>
</h2>
<p>Experimental designs provide structured frameworks for conducting experiments, ensuring that results are <strong>statistically valid</strong> and <strong>practically applicable</strong>. The choice of design depends on the research question, the nature of the treatment, and potential sources of variability. For a more in-depth statistical understanding of these designs, we will revisit them again in <a href="sec-analysis-of-variance-anova.html#sec-analysis-of-variance-anova">Analysis of Variance</a>.</p>
<hr>
<div id="completely-randomized-design" class="section level3" number="22.4.1">
<h3>
<span class="header-section-number">22.4.1</span> Completely Randomized Design<a class="anchor" aria-label="anchor" href="#completely-randomized-design"><i class="fas fa-link"></i></a>
</h3>
<p>In a Completely Randomized Design (CRD), each experimental unit is randomly assigned to a treatment group. This is the simplest form of experimental design and is effective when no confounding factors are present.</p>
<p><strong>Example: Email Marketing Experiment</strong></p>
<p>A company tests three different email marketing strategies (A, B, and C) to measure their effect on <strong>customer engagement</strong> (click-through rate). Customers are randomly assigned to receive one of the three emails.</p>
<p><strong>Mathematical Model</strong></p>
<p><span class="math display">\[
Y_{ij} = \mu + \tau_i + \epsilon_{ij}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(Y_{ij}\)</span> is the response variable (e.g., click-through rate).</li>
<li>
<span class="math inline">\(\mu\)</span> is the overall mean response.</li>
<li>
<span class="math inline">\(\tau_i\)</span> is the effect of treatment <span class="math inline">\(i\)</span>.</li>
<li>
<span class="math inline">\(\epsilon_{ij}\)</span> is the random error term, assumed to be normally distributed: <span class="math inline">\(\epsilon_{ij} \sim N(0, \sigma^2)\)</span>.</li>
</ul>
<div class="sourceCode" id="cb657"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulated dataset for email marketing experiment</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span>, mean<span class="op">=</span><span class="fl">50</span>, sd<span class="op">=</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span>, mean<span class="op">=</span><span class="fl">55</span>, sd<span class="op">=</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span>, mean<span class="op">=</span><span class="fl">60</span>, sd<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ANOVA to test for differences among groups</span></span>
<span><span class="va">anova_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aov.html">aov</a></span><span class="op">(</span><span class="va">response</span> <span class="op">~</span> <span class="va">group</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">anova_result</span><span class="op">)</span></span>
<span><span class="co">#&gt;             Df Sum Sq Mean Sq F value  Pr(&gt;F)   </span></span>
<span><span class="co">#&gt; group        2  306.1  153.04   6.435 0.00518 **</span></span>
<span><span class="co">#&gt; Residuals   27  642.1   23.78                   </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre></div>
<p>If the <strong>p-value</strong> in the ANOVA summary is <strong>less than 0.05</strong>, we reject the null hypothesis and conclude that at least one email strategy significantly affects engagement.</p>
</div>
<div id="randomized-block-design" class="section level3" number="22.4.2">
<h3>
<span class="header-section-number">22.4.2</span> Randomized Block Design<a class="anchor" aria-label="anchor" href="#randomized-block-design"><i class="fas fa-link"></i></a>
</h3>
<p>A Randomized Block Design (RBD) is used when experimental units can be grouped into homogeneous blocks based on a known confounding factor. Blocking helps reduce unwanted variation, increasing the precision of estimated treatment effects.</p>
<p><strong>Example: Store Layout Experiment</strong></p>
<p>A retailer tests three store layouts (A, B, and C) on sales performance. Since store location (Urban, Suburban, Rural) might influence sales, we use blocking to control for this effect.</p>
<p><strong>Mathematical Model</strong> <span class="math display">\[
Y_{ij} = \mu + \tau_i + \beta_j + \epsilon_{ij}
\]</span> where:</p>
<ul>
<li><p><span class="math inline">\(Y_{ij}\)</span> is the sales outcome for store <span class="math inline">\(i\)</span> in location <span class="math inline">\(j\)</span>.</p></li>
<li><p><span class="math inline">\(\mu\)</span> is the overall mean sales.</p></li>
<li><p><span class="math inline">\(\tau_i\)</span> is the effect of layout <span class="math inline">\(i\)</span>.</p></li>
<li><p><span class="math inline">\(\beta_j\)</span> represents the block effect (location).</p></li>
<li><p><span class="math inline">\(\epsilon_{ij}\)</span> is the random error.</p></li>
</ul>
<div class="sourceCode" id="cb658"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulated dataset for store layout experiment</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  block <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Urban"</span>, <span class="st">"Suburban"</span>, <span class="st">"Rural"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span>
<span>  layout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span>
<span>  sales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">6</span>, mean<span class="op">=</span><span class="fl">200</span>, sd<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">6</span>, mean<span class="op">=</span><span class="fl">220</span>, sd<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">6</span>, mean<span class="op">=</span><span class="fl">210</span>, sd<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ANOVA with blocking factor</span></span>
<span><span class="va">anova_block</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aov.html">aov</a></span><span class="op">(</span><span class="va">sales</span> <span class="op">~</span> <span class="va">layout</span> <span class="op">+</span> <span class="va">block</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">anova_block</span><span class="op">)</span></span>
<span><span class="co">#&gt;             Df Sum Sq Mean Sq F value Pr(&gt;F)</span></span>
<span><span class="co">#&gt; layout       2     71    35.7   0.071  0.931</span></span>
<span><span class="co">#&gt; block        2    328   164.1   0.328  0.726</span></span>
<span><span class="co">#&gt; Residuals   13   6500   500.0</span></span></code></pre></div>
<p>By including <code>block</code> in the model, we account for <strong>location effects</strong>, leading to <strong>more accurate</strong> treatment comparisons.</p>
</div>
<div id="factorial-design" class="section level3" number="22.4.3">
<h3>
<span class="header-section-number">22.4.3</span> Factorial Design<a class="anchor" aria-label="anchor" href="#factorial-design"><i class="fas fa-link"></i></a>
</h3>
<p>A Factorial Design evaluates the effects of two or more factors simultaneously, allowing for the study of interactions between variables.</p>
<p><strong>Example: Pricing and Advertising Experiment</strong></p>
<p>A company tests two pricing strategies (High, Low) and two advertising methods (TV, Social Media) on sales.</p>
<p><strong>Mathematical Model</strong> <span class="math display">\[
Y_{ijk} = \mu + \tau_i + \gamma_j + (\tau\gamma)_{ij} + \epsilon_{ijk}
\]</span></p>
<p>where:</p>
<ul>
<li><p><span class="math inline">\(\tau_i\)</span> is the effect of price level <span class="math inline">\(i\)</span>.</p></li>
<li><p><span class="math inline">\(\gamma_j\)</span> is the effect of advertising method <span class="math inline">\(j\)</span>.</p></li>
<li><p><span class="math inline">\((\tau\gamma)_{ij}\)</span> is the <strong>interaction effect</strong> between price and advertising.</p></li>
<li><p><span class="math inline">\(\epsilon_{ijk}\)</span> is the random error term.</p></li>
</ul>
<div class="sourceCode" id="cb659"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulated dataset</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span></span>
<span>  Price <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"High"</span>, <span class="st">"Low"</span><span class="op">)</span>,</span>
<span>  Advertising <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"TV"</span>, <span class="st">"Social Media"</span><span class="op">)</span>,</span>
<span>  Replicate <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate response variable (sales)</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">Sales</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">data</span>, </span>
<span>                   <span class="fl">100</span> <span class="op">+</span> </span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Price</span> <span class="op">==</span> <span class="st">"Low"</span>, <span class="fl">10</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Advertising</span> <span class="op">==</span> <span class="st">"Social Media"</span>, <span class="fl">15</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Price</span> <span class="op">==</span> <span class="st">"Low"</span> <span class="op">&amp;</span> <span class="va">Advertising</span> <span class="op">==</span> <span class="st">"Social Media"</span>, <span class="fl">5</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, sd<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Two-way ANOVA</span></span>
<span><span class="va">anova_factorial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aov.html">aov</a></span><span class="op">(</span><span class="va">Sales</span> <span class="op">~</span> <span class="va">Price</span> <span class="op">*</span> <span class="va">Advertising</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">anova_factorial</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   Df Sum Sq Mean Sq F value   Pr(&gt;F)    </span></span>
<span><span class="co">#&gt; Price              1   1364    1364   66.60 1.05e-09 ***</span></span>
<span><span class="co">#&gt; Advertising        1   3640    3640  177.67 1.72e-15 ***</span></span>
<span><span class="co">#&gt; Price:Advertising  1     15      15    0.71    0.405    </span></span>
<span><span class="co">#&gt; Residuals         36    738      20                     </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre></div>
</div>
<div id="crossover-design" class="section level3" number="22.4.4">
<h3>
<span class="header-section-number">22.4.4</span> Crossover Design<a class="anchor" aria-label="anchor" href="#crossover-design"><i class="fas fa-link"></i></a>
</h3>
<p>A Crossover Design is used when each subject receives multiple treatments in a sequential manner. This design controls for individual differences by using each subject as their own control.</p>
<p><strong>Example: Drug Trial</strong></p>
<p>Patients receive Drug A in the first period and Drug B in the second period, or vice versa.</p>
<p><strong>Mathematical Model</strong> <span class="math display">\[
Y_{ijk} = \mu + \tau_i + \pi_j + \beta_k + \epsilon_{ijk}
\]</span> where:</p>
<ul>
<li><p><span class="math inline">\(\tau_i\)</span> is the <strong>treatment effect</strong>.</p></li>
<li><p><span class="math inline">\(\pi_j\)</span> is the <strong>period effect</strong> (e.g., learning effects).</p></li>
<li><p><span class="math inline">\(\beta_k\)</span> is the <strong>subject effect</strong> (individual baseline differences).</p></li>
</ul>
<div class="sourceCode" id="cb660"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulated dataset</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  Subject <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, each <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  Period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Period 1"</span>, <span class="st">"Period 2"</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  Treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  Response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span>, mean<span class="op">=</span><span class="fl">50</span>, sd<span class="op">=</span><span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span>, mean<span class="op">=</span><span class="fl">55</span>, sd<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Crossover ANOVA</span></span>
<span><span class="va">anova_crossover</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/aov.html">aov</a></span><span class="op">(</span><span class="va">Response</span> <span class="op">~</span> <span class="va">Treatment</span> <span class="op">+</span> <span class="va">Period</span> <span class="op">+</span> <span class="fu">Error</span><span class="op">(</span><span class="va">Subject</span> <span class="op">/</span> <span class="va">Period</span><span class="op">)</span>,</span>
<span>      data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">anova_crossover</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Error: Subject</span></span>
<span><span class="co">#&gt;           Df Sum Sq Mean Sq</span></span>
<span><span class="co">#&gt; Treatment  1  63.94   63.94</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Error: Subject:Period</span></span>
<span><span class="co">#&gt;        Df Sum Sq Mean Sq</span></span>
<span><span class="co">#&gt; Period  1  21.92   21.92</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Error: Within</span></span>
<span><span class="co">#&gt;           Df Sum Sq Mean Sq F value Pr(&gt;F)  </span></span>
<span><span class="co">#&gt; Treatment  1  134.9  134.91   5.231 0.0371 *</span></span>
<span><span class="co">#&gt; Period     1    0.2    0.24   0.009 0.9237  </span></span>
<span><span class="co">#&gt; Residuals 15  386.9   25.79                 </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre></div>
</div>
<div id="split-plot-design" class="section level3" number="22.4.5">
<h3>
<span class="header-section-number">22.4.5</span> Split-Plot Design<a class="anchor" aria-label="anchor" href="#split-plot-design"><i class="fas fa-link"></i></a>
</h3>
<p>A Split-Plot Design is used when one factor is applied at the group (whole-plot) level and another at the individual (sub-plot) level. This design is particularly useful when some factors are harder or more expensive to randomize than others.</p>
<p><strong>Example: Farming Experiment</strong></p>
<p>A farm is testing two irrigation methods (Drip vs. Sprinkler) and two soil types (Clay vs. Sand) on crop yield. Since irrigation systems are installed at the farm level and are difficult to change, they are treated as the whole-plot factor. However, different soil types exist within each farm and can be tested more easily, making them the sub-plot factor.</p>
<hr>
<p><strong>Mathematical Model</strong></p>
<p>The statistical model for a <strong>Split-Plot Design</strong> is:</p>
<p><span class="math display">\[
Y_{ijk} = \mu + \alpha_i + B_k + \beta_j + (\alpha\beta)_{ij} + \epsilon_{ijk}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(Y_{ijk}\)</span> is the response (e.g., crop yield).<br>
</li>
<li>
<span class="math inline">\(\mu\)</span> is the overall mean.<br>
</li>
<li>
<span class="math inline">\(\alpha_i\)</span> is the <strong>whole-plot factor</strong> (Irrigation method).<br>
</li>
<li>
<span class="math inline">\(B_k\)</span> is the <strong>random block effect</strong> (Farm-level variation).<br>
</li>
<li>
<span class="math inline">\(\beta_j\)</span> is the <strong>sub-plot factor</strong> (Soil type).<br>
</li>
<li>
<span class="math inline">\((\alpha\beta)_{ij}\)</span> is the interaction effect between <strong>Irrigation</strong> and <strong>Soil type</strong>.<br>
</li>
<li>
<span class="math inline">\(\epsilon_{ijk} \sim N(0, \sigma^2)\)</span> represents the <strong>random error term</strong>.</li>
</ul>
<p>The key feature of the Split-Plot Design is that the whole-plot factor (<span class="math inline">\(\alpha_i\)</span>) is tested against the farm-level variance (<span class="math inline">\(B_k\)</span>), while the sub-plot factor (<span class="math inline">\(\beta_j\)</span>) is tested against individual variance (<span class="math inline">\(\epsilon_{ijk}\)</span>).</p>
<hr>
<p>We model the <strong>Split-Plot Design</strong> using a <strong>Mixed Effects Model</strong>, treating <strong>Farm</strong> as a <strong>random effect</strong> to account for variation at the whole-plot level.</p>
<div class="sourceCode" id="cb661"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulated dataset for a split-plot experiment</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  Farm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, <span class="co"># 6 farms (whole plots)</span></span>
<span>  </span>
<span>  <span class="co"># Whole-plot factor</span></span>
<span>  Irrigation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Drip"</span>, <span class="st">"Sprinkler"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>, </span>
<span>  Soil <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Clay"</span>, <span class="st">"Sand"</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>, <span class="co"># Sub-plot factor</span></span>
<span>  </span>
<span>  <span class="co"># Response variable</span></span>
<span>  Yield <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">12</span>, mean<span class="op">=</span><span class="fl">30</span>, sd<span class="op">=</span><span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">12</span>, mean<span class="op">=</span><span class="fl">35</span>, sd<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load mixed-effects model library</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mixed-effects model: Whole-plot factor (Irrigation) as a random effect</span></span>
<span><span class="va">model_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">Yield</span> <span class="op">~</span> <span class="va">Irrigation</span> <span class="op">*</span> <span class="va">Soil</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">Farm</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summary of the model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_split</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">#&gt; Formula: Yield ~ Irrigation * Soil + (1 | Farm)</span></span>
<span><span class="co">#&gt;    Data: data</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; REML criterion at convergence: 128.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled residuals: </span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -1.72562 -0.57572 -0.09767  0.60248  2.04346 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups   Name        Variance Std.Dev.</span></span>
<span><span class="co">#&gt;  Farm     (Intercept)  0.00    0.000   </span></span>
<span><span class="co">#&gt;  Residual             24.79    4.979   </span></span>
<span><span class="co">#&gt; Number of obs: 24, groups:  Farm, 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;                              Estimate Std. Error t value</span></span>
<span><span class="co">#&gt; (Intercept)                    31.771      2.033  15.629</span></span>
<span><span class="co">#&gt; IrrigationSprinkler             2.354      2.875   0.819</span></span>
<span><span class="co">#&gt; SoilSand                       -1.601      2.875  -0.557</span></span>
<span><span class="co">#&gt; IrrigationSprinkler:SoilSand    1.235      4.066   0.304</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Correlation of Fixed Effects:</span></span>
<span><span class="co">#&gt;             (Intr) IrrgtS SolSnd</span></span>
<span><span class="co">#&gt; IrrgtnSprnk -0.707              </span></span>
<span><span class="co">#&gt; SoilSand    -0.707  0.500       </span></span>
<span><span class="co">#&gt; IrrgtnSp:SS  0.500 -0.707 -0.707</span></span>
<span><span class="co">#&gt; optimizer (nloptwrap) convergence code: 0 (OK)</span></span>
<span><span class="co">#&gt; boundary (singular) fit: see help('isSingular')</span></span></code></pre></div>
<p>In this model:</p>
<ul>
<li><p>Irrigation (Whole-plot factor) is tested against Farm-level variance.</p></li>
<li><p>Soil type (Sub-plot factor) is tested against Residual variance.</p></li>
<li><p>The interaction between Irrigation × Soil is also evaluated.</p></li>
</ul>
<p>This hierarchical structure accounts for the fact that farms are not independent, improving the precision of our estimates.</p>
</div>
<div id="latin-square-design" class="section level3" number="22.4.6">
<h3>
<span class="header-section-number">22.4.6</span> Latin Square Design<a class="anchor" aria-label="anchor" href="#latin-square-design"><i class="fas fa-link"></i></a>
</h3>
<p>When two potential confounding factors exist, Latin Square Designs provide a structured way to control for these variables. This design is common in scheduling, manufacturing, and supply chain experiments.</p>
<p><strong>Example: Assembly Line Experiment</strong></p>
<p>A manufacturer wants to test three assembly methods (A, B, C) while controlling for work shifts and workstations. Since both shifts and workstations may influence production time, a Latin Square Design ensures that each method is tested once per shift and once per workstation.</p>
<p><strong>Mathematical Model</strong></p>
<p>A Latin Square Design ensures that each treatment appears exactly once in each row and column: <span class="math display">\[
Y_{ijk} = \mu + \alpha_i + \beta_j + \gamma_k + \epsilon_{ijk}
\]</span> where:</p>
<ul>
<li><p><span class="math inline">\(Y_{ijk}\)</span> is the outcome (e.g., assembly time).</p></li>
<li><p><span class="math inline">\(\mu\)</span> is the overall mean.</p></li>
<li><p><span class="math inline">\(\alpha_i\)</span> is the <strong>treatment effect</strong> (Assembly Method).</p></li>
<li><p><span class="math inline">\(\beta_j\)</span> is the <strong>row effect</strong> (Work Shift).</p></li>
<li><p><span class="math inline">\(\gamma_k\)</span> is the <strong>column effect</strong> (Workstation).</p></li>
<li><p><span class="math inline">\(\epsilon_{ijk}\)</span> is the random error term.</p></li>
</ul>
<p>This ensures that each treatment is <strong>equally balanced across both confounding factors</strong>.</p>
<hr>
<p>We implement a <strong>Latin Square Design</strong> by treating <strong>Assembly Method</strong> as the primary factor, while controlling for <strong>Shifts</strong> and <strong>Workstations</strong>.</p>
<div class="sourceCode" id="cb662"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define the Latin Square layout</span></span>
<span><span class="va">latin_square</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  Shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="co"># Rows</span></span>
<span>  Workstation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="co"># Columns</span></span>
<span>  </span>
<span>  <span class="co"># Treatments assigned in a balanced way</span></span>
<span>  Method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"C"</span>, <span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"A"</span><span class="op">)</span>, </span>
<span>  Time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">3</span>, mean <span class="op">=</span> <span class="fl">30</span>, sd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">3</span>, mean <span class="op">=</span> <span class="fl">28</span>, sd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">3</span>, mean <span class="op">=</span> <span class="fl">32</span>, sd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="co"># Assembly time</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ANOVA for Latin Square Design</span></span>
<span><span class="va">anova_latin</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/aov.html">aov</a></span><span class="op">(</span><span class="va">Time</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Shift</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Workstation</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Method</span><span class="op">)</span>,</span>
<span>      data <span class="op">=</span> <span class="va">latin_square</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">anova_latin</span><span class="op">)</span></span>
<span><span class="co">#&gt;                     Df Sum Sq Mean Sq F value Pr(&gt;F)</span></span>
<span><span class="co">#&gt; factor(Shift)        2  1.148   0.574   0.079  0.927</span></span>
<span><span class="co">#&gt; factor(Workstation)  2 24.256  12.128   1.659  0.376</span></span>
<span><span class="co">#&gt; factor(Method)       2 14.086   7.043   0.964  0.509</span></span>
<span><span class="co">#&gt; Residuals            2 14.619   7.310</span></span></code></pre></div>
<ul>
<li><p>If the p-value for “Method” is significant, we conclude that different assembly methods impact production time.</p></li>
<li><p>If “Shift” or “Workstation” is significant, it indicates systematic differences across these variables.</p></li>
</ul>
</div>
</div>
<div id="advanced-experimental-designs" class="section level2" number="22.5">
<h2>
<span class="header-section-number">22.5</span> Advanced Experimental Designs<a class="anchor" aria-label="anchor" href="#advanced-experimental-designs"><i class="fas fa-link"></i></a>
</h2>
<div id="semi-random-experiments" class="section level3" number="22.5.1">
<h3>
<span class="header-section-number">22.5.1</span> Semi-Random Experiments<a class="anchor" aria-label="anchor" href="#semi-random-experiments"><i class="fas fa-link"></i></a>
</h3>
<p>In <strong>semi-random experiments</strong>, participants are <strong>not fully randomized</strong> into treatment and control groups. Instead, a <strong>structured randomization process</strong> ensures fairness while allowing some level of causal inference.</p>
<div id="example-loan-assignment-fairness" class="section level4" number="22.5.1.1">
<h4>
<span class="header-section-number">22.5.1.1</span> Example: Loan Assignment Fairness<a class="anchor" aria-label="anchor" href="#example-loan-assignment-fairness"><i class="fas fa-link"></i></a>
</h4>
<p>A bank wants to evaluate a new loan approval policy while ensuring that the experiment does not unfairly exclude specific demographics.</p>
<p>To maintain fairness:</p>
<ol style="list-style-type: decimal">
<li>Applicants are first stratified based on income and credit history.</li>
<li>Within each stratum, a random subset is assigned to receive the new policy, while others continue under the old policy.</li>
</ol>
<div class="sourceCode" id="cb663"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create stratified groups</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  income_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Low"</span>, <span class="st">"Medium"</span>, <span class="st">"High"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Stratified randomization</span></span>
<span>  treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"New Policy"</span>, <span class="st">"Old Policy"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display the stratification results</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html">table</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">income_group</span>, <span class="va">data</span><span class="op">$</span><span class="va">treatment</span><span class="op">)</span></span>
<span><span class="co">#&gt;         </span></span>
<span><span class="co">#&gt;          New Policy Old Policy</span></span>
<span><span class="co">#&gt;   High            6          4</span></span>
<span><span class="co">#&gt;   Low             6          4</span></span>
<span><span class="co">#&gt;   Medium          3          7</span></span></code></pre></div>
<p>This approach ensures that each income group is fairly represented in both treatment and control conditions.</p>
</div>
<div id="case-study-chicago-open-enrollment-program" class="section level4" number="22.5.1.2">
<h4>
<span class="header-section-number">22.5.1.2</span> Case Study: Chicago Open Enrollment Program<a class="anchor" aria-label="anchor" href="#case-study-chicago-open-enrollment-program"><i class="fas fa-link"></i></a>
</h4>
<p>A well-known example of semi-random assignment is the <strong>Chicago Open Enrollment Program</strong> <span class="citation">(<a href="references.html#ref-cullen2005impact">Cullen, Jacob, and Levitt 2005</a>)</span>, where students could apply to choice schools.</p>
<p>However, since many schools were oversubscribed (i.e., demand exceeded supply), they used a random lottery system to allocate spots.</p>
<p>Thus, while <strong>enrollment itself was not fully random</strong>, the <strong>lottery outcomes were random</strong>, allowing researchers to estimate the <a href="sec-causal-inference.html#sec-intention-to-treat-effect">Intent-to-Treat effect</a> while acknowledging that not all students who won the lottery actually enrolled.</p>
<p>This situation presents a classic case where:</p>
<ul>
<li>
<strong>School choice is not random</strong>: Families self-select into applying to certain schools.</li>
<li>
<strong>Lottery outcomes are random</strong>: Among those who apply, winning or losing the lottery is as good as a <strong>random assignment</strong>.</li>
</ul>
<p>Let:</p>
<ul>
<li>
<span class="math inline">\(Enroll_{ij} = 1\)</span> if student <span class="math inline">\(i\)</span> enrolls in school <span class="math inline">\(j\)</span>, and <span class="math inline">\(0\)</span> otherwise.</li>
<li>
<span class="math inline">\(Win_{ij} = 1\)</span> if student <span class="math inline">\(i\)</span> <strong>wins the lottery</strong>, and <span class="math inline">\(0\)</span> otherwise.</li>
<li>
<span class="math inline">\(Apply_{ij} = 1\)</span> if student <span class="math inline">\(i\)</span> <strong>applies</strong> to school <span class="math inline">\(j\)</span>.</li>
</ul>
<p>We define:</p>
<p><span class="math display">\[
\delta_j = E[Y_i | Enroll_{ij} = 1, Apply_{ij} = 1] - E[Y_i | Enroll_{ij} = 0, Apply_{ij} = 1]
\]</span></p>
<p><span class="math display">\[
\theta_j = E[Y_i | Win_{ij} = 1, Apply_{ij} = 1] - E[Y_i | Win_{ij} = 0, Apply_{ij} = 1]
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(\delta_j\)</span> is the <strong>treatment effect</strong> (impact of actual school enrollment).</li>
<li>
<span class="math inline">\(\theta_j\)</span> is the <a href="sec-causal-inference.html#sec-intention-to-treat-effect">intent-to-treat effect</a> (impact of winning the lottery).</li>
</ul>
<p>Since <strong>not all winners enroll</strong>, we know that:</p>
<p><span class="math display">\[
\delta_j \neq \theta_j
\]</span></p>
<p>Thus, we can only estimate <span class="math inline">\(\theta_j\)</span> directly, and need an additional method to recover <span class="math inline">\(\delta_j\)</span>.</p>
<p>This distinction is crucial because simply comparing lottery winners and losers does not measure the true effect of enrollment—only the effect of being given the opportunity to enroll.</p>
<p>To estimate the treatment effect (<span class="math inline">\(\delta_j\)</span>), we use an Instrumental Variable approach:</p>
<p><span class="math display">\[
\delta_j = \frac{E[Y_i | W_{ij} = 1, A_{ij} = 1] - E[Y_i | W_{ij} = 0, A_{ij} = 1]}{P(Enroll_{ij} = 1 | W_{ij} = 1, A_{ij} = 1) - P(Enroll_{ij} = 1 | W_{ij} = 0, A_{ij} = 1)}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(P(Enroll_{ij} = 1 | W_{ij} = 1, A_{ij} = 1)\)</span> = probability of enrolling <strong>if winning the lottery</strong>.</li>
<li>
<span class="math inline">\(P(Enroll_{ij} = 1 | W_{ij} = 0, A_{ij} = 1)\)</span> = probability of enrolling <strong>if losing the lottery</strong>.</li>
</ul>
<p>This adjustment accounts for the fact that some lottery winners do not enroll, and thus the observed effect (<span class="math inline">\(\theta_j\)</span>) underestimates the true treatment effect (<span class="math inline">\(\delta_j\)</span>).</p>
<p>This Instrumental Variable approach corrects for <strong>selection bias</strong> by leveraging <strong>randomized lottery assignment</strong>.</p>
<hr>
<p><strong>Numerical Example</strong></p>
<p>Assume <strong>10 students win</strong> the lottery and <strong>10 students lose</strong>.</p>
<p><strong>For Winners:</strong></p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="20%">
<col width="9%">
<col width="25%">
<col width="25%">
<col width="19%">
</colgroup>
<thead><tr class="header">
<th>Type</th>
<th>Count</th>
<th>Selection Effect</th>
<th>Treatment Effect</th>
<th>Total Effect</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Always Takers</td>
<td>1</td>
<td>+0.2</td>
<td>+1</td>
<td>+1.2</td>
</tr>
<tr class="even">
<td>Compliers</td>
<td>2</td>
<td>0</td>
<td>+1</td>
<td>+1</td>
</tr>
<tr class="odd">
<td>Never Takers</td>
<td>7</td>
<td>-0.1</td>
<td>0</td>
<td>-0.1</td>
</tr>
</tbody>
</table></div>
<p><strong>For Losers:</strong></p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="20%">
<col width="9%">
<col width="25%">
<col width="25%">
<col width="19%">
</colgroup>
<thead><tr class="header">
<th>Type</th>
<th>Count</th>
<th>Selection Effect</th>
<th>Treatment Effect</th>
<th>Total Effect</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Always Takers</td>
<td>1</td>
<td>+0.2</td>
<td>+1</td>
<td>+1.2</td>
</tr>
<tr class="even">
<td>Compliers</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>Never Takers</td>
<td>7</td>
<td>-0.1</td>
<td>0</td>
<td>-0.1</td>
</tr>
</tbody>
</table></div>
<hr>
<p>Computing <a href="sec-causal-inference.html#sec-intention-to-treat-effect">Intent-to-Treat Effect</a></p>
<p>We compute the <strong>expected outcome</strong> for those who <strong>won</strong> and <strong>lost</strong> the lottery.</p>
<p><span class="math display">\[
\begin{aligned}
E[Y_i | W_{ij} = 1, A_{ij} = 1] &amp;= \frac{1(1.2) + 2(1) + 7(-0.1)}{10} = 0.25 \\
E[Y_i | W_{ij} = 0, A_{ij} = 1] &amp;= \frac{1(1.2) + 2(0) + 7(-0.1)}{10} = 0.05
\end{aligned}
\]</span></p>
<p>Thus, the <a href="sec-causal-inference.html#sec-intention-to-treat-effect">Intent-to-Treat Effect</a> is:</p>
<p><span class="math display">\[
\text{Intent-to-Treat Effect} = 0.25 - 0.05 = 0.2
\]</span></p>
<hr>
<p>Now, we calculate the <strong>probability of enrollment</strong> for lottery winners and losers:</p>
<p><span class="math display">\[
\begin{aligned}
P(Enroll_{ij} = 1 | W_{ij} = 1, A_{ij} = 1) &amp;= \frac{1+2}{10} = 0.3 \\
P(Enroll_{ij} = 1 | W_{ij} = 0, A_{ij} = 1) &amp;= \frac{1}{10} = 0.1
\end{aligned}
\]</span></p>
<p>Using the formula for treatment effect (<span class="math inline">\(\delta\)</span>):</p>
<p><span class="math display">\[
\text{Treatment Effect} = \frac{0.2}{0.3 - 0.1} = 1
\]</span></p>
<p>This confirms that the <strong>true treatment effect</strong> is <strong>1 unit</strong>.</p>
<hr>
<p>To account for additional factors (<span class="math inline">\(X_i\)</span>), we extend the model as follows:</p>
<p><span class="math display">\[
Y_{ia} = \delta W_{ia} + \lambda L_{ia} + X_i \theta + u_{ia}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(\delta\)</span> = <a href="sec-causal-inference.html#sec-intention-to-treat-effect">Intent-to-Treat effect</a>
</li>
<li>
<span class="math inline">\(\lambda\)</span> = <strong>True treatment effect</strong>
</li>
<li>
<span class="math inline">\(W\)</span> = Whether a student <strong>wins</strong> the lottery</li>
<li>
<span class="math inline">\(L\)</span> = Whether a student <strong>enrolls</strong> in the school</li>
<li>
<span class="math inline">\(X_i \theta\)</span> = Control variables (i.e., reweighting of lottery), but would not affect treatment effect <span class="math inline">\(E(\delta)\)</span>
</li>
</ul>
<p>Since <strong>choosing to apply to a lottery is not random</strong>, we must consider the following:</p>
<p><span class="math display">\[
E(\lambda) \neq E(\lambda_1)
\]</span></p>
<p>This demonstrates why <strong>lottery-based assignment</strong> is a useful but imperfect tool for <a href="sec-causal-inference.html#sec-causal-inference">causal inference</a>—winning the lottery is random, but <strong>who applies</strong> is not.</p>
<hr>
</div>
</div>
<div id="re-randomization" class="section level3" number="22.5.2">
<h3>
<span class="header-section-number">22.5.2</span> Re-Randomization<a class="anchor" aria-label="anchor" href="#re-randomization"><i class="fas fa-link"></i></a>
</h3>
<p>In standard randomization, baseline covariates are only balanced on average, meaning imbalance can still occur due to random chance. Re-randomization eliminates bad randomizations by checking balance before the experiment begins <span class="citation">(<a href="references.html#ref-morgan2012rerandomization">Morgan and Rubin 2012</a>)</span>.</p>
<p><strong>Key Motivations for Re-Randomization</strong></p>
<ul>
<li>
<strong>Randomization does not guarantee balance</strong>:
<ul>
<li>Example: For <strong>10 covariates</strong>, the probability of at least one imbalance at <span class="math inline">\(\alpha = 0.05\)</span> is:<br><span class="math display">\[  
1 - (1 - 0.05)^{10} = 0.40 = 40\%  
\]</span><br>
</li>
<li>This means a high chance of some imbalance across treatment groups.<br>
</li>
</ul>
</li>
<li>
<strong>Re-randomization increases precision</strong>: If covariates correlate with the outcome, improving covariate balance improves treatment effect estimation</li>
<li>
<strong>Accounting for re-randomization in inference</strong>: Since re-randomization filters out bad assignments, it is equivalent to increasing the sample size and must be considered when computing standard errors.</li>
<li>
<strong>Alternative balancing techniques</strong>:
<ul>
<li>Stratified randomization <span class="citation">(<a href="references.html#ref-johansson2022rerandomization">Johansson and Schultzberg 2022</a>)</span>.</li>
<li>Matched randomization <span class="citation">(<a href="references.html#ref-greevy2004optimal">Greevy et al. 2004</a>; <a href="references.html#ref-kapelner2014matching">Kapelner and Krieger 2014</a>)</span>.</li>
<li>Minimization <span class="citation">(<a href="references.html#ref-pocock1975sequential">Pocock and Simon 1975</a>)</span>.</li>
</ul>
</li>
</ul>
<div class="float">
<img src="images/The-Randomization-Procedure.png" title="Figure from USC Schaeffer Center" style="width:80.0%" alt="Figure from USC Schaeffer Center"><div class="figcaption">Figure from USC Schaeffer Center</div>
</div>
<hr>
<p><strong>Example: Balancing Experimental Groups</strong></p>
<p>An online retailer is testing two website designs (A and B) but wants to ensure that key customer demographics (e.g., age) are balanced across treatment groups.</p>
<p>We define a balance criterion to check if the mean age difference between groups is acceptable before proceeding.</p>
<div class="sourceCode" id="cb664"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define balance criterion: Ensure mean age difference &lt; 1 year</span></span>
<span><span class="va">balance_criterion</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html">mean</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">age</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">group</span> <span class="op">==</span> <span class="st">"A"</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html">mean</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">age</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">group</span> <span class="op">==</span> <span class="st">"B"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Generate randomized groups, repeat until balance criterion is met</span></span>
<span><span class="kw">repeat</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, mean <span class="op">=</span> <span class="fl">35</span>, sd <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">balance_criterion</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="kw">break</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Check final group means</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/tapply.html">tapply</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">age</span>, <span class="va">data</span><span class="op">$</span><span class="va">group</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="co">#&gt;        A        B </span></span>
<span><span class="co">#&gt; 35.91079 35.25483</span></span></code></pre></div>
<div id="rerandomization-criterion" class="section level4" number="22.5.2.1">
<h4>
<span class="header-section-number">22.5.2.1</span> Rerandomization Criterion<a class="anchor" aria-label="anchor" href="#rerandomization-criterion"><i class="fas fa-link"></i></a>
</h4>
<p>Re-randomization is based on a function of the covariate matrix (<span class="math inline">\(\mathbf{X}\)</span>) and treatment assignments (<span class="math inline">\(\mathbf{W}\)</span>).</p>
<p><span class="math display">\[
W_i =
\begin{cases}
1, &amp; \text{if treated} \\
0, &amp; \text{if control}
\end{cases}
\]</span></p>
<p>A common approach is to use Mahalanobis Distance to measure covariate balance between treatment and control groups:</p>
<p><span class="math display">\[
\begin{aligned}
M &amp;= (\bar{\mathbf{X}}_T - \bar{\mathbf{X}}_C)' \text{cov}(\bar{\mathbf{X}}_T - \bar{\mathbf{X}}_C)^{-1} (\bar{\mathbf{X}}_T - \bar{\mathbf{X}}_C) \\
&amp;= (\frac{1}{n_T} + \frac{1}{n_C})^{-1} (\bar{\mathbf{X}}_T - \bar{\mathbf{X}}_C)' \text{cov}(\mathbf{X})^{-1} (\bar{\mathbf{X}}_T - \bar{\mathbf{X}}_C)
\end{aligned}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(\bar{\mathbf{X}}_T\)</span> and <span class="math inline">\(\bar{\mathbf{X}}_C\)</span> are the mean covariate values for treatment and control groups.</li>
<li>
<span class="math inline">\(\text{cov}(\mathbf{X})\)</span> is the covariance matrix of the covariates.</li>
<li>
<span class="math inline">\(n_T\)</span> and <span class="math inline">\(n_C\)</span> are the sample sizes for treatment and control groups.</li>
</ul>
<p>If the sample size is large and randomization is pure, then <span class="math inline">\(M\)</span> follows a chi-squared distribution:</p>
<p><span class="math display">\[
M \sim \chi^2_k
\]</span></p>
<p>where <span class="math inline">\(k\)</span> is the number of covariates to be balanced.</p>
<hr>
<p><strong>Choosing the Rerandomization Threshold</strong> (<span class="math inline">\(M &gt; a\)</span>)</p>
<p>Define <span class="math inline">\(p_a\)</span> as the probability of accepting a randomization:</p>
<ul>
<li>Smaller <span class="math inline">\(p_a\)</span> → Stronger balance, but longer computation time.</li>
<li>Larger <span class="math inline">\(p_a\)</span> → Faster randomization, but weaker balance.</li>
</ul>
<p>A rule of thumb is to re-randomize whenever:</p>
<p><span class="math display">\[
M &gt; a
\]</span></p>
<p>where <span class="math inline">\(a\)</span> is chosen based on acceptable balance thresholds.</p>
<hr>
<p>We apply Mahalanobis Distance as a balance criterion to ensure that treatment and control groups are well-matched before proceeding with the experiment.</p>
<div class="sourceCode" id="cb665"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/">MASS</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate a dataset with two covariates</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span><span class="op">(</span><span class="va">n</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Covariate1"</span>, <span class="st">"Covariate2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Balance function using Mahalanobis Distance</span></span>
<span><span class="va">balance_criterion</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">group</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">X_treat</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">group</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span></span>
<span>  <span class="va">X_control</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">group</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">mean_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">X_treat</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">X_control</span><span class="op">)</span></span>
<span>  <span class="va">cov_inv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/solve-methods.html">solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/t.html">t</a></span><span class="op">(</span><span class="va">mean_diff</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">cov_inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">mean_diff</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># Acceptable threshold </span></span>
<span>  <span class="co"># (chi-squared critical value for k = 2, alpha = 0.05)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">M</span> <span class="op">&lt;</span> <span class="fl">3.84</span><span class="op">)</span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Repeat randomization until balance is met</span></span>
<span><span class="kw">repeat</span> <span class="op">{</span></span>
<span>  <span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">balance_criterion</span><span class="op">(</span><span class="va">X</span>, <span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="kw">break</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Display final balance check</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html">table</a></span><span class="op">(</span><span class="va">group</span><span class="op">)</span></span>
<span><span class="co">#&gt; group</span></span>
<span><span class="co">#&gt;  0  1 </span></span>
<span><span class="co">#&gt; 50 50</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">group</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span><span class="op">)</span>  <span class="co"># Treatment group means</span></span>
<span><span class="co">#&gt; Covariate1 Covariate2 </span></span>
<span><span class="co">#&gt;  0.2469635  0.1918521</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">group</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">]</span><span class="op">)</span>  <span class="co"># Control group means</span></span>
<span><span class="co">#&gt;  Covariate1  Covariate2 </span></span>
<span><span class="co">#&gt;  0.01717088 -0.14281124</span></span></code></pre></div>
</div>
</div>
<div id="two-stage-randomized-experiments" class="section level3" number="22.5.3">
<h3>
<span class="header-section-number">22.5.3</span> Two-Stage Randomized Experiments<a class="anchor" aria-label="anchor" href="#two-stage-randomized-experiments"><i class="fas fa-link"></i></a>
</h3>
<p>A <strong>two-stage randomized experiment</strong> involves <strong>sequential interventions</strong>, where treatment assignments depend on earlier responses. This design is widely used in:</p>
<ul>
<li>
<strong>Adaptive Learning</strong>: Adjusting educational content based on student progress.</li>
<li>
<strong>Personalized Advertising</strong>: Targeting follow-up ads based on engagement.</li>
<li>
<strong>Medical Trials</strong>: Adapting treatments based on patient response.</li>
</ul>
<p>By introducing <strong>a second randomization stage</strong>, researchers can evaluate:</p>
<ol style="list-style-type: decimal">
<li><strong>The effect of initial treatments.</strong></li>
<li><strong>The effect of follow-up treatments.</strong></li>
<li><strong>Potential interactions between the two stages.</strong></li>
</ol>
<hr>
<div id="example-personalized-advertising-experiment" class="section level4" number="22.5.3.1">
<h4>
<span class="header-section-number">22.5.3.1</span> Example: Personalized Advertising Experiment<a class="anchor" aria-label="anchor" href="#example-personalized-advertising-experiment"><i class="fas fa-link"></i></a>
</h4>
<p>A company tests two initial ad campaigns (Ad A vs. Ad B). After observing customer engagement, they apply a second-stage intervention (e.g., Discount vs. No Discount).</p>
<p>The two-stage experiment can be modeled as:</p>
<p><span class="math display">\[
Y_{ijk} = \mu + \alpha_i + \beta_{j(i)} + \epsilon_{ijk}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(\mu\)</span> = Overall mean outcome (e.g., conversion rate).</li>
<li>
<span class="math inline">\(\alpha_i\)</span> = Effect of first-stage intervention (<span class="math inline">\(i\)</span> = Ad A or Ad B).</li>
<li>
<span class="math inline">\(\beta_{j(i)}\)</span> = Effect of second-stage intervention, nested within first-stage groups.</li>
<li>
<span class="math inline">\(\epsilon_{ijk}\)</span> = Random error term.</li>
</ul>
<p>The nested structure ensures that the second-stage treatment (<span class="math inline">\(\beta_{j(i)}\)</span>) is assigned within each first-stage treatment group.</p>
<hr>
<div class="sourceCode" id="cb666"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate first-stage randomization (Initial Ad)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  stage1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Ad A"</span>, <span class="st">"Ad B"</span><span class="op">)</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  stage2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">100</span><span class="op">)</span>  <span class="co"># Placeholder for second-stage randomization</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Second-stage assignment based on first-stage response</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">stage2</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">stage1</span> <span class="op">==</span> <span class="st">"Ad A"</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Discount"</span>, <span class="st">"No Discount"</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">stage1</span> <span class="op">==</span> <span class="st">"Ad A"</span><span class="op">)</span>,</span>
<span>           replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">stage2</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">stage1</span> <span class="op">==</span> <span class="st">"Ad B"</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Discount"</span>, <span class="st">"No Discount"</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">stage1</span> <span class="op">==</span> <span class="st">"Ad B"</span><span class="op">)</span>,</span>
<span>           replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display final randomization</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html">table</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">stage1</span>, <span class="va">data</span><span class="op">$</span><span class="va">stage2</span><span class="op">)</span></span>
<span><span class="co">#&gt;       </span></span>
<span><span class="co">#&gt;        Discount No Discount</span></span>
<span><span class="co">#&gt;   Ad A       24          33</span></span>
<span><span class="co">#&gt;   Ad B       22          21</span></span></code></pre></div>
<p>This structure ensures:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Fair assignment</strong> of initial ads.</p></li>
<li><p><strong>Adaptive targeting</strong> in the second stage based on user engagement.</p></li>
</ol>
</div>
</div>
<div id="two-stage-randomized-experiments-with-interference-and-noncompliance" class="section level3" number="22.5.4">
<h3>
<span class="header-section-number">22.5.4</span> Two-Stage Randomized Experiments with Interference and Noncompliance<a class="anchor" aria-label="anchor" href="#two-stage-randomized-experiments-with-interference-and-noncompliance"><i class="fas fa-link"></i></a>
</h3>
<p>In real-world experiments, <strong>interference and noncompliance</strong> complicate analysis <span class="citation">(<a href="references.html#ref-imai2021causal">Imai, Jiang, and Malani 2021</a>)</span>:</p>
<ul>
<li><p><strong>Interference</strong>: When treatment effects “spill over” from one group to another (e.g., social influence in marketing).</p></li>
<li><p><strong>Noncompliance</strong>: When participants do not adhere to their assigned treatment (e.g., a customer ignoring an ad).</p></li>
</ul>
<p>To handle <strong>noncompliance</strong>, we define:</p>
<ul>
<li><p><span class="math inline">\(Z_{ik}\)</span> = <strong>Assigned treatment</strong> (e.g., Ad A or Ad B).</p></li>
<li><p><span class="math inline">\(D_{ik}\)</span> = <strong>Actual treatment received</strong> (e.g., whether the user actually saw the ad).</p></li>
<li><p><span class="math inline">\(Y_{ik}\)</span> = <strong>Outcome</strong> (e.g., purchase).</p></li>
</ul>
<p>A <strong>two-stage Instrumental Variable model</strong> adjusts for noncompliance:</p>
<p><span class="math display">\[
\begin{aligned}
D_{ik} &amp;= \gamma_0 + \gamma_1 Z_{ik} + v_{ik} \\
Y_{ik} &amp;= \beta_0 + \beta_1 D_{ik} + \epsilon_{ik}
\end{aligned}
\]</span> where:</p>
<ul>
<li><p><span class="math inline">\(\gamma_1\)</span> measures the effect of assignment on actual treatment received.</p></li>
<li><p><span class="math inline">\(\beta_1\)</span> estimates the treatment effect, adjusting for noncompliance.</p></li>
</ul>
<p>If individuals influence each other’s outcomes, traditional randomization is biased. Solutions include:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Cluster Randomization</strong>: Assigning treatments at the group level (e.g., entire social circles receive the same ad).</p></li>
<li><p><strong>Partial Interference Models</strong>: Assume interference only occurs within predefined groups.</p></li>
</ol>
<div class="sourceCode" id="cb667"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://zeileis.github.io/ivreg/">ivreg</a></span><span class="op">)</span>  <span class="co"># Load Instrumental Variable Regression Package</span></span>
<span></span>
<span><span class="co"># Generate data for first-stage treatment assignment</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,  <span class="co"># Initial assignment (randomized)</span></span>
<span>  D <span class="op">=</span> <span class="cn">NA</span>,  <span class="co"># Actual treatment received (affected by compliance)</span></span>
<span>  Y <span class="op">=</span> <span class="cn">NA</span>   <span class="co"># Outcome variable (e.g., purchase)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Introduce noncompliance: 80% compliance rate</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.8</span>, <span class="va">data</span><span class="op">$</span><span class="va">Z</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">data</span><span class="op">$</span><span class="va">Z</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate outcome variable (Y) with true treatment effect</span></span>
<span><span class="co"># True effect of D on Y is 3</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="op">+</span> <span class="fl">3</span> <span class="op">*</span> <span class="va">data</span><span class="op">$</span><span class="va">D</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>  </span>
<span></span>
<span><span class="co"># Estimate Two-Stage Least Squares (2SLS)</span></span>
<span><span class="va">iv_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://zeileis.github.io/ivreg/reference/ivreg.html">ivreg</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">D</span> <span class="op">|</span> <span class="va">Z</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">iv_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; ivreg(formula = Y ~ D | Z, data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;    Min     1Q Median     3Q    Max </span></span>
<span><span class="co">#&gt; -5.497 -1.344  0.018  1.303  5.493 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)   5.1285     0.1861  27.557   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; D             2.7487     0.3072   8.949   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Diagnostic tests:</span></span>
<span><span class="co">#&gt;                  df1 df2 statistic p-value    </span></span>
<span><span class="co">#&gt; Weak instruments   1 498    263.54  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; Wu-Hausman         1 497      0.19   0.663    </span></span>
<span><span class="co">#&gt; Sargan             0  NA        NA      NA    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 2.017 on 498 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-Squared: 0.2997,  Adjusted R-squared: 0.2983 </span></span>
<span><span class="co">#&gt; Wald test: 80.08 on 1 and 498 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<ul>
<li><p>The first-stage regression estimates how strongly <span class="math inline">\(Z\)</span> affects <span class="math inline">\(D\)</span> (compliance).</p></li>
<li><p>The second-stage regression estimates the true causal effect of <span class="math inline">\(D\)</span> on <span class="math inline">\(Y\)</span>.</p></li>
</ul>
<p>If interference is present, the standard IV method may be biased. Researchers should explore network-based randomization or spatial models.</p>
</div>
</div>
<div id="emerging-research" class="section level2" number="22.6">
<h2>
<span class="header-section-number">22.6</span> Emerging Research<a class="anchor" aria-label="anchor" href="#emerging-research"><i class="fas fa-link"></i></a>
</h2>
<p>Recent research highlights significant challenges in measuring the causal effects of ad content in online advertising experiments. Digital advertising platforms employ algorithmic targeting and dynamic ad delivery mechanisms, which can introduce systematic biases in A/B testing <span class="citation">(<a href="references.html#ref-braun2025where">Braun and Schwartz 2025</a>)</span>. Key concerns include:</p>
<ul>
<li><p><strong>Nonrandom Exposure</strong>: Online advertising platforms optimize ad delivery dynamically, meaning users are not randomly assigned to different ad variants. Instead, platforms use proprietary algorithms to serve ads to different, often highly heterogeneous, user groups.</p></li>
<li><p><strong>Divergent Delivery</strong>: The optimization process can lead to “divergent delivery,” where differences in user engagement patterns and platform objectives result in non-comparable treatment groups. This confounds the true effect of ad content with algorithmic biases in exposure.</p></li>
<li><p><strong>Bias in Measured Effects</strong>: Algorithmic targeting, user heterogeneity, and data aggregation can distort both the <strong>magnitude</strong> and <strong>direction</strong> of estimated ad effects. This means traditional A/B test results may not accurately reflect the true impact of ad creatives.</p></li>
<li><p><strong>Limited Transparency</strong>: Platforms have little incentive to assist advertisers or researchers in disentangling ad content effects from proprietary targeting mechanisms. As a result, experimenters must design careful identification strategies to mitigate these biases.</p></li>
</ul>
<p><span class="citation">J. Zhao and Zhou (<a href="references.html#ref-zhao2024pigeonhole">2024</a>)</span></p>
<ul>
<li><p>Addresses the challenge of covariate balancing in online A/B testing when experimental subjects arrive sequentially.</p></li>
<li><p>Introduces the <strong>online blocking problem</strong>, where subjects with heterogeneous covariates must be immediately assigned to control or treatment groups.</p></li>
<li><p>Aims to minimize total discrepancy, measured as the minimum weight perfect matching between groups.</p></li>
<li>
<p>Proposes a <strong>pigeonhole design</strong>, a randomized experimental design that:</p>
<ul>
<li><p><strong>Partitions</strong> the covariate space into smaller subspaces (“pigeonholes”).</p></li>
<li><p><strong>Balances</strong> the number of treated and control subjects within each pigeonhole.</p></li>
</ul>
</li>
<li><p>Theoretical analysis demonstrates the effectiveness of the pigeonhole design.</p></li>
<li><p>Compares against <strong>matched-pair design</strong> and <strong>completely randomized design</strong>, identifying scenarios where the pigeonhole design performs better.</p></li>
<li><p><strong>Empirical validation using Yahoo! data</strong> shows a <strong>10.2% reduction in variance</strong> in estimating the average treatment effect.</p></li>
<li><p>Highlights practical implications for improving covariate balance in real-world online experiments.</p></li>
</ul>
<div id="covariate-balancing-in-online-ab-testing-the-pigeonhole-design" class="section level3" number="22.6.1">
<h3>
<span class="header-section-number">22.6.1</span> Covariate Balancing in Online A/B Testing: The Pigeonhole Design<a class="anchor" aria-label="anchor" href="#covariate-balancing-in-online-ab-testing-the-pigeonhole-design"><i class="fas fa-link"></i></a>
</h3>
<p><span class="citation">J. Zhao and Zhou (<a href="references.html#ref-zhao2024pigeonhole">2024</a>)</span> address the challenge of covariate balancing in online A/B testing when experimental subjects arrive sequentially. Traditional experimental designs struggle to maintain balance in real-time settings where treatment assignments must be made immediately. This work introduces the <strong>online blocking problem</strong>, in which subjects with heterogeneous covariates must be assigned to treatment or control groups dynamically, with the goal of minimizing <strong>total discrepancy</strong>—quantified as the minimum weight perfect matching between groups.</p>
<p>To improve covariate balance, the authors propose the <strong>pigeonhole design</strong>, a randomized experimental design that operates as follows:</p>
<ul>
<li>The covariate space is partitioned into smaller subspaces called “pigeonholes.”</li>
<li>Within each pigeonhole, the design balances the number of treated and control subjects, reducing systematic imbalances.</li>
</ul>
<p>Theoretical analysis demonstrates the effectiveness of this design in reducing discrepancy compared to existing approaches. Specifically, the pigeonhole design is benchmarked against:</p>
<ul>
<li><strong>Matched-pair design</strong></li>
<li><a href="sec-experimental-design.html#completely-randomized-design">Completely Randomized Design</a></li>
</ul>
<p>The results highlight scenarios where the pigeonhole design outperforms these alternatives in maintaining covariate balance.</p>
<p>Using Yahoo! data, the authors validate the pigeonhole design in practice, demonstrating a 10.2% reduction in variance when estimating the <a href="sec-causal-inference.html#sec-average-treatment-effect">Average Treatment Effect</a>. This improvement underscores the design’s practical utility in reducing noise and improving the precision of experimental results.</p>
<p>The findings of <span class="citation">J. Zhao and Zhou (<a href="references.html#ref-zhao2024pigeonhole">2024</a>)</span> provide valuable insights for practitioners conducting online A/B tests:</p>
<ul>
<li>Ensuring real-time covariate balance improves the reliability of causal estimates.</li>
<li>The pigeonhole design offers a structured yet flexible approach to balancing covariates dynamically.</li>
<li>By reducing variance in treatment effect estimation, it enhances statistical efficiency in large-scale online experiments.</li>
</ul>
<p>This study contributes to the broader discussion of <a href="sec-experimental-design.html#sec-the-gold-standard-randomized-controlled-trials">randomized experimental design</a> in dynamic settings, providing a compelling alternative to traditional approaches.</p>
</div>
<div id="sec-handling-zero-valued-outcomes" class="section level3" number="22.6.2">
<h3>
<span class="header-section-number">22.6.2</span> Handling Zero-Valued Outcomes<a class="anchor" aria-label="anchor" href="#sec-handling-zero-valued-outcomes"><i class="fas fa-link"></i></a>
</h3>
<p>When analyzing treatment effects, a common issue arises when the outcome variable includes <strong>zero values</strong>.</p>
<p>For example, in business applications, a marketing intervention may have <strong>no effect on some customers</strong> (resulting in zero sales). If we were to apply a <a href="variable-transformation.html#sec-logarithmic-transformation">log transformation</a> to the outcome variable, this would be problematic because:</p>
<ul>
<li>
<span class="math inline">\(\log(0)\)</span> is undefined.</li>
<li>Log transformation is <strong>sensitive to outcome units</strong>, making interpretation difficult <span class="citation">(<a href="references.html#ref-chen2023logs">J. Chen and Roth 2023</a>)</span>.</li>
</ul>
<p>Instead of applying a log transformation, we should use methods that are <strong>robust to zero values</strong>:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Percentage changes in the Average</strong>
<ul>
<li>By using Poisson Quasi-Maximum Likelihood Estimation (QMLE), we can interpret coefficients as percentage changes in the mean outcome of the treatment group relative to the control group.</li>
</ul>
</li>
<li>
<strong>Extensive vs. Intensive Margins</strong>
<ul>
<li>This approach distinguishes between:
<ul>
<li>
<strong>Extensive margin</strong>: The likelihood of moving from zero to a positive outcome (e.g., increasing the probability of making a sale).</li>
<li>
<strong>Intensive margin</strong>: The increase in the outcome given that it is already positive (e.g., increasing the sales amount).</li>
</ul>
</li>
<li>To estimate the <strong>intensive-margin bounds</strong>, we could use <span class="citation">Lee (<a href="references.html#ref-lee2009training">2009</a>)</span>, assuming that treatment has a <strong>monotonic effect</strong> on the outcome.</li>
</ul>
</li>
</ol>
<hr>
<p>We first generate a dataset to simulate a scenario where an outcome variable (e.g., sales, website clicks) has <strong>many zeros</strong>, and treatment affects both the <strong>extensive</strong> and <strong>intensive margins</strong>.</p>
<div class="sourceCode" id="cb668"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span> <span class="co"># For reproducibility</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="co"># Number of observations</span></span>
<span><span class="va">p_treatment</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># Probability of being treated</span></span>
<span></span>
<span><span class="co"># Step 1: Generate the treatment variable D</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="va">p_treatment</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 2: Generate potential outcomes</span></span>
<span><span class="co"># Untreated potential outcome (mostly zeroes)</span></span>
<span><span class="va">Y0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Treated potential outcome (affecting both extensive and intensive margins)</span></span>
<span><span class="va">Y1</span> <span class="op">&lt;-</span> <span class="va">Y0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean <span class="op">=</span> <span class="fl">2</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 3: Combine effects based on treatment assignment</span></span>
<span><span class="va">Y_observed</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">D</span><span class="op">)</span> <span class="op">*</span> <span class="va">Y0</span> <span class="op">+</span> <span class="va">D</span> <span class="op">*</span> <span class="va">Y1</span></span>
<span></span>
<span><span class="co"># Ensure non-negative outcomes (modeling real-world situations)</span></span>
<span><span class="va">Y_observed</span><span class="op">[</span><span class="va">Y_observed</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="co"># Create a dataset with an additional control variable</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>    Treatment <span class="op">=</span> <span class="va">D</span>,</span>
<span>    Outcome <span class="op">=</span> <span class="va">Y_observed</span>,</span>
<span>    X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="co"># Control variable</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>positive <span class="op">=</span> <span class="va">Outcome</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># Indicator for extensive margin</span></span>
<span></span>
<span><span class="co"># View first few rows</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ID Treatment   Outcome          X positive</span></span>
<span><span class="co">#&gt; 1  1         0 0.0000000  1.4783345    FALSE</span></span>
<span><span class="co">#&gt; 2  2         1 2.2369379 -1.4067867     TRUE</span></span>
<span><span class="co">#&gt; 3  3         0 0.0000000 -1.8839721    FALSE</span></span>
<span><span class="co">#&gt; 4  4         1 3.2192276 -0.2773662     TRUE</span></span>
<span><span class="co">#&gt; 5  5         1 0.6649693  0.4304278     TRUE</span></span>
<span><span class="co">#&gt; 6  6         0 0.0000000 -0.1287867    FALSE</span></span>
<span></span>
<span><span class="co"># Plot distribution of outcomes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span></span>
<span>    <span class="va">data</span><span class="op">$</span><span class="va">Outcome</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fl">30</span>,</span>
<span>    main <span class="op">=</span> <span class="st">"Distribution of Outcomes"</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"lightblue"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="22-experiment_files/figure-html/unnamed-chunk-12-1.png" width="90%" style="display: block; margin: auto;"></div>
<div id="estimating-percentage-changes-in-the-average" class="section level4" number="22.6.2.1">
<h4>
<span class="header-section-number">22.6.2.1</span> Estimating Percentage Changes in the Average<a class="anchor" aria-label="anchor" href="#estimating-percentage-changes-in-the-average"><i class="fas fa-link"></i></a>
</h4>
<p>Since we cannot use a log transformation, we estimate <strong>percentage changes</strong> using <strong>Poisson QMLE</strong>, which is robust to zero-valued outcomes.</p>
<div class="sourceCode" id="cb669"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Poisson Quasi-Maximum Likelihood Estimation (QMLE)</span></span>
<span><span class="va">res_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feglm.html">fepois</a></span><span class="op">(</span></span>
<span>    fml <span class="op">=</span> <span class="va">Outcome</span> <span class="op">~</span> <span class="va">Treatment</span> <span class="op">+</span> <span class="va">X</span>, </span>
<span>    data <span class="op">=</span> <span class="va">data</span>, </span>
<span>    vcov <span class="op">=</span> <span class="st">"hetero"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display results</span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/etable.html">etable</a></span><span class="op">(</span><span class="va">res_pois</span><span class="op">)</span></span>
<span><span class="co">#&gt;                           res_pois</span></span>
<span><span class="co">#&gt; Dependent Var.:            Outcome</span></span>
<span><span class="co">#&gt;                                   </span></span>
<span><span class="co">#&gt; Constant        -2.223*** (0.1440)</span></span>
<span><span class="co">#&gt; Treatment        2.579*** (0.1494)</span></span>
<span><span class="co">#&gt; X                  0.0235 (0.0406)</span></span>
<span><span class="co">#&gt; _______________ __________________</span></span>
<span><span class="co">#&gt; S.E. type       Heteroskedas.-rob.</span></span>
<span><span class="co">#&gt; Observations                 1,000</span></span>
<span><span class="co">#&gt; Squared Cor.               0.33857</span></span>
<span><span class="co">#&gt; Pseudo R2                  0.26145</span></span>
<span><span class="co">#&gt; BIC                        1,927.9</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre></div>
<p>To interpret the results:</p>
<ul>
<li><p>The coefficient on <code>Treatment</code> represents the <strong>log-percentage change</strong> in the mean outcome of the treatment group relative to the control group.</p></li>
<li><p>To compute the <strong>proportional effect</strong>, we exponentiate the coefficient:</p></li>
</ul>
<div class="sourceCode" id="cb670"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute the proportional effect of treatment</span></span>
<span><span class="va">treatment_effect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coefficients</a></span><span class="op">(</span><span class="va">res_pois</span><span class="op">)</span><span class="op">[</span><span class="st">"Treatment"</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="va">treatment_effect</span></span>
<span><span class="co">#&gt; Treatment </span></span>
<span><span class="co">#&gt;  12.17757</span></span></code></pre></div>
<p>Compute the <strong>standard error</strong>:</p>
<div class="sourceCode" id="cb671"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute standard error</span></span>
<span><span class="va">se_treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coefficients</a></span><span class="op">(</span><span class="va">res_pois</span><span class="op">)</span><span class="op">[</span><span class="st">"Treatment"</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">res_pois</span><span class="op">$</span><span class="va">cov.scaled</span><span class="op">[</span><span class="st">"Treatment"</span>, <span class="st">"Treatment"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">se_treatment</span></span>
<span><span class="co">#&gt; Treatment </span></span>
<span><span class="co">#&gt;  1.968684</span></span></code></pre></div>
<p>Thus, we conclude that the treatment effect increases the outcome by <strong>1215%</strong> for the treated group compared to the control group.</p>
</div>
<div id="estimating-extensive-vs.-intensive-margins" class="section level4" number="22.6.2.2">
<h4>
<span class="header-section-number">22.6.2.2</span> Estimating Extensive vs. Intensive Margins<a class="anchor" aria-label="anchor" href="#estimating-extensive-vs.-intensive-margins"><i class="fas fa-link"></i></a>
</h4>
<p>We now estimate <strong>treatment effects separately</strong> for the <strong>extensive margin</strong> (probability of a nonzero outcome) and the <strong>intensive margin</strong> (magnitude of effect among those with a nonzero outcome).</p>
<p>First, we use <strong>Lee Bounds</strong> to estimate the <strong>intensive-margin effect</strong> for individuals who always have a nonzero outcome.</p>
<div class="sourceCode" id="cb672"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">causalverse</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/lee_bounds.html">lee_bounds</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">data</span>,</span>
<span>    d <span class="op">=</span> <span class="st">"Treatment"</span>,</span>
<span>    m <span class="op">=</span> <span class="st">"positive"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Outcome"</span>,</span>
<span>    numdraws <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/nice_tab.html">nice_tab</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/print.html">print</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="co">#&gt;          term estimate std.error</span></span>
<span><span class="co">#&gt; 1 Lower bound    -0.22      0.09</span></span>
<span><span class="co">#&gt; 2 Upper bound     2.77      0.14</span></span></code></pre></div>
<p>Since the confidence interval <strong>includes zero</strong>, we cannot conclude that the treatment has a significant <strong>intensive-margin effect</strong>.</p>
</div>
<div id="sensitivity-analysis-varying-the-effect-for-compliers" class="section level4" number="22.6.2.3">
<h4>
<span class="header-section-number">22.6.2.3</span> Sensitivity Analysis: Varying the Effect for Compliers<a class="anchor" aria-label="anchor" href="#sensitivity-analysis-varying-the-effect-for-compliers"><i class="fas fa-link"></i></a>
</h4>
<p>To further investigate the intensive-margin effect, we consider <strong>how sensitive our results are</strong> to different assumptions about compliers.</p>
<p>We assume that the expected outcome for compliers is <span class="math inline">\(100 \times c%\)</span> <strong>lower or higher</strong> than for always-takers: <span class="math display">\[
E(Y(1) \| \text{Complier}) = (1 - c) E(Y(1) \| \text{Always-taker})
\]</span> We compute Lee Bounds for different values of <span class="math inline">\(c\)</span>:</p>
<div class="sourceCode" id="cb673"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">c_values</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.7</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html">lapply</a></span><span class="op">(</span><span class="va">c_values</span>, <span class="kw">function</span><span class="op">(</span><span class="va">c</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/lee_bounds.html">lee_bounds</a></span><span class="op">(</span></span>
<span>        df <span class="op">=</span> <span class="va">data</span>,</span>
<span>        d <span class="op">=</span> <span class="st">"Treatment"</span>,</span>
<span>        m <span class="op">=</span> <span class="st">"positive"</span>,</span>
<span>        y <span class="op">=</span> <span class="st">"Outcome"</span>,</span>
<span>        numdraws <span class="op">=</span> <span class="fl">10</span>,</span>
<span>        c_at_ratio <span class="op">=</span> <span class="va">c</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">res</span><span class="op">$</span><span class="va">c_value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined_res</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">c_value</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/nice_tab.html">nice_tab</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   c_value           term estimate std.error</span></span>
<span><span class="co">#&gt; 1     0.1 Point estimate     6.60      0.71</span></span>
<span><span class="co">#&gt; 2     0.5 Point estimate     2.54      0.13</span></span>
<span><span class="co">#&gt; 3     0.7 Point estimate     1.82      0.08</span></span></code></pre></div>
<ul>
<li>If we assume <span class="math inline">\(c = 0.1\)</span>, meaning compliers’ outcomes are 10% of always-takers’, then the intensive-margin effect is 6.6 units higher for always-takers.</li>
<li>If <span class="math inline">\(c = 0.5\)</span>, meaning compliers’ outcomes are 50% of always-takers’, then the intensive-margin effect is 2.54 units higher.</li>
</ul>
<p>These results highlight how assumptions about compliers affect conclusions about the intensive margin.</p>
<p>When dealing with <a href="sec-experimental-design.html#sec-handling-zero-valued-outcomes">zero-valued outcomes</a>, log transformations are not appropriate. Instead:</p>
<ul>
<li><p><strong>Poisson QMLE</strong> provides a robust way to estimate percentage changes in the outcome.</p></li>
<li>
<p><strong>Extensive vs. Intensive Margins</strong> allow us to distinguish between:</p>
<ul>
<li><p>The probability of a nonzero outcome (extensive margin).</p></li>
<li><p>The magnitude of change among those with a nonzero outcome (intensive margin).</p></li>
</ul>
</li>
<li><p><strong>Lee Bounds</strong> provide a method to estimate the intensive-margin effect, though results can be sensitive to assumptions about always-takers and compliers.</p></li>
</ul>
</div>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="sec-causal-inference.html"><span class="header-section-number">21</span> Causal Inference</a></div>
<div class="next"><a href="sampling.html"><span class="header-section-number">23</span> Sampling</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec-experimental-design"><span class="header-section-number">22</span> Experimental Design</a></li>
<li><a class="nav-link" href="#principles-of-experimental-design"><span class="header-section-number">22.1</span> Principles of Experimental Design</a></li>
<li><a class="nav-link" href="#sec-the-gold-standard-randomized-controlled-trials"><span class="header-section-number">22.2</span> The Gold Standard: Randomized Controlled Trials</a></li>
<li>
<a class="nav-link" href="#selection-problem"><span class="header-section-number">22.3</span> Selection Problem</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#the-observed-difference-in-outcomes"><span class="header-section-number">22.3.1</span> The Observed Difference in Outcomes</a></li>
<li><a class="nav-link" href="#eliminating-selection-bias-with-random-assignment"><span class="header-section-number">22.3.2</span> Eliminating Selection Bias with Random Assignment</a></li>
<li><a class="nav-link" href="#another-representation-under-regression"><span class="header-section-number">22.3.3</span> Another Representation Under Regression</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#classical-experimental-designs"><span class="header-section-number">22.4</span> Classical Experimental Designs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#completely-randomized-design"><span class="header-section-number">22.4.1</span> Completely Randomized Design</a></li>
<li><a class="nav-link" href="#randomized-block-design"><span class="header-section-number">22.4.2</span> Randomized Block Design</a></li>
<li><a class="nav-link" href="#factorial-design"><span class="header-section-number">22.4.3</span> Factorial Design</a></li>
<li><a class="nav-link" href="#crossover-design"><span class="header-section-number">22.4.4</span> Crossover Design</a></li>
<li><a class="nav-link" href="#split-plot-design"><span class="header-section-number">22.4.5</span> Split-Plot Design</a></li>
<li><a class="nav-link" href="#latin-square-design"><span class="header-section-number">22.4.6</span> Latin Square Design</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#advanced-experimental-designs"><span class="header-section-number">22.5</span> Advanced Experimental Designs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#semi-random-experiments"><span class="header-section-number">22.5.1</span> Semi-Random Experiments</a></li>
<li><a class="nav-link" href="#re-randomization"><span class="header-section-number">22.5.2</span> Re-Randomization</a></li>
<li><a class="nav-link" href="#two-stage-randomized-experiments"><span class="header-section-number">22.5.3</span> Two-Stage Randomized Experiments</a></li>
<li><a class="nav-link" href="#two-stage-randomized-experiments-with-interference-and-noncompliance"><span class="header-section-number">22.5.4</span> Two-Stage Randomized Experiments with Interference and Noncompliance</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#emerging-research"><span class="header-section-number">22.6</span> Emerging Research</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#covariate-balancing-in-online-ab-testing-the-pigeonhole-design"><span class="header-section-number">22.6.1</span> Covariate Balancing in Online A/B Testing: The Pigeonhole Design</a></li>
<li><a class="nav-link" href="#sec-handling-zero-valued-outcomes"><span class="header-section-number">22.6.2</span> Handling Zero-Valued Outcomes</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/mikenguyen13/data_analysis/blob/main/22-experiment.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/mikenguyen13/data_analysis/edit/main/22-experiment.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>A Guide on Data Analysis</strong>" was written by Mike Nguyen. It was last built on 2025-03-12.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
