<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 26 Synthetic Control | A Guide on Data Analysis</title>
<meta name="author" content="Mike Nguyen">
<meta name="description" content="Examples in marketing: (Tirunillai and Tellis 2017): offline TV ad on Online Chatter (Guo, Sriram, and Manchanda 2020): payment disclosure laws effect on physician prescription behavior using...">
<meta name="generator" content="bookdown 0.35 with bs4_book()">
<meta property="og:title" content="Chapter 26 Synthetic Control | A Guide on Data Analysis">
<meta property="og:type" content="book">
<meta property="og:url" content="https://bookdown.org/mike/data_analysis/synthetic-control.html">
<meta property="og:image" content="https://bookdown.org/mike/data_analysis//images/cover.jpg">
<meta property="og:description" content="Examples in marketing: (Tirunillai and Tellis 2017): offline TV ad on Online Chatter (Guo, Sriram, and Manchanda 2020): payment disclosure laws effect on physician prescription behavior using...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 26 Synthetic Control | A Guide on Data Analysis">
<meta name="twitter:description" content="Examples in marketing: (Tirunillai and Tellis 2017): offline TV ad on Online Chatter (Guo, Sriram, and Manchanda 2020): payment disclosure laws effect on physician prescription behavior using...">
<meta name="twitter:image" content="https://bookdown.org/mike/data_analysis//images/cover.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.1/transition.js"></script><script src="libs/bs3compat-0.5.1/tabs.js"></script><script src="libs/bs3compat-0.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){window.dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-DMNX2X65HQ');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">A Guide on Data Analysis</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="prerequisites.html"><span class="header-section-number">2</span> Prerequisites</a></li>
<li class="book-part">I. BASIC</li>
<li><a class="" href="descriptive-stat.html"><span class="header-section-number">3</span> Descriptive Statistics</a></li>
<li><a class="" href="basic-statistical-inference.html"><span class="header-section-number">4</span> Basic Statistical Inference</a></li>
<li class="book-part">II. REGRESSION</li>
<li><a class="" href="linear-regression.html"><span class="header-section-number">5</span> Linear Regression</a></li>
<li><a class="" href="non-linear-regression.html"><span class="header-section-number">6</span> Non-linear Regression</a></li>
<li><a class="" href="generalized-linear-models.html"><span class="header-section-number">7</span> Generalized Linear Models</a></li>
<li><a class="" href="linear-mixed-models.html"><span class="header-section-number">8</span> Linear Mixed Models</a></li>
<li><a class="" href="nonlinear-and-generalized-linear-mixed-models.html"><span class="header-section-number">9</span> Nonlinear and Generalized Linear Mixed Models</a></li>
<li class="book-part">III. RAMIFICATIONS</li>
<li><a class="" href="model-specification.html"><span class="header-section-number">10</span> Model Specification</a></li>
<li><a class="" href="imputation-missing-data.html"><span class="header-section-number">11</span> Imputation (Missing Data)</a></li>
<li><a class="" href="data.html"><span class="header-section-number">12</span> Data</a></li>
<li><a class="" href="variable-transformation.html"><span class="header-section-number">13</span> Variable Transformation</a></li>
<li><a class="" href="hypothesis-testing.html"><span class="header-section-number">14</span> Hypothesis Testing</a></li>
<li><a class="" href="marginal-effects.html"><span class="header-section-number">15</span> Marginal Effects</a></li>
<li><a class="" href="prediction-and-estimation.html"><span class="header-section-number">16</span> Prediction and Estimation</a></li>
<li><a class="" href="moderation.html"><span class="header-section-number">17</span> Moderation</a></li>
<li class="book-part">IV. CAUSAL INFERENCE</li>
<li><a class="" href="causal-inference.html"><span class="header-section-number">18</span> Causal Inference</a></li>
<li class="book-part">A. EXPERIMENTAL DESIGN</li>
<li><a class="" href="experimental-design.html"><span class="header-section-number">19</span> Experimental Design</a></li>
<li><a class="" href="sampling.html"><span class="header-section-number">20</span> Sampling</a></li>
<li><a class="" href="analysis-of-variance-anova.html"><span class="header-section-number">21</span> Analysis of Variance (ANOVA)</a></li>
<li><a class="" href="multivariate-methods.html"><span class="header-section-number">22</span> Multivariate Methods</a></li>
<li class="book-part">B. QUASI-EXPERIMENTAL DESIGN</li>
<li><a class="" href="quasi-experimental.html"><span class="header-section-number">23</span> Quasi-experimental</a></li>
<li><a class="" href="regression-discontinuity.html"><span class="header-section-number">24</span> Regression Discontinuity</a></li>
<li><a class="" href="difference-in-differences.html"><span class="header-section-number">25</span> Difference-in-differences</a></li>
<li><a class="active" href="synthetic-control.html"><span class="header-section-number">26</span> Synthetic Control</a></li>
<li><a class="" href="event-studies.html"><span class="header-section-number">27</span> Event Studies</a></li>
<li><a class="" href="matching-methods.html"><span class="header-section-number">28</span> Matching Methods</a></li>
<li><a class="" href="interrupted-time-series.html"><span class="header-section-number">29</span> Interrupted Time Series</a></li>
<li class="book-part">C. OTHER CONCERNS</li>
<li><a class="" href="endogeneity.html"><span class="header-section-number">30</span> Endogeneity</a></li>
<li><a class="" href="controls.html"><span class="header-section-number">31</span> Controls</a></li>
<li class="book-part">V. MISCELLANEOUS</li>
<li><a class="" href="mediation.html"><span class="header-section-number">32</span> Mediation</a></li>
<li><a class="" href="directed-acyclic-graph.html"><span class="header-section-number">33</span> Directed Acyclic Graph</a></li>
<li><a class="" href="report.html"><span class="header-section-number">34</span> Report</a></li>
<li><a class="" href="exploratory-data-analysis.html"><span class="header-section-number">35</span> Exploratory Data Analysis</a></li>
<li><a class="" href="sensitivity-analysis-robustness-check.html"><span class="header-section-number">36</span> Sensitivity Analysis/ Robustness Check</a></li>
<li class="book-part">APPENDIX</li>
<li><a class="" href="appendix.html"><span class="header-section-number">A</span> Appendix</a></li>
<li><a class="" href="bookdown-cheat-sheet.html"><span class="header-section-number">B</span> Bookdown cheat sheet</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/mikenguyen13/data_analysis">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="synthetic-control" class="section level1" number="26">
<h1>
<span class="header-section-number">26</span> Synthetic Control<a class="anchor" aria-label="anchor" href="#synthetic-control"><i class="fas fa-link"></i></a>
</h1>
<p>Examples in marketing:</p>
<ul>
<li>
<span class="citation">(<a href="references.html#ref-tirunillai2017">Tirunillai and Tellis 2017</a>)</span>: offline TV ad on Online Chatter</li>
<li>
<span class="citation">(<a href="references.html#ref-guo2020let">Guo, Sriram, and Manchanda 2020</a>)</span>: payment disclosure laws effect on physician prescription behavior using Timing of the Massachusetts open payment law as the exogenous shock</li>
<li>
<span class="citation">(<a href="references.html#ref-wang2019mobile">Wang, Wu, and Zhu 2019</a>)</span>: mobile hailing technology adoption on drivers’ hourly earnings</li>
</ul>
<p>Notes</p>
<ul>
<li><p>Synthetic control method (SCM) is a generalization of the <a href="difference-in-differences.html#difference-in-differences">Difference-in-differences</a> model</p></li>
<li><p>SCM is <strong>superior</strong> than <a href="matching-methods.html#matching-methods">Matching Methods</a> because it not only matches on covariates (i.e., pre-treatment variables), but also outcomes.</p></li>
<li><p>For a review of the method, see <span class="citation">(<a href="references.html#ref-abadie2021using">Abadie 2021</a>)</span></p></li>
<li><p>SCMs can also be used under the Bayesian framework where we do not have to impose any restrictive priori <span class="citation">(<a href="references.html#ref-kim2020bayesian">S. Kim, Lee, and Gupta 2020</a>)</span></p></li>
<li><p>Different from <a href="matching-methods.html#matching-methods">Matching Methods</a> because SCMs match on the pre-treatment outcomes in each period while <a href="matching-methods.html#matching-methods">Matching Methods</a> match on the number of covariates.</p></li>
<li><p>A data driven procedure to construct more comparable control groups (i.e., black box).</p></li>
<li><p>To do causal inference with control and treatment group using <a href="matching-methods.html#matching-methods">Matching Methods</a>, you typically have to have similar covariates in the control and the treated groups. However, if you don’t methods like <a href="matching-methods.html#propensity-scores">Propensity Scores</a> and DID can perform rather poorly (i.e., large bias).</p></li>
</ul>
<p>Advantages over <a href="difference-in-differences.html#difference-in-differences">Difference-in-differences</a></p>
<ol style="list-style-type: decimal">
<li>Maximization of the observable similarity between control and treatment (maybe also unobservables)</li>
<li>Can also be used in cases where no untreated case with similar on matching dimensions with treated cases</li>
<li>Objective selection of controls.</li>
</ol>
<p>Advantages over linear regression</p>
<ul>
<li><p>Regression weights for the estimator will be outside of [0,1] (because regression allows extrapolation), and it will not be sparse (i.e., can be less than 0).</p></li>
<li><p>No extrapolation under SCMs</p></li>
<li><p>Explicitly state the fit (i.e., the weight)</p></li>
<li><p>Can be estimated without the post-treatment outcomes for the control group (can’t p-hack)</p></li>
</ul>
<p>Advantages:</p>
<ol style="list-style-type: decimal">
<li>From the selection criteria, researchers can understand the relative importance of each candidate</li>
<li>Post-intervention outcomes are not used in synthetic. Hence, you can’t retro-fit.</li>
<li>Observable similarity between control and treatment cases is maximized</li>
</ol>
<p>Disadvantages:</p>
<ol style="list-style-type: decimal">
<li>It’s hard to argue for the weights you use to create the “synthetic control”</li>
</ol>
<p>SCM is recommended when</p>
<ol style="list-style-type: decimal">
<li>Social events to evaluate large-scale program or policy</li>
<li>Only one treated case with several control candidates.</li>
</ol>
<p><strong>Assumptions</strong></p>
<ul>
<li><p>Donor subject is a good match for the synthetic control (i.e., gap between the dependent of the donor subject and that of the synthetic control should be 0 before treatment)</p></li>
<li><p>Only the treated subject undergoes the treatment and not any of the subjects in the donor pool.</p></li>
<li><p>No other changes to the subjects during the whole window.</p></li>
<li><p>The counterfactual outcome of the treatment group can be imputed in a <strong>linear combination</strong> of control groups.</p></li>
</ul>
<p><strong>Identification</strong>: The exclusion restriction is met conditional on the pre-treatment outcomes.</p>
<p><code>Synth</code> provides an algorithm that finds weighted combination of the comparison units where the weights are chosen such that it best resembles the values of predictors of the outcome variable for the affected units before the intervention</p>
<p>Setting (notation followed professor <a href="https://conference.nber.org/confer/2021/SI2021/ML/AbadieSlides.pdf">Alberto Abadie</a>)</p>
<ul>
<li><p><span class="math inline">\(J + 1\)</span> units in periods <span class="math inline">\(1, \dots, T\)</span></p></li>
<li><p>The first unit is the treated one during <span class="math inline">\(T_0 + 1, \dots, T\)</span></p></li>
<li><p><span class="math inline">\(J\)</span> units are called a donor pool</p></li>
<li><p><span class="math inline">\(Y_{it}^I\)</span> is the outcome for unit <span class="math inline">\(i\)</span> if it’s exposed to the treatment during <span class="math inline">\(T_0 + 1 , \dots T\)</span></p></li>
<li><p><span class="math inline">\(Y_{it}^N\)</span> is the outcome for unit <span class="math inline">\(i\)</span> if it’s not exposed to the treatment</p></li>
</ul>
<p>We try to estimate the effect of treatment on the treated unit</p>
<p><span class="math display">\[
\tau_{1t} = Y_{1t}^I - Y_{1t}^N
\]</span></p>
<p>where we observe the first treated unit already <span class="math inline">\(Y_{1t}^I = Y_{1t}\)</span></p>
<p>To construct the synthetic control unit, we have to find appropriate weight for each donor in the donor pool by finding <span class="math inline">\(\mathbf{W} = (w_2, \dots, w_{J=1})'\)</span> where</p>
<ul>
<li><p><span class="math inline">\(w_j \ge 0\)</span> for <span class="math inline">\(j = 2, \dots, J+1\)</span></p></li>
<li><p><span class="math inline">\(w_2 + \dots + w_{J+1} = 1\)</span></p></li>
</ul>
<p>The “appropriate” vector <span class="math inline">\(\mathbf{W}\)</span> here is constrained to</p>
<p><span class="math display">\[
\min||\mathbf{X}_1 - \mathbf{X}_0 \mathbf{W}||
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(\mathbf{X}_1\)</span> is the <span class="math inline">\(k \times 1\)</span> vector of pre-treatment characteristics for the treated unit</p></li>
<li><p><span class="math inline">\(\mathbf{X}_0\)</span> is the <span class="math inline">\(k \times J\)</span> matrix of pre-treatment characteristics for the untreated units</p></li>
</ul>
<p>For simplicity, researchers usually use</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\min||\mathbf{X}_1 - \mathbf{X}_0 \mathbf{W}|| \\
&amp;= (\sum_{h=1}^k v_h(X_{h1}- w_2 X-{h2} - \dots - w_{J+1} X_{hJ +1})^{1/2}
\end{aligned}
\]</span></p>
<p>where</p>
<ul>
<li>
<span class="math inline">\(v_1, \dots, v_k\)</span> is a vector positive constants that represent the predictive power of the <span class="math inline">\(k\)</span> predictors on <span class="math inline">\(Y_{1t}^N\)</span> (i.e., the potential outcome of the treated without treatment) and it can be chosen either explicitly by the researcher or by data-driven methods</li>
</ul>
<p>For penalized synthetic control <span class="citation">(<a href="references.html#ref-abadie2021penalized">Abadie and L’hour 2021</a>)</span>, the minimization problem becomes</p>
<p><span class="math display">\[
\min_{\mathbf{W}} ||\mathbf{X}_1 - \sum_{j=2}^{J + 1}W_j \mathbf{X}_j ||^2 + \lambda \sum_{j=2}^{J+1} W_j ||\mathbf{X}_1 - \mathbf{X}_j||^2
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(W_j \ge 0\)</span> and <span class="math inline">\(\sum_{j=2}^{J+1} W_j = 1\)</span></p></li>
<li>
<p><span class="math inline">\(\lambda &gt;0\)</span> balances over-fitting of the treated and minimize the sum of pairwise distances</p>
<ul>
<li><p><span class="math inline">\(\lambda \to 0\)</span>: pure synthetic control (i.e solution for the unpenalized estimator)</p></li>
<li><p><span class="math inline">\(\lambda \to \infty\)</span>: nearest neighbor matching</p></li>
</ul>
</li>
</ul>
<p>Advantages:</p>
<ul>
<li><p>For <span class="math inline">\(\lambda &gt;0\)</span>, you have unique and sparse solution</p></li>
<li><p>Reduces the interpolation bias when averaging dissimilar units</p></li>
<li><p>Penalized SC never uses dissimilar units</p></li>
</ul>
<p>Then the synthetic control estimator is</p>
<p><span class="math display">\[
\hat{\tau}_{1t} = Y_{1t} - \sum_{j=2}^{J+1} w_j^* Y_{jt}
\]</span></p>
<p>where <span class="math inline">\(Y_{jt}\)</span> is the outcome for unit <span class="math inline">\(j\)</span> at time <span class="math inline">\(t\)</span></p>
<p>Consideration</p>
<p>Under the factor model <span class="citation">(<a href="references.html#ref-abadie2010synthetic">Abadie, Diamond, and Hainmueller 2010</a>)</span></p>
<p><span class="math display">\[
Y_{it}^N = \mathbf{\theta}_t \mathbf{Z}_i + \mathbf{\lambda}_t \mathbf{\mu}_i + \epsilon_{it}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(Z_i\)</span> = observables</p></li>
<li><p><span class="math inline">\(\mu_i\)</span> = unobservables</p></li>
<li><p><span class="math inline">\(\epsilon_{it}\)</span> = unit-level transitory shock (i.e., random noise)</p></li>
</ul>
<p>with assumptions of <span class="math inline">\(\mathbf{W}^*\)</span> such that</p>
<p><span class="math display">\[
\begin{aligned}
\sum_{j=2}^{J+1} w_j^* \mathbf{Z}_j  &amp;= \mathbf{Z}_1 \\
&amp;\dots \\
\sum_{j=2}^{J+1} w_j^* Y_{j1} &amp;= Y_{11} \\
\sum_{j=2}^{J+1} w_j^* Y_{jT_0} &amp;= Y_{1T_0}
\end{aligned}
\]</span></p>
<p>Basically, we assume that the synthetic control is a good counterfactual when the treated unit is not exposed to the treatment.</p>
<p>Then,</p>
<ul>
<li><p>the bias bound depends on close fit, which is controlled by the ratio between <span class="math inline">\(\epsilon_{it}\)</span> (transitory shock) and <span class="math inline">\(T_0\)</span> (the number of pre-treatment periods). In other words, you should have good fit for <span class="math inline">\(Y_{1t}\)</span> for pre-treatment period (i.e., <span class="math inline">\(T_0\)</span> should be large while small variance in <span class="math inline">\(\epsilon_{it}\)</span>)</p></li>
<li><p>When you have poor fit, you have to use bias correction version of the synthetic control. See <span class="citation">Ben-Michael, Feller, and Rothstein (<a href="references.html#ref-ben2020varying">2020</a>)</span></p></li>
<li>
<p>Overfitting can be the result of small <span class="math inline">\(T_0\)</span> (the number of pre-treatment periods), large <span class="math inline">\(J\)</span> (the number of units in the donor pool), and large <span class="math inline">\(\epsilon_{it}\)</span> (noise)</p>
<ul>
<li>Mitigation: put only similar units (to the treated one) in the donor pool</li>
</ul>
</li>
</ul>
<p>To make inference, we have to create a permutation distribution (by iteratively reassigning the treatment to the units in the donor pool and estimate the placebo effects in each iteration). We say there is an effect of the treatment when the magnitude of value of the treatment effect on the treated unit is extreme relative to the permutation distribution.</p>
<p>It’s recommended to use one-sided inference. And the permutation distribution is superior to the p-values alone (because sampling-based inference is hard under SCMs either because of undefined sampling mechanism or the sample is the population).</p>
<p>For benchmark (permutation) distribution (e.g., uniform), see <span class="citation">(<a href="references.html#ref-firpo2018synthetic">Firpo and Possebom 2018</a>)</span></p>
<div id="applications-1" class="section level2" number="26.1">
<h2>
<span class="header-section-number">26.1</span> Applications<a class="anchor" aria-label="anchor" href="#applications-1"><i class="fas fa-link"></i></a>
</h2>
<div id="example-1-2" class="section level3" number="26.1.1">
<h3>
<span class="header-section-number">26.1.1</span> Example 1<a class="anchor" aria-label="anchor" href="#example-1-2"><i class="fas fa-link"></i></a>
</h3>
<p>by <a href="https://rpubs.com/danilofreire/synth">Danilo Freire</a></p>
<div class="sourceCode" id="cb427"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("Synth")</span></span>
<span><span class="co"># install.packages("gsynth")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://web.stanford.edu/~jhain/">"Synth"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://yiqingxu.org/packages/gsynth/gsynth_examples.html">"gsynth"</a></span><span class="op">)</span></span></code></pre></div>
<p>simulate data for 10 states and 30 years. State A receives the treatment <code>T = 20</code> after year 15.</p>
<div class="sourceCode" id="cb428"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">year</span>         <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">state</span>        <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, each <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">X1</span>           <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">300</span>, mean <span class="op">=</span> <span class="fl">2</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">X2</span>           <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="fl">300</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">300</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">Y</span>            <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">X1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">300</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">df</span>           <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://amices.org/mice/reference/cbind.html">cbind</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">X1</span>, <span class="va">X2</span>, <span class="va">state</span>, <span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">Y</span>         <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">X1</span>        <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">X1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">X2</span>        <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">X2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">year</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">state.num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, each <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">state</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">`T`</span>       <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">state</span> <span class="op">==</span> <span class="st">"A"</span> <span class="op">&amp;</span> <span class="va">df</span><span class="op">$</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">15</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">Y</span>         <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">state</span> <span class="op">==</span> <span class="st">"A"</span> <span class="op">&amp;</span> <span class="va">df</span><span class="op">$</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">15</span>, </span>
<span>                       <span class="va">df</span><span class="op">$</span><span class="va">Y</span> <span class="op">+</span> <span class="fl">20</span>, <span class="va">df</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb429"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    300 obs. of  7 variables:</span></span>
<span><span class="co">#&gt;  $ Y        : num  2.29 4.51 2.07 8.87 4.37 1.32 8 7.49 6.98 3.72 ...</span></span>
<span><span class="co">#&gt;  $ X1       : num  1.37 2.18 1.16 3.6 2.33 1.18 2.49 2.74 2.58 1.69 ...</span></span>
<span><span class="co">#&gt;  $ X2       : num  1.96 0.4 -0.75 -0.56 -0.45 1.06 0.51 -2.1 0 0.54 ...</span></span>
<span><span class="co">#&gt;  $ state    : chr  "A" "A" "A" "A" ...</span></span>
<span><span class="co">#&gt;  $ year     : num  1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span><span class="co">#&gt;  $ state.num: int  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ T        : num  0 0 0 0 0 0 0 0 0 0 ...</span></span></code></pre></div>
<div class="sourceCode" id="cb430"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dataprep.out</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/dataprep.html">dataprep</a></span><span class="op">(</span></span>
<span>        <span class="va">df</span>,</span>
<span>        predictors            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X1"</span>, <span class="st">"X2"</span><span class="op">)</span>,</span>
<span>        dependent             <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>        unit.variable         <span class="op">=</span> <span class="st">"state.num"</span>,</span>
<span>        time.variable         <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        unit.names.variable   <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>        treatment.identifier  <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        controls.identifier   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>        time.predictors.prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">14</span><span class="op">)</span>,</span>
<span>        time.optimize.ssr     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">14</span><span class="op">)</span>,</span>
<span>        time.plot             <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">synth.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/synth.html">synth</a></span><span class="op">(</span><span class="va">dataprep.out</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; X1, X0, Z1, Z0 all come directly from dataprep object.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; **************** </span></span>
<span><span class="co">#&gt;  searching for synthetic control unit  </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; **************** </span></span>
<span><span class="co">#&gt; **************** </span></span>
<span><span class="co">#&gt; **************** </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; MSPE (LOSS V): 9.831789 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; solution.v:</span></span>
<span><span class="co">#&gt;  0.3888387 0.6111613 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; solution.w:</span></span>
<span><span class="co">#&gt;  0.1115941 0.1832781 0.1027237 0.312091 0.06096758 0.03509706 0.05893735 0.05746256 0.07784853</span></span></code></pre></div>
<div class="sourceCode" id="cb431"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">synth.tables</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/synth.tab.html">synth.tab</a></span><span class="op">(</span></span>
<span>        dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,</span>
<span>        synth.res    <span class="op">=</span> <span class="va">synth.out</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span><span class="co">#&gt; $tab.pred</span></span>
<span><span class="co">#&gt;    Treated Synthetic Sample Mean</span></span>
<span><span class="co">#&gt; X1   2.028     2.028       2.017</span></span>
<span><span class="co">#&gt; X2   0.513     0.513       0.394</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $tab.v</span></span>
<span><span class="co">#&gt;    v.weights</span></span>
<span><span class="co">#&gt; X1 0.389    </span></span>
<span><span class="co">#&gt; X2 0.611    </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $tab.w</span></span>
<span><span class="co">#&gt;    w.weights unit.names unit.numbers</span></span>
<span><span class="co">#&gt; 2      0.112          B            2</span></span>
<span><span class="co">#&gt; 3      0.183          C            3</span></span>
<span><span class="co">#&gt; 4      0.103          D            4</span></span>
<span><span class="co">#&gt; 5      0.312          E            5</span></span>
<span><span class="co">#&gt; 6      0.061          F            6</span></span>
<span><span class="co">#&gt; 7      0.035          G            7</span></span>
<span><span class="co">#&gt; 8      0.059          H            8</span></span>
<span><span class="co">#&gt; 9      0.057          I            9</span></span>
<span><span class="co">#&gt; 10     0.078          J           10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $tab.loss</span></span>
<span><span class="co">#&gt;            Loss W   Loss V</span></span>
<span><span class="co">#&gt; [1,] 9.761708e-12 9.831789</span></span></code></pre></div>
<div class="sourceCode" id="cb432"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Synth/man/path.plot.html">path.plot</a></span><span class="op">(</span>synth.res    <span class="op">=</span> <span class="va">synth.out</span>,</span>
<span>          dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,</span>
<span>          Ylab         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span>,</span>
<span>          Xlab         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span>,</span>
<span>          Legend       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"State A"</span>,<span class="st">"Synthetic State A"</span><span class="op">)</span>,</span>
<span>          Legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"topleft"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v   <span class="op">=</span> <span class="fl">15</span>,</span>
<span>       lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-synthetic-control_files/figure-html/unnamed-chunk-6-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>Gaps plot:</p>
<div class="sourceCode" id="cb433"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Synth/man/gaps.plot.html">gaps.plot</a></span><span class="op">(</span>synth.res    <span class="op">=</span> <span class="va">synth.out</span>,</span>
<span>          dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,</span>
<span>          Ylab         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Gap"</span><span class="op">)</span>,</span>
<span>          Xlab         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span>,</span>
<span>          Ylim         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">30</span>, <span class="fl">30</span><span class="op">)</span>,</span>
<span>          Main         <span class="op">=</span> <span class="st">""</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v   <span class="op">=</span> <span class="fl">15</span>,</span>
<span>       lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-synthetic-control_files/figure-html/unnamed-chunk-7-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>Alternatively, <code>gsynth</code> provides options to estimate iterative fixed effects, and handle multiple treated units at tat time.</p>
<p>Here, we use two=way fixed effects and bootstrapped standard errors</p>
<div class="sourceCode" id="cb434"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb434-1"><a href="synthetic-control.html#cb434-1" tabindex="-1"></a>gsynth.out <span class="ot">&lt;-</span> <span class="fu">gsynth</span>(</span>
<span id="cb434-2"><a href="synthetic-control.html#cb434-2" tabindex="-1"></a>  Y <span class="sc">~</span> <span class="st">`</span><span class="at">T</span><span class="st">`</span> <span class="sc">+</span> X1 <span class="sc">+</span> X2,</span>
<span id="cb434-3"><a href="synthetic-control.html#cb434-3" tabindex="-1"></a>  <span class="at">data =</span> df,</span>
<span id="cb434-4"><a href="synthetic-control.html#cb434-4" tabindex="-1"></a>  <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"state"</span>, <span class="st">"year"</span>),</span>
<span id="cb434-5"><a href="synthetic-control.html#cb434-5" tabindex="-1"></a>  <span class="at">force =</span> <span class="st">"two-way"</span>,</span>
<span id="cb434-6"><a href="synthetic-control.html#cb434-6" tabindex="-1"></a>  <span class="at">CV =</span> <span class="cn">TRUE</span>,</span>
<span id="cb434-7"><a href="synthetic-control.html#cb434-7" tabindex="-1"></a>  <span class="at">r =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>),</span>
<span id="cb434-8"><a href="synthetic-control.html#cb434-8" tabindex="-1"></a>  <span class="at">se =</span> <span class="cn">TRUE</span>,</span>
<span id="cb434-9"><a href="synthetic-control.html#cb434-9" tabindex="-1"></a>  <span class="at">inference =</span> <span class="st">"parametric"</span>,</span>
<span id="cb434-10"><a href="synthetic-control.html#cb434-10" tabindex="-1"></a>  <span class="at">nboots =</span> <span class="dv">1000</span>,</span>
<span id="cb434-11"><a href="synthetic-control.html#cb434-11" tabindex="-1"></a>  <span class="at">parallel =</span> F <span class="co"># TRUE</span></span>
<span id="cb434-12"><a href="synthetic-control.html#cb434-12" tabindex="-1"></a>)</span>
<span id="cb434-13"><a href="synthetic-control.html#cb434-13" tabindex="-1"></a><span class="co">#&gt; Cross-validating ... </span></span>
<span id="cb434-14"><a href="synthetic-control.html#cb434-14" tabindex="-1"></a><span class="co">#&gt;  r = 0; sigma2 = 1.13533; IC = 0.95632; PC = 0.96713; MSPE = 1.65502</span></span>
<span id="cb434-15"><a href="synthetic-control.html#cb434-15" tabindex="-1"></a><span class="co">#&gt;  r = 1; sigma2 = 0.96885; IC = 1.54420; PC = 4.30644; MSPE = 1.33375</span></span>
<span id="cb434-16"><a href="synthetic-control.html#cb434-16" tabindex="-1"></a><span class="co">#&gt;  r = 2; sigma2 = 0.81855; IC = 2.08062; PC = 6.58556; MSPE = 1.27341*</span></span>
<span id="cb434-17"><a href="synthetic-control.html#cb434-17" tabindex="-1"></a><span class="co">#&gt;  r = 3; sigma2 = 0.71670; IC = 2.61125; PC = 8.35187; MSPE = 1.79319</span></span>
<span id="cb434-18"><a href="synthetic-control.html#cb434-18" tabindex="-1"></a><span class="co">#&gt;  r = 4; sigma2 = 0.62823; IC = 3.10156; PC = 9.59221; MSPE = 2.02301</span></span>
<span id="cb434-19"><a href="synthetic-control.html#cb434-19" tabindex="-1"></a><span class="co">#&gt;  r = 5; sigma2 = 0.55497; IC = 3.55814; PC = 10.48406; MSPE = 2.79596</span></span>
<span id="cb434-20"><a href="synthetic-control.html#cb434-20" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb434-21"><a href="synthetic-control.html#cb434-21" tabindex="-1"></a><span class="co">#&gt;  r* = 2</span></span>
<span id="cb434-22"><a href="synthetic-control.html#cb434-22" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb434-23"><a href="synthetic-control.html#cb434-23" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb434-24"><a href="synthetic-control.html#cb434-24" tabindex="-1"></a>Simulating errors .............</span>
<span id="cb434-25"><a href="synthetic-control.html#cb434-25" tabindex="-1"></a>Bootstrapping ...</span>
<span id="cb434-26"><a href="synthetic-control.html#cb434-26" tabindex="-1"></a><span class="co">#&gt; ..........</span></span></code></pre></div>
<div class="sourceCode" id="cb435"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">gsynth.out</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-synthetic-control_files/figure-html/unnamed-chunk-9-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb436"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">gsynth.out</span>, type <span class="op">=</span> <span class="st">"counterfactual"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-synthetic-control_files/figure-html/unnamed-chunk-10-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb437"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">gsynth.out</span>, type <span class="op">=</span> <span class="st">"counterfactual"</span>, raw <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="26-synthetic-control_files/figure-html/unnamed-chunk-11-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb438"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># shows estimations for the control cases</span></span></code></pre></div>
</div>
<div id="example-2-1" class="section level3" number="26.1.2">
<h3>
<span class="header-section-number">26.1.2</span> Example 2<a class="anchor" aria-label="anchor" href="#example-2-1"><i class="fas fa-link"></i></a>
</h3>
<p>by <a href="https://towardsdatascience.com/causal-inference-using-synthetic-control-the-ultimate-guide-a622ad5cf827">Leihua Ye</a></p>
<div class="sourceCode" id="cb439"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://web.stanford.edu/~jhain/">Synth</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"basque"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">basque</span><span class="op">)</span> <span class="co">#774*17</span></span>
<span><span class="co">#&gt; [1] 774  17</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">basque</span><span class="op">)</span></span>
<span><span class="co">#&gt;   regionno     regionname year   gdpcap sec.agriculture sec.energy sec.industry</span></span>
<span><span class="co">#&gt; 1        1 Spain (Espana) 1955 2.354542              NA         NA           NA</span></span>
<span><span class="co">#&gt; 2        1 Spain (Espana) 1956 2.480149              NA         NA           NA</span></span>
<span><span class="co">#&gt; 3        1 Spain (Espana) 1957 2.603613              NA         NA           NA</span></span>
<span><span class="co">#&gt; 4        1 Spain (Espana) 1958 2.637104              NA         NA           NA</span></span>
<span><span class="co">#&gt; 5        1 Spain (Espana) 1959 2.669880              NA         NA           NA</span></span>
<span><span class="co">#&gt; 6        1 Spain (Espana) 1960 2.869966              NA         NA           NA</span></span>
<span><span class="co">#&gt;   sec.construction sec.services.venta sec.services.nonventa school.illit</span></span>
<span><span class="co">#&gt; 1               NA                 NA                    NA           NA</span></span>
<span><span class="co">#&gt; 2               NA                 NA                    NA           NA</span></span>
<span><span class="co">#&gt; 3               NA                 NA                    NA           NA</span></span>
<span><span class="co">#&gt; 4               NA                 NA                    NA           NA</span></span>
<span><span class="co">#&gt; 5               NA                 NA                    NA           NA</span></span>
<span><span class="co">#&gt; 6               NA                 NA                    NA           NA</span></span>
<span><span class="co">#&gt;   school.prim school.med school.high school.post.high popdens invest</span></span>
<span><span class="co">#&gt; 1          NA         NA          NA               NA      NA     NA</span></span>
<span><span class="co">#&gt; 2          NA         NA          NA               NA      NA     NA</span></span>
<span><span class="co">#&gt; 3          NA         NA          NA               NA      NA     NA</span></span>
<span><span class="co">#&gt; 4          NA         NA          NA               NA      NA     NA</span></span>
<span><span class="co">#&gt; 5          NA         NA          NA               NA      NA     NA</span></span>
<span><span class="co">#&gt; 6          NA         NA          NA               NA      NA     NA</span></span></code></pre></div>
<p>transform data to be used in <code><a href="https://rdrr.io/pkg/Synth/man/synth.html">synth()</a></code></p>
<div class="sourceCode" id="cb440"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dataprep.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/dataprep.html">dataprep</a></span><span class="op">(</span></span>
<span>    foo <span class="op">=</span> <span class="va">basque</span>,</span>
<span>    predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"school.illit"</span>,</span>
<span>        <span class="st">"school.prim"</span>,</span>
<span>        <span class="st">"school.med"</span>,</span>
<span>        <span class="st">"school.high"</span>,</span>
<span>        <span class="st">"school.post.high"</span>,</span>
<span>        <span class="st">"invest"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    predictors.op <span class="op">=</span>  <span class="st">"mean"</span>,</span>
<span>    <span class="co"># the operator</span></span>
<span>    time.predictors.prior <span class="op">=</span> <span class="fl">1964</span><span class="op">:</span><span class="fl">1969</span>,</span>
<span>    <span class="co">#the entire time frame from the #beginning to the end</span></span>
<span>    special.predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"gdpcap"</span>, <span class="fl">1960</span><span class="op">:</span><span class="fl">1969</span>,  <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"sec.agriculture"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"sec.energy"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"sec.industry"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"sec.construction"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"sec.services.venta"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"sec.services.nonventa"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"popdens"</span>, <span class="fl">1969</span>,  <span class="st">"mean"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    dependent <span class="op">=</span>  <span class="st">"gdpcap"</span>,</span>
<span>    <span class="co"># dv</span></span>
<span>    unit.variable <span class="op">=</span>  <span class="st">"regionno"</span>,</span>
<span>    <span class="co">#identifying unit numbers</span></span>
<span>    unit.names.variable <span class="op">=</span>  <span class="st">"regionname"</span>,</span>
<span>    <span class="co">#identifying unit names</span></span>
<span>    time.variable <span class="op">=</span>  <span class="st">"year"</span>,</span>
<span>    <span class="co">#time-periods</span></span>
<span>    treatment.identifier <span class="op">=</span> <span class="fl">17</span>,</span>
<span>    <span class="co">#the treated case</span></span>
<span>    controls.identifier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">16</span>, <span class="fl">18</span><span class="op">)</span>,</span>
<span>    <span class="co">#the control cases; all others #except number 17</span></span>
<span>    time.optimize.ssr <span class="op">=</span> <span class="fl">1960</span><span class="op">:</span><span class="fl">1969</span>,</span>
<span>    <span class="co">#the time-period over which to optimize</span></span>
<span>    time.plot <span class="op">=</span> <span class="fl">1955</span><span class="op">:</span><span class="fl">1997</span></span>
<span><span class="op">)</span> <span class="co">#the entire time period before/after the treatment</span></span></code></pre></div>
<p>where</p>
<ul>
<li><p><span class="math inline">\(X_1\)</span> = the control case before the treatment</p></li>
<li><p><span class="math inline">\(X_0\)</span> = the control cases after the treatment</p></li>
<li><p><span class="math inline">\(Z_1\)</span>: the treatment case before the treatment</p></li>
<li><p><span class="math inline">\(Z_0\)</span>: the treatment case after the treatment</p></li>
</ul>
<div class="sourceCode" id="cb441"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">synth.out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/synth.html">synth</a></span><span class="op">(</span>data.prep.obj <span class="op">=</span> <span class="va">dataprep.out</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; X1, X0, Z1, Z0 all come directly from dataprep object.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; **************** </span></span>
<span><span class="co">#&gt;  searching for synthetic control unit  </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; **************** </span></span>
<span><span class="co">#&gt; **************** </span></span>
<span><span class="co">#&gt; **************** </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; MSPE (LOSS V): 0.008864606 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; solution.v:</span></span>
<span><span class="co">#&gt;  0.02773094 1.194e-07 1.60609e-05 0.0007163836 1.486e-07 0.002423908 0.0587055 0.2651997 0.02851006 0.291276 0.007994382 0.004053188 0.009398579 0.303975 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; solution.w:</span></span>
<span><span class="co">#&gt;  2.53e-08 4.63e-08 6.44e-08 2.81e-08 3.37e-08 4.844e-07 4.2e-08 4.69e-08 0.8508145 9.75e-08 3.2e-08 5.54e-08 0.1491843 4.86e-08 9.89e-08 1.162e-07</span></span></code></pre></div>
<p>Calculate the difference between the real basque region and the synthetic control</p>
<div class="sourceCode" id="cb442"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gaps</span> <span class="op">=</span> <span class="va">dataprep.out</span><span class="op">$</span><span class="va">Y1plot</span> <span class="op">-</span> <span class="op">(</span><span class="va">dataprep.out</span><span class="op">$</span><span class="va">Y0plot</span> </span>
<span>                                     <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">synth.out</span><span class="op">$</span><span class="va">solution.w</span><span class="op">)</span></span>
<span><span class="va">gaps</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="co">#&gt;       1955       1956       1957 </span></span>
<span><span class="co">#&gt; 0.15023473 0.09168035 0.03716475</span></span></code></pre></div>
<div class="sourceCode" id="cb443"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">synth.tables</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/synth.tab.html">synth.tab</a></span><span class="op">(</span>dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,</span>
<span>                         synth.res <span class="op">=</span> <span class="va">synth.out</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">synth.tables</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "tab.pred" "tab.v"    "tab.w"    "tab.loss"</span></span>
<span><span class="va">synth.tables</span><span class="op">$</span><span class="va">tab.pred</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">13</span>,<span class="op">]</span></span>
<span><span class="co">#&gt;                                          Treated Synthetic Sample Mean</span></span>
<span><span class="co">#&gt; school.illit                              39.888   256.337     170.786</span></span>
<span><span class="co">#&gt; school.prim                             1031.742  2730.104    1127.186</span></span>
<span><span class="co">#&gt; school.med                                90.359   223.340      76.260</span></span>
<span><span class="co">#&gt; school.high                               25.728    63.437      24.235</span></span>
<span><span class="co">#&gt; school.post.high                          13.480    36.153      13.478</span></span>
<span><span class="co">#&gt; invest                                    24.647    21.583      21.424</span></span>
<span><span class="co">#&gt; special.gdpcap.1960.1969                   5.285     5.271       3.581</span></span>
<span><span class="co">#&gt; special.sec.agriculture.1961.1969          6.844     6.179      21.353</span></span>
<span><span class="co">#&gt; special.sec.energy.1961.1969               4.106     2.760       5.310</span></span>
<span><span class="co">#&gt; special.sec.industry.1961.1969            45.082    37.636      22.425</span></span>
<span><span class="co">#&gt; special.sec.construction.1961.1969         6.150     6.952       7.276</span></span>
<span><span class="co">#&gt; special.sec.services.venta.1961.1969      33.754    41.104      36.528</span></span>
<span><span class="co">#&gt; special.sec.services.nonventa.1961.1969    4.072     5.371       7.111</span></span></code></pre></div>
<p>Relative importance of each unit</p>
<div class="sourceCode" id="cb444"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">synth.tables</span><span class="op">$</span><span class="va">tab.w</span><span class="op">[</span><span class="fl">8</span><span class="op">:</span><span class="fl">14</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;    w.weights            unit.names unit.numbers</span></span>
<span><span class="co">#&gt; 9      0.000    Castilla-La Mancha            9</span></span>
<span><span class="co">#&gt; 10     0.851              Cataluna           10</span></span>
<span><span class="co">#&gt; 11     0.000  Comunidad Valenciana           11</span></span>
<span><span class="co">#&gt; 12     0.000           Extremadura           12</span></span>
<span><span class="co">#&gt; 13     0.000               Galicia           13</span></span>
<span><span class="co">#&gt; 14     0.149 Madrid (Comunidad De)           14</span></span>
<span><span class="co">#&gt; 15     0.000    Murcia (Region de)           15</span></span></code></pre></div>
<div class="sourceCode" id="cb445"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot the changes before and after the treatment </span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Synth/man/path.plot.html">path.plot</a></span><span class="op">(</span></span>
<span>    synth.res <span class="op">=</span> <span class="va">synth.out</span>,</span>
<span>    dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,</span>
<span>    Ylab <span class="op">=</span> <span class="st">"real per-capita gdp (1986 USD, thousand)"</span>,</span>
<span>    Xlab <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    Ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">12</span><span class="op">)</span>,</span>
<span>    Legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Basque country"</span>,</span>
<span>               <span class="st">"synthetic Basque country"</span><span class="op">)</span>,</span>
<span>    Legend.position <span class="op">=</span> <span class="st">"bottomright"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-synthetic-control_files/figure-html/unnamed-chunk-18-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb446"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Synth/man/gaps.plot.html">gaps.plot</a></span><span class="op">(</span></span>
<span>    synth.res <span class="op">=</span> <span class="va">synth.out</span>,</span>
<span>    dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,</span>
<span>    Ylab <span class="op">=</span>  <span class="st">"gap in real per - capita GDP (1986 USD, thousand)"</span>,</span>
<span>    Xlab <span class="op">=</span>  <span class="st">"year"</span>,</span>
<span>    Ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span><span class="op">)</span>,</span>
<span>    Main <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-synthetic-control_files/figure-html/unnamed-chunk-19-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>Doubly Robust Difference-in-Differences</p>
<p>Example from <code>DRDID</code> package</p>
<div class="sourceCode" id="cb447"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://psantanna.com/DRDID/">DRDID</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">nsw_long</span><span class="op">)</span></span>
<span><span class="co"># Form the Lalonde sample with CPS comparison group</span></span>
<span><span class="va">eval_lalonde_cps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">nsw_long</span>, <span class="va">nsw_long</span><span class="op">$</span><span class="va">treated</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> </span>
<span>                               <span class="va">nsw_long</span><span class="op">$</span><span class="va">sample</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Estimate Average Treatment Effect on Treated using Improved Locally Efficient Doubly Robust DID estimator</p>
<div class="sourceCode" id="cb448"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://psantanna.com/DRDID/reference/drdid.html">drdid</a></span><span class="op">(</span></span>
<span>        yname <span class="op">=</span> <span class="st">"re"</span>,</span>
<span>        tname <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        idname <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>        dname <span class="op">=</span> <span class="st">"experimental"</span>,</span>
<span>        xformla <span class="op">=</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">black</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span> <span class="va">hisp</span> <span class="op">+</span> <span class="va">re74</span>,</span>
<span>        data <span class="op">=</span> <span class="va">eval_lalonde_cps</span>,</span>
<span>        panel <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Call:</span></span>
<span><span class="co">#&gt; drdid(yname = "re", tname = "year", idname = "id", dname = "experimental", </span></span>
<span><span class="co">#&gt;     xformla = ~age + educ + black + married + nodegree + hisp + </span></span>
<span><span class="co">#&gt;         re74, data = eval_lalonde_cps, panel = TRUE)</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------------</span></span>
<span><span class="co">#&gt;  Further improved locally efficient DR DID estimator for the ATT:</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;    ATT     Std. Error  t value    Pr(&gt;|t|)  [95% Conf. Interval] </span></span>
<span><span class="co">#&gt; -901.2703   393.6247   -2.2897     0.022    -1672.7747  -129.766 </span></span>
<span><span class="co">#&gt; ------------------------------------------------------------------</span></span>
<span><span class="co">#&gt;  Estimator based on panel data.</span></span>
<span><span class="co">#&gt;  Outcome regression est. method: weighted least squares.</span></span>
<span><span class="co">#&gt;  Propensity score est. method: inverse prob. tilting.</span></span>
<span><span class="co">#&gt;  Analytical standard error.</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------------</span></span>
<span><span class="co">#&gt;  See Sant'Anna and Zhao (2020) for details.</span></span></code></pre></div>
</div>
<div id="example-3-1" class="section level3" number="26.1.3">
<h3>
<span class="header-section-number">26.1.3</span> Example 3<a class="anchor" aria-label="anchor" href="#example-3-1"><i class="fas fa-link"></i></a>
</h3>
<p>by <code>Synth</code> package’s authors</p>
<div class="sourceCode" id="cb449"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://web.stanford.edu/~jhain/">Synth</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"basque"</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="https://rdrr.io/pkg/Synth/man/synth.html">synth()</a></code> requires</p>
<ul>
<li><p><span class="math inline">\(X_1\)</span> vector of treatment predictors</p></li>
<li><p><span class="math inline">\(X_0\)</span> matrix of same variables for control group</p></li>
<li><p><span class="math inline">\(Z_1\)</span> vector of outcome variable for treatment group</p></li>
<li><p><span class="math inline">\(Z_0\)</span> matrix of outcome variable for control group</p></li>
</ul>
<p>use <code><a href="https://rdrr.io/pkg/Synth/man/dataprep.html">dataprep()</a></code> to prepare data in the format that can be used throughout the <code>Synth</code> package</p>
<div class="sourceCode" id="cb450"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dataprep.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/dataprep.html">dataprep</a></span><span class="op">(</span></span>
<span>    foo <span class="op">=</span> <span class="va">basque</span>,</span>
<span>    predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"school.illit"</span>,</span>
<span>        <span class="st">"school.prim"</span>,</span>
<span>        <span class="st">"school.med"</span>,</span>
<span>        <span class="st">"school.high"</span>,</span>
<span>        <span class="st">"school.post.high"</span>,</span>
<span>        <span class="st">"invest"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    predictors.op <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>    time.predictors.prior <span class="op">=</span> <span class="fl">1964</span><span class="op">:</span><span class="fl">1969</span>,</span>
<span>    special.predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"gdpcap"</span>, <span class="fl">1960</span><span class="op">:</span><span class="fl">1969</span> , <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"sec.agriculture"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"sec.energy"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"sec.industry"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"sec.construction"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"sec.services.venta"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"sec.services.nonventa"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"popdens"</span>, <span class="fl">1969</span>, <span class="st">"mean"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    dependent <span class="op">=</span> <span class="st">"gdpcap"</span>,</span>
<span>    unit.variable <span class="op">=</span> <span class="st">"regionno"</span>,</span>
<span>    unit.names.variable <span class="op">=</span> <span class="st">"regionname"</span>,</span>
<span>    time.variable <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    treatment.identifier <span class="op">=</span> <span class="fl">17</span>,</span>
<span>    controls.identifier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">16</span>, <span class="fl">18</span><span class="op">)</span>,</span>
<span>    time.optimize.ssr <span class="op">=</span> <span class="fl">1960</span><span class="op">:</span><span class="fl">1969</span>,</span>
<span>    time.plot <span class="op">=</span> <span class="fl">1955</span><span class="op">:</span><span class="fl">1997</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>find optimal weights that identifies the synthetic control for the treatment group</p>
<div class="sourceCode" id="cb451"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">synth.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/synth.html">synth</a></span><span class="op">(</span>data.prep.obj <span class="op">=</span> <span class="va">dataprep.out</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; X1, X0, Z1, Z0 all come directly from dataprep object.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; **************** </span></span>
<span><span class="co">#&gt;  searching for synthetic control unit  </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; **************** </span></span>
<span><span class="co">#&gt; **************** </span></span>
<span><span class="co">#&gt; **************** </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; MSPE (LOSS V): 0.008864606 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; solution.v:</span></span>
<span><span class="co">#&gt;  0.02773094 1.194e-07 1.60609e-05 0.0007163836 1.486e-07 0.002423908 0.0587055 0.2651997 0.02851006 0.291276 0.007994382 0.004053188 0.009398579 0.303975 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; solution.w:</span></span>
<span><span class="co">#&gt;  2.53e-08 4.63e-08 6.44e-08 2.81e-08 3.37e-08 4.844e-07 4.2e-08 4.69e-08 0.8508145 9.75e-08 3.2e-08 5.54e-08 0.1491843 4.86e-08 9.89e-08 1.162e-07</span></span></code></pre></div>
<div class="sourceCode" id="cb452"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gaps</span> <span class="op">&lt;-</span> <span class="va">dataprep.out</span><span class="op">$</span><span class="va">Y1plot</span> <span class="op">-</span> <span class="op">(</span><span class="va">dataprep.out</span><span class="op">$</span><span class="va">Y0plot</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">synth.out</span><span class="op">$</span><span class="va">solution.w</span><span class="op">)</span></span>
<span><span class="va">gaps</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">]</span></span>
<span><span class="co">#&gt;       1955       1956       1957 </span></span>
<span><span class="co">#&gt; 0.15023473 0.09168035 0.03716475</span></span></code></pre></div>
<div class="sourceCode" id="cb453"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">synth.tables</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/synth.tab.html">synth.tab</a></span><span class="op">(</span>dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>, synth.res <span class="op">=</span> <span class="va">synth.out</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">synth.tables</span><span class="op">)</span> <span class="co"># you can pick tables to see </span></span>
<span><span class="co">#&gt; [1] "tab.pred" "tab.v"    "tab.w"    "tab.loss"</span></span></code></pre></div>
<div class="sourceCode" id="cb454"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Synth/man/path.plot.html">path.plot</a></span><span class="op">(</span></span>
<span>    synth.res <span class="op">=</span> <span class="va">synth.out</span>,</span>
<span>    dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,</span>
<span>    Ylab <span class="op">=</span> <span class="st">"real per-capita GDP (1986 USD, thousand)"</span>,</span>
<span>    Xlab <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    Ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">12</span><span class="op">)</span>,</span>
<span>    Legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Basque country"</span>,</span>
<span>               <span class="st">"synthetic Basque country"</span><span class="op">)</span>,</span>
<span>    Legend.position <span class="op">=</span> <span class="st">"bottomright"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-synthetic-control_files/figure-html/unnamed-chunk-27-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb455"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Synth/man/gaps.plot.html">gaps.plot</a></span><span class="op">(</span></span>
<span>    synth.res <span class="op">=</span> <span class="va">synth.out</span>,</span>
<span>    dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,</span>
<span>    Ylab <span class="op">=</span> <span class="st">"gap in real per-capita GDP (1986 USD, thousand)"</span>,</span>
<span>    Xlab <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    Ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span><span class="op">)</span>,</span>
<span>    Main <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-synthetic-control_files/figure-html/unnamed-chunk-28-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>You could also run placebo tests</p>
</div>
<div id="example-4-1" class="section level3" number="26.1.4">
<h3>
<span class="header-section-number">26.1.4</span> Example 4<a class="anchor" aria-label="anchor" href="#example-4-1"><i class="fas fa-link"></i></a>
</h3>
<p>by <a href="https://cran.r-project.org/web/packages/microsynth/vignettes/introduction.html">Michael Robbins and Steven Davenport</a> who are authors of <code>MicroSynth</code> with the following improvements:</p>
<ul>
<li><p>Standardization <code>use.survey = TRUE</code> and permutation ( <code>perm = 250</code> and <code>jack = TRUE</code> ) for placebo tests</p></li>
<li><p>Omnibus statistic (set to <code>omnibus.var</code> ) for multiple outcome variables</p></li>
<li><p>incorporate multiple follow-up periods <code>end.post</code></p></li>
</ul>
<p>Notes:</p>
<ul>
<li>
<p>Both predictors and outcome will be used to match units before intervention</p>
<ul>
<li><p>Outcome variable has to be <strong>time-variant</strong></p></li>
<li><p>Predictors are <strong>time-invariant</strong></p></li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb456"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># right now the package is not availabe for R version 4.2</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">microsynth</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"seattledmi"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">cov.var</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"TotalPop"</span>,</span>
<span>        <span class="st">"BLACK"</span>,</span>
<span>        <span class="st">"HISPANIC"</span>,</span>
<span>        <span class="st">"Males_1521"</span>,</span>
<span>        <span class="st">"HOUSEHOLDS"</span>,</span>
<span>        <span class="st">"FAMILYHOUS"</span>,</span>
<span>        <span class="st">"FEMALE_HOU"</span>,</span>
<span>        <span class="st">"RENTER_HOU"</span>,</span>
<span>        <span class="st">"VACANT_HOU"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="va">match.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"i_felony"</span>, <span class="st">"i_misdemea"</span>, <span class="st">"i_drugs"</span>, <span class="st">"any_crime"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb457"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sea1</span> <span class="op">&lt;-</span> <span class="fu">microsynth</span><span class="op">(</span></span>
<span>    <span class="va">seattledmi</span>,</span>
<span>    idvar       <span class="op">=</span> <span class="st">"ID"</span>,</span>
<span>    timevar     <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>    intvar      <span class="op">=</span> <span class="st">"Intervention"</span>,</span>
<span>    start.pre   <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    end.pre     <span class="op">=</span> <span class="fl">12</span>,</span>
<span>    end.post    <span class="op">=</span> <span class="fl">16</span>,</span>
<span>    match.out   <span class="op">=</span> <span class="va">match.out</span>, <span class="co"># outcome variable will be matched on exactly</span></span>
<span>    match.covar <span class="op">=</span> <span class="va">cov.var</span>, <span class="co"># specify covariates will be matched on exactly</span></span>
<span>    result.var  <span class="op">=</span> <span class="va">match.out</span>, <span class="co"># used to report results</span></span>
<span>    omnibus.var <span class="op">=</span> <span class="va">match.out</span>, <span class="co"># feature in the omnibus p-value</span></span>
<span>    test        <span class="op">=</span> <span class="st">"lower"</span>,</span>
<span>    n.cores     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sea1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">sea1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb458"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_microsynth</span><span class="op">(</span><span class="va">sea1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb459"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sea2</span> <span class="op">&lt;-</span> <span class="fu">microsynth</span><span class="op">(</span></span>
<span>    <span class="va">seattledmi</span>,</span>
<span>    idvar <span class="op">=</span> <span class="st">"ID"</span>,</span>
<span>    timevar <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>    intvar <span class="op">=</span> <span class="st">"Intervention"</span>,</span>
<span>    start.pre <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    end.pre <span class="op">=</span> <span class="fl">12</span>,</span>
<span>    end.post <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">14</span>, <span class="fl">16</span><span class="op">)</span>,</span>
<span>    match.out <span class="op">=</span> <span class="va">match.out</span>,</span>
<span>    match.covar <span class="op">=</span> <span class="va">cov.var</span>,</span>
<span>    result.var <span class="op">=</span> <span class="va">match.out</span>,</span>
<span>    omnibus.var <span class="op">=</span> <span class="va">match.out</span>,</span>
<span>    test <span class="op">=</span> <span class="st">"lower"</span>,</span>
<span>    perm <span class="op">=</span> <span class="fl">250</span>,</span>
<span>    jack <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    n.cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="synthetic-difference-in-differences" class="section level2" number="26.2">
<h2>
<span class="header-section-number">26.2</span> Synthetic Difference-in-differences<a class="anchor" aria-label="anchor" href="#synthetic-difference-in-differences"><i class="fas fa-link"></i></a>
</h2>
<p>reference: <span class="citation">(<a href="references.html#ref-arkhangelsky2021synthetic">Arkhangelsky et al. 2021</a>)</span></p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="difference-in-differences.html"><span class="header-section-number">25</span> Difference-in-differences</a></div>
<div class="next"><a href="event-studies.html"><span class="header-section-number">27</span> Event Studies</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#synthetic-control"><span class="header-section-number">26</span> Synthetic Control</a></li>
<li>
<a class="nav-link" href="#applications-1"><span class="header-section-number">26.1</span> Applications</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#example-1-2"><span class="header-section-number">26.1.1</span> Example 1</a></li>
<li><a class="nav-link" href="#example-2-1"><span class="header-section-number">26.1.2</span> Example 2</a></li>
<li><a class="nav-link" href="#example-3-1"><span class="header-section-number">26.1.3</span> Example 3</a></li>
<li><a class="nav-link" href="#example-4-1"><span class="header-section-number">26.1.4</span> Example 4</a></li>
</ul>
</li>
<li><a class="nav-link" href="#synthetic-difference-in-differences"><span class="header-section-number">26.2</span> Synthetic Difference-in-differences</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/mikenguyen13/data_analysis/blob/main/26-synthetic-control.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/mikenguyen13/data_analysis/edit/main/26-synthetic-control.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>A Guide on Data Analysis</strong>" was written by Mike Nguyen. It was last built on 2023-08-22.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
