<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 30 Difference-in-Differences | A Guide on Data Analysis</title>
<meta name="author" content="Mike Nguyen">
<meta name="description" content="Difference-in-Differences (DID) is a widely used causal inference method for estimating the effect of policy interventions or exogenous shocks when randomized experiments are not feasible. The key...">
<meta name="generator" content="bookdown 0.43 with bs4_book()">
<meta property="og:title" content="Chapter 30 Difference-in-Differences | A Guide on Data Analysis">
<meta property="og:type" content="book">
<meta property="og:url" content="https://bookdown.org/mike/data_analysis/sec-difference-in-differences.html">
<meta property="og:image" content="https://bookdown.org/mike/data_analysis//images/cover.jpg">
<meta property="og:description" content="Difference-in-Differences (DID) is a widely used causal inference method for estimating the effect of policy interventions or exogenous shocks when randomized experiments are not feasible. The key...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 30 Difference-in-Differences | A Guide on Data Analysis">
<meta name="twitter:description" content="Difference-in-Differences (DID) is a widely used causal inference method for estimating the effect of policy interventions or exogenous shocks when randomized experiments are not feasible. The key...">
<meta name="twitter:image" content="https://bookdown.org/mike/data_analysis//images/cover.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.9.0/transition.js"></script><script src="libs/bs3compat-0.9.0/tabs.js"></script><script src="libs/bs3compat-0.9.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){window.dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-DMNX2X65HQ');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">A Guide on Data Analysis</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="prerequisites.html"><span class="header-section-number">2</span> Prerequisites</a></li>
<li class="book-part">I. BASIC</li>
<li><a class="" href="descriptive-statistics.html"><span class="header-section-number">3</span> Descriptive Statistics</a></li>
<li><a class="" href="basic-statistical-inference.html"><span class="header-section-number">4</span> Basic Statistical Inference</a></li>
<li class="book-part">II. REGRESSION</li>
<li><a class="" href="linear-regression.html"><span class="header-section-number">5</span> Linear Regression</a></li>
<li><a class="" href="non-linear-regression.html"><span class="header-section-number">6</span> Non-Linear Regression</a></li>
<li><a class="" href="generalized-linear-models.html"><span class="header-section-number">7</span> Generalized Linear Models</a></li>
<li><a class="" href="sec-linear-mixed-models.html"><span class="header-section-number">8</span> Linear Mixed Models</a></li>
<li><a class="" href="sec-nonlinear-and-generalized-linear-mixed-models.html"><span class="header-section-number">9</span> Nonlinear and Generalized Linear Mixed Models</a></li>
<li><a class="" href="sec-nonparametric-regression.html"><span class="header-section-number">10</span> Nonparametric Regression</a></li>
<li class="book-part">III. RAMIFICATIONS</li>
<li><a class="" href="data.html"><span class="header-section-number">11</span> Data</a></li>
<li><a class="" href="variable-transformation.html"><span class="header-section-number">12</span> Variable Transformation</a></li>
<li><a class="" href="imputation-missing-data.html"><span class="header-section-number">13</span> Imputation (Missing Data)</a></li>
<li><a class="" href="model-specification-tests.html"><span class="header-section-number">14</span> Model Specification Tests</a></li>
<li><a class="" href="variable-selection.html"><span class="header-section-number">15</span> Variable Selection</a></li>
<li><a class="" href="hypothesis-testing.html"><span class="header-section-number">16</span> Hypothesis Testing</a></li>
<li><a class="" href="sec-marginal-effects.html"><span class="header-section-number">17</span> Marginal Effects</a></li>
<li><a class="" href="moderation.html"><span class="header-section-number">18</span> Moderation</a></li>
<li><a class="" href="mediation.html"><span class="header-section-number">19</span> Mediation</a></li>
<li><a class="" href="prediction-and-estimation.html"><span class="header-section-number">20</span> Prediction and Estimation</a></li>
<li class="book-part">IV. CAUSAL INFERENCE</li>
<li><a class="" href="sec-causal-inference.html"><span class="header-section-number">21</span> Causal Inference</a></li>
<li class="book-part">A. EXPERIMENTAL DESIGN</li>
<li><a class="" href="sec-experimental-design.html"><span class="header-section-number">22</span> Experimental Design</a></li>
<li><a class="" href="sampling.html"><span class="header-section-number">23</span> Sampling</a></li>
<li><a class="" href="sec-analysis-of-variance-anova.html"><span class="header-section-number">24</span> Analysis of Variance</a></li>
<li><a class="" href="sec-multivariate-methods.html"><span class="header-section-number">25</span> Multivariate Methods</a></li>
<li class="book-part">B. QUASI-EXPERIMENTAL DESIGN</li>
<li><a class="" href="sec-quasi-experimental.html"><span class="header-section-number">26</span> Quasi-Experimental Methods</a></li>
<li><a class="" href="sec-regression-discontinuity.html"><span class="header-section-number">27</span> Regression Discontinuity</a></li>
<li><a class="" href="temporal-discontinuity-designs.html"><span class="header-section-number">28</span> Temporal Discontinuity Designs</a></li>
<li><a class="" href="sec-synthetic-difference-in-differences.html"><span class="header-section-number">29</span> Synthetic Difference-in-Differences</a></li>
<li><a class="active" href="sec-difference-in-differences.html"><span class="header-section-number">30</span> Difference-in-Differences</a></li>
<li><a class="" href="sec-changes-in-changes.html"><span class="header-section-number">31</span> Changes-in-Changes</a></li>
<li><a class="" href="sec-synthetic-control.html"><span class="header-section-number">32</span> Synthetic Control</a></li>
<li><a class="" href="sec-event-studies.html"><span class="header-section-number">33</span> Event Studies</a></li>
<li><a class="" href="sec-instrumental-variables.html"><span class="header-section-number">34</span> Instrumental Variables</a></li>
<li><a class="" href="sec-matching-methods.html"><span class="header-section-number">35</span> Matching Methods</a></li>
<li class="book-part">C. OTHER CONCERNS</li>
<li><a class="" href="sec-endogeneity.html"><span class="header-section-number">36</span> Endogeneity</a></li>
<li><a class="" href="other-biases.html"><span class="header-section-number">37</span> Other Biases</a></li>
<li><a class="" href="sec-directed-acyclic-graphs.html"><span class="header-section-number">38</span> Directed Acyclic Graphs</a></li>
<li><a class="" href="sec-controls.html"><span class="header-section-number">39</span> Controls</a></li>
<li class="book-part">V. MISCELLANEOUS</li>
<li><a class="" href="report.html"><span class="header-section-number">40</span> Report</a></li>
<li><a class="" href="exploratory-data-analysis.html"><span class="header-section-number">41</span> Exploratory Data Analysis</a></li>
<li><a class="" href="sensitivity-analysis-robustness-check.html"><span class="header-section-number">42</span> Sensitivity Analysis/ Robustness Check</a></li>
<li><a class="" href="replication-and-synthetic-data.html"><span class="header-section-number">43</span> Replication and Synthetic Data</a></li>
<li><a class="" href="high-performance-computing.html"><span class="header-section-number">44</span> High-Performance Computing</a></li>
<li class="book-part">APPENDIX</li>
<li><a class="" href="appendix.html"><span class="header-section-number">A</span> Appendix</a></li>
<li><a class="" href="bookdown-cheat-sheet.html"><span class="header-section-number">B</span> Bookdown cheat sheet</a></li>
<li><a class="" href="references.html">References</a></li>
<li><a class="" href="chapter-cluster-randomization-and-interference-bias.html"><span class="header-section-number">C</span> Chapter: Cluster Randomization and Interference Bias</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/mikenguyen13/data_analysis">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="sec-difference-in-differences" class="section level1" number="30">
<h1>
<span class="header-section-number">30</span> Difference-in-Differences<a class="anchor" aria-label="anchor" href="#sec-difference-in-differences"><i class="fas fa-link"></i></a>
</h1>
<p><a href="sec-difference-in-differences.html#sec-difference-in-differences">Difference-in-Differences</a> (DID) is a widely used causal inference method for estimating the effect of <strong>policy interventions</strong> or <strong>exogenous shocks</strong> when randomized experiments are not feasible. The key idea behind DID is to compare changes in outcomes over time between <strong>treated</strong> and <strong>control</strong> groups, under the assumption that—absent treatment—both groups would have followed parallel trends.</p>
<!-- [List of packages](https://github.com/lnsongxf/DiD-1) -->
<p>DID analysis can go beyond simple treatment effects by exploring causal mechanisms using mediation and moderation analyses:</p>
<ul>
<li>
<a href="sec-difference-in-differences.html#mediation-under-did">Mediation Under DiD</a>: Examines how intermediate variables (e.g., consumer sentiment, brand perception) mediate the treatment effect <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-habel2021variable">Habel, Alavi, and Linsenmayer 2021</a>)</span>.</li>
<li>
<a href="moderation.html#moderation">Moderation</a> Analysis: Studies how treatment effects vary across different groups (e.g., high vs. low brand loyalty) <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-goldfarb2011online">Goldfarb and Tucker 2011</a>)</span>.</li>
</ul>
<div id="empirical-studies" class="section level2" number="30.1">
<h2>
<span class="header-section-number">30.1</span> Empirical Studies<a class="anchor" aria-label="anchor" href="#empirical-studies"><i class="fas fa-link"></i></a>
</h2>
<div id="applications-of-did-in-marketing" class="section level3" number="30.1.1">
<h3>
<span class="header-section-number">30.1.1</span> Applications of DID in Marketing<a class="anchor" aria-label="anchor" href="#applications-of-did-in-marketing"><i class="fas fa-link"></i></a>
</h3>
<p>DID has been extensively applied in marketing and business research to measure the impact of policy changes, advertising campaigns, and competitive actions. Below are several notable examples:</p>
<ul>
<li>
<strong>TV Advertising &amp; Online Shopping</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-liaukonyte2015television">Liaukonyte, Teixeira, and Wilbur 2015</a>)</span>: Examines how TV ads influence consumer behavior in online shopping.</li>
<li>
<strong>Political Advertising &amp; Voting Behavior</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-wang2018border">Wang, Lewis, and Schweidel 2018</a>)</span>: Uses geographic discontinuities at state borders to analyze how ad sources and tone affect voter turnout.</li>
<li>
<strong>Music Streaming &amp; Consumption</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-datta2018changing">Datta, Knox, and Bronnenberg 2018</a>)</span>: Investigates how adopting a music streaming service affects total music consumption.</li>
<li>
<strong>Data Breaches &amp; Customer Spending</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-janakiraman2018effect">Janakiraman, Lim, and Rishika 2018</a>)</span>: Analyzes how customer spending changes after a firm announces a data breach.</li>
<li>
<strong>Price Monitoring &amp; Policy Enforcement</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-israeli2018online">Israeli 2018</a>)</span>: Studies the effect of digital monitoring on minimum advertised price policy enforcement.</li>
<li>
<strong>Foreign Direct Investment &amp; Firm Responses</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-ramani2019effects">Ramani and Srinivasan 2019</a>)</span>: Examines how firms in India responded to FDI liberalization reforms in 1991.</li>
<li>
<strong>Paywalls &amp; Readership</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-pattabhiramaiah2019paywalls">Pattabhiramaiah, Sriram, and Manchanda 2019</a>)</span>: Investigates how implementing paywalls affects online news consumption.</li>
<li>
<strong>Aggregators &amp; Airline Business</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-akca2020value">Akca and Rao 2020</a>)</span>: Evaluates how online aggregators impact airline ticket sales.</li>
<li>
<strong>Nutritional Labels &amp; Competitive Response</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-lim2020competitive">Lim et al. 2020</a>)</span>: Analyzes whether nutrition labels affect the nutritional quality of competing brands.</li>
<li>
<strong>Payment Disclosure &amp; Physician Behavior</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-guo2020let">Guo, Sriram, and Manchanda 2020</a>)</span>: Studies how payment disclosure laws impact prescription behavior.</li>
<li>
<strong>Fake Reviews &amp; Sales</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-he2022market">S. He, Hollenbeck, and Proserpio 2022</a>)</span>: Uses an Amazon policy change to measure the effect of fake reviews on sales and ratings.</li>
<li>
<strong>Data Protection Regulations &amp; Website Usage</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-peukert2022regulatory">Peukert et al. 2022</a>)</span>: Assesses the impact of GDPR regulations on website usage and online business models.</li>
</ul>
</div>
<div id="applications-of-did-in-economics" class="section level3" number="30.1.2">
<h3>
<span class="header-section-number">30.1.2</span> Applications of DID in Economics<a class="anchor" aria-label="anchor" href="#applications-of-did-in-economics"><i class="fas fa-link"></i></a>
</h3>
<p>DID has also been extensively applied in <strong>economics</strong>, particularly in policy evaluation, labor economics, and macroeconomics:</p>
<ul>
<li>
<strong>Natural Experiments in Development Economics</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-rosenzweig2000natural">Rosenzweig and Wolpin 2000</a>)</span>
</li>
<li>
<strong>Instrumental Variables &amp; Natural Experiments</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-angrist2001instrumental">J. D. Angrist and Krueger 2001</a>)</span>
</li>
<li>
<strong>DID in Macroeconomic Policy Analysis</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-fuchs2016natural">Fuchs-Schündeln and Hassan 2016</a>)</span>
</li>
</ul>
<hr>
</div>
</div>
<div id="sec-visualization-did" class="section level2" number="30.2">
<h2>
<span class="header-section-number">30.2</span> Visualization<a class="anchor" aria-label="anchor" href="#sec-visualization-did"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb761"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yiqingxu.org/packages/panelview/index.html">panelView</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="va">base_stagg</span> <span class="op">&lt;-</span> <span class="fu">fixest</span><span class="fu">::</span><span class="va"><a href="https://lrberge.github.io/fixest/reference/base_stagg.html">base_stagg</a></span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># treatment status</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>treat_stat <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">time_to_treatment</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">year</span>, <span class="va">treat_stat</span>, <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">base_stagg</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id year treat_stat           y</span></span>
<span><span class="co">#&gt; 2 90    1          0  0.01722971</span></span>
<span><span class="co">#&gt; 3 89    1          0 -4.58084528</span></span>
<span><span class="co">#&gt; 4 88    1          0  2.73817174</span></span>
<span><span class="co">#&gt; 5 87    1          0 -0.65103066</span></span>
<span><span class="co">#&gt; 6 86    1          0 -5.33381664</span></span>
<span><span class="co">#&gt; 7 85    1          0  0.49562631</span></span>
<span></span>
<span><span class="fu">panelView</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/panelView/man/panelView.html">panelview</a></span><span class="op">(</span></span>
<span>    <span class="va">y</span> <span class="op">~</span> <span class="va">treat_stat</span>,</span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"Unit"</span>,</span>
<span>    display.all <span class="op">=</span> <span class="cn">F</span>,</span>
<span>    gridOff <span class="op">=</span> <span class="cn">T</span>,</span>
<span>    by.timing <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30-dif-in-dif_files/figure-html/unnamed-chunk-1-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb762"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># alternatively specification</span></span>
<span><span class="fu">panelView</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/panelView/man/panelView.html">panelview</a></span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    D <span class="op">=</span> <span class="st">"treat_stat"</span>,</span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"Unit"</span>,</span>
<span>    display.all <span class="op">=</span> <span class="cn">F</span>,</span>
<span>    gridOff <span class="op">=</span> <span class="cn">T</span>,</span>
<span>    by.timing <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30-dif-in-dif_files/figure-html/unnamed-chunk-1-2.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb763"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Average outcomes for each cohort</span></span>
<span><span class="fu">panelView</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/panelView/man/panelView.html">panelview</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span>, </span>
<span>    Y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    D <span class="op">=</span> <span class="st">"treat_stat"</span>,</span>
<span>    index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>    by.timing <span class="op">=</span> <span class="cn">T</span>,</span>
<span>    display.all <span class="op">=</span> <span class="cn">F</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"outcome"</span>, </span>
<span>    by.cohort <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of unique treatment histories: 10</span></span></code></pre></div>
<div class="inline-figure"><img src="30-dif-in-dif_files/figure-html/unnamed-chunk-1-3.png" width="90%" style="display: block; margin: auto;"></div>
</div>
<div id="sec-simple-difference-in-differences" class="section level2" number="30.3">
<h2>
<span class="header-section-number">30.3</span> Simple Difference-in-Differences<a class="anchor" aria-label="anchor" href="#sec-simple-difference-in-differences"><i class="fas fa-link"></i></a>
</h2>
<p>Difference-in-Differences originated as a tool to analyze <a href="sec-quasi-experimental.html#sec-natural-experiments">natural experiments</a>, but its applications extend far beyond that. DID is built on the <a href="data.html#sec-fixed-effects-estimator">Fixed Effects Estimator</a>, making it a fundamental approach for policy evaluation and causal inference in observational studies.</p>
<p>DID leverages inter-temporal variation between groups:</p>
<ul>
<li>
<strong>Cross-sectional comparison</strong>: Helps avoid omitted variable bias due to common trends.</li>
<li>
<strong>Time-series comparison</strong>: Helps mitigate omitted variable bias due to cross-sectional heterogeneity.</li>
</ul>
<hr>
<div id="basic-setup-of-did" class="section level3" number="30.3.1">
<h3>
<span class="header-section-number">30.3.1</span> Basic Setup of DID<a class="anchor" aria-label="anchor" href="#basic-setup-of-did"><i class="fas fa-link"></i></a>
</h3>
<p>Consider a simple setting with:</p>
<ul>
<li>
<strong>Treatment Group</strong> (<span class="math inline">\(D_i = 1\)</span>)</li>
<li>
<strong>Control Group</strong> (<span class="math inline">\(D_i = 0\)</span>)</li>
<li>
<strong>Pre-Treatment Period</strong> (<span class="math inline">\(T = 0\)</span>)</li>
<li>
<strong>Post-Treatment Period</strong> (<span class="math inline">\(T = 1\)</span>)</li>
</ul>
<div class="inline-table"><table style="width:99%;" class="table table-sm">
<colgroup>
<col width="22%">
<col width="37%">
<col width="38%">
</colgroup>
<thead><tr class="header">
<th></th>
<th>
<strong>After Treatment (</strong><span class="math inline">\(T = 1\)</span><strong>)</strong>
</th>
<th>
<strong>Before Treatment (</strong><span class="math inline">\(T = 0\)</span><strong>)</strong>
</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Treated (<span class="math inline">\(D_i = 1\)</span>)</td>
<td><span class="math inline">\(E[Y_{1i}(1)|D_i = 1]\)</span></td>
<td><span class="math inline">\(E[Y_{0i}(0)|D_i = 1]\)</span></td>
</tr>
<tr class="even">
<td>Control (<span class="math inline">\(D_i = 0\)</span>)</td>
<td><span class="math inline">\(E[Y_{0i}(1)|D_i = 0]\)</span></td>
<td><span class="math inline">\(E[Y_{0i}(0)|D_i = 0]\)</span></td>
</tr>
</tbody>
</table></div>
<p>The <strong>fundamental challenge</strong>: We cannot observe <span class="math inline">\(E[Y_{0i}(1)|D_i = 1]\)</span>—i.e., the <strong>counterfactual outcome</strong> for the treated group had they not received treatment.</p>
<hr>
<p>DID estimates the <a href="sec-causal-inference.html#sec-average-treatment-effect-on-the-treated">Average Treatment Effect on the Treated</a> using the following formula:</p>
<p><span class="math display">\[
\begin{aligned}
E[Y_1(1) - Y_0(1) | D = 1] &amp;= \{E[Y(1)|D = 1] - E[Y(1)|D = 0] \} \\
&amp;- \{E[Y(0)|D = 1] - E[Y(0)|D = 0] \}
\end{aligned}
\]</span></p>
<p>This formulation differences out time-invariant unobserved factors, assuming the parallel trends assumption holds.</p>
<ul>
<li>For the treated group, we isolate the difference between being treated and not being treated.</li>
<li>If the control group would have experienced a different trajectory, the DID estimate may be biased.</li>
<li>Since we cannot observe treatment variation in the control group, we cannot infer the treatment effect for this group.</li>
</ul>
<div class="sourceCode" id="cb764"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulated dataset for illustration</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,  <span class="co"># Pre (0) and Post (1)</span></span>
<span>  treated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>, <span class="co"># Control (0) and Treated (1)</span></span>
<span>  error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate outcome variable</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">outcome</span> <span class="op">&lt;-</span></span>
<span>    <span class="fl">5</span> <span class="op">+</span> <span class="fl">3</span> <span class="op">*</span> <span class="va">data</span><span class="op">$</span><span class="va">treated</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">data</span><span class="op">$</span><span class="va">time</span> <span class="op">+</span> </span>
<span>    <span class="fl">4</span> <span class="op">*</span> <span class="va">data</span><span class="op">$</span><span class="va">treated</span> <span class="op">*</span> <span class="va">data</span><span class="op">$</span><span class="va">time</span> <span class="op">+</span> <span class="va">data</span><span class="op">$</span><span class="va">error</span></span>
<span></span>
<span><span class="co"># Compute averages for 2x2 table</span></span>
<span><span class="va">table_means</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">treated</span>, <span class="va">time</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean_outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html">mean</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">treated</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"Treated"</span>, <span class="st">"Control"</span><span class="op">)</span>, <span class="st">", "</span>, </span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">time</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"Post"</span>, <span class="st">"Pre"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Display the 2x2 table</span></span>
<span><span class="va">table_2x2</span> <span class="op">&lt;-</span> <span class="va">table_means</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">mean_outcome</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span>key <span class="op">=</span> <span class="va">group</span>, value <span class="op">=</span> <span class="va">mean_outcome</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/print.html">print</a></span><span class="op">(</span><span class="st">"2x2 Table of Mean Outcomes:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2x2 Table of Mean Outcomes:"</span></span>
<span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/print.html">print</a></span><span class="op">(</span><span class="va">table_2x2</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 4</span></span>
<span><span class="co">#&gt;   `Control, Post` `Control, Pre` `Treated, Post` `Treated, Pre`</span></span>
<span><span class="co">#&gt;             &lt;dbl&gt;          &lt;dbl&gt;           &lt;dbl&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1            7.19           5.20            14.0           8.00</span></span>
<span></span>
<span><span class="co"># Calculate Diff-in-Diff manually</span></span>
<span></span>
<span><span class="co"># Treated, Post</span></span>
<span><span class="va">Y11</span> <span class="op">&lt;-</span> <span class="va">table_means</span><span class="op">$</span><span class="va">mean_outcome</span><span class="op">[</span><span class="va">table_means</span><span class="op">$</span><span class="va">group</span> <span class="op">==</span> <span class="st">"Treated, Post"</span><span class="op">]</span>  </span>
<span></span>
<span><span class="co"># Treated, Pre</span></span>
<span><span class="va">Y10</span> <span class="op">&lt;-</span> <span class="va">table_means</span><span class="op">$</span><span class="va">mean_outcome</span><span class="op">[</span><span class="va">table_means</span><span class="op">$</span><span class="va">group</span> <span class="op">==</span> <span class="st">"Treated, Pre"</span><span class="op">]</span>   </span>
<span></span>
<span><span class="co"># Control, Post</span></span>
<span><span class="va">Y01</span> <span class="op">&lt;-</span> <span class="va">table_means</span><span class="op">$</span><span class="va">mean_outcome</span><span class="op">[</span><span class="va">table_means</span><span class="op">$</span><span class="va">group</span> <span class="op">==</span> <span class="st">"Control, Post"</span><span class="op">]</span>  </span>
<span></span>
<span><span class="co"># Control, Pre</span></span>
<span><span class="va">Y00</span> <span class="op">&lt;-</span> <span class="va">table_means</span><span class="op">$</span><span class="va">mean_outcome</span><span class="op">[</span><span class="va">table_means</span><span class="op">$</span><span class="va">group</span> <span class="op">==</span> <span class="st">"Control, Pre"</span><span class="op">]</span>   </span>
<span></span>
<span><span class="va">diff_in_diff_formula</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">Y11</span> <span class="op">-</span> <span class="va">Y10</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">Y01</span> <span class="op">-</span> <span class="va">Y00</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate DID using OLS</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">treated</span> <span class="op">*</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">ols_estimate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">[</span><span class="st">"treated:time"</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Print results</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  Method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Diff-in-Diff Formula"</span>, <span class="st">"OLS Estimate"</span><span class="op">)</span>,</span>
<span>  Estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">diff_in_diff_formula</span>, <span class="va">ols_estimate</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/print.html">print</a></span><span class="op">(</span><span class="st">"Comparison of DID Estimates:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Comparison of DID Estimates:"</span></span>
<span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/print.html">print</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="co">#&gt;                            Method Estimate</span></span>
<span><span class="co">#&gt;              Diff-in-Diff Formula 4.035895</span></span>
<span><span class="co">#&gt; treated:time         OLS Estimate 4.035895</span></span>
<span></span>
<span><span class="co"># Visualization</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>           x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>,</span>
<span>           y <span class="op">=</span> <span class="va">outcome</span>,</span>
<span>           color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">treated</span><span class="op">)</span>,</span>
<span>           group <span class="op">=</span> <span class="va">treated</span></span>
<span>       <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_summary.html">stat_summary</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">mean</span>, geom <span class="op">=</span> <span class="st">"point"</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_summary.html">stat_summary</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">mean</span>,</span>
<span>                 geom <span class="op">=</span> <span class="st">"line"</span>,</span>
<span>                 linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"Difference-in-Differences Visualization"</span>,</span>
<span>        x <span class="op">=</span> <span class="st">"Time (0 = Pre, 1 = Post)"</span>,</span>
<span>        y <span class="op">=</span> <span class="st">"Outcome"</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"Group"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="st">"Treated"</span><span class="op">)</span>,</span>
<span>                       values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30-dif-in-dif_files/figure-html/unnamed-chunk-2-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th></th>
<th>Control (0)</th>
<th>Treated (1)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>Pre (0)</strong></td>
<td><span class="math inline">\(\bar{Y}_{00} = 5\)</span></td>
<td><span class="math inline">\(\bar{Y}_{10} = 8\)</span></td>
</tr>
<tr class="even">
<td><strong>Post (1)</strong></td>
<td><span class="math inline">\(\bar{Y}_{01} = 7\)</span></td>
<td><span class="math inline">\(\bar{Y}_{11} = 14\)</span></td>
</tr>
</tbody>
</table></div>
<p>The table organizes the mean outcomes into four cells:</p>
<ol style="list-style-type: decimal">
<li><p>Control Group, Pre-period (<span class="math inline">\(\bar{Y}_{00}\)</span>): Mean outcome for the control group before the intervention.</p></li>
<li><p>Control Group, Post-period (<span class="math inline">\(\bar{Y}_{01}\)</span>): Mean outcome for the control group after the intervention.</p></li>
<li><p>Treated Group, Pre-period (<span class="math inline">\(\bar{Y}_{10}\)</span>): Mean outcome for the treated group before the intervention.</p></li>
<li><p>Treated Group, Post-period (<span class="math inline">\(\bar{Y}_{11}\)</span>): Mean outcome for the treated group after the intervention.</p></li>
</ol>
<p>The DID treatment effect calculated from the simple formula of averages is identical to the estimate from an OLS regression with an interaction term.</p>
<p>The treatment effect is calculated as:</p>
<p><span class="math inline">\(\text{DID} = (\bar{Y}_{11} - \bar{Y}_{10}) - (\bar{Y}_{01} - \bar{Y}_{00})\)</span></p>
<p>Compute manually:</p>
<p><span class="math inline">\((\bar{Y}_{11} - \bar{Y}_{10}) - (\bar{Y}_{01} - \bar{Y}_{00})\)</span></p>
<p>Use OLS regression:</p>
<p><span class="math inline">\(Y_{it} = \beta_0 + \beta_1 \text{treated}_i + \beta_2 \text{time}_t + \beta_3 (\text{treated}_i \cdot \text{time}_t) + \epsilon_{it}\)</span></p>
<p>Using the simulated table:</p>
<p><span class="math inline">\(\text{DID} = (14 - 8) - (7 - 5) = 6 - 2 = 4\)</span></p>
<p>This matches the <strong>interaction term coefficient</strong> (<span class="math inline">\(\beta_3 = 4\)</span>) from the OLS regression.</p>
<p>Both methods give the same result!</p>
<hr>
</div>
<div id="extensions-of-did" class="section level3" number="30.3.2">
<h3>
<span class="header-section-number">30.3.2</span> Extensions of DID<a class="anchor" aria-label="anchor" href="#extensions-of-did"><i class="fas fa-link"></i></a>
</h3>
<div id="did-with-more-than-two-groups-or-time-periods" class="section level4" number="30.3.2.1">
<h4>
<span class="header-section-number">30.3.2.1</span> DID with More Than Two Groups or Time Periods<a class="anchor" aria-label="anchor" href="#did-with-more-than-two-groups-or-time-periods"><i class="fas fa-link"></i></a>
</h4>
<p>DID can be extended to <strong>multiple treatments, multiple controls</strong>, and more than two periods:</p>
<p><span class="math display">\[
Y_{igt} = \alpha_g + \gamma_t + \beta I_{gt} + \delta X_{igt} + \epsilon_{igt}
\]</span></p>
<p>where:</p>
<ul>
<li><p><span class="math inline">\(\alpha_g\)</span> = Group-Specific Fixed Effects (e.g., firm, region).</p></li>
<li><p><span class="math inline">\(\gamma_t\)</span> = Time-Specific Fixed Effects (e.g., year, quarter).</p></li>
<li><p><span class="math inline">\(\beta\)</span> = DID Effect.</p></li>
<li><p><span class="math inline">\(I_{gt}\)</span> = Interaction Terms (Treatment × Post-Treatment).</p></li>
<li><p><span class="math inline">\(\delta X_{igt}\)</span> = Additional Covariates.</p></li>
</ul>
<p>This is known as the <a href="sec-difference-in-differences.html#sec-two-way-fixed-effects">Two-Way Fixed Effects DID</a> model. However, TWFE performs poorly under staggered treatment adoption, where different groups receive treatment at different times.</p>
<hr>
</div>
<div id="examining-long-term-effects-dynamic-did" class="section level4" number="30.3.2.2">
<h4>
<span class="header-section-number">30.3.2.2</span> Examining Long-Term Effects (Dynamic DID)<a class="anchor" aria-label="anchor" href="#examining-long-term-effects-dynamic-did"><i class="fas fa-link"></i></a>
</h4>
<p>To examine the dynamic treatment effects (that are not under rollout/staggered design), we can create a centered time variable.</p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="30%">
<col width="69%">
</colgroup>
<thead><tr class="header">
<th>Centered Time Variable</th>
<th>Interpretation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(t = -2\)</span></td>
<td>Two periods before treatment</td>
</tr>
<tr class="even">
<td><span class="math inline">\(t = -1\)</span></td>
<td>One period before treatment</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(t = 0\)</span></td>
<td>
<p>Last pre-treatment period right before treatment period</p>
<p>(Baseline/Reference Group)</p>
</td>
</tr>
<tr class="even">
<td><span class="math inline">\(t = 1\)</span></td>
<td>Treatment period</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(t = 2\)</span></td>
<td>One period after treatment</td>
</tr>
</tbody>
</table></div>
<p><strong>Dynamic Treatment Model Specification</strong></p>
<p>By interacting this factor variable, we can examine the dynamic effect of treatment (i.e., whether it’s fading or intensifying):</p>
<p><span class="math display">\[
\begin{aligned}
Y &amp;= \alpha_0 + \alpha_1 Group + \alpha_2 Time  \\
&amp;+ \beta_{-T_1} Treatment + \beta_{-(T_1 -1)} Treatment + \dots + \beta_{-1} Treatment \\
&amp;+ \beta_1 + \dots + \beta_{T_2} Treatment
\end{aligned}
\]</span></p>
<p>where:</p>
<ul>
<li><p><span class="math inline">\(\beta_0\)</span> (Baseline Period) is the reference group (i.e., drop from the model).</p></li>
<li><p><span class="math inline">\(T_1\)</span> = Pre-Treatment Period.</p></li>
<li><p><span class="math inline">\(T_2\)</span> = Post-Treatment Period.</p></li>
<li><p>Treatment coefficients (<span class="math inline">\(\beta_t\)</span>) measure the effect over time.</p></li>
</ul>
<p><strong>Key Observations</strong>:</p>
<ul>
<li><p>Pre-treatment coefficients should be close to zero (<span class="math inline">\(\beta_{-T_1}, \dots, \beta_{-1} \approx 0\)</span>), ensuring no pre-trend bias.</p></li>
<li><p>Post-treatment coefficients should be significantly different from zero (<span class="math inline">\(\beta_1, \dots, \beta_{T_2} \neq 0\)</span>), measuring the treatment effect over time.</p></li>
<li><p>Higher standard errors with more interactions: Including too many lags can reduce precision.</p></li>
</ul>
<hr>
</div>
<div id="did-on-relationships-not-just-levels" class="section level4" number="30.3.2.3">
<h4>
<span class="header-section-number">30.3.2.3</span> DID on Relationships, Not Just Levels<a class="anchor" aria-label="anchor" href="#did-on-relationships-not-just-levels"><i class="fas fa-link"></i></a>
</h4>
<p>DID can also be applied to relationships between variables rather than just outcome levels.</p>
<p>For example, DID can be used to estimate treatment effects on regression coefficients by comparing relationships before and after a policy change.</p>
<hr>
</div>
</div>
<div id="goals-of-did" class="section level3" number="30.3.3">
<h3>
<span class="header-section-number">30.3.3</span> Goals of DID<a class="anchor" aria-label="anchor" href="#goals-of-did"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<strong>Pre-Treatment Coefficients Should Be Insignificant</strong>
<ul>
<li>Ensure that <span class="math inline">\(\beta_{-T_1}, \dots, \beta_{-1} = 0\)</span> (similar to a <a href="Ensure%20no%20pre-treatment%20effects.">Placebo Test</a>).</li>
</ul>
</li>
<li>
<strong>Post-Treatment Coefficients Should Be Significant</strong>
<ul>
<li>Verify that <span class="math inline">\(\beta_1, \dots, \beta_{T_2} \neq 0\)</span>.</li>
<li>Examine whether the trend in post-treatment coefficients is increasing or decreasing over time.</li>
</ul>
</li>
</ol>
<hr>
<div class="sourceCode" id="cb765"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">od</span> <span class="op">&lt;-</span> <span class="fu">causaldata</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/causaldata/man/organ_donations.html">organ_donations</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span>    <span class="co"># Treatment variable</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>California <span class="op">=</span> <span class="va">State</span> <span class="op">==</span> <span class="st">'California'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># centered time variable</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>center_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">Quarter_Num</span> <span class="op">-</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>  </span>
<span><span class="co"># where 3 is the reference period precedes the treatment period</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">od</span><span class="op">$</span><span class="va">California</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "logical"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">od</span><span class="op">$</span><span class="va">State</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "character"</span></span>
<span></span>
<span><span class="va">cali</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">Rate</span> <span class="op">~</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/i.html">i</a></span><span class="op">(</span><span class="va">center_time</span>, <span class="va">California</span>, ref <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|</span></span>
<span>                  <span class="va">State</span> <span class="op">+</span> <span class="va">center_time</span>,</span>
<span>              data <span class="op">=</span> <span class="va">od</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/etable.html">etable</a></span><span class="op">(</span><span class="va">cali</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                              cali</span></span>
<span><span class="co">#&gt; Dependent Var.:                              Rate</span></span>
<span><span class="co">#&gt;                                                  </span></span>
<span><span class="co">#&gt; California x center_time = -2    -0.0029 (0.0051)</span></span>
<span><span class="co">#&gt; California x center_time = -1   0.0063** (0.0023)</span></span>
<span><span class="co">#&gt; California x center_time = 1  -0.0216*** (0.0050)</span></span>
<span><span class="co">#&gt; California x center_time = 2  -0.0203*** (0.0045)</span></span>
<span><span class="co">#&gt; California x center_time = 3    -0.0222* (0.0100)</span></span>
<span><span class="co">#&gt; Fixed-Effects:                -------------------</span></span>
<span><span class="co">#&gt; State                                         Yes</span></span>
<span><span class="co">#&gt; center_time                                   Yes</span></span>
<span><span class="co">#&gt; _____________________________ ___________________</span></span>
<span><span class="co">#&gt; S.E.: Clustered                         by: State</span></span>
<span><span class="co">#&gt; Observations                                  162</span></span>
<span><span class="co">#&gt; R2                                        0.97934</span></span>
<span><span class="co">#&gt; Within R2                                 0.00979</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">iplot</a></span><span class="op">(</span><span class="va">cali</span>, pt.join <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30-dif-in-dif_files/figure-html/unnamed-chunk-3-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb766"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">coefplot</a></span><span class="op">(</span><span class="va">cali</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30-dif-in-dif_files/figure-html/unnamed-chunk-3-2.png" width="90%" style="display: block; margin: auto;"></div>
</div>
</div>
<div id="empirical-research-walkthrough" class="section level2" number="30.4">
<h2>
<span class="header-section-number">30.4</span> Empirical Research Walkthrough<a class="anchor" aria-label="anchor" href="#empirical-research-walkthrough"><i class="fas fa-link"></i></a>
</h2>
<div id="example-the-unintended-consequences-of-ban-the-box-policies" class="section level3" number="30.4.1">
<h3>
<span class="header-section-number">30.4.1</span> Example: The Unintended Consequences of “Ban the Box” Policies<a class="anchor" aria-label="anchor" href="#example-the-unintended-consequences-of-ban-the-box-policies"><i class="fas fa-link"></i></a>
</h3>
<p><span class="citation">Doleac and Hansen (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-doleac2020unintended">2020</a>)</span> examine the unintended effects of “Ban the Box” (BTB) policies, which prevent employers from asking about criminal records during the hiring process. The intended goal of BTB was to increase job access for individuals with criminal records. However, the study found that employers, unable to observe criminal history, resorted to statistical discrimination based on race, leading to unintended negative consequences.</p>
<p>Three Types of “Ban the Box” Policies:</p>
<ol style="list-style-type: decimal">
<li>Public employers only</li>
<li>Private employers with government contracts</li>
<li>All employers</li>
</ol>
<p>Identification Strategy</p>
<ul>
<li>If any county within a Metropolitan Statistical Area (MSA) adopts BTB, the entire MSA is considered treated.</li>
<li>If a state passes a law banning BTB, then all counties in that state are treated.</li>
</ul>
<hr>
<p>The <a href="sec-difference-in-differences.html#sec-simple-difference-in-differences">basic DiD model</a> is:</p>
<p><span class="math display">\[
Y_{it} = \beta_0 + \beta_1 \text{Post}_t + \beta_2 \text{Treat}_i + \beta_3 (\text{Post}_t \times \text{Treat}_i) + \epsilon_{it}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(Y_{it}\)</span> = employment outcome for individual <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span>
</li>
<li>
<span class="math inline">\(\text{Post}_t\)</span> = indicator for post-treatment period</li>
<li>
<span class="math inline">\(\text{Treat}_i\)</span> = indicator for treated MSAs</li>
<li>
<span class="math inline">\(\beta_3\)</span> = the DiD coefficient, capturing the effect of BTB on employment</li>
<li>
<span class="math inline">\(\epsilon_{it}\)</span> = error term</li>
</ul>
<p><strong>Limitations</strong>: If different locations adopt BTB at different times, this model is not valid due to staggered treatment timing.</p>
<hr>
<p>For settings where different MSAs adopt BTB at different times, we use a <strong>staggered DiD</strong> approach:</p>
<p><span class="math display">\[
\begin{aligned}
E_{imrt} &amp;= \alpha + \beta_1 BTB_{imt} W_{imt} + \beta_2 BTB_{mt} + \beta_3 BTB_{mt} H_{imt} \\
&amp;+ \delta_m + D_{imt} \beta_5 + \lambda_{rt} + \delta_m \times f(t) \beta_7 + e_{imrt}
\end{aligned}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(i\)</span> = individual, <span class="math inline">\(m\)</span> = MSA, <span class="math inline">\(r\)</span> = region (e.g., Midwest, South), <span class="math inline">\(t\)</span> = year</li>
<li>
<span class="math inline">\(W\)</span> = White; <span class="math inline">\(B\)</span> = Black; <span class="math inline">\(H\)</span> = Hispanic</li>
<li>
<span class="math inline">\(BTB_{imt}\)</span> = Ban the Box policy indicator</li>
<li>
<span class="math inline">\(\delta_m\)</span> = MSA fixed effect</li>
<li>
<span class="math inline">\(D_{imt}\)</span> = individual-level controls</li>
<li>
<span class="math inline">\(\lambda_{rt}\)</span> = region-by-time fixed effect</li>
<li>
<span class="math inline">\(\delta_m \times f(t)\)</span> = linear time trend within MSA</li>
</ul>
<p><strong>Fixed Effects Considerations</strong>:</p>
<ul>
<li><p>Including <span class="math inline">\(\lambda_r\)</span> and <span class="math inline">\(\lambda_t\)</span> separately gives broader fixed effects.</p></li>
<li><p>Using <span class="math inline">\(\lambda_{rt}\)</span> provides more granular controls for regional time trends.</p></li>
</ul>
<hr>
<p>To estimate the effects for Black men specifically, the model simplifies to:</p>
<p><span class="math display">\[
E_{imrt} = \alpha + BTB_{mt} \beta_1 + \delta_m + D_{imt} \beta_5 + \lambda_{rt} + (\delta_m \times f(t)) \beta_7 + e_{imrt}
\]</span></p>
<hr>
<p>To check for pre-trends and dynamic effects, we estimate:</p>
<p><span class="math display">\[
\begin{aligned}
E_{imrt} &amp;= \alpha + BTB_{m (t - 3)} \theta_1 + BTB_{m (t - 2)} \theta_2 + BTB_{m (t - 1)} \theta_3 \\
&amp;+ BTB_{mt} \theta_4 + BTB_{m (t + 1)} \theta_5 + BTB_{m (t + 2)} \theta_6 + BTB_{m (t + 3)} \theta_7 \\
&amp;+ \delta_m + D_{imt} \beta_5 + \lambda_{r} + (\delta_m \times f(t)) \beta_7 + e_{imrt}
\end{aligned}
\]</span></p>
<p>Key points:</p>
<ul>
<li>Leave out <span class="math inline">\(BTB_{m (t - 1)} \theta_3\)</span> as the reference category (to avoid perfect collinearity).</li>
<li>If <span class="math inline">\(\theta_2\)</span> is significantly different from <span class="math inline">\(\theta_3\)</span>, it suggests pre-trend issues, which could indicate anticipatory effects before BTB implementation.</li>
</ul>
<blockquote>
<p>Substantively, <span class="citation">Shoag and Veuger (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-shoag2021ban">2021</a>)</span> show that Ban-the-box policies increased employment in high-crime neighborhoods by up to 4%, especially in the public sector and low-wage jobs. This is the first nationwide evidence that such laws improve job access for areas with many ex-offenders.</p>
</blockquote>
<hr>
</div>
<div id="example-minimum-wage-and-employment" class="section level3" number="30.4.2">
<h3>
<span class="header-section-number">30.4.2</span> Example: Minimum Wage and Employment<a class="anchor" aria-label="anchor" href="#example-minimum-wage-and-employment"><i class="fas fa-link"></i></a>
</h3>
<p><span class="citation">Card and Krueger (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-card1993minimum">1993</a>)</span> famously studied the effect of an increase in the minimum wage on employment, challenging the traditional economic view that higher wages reduce employment.</p>
<ul>
<li>
<a href="https://rpubs.com/phle/r_tutorial_difference_in_differences">Philipp Leppert</a> provides an R-based replication.</li>
<li>Original datasets are available at <a href="https://davidcard.berkeley.edu/data_sets.html">David Card’s website</a>.</li>
</ul>
<p>Setting</p>
<ul>
<li>
<strong>Treatment group</strong>: New Jersey (NJ), which increased its minimum wage.</li>
<li>
<strong>Control group</strong>: Pennsylvania (PA), which did not change its minimum wage.</li>
<li>
<strong>Outcome variable</strong>: Employment levels in fast-food restaurants.</li>
</ul>
<p>The study used a Difference-in-Differences approach to estimate the impact:</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th></th>
<th>State</th>
<th>After (Post)</th>
<th>Before (Pre)</th>
<th>Difference</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Treatment</td>
<td>NJ</td>
<td>A</td>
<td>B</td>
<td>A - B</td>
</tr>
<tr class="even">
<td>Control</td>
<td>PA</td>
<td>C</td>
<td>D</td>
<td>C - D</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>A - C</td>
<td>B - D</td>
<td>(A - B) - (C - D)</td>
</tr>
</tbody>
</table></div>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(A - B\)</span> captures the treatment effect plus general time trends.</li>
<li>
<span class="math inline">\(C - D\)</span> captures only the general time trends.</li>
<li>
<span class="math inline">\((A - B) - (C - D)\)</span> isolates the causal effect of the minimum wage increase.</li>
</ul>
<p>For the DiD estimator to be valid, the following conditions must hold:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Parallel Trends Assumption</strong>
<ul>
<li>The employment trends in NJ and PA would have been the same in the absence of the policy change.</li>
<li>Pre-treatment employment trends should be similar between the two states.</li>
</ul>
</li>
<li>
<strong>No “Switchers”</strong>
<ul>
<li>The policy must not induce restaurants to switch locations between NJ and PA (e.g., a restaurant relocating across the border).</li>
</ul>
</li>
<li>
<strong>PA as a Valid Counterfactual</strong>
<ul>
<li>PA represents what NJ would have looked like had it not changed the minimum wage.</li>
<li>The study focuses on bordering counties to increase comparability.</li>
</ul>
</li>
</ol>
<hr>
<p>The main regression specification is:</p>
<p><span class="math display">\[
Y_{jt} = \beta_0 + NJ_j \beta_1 + POST_t \beta_2 + (NJ_j \times POST_t)\beta_3+ X_{jt}\beta_4 + \epsilon_{jt}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(Y_{jt}\)</span> = Employment in restaurant <span class="math inline">\(j\)</span> at time <span class="math inline">\(t\)</span>
</li>
<li>
<span class="math inline">\(NJ_j\)</span> = 1 if restaurant is in NJ, 0 if in PA</li>
<li>
<span class="math inline">\(POST_t\)</span> = 1 if post-policy period, 0 if pre-policy</li>
<li>
<span class="math inline">\((NJ_j \times POST_t)\)</span> = <strong>DiD interaction term</strong>, capturing the causal effect of NJ’s minimum wage increase</li>
<li>
<span class="math inline">\(X_{jt}\)</span> = Additional controls (optional)</li>
<li>
<span class="math inline">\(\epsilon_{jt}\)</span> = Error term</li>
</ul>
<p>Notes on Model Specification</p>
<ul>
<li><p><span class="math inline">\(\beta_3\)</span> (DiD coefficient) is the key parameter of interest, representing the causal impact of the policy.</p></li>
<li><p><span class="math inline">\(\beta_4\)</span> (controls <span class="math inline">\(X_{jt}\)</span>) is not necessary for unbiasedness but improves efficiency.</p></li>
<li>
<p>If we difference out the pre-period (<span class="math inline">\(\Delta Y_{jt} = Y_{j,Post} - Y_{j,Pre}\)</span>), we can simplify the model:</p>
<p><span class="math display">\[
\Delta Y_{jt} = \alpha + NJ_j \beta_1 + \epsilon_{jt}
\]</span></p>
<p>Here, we no longer need <span class="math inline">\(\beta_2\)</span> for the post-treatment period.</p>
</li>
</ul>
<hr>
<p>An alternative specification uses high-wage NJ restaurants as a control group, arguing that they were not affected by the minimum wage increase. However:</p>
<ul>
<li>This approach eliminates cross-state differences, but</li>
<li>It may be harder to interpret causality, as the control group is not entirely untreated.</li>
</ul>
<hr>
<p>A common misconception in DiD is that treatment and control groups must have the same baseline levels of the dependent variable (e.g., employment levels). However:</p>
<ul>
<li>DiD only requires parallel trends, meaning the slopes of employment changes should be the same pre-treatment.</li>
<li>If pre-treatment trends diverge, this threatens validity.</li>
<li>If post-treatment trends converge, it may suggest policy effects rather than pre-trend violations.</li>
</ul>
<p>Is Parallel Trends a Necessary or Sufficient Condition?</p>
<ul>
<li>Not sufficient: Even if pre-trends are parallel, other confounders could affect results.</li>
<li>Not necessary: Parallel trends may emerge only after treatment, depending on behavioral responses.</li>
</ul>
<p>Thus, we cannot prove DiD is valid—we can only present evidence that supports the assumptions.</p>
<hr>
</div>
<div id="example-the-effects-of-grade-policies-on-major-choice" class="section level3" number="30.4.3">
<h3>
<span class="header-section-number">30.4.3</span> Example: The Effects of Grade Policies on Major Choice<a class="anchor" aria-label="anchor" href="#example-the-effects-of-grade-policies-on-major-choice"><i class="fas fa-link"></i></a>
</h3>
<p><span class="citation">Butcher, McEwan, and Weerapana (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-butcher2014effects">2014</a>)</span> investigate how grading policies influence students’ major choices. The central theory is that grading standards vary by discipline, which affects students’ decisions.</p>
<p>Why do the highest-achieving students often major in hard sciences?</p>
<ol style="list-style-type: decimal">
<li>
<strong>Grading Practices Differ Across Majors</strong>
<ul>
<li>In STEM fields, grading is often stricter, meaning professors are less likely to give students the benefit of the doubt.</li>
<li>In contrast, softer disciplines (e.g., humanities) may have more lenient grading, making students’ experiences more pleasant.</li>
</ul>
</li>
<li>
<strong>Labor Market Incentives</strong>
<ul>
<li>Degrees with lower market value (e.g., humanities) might compensate by offering a more pleasant academic experience.</li>
<li>STEM degrees tend to be more rigorous but provide higher job market returns.</li>
</ul>
</li>
</ol>
<hr>
<p>To examine how grades influence major selection, the study first estimates an OLS model:</p>
<p><span class="math display">\[
E_{ij} = \beta_0 + X_i \beta_1 + G_j \beta_2 + \epsilon_{ij}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(E_{ij}\)</span> = Indicator for whether student <span class="math inline">\(i\)</span> chooses major <span class="math inline">\(j\)</span>.</li>
<li>
<span class="math inline">\(X_i\)</span> = Student-level attributes (e.g., SAT scores, demographics).</li>
<li>
<span class="math inline">\(G_j\)</span> = Average grade in major <span class="math inline">\(j\)</span>.</li>
<li>
<span class="math inline">\(\beta_2\)</span> = Key coefficient, capturing how grading standards influence major choice.</li>
</ul>
<p>Potential Biases in <span class="math inline">\(\hat{\beta}_2\)</span>:</p>
<ul>
<li>
<strong>Negative Bias</strong>:
<ul>
<li>Departments with lower enrollment rates may offer higher grades to attract students.</li>
<li>This endogenous response leads to a downward bias in the OLS estimate.</li>
</ul>
</li>
<li>
<strong>Positive Bias</strong>:
<ul>
<li>STEM majors attract the best students, so their grades would naturally be higher if ability were controlled.</li>
<li>If ability is not fully accounted for, <span class="math inline">\(\hat{\beta}_2\)</span> may be upward biased.</li>
</ul>
</li>
</ul>
<hr>
<p>To address potential endogeneity in OLS, the study uses a difference-in-differences approach:</p>
<p><span class="math display">\[
Y_{idt} = \beta_0 + POST_t \beta_1 + Treat_d \beta_2 + (POST_t \times Treat_d)\beta_3 + X_{idt} + \epsilon_{idt}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(Y_{idt}\)</span> = Average grade in department <span class="math inline">\(d\)</span> at time <span class="math inline">\(t\)</span> for student <span class="math inline">\(i\)</span>.</li>
<li>
<span class="math inline">\(POST_t\)</span> = 1 if post-policy period, 0 otherwise.</li>
<li>
<span class="math inline">\(Treat_d\)</span> = 1 if department is treated (i.e., grade policy change), 0 otherwise.</li>
<li>
<span class="math inline">\((POST_t \times Treat_d)\)</span> = <strong>DiD interaction term</strong>, capturing the causal effect of grade policy changes on major choice.</li>
<li>
<span class="math inline">\(X_{idt}\)</span> = Additional student controls.</li>
</ul>
<hr>
<div class="inline-table"><table style="width:97%;" class="table table-sm">
<caption>Difference-in-Differences Table</caption>
<colgroup>
<col width="17%">
<col width="20%">
<col width="20%">
<col width="16%">
<col width="22%">
</colgroup>
<thead><tr class="header">
<th>Group</th>
<th>Intercept (<span class="math inline">\(\beta_0\)</span>)</th>
<th>Treatment (<span class="math inline">\(\beta_2\)</span>)</th>
<th>Post (<span class="math inline">\(\beta_1\)</span>)</th>
<th>Interaction (<span class="math inline">\(\beta_3\)</span>)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>Treated, Pre</strong></td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td><strong>Treated, Post</strong></td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td><strong>Control, Pre</strong></td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td><strong>Control, Post</strong></td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table></div>
<ul>
<li>The average pre-period outcome for the control group is given by <span class="math inline">\(\beta_0\)</span>.</li>
<li>The key coefficient of interest is <span class="math inline">\(\beta_3\)</span>, which captures the difference in the post-treatment effect between treated and control groups.</li>
</ul>
<hr>
<p>A more flexible specification includes fixed effects:</p>
<p><span class="math display">\[
Y_{idt} = \alpha_0 + (POST_t \times Treat_d) \alpha_1 + \theta_d + \delta_t + X_{idt} + u_{idt}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(\theta_d\)</span> = Department fixed effects (absorbing <span class="math inline">\(Treat_d\)</span>).</li>
<li>
<span class="math inline">\(\delta_t\)</span> = Time fixed effects (absorbing <span class="math inline">\(POST_t\)</span>).</li>
<li>
<span class="math inline">\(\alpha_1\)</span> = Effect of policy change (equivalent to <span class="math inline">\(\beta_3\)</span> in the simpler model).</li>
</ul>
<p>Why Use Fixed Effects?</p>
<ul>
<li>
<strong>More flexible specification</strong>:
<ul>
<li>Instead of assuming a uniform treatment effect across groups, this model allows for department-specific differences (<span class="math inline">\(\theta_d\)</span>) and time-specific shocks (<span class="math inline">\(\delta_t\)</span>).</li>
</ul>
</li>
<li>
<strong>Higher degrees of freedom</strong>:
<ul>
<li>Fixed effects absorb variation that would otherwise be attributed to <span class="math inline">\(POST_t\)</span> and <span class="math inline">\(Treat_d\)</span>, making the estimation more efficient.</li>
</ul>
</li>
</ul>
<p>Interpretation of Results</p>
<ul>
<li>If <span class="math inline">\(\alpha_1 &gt; 0\)</span>, then the policy <strong>increased</strong> grades in treated departments.</li>
<li>If <span class="math inline">\(\alpha_1 &lt; 0\)</span>, then the policy <strong>decreased</strong> grades in treated departments.</li>
</ul>
<hr>
</div>
</div>
<div id="one-difference" class="section level2" number="30.5">
<h2>
<span class="header-section-number">30.5</span> One Difference<a class="anchor" aria-label="anchor" href="#one-difference"><i class="fas fa-link"></i></a>
</h2>
<p>The regression formula is as follows <span class="citation">Liaukonytė, Tuchman, and Zhu (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-liaukonyte2023frontiers">2023</a>)</span>:</p>
<p><span class="math display">\[
y_{ut} = \beta \text{Post}_t + \gamma_u + \gamma_w(t) + \gamma_l + \gamma_g(u)p(t) + \epsilon_{ut}
\]</span></p>
<p>where</p>
<ul>
<li>
<span class="math inline">\(y_{ut}\)</span>: Outcome of interest for unit u in time t.</li>
<li>
<span class="math inline">\(\text{Post}_t\)</span>: Dummy variable representing a specific post-event period.</li>
<li>
<span class="math inline">\(\beta\)</span>: Coefficient measuring the average change in the outcome after the event relative to the pre-period.</li>
<li>
<span class="math inline">\(\gamma_u\)</span>: Fixed effects for each unit.</li>
<li>
<span class="math inline">\(\gamma_w(t)\)</span>: Time-specific fixed effects to account for periodic variations.</li>
<li>
<span class="math inline">\(\gamma_l\)</span>: Dummy variable for a specific significant period (e.g., a major event change).</li>
<li>
<span class="math inline">\(\gamma_g(u)p(t)\)</span>: Group x period fixed effects for flexible trends that may vary across different categories (e.g., geographical regions) and periods.</li>
<li>
<span class="math inline">\(\epsilon_{ut}\)</span>: Error term.</li>
</ul>
<p>This model can be used to analyze the impact of an event on the outcome of interest while controlling for various fixed effects and time-specific variations, but using units themselves pre-treatment as controls.</p>
<hr>
</div>
<div id="sec-two-way-fixed-effects" class="section level2" number="30.6">
<h2>
<span class="header-section-number">30.6</span> Two-Way Fixed Effects<a class="anchor" aria-label="anchor" href="#sec-two-way-fixed-effects"><i class="fas fa-link"></i></a>
</h2>
<p>A generalization of the <a href="sec-difference-in-differences.html#sec-difference-in-differences">Difference-in-Differences</a> model is the two-way fixed effects (TWFE) model, which accounts for <strong>multiple groups</strong> and <strong>multiple time periods</strong> by including both unit and time fixed effects. In practice, TWFE is frequently used to estimate causal effects in panel data settings. However, it is <strong>not</strong> a design-based, non-parametric causal estimator <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2021use">Imai and Kim 2021</a>)</span>, and it can suffer from severe biases if the treatment effect is heterogeneous across units or time.</p>
<p>When applying TWFE to datasets with <strong>multiple treatment groups</strong> and <strong>staggered treatment timing</strong>, the estimated causal coefficient is a <strong>weighted average</strong> of all possible two-group, two-period DiD comparisons. Crucially, some of these weights can be <strong>negative</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-goodman2021difference">Goodman-Bacon 2021</a>)</span>, which leads to potential biases. The weighting scheme depends on:</p>
<ul>
<li><strong>Group sizes</strong></li>
<li><strong>Variation in treatment timing</strong></li>
<li>
<strong>Placement in the middle of the panel</strong> (units in the middle tend to get the highest weight)</li>
</ul>
<hr>
<div id="canonical-twfe-model" class="section level3" number="30.6.1">
<h3>
<span class="header-section-number">30.6.1</span> Canonical TWFE Model<a class="anchor" aria-label="anchor" href="#canonical-twfe-model"><i class="fas fa-link"></i></a>
</h3>
<p>The canonical TWFE model is typically written as:</p>
<p><span class="math display">\[
Y_{it} = \alpha_i + \lambda_t + \tau W_{it} + \beta X_{it} + \epsilon_{it},
\]</span></p>
<p>where:</p>
<ul>
<li><p><span class="math inline">\(Y_{it}\)</span> = Outcome for unit <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span></p></li>
<li><p><span class="math inline">\(\alpha_i\)</span> = Unit fixed effect</p></li>
<li><p><span class="math inline">\(\lambda_t\)</span> = Time fixed effect</p></li>
<li><p><span class="math inline">\(\tau\)</span> = Causal effect of treatment</p></li>
<li><p><span class="math inline">\(W_{it}\)</span> = Treatment indicator (<span class="math inline">\(1\)</span> if treated, <span class="math inline">\(0\)</span> otherwise)</p></li>
<li><p><span class="math inline">\(X_{it}\)</span> = Covariates</p></li>
<li><p><span class="math inline">\(\epsilon_{it}\)</span> = Error term</p></li>
</ul>
<p>An illustrative TWFE event-study model <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-stevenson2006bargaining">Stevenson and Wolfers 2006</a>)</span>:</p>
<p><span class="math display">\[ \begin{aligned} Y_{it} &amp;= \sum_{k} \beta_{k} \cdot Treatment_{it}^{k} \;+\; \eta_{i} \;+\; \lambda_{t} \;+\; Controls_{it} \;+\; \epsilon_{it}, \end{aligned} \]</span></p>
<p>where:</p>
<ul>
<li><p><span class="math inline">\(Treatment_{it}^k\)</span>: Indicator for whether unit <span class="math inline">\(i\)</span> is in its <span class="math inline">\(k\)</span>-th year relative to treatment at time <span class="math inline">\(t\)</span>.</p></li>
<li><p><span class="math inline">\(\eta_i\)</span>: Unit fixed effects, controlling for time-invariant unobserved heterogeneity.</p></li>
<li><p><span class="math inline">\(\lambda_t\)</span>: Time fixed effects, capturing overall macro shocks.</p></li>
<li><p>Standard Errors: Typically clustered at the group or cohort level.</p></li>
</ul>
<p>Usually, researchers drop the period <strong>immediately before treatment</strong> (<span class="math inline">\(k=-1\)</span>) to avoid collinearity. However, dropping this or another period inappropriately can shift or bias the estimates.</p>
<p>When there are only two time periods <span class="math inline">\((T=2)\)</span>, TWFE simplifies to the <a href="sec-difference-in-differences.html#sec-simple-difference-in-differences">traditional DiD model</a>. Under <strong>homogeneous treatment effects</strong> and if the <a href="sec-difference-in-differences.html#prior-parallel-trends-test">parallel trends assumption</a> holds, <span class="math inline">\(\hat{\tau}_{OLS}\)</span> is unbiased. Specifically, the model assumes <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2021use">Imai and Kim 2021</a>)</span>:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Homogeneous treatment effects</strong> across units and time periods, meaning:
<ul>
<li>No dynamic treatment effects (i.e., treatment effects do not evolve over time).</li>
<li>The treatment effect is constant across units <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-goodman2021difference">Goodman-Bacon 2021</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-de2020two">Clément De Chaisemartin and d’Haultfoeuille 2020</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">L. Sun and Abraham 2021</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-borusyak2021revisiting">Borusyak, Jaravel, and Spiess 2021</a>)</span>.</li>
</ul>
</li>
<li><a href="sec-difference-in-differences.html#prior-parallel-trends-test">Parallel trends assumption</a></li>
<li>
<strong>Linear additive effects</strong> are valid <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2021use">Imai and Kim 2021</a>)</span>.</li>
</ol>
<p>However, in practice, <strong>treatment effects are often heterogeneous</strong>. If effects vary by cohort or over time, then standard TWFE estimates can be biased—particularly when there is staggered adoption or dynamic treatment effects <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-goodman2021difference">Goodman-Bacon 2021</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-de2020two">Clément De Chaisemartin and d’Haultfoeuille 2020</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">L. Sun and Abraham 2021</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-borusyak2021revisiting">Borusyak, Jaravel, and Spiess 2021</a>)</span>. Hence, to use the TWFE, we actually have to argue why the effects are homogeneous to justify TWFE use:</p>
<ul>
<li>
<strong>Assess treatment heterogeneity</strong>: If heterogeneity exists, TWFE may produce biased estimates. Researchers should:
<ul>
<li>Plot treatment timing across units.</li>
<li>Decompose the treatment effect using the <a href="sec-difference-in-differences.html#sec-goodman-bacon-decomposition">Goodman-Bacon decomposition</a> to identify negative weights.</li>
<li>Check the proportion of never-treated observations: When 80% or more of the sample is never treated, TWFE bias is negligible.</li>
<li>Beware of bias worsening with long-run effects.</li>
</ul>
</li>
<li>
<strong>Dropping relative time periods</strong>:
<ul>
<li>If all units eventually receive treatment, two relative time periods must be dropped to avoid multicollinearity.</li>
<li>Some software packages drop periods randomly; if a post-treatment period is dropped, bias may result.</li>
<li>The standard approach is to drop periods -1 and -2.</li>
</ul>
</li>
<li>
<strong>Sources of treatment heterogeneity</strong>:
<ul>
<li>Delayed treatment effects: The impact of treatment may take time to manifest.</li>
<li>Evolving effects: Treatment effects can increase or change over time (e.g., phase-in effects).</li>
</ul>
</li>
</ul>
<hr>
<p>TWFE compares different types of treatment/control groups:</p>
<ul>
<li>
<strong>Valid comparisons</strong>:
<ul>
<li>Newly treated units vs. control units</li>
<li>Newly treated units vs. not-yet treated units</li>
</ul>
</li>
<li>
<strong>Problematic comparisons</strong>:
<ul>
<li>Newly treated units vs. already treated units (since already treated units do not represent the correct counterfactual).</li>
<li>
<strong>Strict exogeneity violations</strong>:
<ul>
<li>Presence of time-varying confounders</li>
<li>Feedback from past outcomes to treatment <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2019should">Imai and Kim 2019</a>)</span>
</li>
</ul>
</li>
<li>
<strong>Functional form restrictions</strong>:
<ul>
<li>Assumes treatment effect homogeneity.</li>
<li>No carryover effects or anticipation effects <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2019should">Imai and Kim 2019</a>)</span>.</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
</div>
<div id="limitations-of-twfe" class="section level3" number="30.6.2">
<h3>
<span class="header-section-number">30.6.2</span> Limitations of TWFE<a class="anchor" aria-label="anchor" href="#limitations-of-twfe"><i class="fas fa-link"></i></a>
</h3>
<p>TWFE DiD is <strong>valid only</strong> under strong assumptions that the treatment effect does not vary across units or over time. In reality, we almost always see some form of <strong>treatment heterogeneity</strong>:</p>
<ul>
<li>
<strong>No dynamic treatment effects</strong>: The model requires that the treatment effect not evolve over time.</li>
<li>
<strong>No unit-level differences</strong>: The treatment effect must be constant across all units.</li>
<li>
<strong>Linear additive effects</strong>: TWFE assumes that the underlying data-generating process is captured by additive fixed effects plus a constant treatment effect <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2021use">Imai and Kim 2021</a>)</span>.</li>
</ul>
<p>If any of these assumptions are violated, TWFE can produce biased estimates. Specifically:</p>
<ul>
<li>
<strong>Negative Weights &amp; Biased Estimates</strong>: With multiple groups and staggered timing, the TWFE estimate becomes a complicated average of “two-group, two-period” DiD comparisons, some of which can receive <strong>negative weights</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-goodman2021difference">Goodman-Bacon 2021</a>)</span>.</li>
<li>
<strong>Potential Bias from Dropping Relative Time Periods</strong>: If all units eventually get treated, software often drops a reference period (or periods) to avoid multicollinearity. If the dropped period is post-treatment, the bias can worsen. Researchers often drop relative time <span class="math inline">\(-1\)</span> or <span class="math inline">\(-2\)</span>.</li>
<li>
<strong>Delayed or Evolving Treatment Effects</strong>: If the effect of treatment takes time to manifest or changes over time, TWFE’s single coefficient <span class="math inline">\(\tau\)</span> can be misleading.</li>
</ul>
<p>When <strong>two time periods only</strong> exist, TWFE collapses back to the <a href="sec-difference-in-differences.html#sec-simple-difference-in-differences">traditional DiD model</a>, making these problems far less severe. But as soon as one moves beyond a single treatment period or has variation in treatment timing, these issues become critical.</p>
<p>Several authors <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">L. Sun and Abraham 2021</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-callaway2021difference">Callaway and Sant’Anna 2021</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-goodman2021difference">Goodman-Bacon 2021</a>)</span> have raised concerns that TWFE DiD regressions under staggered adoption:</p>
<ul>
<li>
<strong>Mixes Cohorts</strong>: May unintentionally compare newly treated units to already treated units, conflating post-treatment behavior of early adopters with the pre-treatment trends of later adopters.</li>
<li>
<strong>Negative Weights</strong>: Some group comparisons receive negative weights, which can reverse the sign of the overall estimate.</li>
<li>
<strong>Pre-Treatment Leads</strong>: Leads may appear non-zero if earlier-treated groups remain in the sample while later adopters are still untreated.</li>
<li>
<strong>Long-Run Effects</strong>: Heterogeneity in lagged (long-run) effects can exacerbate bias.</li>
</ul>
<p>In fields like finance and accounting, <a href="sec-difference-in-differences.html#sec-modern-estimators-for-staggered-adoption">newer estimators</a> often reveal <strong>null or much smaller</strong> effects than standard TWFE once bias is properly accounted for <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-baker2022much">Baker, Larcker, and Wang 2022</a>)</span>.</p>
<hr>
</div>
<div id="diagnosing-and-addressing-bias-in-twfe" class="section level3" number="30.6.3">
<h3>
<span class="header-section-number">30.6.3</span> Diagnosing and Addressing Bias in TWFE<a class="anchor" aria-label="anchor" href="#diagnosing-and-addressing-bias-in-twfe"><i class="fas fa-link"></i></a>
</h3>
<p>Researchers can identify and mitigate the biases arising from heterogeneous treatment effects through diagnostic checks and alternative estimators:</p>
<ol style="list-style-type: decimal">
<li><a href="sec-difference-in-differences.html#sec-goodman-bacon-decomposition">Goodman-Bacon Decomposition</a></li>
</ol>
<ul>
<li>
<strong>Purpose</strong>: Decomposes the TWFE DiD estimate into the sum of all two-group, two-period comparisons.</li>
<li>
<strong>Insight</strong>: Reveals which comparisons have negative weights and how much each comparison contributes to the overall estimate <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-goodman2021difference">Goodman-Bacon 2021</a>)</span>.</li>
<li>
<strong>Implementation</strong>: Identify subgroups by treatment timing, then examine each group–time pair to see how it contributes to the aggregate TWFE coefficient.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><a href="sec-difference-in-differences.html#sec-visualization-did">Plotting Treatment Timing</a></li>
</ol>
<ul>
<li>
<strong>Visual Inspection</strong>: Always plot the distribution of treatment timing across units.</li>
<li>
<strong>High Risk of Bias</strong>: If treatment is staggered and many units differ in their adoption times, standard TWFE will often be biased.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><strong>Assessing Treatment Heterogeneity Directly</strong></li>
</ol>
<ul>
<li>
<strong>Check for Variation in Effects</strong>: If there is a theoretical or empirical reason to believe that treatment effects differ by subgroup or over time, TWFE might not be appropriate.</li>
<li>
<strong>Size of Never-Treated Sample</strong>: When 80% or more of the sample is never treated, the potential for bias in TWFE is smaller. However, large shares of treated units with varied adoption times raise red flags.</li>
<li>
<strong>Long-Run Effects</strong>: Bias can worsen if the treatment effect accumulates or changes over time.</li>
</ul>
<hr>
<div id="sec-goodman-bacon-decomposition" class="section level4" number="30.6.3.1">
<h4>
<span class="header-section-number">30.6.3.1</span> Goodman-Bacon Decomposition<a class="anchor" aria-label="anchor" href="#sec-goodman-bacon-decomposition"><i class="fas fa-link"></i></a>
</h4>
<p>The Goodman-Bacon decomposition <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-goodman2021difference">Goodman-Bacon 2021</a>)</span> is a powerful diagnostic tool for understanding the <a href="sec-difference-in-differences.html#sec-two-way-fixed-effects">TWFE</a> estimator in settings with <a href="sec-difference-in-differences.html#sec-staggered-difference-in-differences">staggered treatment adoption</a>. This approach clarifies how the TWFE DiD estimate is a weighted average of many <strong>2×2 difference-in-differences comparisons</strong> between groups treated at different times (or never treated).</p>
<!-- For an excellent set of explanatory slides by the author, [see here](https://www.stata.com/meeting/chicago19/slides/chicago19_Goodman-Bacon.pdf). -->
<p>Key Takeaways</p>
<ul>
<li>A pairwise DiD estimate (<span class="math inline">\(\tau\)</span>) receives <strong>more weight</strong> when:
<ul>
<li>The treatment happens <strong>closer to the midpoint</strong> of the observation window.</li>
<li>The comparison involves <strong>more observations</strong> (e.g., more units or more years).</li>
</ul>
</li>
<li>Comparisons between early-treated and later-treated groups can produce <strong>negative weights</strong>, potentially biasing the aggregate TWFE estimate.</li>
</ul>
<p>We illustrate the decomposition using the <code>castle</code> dataset from the <code>bacondecomp</code> package:</p>
<div class="sourceCode" id="cb767"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">bacondecomp</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load and inspect the castle dataset</span></span>
<span><span class="va">castle</span> <span class="op">&lt;-</span> <span class="fu">bacondecomp</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/bacondecomp/man/castle.html">castle</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">l_homicide</span>, <span class="va">post</span>, <span class="va">state</span>, <span class="va">year</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">castle</span><span class="op">)</span></span>
<span><span class="co">#&gt;   l_homicide post   state year</span></span>
<span><span class="co">#&gt; 1   2.027356    0 Alabama 2000</span></span>
<span><span class="co">#&gt; 2   2.164867    0 Alabama 2001</span></span>
<span><span class="co">#&gt; 3   1.936334    0 Alabama 2002</span></span>
<span><span class="co">#&gt; 4   1.919567    0 Alabama 2003</span></span>
<span><span class="co">#&gt; 5   1.749841    0 Alabama 2004</span></span>
<span><span class="co">#&gt; 6   2.130440    0 Alabama 2005</span></span></code></pre></div>
<p>Running the Goodman-Bacon Decomposition</p>
<div class="sourceCode" id="cb768"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Apply Goodman-Bacon decomposition</span></span>
<span><span class="va">df_bacon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/bacondecomp/man/bacon.html">bacon</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">l_homicide</span> <span class="op">~</span> <span class="va">post</span>,</span>
<span>  data <span class="op">=</span> <span class="va">castle</span>,</span>
<span>  id_var <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_var <span class="op">=</span> <span class="st">"year"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;                       type  weight  avg_est</span></span>
<span><span class="co">#&gt; 1 Earlier vs Later Treated 0.05976 -0.00554</span></span>
<span><span class="co">#&gt; 2 Later vs Earlier Treated 0.03190  0.07032</span></span>
<span><span class="co">#&gt; 3     Treated vs Untreated 0.90834  0.08796</span></span>
<span></span>
<span><span class="co"># Display weighted average of the decomposition</span></span>
<span><span class="va">weighted_avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">df_bacon</span><span class="op">$</span><span class="va">estimate</span> <span class="op">*</span> <span class="va">df_bacon</span><span class="op">$</span><span class="va">weight</span><span class="op">)</span></span>
<span><span class="va">weighted_avg</span></span>
<span><span class="co">#&gt; [1] 0.08181162</span></span></code></pre></div>
<p>Comparing with the TWFE Estimate</p>
<div class="sourceCode" id="cb769"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit a TWFE model</span></span>
<span><span class="va">fit_tw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">l_homicide</span> <span class="op">~</span> <span class="va">post</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">castle</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">fit_tw</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 61 × 5</span></span>
<span><span class="co">#&gt;    term                     estimate std.error statistic   p.value</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;                       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 (Intercept)                1.95      0.0624    31.2   2.84e-118</span></span>
<span><span class="co">#&gt;  2 post                       0.0818    0.0317     2.58  1.02e-  2</span></span>
<span><span class="co">#&gt;  3 factor(state)Alaska       -0.373     0.0797    -4.68  3.77e-  6</span></span>
<span><span class="co">#&gt;  4 factor(state)Arizona       0.0158    0.0797     0.198 8.43e-  1</span></span>
<span><span class="co">#&gt;  5 factor(state)Arkansas     -0.118     0.0810    -1.46  1.44e-  1</span></span>
<span><span class="co">#&gt;  6 factor(state)California   -0.108     0.0810    -1.34  1.82e-  1</span></span>
<span><span class="co">#&gt;  7 factor(state)Colorado     -0.696     0.0810    -8.59  1.14e- 16</span></span>
<span><span class="co">#&gt;  8 factor(state)Connecticut  -0.785     0.0810    -9.68  2.08e- 20</span></span>
<span><span class="co">#&gt;  9 factor(state)Delaware     -0.547     0.0810    -6.75  4.18e- 11</span></span>
<span><span class="co">#&gt; 10 factor(state)Florida      -0.251     0.0798    -3.14  1.76e-  3</span></span>
<span><span class="co">#&gt; # ℹ 51 more rows</span></span></code></pre></div>
<blockquote>
<p><strong>Interpretation</strong>: The TWFE estimate (approx. 0.08) equals the weighted average of the Bacon decomposition estimates, confirming the decomposition’s validity.</p>
</blockquote>
<hr>
<p>Visualizing the Decomposition</p>
<div class="sourceCode" id="cb770"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_bacon</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">weight</span>,</span>
<span>    y <span class="op">=</span> <span class="va">estimate</span>,</span>
<span>    color <span class="op">=</span> <span class="va">type</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Weight"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Estimate"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Comparison Type"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30-dif-in-dif_files/figure-html/unnamed-chunk-7-1.png" width="90%" style="display: block; margin: auto;"></div>
<blockquote>
<p><strong>Insight</strong>: This plot shows the contribution of each 2×2 DiD comparison, highlighting how estimates with large weights dominate the overall TWFE coefficient.</p>
</blockquote>
<hr>
<p>Interpretation and Practical Implications</p>
<ul>
<li>
<strong>Purpose</strong>: Decomposes the TWFE DiD estimate into the sum of all two-group, two-period comparisons.</li>
<li>
<strong>Insight</strong>: Reveals how much each comparison contributes to the overall estimate and whether any have negative or misleading effects.</li>
<li>
<strong>Implementation</strong>:
<ul>
<li>Identify subgroups by treatment timing.</li>
<li>Compute DiD for each 2×2 comparison (early vs. late, late vs. never, etc.).</li>
<li>Evaluate how these contribute to the final TWFE estimate.</li>
</ul>
</li>
</ul>
<p>When time-varying covariates are included that allow for identification within treatment timing groups, certain problematic comparisons (like “early vs. late”) may no longer influence the TWFE estimator directly. These scenarios may collapse into simpler within-group estimates, improving identification.</p>
<p>Summary Table: Goodman-Bacon Comparison Types</p>
<div class="inline-table"><table style="width:99%;" class="table table-sm">
<colgroup>
<col width="22%">
<col width="51%">
<col width="25%">
</colgroup>
<thead><tr class="header">
<th>Comparison Type</th>
<th>Description</th>
<th>Common Issue</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Treated vs. Never</td>
<td>Clean comparisons if never-treated units exist</td>
<td>Often reliable</td>
</tr>
<tr class="even">
<td>Early vs. Late</td>
<td>Later group is control in earlier period</td>
<td>May introduce bias</td>
</tr>
<tr class="odd">
<td>Late vs. Early</td>
<td>Early group is control in later period</td>
<td>May reverse causality</td>
</tr>
<tr class="even">
<td>Treated vs. Treated</td>
<td>Within-treatment variation by timing</td>
<td>Sensitive to dynamics</td>
</tr>
</tbody>
</table></div>
<hr>
</div>
</div>
<div id="remedies-for-twfes-shortcomings" class="section level3" number="30.6.4">
<h3>
<span class="header-section-number">30.6.4</span> Remedies for TWFE’s Shortcomings<a class="anchor" aria-label="anchor" href="#remedies-for-twfes-shortcomings"><i class="fas fa-link"></i></a>
</h3>
<p>This section outlines <strong>alternative estimators</strong> and design-based approaches that explicitly handle <strong>heterogeneous treatment effects</strong>, <strong>staggered adoption</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-baker2022much">Baker, Larcker, and Wang 2022</a>)</span>, and <strong>dynamic treatment effects</strong> better than standard TWFE (e.g., <a href="sec-difference-in-differences.html#sec-modern-estimators-for-staggered-adoption">Modern Estimators for Staggered Adoption</a>).</p>
<ol style="list-style-type: decimal">
<li><a href="sec-difference-in-differences.html#sec-group-time-average-treatment-effects-callaway2021difference">Group-Time Average Treatment Effects</a></li>
</ol>
<p><span class="citation">Callaway and Sant’Anna (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-callaway2021difference">2021</a>)</span> propose a two-step approach:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Group-time treatment effects</strong>: In each time period, estimate the effect for the cohort that first received treatment in that period (compared to a never-treated group).</li>
<li>
<strong>Aggregate</strong>: Use a bootstrap procedure to account for autocorrelation and clustering, then aggregate across groups.</li>
</ol>
<ul>
<li>
<strong>Advantages</strong>: Allows for <strong>heterogeneous treatment effects</strong> across groups and over time; compares treated groups only with never-treated units (or well-chosen controls).</li>
<li>
<strong>Implementation</strong>: <code>did</code> package in R.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><a href="sec-difference-in-differences.html#sec-cohort-average-treatment-effects-sun2021estimating">Event-Study Design with Cohort-Specific Estimates</a></li>
</ol>
<p><span class="citation">L. Sun and Abraham (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">2021</a>)</span> build on <span class="citation">Callaway and Sant’Anna (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-callaway2021difference">2021</a>)</span> to handle event-study settings:</p>
<ul>
<li>
<strong>Lags and Leads</strong>: Capture dynamic treatment effects by including time lags and leads relative to the event (treatment).</li>
<li>
<strong>Cohort-Specific Estimates</strong>: Estimate separate paths of outcomes for each cohort, controlling for other cohorts carefully.</li>
<li>
<strong>Interaction-Weighted Estimator</strong>: Adjusts for differences in when treatment began.</li>
<li>
<strong>Implementation</strong>: <code>fixest</code> package in R.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><a href="sec-difference-in-differences.html#sec-panel-match-did-estimator-with-in-and-out-treatment-conditions">Panel Match DiD Estimator with In-and-Out Treatment Conditions</a></li>
</ol>
<p><span class="citation">Imai and Kim (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2021use">2021</a>)</span> develop methods allowing units to <strong>switch in and out</strong> of treatment:</p>
<ul>
<li>
<strong>Matching</strong> to create a weighted version of TWFE, addressing some of the bias from heterogeneous effects.</li>
<li>
<strong>Implementation</strong>: <code>wfe</code> and <code>PanelMatch</code> R packages.</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Two-Stage Difference-in-Differences (DiD2S)</li>
</ol>
<p><span class="citation">Gardner (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-gardner2022two">2022</a>)</span> propose <strong>two-stage DiD</strong>:</p>
<ul>
<li>
<strong>Idea</strong>: Partial out fixed effects first, then perform a second-stage regression that focuses on within-group/time variation.</li>
<li>
<strong>Strength</strong>: Handles heterogeneous treatment effects well, especially when never-treated units are present.</li>
<li>
<strong>Implementation</strong>: <code>did2s</code> R package.</li>
</ul>
<ol start="5" style="list-style-type: decimal">
<li><a href="sec-difference-in-differences.html#sec-switching-difference-in-differences-estimator-de2020two">Switching DiD Estimator</a></li>
</ol>
<ul>
<li>If a study has <strong>never-treated units</strong>, <span class="citation">Clément De Chaisemartin and d’Haultfoeuille (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-de2020two">2020</a>)</span> suggest an <a href="sec-difference-in-differences.html#sec-switching-difference-in-differences-estimator-de2020two">switching DiD estimator</a> to recover the <a href="sec-causal-inference.html#sec-average-treatment-effect">average treatment effect</a>.</li>
<li>
<strong>Caveat</strong>: This approach still fails to detect heterogeneity if treatment effects vary with <strong>exposure length</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2022linear">L. Sun and Shapiro 2022</a>)</span>.</li>
</ul>
<ol start="6" style="list-style-type: decimal">
<li><a href="sec-difference-in-differences.html#sec-matrix-completion-estimator">Matrix Completion Estimator</a></li>
<li><a href="sec-difference-in-differences.html#sec-reshaped-inverse-probability-weighting-twfe-estimator">Reshaped Inverse Probability Weighting–TWFE Estimator</a></li>
</ol>
<ul>
<li>
<strong>Design-Based Approaches</strong>: <span class="citation">Arkhangelsky et al. (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-arkhangelsky2024design">2024</a>)</span> offer further refinements that incorporate inverse probability weighting.</li>
<li>
<strong>Goal</strong>: Improve balance and reduce bias from non-random treatment timing.</li>
</ul>
<ol start="7" style="list-style-type: decimal">
<li>
<a href="sec-difference-in-differences.html#sec-stacked-difference-in-differences">Stacked DID</a> (Simpler but Biased)
<ul>
<li>Build stacked datasets for each treatment cohort, running separate regressions for each “event window.”</li>
<li>This approach is simpler but can still carry biases if the underlying assumptions are violated <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-gormley2011growing">Gormley and Matsa 2011</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-cengiz2019effect">Cengiz et al. 2019</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-deshpande2019screened">Deshpande and Li 2019</a>)</span>.</li>
</ul>
</li>
<li>
<a href="sec-difference-in-differences.html#doubly-robust-difference-in-differences-estimators">Doubly Robust Difference-in-Differences Estimators</a> (DR-DID) <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sant2020doubly">Sant’Anna and Zhao 2020</a>)</span>
<ul>
<li>DR-DID estimators combine outcome regression and propensity score weighting to identify treatment effects, remaining consistent if either model is correctly specified.</li>
<li>They achieve local efficiency under joint correctness and can be applied to both panel and repeated cross-section data.</li>
</ul>
</li>
<li><a href="sec-difference-in-differences.html#nonlinear-difference-in-differences">Nonlinear Difference-in-Differences</a></li>
</ol>
<hr>
</div>
<div id="best-practices-and-recommendations" class="section level3" number="30.6.5">
<h3>
<span class="header-section-number">30.6.5</span> Best Practices and Recommendations<a class="anchor" aria-label="anchor" href="#best-practices-and-recommendations"><i class="fas fa-link"></i></a>
</h3>
<p>Below are practical guidelines for deciding when to use TWFE and how to diagnose or address potential bias.</p>
<ol style="list-style-type: decimal">
<li>
<strong>When is TWFE Appropriate?</strong>
<ul>
<li>
<strong>Single Treatment Period</strong>: TWFE DiD works well if there is <strong>only one</strong> treatment period for all treated units (no variation in timing).</li>
<li>
<strong>Homogeneous Effects</strong>: If strong theoretical or empirical reasons suggest <strong>constant treatment effects</strong> across cohorts and over time, TWFE remains a reasonable choice.</li>
</ul>
</li>
<li>
<strong>Diagnosing and Addressing Bias with Staggered Adoption</strong>
<ul>
<li>
<strong>Plot Treatment Timing</strong>: Examine the distribution of treatment timing across units. If treatment adoption is highly staggered, TWFE is likely to produce biased estimates.</li>
<li>
<strong>Decomposition Methods</strong>: Use the <a href="sec-difference-in-differences.html#sec-goodman-bacon-decomposition">Goodman-Bacon Decomposition</a> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-goodman2021difference">Goodman-Bacon 2021</a>)</span> to see how TWFE pools comparisons (and whether negative weights emerge). If decomposition is infeasible (e.g., unbalanced panels), the share of never-treated units can indicate potential bias severity.
<ul>
<li>Decomposes the TWFE DiD estimate into two-group, two-period comparisons.</li>
<li>Identifies which comparisons receive negative weights, which can lead to biased estimates.</li>
<li>Helps determine the influence of specific groups on the overall estimate.</li>
</ul>
</li>
<li>
<strong>Discuss Heterogeneity</strong>: Explicitly state the likelihood of treatment effect heterogeneity; incorporate it into the research design.</li>
</ul>
</li>
<li>
<strong>Event-Study Specifications within TWFE</strong>
<ul>
<li>
<strong>Avoid Arbitrary Binning</strong>: Do not collapse multiple time periods into a single bin unless you can justify <strong>homogeneous</strong> effects within that bin.</li>
<li>
<strong>Full Relative-Time Indicators</strong>: Include flexible event-time indicators, carefully choosing a reference period (commonly <span class="math inline">\(-1\)</span>, the year before treatment). Specifically, Include fully flexible relative time indicators, and justify the reference period (usually <span class="math inline">\(l = -1\)</span> or the period just prior to treatment).</li>
<li>
<strong>Beware of Multicollinearity</strong>: Including leads and lags can cause multicollinearity and artificially produce significant “pre-trends.”</li>
<li>
<strong>Drop the Right Periods</strong>: If all units eventually get treated, dropping post-treatment periods accidentally can bias results.</li>
</ul>
</li>
<li><a href="sec-difference-in-differences.html#sec-modern-estimators-for-staggered-adoption"><strong>Consider Alternative Estimators</strong></a></li>
</ol>
<hr>
</div>
</div>
<div id="sec-multiple-periods-and-variation-in-treatment-timing" class="section level2" number="30.7">
<h2>
<span class="header-section-number">30.7</span> Multiple Periods and Variation in Treatment Timing<a class="anchor" aria-label="anchor" href="#sec-multiple-periods-and-variation-in-treatment-timing"><i class="fas fa-link"></i></a>
</h2>
<p>TWFE has been extended beyond the simple DiD setup to <strong>multiple periods</strong> and <strong>staggered adoption</strong> (where treatment occurs at different times for different units). Such designs are common in applied economics, public policy, and longitudinal research. However, standard TWFE regressions <strong>can</strong> be biased in these contexts when treatment effects are heterogeneous across groups or over time.</p>
<div id="sec-staggered-difference-in-differences" class="section level3" number="30.7.1">
<h3>
<span class="header-section-number">30.7.1</span> Staggered Difference-in-Differences<a class="anchor" aria-label="anchor" href="#sec-staggered-difference-in-differences"><i class="fas fa-link"></i></a>
</h3>
<p>In <strong>staggered treatment adoption</strong> (also called event-study DiD or dynamic DiD):</p>
<ul>
<li>Different units adopt the treatment at <strong>different time periods</strong>.</li>
<li>Standard TWFE often produces biased estimates because it “pools” all treated units (regardless of when they started treatment) together, implicitly comparing newly treated units to already treated ones.</li>
<li>Treatments that occurred earlier may contaminate the counterfactual for later adopters if the model does not properly handle dynamic or heterogeneous effects <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-wing2024designing">Wing et al. 2024</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-baker2022much">Baker, Larcker, and Wang 2022</a>)</span>.</li>
<li>For applied guidance, see <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-wing2024designing">Wing et al. 2024</a>)</span> and recommendations in <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-baker2022much">Baker, Larcker, and Wang 2022</a>)</span>.</li>
</ul>
<p>Researchers should be aware that standard TWFE can <strong>mix treatment effects</strong> of early adopters (long-exposed) with later adopters (newly exposed), potentially assigning <strong>negative weights</strong> to particular group comparisons <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-goodman2021difference">Goodman-Bacon 2021</a>)</span>.</p>
<p>When using staggered adoption, the following assumptions are critical:</p>
<ol style="list-style-type: decimal">
<li>
<p><strong>Rollout Exogeneity</strong><br>
Treatment assignment and timing should be uncorrelated with potential outcomes.</p>
<ul>
<li>Evidence: Regress adoption on pre-treatment variables. And if you find evidence of correlation, include linear trends interacted with pre-treatment variables <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-hoynes2009consumption">Hoynes and Schanzenbach 2009</a>)</span>
</li>
<li>Evidence: <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-deshpande2019screened">Deshpande and Li 2019, 223</a>)</span>
<ul>
<li>Treatment is random: Regress treatment status at the unit level to all pre-treatment observables. If you have some that are predictive of treatment status, you might have to argue why it’s not a worry. At best, you want this.</li>
<li>Treatment timing is random: Conditional on treatment, regress timing of the treatment on pre-treatment observables. At least, you want this.</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>No Confounding Events</strong><br>
Ensure no other policies or shocks coincide with the staggered treatment rollout.</p></li>
<li>
<p><strong>Exclusion Restrictions</strong></p>
<ul>
<li>
<strong>No Anticipation</strong>: Treatment timing should not affect outcomes prior to treatment.</li>
<li>
<strong>Invariance to History</strong>: Treatment duration shouldn’t matter; only the treated status matters (often violated).</li>
</ul>
</li>
<li>
<p><strong>Standard DID Assumptions</strong></p>
<ul>
<li>
<strong>Parallel Trends</strong> (Conditional or Unconditional)</li>
<li><strong>Random Sampling</strong></li>
<li>
<strong>Overlap</strong> (Common Support)</li>
<li><strong>Effect Additivity</strong></li>
</ul>
</li>
</ol>
<hr>
</div>
</div>
<div id="sec-modern-estimators-for-staggered-adoption" class="section level2" number="30.8">
<h2>
<span class="header-section-number">30.8</span> Modern Estimators for Staggered Adoption<a class="anchor" aria-label="anchor" href="#sec-modern-estimators-for-staggered-adoption"><i class="fas fa-link"></i></a>
</h2>
<div id="sec-group-time-average-treatment-effects-callaway2021difference" class="section level3" number="30.8.1">
<h3>
<span class="header-section-number">30.8.1</span> Group-Time Average Treatment Effects <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-callaway2021difference">Callaway and Sant’Anna 2021</a>)</span><a class="anchor" aria-label="anchor" href="#sec-group-time-average-treatment-effects-callaway2021difference"><i class="fas fa-link"></i></a>
</h3>
<p><strong>Notation Recap</strong></p>
<ul>
<li><p><span class="math inline">\(Y_{it}(0)\)</span>: Potential outcome for unit <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span> in the absence of treatment.</p></li>
<li><p><span class="math inline">\(Y_{it}(g)\)</span>: Potential outcome for unit <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span> if first treated in period <span class="math inline">\(g\)</span>.</p></li>
<li>
<p><span class="math inline">\(Y_{it}\)</span>: Observed outcome for unit <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span>.</p>
<p><span class="math display">\[
Y_{it} =
\begin{cases}
Y_{it}(0), &amp; \text{if unit } i \text{ never treated ( } C_i = 1 \text{)} \\
1\{G_i &gt; t\} Y_{it}(0) + 1\{G_i \le t\} Y_{it}(G_i), &amp; \text{otherwise}
\end{cases}
\]</span></p>
</li>
<li><p><span class="math inline">\(G_i\)</span>: Group assignment, i.e., the time period when unit <span class="math inline">\(i\)</span> first receives treatment.</p></li>
<li><p><span class="math inline">\(C_i = 1\)</span>: Indicator that unit <span class="math inline">\(i\)</span> never receives treatment (the never-treated group).</p></li>
<li><p><span class="math inline">\(D_{it} = 1\{G_i \le t\}\)</span>: Indicator that unit <span class="math inline">\(i\)</span> has been treated by time <span class="math inline">\(t\)</span>.</p></li>
</ul>
<hr>
<p><strong>Assumptions</strong></p>
<p>The following assumptions are typically imposed to identify treatment effects in staggered adoption settings.</p>
<ol style="list-style-type: decimal">
<li><p><strong>Staggered Treatment Adoption</strong><br>
Once treated, a unit remains treated in all subsequent periods.<br>
Formally, <span class="math inline">\(D_{it}\)</span> is non-decreasing in <span class="math inline">\(t\)</span>.</p></li>
<li>
<p><strong>Parallel Trends Assumptions</strong> (Conditional or Unconditional on Covariates)</p>
<p>Two common variants:</p>
<ul>
<li>
<strong>Parallel trends based on never-treated units</strong>: <span class="math display">\[
\mathbb{E}[Y_t(0) - Y_{t-1}(0) | G_i = g] = \mathbb{E}[Y_t(0) - Y_{t-1}(0) | C_i = 1]
\]</span> Interpretation:
<ul>
<li>The average potential outcome trends of the treated group (<span class="math inline">\(G_i = g\)</span>) are the same as the <strong>never-treated</strong> group, absent treatment.</li>
</ul>
</li>
<li>
<strong>Parallel trends based on not-yet-treated units</strong>: <span class="math display">\[
\mathbb{E}[Y_t(0) - Y_{t-1}(0) | G_i = g] = \mathbb{E}[Y_t(0) - Y_{t-1}(0) | D_{is} = 0, G_i \ne g]
\]</span> Interpretation:
<ul>
<li>Units <strong>not yet treated</strong> by time <span class="math inline">\(s\)</span> (<span class="math inline">\(D_{is} = 0\)</span>) can serve as controls for units first treated at <span class="math inline">\(g\)</span>.</li>
</ul>
</li>
</ul>
<p>These assumptions can also be <strong>conditional on covariates</strong> <span class="math inline">\(X\)</span>, as:</p>
<p><span class="math display">\[
\mathbb{E}[Y_t(0) - Y_{t-1}(0) | X_i, G_i = g] = \mathbb{E}[Y_t(0) - Y_{t-1}(0) | X_i, C_i = 1]
\]</span></p>
</li>
<li><p><strong>Random Sampling</strong><br>
Units are sampled independently and identically from the population.</p></li>
<li><p><strong>Irreversibility of Treatment</strong><br>
Once treated, units do not revert to untreated status.</p></li>
<li><p><strong>Overlap (Positivity)</strong><br>
For each group <span class="math inline">\(g\)</span>, the propensity of receiving treatment at <span class="math inline">\(g\)</span> lies strictly within <span class="math inline">\((0, 1)\)</span>: <span class="math display">\[
0 &lt; \mathbb{P}(G_i = g | X_i) &lt; 1
\]</span></p></li>
</ol>
<hr>
<p>The Group-Time <a href="sec-causal-inference.html#sec-average-treatment-effect-on-the-treated">ATT</a>, <span class="math inline">\(ATT(g, t)\)</span>, measures the average treatment effect for units first treated in period <span class="math inline">\(g\)</span>, evaluated at time <span class="math inline">\(t\)</span>.</p>
<p><span class="math display">\[
ATT(g, t) = \mathbb{E}[Y_t(g) - Y_t(0) | G_i = g]
\]</span></p>
<p>Interpretation:</p>
<ul>
<li><p><span class="math inline">\(g\)</span> indexes when the group first receives treatment.</p></li>
<li><p><span class="math inline">\(t\)</span> is the time period when the effect is evaluated.</p></li>
<li><p><span class="math inline">\(ATT(g, t)\)</span> captures how treatment effects evolve over time, following adoption at time <span class="math inline">\(g\)</span>.</p></li>
</ul>
<hr>
<p>Identification of <span class="math inline">\(ATT(g, t)\)</span></p>
<ol style="list-style-type: decimal">
<li><p><strong>Using Never-Treated Units as Controls</strong>: <span class="math display">\[
ATT(g, t) = \mathbb{E}[Y_t - Y_{g-1} | G_i = g] - \mathbb{E}[Y_t - Y_{g-1} | C_i = 1], \quad \forall t \ge g
\]</span></p></li>
<li><p><strong>Using Not-Yet-Treated Units as Controls</strong>: <span class="math display">\[
ATT(g, t) = \mathbb{E}[Y_t - Y_{g-1} | G_i = g] - \mathbb{E}[Y_t - Y_{g-1} | D_{it} = 0, G_i \ne g], \quad \forall t \ge g
\]</span></p></li>
<li>
<p><strong>Conditional Parallel Trends (with Covariates)</strong>:<br>
If treatment assignment depends on covariates <span class="math inline">\(X_i\)</span>, adjust the parallel trends assumption:</p>
<ul>
<li>
<strong>Never-treated controls</strong>: <span class="math display">\[
ATT(g, t) = \mathbb{E}[Y_t - Y_{g-1} | X_i, G_i = g] - \mathbb{E}[Y_t - Y_{g-1} | X_i, C_i = 1], \quad \forall t \ge g
\]</span>
</li>
<li>
<strong>Not-yet-treated controls</strong>: <span class="math display">\[
ATT(g, t) = \mathbb{E}[Y_t - Y_{g-1} | X_i, G_i = g] - \mathbb{E}[Y_t - Y_{g-1} | X_i, D_{it} = 0, G_i \ne g], \quad \forall t \ge g
\]</span>
</li>
</ul>
</li>
</ol>
<hr>
<p>Aggregating <span class="math inline">\(ATT(g, t)\)</span>: Common Parameters of Interest</p>
<ol style="list-style-type: decimal">
<li>
<p><a href="sec-causal-inference.html#sec-average-treatment-effect">Average Treatment Effect</a> per Group (<span class="math inline">\(\theta_S(g)\)</span>):<br>
Average effect over all periods after treatment for group <span class="math inline">\(g\)</span>: <span class="math display">\[
\theta_S(g) = \frac{1}{\tau - g + 1} \sum_{t = g}^{\tau} ATT(g, t)
\]</span></p>
<ul>
<li>
<span class="math inline">\(\tau\)</span>: Last time period in the panel.</li>
</ul>
</li>
<li><p>Overall <a href="sec-causal-inference.html#sec-average-treatment-effect-on-the-treated">Average Treatment Effect on the Treated</a> (ATT) (<span class="math inline">\(\theta_S^O\)</span>):<br>
Weighted average of <span class="math inline">\(\theta_S(g)\)</span> across groups <span class="math inline">\(g\)</span>, weighted by their group size: <span class="math display">\[
\theta_S^O = \sum_{g=2}^{\tau} \theta_S(g) \cdot \mathbb{P}(G_i = g)
\]</span></p></li>
<li><p><strong>Dynamic Treatment Effects</strong> (<span class="math inline">\(\theta_D(e)\)</span>):<br>
Average effect after <span class="math inline">\(e\)</span> periods of treatment exposure: <span class="math display">\[
\theta_D(e) = \sum_{g=2}^{\tau} \mathbb{1}\{g + e \le \tau\} \cdot ATT(g, g + e) \cdot \mathbb{P}(G_i = g | g + e \le \tau)
\]</span></p></li>
<li><p><strong>Calendar Time Treatment Effects</strong> (<span class="math inline">\(\theta_C(t)\)</span>):<br>
Average treatment effect at time <span class="math inline">\(t\)</span> across all groups treated by <span class="math inline">\(t\)</span>: <span class="math display">\[
\theta_C(t) = \sum_{g=2}^{\tau} \mathbb{1}\{g \le t\} \cdot ATT(g, t) \cdot \mathbb{P}(G_i = g | g \le t)
\]</span></p></li>
<li><p><strong>Average Calendar Time Treatment Effect</strong> (<span class="math inline">\(\theta_C\)</span>):<br>
Average of <span class="math inline">\(\theta_C(t)\)</span> across all post-treatment periods: <span class="math display">\[
\theta_C = \frac{1}{\tau - 1} \sum_{t=2}^{\tau} \theta_C(t)
\]</span></p></li>
</ol>
<p>The <code><a href="https://rdrr.io/pkg/staggered/man/staggered.html">staggered()</a></code> function offers several estimands, each defining a different way of aggregating group-time average treatment effects into a single overall treatment effect:</p>
<ul>
<li><p>Simple: Equally weighted across all groups.</p></li>
<li><p>Cohort: Weighted by group sizes (i.e., treated cohorts).</p></li>
<li><p>Calendar: Weighted by the number of observations in each calendar time.</p></li>
</ul>
<div class="sourceCode" id="cb771"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">staggered</span><span class="op">)</span> </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"base_stagg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simple weighted average ATT</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/staggered/man/staggered.html">staggered</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    i <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    t <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    g <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"simple"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     estimate        se se_neyman</span></span>
<span><span class="co">#&gt; 1 -0.7110941 0.2211943 0.2214245</span></span>
<span></span>
<span><span class="co"># Cohort weighted ATT (i.e., by treatment cohort size)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/staggered/man/staggered.html">staggered</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    i <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    t <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    g <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"cohort"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;    estimate        se se_neyman</span></span>
<span><span class="co">#&gt; 1 -2.724242 0.2701093 0.2701745</span></span>
<span></span>
<span><span class="co"># Calendar weighted ATT (i.e., by year)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/staggered/man/staggered.html">staggered</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    i <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    t <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    g <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"calendar"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     estimate        se se_neyman</span></span>
<span><span class="co">#&gt; 1 -0.5861831 0.1768297 0.1770729</span></span></code></pre></div>
<p>To visualize treatment dynamics around the time of adoption, the event study specification estimates dynamic treatment effects relative to the time of treatment.</p>
<div class="sourceCode" id="cb772"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/staggered/man/staggered.html">staggered</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    i <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    t <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    g <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"eventstudy"</span>, </span>
<span>    eventTime <span class="op">=</span> <span class="op">-</span><span class="fl">9</span><span class="op">:</span><span class="fl">8</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the event study with pointwise confidence intervals</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="va">res</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        ymin_ptwise <span class="op">=</span> <span class="va">estimate</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span>,</span>
<span>        ymax_ptwise <span class="op">=</span> <span class="va">estimate</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">eventTime</span>, y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ymin_ptwise</span>, ymax <span class="op">=</span> <span class="va">ymax_ptwise</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Event Time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"ATT Estimate"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Event Study: Dynamic Treatment Effects"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.1-stagger_files/figure-html/unnamed-chunk-2-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>The <code>staggered</code> package also includes direct implementations of alternative estimators:</p>
<ul>
<li><p><code><a href="https://rdrr.io/pkg/staggered/man/staggered_cs.html">staggered_cs()</a></code> implements the <span class="citation">Callaway and Sant’Anna (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-callaway2021difference">2021</a>)</span> estimator.</p></li>
<li><p><code><a href="https://rdrr.io/pkg/staggered/man/staggered_sa.html">staggered_sa()</a></code> implements the <span class="citation">L. Sun and Abraham (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">2021</a>)</span> estimator, which adjusts for bias from comparisons involving already-treated units.</p></li>
</ul>
<div class="sourceCode" id="cb773"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Callaway and Sant’Anna estimator</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/staggered/man/staggered_cs.html">staggered_cs</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    i <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    t <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    g <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"simple"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     estimate        se se_neyman</span></span>
<span><span class="co">#&gt; 1 -0.7994889 0.4484987 0.4486122</span></span>
<span></span>
<span><span class="co"># Sun and Abraham estimator</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/staggered/man/staggered_sa.html">staggered_sa</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    i <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    t <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    g <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"simple"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     estimate        se se_neyman</span></span>
<span><span class="co">#&gt; 1 -0.7551901 0.4407818 0.4409525</span></span></code></pre></div>
<p>To assess statistical significance under the sharp null hypothesis <span class="math inline">\(H_0: \text{TE} = 0\)</span>, the <code>staggered</code> package includes an option for Fisher’s randomization (permutation) test. This approach tests whether the observed estimate could plausibly occur under a random reallocation of treatment timings.</p>
<div class="sourceCode" id="cb774"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fisher Randomization Test</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/staggered/man/staggered.html">staggered</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    i <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    t <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    g <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"simple"</span>,</span>
<span>    compute_fisher <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    num_fisher_permutations <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     estimate        se se_neyman fisher_pval fisher_pval_se_neyman</span></span>
<span><span class="co">#&gt; 1 -0.7110941 0.2211943 0.2214245           0                     0</span></span>
<span><span class="co">#&gt;   num_fisher_permutations</span></span>
<span><span class="co">#&gt; 1                     100</span></span></code></pre></div>
<p>This test provides a non-parametric method for inference and is particularly useful when the number of groups is small or standard errors are unreliable due to clustering or heteroskedasticity.</p>
<hr>
</div>
<div id="sec-cohort-average-treatment-effects-sun2021estimating" class="section level3" number="30.8.2">
<h3>
<span class="header-section-number">30.8.2</span> Cohort Average Treatment Effects <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">L. Sun and Abraham 2021</a>)</span><a class="anchor" aria-label="anchor" href="#sec-cohort-average-treatment-effects-sun2021estimating"><i class="fas fa-link"></i></a>
</h3>
<p><span class="citation">L. Sun and Abraham (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">2021</a>)</span> propose a solution to the TWFE problem in staggered adoption settings by introducing an interaction-weighted estimator for dynamic treatment effects. This estimator is based on the concept of <strong>Cohort Average Treatment Effects on the Treated (CATT)</strong>, which accounts for variation in treatment timing and dynamic treatment responses.</p>
<p>Traditional TWFE estimators implicitly assume <strong>homogeneous treatment effects</strong> and often rely on treated units serving as controls for later-treated units. When treatment effects vary over time or across groups, this leads to <strong>contaminated comparisons</strong>, especially in event-study specifications.</p>
<p><span class="citation">L. Sun and Abraham (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">2021</a>)</span> address this issue by:</p>
<ul>
<li><p>Estimating cohort-specific treatment effects relative to time since treatment.</p></li>
<li><p>Using never-treated units as controls, or in their absence, the last-treated cohort.</p></li>
</ul>
<div id="defining-the-parameter-of-interest-catt" class="section level4" number="30.8.2.1">
<h4>
<span class="header-section-number">30.8.2.1</span> Defining the Parameter of Interest: CATT<a class="anchor" aria-label="anchor" href="#defining-the-parameter-of-interest-catt"><i class="fas fa-link"></i></a>
</h4>
<p>Let <span class="math inline">\(E_i = e\)</span> denote the period when unit <span class="math inline">\(i\)</span> first receives treatment. The <strong>cohort-specific average treatment effect on the treated</strong> (CATT) is defined as: <span class="math display">\[
CATT_{e, l} = \mathbb{E}[Y_{i, e + l} - Y_{i, e + l}^\infty \mid E_i = e]
\]</span> Where:</p>
<ul>
<li><p><span class="math inline">\(l\)</span> is the relative period (e.g., <span class="math inline">\(l = -1\)</span> is one year before treatment, <span class="math inline">\(l = 0\)</span> is the treatment year).</p></li>
<li><p><span class="math inline">\(Y_{i, e + l}^\infty\)</span> is the potential outcome without treatment.</p></li>
<li><p><span class="math inline">\(Y_{i, e + l}\)</span> is the observed outcome.</p></li>
</ul>
<p>This formulation allows one to trace out the dynamic effect of treatment for each cohort, relative to their treatment start time.</p>
<p><span class="citation">L. Sun and Abraham (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">2021</a>)</span> extend the interaction-weighted idea to panel settings, originally introduced by <span class="citation">Gibbons, Suárez Serrato, and Urbancic (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-gibbons2018broken">2018</a>)</span> in a cross-sectional context.</p>
<p>They propose regressing the outcome on:</p>
<ul>
<li><p>Relative time indicators constructed by interacting treatment cohort (<span class="math inline">\(E_i\)</span>) with time (<span class="math inline">\(t\)</span>).</p></li>
<li><p>Unit and time fixed effects.</p></li>
</ul>
<p>This method explicitly estimates <span class="math inline">\(CATT_{e, l}\)</span> terms, avoiding the contaminating influence of already-treated units that TWFE models often suffer from.</p>
<p><strong>Relative Period Bin Indicator</strong></p>
<p><span class="math display">\[ D_{it}^l = \mathbb{1}(t - E_i = l) \]</span></p>
<ul>
<li>
<span class="math inline">\(E_i\)</span>: The time period when unit <span class="math inline">\(i\)</span> first receives treatment.</li>
<li>
<span class="math inline">\(l\)</span>: The <strong>relative time period</strong>—how many periods have passed since treatment began.</li>
</ul>
<ol style="list-style-type: decimal">
<li><strong>Static Specification</strong></li>
</ol>
<p><span class="math display">\[ Y_{it} = \alpha_i + \lambda_t + \mu_g \sum_{l \ge 0} D_{it}^l + \epsilon_{it} \]</span></p>
<ul>
<li>
<span class="math inline">\(\alpha_i\)</span>: Unit fixed effects.</li>
<li>
<span class="math inline">\(\lambda_t\)</span>: Time fixed effects.</li>
<li>
<span class="math inline">\(\mu_g\)</span>: Effect for group <span class="math inline">\(g\)</span>.</li>
<li>Excludes periods <strong>prior to treatment</strong>.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><strong>Dynamic Specification</strong></li>
</ol>
<p><span class="math display">\[ Y_{it} = \alpha_i + \lambda_t + \sum_{\substack{l = -K \\ l \neq -1}}^{L} \mu_l D_{it}^l + \epsilon_{it} \]</span></p>
<ul>
<li>Includes leads and lags of treatment indicators <span class="math inline">\(D_{it}^l\)</span>.</li>
<li>Excludes one period (typically <span class="math inline">\(l = -1\)</span>) to avoid perfect collinearity.</li>
<li>Tests for pre-treatment parallel trends rely on the leads (<span class="math inline">\(l &lt; 0\)</span>).</li>
</ul>
<hr>
</div>
<div id="identifying-assumptions" class="section level4" number="30.8.2.2">
<h4>
<span class="header-section-number">30.8.2.2</span> Identifying Assumptions<a class="anchor" aria-label="anchor" href="#identifying-assumptions"><i class="fas fa-link"></i></a>
</h4>
<ol style="list-style-type: decimal">
<li><strong>Parallel Trends</strong></li>
</ol>
<p>For identification, it is assumed that untreated potential outcomes follow parallel trends across cohorts in the absence of treatment: <span class="math display">\[
\mathbb{E}[Y_{it}^\infty - Y_{i, t-1}^\infty \mid E_i = e] = \text{constant across } e
\]</span> This allows us to use <strong>never-treated</strong> or <strong>not-yet-treated</strong> units as valid counterfactuals.</p>
<ol start="2" style="list-style-type: decimal">
<li><strong>No Anticipatory Effects</strong></li>
</ol>
<p>Treatment should not influence outcomes before it is implemented. That is: <span class="math display">\[
CATT_{e, l} = 0 \quad \text{for all } l &lt; 0
\]</span> This ensures that any pre-trends are not driven by behavioral changes in anticipation of treatment.</p>
<ol start="3" style="list-style-type: decimal">
<li><strong>Treatment Effect Homogeneity (Optional)</strong></li>
</ol>
<p>The treatment effect is consistent across cohorts for each relative period. Each adoption cohort should have the same path of treatment effects. In other words, the trajectory of each treatment cohort is similar.</p>
<p>Although <span class="citation">L. Sun and Abraham (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">2021</a>)</span> allow treatment effect heterogeneity, some settings may assume homogeneous effects within cohorts and periods:</p>
<ul>
<li><p>Each cohort has the same pattern of response over time.</p></li>
<li><p>This is relaxed in their design but assumed in simpler TWFE settings.</p></li>
</ul>
</div>
<div id="comparison-to-other-designs" class="section level4" number="30.8.2.3">
<h4>
<span class="header-section-number">30.8.2.3</span> Comparison to Other Designs<a class="anchor" aria-label="anchor" href="#comparison-to-other-designs"><i class="fas fa-link"></i></a>
</h4>
<p>Different DiD designs make distinct assumptions about how treatment effects vary:</p>
<div class="inline-table"><table style="width:99%;" class="table table-sm">
<colgroup>
<col width="15%">
<col width="10%">
<col width="12%">
<col width="60%">
</colgroup>
<thead><tr class="header">
<th>Study</th>
<th>Vary Over Time</th>
<th>Vary Across Cohorts</th>
<th>Notes</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span class="citation">L. Sun and Abraham (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">2021</a>)</span></td>
<td>✓</td>
<td>✓</td>
<td>Allows full heterogeneity</td>
</tr>
<tr class="even">
<td><span class="citation">Callaway and Sant’Anna (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-callaway2021difference">2021</a>)</span></td>
<td>✓</td>
<td>✓</td>
<td>Estimates group × time ATTs</td>
</tr>
<tr class="odd">
<td><span class="citation">Borusyak, Jaravel, and Spiess (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-borusyak2024revisiting">2024</a>)</span></td>
<td>✓</td>
<td>✗</td>
<td>
<p>Homogeneous across cohorts</p>
<p>Heterogeneity over time</p>
</td>
</tr>
<tr class="even">
<td><span class="citation">Athey and Imbens (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-athey2022design">2022</a>)</span></td>
<td>✗</td>
<td>✓</td>
<td>Heterogeneity only across adoption cohorts</td>
</tr>
<tr class="odd">
<td><span class="citation">Clement De Chaisemartin and D’haultfœuille (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-de2023two">2023</a>)</span></td>
<td>✓</td>
<td>✓</td>
<td>Complete heterogeneity</td>
</tr>
<tr class="even">
<td><span class="citation">Goodman-Bacon (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-goodman2021difference">2021</a>)</span></td>
<td>✓ or ✗</td>
<td>✗ or ✓</td>
<td>
<p>Restricts one dimension</p>
<p>Heterogeneity either “vary across units but not over time” or “vary over time but not across units”.</p>
</td>
</tr>
</tbody>
</table></div>
</div>
<div id="sources-of-treatment-effect-heterogeneity" class="section level4" number="30.8.2.4">
<h4>
<span class="header-section-number">30.8.2.4</span> Sources of Treatment Effect Heterogeneity<a class="anchor" aria-label="anchor" href="#sources-of-treatment-effect-heterogeneity"><i class="fas fa-link"></i></a>
</h4>
<p>Several forces can generate heterogeneous treatment effects:</p>
<ul>
<li><p><strong>Calendar Time Effects</strong>: Macro events (e.g., recessions, policy changes) affect cohorts differently.</p></li>
<li><p><strong>Selection into Timing</strong>: Units self-select into early/late treatment based on anticipated effects.</p></li>
<li><p><strong>Composition Differences</strong>: Adoption cohorts may differ in observed or unobserved ways.</p></li>
</ul>
<p>Such heterogeneity can bias TWFE estimates, which often average effects across incomparable groups.</p>
<hr>
</div>
<div id="technical-issues" class="section level4" number="30.8.2.5">
<h4>
<span class="header-section-number">30.8.2.5</span> Technical Issues<a class="anchor" aria-label="anchor" href="#technical-issues"><i class="fas fa-link"></i></a>
</h4>
<p>When using an event-study TWFE regression to estimate dynamic treatment effects in staggered adoption settings, one must exclude certain relative time indicators to avoid perfect multicollinearity. This arises because relative period indicators are linearly dependent due to the presence of unit and time fixed effects.</p>
<p>Specifically, the following two terms must be addressed:</p>
<ul>
<li><p><strong>The period immediately before treatment</strong> (<span class="math inline">\(l = -1\)</span>): This period is typically omitted and serves as the baseline for comparison. This normalization has been standard practice in event study regressions prior to <span class="citation">L. Sun and Abraham (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">2021</a>)</span> .</p></li>
<li><p><strong>A distant post-treatment period</strong> (e.g., <span class="math inline">\(l = +5\)</span> or <span class="math inline">\(l = +10\)</span>): <span class="citation">L. Sun and Abraham (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">2021</a>)</span> clarified that in addition to the baseline period, at least one other relative time indicator—typically from the far tail of the post-treatment distribution—must be dropped, binned, or trimmed to avoid multicollinearity among the relative time dummies. This issue emerges because fixed effects absorb much of the within-unit and within-time variation, reducing the effective rank of the design matrix.</p></li>
</ul>
<p>Dropping certain relative periods (especially pre-treatment periods) introduces an implicit normalization: the estimates for included periods are now interpreted relative to the omitted periods. If treatment effects are present in these omitted periods—say, due to anticipation or early effects—this will contaminate the estimates of included relative periods.</p>
<p>To avoid this contamination, researchers often assume that all pre-treatment periods have zero treatment effect, i.e.,</p>
<p><span class="math display">\[
CATT_{e, l} = 0 \quad \text{for all } l &lt; 0
\]</span></p>
<p>This assumption ensures that excluded pre-treatment periods form a valid counterfactual, and estimates for <span class="math inline">\(l \geq 0\)</span> are not biased due to normalization.</p>
<hr>
<p><span class="citation">L. Sun and Abraham (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">2021</a>)</span> resolve the issues of weighting and aggregation by using a clean weighting scheme that avoids contamination from excluded periods. Their method produces a weighted average of cohort- and time-specific treatment effects (<span class="math inline">\(CATT_{e, l}\)</span>), where the weights are:</p>
<ul>
<li><strong>Non-negative</strong></li>
<li><strong>Sum to one</strong></li>
<li>
<strong>Interpretable as the fraction of treated units who are observed</strong> <span class="math inline">\(l\)</span> periods after treatment, normalized over the number of available periods <span class="math inline">\(g\)</span>
</li>
</ul>
<p>This interaction-weighted estimator ensures that the estimated average treatment effect reflects a convex combination of dynamic treatment effects from different cohorts and times.</p>
<p>In this way, their aggregation logic closely mirrors that of <span class="citation">Callaway and Sant’Anna (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-callaway2021difference">2021</a>)</span>, who also construct average treatment effects from group-time ATTs using interpretable weights that align with the sampling structure.</p>
<hr>
<div class="sourceCode" id="cb775"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"base_stagg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate Sun &amp; Abraham interaction-weighted model</span></span>
<span><span class="va">res_sa20</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="fu">sunab</span><span class="op">(</span><span class="va">year_treated</span>, <span class="va">year</span><span class="op">)</span> <span class="op">|</span> <span class="va">id</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>  data <span class="op">=</span> <span class="va">base_stagg</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Use <code><a href="https://lrberge.github.io/fixest/reference/coefplot.html">iplot()</a></code> to visualize the estimated dynamic treatment effects across relative time:</p>
<div class="sourceCode" id="cb776"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">iplot</a></span><span class="op">(</span><span class="va">res_sa20</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.1-stagger_files/figure-html/unnamed-chunk-6-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>You can summarize the results using different aggregation options:</p>
<div class="sourceCode" id="cb777"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Overall average ATT</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">res_sa20</span>, agg <span class="op">=</span> <span class="st">"att"</span><span class="op">)</span></span>
<span><span class="co">#&gt; OLS estimation, Dep. Var.: y</span></span>
<span><span class="co">#&gt; Observations: 950</span></span>
<span><span class="co">#&gt; Fixed-effects: id: 95,  year: 10</span></span>
<span><span class="co">#&gt; Standard-errors: Clustered (id) </span></span>
<span><span class="co">#&gt;      Estimate Std. Error  t value  Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; x1   0.994678   0.018378 54.12293 &lt; 2.2e-16 ***</span></span>
<span><span class="co">#&gt; ATT -1.133749   0.205070 -5.52858 2.882e-07 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; RMSE: 0.921817     Adj. R2: 0.887984</span></span>
<span><span class="co">#&gt;                  Within R2: 0.876406</span></span>
<span></span>
<span><span class="co"># Aggregation across post-treatment periods (excluding leads)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">res_sa20</span>, agg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"att"</span> <span class="op">=</span> <span class="st">"year::[^-]"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; OLS estimation, Dep. Var.: y</span></span>
<span><span class="co">#&gt; Observations: 950</span></span>
<span><span class="co">#&gt; Fixed-effects: id: 95,  year: 10</span></span>
<span><span class="co">#&gt; Standard-errors: Clustered (id) </span></span>
<span><span class="co">#&gt;                      Estimate Std. Error   t value   Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; x1                   0.994678   0.018378 54.122928  &lt; 2.2e-16 ***</span></span>
<span><span class="co">#&gt; year::-9:cohort::10  0.351766   0.359073  0.979649 3.2977e-01    </span></span>
<span><span class="co">#&gt; year::-8:cohort::9   0.033914   0.471437  0.071937 9.4281e-01    </span></span>
<span><span class="co">#&gt; year::-8:cohort::10 -0.191932   0.352896 -0.543876 5.8781e-01    </span></span>
<span><span class="co">#&gt; year::-7:cohort::8  -0.589387   0.736910 -0.799809 4.2584e-01    </span></span>
<span><span class="co">#&gt; year::-7:cohort::9   0.872995   0.493427  1.769249 8.0096e-02 .  </span></span>
<span><span class="co">#&gt; year::-7:cohort::10  0.019512   0.603411  0.032336 9.7427e-01    </span></span>
<span><span class="co">#&gt; year::-6:cohort::7  -0.042147   0.865736 -0.048683 9.6127e-01    </span></span>
<span><span class="co">#&gt; year::-6:cohort::8  -0.657571   0.573257 -1.147078 2.5426e-01    </span></span>
<span><span class="co">#&gt; year::-6:cohort::9   0.877743   0.533331  1.645775 1.0315e-01    </span></span>
<span><span class="co">#&gt; year::-6:cohort::10 -0.403635   0.347412 -1.161832 2.4825e-01    </span></span>
<span><span class="co">#&gt; year::-5:cohort::6  -0.658034   0.913407 -0.720418 4.7306e-01    </span></span>
<span><span class="co">#&gt; year::-5:cohort::7  -0.316974   0.697939 -0.454158 6.5076e-01    </span></span>
<span><span class="co">#&gt; year::-5:cohort::8  -0.238213   0.469744 -0.507113 6.1326e-01    </span></span>
<span><span class="co">#&gt; year::-5:cohort::9   0.301477   0.604201  0.498968 6.1897e-01    </span></span>
<span><span class="co">#&gt; year::-5:cohort::10 -0.564801   0.463214 -1.219308 2.2578e-01    </span></span>
<span><span class="co">#&gt; year::-4:cohort::5  -0.983453   0.634492 -1.549984 1.2451e-01    </span></span>
<span><span class="co">#&gt; year::-4:cohort::6   0.360407   0.858316  0.419900 6.7552e-01    </span></span>
<span><span class="co">#&gt; year::-4:cohort::7  -0.430610   0.661356 -0.651102 5.1657e-01    </span></span>
<span><span class="co">#&gt; year::-4:cohort::8  -0.895195   0.374901 -2.387816 1.8949e-02 *  </span></span>
<span><span class="co">#&gt; year::-4:cohort::9  -0.392478   0.439547 -0.892914 3.7418e-01    </span></span>
<span><span class="co">#&gt; year::-4:cohort::10  0.519001   0.597880  0.868069 3.8757e-01    </span></span>
<span><span class="co">#&gt; year::-3:cohort::4   0.591288   0.680169  0.869324 3.8688e-01    </span></span>
<span><span class="co">#&gt; year::-3:cohort::5  -1.000650   0.971741 -1.029749 3.0577e-01    </span></span>
<span><span class="co">#&gt; year::-3:cohort::6   0.072188   0.652641  0.110609 9.1216e-01    </span></span>
<span><span class="co">#&gt; year::-3:cohort::7  -0.836820   0.804275 -1.040465 3.0079e-01    </span></span>
<span><span class="co">#&gt; year::-3:cohort::8  -0.783148   0.701312 -1.116691 2.6697e-01    </span></span>
<span><span class="co">#&gt; year::-3:cohort::9   0.811285   0.564470  1.437251 1.5397e-01    </span></span>
<span><span class="co">#&gt; year::-3:cohort::10  0.527203   0.320051  1.647250 1.0285e-01    </span></span>
<span><span class="co">#&gt; year::-2:cohort::3   0.036941   0.673771  0.054828 9.5639e-01    </span></span>
<span><span class="co">#&gt; year::-2:cohort::4   0.832250   0.859544  0.968246 3.3541e-01    </span></span>
<span><span class="co">#&gt; year::-2:cohort::5  -1.574086   0.525563 -2.995051 3.5076e-03 ** </span></span>
<span><span class="co">#&gt; year::-2:cohort::6   0.311758   0.832095  0.374666 7.0875e-01    </span></span>
<span><span class="co">#&gt; year::-2:cohort::7  -0.558631   0.871993 -0.640638 5.2332e-01    </span></span>
<span><span class="co">#&gt; year::-2:cohort::8   0.429591   0.305270  1.407250 1.6265e-01    </span></span>
<span><span class="co">#&gt; year::-2:cohort::9   1.201899   0.819186  1.467188 1.4566e-01    </span></span>
<span><span class="co">#&gt; year::-2:cohort::10 -0.002429   0.682087 -0.003562 9.9717e-01    </span></span>
<span><span class="co">#&gt; att                 -1.133749   0.205070 -5.528584 2.8820e-07 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; RMSE: 0.921817     Adj. R2: 0.887984</span></span>
<span><span class="co">#&gt;                  Within R2: 0.876406</span></span>
<span></span>
<span><span class="co"># Aggregate post-treatment effects from l = 0 to 8</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">res_sa20</span>, agg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"att"</span> <span class="op">=</span> <span class="st">"year::[012345678]"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://lrberge.github.io/fixest/reference/etable.html">etable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         summary(res_..</span></span>
<span><span class="co">#&gt; Dependent Var.:                      y</span></span>
<span><span class="co">#&gt;                                       </span></span>
<span><span class="co">#&gt; x1                      0.99*** (0.02)</span></span>
<span><span class="co">#&gt; year = -9 x cohort = 10    0.35 (0.36)</span></span>
<span><span class="co">#&gt; year = -8 x cohort = 9     0.03 (0.47)</span></span>
<span><span class="co">#&gt; year = -8 x cohort = 10   -0.19 (0.35)</span></span>
<span><span class="co">#&gt; year = -7 x cohort = 8    -0.59 (0.74)</span></span>
<span><span class="co">#&gt; year = -7 x cohort = 9    0.87. (0.49)</span></span>
<span><span class="co">#&gt; year = -7 x cohort = 10    0.02 (0.60)</span></span>
<span><span class="co">#&gt; year = -6 x cohort = 7    -0.04 (0.87)</span></span>
<span><span class="co">#&gt; year = -6 x cohort = 8    -0.66 (0.57)</span></span>
<span><span class="co">#&gt; year = -6 x cohort = 9     0.88 (0.53)</span></span>
<span><span class="co">#&gt; year = -6 x cohort = 10   -0.40 (0.35)</span></span>
<span><span class="co">#&gt; year = -5 x cohort = 6    -0.66 (0.91)</span></span>
<span><span class="co">#&gt; year = -5 x cohort = 7    -0.32 (0.70)</span></span>
<span><span class="co">#&gt; year = -5 x cohort = 8    -0.24 (0.47)</span></span>
<span><span class="co">#&gt; year = -5 x cohort = 9     0.30 (0.60)</span></span>
<span><span class="co">#&gt; year = -5 x cohort = 10   -0.56 (0.46)</span></span>
<span><span class="co">#&gt; year = -4 x cohort = 5    -0.98 (0.63)</span></span>
<span><span class="co">#&gt; year = -4 x cohort = 6     0.36 (0.86)</span></span>
<span><span class="co">#&gt; year = -4 x cohort = 7    -0.43 (0.66)</span></span>
<span><span class="co">#&gt; year = -4 x cohort = 8   -0.90* (0.37)</span></span>
<span><span class="co">#&gt; year = -4 x cohort = 9    -0.39 (0.44)</span></span>
<span><span class="co">#&gt; year = -4 x cohort = 10    0.52 (0.60)</span></span>
<span><span class="co">#&gt; year = -3 x cohort = 4     0.59 (0.68)</span></span>
<span><span class="co">#&gt; year = -3 x cohort = 5     -1.0 (0.97)</span></span>
<span><span class="co">#&gt; year = -3 x cohort = 6     0.07 (0.65)</span></span>
<span><span class="co">#&gt; year = -3 x cohort = 7    -0.84 (0.80)</span></span>
<span><span class="co">#&gt; year = -3 x cohort = 8    -0.78 (0.70)</span></span>
<span><span class="co">#&gt; year = -3 x cohort = 9     0.81 (0.56)</span></span>
<span><span class="co">#&gt; year = -3 x cohort = 10    0.53 (0.32)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 3     0.04 (0.67)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 4     0.83 (0.86)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 5   -1.6** (0.53)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 6     0.31 (0.83)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 7    -0.56 (0.87)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 8     0.43 (0.31)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 9      1.2 (0.82)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 10  -0.002 (0.68)</span></span>
<span><span class="co">#&gt; att                     -1.1*** (0.21)</span></span>
<span><span class="co">#&gt; Fixed-Effects:          --------------</span></span>
<span><span class="co">#&gt; id                                 Yes</span></span>
<span><span class="co">#&gt; year                               Yes</span></span>
<span><span class="co">#&gt; _______________________ ______________</span></span>
<span><span class="co">#&gt; S.E.: Clustered                 by: id</span></span>
<span><span class="co">#&gt; Observations                       950</span></span>
<span><span class="co">#&gt; R2                             0.90982</span></span>
<span><span class="co">#&gt; Within R2                      0.87641</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre></div>
<p>The <code>fwlplot</code> package provides diagnostics for how much variation is explained by fixed effects or covariates:</p>
<div class="sourceCode" id="cb778"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">fwlplot</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simple FWL plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/fwlplot/man/fwl_plot.html">fwl_plot</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span>, data <span class="op">=</span> <span class="va">base_stagg</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.1-stagger_files/figure-html/unnamed-chunk-8-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb779"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co"># With fixed effects</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/fwlplot/man/fwl_plot.html">fwl_plot</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">|</span> <span class="va">id</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>         data <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>         n_sample <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.1-stagger_files/figure-html/unnamed-chunk-8-2.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb780"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Splitting by treatment status</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/fwlplot/man/fwl_plot.html">fwl_plot</a></span><span class="op">(</span></span>
<span>    <span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">|</span></span>
<span>        <span class="va">id</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    n_sample <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    fsplit <span class="op">=</span> <span class="op">~</span> <span class="va">treated</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.1-stagger_files/figure-html/unnamed-chunk-8-3.png" width="90%" style="display: block; margin: auto;"></div>
<hr>
</div>
</div>
<div id="sec-stacked-difference-in-differences" class="section level3" number="30.8.3">
<h3>
<span class="header-section-number">30.8.3</span> Stacked Difference-in-Differences<a class="anchor" aria-label="anchor" href="#sec-stacked-difference-in-differences"><i class="fas fa-link"></i></a>
</h3>
<p>The <strong>Stacked DiD</strong> approach addresses key limitations of standard TWFE models in <strong>staggered adoption designs</strong>, particularly <strong>treatment effect heterogeneity</strong> and <strong>timing variations</strong>. By constructing <strong>sub-experiments</strong> around each treatment event, researchers can isolate cleaner comparisons and reduce contamination from improperly specified control groups.</p>
<p>Basic TWFE Specification</p>
<p><span class="math display">\[
Y_{it} = \beta_{FE} D_{it} + A_i + B_t + \epsilon_{it}
\]</span></p>
<ul>
<li>
<span class="math inline">\(Y_{it}\)</span>: Outcome for unit <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span>.</li>
<li>
<span class="math inline">\(D_{it}\)</span>: Treatment indicator (1 if treated, 0 otherwise).</li>
<li>
<span class="math inline">\(A_i\)</span>: Unit (group) fixed effects.</li>
<li>
<span class="math inline">\(B_t\)</span>: Time period fixed effects.</li>
<li>
<span class="math inline">\(\epsilon_{it}\)</span>: Idiosyncratic error term.</li>
</ul>
<hr>
<p>Steps in the Stacked DiD Procedure</p>
<div id="choose-an-event-window" class="section level4" number="30.8.3.1">
<h4>
<span class="header-section-number">30.8.3.1</span> Choose an Event Window<a class="anchor" aria-label="anchor" href="#choose-an-event-window"><i class="fas fa-link"></i></a>
</h4>
<p>Define:</p>
<ul>
<li>
<span class="math inline">\(\kappa_a\)</span>: Number of <strong>pre-treatment</strong> periods to include in the event window (lead periods).</li>
<li>
<span class="math inline">\(\kappa_b\)</span>: Number of <strong>post-treatment</strong> periods to include in the event window (lag periods).</li>
</ul>
<p><strong>Implication</strong>:<br>
Only events where sufficient <strong>pre- and post-treatment periods</strong> exist will be included (i.e., excluding those events that do not meet this criteria).</p>
<hr>
</div>
<div id="enumerate-sub-experiments" class="section level4" number="30.8.3.2">
<h4>
<span class="header-section-number">30.8.3.2</span> Enumerate Sub-Experiments<a class="anchor" aria-label="anchor" href="#enumerate-sub-experiments"><i class="fas fa-link"></i></a>
</h4>
<p>Define:</p>
<ul>
<li>
<span class="math inline">\(T_1\)</span>: First period in the panel.</li>
<li>
<span class="math inline">\(T_T\)</span>: Last period in the panel.</li>
<li>
<span class="math inline">\(\Omega_A\)</span>: The set of <strong>treatment adoption periods</strong> that fit within the event window:</li>
</ul>
<p><span class="math display">\[
\Omega_A = \left\{ A_i \;\middle|\; T_1 + \kappa_a \le A_i \le T_T - \kappa_b \right\}
\]</span></p>
<ul>
<li>Each <span class="math inline">\(A_i\)</span> represents an <strong>adoption period</strong> for unit <span class="math inline">\(i\)</span> that has enough time on both sides of the event.</li>
</ul>
<p>Let <span class="math inline">\(d = 1, \dots, D\)</span> index the <strong>sub-experiments</strong> in <span class="math inline">\(\Omega_A\)</span>.</p>
<ul>
<li>
<span class="math inline">\(\omega_d\)</span>: The event (adoption) date of the <span class="math inline">\(d\)</span>-th sub-experiment.</li>
</ul>
<hr>
</div>
<div id="define-inclusion-criteria" class="section level4" number="30.8.3.3">
<h4>
<span class="header-section-number">30.8.3.3</span> Define Inclusion Criteria<a class="anchor" aria-label="anchor" href="#define-inclusion-criteria"><i class="fas fa-link"></i></a>
</h4>
<p><strong>Valid Treated Units</strong></p>
<ul>
<li>In sub-experiment <span class="math inline">\(d\)</span>, treated units have adoption date exactly equal to <span class="math inline">\(\omega_d\)</span>.</li>
<li>A unit may only be treated in one sub-experiment to avoid duplication.</li>
</ul>
<p><strong>Clean Control Units</strong></p>
<ul>
<li>Controls are units where <span class="math inline">\(A_i &gt; \omega_d + \kappa_b\)</span>, i.e.,
<ul>
<li>They are <strong>never treated</strong>, or</li>
<li>They are <strong>treated in the far future</strong> (beyond the post-event window).</li>
</ul>
</li>
<li>A control unit can appear in multiple sub-experiments, but this requires correcting standard errors (see below).</li>
</ul>
<p><strong>Valid Time Periods</strong></p>
<ul>
<li>Only observations where<br><span class="math display">\[
\omega_d - \kappa_a \le t \le \omega_d + \kappa_b
\]</span><br>
are included.</li>
<li>This ensures the analysis is centered on the event window.</li>
</ul>
</div>
<div id="specify-estimating-equation" class="section level4" number="30.8.3.4">
<h4>
<span class="header-section-number">30.8.3.4</span> Specify Estimating Equation<a class="anchor" aria-label="anchor" href="#specify-estimating-equation"><i class="fas fa-link"></i></a>
</h4>
<p>Basic DiD Specification in the Stacked Dataset</p>
<p><span class="math display">\[
Y_{itd} = \beta_0 + \beta_1 T_{id}  + \beta_2 P_{td} + \beta_3 (T_{id} \times P_{td}) + \epsilon_{itd}
\]</span></p>
<p>Where:</p>
<ul>
<li><p><span class="math inline">\(i\)</span>: Unit index</p></li>
<li><p><span class="math inline">\(t\)</span>: Time index</p></li>
<li><p><span class="math inline">\(d\)</span>: Sub-experiment index</p></li>
<li><p><span class="math inline">\(T_{id}\)</span>: Indicator for <strong>treated units</strong> in sub-experiment <span class="math inline">\(d\)</span></p></li>
<li><p><span class="math inline">\(P_{td}\)</span>: Indicator for <strong>post-treatment periods</strong> in sub-experiment <span class="math inline">\(d\)</span></p></li>
<li><p><span class="math inline">\(\beta_3\)</span>: Captures the <strong>DiD estimate</strong> of the treatment effect.</p></li>
</ul>
<p>Equivalent Form with Fixed Effects</p>
<p><span class="math display">\[
Y_{itd} = \beta_3 (T_{id} \times P_{td}) + \theta_{id} + \gamma_{td} + \epsilon_{itd}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(\theta_{id}\)</span>: Unit-by-sub-experiment fixed effect.</p></li>
<li><p><span class="math inline">\(\gamma_{td}\)</span>: Time-by-sub-experiment fixed effect.</p></li>
</ul>
<p>Note:</p>
<ul>
<li>
<span class="math inline">\(\beta_3\)</span> summarizes the average treatment effect across all sub-experiments but does not allow for dynamic effects by time since treatment.</li>
</ul>
</div>
<div id="stacked-event-study-specification" class="section level4" number="30.8.3.5">
<h4>
<span class="header-section-number">30.8.3.5</span> Stacked Event Study Specification<a class="anchor" aria-label="anchor" href="#stacked-event-study-specification"><i class="fas fa-link"></i></a>
</h4>
<p>Define Time Since Event (<span class="math inline">\(YSE_{td}\)</span>):</p>
<p><span class="math display">\[
YSE_{td} = t- \omega_d
\]</span></p>
<p>where</p>
<ul>
<li><p>Measures time since the event (relative time) in sub-experiment <span class="math inline">\(d\)</span>.</p></li>
<li><p><span class="math inline">\(YSE_{td} \in [-\kappa_a, \dots, 0, \dots, \kappa_b]\)</span> in every sub-experiment.</p></li>
</ul>
<p><strong>Event-Study Regression (Sub-Experiment Level)</strong></p>
<p><span class="math display">\[
Y_{it}^d = \sum_{j = -\kappa_a}^{\kappa_b} \beta_j^d . 1 (YSE_{td} = j) + \sum_{j = -\kappa_a}^{\kappa_b} \delta_j^d (T_{id} . 1 (YSE_{td} = j)) + \theta_i^d + \epsilon_{it}^d
\]</span></p>
<p>where</p>
<ul>
<li><p>Separate coefficients for each sub-experiment <span class="math inline">\(d\)</span>.</p></li>
<li><p><span class="math inline">\(\delta_j^d\)</span>: Captures treatment effects at relative time <span class="math inline">\(j\)</span> within sub-experiment <span class="math inline">\(d\)</span>.</p></li>
</ul>
<p><strong>Pooled Stacked Event-Study Regression</strong></p>
<p><span class="math display">\[
Y_{itd} = \sum_{j = -\kappa_a}^{\kappa_b} \beta_j \cdot \mathbb{1}(YSE_{td} = j) + \sum_{j = -\kappa_a}^{\kappa_b} \delta_j \left( T_{id} \cdot \mathbb{1}(YSE_{td} = j) \right) + \theta_{id} + \epsilon_{itd}
\]</span></p>
<ul>
<li>Pooled coefficients <span class="math inline">\(\delta_j\)</span> reflect average treatment effects by event time <span class="math inline">\(j\)</span> across sub-experiments.</li>
</ul>
</div>
<div id="clustering-in-stacked-did" class="section level4" number="30.8.3.6">
<h4>
<span class="header-section-number">30.8.3.6</span> Clustering in Stacked DID<a class="anchor" aria-label="anchor" href="#clustering-in-stacked-did"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li><p><strong>Cluster at Unit × Sub-Experiment Level</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-cengiz2019effect">Cengiz et al. 2019</a>)</span>: Accounts for units appearing multiple times across sub-experiments.</p></li>
<li><p><strong>Cluster at Unit Level</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-deshpande2019screened">Deshpande and Li 2019</a>)</span>: Appropriate when units are uniquely identified and do not appear in multiple sub-experiments.</p></li>
</ul>
<hr>
<div class="sourceCode" id="cb781"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bcallaway11.github.io/did/">did</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load example data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">base_stagg</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get treated cohorts (exclude never-treated units coded as 10000)</span></span>
<span><span class="va">cohorts</span> <span class="op">&lt;-</span> <span class="va">base_stagg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">year_treated</span> <span class="op">!=</span> <span class="fl">10000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">year_treated</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Function to generate data for each sub-experiment</span></span>
<span><span class="va">getdata</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">window</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">base_stagg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>            <span class="va">year_treated</span> <span class="op">==</span> <span class="va">j</span> <span class="op">|</span>               <span class="co"># treated units in cohort j</span></span>
<span>            <span class="va">year_treated</span> <span class="op">&gt;</span> <span class="va">j</span> <span class="op">+</span> <span class="va">window</span>         <span class="co"># controls not treated soon after</span></span>
<span>        <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>            <span class="va">year</span> <span class="op">&gt;=</span> <span class="va">j</span> <span class="op">-</span> <span class="va">window</span> <span class="op">&amp;</span></span>
<span>            <span class="va">year</span> <span class="op">&lt;=</span> <span class="va">j</span> <span class="op">+</span> <span class="va">window</span>                <span class="co"># event window bounds</span></span>
<span>        <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>df <span class="op">=</span> <span class="va">j</span><span class="op">)</span>                        <span class="co"># sub-experiment indicator</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Generate the stacked dataset</span></span>
<span><span class="va">stacked_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_df</a></span><span class="op">(</span><span class="va">cohorts</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/sampling/man/getdata.html">getdata</a></span><span class="op">(</span><span class="va">.</span>, window <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        rel_year <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">df</span> <span class="op">==</span> <span class="va">year_treated</span>, <span class="va">time_to_treatment</span>, <span class="cn">NA_real_</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">fastDummies</span><span class="fu">::</span><span class="fu"><a href="https://jacobkap.github.io/fastDummies/reference/dummy_cols.html">dummy_cols</a></span><span class="op">(</span><span class="st">"rel_year"</span>, ignore_na <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"rel_year_"</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate fixed effects regression on the stacked data</span></span>
<span><span class="va">stacked_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span></span>
<span>    <span class="va">y</span> <span class="op">~</span> <span class="va">`rel_year_-5`</span> <span class="op">+</span> <span class="va">`rel_year_-4`</span> <span class="op">+</span> <span class="va">`rel_year_-3`</span> <span class="op">+</span> <span class="va">`rel_year_-2`</span> <span class="op">+</span></span>
<span>        <span class="va">rel_year_0</span> <span class="op">+</span> <span class="va">rel_year_1</span> <span class="op">+</span> <span class="va">rel_year_2</span> <span class="op">+</span> <span class="va">rel_year_3</span> <span class="op">+</span></span>
<span>        <span class="va">rel_year_4</span> <span class="op">+</span> <span class="va">rel_year_5</span> <span class="op">|</span></span>
<span>        <span class="va">id</span> <span class="op">^</span> <span class="va">df</span> <span class="op">+</span> <span class="va">year</span> <span class="op">^</span> <span class="va">df</span>,</span>
<span>    data <span class="op">=</span> <span class="va">stacked_data</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract coefficients and standard errors</span></span>
<span><span class="va">stacked_coeffs</span> <span class="op">&lt;-</span> <span class="va">stacked_result</span><span class="op">$</span><span class="va">coefficients</span></span>
<span><span class="va">stacked_se</span> <span class="op">&lt;-</span> <span class="va">stacked_result</span><span class="op">$</span><span class="va">se</span></span>
<span></span>
<span><span class="co"># Insert zero for the omitted period (usually -1)</span></span>
<span><span class="va">stacked_coeffs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">stacked_coeffs</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">0</span>, <span class="va">stacked_coeffs</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">stacked_se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">stacked_se</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">0</span>, <span class="va">stacked_se</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb782"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plotting estimates from three methods: Callaway &amp; Sant'Anna, Sun &amp; Abraham, and Stacked DiD</span></span>
<span></span>
<span><span class="va">cs_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bcallaway11.github.io/did/reference/att_gt.html">att_gt</a></span><span class="op">(</span></span>
<span>    yname <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    gname <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    idname <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    <span class="co"># xformla = "~x1",</span></span>
<span>    tname <span class="op">=</span> <span class="st">"year"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cs</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://bcallaway11.github.io/did/reference/aggte.html">aggte</a></span><span class="op">(</span></span>
<span>        <span class="va">cs_out</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"dynamic"</span>,</span>
<span>        min_e <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>,</span>
<span>        max_e <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        bstrap <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        cband <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">res_sa20</span> <span class="op">=</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu">sunab</span><span class="op">(</span><span class="va">year_treated</span>, <span class="va">year</span><span class="op">)</span> <span class="op">|</span></span>
<span>                     <span class="va">id</span> <span class="op">+</span> <span class="va">year</span>, <span class="va">base_stagg</span><span class="op">)</span></span>
<span><span class="va">sa</span> <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">res_sa20</span><span class="op">)</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">14</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span></span>
<span><span class="va">sa</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sa</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">0</span>, <span class="va">sa</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sa_se</span> <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">res_sa20</span><span class="op">)</span><span class="op">[</span><span class="fl">6</span><span class="op">:</span><span class="fl">15</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">std.error</span><span class="op">)</span></span>
<span><span class="va">sa_se</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sa_se</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">0</span>, <span class="va">sa_se</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">compare_df_est</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    period <span class="op">=</span> <span class="op">-</span><span class="fl">5</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>    cs <span class="op">=</span> <span class="va">cs</span><span class="op">$</span><span class="va">att.egt</span>,</span>
<span>    sa <span class="op">=</span> <span class="va">sa</span>,</span>
<span>    stacked <span class="op">=</span> <span class="va">stacked_coeffs</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">compare_df_se</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    period <span class="op">=</span> <span class="op">-</span><span class="fl">5</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>    cs <span class="op">=</span> <span class="va">cs</span><span class="op">$</span><span class="va">se.egt</span>,</span>
<span>    sa <span class="op">=</span> <span class="va">sa_se</span>,</span>
<span>    stacked <span class="op">=</span> <span class="va">stacked_se</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">compare_df_longer</span> <span class="op">&lt;-</span> <span class="va">compare_df_est</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">!</span><span class="va">period</span>, names_to <span class="op">=</span> <span class="st">"estimator"</span>, values_to <span class="op">=</span> <span class="st">"est"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">compare_df_se</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">!</span><span class="va">period</span>, names_to <span class="op">=</span> <span class="st">"estimator"</span>, values_to <span class="op">=</span> <span class="st">"se"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>upper <span class="op">=</span> <span class="va">est</span> <span class="op">+</span>  <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span>,</span>
<span>           lower <span class="op">=</span> <span class="va">est</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">compare_df_longer</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">period</span>,</span>
<span>        ymin <span class="op">=</span> <span class="va">lower</span>,</span>
<span>        ymax <span class="op">=</span> <span class="va">upper</span>,</span>
<span>        group <span class="op">=</span> <span class="va">estimator</span></span>
<span>    <span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">period</span>,</span>
<span>        y <span class="op">=</span> <span class="va">est</span>,</span>
<span>        group <span class="op">=</span> <span class="va">estimator</span>,</span>
<span>        color <span class="op">=</span> <span class="va">estimator</span></span>
<span>    <span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"Comparison of Dynamic Treatment Effects"</span>,</span>
<span>        x <span class="op">=</span> <span class="st">"Event Time (Periods since Treatment)"</span>,</span>
<span>        y <span class="op">=</span> <span class="st">"Estimated ATT"</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"Estimator"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.1-stagger_files/figure-html/unnamed-chunk-10-1.png" width="90%" style="display: block; margin: auto;"></div>
<hr>
</div>
</div>
<div id="sec-panel-match-did-estimator-with-in-and-out-treatment-conditions" class="section level3" number="30.8.4">
<h3>
<span class="header-section-number">30.8.4</span> Panel Match DiD Estimator with In-and-Out Treatment Conditions<a class="anchor" aria-label="anchor" href="#sec-panel-match-did-estimator-with-in-and-out-treatment-conditions"><i class="fas fa-link"></i></a>
</h3>
<p>As noted in <span class="citation">Imai and Kim (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2021use">2021</a>)</span>, the <a href="sec-difference-in-differences.html#sec-two-way-fixed-effects">TWFE</a> regression model is widely used but fundamentally relies on strong modeling assumptions, particularly <strong>linearity</strong> and <strong>additivity</strong>. It does not constitute a fully nonparametric estimation method and may yield biased results under model misspecification.</p>
<div id="limitations-of-twfe-1" class="section level4" number="30.8.4.1">
<h4>
<span class="header-section-number">30.8.4.1</span> Limitations of TWFE<a class="anchor" aria-label="anchor" href="#limitations-of-twfe-1"><i class="fas fa-link"></i></a>
</h4>
<p>Researchers often prefer TWFE due to its ability to control for both unit- and time-specific unobserved confounders:</p>
<ul>
<li>
<span class="math inline">\(\alpha_i = h(\mathbf{U}_i)\)</span> accounts for unit-level confounders.</li>
<li>
<span class="math inline">\(\gamma_t = f(\mathbf{V}_t)\)</span> adjusts for time-level confounders.</li>
</ul>
<p>The functional forms <span class="math inline">\(h(\cdot)\)</span> and <span class="math inline">\(f(\cdot)\)</span> are left unspecified, but <strong>additivity and separability</strong> are assumed. TWFE is based on the model:</p>
<p><span class="math display">\[
Y_{it} = \alpha_i + \gamma_t + \beta X_{it} + \epsilon_{it}
\]</span></p>
<p>for <span class="math inline">\(i = 1, \dots, N\)</span>, and <span class="math inline">\(t = 1, \dots, T\)</span>. However, this formulation requires a linear specification for the treatment effect <span class="math inline">\(\beta\)</span>. Contrary to popular belief, the model does require functional form assumptions for validity <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2021use">Imai and Kim 2021, 406</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2019should">2019</a>)</span>.</p>
<hr>
</div>
<div id="matching-and-the-panel-match-did-estimator" class="section level4" number="30.8.4.2">
<h4>
<span class="header-section-number">30.8.4.2</span> Matching and the Panel Match DiD Estimator<a class="anchor" aria-label="anchor" href="#matching-and-the-panel-match-did-estimator"><i class="fas fa-link"></i></a>
</h4>
<p>To mitigate model dependence and improve causal inference validity, <span class="citation">Imai and Kim (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2021use">2021</a>)</span> propose a matching-based framework for panel data. This method is implemented via the <code>wfe</code> and <code>PanelMatch</code> R packages and offers <strong>design-based identification</strong> under relaxed assumptions.</p>
<p>This setting generalizes <a href="sec-difference-in-differences.html#sec-staggered-difference-in-differences">staggered adoption</a>, allowing units to transition in and out of treatment. The core idea is to construct matched control groups that share the same <strong>treatment history</strong> as treated units and then apply a <a href="sec-difference-in-differences.html#sec-simple-difference-in-differences">Difference-in-Differences</a> logic. This is better than <a href="(#sec-synthetic-control)">synthetic controls</a> (e.g., <span class="citation">Xu (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-xu2017generalized">2017</a>)</span>) because it requires less data to achieve good performance and can adapt to contexts where units switch treatment status multiple times.</p>
<p><strong>Key Properties</strong> of PM-DiD <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2021matching">Imai, Kim, and Wang 2021</a>)</span></p>
<ul>
<li>Designed for <strong>multiple treatment switches</strong> over time.</li>
<li>Addresses issues of <strong>carryover</strong>, <strong>reversal</strong>, and <strong>attenuation bias</strong>.</li>
<li>Allows estimation of <strong>short-term and long-term</strong> causal effects, accounting for time dynamics.</li>
</ul>
<p><strong>Key Findings</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2021matching">Imai, Kim, and Wang 2021</a>)</span></p>
<ul>
<li><p>Even under favorable conditions for OLS, PM-DiD is more robust to model misspecification and omitted lags.</p></li>
<li><p>This robustness comes with a cost: reduced efficiency (larger variance).</p></li>
<li><p>Reflects the classic bias-variance tradeoff between flexible and parametric estimators.</p></li>
</ul>
<p><strong>Data and Software Requirements</strong></p>
<ul>
<li><p>Treatment variable: binary (0 = control, 1 = treated).</p></li>
<li><p>Unit and time variables: integer/numeric and ordered.</p></li>
<li><p>Input data must be in <code>data.frame</code> format.</p></li>
</ul>
<p>Examples:</p>
<ul>
<li><p><span class="citation">Scheve and Stasavage (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-scheve2012democracy">2012</a>)</span></p></li>
<li><p><span class="citation">Acemoglu et al. (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-acemoglu2019democracy">2019</a>)</span></p></li>
</ul>
<hr>
</div>
<div id="two-way-matching-interpretation-of-twfe" class="section level4" number="30.8.4.3">
<h4>
<span class="header-section-number">30.8.4.3</span> Two-Way Matching Interpretation of TWFE<a class="anchor" aria-label="anchor" href="#two-way-matching-interpretation-of-twfe"><i class="fas fa-link"></i></a>
</h4>
<p>The least squares estimate of <span class="math inline">\(\beta\)</span> in the TWFE model can be re-expressed as a <strong>matching estimator</strong> that compares each treated unit to observations within:</p>
<ul>
<li>The <strong>same unit</strong> (within-unit match),</li>
<li>The <strong>same time period</strong> (within-time match),</li>
<li>Adjusted by a third set of observations in neither group.</li>
</ul>
<p>This leads to mismatches—treated observations compared to units with the same treatment status, which causes <strong>attenuation bias</strong>.</p>
<p>The adjustment factor <span class="math inline">\(K\)</span> corrects for this by weighting matches appropriately. However, even the <strong>weighted TWFE estimator</strong> contains some mismatches and relies on comparisons across units that differ in key characteristics.</p>
<p>In the simple two-period, two-group DiD setting, the TWFE and DiD estimators coincide. However, in <a href="sec-difference-in-differences.html#sec-multiple-periods-and-variation-in-treatment-timing">multi-period DiD</a> with <strong>treatment reversals</strong>, this equivalence breaks down <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2021use">Imai and Kim 2021</a>)</span>.</p>
<ul>
<li>The <strong>unweighted TWFE</strong> is not equivalent to multi-period DiD.</li>
<li>The <a href="sec-difference-in-differences.html#sec-multiple-periods-and-variation-in-treatment-timing">multi-period DiD</a> is equivalent to a <strong>weighted TWFE</strong>, but some weights are <strong>negative</strong>—a problematic feature from a design-based perspective.</li>
</ul>
<p>This means that justifying TWFE via DiD logic is incorrect unless the linearity assumption is satisfied.</p>
<hr>
</div>
<div id="estimation-using-panel-match-did" class="section level4" number="30.8.4.4">
<h4>
<span class="header-section-number">30.8.4.4</span> Estimation Using Panel Match DiD<a class="anchor" aria-label="anchor" href="#estimation-using-panel-match-did"><i class="fas fa-link"></i></a>
</h4>
<p><strong>Core Estimation Steps</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2021matching">Imai, Kim, and Wang 2021</a>)</span>:</p>
<ol style="list-style-type: decimal">
<li>Match treated observations with control observations from the same time period and with identical treatment histories over the past <span class="math inline">\(L\)</span> periods.</li>
<li>Use standard matching or weighting methods to refine control sets (e.g., Mahalanobis distance, propensity score).</li>
<li>Apply a DiD estimator to compute treatment effects at time <span class="math inline">\(t + F\)</span>.</li>
<li>Evaluate match quality using covariate balance diagnostics <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-ho2007matching">Ho et al. 2007</a>)</span>.</li>
</ol>
<p><strong>Causal Estimand</strong></p>
<p>Let <span class="math inline">\(F\)</span> be the number of <strong>leads</strong> (future periods) and <span class="math inline">\(L\)</span> be the number of <strong>lags</strong> (past treatment periods). Define the average treatment effect as:</p>
<p><span class="math display">\[
\delta(F, L) = \mathbb{E}\left[Y_{i, t+F}(1) - Y_{i, t+F}(0) \mid \text{treatment history from } t-L \text{ to } t\right]
\]</span></p>
<ul>
<li>
<span class="math inline">\(F = 0\)</span>: contemporaneous effect (short-run ATT)</li>
<li>
<span class="math inline">\(F &gt; 0\)</span>: future outcomes (long-run ATT)</li>
<li>
<span class="math inline">\(L\)</span>: adjusts for potential <strong>carryover effects</strong>
</li>
</ul>
<p>The estimator also allows for estimation of the <strong>Average Reversal Treatment Effect (ART)</strong> when treatment status switches from 1 to 0.</p>
<hr>
</div>
<div id="model-assumptions" class="section level4" number="30.8.4.5">
<h4>
<span class="header-section-number">30.8.4.5</span> Model Assumptions<a class="anchor" aria-label="anchor" href="#model-assumptions"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li><p><strong>No spillover effects</strong> across units (i.e., SUTVA holds)</p></li>
<li><p><strong>Carryover effects</strong> allowed up to <span class="math inline">\(L\)</span> periods.</p></li>
<li><p>After <span class="math inline">\(L\)</span> lags, prior treatments are assumed to have no effect on <span class="math inline">\(Y_{i,t+F}\)</span>.</p></li>
<li><p>The potential outcome at <span class="math inline">\(t + F\)</span> is independent of treatment assignments beyond <span class="math inline">\(t - L\)</span>.</p></li>
<li>
<p>The key identifying assumption is a conditional parallel trends assumption. Outcome trends are assumed parallel across treated and matched control units, conditional on:</p>
<ul>
<li><p>Past treatment,</p></li>
<li><p>Covariate histories,</p></li>
<li><p>Lagged outcomes (excluding the most recent).</p></li>
</ul>
<p>Unlike standard <a href="sec-difference-in-differences.html#sec-simple-difference-in-differences">TWFE</a>, strong ignorability is not required.</p>
</li>
</ul>
<hr>
</div>
<div id="covariate-balance-assessment" class="section level4" number="30.8.4.6">
<h4>
<span class="header-section-number">30.8.4.6</span> Covariate Balance Assessment<a class="anchor" aria-label="anchor" href="#covariate-balance-assessment"><i class="fas fa-link"></i></a>
</h4>
<p>Assessing balance before estimating ATT is critical:</p>
<ul>
<li>Compute the mean standardized difference between treated and matched control units.</li>
<li>Check balance across covariates and lagged outcomes for all <span class="math inline">\(L\)</span> pretreatment periods.</li>
<li>Imbalanced covariates may indicate violations of the parallel trends assumption.</li>
</ul>
<hr>
</div>
<div id="implementing-the-panel-match-did-estimator" class="section level4" number="30.8.4.7">
<h4>
<span class="header-section-number">30.8.4.7</span> Implementing the Panel Match DiD Estimator<a class="anchor" aria-label="anchor" href="#implementing-the-panel-match-did-estimator"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb783"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">PanelMatch</span><span class="op">)</span></span></code></pre></div>
<p><strong>Treatment Variation Plot</strong></p>
<p>Visualizing the variation of treatment across space and time is essential to assess whether the treatment has sufficient heterogeneity to support credible causal identification.</p>
<div class="sourceCode" id="cb784"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/DisplayTreatment.html">DisplayTreatment</a></span><span class="op">(</span></span>
<span>  panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span></span>
<span>    panel.data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>    time.id <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    treatment <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>    outcome <span class="op">=</span> <span class="st">"y"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  legend.position <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">"Country Code"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.2-did-other_files/figure-html/unnamed-chunk-2-1.png" width="90%" style="display: block; margin: auto;"></div>
<ul>
<li><p>This plot aids in identifying whether the treatment is broadly distributed or concentrated among a few units or time periods.</p></li>
<li><p>Insufficient treatment variation may weaken identification or reduce the precision of estimated effects.</p></li>
</ul>
<div id="setting-parameters-f-and-l" class="section level5" number="30.8.4.7.1">
<h5>
<span class="header-section-number">30.8.4.7.1</span> Setting Parameters <span class="math inline">\(F\)</span> and <span class="math inline">\(L\)</span><a class="anchor" aria-label="anchor" href="#setting-parameters-f-and-l"><i class="fas fa-link"></i></a>
</h5>
<ol style="list-style-type: decimal">
<li>Select <span class="math inline">\(F\)</span>: the number of leads, or time periods after treatment, for which the effect is measured.</li>
</ol>
<ul>
<li><p><span class="math inline">\(F = 0\)</span>: contemporaneous (short-term) treatment effect.</p></li>
<li><p><span class="math inline">\(F &gt; 0\)</span>: long-term or cumulative effects.</p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Select <span class="math inline">\(L\)</span>: the number of lags (prior treatment periods) used in matching to adjust for carryover effects.</li>
</ol>
<ul>
<li><p>Increasing <span class="math inline">\(L\)</span> enhances credibility but reduces match quality and sample size.</p></li>
<li><p>This selection reflects the bias-variance tradeoff.</p></li>
</ul>
<hr>
</div>
<div id="causal-quantity-of-interest" class="section level5" number="30.8.4.7.2">
<h5>
<span class="header-section-number">30.8.4.7.2</span> Causal Quantity of Interest<a class="anchor" aria-label="anchor" href="#causal-quantity-of-interest"><i class="fas fa-link"></i></a>
</h5>
<p>The <a href="sec-causal-inference.html#sec-average-treatment-effect-on-the-treated">ATT</a> is defined as:</p>
<p><span class="math display">\[
\delta(F, L) = \mathbb{E} \left[ Y_{i,t+F}(1) - Y_{i,t+F}(0) \mid X_{i,t} = 1, \text{History}_{i,t-L:t-1} \right]
\]</span></p>
<ul>
<li><p>This estimator accounts for carryover history (via <span class="math inline">\(L\)</span>) and post-treatment dynamics (via <span class="math inline">\(F\)</span>).</p></li>
<li><p>It is also robust to treatment reversals, i.e., treatment switching back to control.</p></li>
</ul>
<p>A related estimand, the <strong>Average Reversal Treatment Effect (ART)</strong>, measures the causal effect of switching from treatment to control.</p>
</div>
<div id="choosing-f-and-l" class="section level5" number="30.8.4.7.3">
<h5>
<span class="header-section-number">30.8.4.7.3</span> Choosing <span class="math inline">\(F\)</span> and <span class="math inline">\(L\)</span><a class="anchor" aria-label="anchor" href="#choosing-f-and-l"><i class="fas fa-link"></i></a>
</h5>
<ul>
<li>
<p><strong>Large</strong> <span class="math inline">\(L\)</span>:</p>
<ul>
<li><p>Improves identification of causal effect by accounting for long-term treatment confounding.</p></li>
<li><p>Reduces sample size due to stricter matching requirements.</p></li>
</ul>
</li>
<li>
<p><strong>Large</strong> <span class="math inline">\(F\)</span>:</p>
<ul>
<li><p>Enables analysis of delayed effects.</p></li>
<li><p>Complicates interpretation if units switch treatment again before <span class="math inline">\(t + F\)</span>.</p></li>
</ul>
</li>
</ul>
<p>Researchers should select <span class="math inline">\(F\)</span> and <span class="math inline">\(L\)</span> based on substantive context, theoretical considerations, and sensitivity analysis.</p>
<hr>
</div>
<div id="constructing-and-refining-matched-sets" class="section level5" number="30.8.4.7.4">
<h5>
<span class="header-section-number">30.8.4.7.4</span> Constructing and Refining Matched Sets<a class="anchor" aria-label="anchor" href="#constructing-and-refining-matched-sets"><i class="fas fa-link"></i></a>
</h5>
<ol style="list-style-type: decimal">
<li><strong>Initial Matching</strong></li>
</ol>
<ul>
<li><p>Each treated observation is matched to control units from other units in the same time period.</p></li>
<li><p>Matching is based on exact treatment histories from <span class="math inline">\(t - L\)</span> to <span class="math inline">\(t - 1\)</span>.</p></li>
</ul>
<p>Purpose</p>
<ul>
<li><p>Controls for carryover effects.</p></li>
<li><p>Ensures matched units have similar latent propensities for treatment.</p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><strong>Refinement Process</strong></li>
</ol>
<ul>
<li><p>Refined matched sets additionally adjust for pre-treatment covariates and lagged outcomes.</p></li>
<li>
<p>Matching strategies:</p>
<ul>
<li><p>Mahalanobis distance.</p></li>
<li><p>Propensity score.</p></li>
</ul>
</li>
</ul>
<!-- --><ul>
<li>Up to <span class="math inline">\(J\)</span> best matches per treated unit may be used.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><strong>Weighting</strong></li>
</ol>
<ul>
<li><p>Assigns weights to matched controls to emphasize similarity.</p></li>
<li><p>Weighting is often done via inverse propensity scores, or other balance-enhancing metrics.</p></li>
<li><p>Can be considered a generalization of traditional matching.</p></li>
</ul>
<hr>
</div>
<div id="difference-in-differences-estimation" class="section level5" number="30.8.4.7.5">
<h5>
<span class="header-section-number">30.8.4.7.5</span> Difference-in-Differences Estimation<a class="anchor" aria-label="anchor" href="#difference-in-differences-estimation"><i class="fas fa-link"></i></a>
</h5>
<p>Once matched sets are constructed:</p>
<ul>
<li><p>The counterfactual for each treated unit is a weighted average of outcomes from its matched control set.</p></li>
<li><p>The DiD estimate of ATT is:</p></li>
</ul>
<p><span class="math display">\[
\widehat{\delta}_{\text{ATT}} = \frac{1}{|T_1|} \sum_{(i,t) \in T_1} \left[ Y_{i,t+F} - \sum_{j \in \mathcal{C}_{it}} w_{ijt} Y_{j,t+F} \right]
\]</span></p>
<p>where <span class="math inline">\(T_1\)</span> is the set of treated observations, <span class="math inline">\(\mathcal{C}_{it}\)</span> is the matched control set, and <span class="math inline">\(w_{ijt}\)</span> are normalized weights.</p>
<p>Considerations when <span class="math inline">\(F &gt; 0\)</span>:</p>
<ul>
<li><p>Matched controls may themselves switch into treatment before <span class="math inline">\(t + F\)</span>.</p></li>
<li><p>Some treated units may revert to control.</p></li>
</ul>
<hr>
</div>
<div id="checking-covariate-balance" class="section level5" number="30.8.4.7.6">
<h5>
<span class="header-section-number">30.8.4.7.6</span> Checking Covariate Balance<a class="anchor" aria-label="anchor" href="#checking-covariate-balance"><i class="fas fa-link"></i></a>
</h5>
<p>One of the main advantages of matching-based estimators is the ability to diagnose balance:</p>
<ul>
<li>For each covariate and each lag, compute:</li>
</ul>
<p><span class="math display">\[
\text{Standardized Difference} = \frac{\bar{X}_{\text{treated}} - \bar{X}_{\text{control}}}{\text{SD}_{\text{treated}}}
\]</span></p>
<ul>
<li><p>Aggregate these over all treated observations and time periods.</p></li>
<li>
<p>Examine balance on:</p>
<ul>
<li><p>Time-varying covariates,</p></li>
<li><p>Lagged outcomes,</p></li>
<li><p>Baseline covariates</p></li>
</ul>
</li>
</ul>
<p>Balance checks provide indirect validation of the <a href="sec-difference-in-differences.html#prior-parallel-trends-test">parallel trends assumption</a>.</p>
<hr>
</div>
<div id="standard-error-estimation" class="section level5" number="30.8.4.7.7">
<h5>
<span class="header-section-number">30.8.4.7.7</span> Standard Error Estimation<a class="anchor" aria-label="anchor" href="#standard-error-estimation"><i class="fas fa-link"></i></a>
</h5>
<ul>
<li><p>Analogous to the conditional variance seen in regression models.</p></li>
<li><p>Standard errors are calculated conditional on the matching weights <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imbens2015causal">G. W. Imbens and Rubin 2015</a>)</span>.</p></li>
<li><p>SE here is a measure of sampling uncertainty given the matched design.</p></li>
</ul>
<p><strong>Note</strong>: They do not incorporate uncertainty from the matching procedure itself <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-ho2007matching">Ho et al. 2007</a>)</span>.</p>
<hr>
</div>
<div id="matching-on-treatment-history" class="section level5" number="30.8.4.7.8">
<h5>
<span class="header-section-number">30.8.4.7.8</span> Matching on Treatment History<a class="anchor" aria-label="anchor" href="#matching-on-treatment-history"><i class="fas fa-link"></i></a>
</h5>
<ul>
<li><p>The goal is to compare treated units transitioning into treatment to control units with comparable treatment histories.</p></li>
<li>
<p>Set <code>qoi =</code>:</p>
<ul>
<li><p><code>"att"</code>: Average Treatment on the Treated,</p></li>
<li><p><code>"atc"</code>: Average Treatment on the Controls,</p></li>
<li><p><code>"art"</code>: Average Reversal Treatment Effect,</p></li>
<li><p><code>"ate"</code>: Average Treatment Effect.</p></li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb785"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">PanelMatch</span><span class="op">)</span></span>
<span><span class="co"># All examples follow the package's vignette</span></span>
<span><span class="co"># Create the matched sets</span></span>
<span><span class="va">PM.results.none</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        refinement.method <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>        panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>        match.missing <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        size.match <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi <span class="op">=</span> <span class="st">"att"</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        use.diagonal.variance.matrix <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># visualize the treated unit and matched controls</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/DisplayTreatment.html">DisplayTreatment</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"Country Code"</span>,</span>
<span>    panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>    matched.set <span class="op">=</span> <span class="va">PM.results.none</span><span class="op">$</span><span class="va">att</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>    <span class="co"># highlight the particular set</span></span>
<span>    show.set.only <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.2-did-other_files/figure-html/unnamed-chunk-3-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>Control units and the treated unit have identical treatment histories over the lag window (1988-1991)</p>
<div class="sourceCode" id="cb786"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/DisplayTreatment.html">DisplayTreatment</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"Country Code"</span>,</span>
<span>    panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>    matched.set <span class="op">=</span> <span class="va">PM.results.none</span><span class="op">$</span><span class="va">att</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>    <span class="co"># highlight the particular set</span></span>
<span>    show.set.only <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.2-did-other_files/figure-html/unnamed-chunk-4-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>This set is more limited than the first one, but we can still see that we have exact past histories.</p>
<ul>
<li>
<p><strong>Refining Matched Sets</strong></p>
<ul>
<li><p>Refinement involves assigning weights to control units.</p></li>
<li>
<p>Users must:</p>
<ol style="list-style-type: decimal">
<li><p>Specify a method for calculating unit similarity/distance.</p></li>
<li><p>Choose variables for similarity/distance calculations.</p></li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>Select a Refinement Method</strong></p>
<ul>
<li><p>Users determine the refinement method via the <strong><code>refinement.method</code></strong> argument.</p></li>
<li>
<p>Options include:</p>
<ul>
<li><p><code>mahalanobis</code></p></li>
<li><p><code>ps.match</code></p></li>
<li><p><code>CBPS.match</code></p></li>
<li><p><code>ps.weight</code></p></li>
<li><p><code>CBPS.weight</code></p></li>
<li><p><code>ps.msm.weight</code></p></li>
<li><p><code>CBPS.msm.weight</code></p></li>
<li><p><code>none</code></p></li>
</ul>
</li>
<li><p>Methods with “match” in the name and Mahalanobis will assign equal weights to similar control units.</p></li>
<li><p>“Weighting” methods give higher weights to control units more similar to treated units.</p></li>
</ul>
</li>
<li>
<p><strong>Variable Selection</strong></p>
<ul>
<li><p>Users need to define which covariates will be used through the <strong><code>covs.formula</code></strong> argument, a one-sided formula object.</p></li>
<li><p>Variables on the right side of the formula are used for calculations.</p></li>
<li><p>“Lagged” versions of variables can be included using the format: <strong><code>I(lag(name.of.var, 0:n))</code></strong>.</p></li>
</ul>
</li>
<li>
<p><strong>Understanding <code>PanelMatch</code> and <code>matched.set</code> objects</strong></p>
<ul>
<li><p>The <strong><code>PanelMatch</code> function</strong> returns a <strong><code>PanelMatch</code> object</strong>.</p></li>
<li><p>The most crucial element within the <code>PanelMatch</code> object is the <strong>matched.set object</strong>.</p></li>
<li><p>Within the <code>PanelMatch</code> object, the matched.set object will have names like att, art, or atc.</p></li>
<li><p>If <strong><code>qoi = ate</code></strong>, there will be two matched.set objects: att and atc.</p></li>
</ul>
</li>
<li>
<p><strong>Matched.set Object Details</strong></p>
<ul>
<li><p>matched.set is a named list with added attributes.</p></li>
<li>
<p>Attributes include:</p>
<ul>
<li><p>Lag</p></li>
<li><p>Names of treatment</p></li>
<li><p>Unit and time variables</p></li>
</ul>
</li>
<li><p>Each list entry represents a matched set of treated and control units.</p></li>
<li><p>Naming follows a structure: <strong><code>[id variable].[time variable]</code></strong>.</p></li>
<li><p>Each list element is a vector of control unit ids that match the treated unit mentioned in the element name.</p></li>
<li><p>Since it’s a matching method, weights are only given to the <strong><code>size.match</code></strong> most similar control units based on distance calculations.</p></li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb787"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># PanelMatch without any refinement</span></span>
<span><span class="va">PM.results.none</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        refinement.method <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>        panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>        match.missing <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        size.match <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi <span class="op">=</span> <span class="st">"att"</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        use.diagonal.variance.matrix <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract the matched.set object</span></span>
<span><span class="va">msets.none</span> <span class="op">&lt;-</span> <span class="va">PM.results.none</span><span class="op">$</span><span class="va">att</span></span>
<span></span>
<span><span class="co"># PanelMatch with refinement</span></span>
<span><span class="va">PM.results.maha</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        refinement.method <span class="op">=</span> <span class="st">"mahalanobis"</span>, <span class="co"># use Mahalanobis distance</span></span>
<span>        panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>        match.missing <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        covs.formula <span class="op">=</span> <span class="op">~</span> <span class="va">tradewb</span>,</span>
<span>        size.match <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi <span class="op">=</span> <span class="st">"att"</span> ,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        use.diagonal.variance.matrix <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span><span class="va">msets.maha</span> <span class="op">&lt;-</span> <span class="va">PM.results.maha</span><span class="op">$</span><span class="va">att</span></span></code></pre></div>
<div class="sourceCode" id="cb788"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># these 2 should be identical because weights are not shown</span></span>
<span><span class="va">msets.none</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   wbcode2 year matched.set.size</span></span>
<span><span class="co">#&gt; 1       4 1992               74</span></span>
<span><span class="co">#&gt; 2       4 1997                2</span></span>
<span><span class="co">#&gt; 3       6 1973               63</span></span>
<span><span class="co">#&gt; 4       6 1983               73</span></span>
<span><span class="co">#&gt; 5       7 1991               81</span></span>
<span><span class="co">#&gt; 6       7 1998                1</span></span>
<span><span class="va">msets.maha</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   wbcode2 year matched.set.size</span></span>
<span><span class="co">#&gt; 1       4 1992               74</span></span>
<span><span class="co">#&gt; 2       4 1997                2</span></span>
<span><span class="co">#&gt; 3       6 1973               63</span></span>
<span><span class="co">#&gt; 4       6 1983               73</span></span>
<span><span class="co">#&gt; 5       7 1991               81</span></span>
<span><span class="co">#&gt; 6       7 1998                1</span></span>
<span><span class="co"># summary(msets.none)</span></span>
<span><span class="co"># summary(msets.maha)</span></span></code></pre></div>
<p><strong>Visualizing Matched Sets with the plot method</strong></p>
<ul>
<li><p>Users can visualize the distribution of the matched set sizes.</p></li>
<li><p>A red line, by default, indicates the count of matched sets where treated units had no matching control units (i.e., empty matched sets).</p></li>
<li><p>Plot adjustments can be made using <strong><code><a href="https://rdrr.io/r/graphics/plot.default.html">graphics::plot</a></code></strong>.</p></li>
</ul>
<div class="sourceCode" id="cb789"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">msets.none</span>,</span>
<span>  panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span></span>
<span>    panel.data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>    time.id <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    treatment <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>    outcome <span class="op">=</span> <span class="st">"y"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.2-did-other_files/figure-html/unnamed-chunk-7-1.png" width="90%" style="display: block; margin: auto;"></div>
<p><strong>Comparing Methods of Refinement</strong></p>
<ul>
<li>
<p>Users are encouraged to:</p>
<ul>
<li><p>Use substantive knowledge for experimentation and evaluation.</p></li>
<li>
<p>Consider the following when configuring <code>PanelMatch</code>:</p>
<ol style="list-style-type: decimal">
<li><p>The number of matched sets.</p></li>
<li><p>The number of controls matched to each treated unit.</p></li>
<li><p>Achieving covariate balance.</p></li>
</ol>
</li>
<li><p><strong>Note</strong>: Large numbers of small matched sets can lead to larger standard errors during the estimation stage.</p></li>
<li><p>Covariates that aren’t well balanced can lead to undesirable comparisons between treated and control units.</p></li>
<li>
<p>Aspects to consider include:</p>
<ul>
<li><p>Refinement method.</p></li>
<li><p>Variables for weight calculation.</p></li>
<li><p>Size of the lag window.</p></li>
<li><p>Procedures for addressing missing data (refer to <strong><code>match.missing</code></strong> and <strong><code>listwise.delete</code></strong> arguments).</p></li>
<li><p>Maximum size of matched sets (for matching methods).</p></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Supportive Features:</strong></p>
<ul>
<li><p><strong><code>print</code></strong>, <strong><code>plot</code></strong>, and <strong><code>summary</code></strong> methods assist in understanding matched sets and their sizes.</p></li>
<li>
<p><strong><code>get_covariate_balance</code></strong> helps evaluate covariate balance:</p>
<ul>
<li>Lower values in the covariate balance calculations are preferred.</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb790"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PM.results.none</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        refinement.method <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>        panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>        match.missing <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        size.match <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi <span class="op">=</span> <span class="st">"att"</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        use.diagonal.variance.matrix <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span><span class="va">PM.results.maha</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        refinement.method <span class="op">=</span> <span class="st">"mahalanobis"</span>,</span>
<span>        panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>        match.missing <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        covs.formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">tradewb</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        size.match <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi <span class="op">=</span> <span class="st">"att"</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        use.diagonal.variance.matrix <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># listwise deletion used for missing data</span></span>
<span><span class="va">PM.results.listwise</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        refinement.method <span class="op">=</span> <span class="st">"mahalanobis"</span>,</span>
<span>        panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>        match.missing <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        listwise.delete <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        covs.formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">tradewb</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        size.match <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi <span class="op">=</span> <span class="st">"att"</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        use.diagonal.variance.matrix <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># propensity score based weighting method</span></span>
<span><span class="va">PM.results.ps.weight</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        refinement.method <span class="op">=</span> <span class="st">"ps.weight"</span>,</span>
<span>        panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>        match.missing <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        listwise.delete <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        covs.formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">tradewb</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        size.match <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi <span class="op">=</span> <span class="st">"att"</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/get_covariate_balance.html">get_covariate_balance</a></span><span class="op">(</span></span>
<span>    <span class="va">PM.results.none</span>,</span>
<span>    panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>    covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tradewb"</span>, <span class="st">"y"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; $att</span></span>
<span><span class="co">#&gt;         tradewb            y</span></span>
<span><span class="co">#&gt; t_4 -0.07245466  0.291871990</span></span>
<span><span class="co">#&gt; t_3 -0.20930129  0.208654876</span></span>
<span><span class="co">#&gt; t_2 -0.24425207  0.107736647</span></span>
<span><span class="co">#&gt; t_1 -0.10806125 -0.004950238</span></span>
<span><span class="co">#&gt; t_0 -0.09493854 -0.015198483</span></span></code></pre></div>
<div class="sourceCode" id="cb791"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare covariate balance to refined sets</span></span>
<span><span class="co"># See large improvement in balance</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/get_covariate_balance.html">get_covariate_balance</a></span><span class="op">(</span></span>
<span>    <span class="va">PM.results.ps.weight</span>,</span>
<span>     panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>    covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tradewb"</span>, <span class="st">"y"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; $att</span></span>
<span><span class="co">#&gt;         tradewb          y</span></span>
<span><span class="co">#&gt; t_4 0.014362590 0.04035905</span></span>
<span><span class="co">#&gt; t_3 0.005529734 0.04188731</span></span>
<span><span class="co">#&gt; t_2 0.009410044 0.04195008</span></span>
<span><span class="co">#&gt; t_1 0.027907540 0.03975173</span></span>
<span><span class="co">#&gt; t_0 0.040272235 0.04167921</span></span></code></pre></div>
<p><strong><code>PanelEstimate</code></strong></p>
<ul>
<li>
<p><strong>Standard Error Calculation Methods</strong></p>
<ul>
<li>
<p>There are different methods available:</p>
<ul>
<li><p><strong>Bootstrap</strong> (default method with 1000 iterations).</p></li>
<li><p><strong>Conditional</strong>: Assumes independence across units, but not time.</p></li>
<li><p><strong>Unconditional</strong>: Doesn’t make assumptions of independence across units or time.</p></li>
</ul>
</li>
<li>
<p>For <strong><code>qoi</code></strong> values set to <code>att</code>, <code>art</code>, or <code>atc</code> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imai2021matching">Imai, Kim, and Wang 2021</a>)</span>:</p>
<ul>
<li>You can use analytical methods for calculating standard errors, which include both “conditional” and “unconditional” methods.</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb792"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PE.results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelEstimate.html">PanelEstimate</a></span><span class="op">(</span></span>
<span>    sets              <span class="op">=</span> <span class="va">PM.results.ps.weight</span>,</span>
<span>    panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>    se.method         <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>    number.iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    confidence.level  <span class="op">=</span> <span class="fl">.95</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># point estimates</span></span>
<span><span class="va">PE.results</span><span class="op">[[</span><span class="st">"estimates"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span></span>
<span><span class="co"># standard errors</span></span>
<span><span class="va">PE.results</span><span class="op">[[</span><span class="st">"standard.error"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt;       t+0       t+1       t+2       t+3       t+4 </span></span>
<span><span class="co">#&gt; 0.6126167 1.0374472 1.4424743 1.8057148 2.1835808</span></span>
<span></span>
<span></span>
<span><span class="co"># use conditional method</span></span>
<span><span class="va">PE.results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelEstimate.html">PanelEstimate</a></span><span class="op">(</span></span>
<span>    sets             <span class="op">=</span> <span class="va">PM.results.ps.weight</span>,</span>
<span>    panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>    se.method        <span class="op">=</span> <span class="st">"conditional"</span>,</span>
<span>    confidence.level <span class="op">=</span> <span class="fl">.95</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># point estimates</span></span>
<span><span class="va">PE.results</span><span class="op">[[</span><span class="st">"estimates"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span></span>
<span><span class="co"># standard errors</span></span>
<span><span class="va">PE.results</span><span class="op">[[</span><span class="st">"standard.error"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt;       t+0       t+1       t+2       t+3       t+4 </span></span>
<span><span class="co">#&gt; 0.4844805 0.8170604 1.1171942 1.4116879 1.7172143</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">PE.results</span><span class="op">)</span></span>
<span><span class="co">#&gt;      estimate std.error       2.5%    97.5%</span></span>
<span><span class="co">#&gt; t+0 0.2609565 0.4844805 -0.6886078 1.210521</span></span>
<span><span class="co">#&gt; t+1 0.9630847 0.8170604 -0.6383243 2.564494</span></span>
<span><span class="co">#&gt; t+2 1.2851017 1.1171942 -0.9045586 3.474762</span></span>
<span><span class="co">#&gt; t+3 1.7370930 1.4116879 -1.0297644 4.503950</span></span>
<span><span class="co">#&gt; t+4 1.4871846 1.7172143 -1.8784937 4.852863</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">PE.results</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.2-did-other_files/figure-html/unnamed-chunk-10-1.png" width="90%" style="display: block; margin: auto;"></div>
<p><strong>Moderating Variables</strong></p>
<div class="sourceCode" id="cb793"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># moderating variable</span></span>
<span><span class="va">dem</span><span class="op">$</span><span class="va">moderator</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">dem</span><span class="op">$</span><span class="va">moderator</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dem</span><span class="op">$</span><span class="va">wbcode2</span> <span class="op">&gt;</span> <span class="fl">100</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">PM.results</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag                          <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        <span class="co"># time.id                      = "year",</span></span>
<span>        <span class="co"># unit.id                      = "wbcode2",</span></span>
<span>        <span class="co"># treatment                    = "dem",</span></span>
<span>        refinement.method            <span class="op">=</span> <span class="st">"mahalanobis"</span>,</span>
<span>        panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>        match.missing                <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        covs.formula                 <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">tradewb</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        size.match                   <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi                          <span class="op">=</span> <span class="st">"att"</span>,</span>
<span>        <span class="co"># outcome.var                  = "y",</span></span>
<span>        lead                         <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal    <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        use.diagonal.variance.matrix <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span><span class="va">PE.results</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelEstimate.html">PanelEstimate</a></span><span class="op">(</span>sets      <span class="op">=</span> <span class="va">PM.results</span>,</span>
<span>                  panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>                  moderator <span class="op">=</span> <span class="st">"moderator"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Each element in the list corresponds to a level in the moderator</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">PE.results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.2-did-other_files/figure-html/unnamed-chunk-11-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb794"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">PE.results</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.2-did-other_files/figure-html/unnamed-chunk-11-2.png" width="90%" style="display: block; margin: auto;"></div>
<!--#To write up for journal submission, you can follow the following report:  -->
<p>In this study, closely aligned with the research by <span class="citation">Acemoglu et al. (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-acemoglu2019democracy">2019</a>)</span>, two key effects of democracy on economic growth are estimated: the impact of democratization and that of authoritarian reversal. The treatment variable, <span class="math inline">\(X_{it}\)</span>, is defined to be one if country <span class="math inline">\(i\)</span> is democratic in year <span class="math inline">\(t\)</span>, and zero otherwise.</p>
<p>The Average Treatment Effect for the Treated (ATT) under democratization is formulated as follows:</p>
<p><span class="math display">\[
\begin{aligned}
\delta(F, L) &amp;= \mathbb{E} \left\{ Y_{i, t + F} (X_{it} = 1, X_{i, t - 1} = 0, \{X_{i,t-l}\}_{l=2}^L) \right. \\
&amp;\left. - Y_{i, t + F} (X_{it} = 0, X_{i, t - 1} = 0, \{X_{i,t-l}\}_{l=2}^L) | X_{it} = 1, X_{i, t - 1} = 0 \right\}
\end{aligned}
\]</span></p>
<p>In this framework, the treated observations are countries that transition from an authoritarian regime <span class="math inline">\(X_{it-1} = 0\)</span> to a democratic one <span class="math inline">\(X_{it} = 1\)</span>. The variable <span class="math inline">\(F\)</span> represents the number of leads, denoting the time periods following the treatment, and <span class="math inline">\(L\)</span> signifies the number of lags, indicating the time periods preceding the treatment.</p>
<p>The ATT under authoritarian reversal is given by:</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\mathbb{E} \left[ Y_{i, t + F} (X_{it} = 0, X_{i, t - 1} = 1, \{ X_{i, t - l}\}_{l=2}^L ) \right. \\
&amp;\left. - Y_{i, t + F} (X_{it} = 1, X_{it-1} = 1, \{X_{i, t - l} \}_{l=2}^L ) | X_{it} = 0, X_{i, t - 1} = 1 \right]
\end{aligned}
\]</span></p>
<p>The ATT is calculated conditioning on 4 years of lags (<span class="math inline">\(L = 4\)</span>) and up to 4 years following the policy change <span class="math inline">\(F = 1, 2, 3, 4\)</span>. Matched sets for each treated observation are constructed based on its treatment history, with the number of matched control units generally decreasing when considering a 4-year treatment history as compared to a 1-year history.</p>
<p>To enhance the quality of matched sets, methods such as Mahalanobis distance matching, propensity score matching, and propensity score weighting are utilized. These approaches enable us to evaluate the effectiveness of each refinement method. In the process of matching, we employ both up-to-five and up-to-ten matching to investigate how sensitive our empirical results are to the maximum number of allowed matches. For more information on the refinement process, please see the Web Appendix</p>
<blockquote>
<p>The Mahalanobis distance is expressed through a specific formula. We aim to pair each treated unit with a maximum of <span class="math inline">\(J\)</span> control units, permitting replacement, denoted as <span class="math inline">\(| \mathcal{M}_{it} \le J|\)</span>. The average Mahalanobis distance between a treated and each control unit over time is computed as:</p>
<p><span class="math display">\[ S_{it} (i') = \frac{1}{L} \sum_{l = 1}^L \sqrt{(\mathbf{V}_{i, t - l} - \mathbf{V}_{i', t -l})^T \mathbf{\Sigma}_{i, t - l}^{-1} (\mathbf{V}_{i, t - l} - \mathbf{V}_{i', t -l})} \]</span></p>
<p>For a matched control unit <span class="math inline">\(i' \in \mathcal{M}_{it}\)</span>, <span class="math inline">\(\mathbf{V}_{it'}\)</span> represents the time-varying covariates to adjust for, and <span class="math inline">\(\mathbf{\Sigma}_{it'}\)</span> is the sample covariance matrix for <span class="math inline">\(\mathbf{V}_{it'}\)</span>. Essentially, we calculate a standardized distance using time-varying covariates and average this across different time intervals.</p>
<p>In the context of propensity score matching, we employ a logistic regression model with balanced covariates to derive the propensity score. Defined as the conditional likelihood of treatment given pre-treatment covariates <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-rosenbaum1983central">Rosenbaum and Rubin 1983</a>)</span>, the propensity score is estimated by first creating a data subset comprised of all treated and their matched control units from the same year. This logistic regression model is then fitted as follows:</p>
<p><span class="math display">\[ \begin{aligned} &amp; e_{it} (\{\mathbf{U}_{i, t - l} \}^L_{l = 1}) \\ &amp;= Pr(X_{it} = 1| \mathbf{U}_{i, t -1}, \ldots, \mathbf{U}_{i, t - L}) \\ &amp;= \frac{1}{1 = \exp(- \sum_{l = 1}^L \beta_l^T \mathbf{U}_{i, t - l})} \end{aligned} \]</span></p>
<p>where <span class="math inline">\(\mathbf{U}_{it'} = (X_{it'}, \mathbf{V}_{it'}^T)^T\)</span>. Given this model, the estimated propensity score for all treated and matched control units is then computed. This enables the adjustment for lagged covariates via matching on the calculated propensity score, resulting in the following distance measure:</p>
<p><span class="math display">\[ S_{it} (i') = | \text{logit} \{ \hat{e}_{it} (\{ \mathbf{U}_{i, t - l}\}^L_{l = 1})\} - \text{logit} \{ \hat{e}_{i't}( \{ \mathbf{U}_{i', t - l} \}^L_{l = 1})\} | \]</span></p>
<p>Here, <span class="math inline">\(\hat{e}_{i't} (\{ \mathbf{U}_{i, t - l}\}^L_{l = 1})\)</span> represents the estimated propensity score for each matched control unit <span class="math inline">\(i' \in \mathcal{M}_{it}\)</span>.</p>
<p>Once the distance measure <span class="math inline">\(S_{it} (i')\)</span> has been determined for all control units in the original matched set, we fine-tune this set by selecting up to <span class="math inline">\(J\)</span> closest control units, which meet a researcher-defined caliper constraint <span class="math inline">\(C\)</span>. All other control units receive zero weight. This results in a refined matched set for each treated unit <span class="math inline">\((i, t)\)</span>:</p>
<p><span class="math display">\[ \mathcal{M}_{it}^* = \{i' : i' \in \mathcal{M}_{it}, S_{it} (i') &lt; C, S_{it} \le S_{it}^{(J)}\} \]</span></p>
<p><span class="math inline">\(S_{it}^{(J)}\)</span> is the <span class="math inline">\(J\)</span>th smallest distance among the control units in the original set <span class="math inline">\(\mathcal{M}_{it}\)</span>.</p>
<p>For further refinement using weighting, a weight is assigned to each control unit <span class="math inline">\(i'\)</span> in a matched set corresponding to a treated unit <span class="math inline">\((i, t)\)</span>, with greater weight accorded to more similar units. We utilize inverse propensity score weighting, based on the propensity score model mentioned earlier:</p>
<p><span class="math display">\[ w_{it}^{i'} \propto \frac{\hat{e}_{i't} (\{ \mathbf{U}_{i, t-l} \}^L_{l = 1} )}{1 - \hat{e}_{i't} (\{ \mathbf{U}_{i, t-l} \}^L_{l = 1} )} \]</span></p>
<p>In this model, <span class="math inline">\(\sum_{i' \in \mathcal{M}_{it}} w_{it}^{i'} = 1\)</span> and <span class="math inline">\(w_{it}^{i'} = 0\)</span> for <span class="math inline">\(i' \notin \mathcal{M}_{it}\)</span>. The model is fitted to the complete sample of treated and matched control units.</p>
</blockquote>
<blockquote>
<p>Checking Covariate Balance A distinct advantage of the proposed methodology over regression methods is the ability it offers researchers to inspect the covariate balance between treated and matched control observations. This facilitates the evaluation of whether treated and matched control observations are comparable regarding observed confounders. To investigate the mean difference of each covariate (e.g., <span class="math inline">\(V_{it'j}\)</span>, representing the <span class="math inline">\(j\)</span>-th variable in <span class="math inline">\(\mathbf{V}_{it'}\)</span>) between the treated observation and its matched control observation at each pre-treatment time period (i.e., <span class="math inline">\(t' &lt; t\)</span>), we further standardize this difference. For any given pretreatment time period, we adjust by the standard deviation of each covariate across all treated observations in the dataset. Thus, the mean difference is quantified in terms of standard deviation units. Formally, for each treated observation <span class="math inline">\((i,t)\)</span> where <span class="math inline">\(D_{it} = 1\)</span>, we define the covariate balance for variable <span class="math inline">\(j\)</span> at the pretreatment time period <span class="math inline">\(t - l\)</span> as: <span class="math display">\[\begin{equation}
B_{it}(j, l) = \frac{V_{i, t- l,j}- \sum_{i' \in \mathcal{M}_{it}}w_{it}^{i'}V_{i', t-l,j}}{\sqrt{\frac{1}{N_1 - 1} \sum_{i'=1}^N \sum_{t' = L+1}^{T-F}D_{i't'}(V_{i', t'-l, j} - \bar{V}_{t' - l, j})^2}}
\label{eq:covbalance}
\end{equation}\]</span> where <span class="math inline">\(N_1 = \sum_{i'= 1}^N \sum_{t' = L+1}^{T-F} D_{i't'}\)</span> denotes the total number of treated observations and <span class="math inline">\(\bar{V}_{t-l,j} = \sum_{i=1}^N D_{i,t-l,j}/N\)</span>. We then aggregate this covariate balance measure across all treated observations for each covariate and pre-treatment time period:</p>
</blockquote>
<span class="math display">\[\begin{equation}
\bar{B}(j, l) = \frac{1}{N_1} \sum_{i=1}^N \sum_{t = L+ 1}^{T-F}D_{it} B_{it}(j,l)
\label{eq:aggbalance}
\end{equation}\]</span>
<blockquote>
<p>Lastly, we evaluate the balance of lagged outcome variables over several pre-treatment periods and that of time-varying covariates. This examination aids in assessing the validity of the parallel trend assumption integral to the DiD estimator justification.</p>
</blockquote>
<p>In Figure for balance scatter, we demonstrate the enhancement of covariate balance thank to the refinement of matched sets. Each scatter plot contrasts the absolute standardized mean difference, as detailed in Equation @ref(eq: ), before (horizontal axis) and after (vertical axis) this refinement. Points below the 45-degree line indicate an improved standardized mean balance for certain time-varying covariates post-refinement. The majority of variables benefit from this refinement process. Notably, the propensity score weighting (bottom panel) shows the most significant improvement, whereas Mahalanobis matching (top panel) yields a more modest improvement.</p>
<div class="sourceCode" id="cb795"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">PanelMatch</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">causalverse</span><span class="op">)</span></span>
<span></span>
<span><span class="va">runPanelMatch</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">method</span>, <span class="va">lag</span>, <span class="va">size.match</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">qoi</span><span class="op">=</span><span class="st">"att"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># Default parameters for PanelMatch</span></span>
<span>    <span class="va">common.args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="va">lag</span>,</span>
<span>        panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>        covs.formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">tradewb</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        qoi <span class="op">=</span> <span class="va">qoi</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        size.match <span class="op">=</span> <span class="va">size.match</span>  <span class="co"># setting size.match here for all methods</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"mahalanobis"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">refinement.method</span> <span class="op">&lt;-</span> <span class="st">"mahalanobis"</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">match.missing</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">use.diagonal.variance.matrix</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"ps.match"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">refinement.method</span> <span class="op">&lt;-</span> <span class="st">"ps.match"</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">match.missing</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">listwise.delete</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"ps.weight"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">refinement.method</span> <span class="op">&lt;-</span> <span class="st">"ps.weight"</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">match.missing</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">listwise.delete</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/do.call.html">do.call</a></span><span class="op">(</span><span class="va">PanelMatch</span>, <span class="va">common.args</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mahalanobis"</span>, <span class="st">"ps.match"</span>, <span class="st">"ps.weight"</span><span class="op">)</span></span>
<span><span class="va">lags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>You can either do it sequentially</p>
<div class="sourceCode" id="cb796"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_pm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">method</span> <span class="kw">in</span> <span class="va">methods</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">lag</span> <span class="kw">in</span> <span class="va">lags</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">for</span><span class="op">(</span><span class="va">size</span> <span class="kw">in</span> <span class="va">sizes</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">method</span>, <span class="st">"."</span>, <span class="va">lag</span>, <span class="st">"lag."</span>, <span class="va">size</span>, <span class="st">"m"</span><span class="op">)</span></span>
<span>            <span class="va">res_pm</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">runPanelMatch</span><span class="op">(</span><span class="va">method</span>, <span class="va">lag</span>, <span class="va">size</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Now, you can access res_pm using res_pm[["mahalanobis.1lag.5m"]] etc.</span></span>
<span></span>
<span><span class="co"># for treatment reversal</span></span>
<span><span class="va">res_pm_rev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">method</span> <span class="kw">in</span> <span class="va">methods</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">lag</span> <span class="kw">in</span> <span class="va">lags</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">for</span><span class="op">(</span><span class="va">size</span> <span class="kw">in</span> <span class="va">sizes</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">method</span>, <span class="st">"."</span>, <span class="va">lag</span>, <span class="st">"lag."</span>, <span class="va">size</span>, <span class="st">"m"</span><span class="op">)</span></span>
<span>            <span class="va">res_pm_rev</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">runPanelMatch</span><span class="op">(</span><span class="va">method</span>, <span class="va">lag</span>, <span class="va">size</span>, qoi <span class="op">=</span> <span class="st">"art"</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>or in parallel</p>
<div class="sourceCode" id="cb797"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach">foreach</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel">doParallel</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co"># Initialize an empty list to store results</span></span>
<span><span class="va">res_pm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Replace nested for-loops with foreach</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="va">methods</span>,</span>
<span>    .combine <span class="op">=</span> <span class="st">'c'</span>,</span>
<span>    .multicombine <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PanelMatch"</span>, <span class="st">"causalverse"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span></span>
<span>    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">lag</span> <span class="kw">in</span> <span class="va">lags</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">size</span> <span class="kw">in</span> <span class="va">sizes</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">method</span>, <span class="st">"."</span>, <span class="va">lag</span>, <span class="st">"lag."</span>, <span class="va">size</span>, <span class="st">"m"</span><span class="op">)</span></span>
<span>        <span class="va">tmp</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">runPanelMatch</span><span class="op">(</span><span class="va">method</span>, <span class="va">lag</span>, <span class="va">size</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">tmp</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="co"># Collate results</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">name</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res_pm</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Treatment reversal</span></span>
<span><span class="co"># Initialize an empty list to store results</span></span>
<span><span class="va">res_pm_rev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Replace nested for-loops with foreach</span></span>
<span><span class="va">results_rev</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="va">methods</span>,</span>
<span>    .combine <span class="op">=</span> <span class="st">'c'</span>,</span>
<span>    .multicombine <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PanelMatch"</span>, <span class="st">"causalverse"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span></span>
<span>    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">lag</span> <span class="kw">in</span> <span class="va">lags</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">size</span> <span class="kw">in</span> <span class="va">sizes</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">method</span>, <span class="st">"."</span>, <span class="va">lag</span>, <span class="st">"lag."</span>, <span class="va">size</span>, <span class="st">"m"</span><span class="op">)</span></span>
<span>        <span class="va">tmp</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>          <span class="fu">runPanelMatch</span><span class="op">(</span><span class="va">method</span>, <span class="va">lag</span>, <span class="va">size</span>, qoi <span class="op">=</span> <span class="st">"art"</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">tmp</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="co"># Collate results</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">name</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">results_rev</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res_pm_rev</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">results_rev</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">stopImplicitCluster</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb798"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Updated plotting function</span></span>
<span><span class="va">create_balance_plot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">method</span>, <span class="va">lag</span>, <span class="va">sizes</span>, <span class="va">res_pm</span>, <span class="va">dem</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">matched_set_lists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html">lapply</a></span><span class="op">(</span><span class="va">sizes</span>, <span class="kw">function</span><span class="op">(</span><span class="va">size</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">res_pm</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">method</span>, <span class="st">"."</span>, <span class="va">lag</span>, <span class="st">"lag."</span>, <span class="va">size</span>, <span class="st">"m"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">att</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/balance_scatter_custom.html">balance_scatter_custom</a></span><span class="op">(</span></span>
<span>            matched_set_list <span class="op">=</span> <span class="va">matched_set_lists</span>,</span>
<span>            legend.title <span class="op">=</span> <span class="st">"Possible Matches"</span>,</span>
<span>            set.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">sizes</span><span class="op">)</span>,</span>
<span>            legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.8</span><span class="op">)</span>,</span>
<span>            </span>
<span>            <span class="co"># for compiled plot, you don't need x,y, or main labs</span></span>
<span>            x.axis.label <span class="op">=</span> <span class="st">""</span>,</span>
<span>            y.axis.label <span class="op">=</span> <span class="st">""</span>,</span>
<span>            main <span class="op">=</span> <span class="st">""</span>,</span>
<span>            data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>            dot.size <span class="op">=</span> <span class="fl">5</span>,</span>
<span>            <span class="co"># show.legend = F,</span></span>
<span>            them_use <span class="op">=</span> <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">32</span><span class="op">)</span>,</span>
<span>            covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="st">"tradewb"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">method</span> <span class="kw">in</span> <span class="va">methods</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">lag</span> <span class="kw">in</span> <span class="va">lags</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">plots</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">method</span>, <span class="st">"."</span>, <span class="va">lag</span>, <span class="st">"lag"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>            <span class="fu">create_balance_plot</span><span class="op">(</span><span class="va">method</span>, <span class="va">lag</span>, <span class="va">sizes</span>, <span class="va">res_pm</span>, <span class="va">dem</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># # Arranging plots in a 3x2 grid</span></span>
<span><span class="co"># grid.arrange(plots[["mahalanobis.1lag"]],</span></span>
<span><span class="co">#              plots[["mahalanobis.4lag"]],</span></span>
<span><span class="co">#              plots[["ps.match.1lag"]],</span></span>
<span><span class="co">#              plots[["ps.match.4lag"]],</span></span>
<span><span class="co">#              plots[["ps.weight.1lag"]],</span></span>
<span><span class="co">#              plots[["ps.weight.4lag"]],</span></span>
<span><span class="co">#              ncol=2, nrow=3)</span></span>
<span></span>
<span></span>
<span><span class="co"># Standardized Mean Difference of Covariates</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create column and row labels using textGrob</span></span>
<span><span class="va">col_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1-year Lag"</span>, <span class="st">"4-year Lag"</span><span class="op">)</span></span>
<span><span class="va">row_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Maha Matching"</span>, <span class="st">"PS Matching"</span>, <span class="st">"PS Weigthing"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">major.axes.fontsize</span> <span class="op">=</span> <span class="fl">40</span></span>
<span><span class="va">minor.axes.fontsize</span> <span class="op">=</span> <span class="fl">30</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/png.html">png</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"images"</span>, <span class="st">"did_balance_scatter.png"</span><span class="op">)</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">1200</span>,</span>
<span>    height <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a list-of-lists, where each inner list represents a row</span></span>
<span><span class="va">grid_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.null.html">nullGrob</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span></span>
<span>        <span class="va">row_labels</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>        gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span>,</span>
<span>        rot <span class="op">=</span> <span class="fl">90</span></span>
<span>    <span class="op">)</span>, <span class="va">plots</span><span class="op">[[</span><span class="st">"mahalanobis.1lag"</span><span class="op">]</span><span class="op">]</span>, <span class="va">plots</span><span class="op">[[</span><span class="st">"mahalanobis.4lag"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span></span>
<span>        <span class="va">row_labels</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>        gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span>,</span>
<span>        rot <span class="op">=</span> <span class="fl">90</span></span>
<span>    <span class="op">)</span>, <span class="va">plots</span><span class="op">[[</span><span class="st">"ps.match.1lag"</span><span class="op">]</span><span class="op">]</span>, <span class="va">plots</span><span class="op">[[</span><span class="st">"ps.match.4lag"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span></span>
<span>        <span class="va">row_labels</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>        gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span>,</span>
<span>        rot <span class="op">=</span> <span class="fl">90</span></span>
<span>    <span class="op">)</span>, <span class="va">plots</span><span class="op">[[</span><span class="st">"ps.weight.1lag"</span><span class="op">]</span><span class="op">]</span>, <span class="va">plots</span><span class="op">[[</span><span class="st">"ps.weight.4lag"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># "Flatten" the list-of-lists into a single list of grobs</span></span>
<span><span class="va">grobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/do.call.html">do.call</a></span><span class="op">(</span><span class="va">c</span>, <span class="va">grid_list</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span></span>
<span>    grobs <span class="op">=</span> <span class="va">grobs</span>,</span>
<span>    ncol <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    nrow <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.42</span>, <span class="fl">0.42</span><span class="op">)</span>,</span>
<span>    heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.28</span>, <span class="fl">0.28</span>, <span class="fl">0.28</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span></span>
<span>    <span class="st">"Before Refinement"</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    y <span class="op">=</span> <span class="fl">0.03</span>,</span>
<span>    gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">major.axes.fontsize</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span></span>
<span>    <span class="st">"After Refinement"</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">0.03</span>,</span>
<span>    y <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    rot <span class="op">=</span> <span class="fl">90</span>,</span>
<span>    gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">major.axes.fontsize</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Note: Scatter plots display the standardized mean difference of each covariate <span class="math inline">\(j\)</span> and lag year <span class="math inline">\(l\)</span> as defined in Equation <a href="#eq:aggbalance">(<strong>??</strong>)</a> before (x-axis) and after (y-axis) matched set refinement. Each plot includes varying numbers of possible matches for each matching method. Rows represent different matching/weighting methods, while columns indicate adjustments for various lag lengths.</p>
<div class="sourceCode" id="cb799"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Step 1: Define configurations</span></span>
<span><span class="va">configurations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"none"</span>, qoi <span class="op">=</span> <span class="st">"att"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"none"</span>, qoi <span class="op">=</span> <span class="st">"art"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"mahalanobis"</span>, qoi <span class="op">=</span> <span class="st">"att"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"mahalanobis"</span>, qoi <span class="op">=</span> <span class="st">"art"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"ps.match"</span>, qoi <span class="op">=</span> <span class="st">"att"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"ps.match"</span>, qoi <span class="op">=</span> <span class="st">"art"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"ps.weight"</span>, qoi <span class="op">=</span> <span class="st">"att"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"ps.weight"</span>, qoi <span class="op">=</span> <span class="st">"art"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 2: Use lapply or loop to generate results</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html">lapply</a></span><span class="op">(</span><span class="va">configurations</span>, <span class="kw">function</span><span class="op">(</span><span class="va">config</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag                       <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>        match.missing             <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        listwise.delete           <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        size.match                <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        lead                      <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        refinement.method         <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">refinement.method</span>,</span>
<span>        covs.formula              <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">tradewb</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        qoi                       <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">qoi</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 3: Get covariate balance and plot</span></span>
<span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mapply.html">mapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">result</span>, <span class="va">config</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/get_covariate_balance.html">get_covariate_balance</a></span><span class="op">(</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">qoi</span> <span class="op">==</span> <span class="st">"att"</span><span class="op">)</span></span>
<span>            <span class="va">result</span><span class="op">$</span><span class="va">att</span></span>
<span>        <span class="kw">else</span></span>
<span>            <span class="va">result</span><span class="op">$</span><span class="va">art</span>,</span>
<span>        panel.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelData.html">PanelData</a></span><span class="op">(</span>panel.data <span class="op">=</span> <span class="va">dem</span>, </span>
<span>              unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>, </span>
<span>              time.id <span class="op">=</span> <span class="st">"year"</span>, </span>
<span>              treatment <span class="op">=</span> <span class="st">"dem"</span>, </span>
<span>              outcome <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span>
<span>        covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tradewb"</span>, <span class="st">"y"</span><span class="op">)</span>,</span>
<span>        plot <span class="op">=</span> <span class="cn">F</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/plot_covariate_balance_pretrend.html">plot_covariate_balance_pretrend</a></span><span class="op">(</span><span class="va">df</span>, main <span class="op">=</span> <span class="st">""</span>, show_legend <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="op">}</span>, <span class="va">results</span>, <span class="va">configurations</span>, SIMPLIFY <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set names for plots</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">plots</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html">sapply</a></span><span class="op">(</span><span class="va">configurations</span>, <span class="kw">function</span><span class="op">(</span><span class="va">config</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html">paste</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">qoi</span>, <span class="va">config</span><span class="op">$</span><span class="va">refinement.method</span>, sep <span class="op">=</span> <span class="st">"."</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>To export</p>
<div class="sourceCode" id="cb800"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Column and row labels</span></span>
<span><span class="va">col_labels</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>,</span>
<span>      <span class="st">"Mahalanobis"</span>,</span>
<span>      <span class="st">"Propensity Score Matching"</span>,</span>
<span>      <span class="st">"Propensity Score Weighting"</span><span class="op">)</span></span>
<span><span class="va">row_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ATT"</span>, <span class="st">"ART"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify your desired fontsize for labels</span></span>
<span><span class="va">minor.axes.fontsize</span> <span class="op">&lt;-</span> <span class="fl">16</span></span>
<span><span class="va">major.axes.fontsize</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/png.html">png</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"images"</span>, <span class="st">"p_covariate_balance.png"</span><span class="op">)</span>, width<span class="op">=</span><span class="fl">1200</span>, height<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a list-of-lists, where each inner list represents a row</span></span>
<span><span class="va">grid_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.null.html">nullGrob</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span></span>
<span>            <span class="va">row_labels</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>            gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span>,</span>
<span>            rot <span class="op">=</span> <span class="fl">90</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">att.none</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">att.mahalanobis</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">att.ps.match</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">att.ps.weight</span></span>
<span>    <span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span></span>
<span>            <span class="va">row_labels</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>            gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span>,</span>
<span>            rot <span class="op">=</span> <span class="fl">90</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">art.none</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">art.mahalanobis</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">art.ps.match</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">art.ps.weight</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># "Flatten" the list-of-lists into a single list of grobs</span></span>
<span><span class="va">grobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/do.call.html">do.call</a></span><span class="op">(</span><span class="va">c</span>, <span class="va">grid_list</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Arrange your plots with text labels</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span></span>
<span>    grobs   <span class="op">=</span> <span class="va">grobs</span>,</span>
<span>    ncol    <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    nrow    <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    widths  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.225</span>, <span class="fl">0.225</span>, <span class="fl">0.225</span>, <span class="fl">0.225</span><span class="op">)</span>,</span>
<span>    heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.45</span>, <span class="fl">0.45</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add main x and y axis titles</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span></span>
<span>    <span class="st">"Refinement Methods"</span>,</span>
<span>    x  <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    y  <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>    gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">major.axes.fontsize</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span></span>
<span>    <span class="st">"Quantities of Interest"</span>,</span>
<span>    x   <span class="op">=</span> <span class="fl">0.02</span>,</span>
<span>    y   <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    rot <span class="op">=</span> <span class="fl">90</span>,</span>
<span>    gp  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">major.axes.fontsize</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb801"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html">include_graphics</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"images"</span>, <span class="st">"p_covariate_balance.png"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Note: Each graph displays the standardized mean difference, as outlined in Equation <a href="#eq:aggbalance">(<strong>??</strong>)</a>, plotted on the vertical axis across a pre-treatment duration of four years represented on the horizontal axis. The leftmost column illustrates the balance prior to refinement, while the subsequent three columns depict the covariate balance post the application of distinct refinement techniques. Each individual line signifies the balance of a specific variable during the pre-treatment phase.The red line is tradewb and blue line is the lagged outcome variable.</p>
<p>In Figure <a href="#fig:balancepretreat"><strong>??</strong></a>, we observe a marked improvement in covariate balance due to the implemented matching procedures during the pre-treatment period. Our analysis prioritizes methods that adjust for time-varying covariates over a span of four years preceding the treatment initiation. The two rows delineate the standardized mean balance for both treatment modalities, with individual lines representing the balance for each covariate.</p>
<p>Across all scenarios, the refinement attributed to matched sets significantly enhances balance. Notably, using propensity score weighting considerably mitigates imbalances in confounders. While some degree of imbalance remains evident in the Mahalanobis distance and propensity score matching techniques, the standardized mean difference for the lagged outcome remains stable throughout the pre-treatment phase. This consistency lends credence to the validity of the proposed DiD estimator.</p>
<p><strong>Estimation Results</strong></p>
<p>We now detail the estimated ATTs derived from the matching techniques. Figure below offers visual representations of the impacts of treatment initiation (upper panel) and treatment reversal (lower panel) on the outcome variable for a duration of 5 years post-transition, specifically, (<span class="math inline">\(F = 0, 1, …, 4\)</span>). Across the five methods (columns), it becomes evident that the point estimates of effects associated with treatment initiation consistently approximate zero over the 5-year window. In contrast, the estimated outcomes of treatment reversal are notably negative and maintain statistical significance through all refinement techniques during the initial year of transition and the 1 to 4 years that follow, provided treatment reversal is permissible. These effects are notably pronounced, pointing to an estimated reduction of roughly X% in the outcome variable.</p>
<p>Collectively, these findings indicate that the transition into the treated state from its absence doesn’t invariably lead to a heightened outcome. Instead, the transition from the treated state back to its absence exerts a considerable negative effect on the outcome variable in both the short and intermediate terms. Hence, the positive effect of the treatment (if we were to use traditional DiD) is actually driven by the negative effect of treatment reversal.</p>
<div class="sourceCode" id="cb802"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># sequential</span></span>
<span><span class="co"># Step 1: Apply PanelEstimate function</span></span>
<span></span>
<span><span class="co"># Initialize an empty list to store results</span></span>
<span><span class="va">res_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_pm</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Iterate over each element in res_pm</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_pm</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res_est</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelEstimate.html">PanelEstimate</a></span><span class="op">(</span></span>
<span>    <span class="va">res_pm</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    se.method <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>    number.iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    confidence.level <span class="op">=</span> <span class="fl">.95</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># Transfer the name of the current element to the res_est list</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_pm</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Step 2: Apply plot_PanelEstimate function</span></span>
<span></span>
<span><span class="co"># Initialize an empty list to store plot results</span></span>
<span><span class="va">res_est_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Iterate over each element in res_est</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">res_est_plot</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/plot_PanelEstimate.html">plot_PanelEstimate</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                           main <span class="op">=</span> <span class="st">""</span>,</span>
<span>                           theme_use <span class="op">=</span> <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co"># Transfer the name of the current element to the res_est_plot list</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_plot</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># check results</span></span>
<span><span class="co"># res_est_plot$mahalanobis.1lag.5m</span></span>
<span></span>
<span></span>
<span><span class="co"># Step 1: Apply PanelEstimate function for res_pm_rev</span></span>
<span></span>
<span><span class="co"># Initialize an empty list to store results</span></span>
<span><span class="va">res_est_rev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_pm_rev</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Iterate over each element in res_pm_rev</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_pm_rev</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res_est_rev</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelEstimate.html">PanelEstimate</a></span><span class="op">(</span></span>
<span>    <span class="va">res_pm_rev</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    se.method <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>    number.iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    confidence.level <span class="op">=</span> <span class="fl">.95</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># Transfer the name of the current element to the res_est_rev list</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_pm_rev</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Step 2: Apply plot_PanelEstimate function for res_est_rev</span></span>
<span></span>
<span><span class="co"># Initialize an empty list to store plot results</span></span>
<span><span class="va">res_est_plot_rev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Iterate over each element in res_est_rev</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">res_est_plot_rev</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/plot_PanelEstimate.html">plot_PanelEstimate</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                           main <span class="op">=</span> <span class="st">""</span>,</span>
<span>                           theme_use <span class="op">=</span> <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Transfer the name of the current element to the res_est_plot_rev list</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_plot_rev</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb803"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># parallel</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel">doParallel</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach">foreach</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Detect the number of cores to use for parallel processing</span></span>
<span><span class="va">num_cores</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span></span>
<span><span class="co"># Register the parallel backend</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span><span class="op">(</span><span class="va">num_cores</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 1: Apply PanelEstimate function in parallel</span></span>
<span><span class="va">res_est</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_pm</span><span class="op">)</span>, .packages <span class="op">=</span> <span class="st">"PanelMatch"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelEstimate.html">PanelEstimate</a></span><span class="op">(</span></span>
<span>            <span class="va">res_pm</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>            data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>            se.method <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>            number.iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>            confidence.level <span class="op">=</span> <span class="fl">.95</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span><span class="co"># Transfer names from res_pm to res_est</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_pm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 2: Apply plot_PanelEstimate function in parallel</span></span>
<span><span class="va">res_est_plot</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span></span>
<span>        i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">)</span>,</span>
<span>        .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PanelMatch"</span>, <span class="st">"causalverse"</span>, <span class="st">"ggplot2"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/plot_PanelEstimate.html">plot_PanelEstimate</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                           main <span class="op">=</span> <span class="st">""</span>,</span>
<span>                           theme_use <span class="op">=</span> <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span><span class="co"># Transfer names from res_est to res_est_plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_plot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># Step 1: Apply PanelEstimate function for res_pm_rev in parallel</span></span>
<span><span class="va">res_est_rev</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_pm_rev</span><span class="op">)</span>, .packages <span class="op">=</span> <span class="st">"PanelMatch"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelEstimate.html">PanelEstimate</a></span><span class="op">(</span></span>
<span>            <span class="va">res_pm_rev</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>            data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>            se.method <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>            number.iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>            confidence.level <span class="op">=</span> <span class="fl">.95</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span><span class="co"># Transfer names from res_pm_rev to res_est_rev</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_pm_rev</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 2: Apply plot_PanelEstimate function for res_est_rev in parallel</span></span>
<span><span class="va">res_est_plot_rev</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span></span>
<span>        i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">)</span>,</span>
<span>        .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PanelMatch"</span>, <span class="st">"causalverse"</span>, <span class="st">"ggplot2"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/plot_PanelEstimate.html">plot_PanelEstimate</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                           main <span class="op">=</span> <span class="st">""</span>,</span>
<span>                           theme_use <span class="op">=</span> <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span><span class="co"># Transfer names from res_est_rev to res_est_plot_rev</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_plot_rev</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Stop the cluster</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>To export</p>
<div class="sourceCode" id="cb804"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Column and row labels</span></span>
<span><span class="va">col_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Mahalanobis 5m"</span>, </span>
<span>                <span class="st">"Mahalanobis 10m"</span>, </span>
<span>                <span class="st">"PS Matching 5m"</span>, </span>
<span>                <span class="st">"PS Matching 10m"</span>, </span>
<span>                <span class="st">"PS Weighting 5m"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">row_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ATT"</span>, <span class="st">"ART"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify your desired fontsize for labels</span></span>
<span><span class="va">minor.axes.fontsize</span> <span class="op">&lt;-</span> <span class="fl">16</span></span>
<span><span class="va">major.axes.fontsize</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/png.html">png</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"images"</span>, <span class="st">"p_did_est_in_n_out.png"</span><span class="op">)</span>, width<span class="op">=</span><span class="fl">1200</span>, height<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a list-of-lists, where each inner list represents a row</span></span>
<span><span class="va">grid_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.null.html">nullGrob</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">row_labels</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span>, rot <span class="op">=</span> <span class="fl">90</span><span class="op">)</span>,</span>
<span>    <span class="va">res_est_plot</span><span class="op">$</span><span class="va">mahalanobis.1lag.5m</span>,</span>
<span>    <span class="va">res_est_plot</span><span class="op">$</span><span class="va">mahalanobis.1lag.10m</span>,</span>
<span>    <span class="va">res_est_plot</span><span class="op">$</span><span class="va">ps.match.1lag.5m</span>,</span>
<span>    <span class="va">res_est_plot</span><span class="op">$</span><span class="va">ps.match.1lag.10m</span>,</span>
<span>    <span class="va">res_est_plot</span><span class="op">$</span><span class="va">ps.weight.1lag.5m</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">row_labels</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span>, rot <span class="op">=</span> <span class="fl">90</span><span class="op">)</span>,</span>
<span>    <span class="va">res_est_plot_rev</span><span class="op">$</span><span class="va">mahalanobis.1lag.5m</span>,</span>
<span>    <span class="va">res_est_plot_rev</span><span class="op">$</span><span class="va">mahalanobis.1lag.10m</span>,</span>
<span>    <span class="va">res_est_plot_rev</span><span class="op">$</span><span class="va">ps.match.1lag.5m</span>,</span>
<span>    <span class="va">res_est_plot_rev</span><span class="op">$</span><span class="va">ps.match.1lag.10m</span>,</span>
<span>    <span class="va">res_est_plot_rev</span><span class="op">$</span><span class="va">ps.weight.1lag.5m</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># "Flatten" the list-of-lists into a single list of grobs</span></span>
<span><span class="va">grobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/do.call.html">do.call</a></span><span class="op">(</span><span class="va">c</span>, <span class="va">grid_list</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Arrange your plots with text labels</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span></span>
<span>  grobs   <span class="op">=</span> <span class="va">grobs</span>,</span>
<span>  ncol    <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  nrow    <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  widths  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.18</span>, <span class="fl">0.18</span>, <span class="fl">0.18</span>, <span class="fl">0.18</span>, <span class="fl">0.18</span><span class="op">)</span>,</span>
<span>  heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.45</span>, <span class="fl">0.45</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add main x and y axis titles</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span></span>
<span>  <span class="st">"Methods"</span>,</span>
<span>  x  <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  y  <span class="op">=</span> <span class="fl">0.02</span>,</span>
<span>  gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">major.axes.fontsize</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span></span>
<span>  <span class="st">""</span>,</span>
<span>  x   <span class="op">=</span> <span class="fl">0.02</span>,</span>
<span>  y   <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  rot <span class="op">=</span> <span class="fl">90</span>,</span>
<span>  gp  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">major.axes.fontsize</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb805"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html">include_graphics</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"images"</span>, <span class="st">"p_did_est_in_n_out.png"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
</div>
<div id="counterfactual-estimators" class="section level3" number="30.8.5">
<h3>
<span class="header-section-number">30.8.5</span> Counterfactual Estimators<a class="anchor" aria-label="anchor" href="#counterfactual-estimators"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Also known as <strong>imputation approach</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-liu2024practical">Liu, Wang, and Xu 2024</a>)</span>
</li>
<li>This class of estimator consider observation treatment as missing data. Models are built using data from the control units to impute conterfactuals for the treated observations.</li>
<li>It’s called counterfactual estimators because they predict outcomes as if the treated observations had not received the treatment.</li>
<li>Advantages:
<ul>
<li>Avoids negative weights and biases by not using treated observations for modeling and applying uniform weights.</li>
<li>Supports various models, including those that may relax strict exogeneity assumptions.</li>
</ul>
</li>
<li>Methods including
<ul>
<li>Fixed-effects conterfactual estimator (FEct) (DiD is a special case):
<ul>
<li>Based on the [Two-way Fixed-effects], where assumes linear additive functional form of unobservables based on unit and time FEs. But FEct fixes the improper weighting of TWFE by comparing within each matched pair (where each pair is the treated observation and its predicted counterfactual that is the weighted sum of all untreated observations).</li>
</ul>
</li>
<li>Interactive Fixed Effects conterfactual estimator (IFEct) <span class="citation">Xu (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-xu2017generalized">2017</a>)</span>:
<ul>
<li>When we suspect unobserved time-varying confounder, FEct fails. Instead, IFEct uses the factor-augmented models to relax the strict exogeneity assumption where the effects of unobservables can be decomposed to unit FE + time FE + unit x time FE.</li>
<li>Generalized Synthetic Controls are a subset of IFEct when treatments don’t revert.</li>
</ul>
</li>
<li>
<a href="sec-difference-in-differences.html#sec-matrix-completion-estimator">Matrix Completion Estimator</a> (MC) <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-athey2021matrix">Athey et al. 2021</a>)</span>:
<ul>
<li>Generalization of factor-augmented models. Different from IFEct which uses hard impute, MC uses soft impute to regularize the singular values when decomposing the residual matrix.</li>
<li>Only when latent factors (of unobservables) are strong and sparse, IFEct outperforms MC.</li>
</ul>
</li>
<li>
<a href="sec-synthetic-control.html#sec-synthetic-control">Synthetic Control</a> (case studies)</li>
</ul>
</li>
</ul>
<p><strong>Identifying Assumptions</strong>:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Function Form</strong>: Additive separability of observables, unobservables, and idiosyncratic error term.
<ul>
<li>Hence, these models are scale dependent <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-athey2006identification">Athey and Imbens 2006</a>)</span> (e.g., log-transform outcome can invadiate this assumption).</li>
</ul>
</li>
<li>
<strong>Strict Exogeneity</strong>: Conditional on observables and unobservables, potential outcomes are independent of treatment assignment (i.e., baseline quasi-randomization)
<ul>
<li>In DiD, where unobservables = unit + time FEs, this assumption is the parallel trends assumption</li>
</ul>
</li>
<li>
<strong>Low-dimensional Decomposition (Feasibility Assumption)</strong>: Unobservable effects can be decomposed in low-dimension.
<ul>
<li>For the case that <span class="math inline">\(U_{it} = f_t \times \lambda_i\)</span> where <span class="math inline">\(f_t\)</span> = common time trend (time FE), and <span class="math inline">\(\lambda_i\)</span> = unit heterogeneity (unit FE). If <span class="math inline">\(U_{it} = f_t \times \lambda_i\)</span> , DiD can satisfy this assumption. But this assumption is weaker than that of DID, and allows us to control for unobservables based on data.</li>
</ul>
</li>
</ol>
<p><strong>Estimation Procedure</strong>:</p>
<ol style="list-style-type: decimal">
<li>Using all control observations, estimate the functions of both observable and unobservable variables (relying on Assumptions 1 and 3).</li>
<li>Predict the counterfactual outcomes for each treated unit using the obtained functions.</li>
<li>Calculate the difference in treatment effect for each treated individual.</li>
<li>By averaging over all treated individuals, you can obtain the Average Treatment Effect on the Treated (ATT).</li>
</ol>
<p>Notes:</p>
<ul>
<li>Use jackknife when number of treated units is small <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-liu2024practical">Liu, Wang, and Xu 2024, 166</a>)</span>.</li>
</ul>
<div id="imputation-method" class="section level5" number="30.8.5.0.1">
<h5>
<span class="header-section-number">30.8.5.0.1</span> Imputation Method<a class="anchor" aria-label="anchor" href="#imputation-method"><i class="fas fa-link"></i></a>
</h5>
<p><span class="citation">Liu, Wang, and Xu (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-liu2024practical">2024</a>)</span> can also account for treatment reversals and heterogeneous treatment effects.</p>
<p>Other imputation estimators include</p>
<ul>
<li><p><span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-gardner2022two">Gardner 2022</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-borusyak2021revisiting">Borusyak, Jaravel, and Spiess 2021</a>)</span></p></li>
<li><p><span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-brown2023simple">N. Brown, Butts, and Westerlund 2023</a>)</span></p></li>
</ul>
<div class="sourceCode" id="cb806"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yiqingxu.org/packages/fect/articles/tutorial.html">fect</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">PanelMatch</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/PanelMatch/man/dem.html">dem</a></span></span>
<span></span>
<span><span class="va">model.fect</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">fect</span><span class="op">(</span></span>
<span>        Y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        D <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        X <span class="op">=</span> <span class="st">"tradewb"</span>,</span>
<span>        data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="fu">PanelMatch</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/PanelMatch/man/dem.html">dem</a></span><span class="op">)</span>,</span>
<span>        method <span class="op">=</span> <span class="st">"fe"</span>,</span>
<span>        index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"wbcode2"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>        se <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        parallel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>        <span class="co"># twfe</span></span>
<span>        force <span class="op">=</span> <span class="st">"two-way"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/print.html">print</a></span><span class="op">(</span><span class="va">model.fect</span><span class="op">$</span><span class="va">est.avg</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">model.fect</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">model.fect</span>, stats <span class="op">=</span> <span class="st">"F.p"</span><span class="op">)</span></span></code></pre></div>
<p>F-test <span class="math inline">\(H_0\)</span>: residual averages in the pre-treatment periods = 0</p>
<p>To see treatment reversal effects</p>
<div class="sourceCode" id="cb807"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">model.fect</span>, stats <span class="op">=</span> <span class="st">"F.p"</span>, type <span class="op">=</span> <span class="st">'exit'</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="placebo-test" class="section level5" number="30.8.5.0.2">
<h5>
<span class="header-section-number">30.8.5.0.2</span> Placebo Test<a class="anchor" aria-label="anchor" href="#placebo-test"><i class="fas fa-link"></i></a>
</h5>
<p>By selecting a part of the data and excluding observations within a specified range to improve the model fitting, we then evaluate whether the estimated Average Treatment Effect (ATT) within this range significantly differs from zero. This approach helps us analyze the periods before treatment.</p>
<p>If this test fails, either the functional form or strict exogeneity assumption is problematic.</p>
<div class="sourceCode" id="cb808"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out.fect.p</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">fect</span><span class="op">(</span></span>
<span>        Y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        D <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        X <span class="op">=</span> <span class="st">"tradewb"</span>,</span>
<span>        data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="fu">PanelMatch</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/PanelMatch/man/dem.html">dem</a></span><span class="op">)</span>,</span>
<span>        method <span class="op">=</span> <span class="st">"fe"</span>,</span>
<span>        index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"wbcode2"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>        se <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        placeboTest <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        <span class="co"># using 3 periods</span></span>
<span>        placebo.period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">out.fect.p</span>, proportion <span class="op">=</span> <span class="fl">0.1</span>, stats <span class="op">=</span> <span class="st">"placebo.p"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="no-carryover-effects-test" class="section level5" number="30.8.5.0.3">
<h5>
<span class="header-section-number">30.8.5.0.3</span> (No) Carryover Effects Test<a class="anchor" aria-label="anchor" href="#no-carryover-effects-test"><i class="fas fa-link"></i></a>
</h5>
<p>The placebo test can be adapted to assess carryover effects by masking several post-treatment periods instead of pre-treatment ones. If no carryover effects are present, the average prediction error should approximate zero. For the carryover test, set <code>carryoverTest = TRUE</code>. Specify a post-treatment period range in carryover.period to exclude observations for model fitting, then evaluate if the estimated ATT significantly deviates from zero.</p>
<p>Even if we have carryover effects, in most cases of the staggered adoption setting, researchers are interested in the cumulative effects, or aggregated treatment effects, so it’s okay.</p>
<div class="sourceCode" id="cb809"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out.fect.c</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">fect</span><span class="op">(</span></span>
<span>        Y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        D <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        X <span class="op">=</span> <span class="st">"tradewb"</span>,</span>
<span>        data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="fu">PanelMatch</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/PanelMatch/man/dem.html">dem</a></span><span class="op">)</span>,</span>
<span>        method <span class="op">=</span> <span class="st">"fe"</span>,</span>
<span>        index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"wbcode2"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>        se <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        carryoverTest <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        <span class="co"># how many periods of carryover</span></span>
<span>        carryover.period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">out.fect.c</span>,  stats <span class="op">=</span> <span class="st">"carryover.p"</span><span class="op">)</span></span></code></pre></div>
<p>We have evidence of carryover effects.</p>
<hr>
</div>
</div>
<div id="sec-matrix-completion-estimator" class="section level3" number="30.8.6">
<h3>
<span class="header-section-number">30.8.6</span> Matrix Completion Estimator<a class="anchor" aria-label="anchor" href="#sec-matrix-completion-estimator"><i class="fas fa-link"></i></a>
</h3>
<p>Matrix completion methods have become increasingly influential in causal inference for panel data, particularly when estimating <a href="sec-causal-inference.html#sec-average-treatment-effect">average treatment effects</a> in business settings such as marketing experiments, customer behavior modeling, and pricing interventions. These settings often feature <a href="sec-difference-in-differences.html#sec-staggered-difference-in-differences">staggered adoption</a>of treatments across units and time, leading to <strong>structured missing data</strong>. <span class="citation">Athey et al. (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-athey2021matrix">2021</a>)</span> develop a matrix completion framework that subsumes methods based on <strong>unconfoundedness</strong> and <a href="sec-synthetic-control.html#sec-synthetic-control"><strong>synthetic controls</strong></a>, by leveraging the low-rank structure of potential outcomes matrices.</p>
<p>An important empirical context is consumer choice data in marketing, where missing outcomes can arise due to <strong>intermittent treatment</strong>, e.g., promotional campaigns delivered at varying times across different stores or consumer segments. One illustrative application is provided by <span class="citation">Bronnenberg, Dubé, and Sanders (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-bronnenberg2020consumer">2020</a>)</span>, who investigates <strong>consumer response to targeted marketing campaigns</strong> using panel data that naturally contains missing counterfactual outcomes for treated units.</p>
<p>Two key literatures have historically addressed the problem of imputing missing potential outcomes:</p>
<ul>
<li>
<strong>Unconfoundedness Framework</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imbens2015causal">G. W. Imbens and Rubin 2015</a>)</span>:
<ul>
<li>Assumes <a href="sec-matching-methods.html#sec-selection-on-observables">selection on observables</a>.</li>
<li>Imputes missing control outcomes by matching or regression using untreated units with similar characteristics or histories.</li>
<li>Assumes time patterns are stable across units.</li>
</ul>
</li>
<li>
<a href="sec-synthetic-control.html#sec-synthetic-control"><strong>Synthetic Control</strong></a> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-abadie2010synthetic">Abadie, Diamond, and Hainmueller 2010</a>)</span>:
<ul>
<li>Constructs counterfactual outcomes as weighted averages of control units.</li>
<li>Assumes unit patterns are stable over time.</li>
<li>Particularly suited for single treated unit settings.</li>
</ul>
</li>
</ul>
<p>These methods can be unified under the matrix completion framework, which interprets the panel of outcomes as a low-rank matrix plus noise, allowing for flexible imputation without strong parametric assumptions.</p>
<p>Contributions of <span class="citation">Athey et al. (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-athey2021matrix">2021</a>)</span></p>
<ol style="list-style-type: decimal">
<li>Accommodates structured missingness, including staggered adoption.</li>
<li>Adjusts for unit (<span class="math inline">\(\mu_i\)</span>) and time (<span class="math inline">\(\lambda_t\)</span>) fixed effects prior to low-rank estimation.</li>
<li>Exhibits strong performance across unbalanced panels with varying dimensions:
<ul>
<li>
<span class="math inline">\(T \gg N\)</span>: Where unconfoundedness struggles.</li>
<li>
<span class="math inline">\(N \gg T\)</span>: Where synthetic control performs poorly.</li>
</ul>
</li>
</ol>
<p><strong>Advantages of Matrix Completion</strong></p>
<ul>
<li>Utilizes all units and periods, even treated ones, to learn latent factors.</li>
<li>Handles complex missingness patterns and autocorrelated errors.</li>
<li>Accommodates covariates and heterogeneous treatment effects.</li>
<li>Can apply weighted loss functions to account for non-random assignment or missingness.</li>
</ul>
<hr>
<div id="matrix-completion-core-assumptions" class="section level4" number="30.8.6.1">
<h4>
<span class="header-section-number">30.8.6.1</span> Matrix Completion Core Assumptions<a class="anchor" aria-label="anchor" href="#matrix-completion-core-assumptions"><i class="fas fa-link"></i></a>
</h4>
<p>The matrix completion approach is built on the assumption that the complete outcome matrix <span class="math inline">\(\mathbf{Y}\)</span> satisfies:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Low-rank structure</strong>: <span class="math display">\[
\mathbf{Y} = \mathbf{U} \mathbf{V}^T + \mathbf{E}
\]</span> where <span class="math inline">\(\mathbf{U} \in \mathbb{R}^{N \times R}\)</span>, <span class="math inline">\(\mathbf{V} \in \mathbb{R}^{T \times R}\)</span>, and <span class="math inline">\(\mathbf{E}\)</span> is a noise matrix.</li>
<li>
<a href="imputation-missing-data.html#missing-completely-at-random-mcar">Missing Completely At Random (MCAR)</a>: The pattern of missing data is independent of unobserved outcomes, conditional on observables.</li>
</ol>
<p>Unlike prior approaches, matrix completion does not impose a specific factorization, but rather regularizes the estimator, e.g., via nuclear norm minimization.</p>
<p>To identify the causal estimand, matrix completion relies on:</p>
<ul>
<li><p><a href="sec-quasi-experimental.html#sec-sutva">SUTVA</a> <strong>(Stable Unit Treatment Value Assumption)</strong>: <span class="math inline">\(Y_{it}(w)\)</span> depends only on <span class="math inline">\(W_{it}\)</span>, not on other units’ treatments.</p></li>
<li><p><strong>No dynamic treatment effects</strong>: The treatment at time <span class="math inline">\(t\)</span> does not influence outcomes in other periods.</p></li>
</ul>
<hr>
</div>
<div id="causal-estimand" class="section level4" number="30.8.6.2">
<h4>
<span class="header-section-number">30.8.6.2</span> Causal Estimand<a class="anchor" aria-label="anchor" href="#causal-estimand"><i class="fas fa-link"></i></a>
</h4>
<p>Let <span class="math inline">\(Y_{it}(0)\)</span> and <span class="math inline">\(Y_{it}(1)\)</span> denote the potential outcomes under control and treatment. We observe treated outcomes, and aim to impute unobserved control outcomes:</p>
<p><span class="math display">\[
\tau = \frac{\sum_{(i,t): W_{it} = 1} \left[ Y_{it}(1) - Y_{it}(0) \right]}{\sum_{i,t} W_{it}}
\]</span></p>
<p>Let <span class="math inline">\(\mathcal{M}\)</span> be the set of indices <span class="math inline">\((i, t)\)</span> where <span class="math inline">\(W_{it} = 1\)</span> (treated, hence <span class="math inline">\(Y_{it}(0)\)</span> is missing), and <span class="math inline">\(\mathcal{O}\)</span> the set where <span class="math inline">\(W_{it} = 0\)</span> (control, hence <span class="math inline">\(Y_{it}(0)\)</span> is observed).</p>
<p>We conceptualize the data as 2 <span class="math inline">\(N \times T\)</span> matrices:</p>
<p><span class="math display">\[
\mathbf{Y} =
\begin{pmatrix}
Y_{11} &amp; Y_{12} &amp; ? &amp; \cdots &amp; Y_{1T} \\
? &amp; ? &amp; Y_{23} &amp; \cdots &amp; ? \\
Y_{31} &amp; ? &amp; Y_{33} &amp; \cdots &amp; ? \\
\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
Y_{N1} &amp; ? &amp; Y_{N3} &amp; \cdots &amp; ?
\end{pmatrix},
\quad
\mathbf{W} =
\begin{pmatrix}
0 &amp; 0 &amp; 1 &amp; \cdots &amp; 0 \\
1 &amp; 1 &amp; 0 &amp; \cdots &amp; 1 \\
0 &amp; 1 &amp; 0 &amp; \cdots &amp; 1 \\
\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
0 &amp; 1 &amp; 0 &amp; \cdots &amp; 1
\end{pmatrix}
\]</span></p>
<p><strong>Matrix Shape</strong></p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="26%">
<col width="25%">
<col width="47%">
</colgroup>
<tbody>
<tr class="odd">
<td>Matrix Shape</td>
<td>Pattern</td>
<td>Literature / Method</td>
</tr>
<tr class="even">
<td>Thin (<span class="math inline">\(N \gg T\)</span>)</td>
<td>Single-treated-period</td>
<td>Horizontal regression (unconfoundedness)</td>
</tr>
<tr class="odd">
<td>Fat (<span class="math inline">\(T \gg N\)</span>)</td>
<td>Single-treated-unit</td>
<td>Vertical regression (synthetic control)</td>
</tr>
<tr class="even">
<td>Square (<span class="math inline">\(N \approx T\)</span>)</td>
<td>Varying patterns</td>
<td>TWFE / Matrix Completion</td>
</tr>
</tbody>
</table></div>
<p><strong>Special Patterns of Missingness</strong></p>
<ul>
<li>
<strong>Block structures</strong>:
<ul>
<li>
<strong>Single-period treatment</strong> (horizontal regression) <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-imbens2015causal">G. W. Imbens and Rubin 2015</a>)</span>
</li>
<li>
<strong>Single-unit treatment</strong> (vertical regression) <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-abadie2010synthetic">Abadie, Diamond, and Hainmueller 2010</a>)</span>
</li>
</ul>
</li>
<li>
<strong>Staggered adoption</strong>: Treatments occur at different times across units, as in many business interventions.</li>
</ul>
<hr>
</div>
<div id="unified-low-rank-model" class="section level4" number="30.8.6.3">
<h4>
<span class="header-section-number">30.8.6.3</span> Unified Low-Rank Model<a class="anchor" aria-label="anchor" href="#unified-low-rank-model"><i class="fas fa-link"></i></a>
</h4>
<p>Matrix completion generalizes these approaches using a low-rank plus noise model:</p>
<p><span class="math display">\[
\mathbf{Y} = \mathbf{U} \mathbf{V}^T + \mathbf{E}
\]</span></p>
<p>where <span class="math inline">\(R = \text{rank}(\mathbf{Y})\)</span> is typically low relative to <span class="math inline">\(N\)</span> and <span class="math inline">\(T\)</span>.</p>
<ul>
<li>
<strong>TWFE</strong> assumes additivity: <span class="math inline">\(\mathbf{Y}_{it} = \mu_i + \lambda_t + \epsilon_{it}\)</span>.</li>
<li>
<strong>Interactive Fixed Effects</strong> use <span class="math inline">\(R\)</span> factors: <span class="math inline">\(\mathbf{Y}_{it} = \sum_{r=1}^R \alpha_{ir} \gamma_{rt} + \epsilon_{it}\)</span>. To estimate the number of factors <span class="math inline">\(R\)</span>, see <span class="citation">Bai and Ng (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-bai2002determining">2002</a>)</span> and <span class="citation">Moon and Weidner (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-moon2015linear">2015</a>)</span>.</li>
<li>
<strong>Matrix Completion</strong> estimates <span class="math inline">\(\mathbf{Y}\)</span> via regularization, avoiding the need to explicitly choose <span class="math inline">\(R\)</span>.</li>
</ul>
<!-- [Specifically](https://bookdown.org/stanfordgsbsilab/ml-ci-tutorial/matrix-completion-methods.html) --><p>In practical settings (e.g., marketing campaigns), it’s beneficial to incorporate unit-level and time-varying covariates:</p>
<p><span class="math display">\[
Y_{it} = L_{it} + \sum_{p=1}^{P} \sum_{q=1}^{Q} X_{ip} H_{pq} Z_{qt} + \mu_i + \lambda_t + V_{it} \beta + \epsilon_{it}
\]</span></p>
<ul>
<li>
<span class="math inline">\(X_{ip}\)</span>: Unit covariates (a matrix of <span class="math inline">\(p\)</span> variables for unit <span class="math inline">\(i\)</span>)</li>
<li>
<span class="math inline">\(Z_{qt}\)</span>: Time covariates (a matrix of <span class="math inline">\(q\)</span> variables for time <span class="math inline">\(t\)</span>)</li>
<li>
<span class="math inline">\(V_{it}\)</span>: Time-varying covariates</li>
<li>
<span class="math inline">\(H\)</span>: Interaction effects. Lasso-type <span class="math inline">\(l_1\)</span> norm (<span class="math inline">\(||H|| = \sum_{p = 1}^p \sum_{q = 1}^Q |H_{pq}|\)</span>) is used to shrink <span class="math inline">\(H \to 0\)</span>.</li>
</ul>
<p>There are several options to regularize <span class="math inline">\(L\)</span>:</p>
<div class="inline-table"><table style="width:99%;" class="table table-sm">
<colgroup>
<col width="13%">
<col width="27%">
<col width="23%">
<col width="35%">
</colgroup>
<tbody>
<tr class="odd">
<td><strong>Regularizer</strong></td>
<td><strong>Penalty</strong></td>
<td><strong>Properties</strong></td>
<td><strong>Feasibility</strong></td>
</tr>
<tr class="even">
<td>
<p>Frobenius Norm</p>
<p>(i.e., Ridge)</p>
</td>
<td><span class="math inline">\(\|\mathbf{L}\|_F^2\)</span></td>
<td>Ridge-type; shrinks towards 0</td>
<td>Not informative</td>
</tr>
<tr class="odd">
<td>
<p>Nuclear Norm</p>
<p>(i.e., Lasso)</p>
</td>
<td><span class="math inline">\(\|\mathbf{L}\|_* = \sum \sigma_r\)</span></td>
<td>Convex relaxation of rank</td>
<td>Yes (via SOFT-IMPUTE <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-mazumder2010spectral">Mazumder, Hastie, and Tibshirani 2010</a>)</span>)</td>
</tr>
<tr class="even">
<td>Rank Constraint</td>
<td><span class="math inline">\(\text{rank}(\mathbf{L}) \le R\)</span></td>
<td>Direct low-rank control</td>
<td>No (NP-hard)</td>
</tr>
</tbody>
</table></div>
<hr>
</div>
</div>
<div id="sec-reshaped-inverse-probability-weighting-twfe-estimator" class="section level3" number="30.8.7">
<h3>
<span class="header-section-number">30.8.7</span> Reshaped Inverse Probability Weighting - TWFE Estimator<a class="anchor" aria-label="anchor" href="#sec-reshaped-inverse-probability-weighting-twfe-estimator"><i class="fas fa-link"></i></a>
</h3>
<p>The <strong>Reshaped Inverse Probability Weighting (RIPW) estimator</strong> extends the classic <strong>TWFE</strong> regression framework to account for arbitrary, time- and unit-varying treatment assignment mechanisms. This approach leverages an explicit model for treatment assignment to achieve <strong>design robustness</strong>, maintaining consistency even when traditional fixed-effects outcome models are misspecified.</p>
<p>The RIPW-TWFE framework is particularly relevant in panel data settings with <strong>general treatment patterns</strong></p>
<ul>
<li><p><strong>staggered adoption</strong></p></li>
<li><p><strong>transient treatments</strong>.</p></li>
</ul>
<hr>
<p>Setting and Notation</p>
<ul>
<li><p>Panel data with <span class="math inline">\(n\)</span> units observed over <span class="math inline">\(T\)</span> time periods.</p></li>
<li>
<p><strong>Potential outcomes</strong>: For each unit <span class="math inline">\(i \in \{1, \dots, n\}\)</span> and time <span class="math inline">\(t \in \{1, \dots, T\}\)</span>:</p>
<p><span class="math display">\[
Y_{it}(1), \quad Y_{it}(0)
\]</span></p>
</li>
<li>
<p><strong>Observed outcomes</strong>:</p>
<p><span class="math display">\[
Y_{it} = W_{it} Y_{it}(1) + (1 - W_{it}) Y_{it}(0)
\]</span></p>
</li>
<li>
<p><strong>Treatment assignment path</strong> for unit <span class="math inline">\(i\)</span>:</p>
<p><span class="math display">\[
\mathbf{W}_i = (W_{i1}, \dots, W_{iT}) \in \{0,1\}^T
\]</span></p>
</li>
<li>
<p><strong>Generalized Propensity Score (GPS)</strong>: For unit <span class="math inline">\(i\)</span>, the probability distribution over treatment paths:</p>
<p><span class="math display">\[
\mathbf{W}_i \sim \pi_i(\cdot)
\]</span></p>
<p>where <span class="math inline">\(\pi_i(w)\)</span> is known or estimated.</p>
</li>
</ul>
<hr>
<p><strong>Assumptions</strong></p>
<ol style="list-style-type: decimal">
<li><p><strong>Binary Treatment</strong>: <span class="math inline">\(W_{it} \in \{0,1\}\)</span> for all <span class="math inline">\(i\)</span> and <span class="math inline">\(t\)</span>.</p></li>
<li><p><strong>No Dynamic Effects</strong>: Current outcomes depend only on current treatment, not past treatments.</p></li>
<li>
<p><strong>Overlap Condition</strong> (Assumption 2.2 from <span class="citation">Arkhangelsky et al. (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-arkhangelsky2024design">2024</a>)</span>):</p>
<p>There exists a subset <span class="math inline">\(S^* \subseteq \{0,1\}^T\)</span>, with <span class="math inline">\(|S^*| \ge 2\)</span> and <span class="math inline">\(S^* \not\subseteq \{0_T, 1_T\}\)</span>, such that:</p>
<p><span class="math display">\[
\pi_i(w) &gt; c &gt; 0, \quad \forall w \in S^*, \forall i \in \{1, \dots, n\}
\]</span></p>
</li>
<li><p><strong>Maximal Correlation Decay</strong> (Assumption 2.1): Dependence between units decays at rate <span class="math inline">\(n^{-q}\)</span> for some <span class="math inline">\(q \in (0,1]\)</span>.</p></li>
<li><p><strong>Bounded Second Moments</strong> (Assumption 2.3): <span class="math inline">\(\sup_{i,t,w} \mathbb{E}[Y_{it}^2(w)] &lt; M &lt; \infty\)</span>.</p></li>
</ol>
<hr>
<p>Key Quantities of Interest</p>
<ul>
<li>
<p><strong>Unit-Time Specific Treatment Effect</strong>:</p>
<p><span class="math display">\[
\tau_{it} = Y_{it}(1) - Y_{it}(0)
\]</span></p>
</li>
<li>
<p><strong>Time-Specific</strong> <a href="sec-causal-inference.html#sec-average-treatment-effect">Average Treatment Effect</a>:</p>
<p><span class="math display">\[
\tau_t = \frac{1}{n} \sum_{i=1}^n \tau_{it}
\]</span></p>
</li>
<li>
<p><strong>Doubly Averaged Treatment Effect (DATE)</strong>:</p>
<p><span class="math display">\[
\tau(\xi) = \sum_{t=1}^T \xi_t \tau_t = \sum_{t=1}^T \xi_t \left( \frac{1}{n} \sum_{i=1}^n \tau_{it} \right)
\]</span></p>
<p>where <span class="math inline">\(\xi = (\xi_1, \dots, \xi_T)\)</span> is a vector of non-negative weights such that <span class="math inline">\(\sum_{t=1}^T \xi_t = 1\)</span>.</p>
</li>
<li>
<p><strong>Special Case</strong>: Equally weighted DATE:</p>
<p><span class="math display">\[
\tau_{\text{eq}} = \frac{1}{nT} \sum_{t=1}^T \sum_{i=1}^n \tau_{it}
\]</span></p>
</li>
</ul>
<hr>
<p>Inverse Probability Weighting (IPW) methods are widely used to correct for <strong>selection bias</strong> in treatment assignment by reweighting observations according to their probability of receiving a given treatment. In panel data settings with TWFE regression, the IPW approach can be incorporated to address non-random treatment assignments over time and across units.</p>
<p>We begin with the <strong>classic TWFE regression objective</strong>, then show how IPW modifies it, and finally generalize to the <strong>Reshaped IPW (RIPW)</strong> estimator.</p>
<hr>
<p>The <strong>unweighted</strong> TWFE estimator minimizes the following objective function:</p>
<p><span class="math display">\[
\min_{\tau, \mu, \{\alpha_i\}, \{\lambda_t\}} \sum_{i=1}^{n} \sum_{t=1}^{T} \left( Y_{it} - \mu - \alpha_i - \lambda_t - W_{it} \tau \right)^2
\]</span></p>
<p>where</p>
<ul>
<li>
<span class="math inline">\(n\)</span>: Total number of units (e.g., individuals, firms, regions).</li>
<li>
<span class="math inline">\(T\)</span>: Total number of time periods.</li>
<li>
<span class="math inline">\(Y_{it}\)</span>: Observed outcome for unit <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span>.</li>
<li>
<span class="math inline">\(W_{it}\)</span>: Binary treatment indicator for unit <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span>.
<ul>
<li>
<span class="math inline">\(W_{it} = 1\)</span> if unit <span class="math inline">\(i\)</span> is treated at time <span class="math inline">\(t\)</span>; <span class="math inline">\(0\)</span> otherwise.</li>
</ul>
</li>
<li>
<span class="math inline">\(\tau\)</span>: Parameter of interest, representing the <a href="sec-causal-inference.html#sec-average-treatment-effect">Average Treatment Effect</a> under the TWFE model.</li>
<li>
<span class="math inline">\(\mu\)</span>: Common intercept, capturing the overall average outcome level across all units and times.</li>
<li>
<span class="math inline">\(\alpha_i\)</span>: Unit-specific fixed effects, controlling for time-invariant heterogeneity across units.</li>
<li>
<span class="math inline">\(\lambda_t\)</span>: Time-specific fixed effects, controlling for shocks or common trends that affect all units in time period <span class="math inline">\(t\)</span>.</li>
</ul>
<p>This standard TWFE regression assumes <a href="sec-difference-in-differences.html#prior-parallel-trends-test">parallel trends</a> across units in the absence of treatment and <strong>ignores</strong> the treatment assignment mechanism.</p>
<hr>
<p>The <strong>IPW-TWFE estimator</strong> modifies the classic TWFE regression by <strong>reweighting</strong> the contribution of each observation according to the <strong>inverse probability of the entire treatment path</strong> for unit <span class="math inline">\(i\)</span>.</p>
<p>The weighted objective function is:</p>
<p><span class="math display">\[
\min_{\tau, \mu, \{\alpha_i\}, \{\lambda_t\}} \sum_{i=1}^{n} \sum_{t=1}^{T} \left( Y_{it} - \mu - \alpha_i - \lambda_t - W_{it} \tau \right)^2 \cdot \frac{1}{\pi_i(\mathbf{W}_i)}
\]</span></p>
<p>where</p>
<ul>
<li>
<span class="math inline">\(\pi_i(\mathbf{W}_i)\)</span>: The <strong>generalized propensity score (GPS)</strong> for unit <span class="math inline">\(i\)</span>.
<ul>
<li>This is the joint probability that unit <span class="math inline">\(i\)</span> follows the entire treatment assignment path <span class="math inline">\(\mathbf{W}_i = (W_{i1}, W_{i2}, \dots, W_{iT})\)</span>.</li>
<li>It represents the assignment mechanism, which may be known (in experimental designs) or estimated (in observational studies).</li>
</ul>
</li>
</ul>
<p>By weighting the squared residual for each unit-time observation by <span class="math inline">\(\frac{1}{\pi_i(\mathbf{W}_i)}\)</span>, the IPW-TWFE estimator <strong>adjusts for non-random treatment assignment</strong>, similar to the role of IPW in cross-sectional data.</p>
<hr>
<p>The <strong>Reshaped IPW (RIPW)</strong> estimator further generalizes the IPW approach by introducing a <strong>user-specified reshaped design distribution</strong>, denoted by <span class="math inline">\(\Pi\)</span>, over the space of treatment assignment paths.</p>
<p>The RIPW-TWFE estimator minimizes the following weighted objective:</p>
<p><span class="math display">\[
\hat{\tau}_{RIPW}(\Pi) = \arg \min_{\tau, \mu, \{\alpha_i\}, \{\lambda_t\}} \sum_{i=1}^{n} \sum_{t=1}^{T} \left( Y_{it} - \mu - \alpha_i - \lambda_t - W_{it} \tau \right)^2 \cdot \frac{\Pi(\mathbf{W}_i)}{\pi_i(\mathbf{W}_i)}
\]</span></p>
<p>where</p>
<ul>
<li>
<span class="math inline">\(\Pi(\mathbf{W}_i)\)</span>: A <strong>user-specified reshaped distribution</strong> over the treatment assignment paths <span class="math inline">\(\mathbf{W}_i\)</span>.
<ul>
<li>It describes an alternative “design” the researcher wants to emulate, possibly reflecting hypothetical or target assignment mechanisms.</li>
</ul>
</li>
<li>The weight <span class="math inline">\(\frac{\Pi(\mathbf{W}_i)}{\pi_i(\mathbf{W}_i)}\)</span> can be interpreted as a likelihood ratio:
<ul>
<li>If <span class="math inline">\(\pi_i(\cdot)\)</span> is the true assignment distribution, reweighting by <span class="math inline">\(\Pi(\cdot)\)</span> effectively shifts the sampling design from <span class="math inline">\(\pi_i\)</span> to <span class="math inline">\(\Pi\)</span>.</li>
</ul>
</li>
<li>The ratio <span class="math inline">\(\frac{\Pi(\mathbf{W}_i)}{\pi_i(\mathbf{W}_i)}\)</span> adjusts for differences between the observed assignment mechanism and the target design.</li>
</ul>
<hr>
<p>Support of <span class="math inline">\(\mathbf{W}_i\)</span></p>
<p>The support of the treatment assignment paths is defined as:</p>
<p><span class="math display">\[
\mathbb{S} = \bigcup_{i=1}^{n} \text{Supp}(\mathbf{W}_i)
\]</span></p>
<ul>
<li>
<span class="math inline">\(\text{Supp}(\mathbf{W}_i)\)</span>: The support of the random variable <span class="math inline">\(\mathbf{W}_i\)</span>, i.e., the set of all treatment paths with positive probability under <span class="math inline">\(\pi_i(\cdot)\)</span>.</li>
<li>
<span class="math inline">\(\mathbb{S}\)</span> represents the combined support across all units <span class="math inline">\(i = 1, \dots, n\)</span>.</li>
<li>
<span class="math inline">\(\Pi(\cdot)\)</span> should have support contained within <span class="math inline">\(\mathbb{S}\)</span>, to ensure valid reweighting.</li>
</ul>
<hr>
<p><strong>Special Cases of the RIPW Estimator</strong></p>
<p>The choice of <span class="math inline">\(\Pi(\cdot)\)</span> determines the behavior and interpretation of the RIPW estimator. Several special cases are noteworthy:</p>
<ul>
<li>
<p><strong>Uniform Reshaped Design</strong>:</p>
<p><span class="math display">\[
\Pi(\cdot) \sim \text{Uniform}(\mathbb{S})
\]</span></p>
<ul>
<li><p>Here, <span class="math inline">\(\Pi\)</span> places equal probability mass on each possible treatment path in <span class="math inline">\(\mathbb{S}\)</span>.</p></li>
<li>
<p>The weight becomes:</p>
<p><span class="math display">\[
\frac{\Pi(\mathbf{W}_i)}{\pi_i(\mathbf{W}_i)} = \frac{1 / |\mathbb{S}|}{\pi_i(\mathbf{W}_i)}
\]</span></p>
</li>
<li><p>This reduces RIPW to the standard <strong>IPW-TWFE estimator</strong>, in which the target is a uniform treatment assignment design.</p></li>
</ul>
</li>
<li>
<p><strong>Reshaped Design Equals True Assignment</strong>:</p>
<p><span class="math display">\[
\Pi(\cdot) = \pi_i(\cdot)
\]</span></p>
<ul>
<li>
<p>The weight simplifies to:</p>
<p><span class="math display">\[
\frac{\Pi(\mathbf{W}_i)}{\pi_i(\mathbf{W}_i)} = 1
\]</span></p>
</li>
<li><p>The RIPW estimator reduces to the <strong>unweighted TWFE regression</strong>, consistent with an experiment where the assignment mechanism <span class="math inline">\(\pi_i\)</span> is known and correctly specified.</p></li>
</ul>
</li>
</ul>
<hr>
<p>To ensure that <span class="math inline">\(\hat{\tau}_{RIPW}(\Pi)\)</span> consistently estimates the DATE <span class="math inline">\(\tau(\xi)\)</span>, we solve the <strong>DATE Equation</strong>:</p>
<p><span class="math display">\[
\mathbb{E}_{\mathbf{W} \sim \Pi} \left[ \left( \text{diag}(\mathbf{W}) - \xi \mathbf{W}^\top \right) J \left( \mathbf{W} - \mathbb{E}_{\Pi}[\mathbf{W}] \right) \right] = 0
\]</span></p>
<ul>
<li>
<span class="math inline">\(J = I_T - \frac{1}{T} \mathbf{1}_T \mathbf{1}_T^\top\)</span> is a projection matrix removing the mean.</li>
<li>Solving this equation ensures consistency of the RIPW estimator for <span class="math inline">\(\tau(\xi)\)</span>.</li>
</ul>
<hr>
<p>Choosing the Reshaped Distribution <span class="math inline">\(\Pi\)</span></p>
<ul>
<li>If the support <span class="math inline">\(\mathbb{S}\)</span> and <span class="math inline">\(\pi_i(\cdot)\)</span> are known, <span class="math inline">\(\Pi\)</span> can be specified directly.</li>
<li>Closed-form solutions for <span class="math inline">\(\Pi\)</span> are available in settings such as staggered adoption designs.</li>
<li>When closed-form solutions are unavailable, optimization algorithms (e.g., BFGS) can be employed to solve the DATE equation numerically.</li>
</ul>
<hr>
<p><strong>Properties</strong></p>
<ul>
<li>The RIPW estimator provides design-robustness:
<ul>
<li>It can correct for misspecified outcome models by properly reweighting according to the assignment mechanism.</li>
<li>It accommodates complex treatment assignment processes, such as staggered adoption and non-random assignment.</li>
</ul>
</li>
<li>The flexibility to choose <span class="math inline">\(\Pi(\cdot)\)</span> allows researchers to target estimands that represent specific policy interventions or hypothetical designs.</li>
</ul>
<p>The RIPW estimator has a <strong>double robustness</strong> property:</p>
<ul>
<li>
<p><span class="math inline">\(\hat{\tau}_{RIPW}(\Pi)\)</span> is consistent if <strong>either</strong>:</p>
<ul>
<li><p>The assignment model <span class="math inline">\(\pi_i(\cdot)\)</span> is correctly specified <strong>or</strong></p></li>
<li><p>The outcome regression (TWFE) model is correctly specified.</p></li>
</ul>
</li>
</ul>
<p>This feature is particularly valuable in <a href="sec-quasi-experimental.html#sec-quasi-experimental">quasi-experimental designs</a> where the parallel trends assumption may not hold globally.</p>
<ul>
<li>
<strong>Design-Robustness</strong>: RIPW corrects for negative weighting issues identified in the TWFE literature (e.g., <span class="citation">Goodman-Bacon (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-goodman2021difference">2021</a>)</span>; <span class="citation">Clement De Chaisemartin and D’haultfœuille (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-de2023two">2023</a>)</span>).</li>
<li>Unlike conventional TWFE regressions, which can yield biased estimands under heterogeneity, RIPW explicitly targets user-specified weighted averages (DATE).</li>
<li>In randomized experiments, RIPW ensures the <strong>effective estimand</strong> is interpretable as a population-level average, determined by the design <span class="math inline">\(\Pi\)</span>.</li>
</ul>
<hr>
</div>
<div id="gardner2022two-and-borusyak2024revisiting" class="section level3" number="30.8.8">
<h3>
<span class="header-section-number">30.8.8</span> <span class="citation">Gardner (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-gardner2022two">2022</a>)</span> and <span class="citation">Borusyak, Jaravel, and Spiess (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-borusyak2024revisiting">2024</a>)</span><a class="anchor" aria-label="anchor" href="#gardner2022two-and-borusyak2024revisiting"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>Estimate the time and unit fixed effects separately</p></li>
<li><p>Known as the imputation method <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-borusyak2024revisiting">Borusyak, Jaravel, and Spiess 2024</a>)</span> or two-stage DiD <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-gardner2022two">Gardner 2022</a>)</span></p></li>
</ul>
<div class="sourceCode" id="cb810"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># remotes::install_github("kylebutts/did2s")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://kylebutts.github.io/did2s/">did2s</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">base_stagg</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kylebutts.github.io/did2s/reference/did2s.html">did2s</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>treat <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">time_to_treatment</span> <span class="op">&gt;=</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    yname <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    first_stage <span class="op">=</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">|</span> <span class="va">id</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>    second_stage <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/i.html">i</a></span><span class="op">(</span><span class="va">time_to_treatment</span>, ref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    treatment <span class="op">=</span> <span class="st">"treat"</span> ,</span>
<span>    cluster_var <span class="op">=</span> <span class="st">"id"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/etable.html">esttable</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                       est</span></span>
<span><span class="co">#&gt; Dependent Var.:                         y</span></span>
<span><span class="co">#&gt;                                          </span></span>
<span><span class="co">#&gt; time_to_treatment = -9  0.3518** (0.1332)</span></span>
<span><span class="co">#&gt; time_to_treatment = -8  -0.3130* (0.1213)</span></span>
<span><span class="co">#&gt; time_to_treatment = -7    0.0894 (0.2367)</span></span>
<span><span class="co">#&gt; time_to_treatment = -6    0.0312 (0.2176)</span></span>
<span><span class="co">#&gt; time_to_treatment = -5   -0.2079 (0.1519)</span></span>
<span><span class="co">#&gt; time_to_treatment = -4   -0.1152 (0.1438)</span></span>
<span><span class="co">#&gt; time_to_treatment = -3   -0.0127 (0.1483)</span></span>
<span><span class="co">#&gt; time_to_treatment = -2    0.1503 (0.1440)</span></span>
<span><span class="co">#&gt; time_to_treatment = 0  -5.139*** (0.3680)</span></span>
<span><span class="co">#&gt; time_to_treatment = 1  -3.480*** (0.3784)</span></span>
<span><span class="co">#&gt; time_to_treatment = 2  -2.021*** (0.3055)</span></span>
<span><span class="co">#&gt; time_to_treatment = 3   -0.6965. (0.3947)</span></span>
<span><span class="co">#&gt; time_to_treatment = 4    1.070** (0.3501)</span></span>
<span><span class="co">#&gt; time_to_treatment = 5   2.173*** (0.4456)</span></span>
<span><span class="co">#&gt; time_to_treatment = 6   4.449*** (0.3680)</span></span>
<span><span class="co">#&gt; time_to_treatment = 7   4.864*** (0.3698)</span></span>
<span><span class="co">#&gt; time_to_treatment = 8   6.187*** (0.2702)</span></span>
<span><span class="co">#&gt; ______________________ __________________</span></span>
<span><span class="co">#&gt; S.E. type                          Custom</span></span>
<span><span class="co">#&gt; Observations                          950</span></span>
<span><span class="co">#&gt; R2                                0.62486</span></span>
<span><span class="co">#&gt; Adj. R2                           0.61843</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span></span>
<span><span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">iplot</a></span><span class="op">(</span></span>
<span>    <span class="va">est</span>,</span>
<span>    main <span class="op">=</span> <span class="st">"Event study"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"Time to treatment"</span>,</span>
<span>    ref.line <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.2-did-other_files/figure-html/unnamed-chunk-26-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb811"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">coefplot</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.2-did-other_files/figure-html/unnamed-chunk-26-2.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb812"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mult_est</span> <span class="op">&lt;-</span> <span class="fu">did2s</span><span class="fu">::</span><span class="fu"><a href="https://kylebutts.github.io/did2s/reference/event_study.html">event_study</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu">fixest</span><span class="fu">::</span><span class="va"><a href="https://lrberge.github.io/fixest/reference/base_stagg.html">base_stagg</a></span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year_treated <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">year_treated</span> <span class="op">==</span> <span class="fl">10000</span>, <span class="fl">0</span>, <span class="va">year_treated</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    gname <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    idname <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    tname <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    yname <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimator <span class="op">=</span> <span class="st">"all"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in purrr::map(., function(y) { : ℹ In index: 1.</span></span>
<span><span class="co">#&gt; ℹ With name: y.</span></span>
<span><span class="co">#&gt; Caused by error in `.subset2()`:</span></span>
<span><span class="co">#&gt; ! no such index at level 1</span></span>
<span><span class="fu">did2s</span><span class="fu">::</span><span class="fu"><a href="https://kylebutts.github.io/did2s/reference/event_study.html">plot_event_study</a></span><span class="op">(</span><span class="va">mult_est</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.2-did-other_files/figure-html/unnamed-chunk-27-1.png" width="90%" style="display: block; margin: auto;"></div>
<p><span class="citation">Borusyak, Jaravel, and Spiess (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-borusyak2024revisiting">2024</a>)</span> <code>didimputation</code></p>
<p>This version is currently not working</p>
<div class="sourceCode" id="cb813"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">didimputation</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"base_stagg"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/didimputation/man/did_imputation.html">did_imputation</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    yname <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    gname <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    tname <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    idname <span class="op">=</span> <span class="st">"id"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
<div id="dynamic-treatment-effect-estimation-with-interactive-fixed-effects-and-short-panels" class="section level3" number="30.8.9">
<h3>
<span class="header-section-number">30.8.9</span> Dynamic Treatment Effect Estimation with Interactive Fixed Effects and Short Panels<a class="anchor" aria-label="anchor" href="#dynamic-treatment-effect-estimation-with-interactive-fixed-effects-and-short-panels"><i class="fas fa-link"></i></a>
</h3>
<!-- https://www.kylebutts.com/files/JMP_slides.pdf -->
<p><span class="citation">N. L. Brown and Butts (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-brown2025dynamic">2025</a>)</span></p>
<hr>
</div>
<div id="sec-switching-difference-in-differences-estimator-de2020two" class="section level3" number="30.8.10">
<h3>
<span class="header-section-number">30.8.10</span> Switching Difference-in-Differences Estimator <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-de2020two">Clément De Chaisemartin and d’Haultfoeuille 2020</a>)</span><a class="anchor" aria-label="anchor" href="#sec-switching-difference-in-differences-estimator-de2020two"><i class="fas fa-link"></i></a>
</h3>
<p><a href="sec-difference-in-differences.html#sec-two-way-fixed-effects">TWFE</a> hinges on restrictive assumptions — notably, the homogeneity of treatment effects across time and groups. When this assumption is violated, TWFE can yield misleading results, including estimates with signs opposite to all underlying effects.</p>
<p>We consider a standard panel data setup with <span class="math inline">\(G\)</span> groups and <span class="math inline">\(T\)</span> time periods. Each observation belongs to a group-period cell <span class="math inline">\((g, t)\)</span>, and treatment <span class="math inline">\(D_{g,t} \in \{0,1\}\)</span> is assigned at the group-time level.</p>
<p>Let <span class="math inline">\(Y_{i,g,t}\)</span> be the outcome of individual <span class="math inline">\(i\)</span> in group <span class="math inline">\(g\)</span> at time <span class="math inline">\(t\)</span>, with potential outcomes <span class="math inline">\(Y_{i,g,t}(1)\)</span> and <span class="math inline">\(Y_{i,g,t}(0)\)</span>. Observed outcomes satisfy:</p>
<p><span class="math display">\[
Y_{i,g,t} = D_{g,t} \cdot Y_{i,g,t}(1) + (1 - D_{g,t}) \cdot Y_{i,g,t}(0)
\]</span></p>
<p>The canonical TWFE regression is:</p>
<p><span class="math display">\[
Y_{i,g,t} = \alpha_g + \lambda_t + \beta^{fe} D_{g,t} + \varepsilon_{i,g,t}
\]</span></p>
<p>where <span class="math inline">\(\alpha_g\)</span> are group fixed effects, <span class="math inline">\(\lambda_t\)</span> are time fixed effects, and <span class="math inline">\(\beta^{fe}\)</span> is interpreted as the treatment effect <strong>only under homogeneous treatment effects</strong>.</p>
<div id="heterogeneous-treatment-effects-and-weighting-bias" class="section level4" number="30.8.10.1">
<h4>
<span class="header-section-number">30.8.10.1</span> Heterogeneous Treatment Effects and Weighting Bias<a class="anchor" aria-label="anchor" href="#heterogeneous-treatment-effects-and-weighting-bias"><i class="fas fa-link"></i></a>
</h4>
<p>When treatment effects vary across <span class="math inline">\((g,t)\)</span> cells, the TWFE estimator <span class="math inline">\(\hat{\beta}^{fe}\)</span> is no longer a simple average. Instead, it can be decomposed into a weighted sum of cell-specific average treatment effects:</p>
<p><span class="math display">\[
\beta^{fe} = \mathbb{E} \left[ \sum_{(g,t): D_{g,t}=1} w_{g,t} \Delta_{g,t} \right]
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(\Delta_{g,t} = \mathbb{E}[Y_{g,t}(1) - Y_{g,t}(0)]\)</span> is the average treatment effect in cell <span class="math inline">\((g,t)\)</span>
</li>
<li>
<span class="math inline">\(w_{g,t}\)</span> are weights that <strong>can be negative</strong> and sum to one.</li>
</ul>
<p>Some weights are negative because <a href="sec-difference-in-differences.html#sec-two-way-fixed-effects">TWFE</a> implicitly compares outcomes across all treated and untreated groups, even when “controls” are themselves treated. These comparisons can subtract out treatment effects, leading to negative weights.</p>
<hr>
</div>
<div id="illustration-negative-weights-can-flip-signs" class="section level4" number="30.8.10.2">
<h4>
<span class="header-section-number">30.8.10.2</span> Illustration: Negative Weights Can Flip Signs<a class="anchor" aria-label="anchor" href="#illustration-negative-weights-can-flip-signs"><i class="fas fa-link"></i></a>
</h4>
<p>For example, suppose:</p>
<ul>
<li>Group 1 is treated only in period 3: <span class="math inline">\(\Delta_{1,3} = 1\)</span>
</li>
<li>Group 2 is treated in periods 2 and 3:
<ul>
<li><span class="math inline">\(\Delta_{2,2} = 1\)</span></li>
<li><span class="math inline">\(\Delta_{2,3} = 4\)</span></li>
</ul>
</li>
</ul>
<p>Then TWFE produces:</p>
<p><span class="math display">\[
\beta^{fe} = \frac{1}{2} \Delta_{1,3} + \Delta_{2,2} - \frac{1}{2} \Delta_{2,3} = \frac{1}{2} + 1 - 2 = -0.5
\]</span></p>
<p>All <span class="math inline">\(\Delta_{g,t}\)</span>s are positive, but the TWFE estimate is <strong>negative</strong>.</p>
<hr>
<p>To assess the extent to which TWFE may be misleading, compute the <strong>robustness ratio</strong>:</p>
<p><span class="math display">\[
\sigma^{fe}_\_ = \frac{|\hat{\beta}^{fe}|}{\hat{\sigma}(w)}
\]</span></p>
<p>Where:</p>
<ul>
<li>
<span class="math inline">\(\hat{\sigma}(w)\)</span> is the standard deviation of the TWFE weights across treated cells.</li>
<li>A <strong>small</strong> <span class="math inline">\(\sigma^{fe}_\_\)</span> indicates that minor heterogeneity can reverse the sign of the estimate.</li>
</ul>
<p>This can be estimated directly from data and helps determine whether TWFE is reliable in your context.</p>
<hr>
</div>
<div id="did_m-estimator-a-robust-alternative" class="section level4" number="30.8.10.3">
<h4>
<span class="header-section-number">30.8.10.3</span> DID_M Estimator: A Robust Alternative<a class="anchor" aria-label="anchor" href="#did_m-estimator-a-robust-alternative"><i class="fas fa-link"></i></a>
</h4>
<p><span class="citation">Clément De Chaisemartin and d’Haultfoeuille (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-de2020two">2020</a>)</span> propose the <strong>DID_M</strong> estimator, which is valid under heterogeneous treatment effects. It focuses only on <strong>switching groups</strong>, using non-switchers as controls in a local difference-in-differences design.</p>
<p>Let <span class="math inline">\(S\)</span> denote the set of all <span class="math inline">\((g,t)\)</span> cells where treatment status changes between <span class="math inline">\(t-1\)</span> and <span class="math inline">\(t\)</span>. The DID_M estimator is:</p>
<p><span class="math display">\[
\text{DID}_M = \sum_{t=2}^{T} \left( \frac{N_{1,0,t}}{N_S} \cdot \text{DID}^+_t + \frac{N_{0,1,t}}{N_S} \cdot \text{DID}^-_t \right)
\]</span></p>
<p>Where:</p>
<ul>
<li>
<span class="math inline">\(\text{DID}^+_t\)</span> compares joiners to stable untreated groups</li>
<li>
<span class="math inline">\(\text{DID}^-_t\)</span> compares leavers to stable treated groups</li>
<li>
<span class="math inline">\(N_S\)</span> is the total number of observations in switching cells</li>
</ul>
<p>DID_M requires:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Common trends</strong> for both treated and untreated potential outcomes</li>
<li>
<strong>Existence of stable groups</strong> at every <span class="math inline">\(t\)</span> (i.e., some groups don’t change treatment status)</li>
<li>
<strong>No Ashenfelter dip</strong> (treatment not triggered by negative shocks)</li>
</ol>
<p>These assumptions are <strong>weaker</strong> than those required for TWFE to be unbiased.</p>
<p><span class="citation">Clément De Chaisemartin and d’Haultfoeuille (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-de2020two">2020</a>)</span> also propose a placebo version of DID_M using pre-treatment periods. If pre-treatment differences exist between switchers and non-switchers, this indicates violation of the parallel trends assumption. This test is analogous to pre-trend checks in event-study designs.</p>
<div class="sourceCode" id="cb814"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span>            <span class="co"># For TWFE model and dataset</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chaisemartinPackages">TwoWayFEWeights</a></span><span class="op">)</span>   <span class="co"># For decomposing TWFE weights</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">DIDmultiplegt</span><span class="op">)</span>     <span class="co"># For robust SDID estimator</span></span>
<span></span>
<span><span class="co"># Load the sample staggered adoption dataset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"base_stagg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview the data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">base_stagg</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id year year_treated time_to_treatment treated treatment_effect_true</span></span>
<span><span class="co">#&gt; 2 90    1            2                -1       1                     0</span></span>
<span><span class="co">#&gt; 3 89    1            3                -2       1                     0</span></span>
<span><span class="co">#&gt; 4 88    1            4                -3       1                     0</span></span>
<span><span class="co">#&gt; 5 87    1            5                -4       1                     0</span></span>
<span><span class="co">#&gt; 6 86    1            6                -5       1                     0</span></span>
<span><span class="co">#&gt; 7 85    1            7                -6       1                     0</span></span>
<span><span class="co">#&gt;           x1           y</span></span>
<span><span class="co">#&gt; 2 -1.0947021  0.01722971</span></span>
<span><span class="co">#&gt; 3 -3.7100676 -4.58084528</span></span>
<span><span class="co">#&gt; 4  2.5274402  2.73817174</span></span>
<span><span class="co">#&gt; 5 -0.7204263 -0.65103066</span></span>
<span><span class="co">#&gt; 6 -3.6711678 -5.33381664</span></span>
<span><span class="co">#&gt; 7 -0.3152137  0.49562631</span></span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Estimate TWFE Model</li>
</ol>
<div class="sourceCode" id="cb815"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run standard TWFE using fixest</span></span>
<span><span class="va">twfe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">|</span> <span class="va">id</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>                    data <span class="op">=</span> <span class="va">base_stagg</span> <span class="op">|&gt;</span></span>
<span>                        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">time_to_treatment</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">twfe</span><span class="op">)</span></span>
<span><span class="co">#&gt; OLS estimation, Dep. Var.: y</span></span>
<span><span class="co">#&gt; Observations: 950</span></span>
<span><span class="co">#&gt; Fixed-effects: id: 95,  year: 10</span></span>
<span><span class="co">#&gt; Standard-errors: Clustered (id) </span></span>
<span><span class="co">#&gt;           Estimate Std. Error t value   Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; treatment -3.46761    0.47672 -7.2739 1.0326e-10 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; RMSE: 2.471     Adj. R2: 0.272265</span></span>
<span><span class="co">#&gt;               Within R2: 0.111912</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Decompose Weights with <code>TwoWayFEWeights</code>
</li>
</ol>
<div class="sourceCode" id="cb816"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">twfe_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/TwoWayFEWeights/man/twowayfeweights.html">twowayfeweights</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">time_to_treatment</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    G <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    T <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    D <span class="op">=</span> <span class="st">"treatment"</span>, </span>
<span>    summary_measures <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show summary</span></span>
<span><span class="va">twfe_weights</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Under the common trends assumption,</span></span>
<span><span class="co">#&gt; the TWFE coefficient beta, equal to -3.4676, estimates a weighted sum of 45 ATTs.</span></span>
<span><span class="co">#&gt; 41 ATTs receive a positive weight, and 4 receive a negative weight.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ────────────────────────────────────────── </span></span>
<span><span class="co">#&gt; Treat. var: treatment    ATTs    Σ weights </span></span>
<span><span class="co">#&gt; ────────────────────────────────────────── </span></span>
<span><span class="co">#&gt; Positive weights           41       1.0238 </span></span>
<span><span class="co">#&gt; Negative weights            4      -0.0238 </span></span>
<span><span class="co">#&gt; ────────────────────────────────────────── </span></span>
<span><span class="co">#&gt; Total                      45            1 </span></span>
<span><span class="co">#&gt; ──────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary Measures:</span></span>
<span><span class="co">#&gt;   TWFE Coefficient (β_fe): -3.4676</span></span>
<span><span class="co">#&gt;   min σ(Δ) compatible with β_fe and Δ_TR = 0: 4.8357</span></span>
<span><span class="co">#&gt;   min σ(Δ) compatible with treatment effect of opposite sign than β_fe in all (g,t) cells: 36.1549</span></span>
<span><span class="co">#&gt;   Reference: Corollary 1, de Chaisemartin, C and D'Haultfoeuille, X (2020a)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The development of this package was funded by the European Union (ERC, REALLYCREDIBLE,GA N. 101043899).</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Estimate DID_M (Switching DID Estimator) with <code>DIDmultiplegt</code>
</li>
</ol>
<div class="sourceCode" id="cb817"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate robust SDID estimator (DID_M)</span></span>
<span><span class="va">did_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DIDmultiplegt/man/did_multiplegt.html">did_multiplegt</a></span><span class="op">(</span></span>
<span>        mode <span class="op">=</span> <span class="st">"dyn"</span>,</span>
<span>        df <span class="op">=</span> <span class="va">base_stagg</span> <span class="op">|&gt;</span></span>
<span>            <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">time_to_treatment</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        outcome <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        group <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>        time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        treatment <span class="op">=</span> <span class="st">"treatment"</span>,</span>
<span>        effects <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        <span class="co"># controls = c("x1"),</span></span>
<span>        placebo <span class="op">=</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.2-did-other_files/figure-html/unnamed-chunk-32-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb818"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">did_m</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ----------------------------------------------------------------------</span></span>
<span><span class="co">#&gt;        Estimation of treatment effects: Event-study effects</span></span>
<span><span class="co">#&gt; ----------------------------------------------------------------------</span></span>
<span><span class="co">#&gt;              Estimate SE      LB CI    UB CI    N  Switchers</span></span>
<span><span class="co">#&gt; Effect_1     -5.04943 0.03256 -5.11324 -4.98562 54 9        </span></span>
<span><span class="co">#&gt; Effect_2     -3.25734 0.06712 -3.38889 -3.12579 44 8        </span></span>
<span><span class="co">#&gt; Effect_3     -2.17826 0.08866 -2.35204 -2.00449 35 7        </span></span>
<span><span class="co">#&gt; Effect_4     -0.03749 0.12841 -0.28916 0.21418  27 6        </span></span>
<span><span class="co">#&gt; Effect_5     1.31986  0.12128 1.08216  1.55756  20 5        </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Test of joint nullity of the effects : p-value = 0.0000</span></span>
<span><span class="co">#&gt; ----------------------------------------------------------------------</span></span>
<span><span class="co">#&gt;     Average cumulative (total) effect per treatment unit</span></span>
<span><span class="co">#&gt; ----------------------------------------------------------------------</span></span>
<span><span class="co">#&gt;  Estimate        SE     LB CI     UB CI         N Switchers </span></span>
<span><span class="co">#&gt;  -2.29649   0.07360  -2.44074  -2.15223        80        35 </span></span>
<span><span class="co">#&gt; Average number of time periods over which a treatment effect is accumulated: 2.7143</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ----------------------------------------------------------------------</span></span>
<span><span class="co">#&gt;      Testing the parallel trends and no anticipation assumptions</span></span>
<span><span class="co">#&gt; ----------------------------------------------------------------------</span></span>
<span><span class="co">#&gt;              Estimate SE      LB CI    UB CI    N  Switchers</span></span>
<span><span class="co">#&gt; Placebo_1    0.27204  0.04917 0.17567  0.36841  44 8        </span></span>
<span><span class="co">#&gt; Placebo_2    -0.72910 0.06790 -0.86219 -0.59601 27 6        </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Test of joint nullity of the placebos : p-value = 0.0000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The development of this package was funded by the European Union.</span></span>
<span><span class="co">#&gt; ERC REALLYCREDIBLE - GA N. 101043899</span></span></code></pre></div>
<hr>
</div>
</div>
<div id="augmentedforward-did" class="section level3" number="30.8.11">
<h3>
<span class="header-section-number">30.8.11</span> Augmented/Forward DID<a class="anchor" aria-label="anchor" href="#augmentedforward-did"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>DID Methods for Limited Pre-Treatment Periods:</li>
</ul>
<div class="inline-table"><table style="width:99%;" class="table table-sm">
<colgroup>
<col width="12%">
<col width="34%">
<col width="52%">
</colgroup>
<thead><tr class="header">
<th><strong>Method</strong></th>
<th><strong>Scenario</strong></th>
<th><strong>Approach</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>
<p><strong>Augmented DID</strong></p>
<p><span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-li2023augmented">K. T. Li and Van den Bulte 2023</a>)</span></p>
</td>
<td>Treatment outcome is outside the range of control units</td>
<td>Constructs the treatment counterfactual using a scaled average of control units</td>
</tr>
<tr class="even">
<td>
<p><strong>Forward DID</strong></p>
<p><span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-li2024frontiers">K. T. Li 2024</a>)</span></p>
</td>
<td>Treatment outcome is within the range of control units</td>
<td>Uses a forward selection algorithm to choose relevant control units before applying DID</td>
</tr>
</tbody>
</table></div>
<hr>
</div>
<div id="doubly-robust-difference-in-differences-estimators" class="section level3" number="30.8.12">
<h3>
<span class="header-section-number">30.8.12</span> Doubly Robust Difference-in-Differences Estimators<a class="anchor" aria-label="anchor" href="#doubly-robust-difference-in-differences-estimators"><i class="fas fa-link"></i></a>
</h3>
<p>In its simplest “canonical” form, DID compares the before-and-after outcomes of one group that eventually receives a treatment (the “treated” group) with the before-and-after outcomes of another group that never receives the treatment (the “comparison” group). Under the parallel trends assumption, DID can recover the <a href="sec-causal-inference.html#sec-average-treatment-effect-on-the-treated">average treatment effect on the treated</a> (ATT).</p>
<p>Practitioners often enrich DID analyses by conditioning on observed covariates to mitigate violations of the unconditional parallel trends assumption. Once conditioning on covariates, the DID framework remains attractive, provided that <em>conditional</em> parallel trends hold.</p>
<p>Historically, two main approaches have emerged for DID estimation in the presence of covariates:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Outcome Regression (OR)</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-heckman1997matching">J. J. Heckman, Ichimura, and Todd 1997</a>)</span>. Model the outcome evolution for the comparison group (and possibly for the treated group), and then plug these fitted outcome equations into the DID formula.</li>
<li>
<strong>Inverse Probability Weighting (IPW)</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-abadie2005semiparametric">Abadie 2005</a>)</span>. Model the probability of treatment conditional on covariates (the “propensity score”) and use inverse-probability reweighting to reconstruct appropriate counterfactuals for the treated group.</li>
</ol>
<p>A key insight in semiparametric causal inference is that one can <em>combine</em> these two approaches—modeling the outcome regression and the propensity score in tandem—to form an estimator that remains consistent if <em>either</em> the outcome-regression equations are correctly specified <em>or</em> the propensity-score equation is correctly specified. Such an estimator is called <strong>doubly robust</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sant2020doubly">Sant’Anna and Zhao 2020</a>)</span>.</p>
<p>This section covers both cases of (i) panel data (where we observe each unit in both pre- and post-treatment periods) and (ii) repeated cross-section data (where, in each period, we observe a new random sample of units).</p>
<p>Under suitable conditions, the proposed doubly robust estimators not only exhibit desirable robustness properties to misspecification but can also attain the semiparametric efficiency bound, making them <em>locally efficient</em> if all working models are correct.</p>
<hr>
<div id="notation-and-set-up" class="section level4" number="30.8.12.1">
<h4>
<span class="header-section-number">30.8.12.1</span> Notation and set-up<a class="anchor" aria-label="anchor" href="#notation-and-set-up"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>
<p><strong>Two-time-period design.</strong> We consider a setting with two time periods: <span class="math inline">\(t = 0\)</span> (pre-treatment) and <span class="math inline">\(t = 1\)</span> (post-treatment). A subset of units receives the treatment only at <span class="math inline">\(t = 1\)</span>. Hence for a unit <span class="math inline">\(i\)</span>:</p>
<ul>
<li>
<span class="math inline">\(D_i = D_{i1} \in \{0, 1\}\)</span> is an indicator for receiving treatment by time 1 (so <span class="math inline">\(D_{i0} = 0\)</span> for all <span class="math inline">\(i\)</span>).</li>
<li>
<span class="math inline">\(Y_{it}\)</span> is the observed outcome at time <span class="math inline">\(t\)</span>.</li>
</ul>
</li>
<li><p><strong>Potential outcomes.</strong> We adopt the potential outcomes framework. Let <span class="math display">\[
   Y_{it}(1) \;=\; \text{potential outcome of unit }i \text{ at time } t \text{ if treated,}
\]</span> <span class="math display">\[
   Y_{it}(0) \;=\; \text{potential outcome of unit }i \text{ at time } t \text{ if not treated.}
\]</span> Then the observed outcome satisfies <span class="math inline">\(Y_{it} = D_i \, Y_{it}(1) + (1-D_i)\, Y_{it}(0)\)</span>.</p></li>
<li><p><strong>Covariates.</strong> A vector of observed pre-treatment covariates is denoted <span class="math inline">\(X_i\)</span>. Throughout, we assume the first component of <span class="math inline">\(X_i\)</span> is a constant (intercept).</p></li>
<li>
<p><strong>Data structures.</strong></p>
<ol style="list-style-type: decimal">
<li>
<strong>Panel data.</strong> We observe <span class="math inline">\(\{(Y_{i0}, Y_{i1}, D_i, X_i)\}_{i=1}^n\)</span>, a sample of size <span class="math inline">\(n\)</span> drawn i.i.d. from an underlying population.</li>
<li>
<strong>Repeated cross-sections.</strong> In period <span class="math inline">\(t\)</span>, we observe a fresh random sample of units. Let <span class="math inline">\(T_i\in \{0,1\}\)</span> be an indicator for whether an observation is drawn in the post-treatment period <span class="math inline">\((T_i=1)\)</span> or the pre-treatment period <span class="math inline">\((T_i=0)\)</span>. Write <span class="math inline">\(\{(Y_i, D_i, X_i, T_i)\}_{i=1}^n\)</span>. Here, if <span class="math inline">\(T_i=1\)</span>, then <span class="math inline">\(Y_i \equiv Y_{i1}\)</span>; if <span class="math inline">\(T_i=0\)</span>, then <span class="math inline">\(Y_i \equiv Y_{i0}\)</span>. We typically assume a stationarity condition, namely that the distribution of <span class="math inline">\((D, X)\)</span> is stable across the two periods.</li>
</ol>
</li>
</ul>
<p>Let <span class="math inline">\(n_1\)</span> and <span class="math inline">\(n_0\)</span> be the respective sample sizes for the post- and pre-treatment periods, so <span class="math inline">\(n_1 + n_0 = n\)</span>. Often we let <span class="math inline">\(\lambda = P(T=1)\approx n_1/n.\)</span></p>
<p>The focus is on the ATT: <span class="math display">\[
    \tau \;=\; \mathbb{E}\bigl[Y_{i1}(1) - Y_{i1}(0)\,\big|\; D_i=1\bigr].
\]</span> Because we only observe <span class="math inline">\(Y_{i1}(1)\)</span> for the treated group, the central challenge is to recover <span class="math inline">\(\mathbb{E}[Y_{i1}(0)\mid D_i=1]\)</span>. Under standard DID assumptions, we identify <span class="math inline">\(\tau\)</span> by comparing the treated group’s evolution in outcomes to the comparison group’s evolution in outcomes.</p>
<p>We require two key assumptions:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Conditional parallel trends</strong><br>
For <span class="math inline">\(t=0,1\)</span>, let <span class="math display">\[
    \mathbb{E}[\,Y_{1}(0) - Y_{0}(0)\,\mid D=1,\, X]
    \;=\;
    \mathbb{E}[\,Y_{1}(0) - Y_{0}(0)\,\mid D=0,\, X].
\]</span> This means that—conditional on <span class="math inline">\(X\)</span>—in the <em>absence</em> of treatment, the treated and comparison groups would have had <em>parallel outcome evolutions</em>.</p></li>
<li><p><strong>Overlap</strong><br>
There exists <span class="math inline">\(\varepsilon&gt;0\)</span> such that <span class="math display">\[
  P(D=1)\;&gt;\;\varepsilon,
  \quad\text{and}\quad
  P(D=1\,\vert\,X)\;\le\;1-\varepsilon
\]</span> That is, we require that a nontrivial fraction of the population is treated, and for each <span class="math inline">\(X\)</span>, there is a nontrivial probability of being in the untreated group (<span class="math inline">\(D=0\)</span>).</p></li>
</ol>
<p>Under these assumptions, we can identify <span class="math inline">\(\mathbb{E}[\,Y_{1}(0)\mid D=1]\)</span> in a semiparametric fashion, either by modeling the outcome regressions (the OR approach) or by modeling the propensity score (the IPW approach).</p>
<hr>
</div>
<div id="two-traditional-did-approaches" class="section level4" number="30.8.12.2">
<h4>
<span class="header-section-number">30.8.12.2</span> Two Traditional DID Approaches<a class="anchor" aria-label="anchor" href="#two-traditional-did-approaches"><i class="fas fa-link"></i></a>
</h4>
<p>We briefly outline the classical DID estimators that rely solely on either outcome regressions or inverse probability weighting, to motivate the doubly robust idea.</p>
<div id="outcome-regression-or-approach" class="section level5" number="30.8.12.2.1">
<h5>
<span class="header-section-number">30.8.12.2.1</span> Outcome-regression (OR) approach<a class="anchor" aria-label="anchor" href="#outcome-regression-or-approach"><i class="fas fa-link"></i></a>
</h5>
<p>Define <span class="math display">\[
   m_{d,t}(x) \;=\; \mathbb{E}[\,Y_t \,\mid\,D=d,\; X=x\,].
\]</span> Under the conditional parallel trends assumption, <span class="math display">\[
  \mathbb{E}[\,Y_{1}(0)\mid D=1 \,]
  \;=\;
   \mathbb{E}[\,Y_{0}(0)\mid D=1\,]
   \;+\;
   \mathbb{E}[\,m_{0,1}(X) - m_{0,0}(X)\,\big\vert\,D=1\,].
\]</span> Hence an OR-based DID estimator (for panel or repeated cross-section) typically looks like <span class="math display">\[
  \hat{\tau}^{\mathrm{reg}}
  \;=\;
  \Bigl(\overline{Y}_{1,1}\Bigr)
  \;-\;
  \Bigl(\,\overline{Y}_{1,0}
        \;+\;
        \frac{1}{n_{\mathrm{treat}}}
        \sum_{i:D_i=1}
         \bigl[\,
             \hat{m}_{0,1}(X_i) \;-\; \hat{m}_{0,0}(X_i)
         \bigr]
   \Bigr),
\]</span></p>
<p>where <span class="math inline">\(\overline{Y}_{d,t}\)</span> is the sample mean of <span class="math inline">\(Y_t\)</span> among units with <span class="math inline">\(D=d\)</span>, and <span class="math inline">\(\hat{m}_{0,t}\)</span> is some fitted model (e.g., linear or semiparametric) for <span class="math inline">\(\mathbb{E}[\,Y_t \mid D=0,\,X\,]\)</span>.</p>
<p>This OR estimator is consistent if (and only if) we have <em>correctly specified</em> the two outcome-regression functions <span class="math inline">\(m_{0,1}(x)\)</span> and <span class="math inline">\(m_{0,0}(x)\)</span>. If these regressions are misspecified, the estimator will generally be biased.</p>
</div>
<div id="ipw-approach" class="section level5" number="30.8.12.2.2">
<h5>
<span class="header-section-number">30.8.12.2.2</span> IPW approach<a class="anchor" aria-label="anchor" href="#ipw-approach"><i class="fas fa-link"></i></a>
</h5>
<p>An alternative is to model the propensity score <span class="math display">\[
   p(x)\;=\; P(D=1\mid X=x),
\]</span> and use a Horvitz–Thompson-type reweighting <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-horvitz1952generalization">Horvitz and Thompson 1952</a>)</span> to reconstruct what “would have happened” to the treated group under no treatment. In the panel-data case, <span class="citation">Abadie (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-abadie2005semiparametric">2005</a>)</span> show that the ATT can be identified via <span class="math display">\[
  \tau
  \;=\;
  \frac{1}{\mathbb{E}[D]}
  \,\mathbb{E}\Bigl[\,
    \frac{D - p(X)}{1 - p(X)}
    \Bigl(Y_1 - Y_0\Bigr)
  \Bigr].
\]</span> Hence an IPW estimator for panel data is <span class="math display">\[
  \hat{\tau}^{\mathrm{ipw,p}}
  \;=\;
  \frac{1}{\overline{D}}
  \sum_{i=1}^n
    \Bigl[
       \frac{D_i - \hat{p}(X_i)}{1-\hat{p}(X_i)}
    \Bigr]
    \,\frac{1}{n}\bigl(Y_{i1} - Y_{i0}\bigr),
\]</span> where <span class="math inline">\(\hat{p}(\cdot)\)</span> is a fitted propensity score model. Similar expressions exist for repeated cross-sections, with small modifications to handle the fact that we observe <span class="math inline">\(Y_1\)</span> only if <span class="math inline">\(T=1\)</span>, etc.</p>
<p>This IPW estimator is consistent if (and only if) the propensity score is correctly specified, i.e., <span class="math inline">\(\hat{p}(x)\approx p(x)\)</span>. If the propensity-score model is incorrect, the estimator may be severely biased.</p>
<hr>
</div>
</div>
<div id="doubly-robust-did-main-identification" class="section level4" number="30.8.12.3">
<h4>
<span class="header-section-number">30.8.12.3</span> Doubly Robust DID: Main Identification<a class="anchor" aria-label="anchor" href="#doubly-robust-did-main-identification"><i class="fas fa-link"></i></a>
</h4>
<p>The <strong>doubly robust (DR) idea</strong> is to combine the OR and IPW approaches so that the resulting estimator is consistent if <em>either</em> the OR model is correct <em>or</em> the propensity-score model is correct. Formally, consider two generic “working” models:</p>
<ul>
<li><p><span class="math inline">\(\pi(X)\)</span> for <span class="math inline">\(p(X)\)</span>, i.e., a model for the propensity score,</p></li>
<li><p><span class="math inline">\(\mu_{0,t}(X)\)</span> for the outcome regressions <span class="math inline">\(m_{0,t}(X)=\mathbb{E}[Y_t \mid D=0,X]\)</span>.</p></li>
</ul>
<p>We define two “DR moments” for each data structure.</p>
<div id="dr-estimand-for-panel-data" class="section level5" number="30.8.12.3.1">
<h5>
<span class="header-section-number">30.8.12.3.1</span> DR estimand for panel data<a class="anchor" aria-label="anchor" href="#dr-estimand-for-panel-data"><i class="fas fa-link"></i></a>
</h5>
<p>When panel data are available, define <span class="math display">\[
   \Delta Y \;=\; Y_1 \,-\, Y_0,
   \quad
   \mu_{0,\Delta}(X)\;=\;\mu_{0,1}(X)\;-\;\mu_{0,0}(X).
\]</span> Then a DR moment for <span class="math inline">\(\tau\)</span> is: <span class="math display">\[
   \tau^{\mathrm{dr,p}}
   \;=\;
   \mathbb{E}\Bigl[
    \Bigl(\,w_{1}^{\mathrm{p}}(D)\,-\,w_{0}^{\mathrm{p}}(D,X;\,\pi)\Bigr)\,
    \Bigl(\,\Delta Y \;-\;\mu_{0,\Delta}(X)\Bigr)
   \Bigr],
\]</span> where <span class="math display">\[
   w_{1}^{\mathrm{p}}(D)\;=\;\frac{D}{\mathbb{E}[D]},
   \quad\quad
   w_{0}^{\mathrm{p}}(D,X;\,\pi)\;=\;\frac{\pi(X)\,(1-D)}{(1-\pi(X))\,\mathbb{E}\bigl[\tfrac{\pi(X)\,(1-D)}{1-\pi(X)}\bigr]}.
\]</span> It can be shown that <span class="math inline">\(\tau^{\mathrm{dr,p}} = \tau\)</span> provided <em>either</em> <span class="math inline">\(\pi(x)=p(x)\)</span> almost surely (a.s.) <em>or</em> <span class="math inline">\(\mu_{0,\Delta}(x)=m_{0,\Delta}(x)\)</span> a.s. (the latter meaning that at least the regression for the comparison group is correct).</p>
</div>
<div id="dr-estimands-for-repeated-cross-sections" class="section level5" number="30.8.12.3.2">
<h5>
<span class="header-section-number">30.8.12.3.2</span> DR estimands for repeated cross-sections<a class="anchor" aria-label="anchor" href="#dr-estimands-for-repeated-cross-sections"><i class="fas fa-link"></i></a>
</h5>
<p>When we only have repeated cross-sections, the DR construction must account for the fact that <span class="math inline">\(Y_0, Y_1\)</span> are not observed jointly on the same individuals. Let <span class="math inline">\(\lambda = P(T=1)\)</span>. Then two valid DR estimands are:</p>
<ol style="list-style-type: decimal">
<li><p><span class="math display">\[
  \tau^{\mathrm{dr,rc}}_{1}
  \;=\;
  \mathbb{E}\Bigl[
   \bigl(\,w_{1}^{\mathrm{rc}}(D,T)\,-\,w_{0}^{\mathrm{rc}}(D,T,X;\,\pi)\bigr)\,
   \bigl(Y \;-\;\mu_{0,Y}(T,X)\bigr)
  \Bigr],
\]</span> where <span class="math display">\[
  w_{1}^{\mathrm{rc}}(D,T)
  \;=\;
  \frac{D\,1\{T=1\}}
       {\mathbb{E}[D\,1\{T=1\}]}
  \;-\;
  \frac{D\,1\{T=0\}}
       {\mathbb{E}[D\,1\{T=0\}]},
\]</span> and <span class="math display">\[
  w_{0}^{\mathrm{rc}}(D,T,X;\,\pi)
  \;=\;
  \frac{\pi(X)\,(1-D)\,1\{T=1\}}{(1-\pi(X))\,\mathbb{E}\bigl[\tfrac{\pi(X)\,(1-D)\,1\{T=1\}}{(1-\pi(X))}\bigr]}
  \;-\;
  \frac{\pi(X)\,(1-D)\,1\{T=0\}}{(1-\pi(X))\,\mathbb{E}\bigl[\tfrac{\pi(X)\,(1-D)\,1\{T=0\}}{(1-\pi(X))}\bigr]},
\]</span> and <span class="math inline">\(\mu_{0,Y}(T,X)=T\cdot\mu_{0,1}(X)+(1-T)\cdot\mu_{0,0}(X)\)</span>.</p></li>
<li><p><span class="math display">\[
\tau^{\mathrm{dr,rc}}_{2} \;=\; \tau^{\mathrm{dr,rc}}_{1}\;+\;\Bigl[    \mathbb{E}\bigl(\mu_{1,1}(X) - \mu_{0,1}(X)\,\big|\,D=1\bigr)    \;-\;    \mathbb{E}\bigl(\mu_{1,1}(X) - \mu_{0,1}(X)\,\big|\,D=1,\,T=1\bigr)    \Bigr]\\\;-\;\Bigl[    \mathbb{E}\bigl(\mu_{1,0}(X) - \mu_{0,0}(X)\,\big|\,D=1\bigr)    \;-\;    \mathbb{E}\bigl(\mu_{1,0}(X) - \mu_{0,0}(X)\,\big|\,D=1,\,T=0\bigr)    \Bigr]
\]</span> where <span class="math inline">\(\mu_{d,t}(x)\)</span> is a model for <span class="math inline">\(m_{d,t}(x)=\mathbb{E}[Y \mid D=d,\,T=t,\,X=x]\)</span>.</p></li>
</ol>
<p>One can show <span class="math inline">\(\tau^{\mathrm{dr,rc}}_1 = \tau^{\mathrm{dr,rc}}_2 = \tau\)</span> as long as the stationarity of <span class="math inline">\((D,X)\)</span> across time holds and <em>either</em> the propensity score model <span class="math inline">\(\pi(x)=p(x)\)</span> is correct <em>or</em> the comparison-group outcome regressions are correct <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sant2020doubly">Sant’Anna and Zhao 2020</a>)</span>. Notably, <span class="math inline">\(\tau^{\mathrm{dr,rc}}_2\)</span> also includes explicit modeling of the treated group’s outcomes. However, in terms of identification alone, <span class="math inline">\(\tau^{\mathrm{dr,rc}}_1\)</span> and <span class="math inline">\(\tau^{\mathrm{dr,rc}}_2\)</span> share the same double-robust property.</p>
<hr>
</div>
</div>
<div id="semiparametric-efficiency-bounds-and-local-efficiency" class="section level4" number="30.8.12.4">
<h4>
<span class="header-section-number">30.8.12.4</span> Semiparametric Efficiency Bounds and Local Efficiency<a class="anchor" aria-label="anchor" href="#semiparametric-efficiency-bounds-and-local-efficiency"><i class="fas fa-link"></i></a>
</h4>
<p>An important concept in semiparametric inference is the <strong>semiparametric efficiency bound</strong>, which is the infimum of the asymptotic variance across <em>all</em> regular estimators that exploit only the imposed assumptions (parallel trends, overlap, stationarity). Equivalently, one can think of it as the variance of the “efficient influence function” (EIF).</p>
<p>We highlight key results:</p>
<ol style="list-style-type: decimal">
<li><strong>Efficient influence function for panel data</strong></li>
</ol>
<p>Under the above mentioned assumptions (i.i.d. data generating process, overlap, and conditional parallel trends) and <em>without</em> imposing further parametric constraints on <span class="math inline">\((m_{d,t},p)\)</span>, one can derive that the <strong>EIF</strong> for <span class="math inline">\(\tau\)</span> in the panel-data setting is</p>
<p><span class="math display">\[
\eta^{e,\mathrm{p}}(Y_1, Y_0, D, X) \;=\;\frac{D}{\mathbb{E}[D]}\Bigl[m_{1,\Delta}(X) - m_{0,\Delta}(X) - \tau\Bigr]\\\;+\;\frac{D}{\mathbb{E}[D]}\Bigl[\Delta Y - m_{1,\Delta}(X)\Bigr]\\\;-\;\frac{\pi(X)\,(1-D)}{(1 - \pi(X))\,\mathbb{E}\bigl[\tfrac{\pi(X)\,(1-D)}{1 - \pi(X)}\bigr]}\Bigl[\Delta Y - m_{0,\Delta}(X)\Bigr]
\]</span></p>
<p>where <span class="math inline">\(\Delta Y = Y_1 - Y_0\)</span> and <span class="math inline">\(m_{d,\Delta}(X) \equiv m_{d,1}(X) - m_{d,0}(X)\)</span>.</p>
<p>The associated <strong>semiparametric efficiency bound</strong> is <span class="math display">\[
   \mathbb{E}\bigl[\,\eta^{e,\mathrm{p}}(Y_1,Y_0,D,X)^2\bigr].
\]</span> It can be shown that a DR DID estimator can <em>attain</em> this bound if (1) the propensity score is correctly modeled, and (2) the comparison-group outcome regressions are correctly modeled.</p>
<ol start="2" style="list-style-type: decimal">
<li><strong>Efficient influence function for repeated cross-sections</strong></li>
</ol>
<p>Similarly, when only repeated cross-sections are available, the EIF becomes</p>
<p><span class="math display">\[
\eta^{e,\mathrm{rc}}(Y,D,T,X) \;=\;\frac{D}{\mathbb{E}[D]}\Bigl[m_{1,\Delta}(X) - m_{0,\Delta}(X) - \tau\Bigr]\\\;+\;\Bigl[    w_{1,1}^{\mathrm{rc}}(D,T)\bigl(Y - m_{1,1}(X)\bigr)    \;-\;    w_{1,0}^{\mathrm{rc}}(D,T)\bigl(Y - m_{1,0}(X)\bigr)    \Bigr]\\\;-\;\Bigl[    w_{0,1}^{\mathrm{rc}}(D,T,X;p)\bigl(Y - m_{0,1}(X)\bigr)    \;-\;    w_{0,0}^{\mathrm{rc}}(D,T,X;p)\bigl(Y - m_{0,0}(X)\bigr)    \Bigr]
\]</span></p>
<p>with <span class="math inline">\(\,m_{d,\Delta}(X)=m_{d,1}(X)-m_{d,0}(X)\)</span>. The resulting efficiency bound is <span class="math inline">\(\mathbb{E}\bigl[\eta^{e,\mathrm{rc}}(Y,D,T,X)^2\bigr]\)</span>.</p>
<p>One can further show that having access to <em>panel</em> data can be strictly more informative (i.e., yields a <em>smaller</em> semiparametric variance bound) than repeated cross-sections. This difference can grow if the pre- and post-treatment samples are highly unbalanced.</p>
<hr>
</div>
<div id="construction-of-doubly-robust-did-estimators" class="section level4" number="30.8.12.5">
<h4>
<span class="header-section-number">30.8.12.5</span> Construction of Doubly Robust DID Estimators<a class="anchor" aria-label="anchor" href="#construction-of-doubly-robust-did-estimators"><i class="fas fa-link"></i></a>
</h4>
<ol style="list-style-type: decimal">
<li><strong>Generic two-step approach</strong></li>
</ol>
<p>Building upon the DR moment expressions, a natural approach to estimation is:</p>
<ol style="list-style-type: decimal">
<li>
<strong>First-stage modeling (nuisance parameters).</strong>
<ul>
<li>Estimate <span class="math inline">\(\hat{\pi}(X)\)</span> for the propensity score, e.g. via logistic regression or other parametric or semiparametric methods.</li>
<li>Estimate <span class="math inline">\(\hat{m}_{0,t}(X)\)</span> for <span class="math inline">\(t=0,1\)</span>. One might also estimate <span class="math inline">\(\hat{m}_{1,t}(X)\)</span> if using the second DR estimator for repeated cross-sections.</li>
</ul>
</li>
<li>
<strong>Plug into the DR moment.</strong><br>
Replace <span class="math inline">\(p\)</span> with <span class="math inline">\(\hat{\pi}\)</span> and <span class="math inline">\(m_{d,t}\)</span> with <span class="math inline">\(\hat{m}_{d,t}\)</span> in the chosen DR formula (panel or repeated cross-sections).</li>
</ol>
<p>Because these estimators are DR, if either the propensity score is well specified or the outcome regressions for the comparison group are well specified, consistency is assured.</p>
<ol start="2" style="list-style-type: decimal">
<li><strong>Improving efficiency and inference: special parametric choices</strong></li>
</ol>
<p>It is sometimes desirable to construct DR DID estimators that are <em>also</em> “DR for inference,” meaning that the asymptotic variance does not depend on which portion of the model is correct. Achieving that typically requires carefully choosing first-stage estimators so that the extra “estimation effect” vanishes in the influence-function calculations. Concretely:</p>
<ul>
<li>
<strong>Propensity score:</strong> Use a logistic regression (and a special <em>inverse probability tilting</em> estimator) proposed by <span class="citation">Graham, Xavier Pinto, and Egel (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-graham2012inverse">2012</a>)</span>.</li>
<li>
<strong>Outcome regressions:</strong> Use linear regressions with specific weights (or with OLS for the treated group).</li>
</ul>
<p>One then obtains:</p>
<ul>
<li>
<p><strong>For panel data:</strong> <span class="math display">\[
    \hat{\tau}^{\mathrm{dr,p}}_{\mathrm{imp}}
    \;=\;
    \frac1n \sum_{i=1}^n
      \Bigl[
         w_{1}^{\mathrm{p}}(D_i) \;-\; w_{0}^{\mathrm{p}}\bigl(D_i,X_i;\,\hat{\gamma}^{\mathrm{ipt}}\bigr)
      \Bigr]
      \Bigl[
        \bigl(Y_{i1}-Y_{i0}\bigr)
        \;-\;
        \hat{\mu}^{\mathrm{lin,p}}_{0,\Delta}\bigl(X_i;\,\hat{\beta}^{\mathrm{wls,p}}_{0,\Delta}\bigr)
      \Bigr],
  \]</span> where <span class="math inline">\(\hat{\gamma}^{\mathrm{ipt}}\)</span> is the “inverse probability tilting” estimate for the logit propensity score, and <span class="math inline">\(\hat{\beta}^{\mathrm{wls,p}}_{0,\Delta}\)</span> is a weighted least squares estimate for the difference regressions of the comparison group. Under suitable regularity conditions, this estimator:</p>
<ol style="list-style-type: decimal">
<li><p>Remains consistent if either the logit model or the linear outcome model for <span class="math inline">\(\Delta Y\)</span> in the control group is correct.</p></li>
<li><p>Has an asymptotic distribution that does <em>not</em> depend on which model is correct (thus simplifying inference).</p></li>
<li><p>Achieves the semiparametric efficiency bound if both models are correct.</p></li>
</ol>
</li>
</ul>
<!-- --><ul>
<li>
<strong>For repeated cross-sections</strong>, one can analogously use logistic-based tilting for the propensity score and weighted/ordinary least squares for the control/treated outcome regressions. The <em>second</em> DR estimator <span class="math inline">\(\hat{\tau}^{\mathrm{dr,rc}}_{2}\)</span> that models the treated group’s outcomes as well can, under correct specification of <em>all</em> models, achieve local efficiency.</li>
</ul>
<hr>
</div>
<div id="large-sample-properties-2" class="section level4" number="30.8.12.6">
<h4>
<span class="header-section-number">30.8.12.6</span> Large-Sample Properties<a class="anchor" aria-label="anchor" href="#large-sample-properties-2"><i class="fas fa-link"></i></a>
</h4>
<p>Assume mild regularity conditions for consistency and asymptotic normality (e.g., overlapping support, identifiability of the pseudo-true parameters for the first-step models, and suitable rates of convergence) <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sant2020doubly">Sant’Anna and Zhao 2020</a>)</span>.</p>
<ol style="list-style-type: decimal">
<li><p><strong>Double Robust Consistency.</strong><br>
Each proposed DR DID estimator is consistent for <span class="math inline">\(\tau\)</span> if either (a) <span class="math inline">\(\hat{p}(X)\)</span> is consistent for <span class="math inline">\(p(X)\)</span>, or (b) the relevant outcome regressions <span class="math inline">\(\hat{m}_{0,t}(X)\)</span> are consistent for <span class="math inline">\(m_{0,t}(X)\)</span>. Thus, we say the estimator is <em>doubly robust</em> to misspecification.</p></li>
<li><p><strong>Asymptotic Normality.</strong><br><span class="math display">\[
    \sqrt{n}\bigl(\,\hat{\tau}^{\mathrm{dr}} \,-\, \tau \bigr)
    \;\;\xrightarrow{d}\;\;
    N\bigl(\,0,\;\mathrm{Var}(\text{IF})\bigr),
\]</span> where <span class="math inline">\(\mathrm{Var}(\text{IF})\)</span> depends on which part(s) of the nuisance models are consistently estimated. In general, one must account for the variance contribution of the first-stage estimation. But under certain special constructions (the “improved DR” approaches with inverse probability tilting and specialized weighting), the first-stage does not contribute additional variance, making inference simpler.</p></li>
<li><p><strong>Local Semiparametric Efficiency.</strong><br>
If <em>both</em> the propensity score model and the outcome-regression models are correct, the estimator’s influence function matches the <em>efficient influence function</em>, hence achieving the semiparametric efficiency bound. In repeated cross-sections, the DR estimator that also models the treated group’s outcomes (namely <span class="math inline">\(\tau^{\mathrm{dr,rc}}_2\)</span>) is the one that can achieve local efficiency.</p></li>
</ol>
<hr>
</div>
<div id="practical-implementation" class="section level4" number="30.8.12.7">
<h4>
<span class="header-section-number">30.8.12.7</span> Practical Implementation<a class="anchor" aria-label="anchor" href="#practical-implementation"><i class="fas fa-link"></i></a>
</h4>
<p>In practice, the recommended workflow is:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Specify (and estimate) a flexible working model</strong> for the propensity score. A logistic regression with the inverse-probability-tilting approach is often a good default, as it simplifies subsequent steps if one wants DR inference.</li>
<li>
<strong>Model the outcome of the comparison group</strong> over time. For panel data, one can directly model <span class="math inline">\(\Delta Y\)</span>. For repeated cross-sections, one typically models <span class="math inline">\(\{m_{0,t}(X)\}_{t=0,1}\)</span>.</li>
<li>
<strong>(Optional) Model the outcome of the treated group</strong> if seeking the local-efficiency version of DR DID in repeated cross-sections.</li>
<li>
<strong>Form the DR DID estimator</strong> by plugging the fitted models from steps (1)–(3) into the chosen DR moment expression.</li>
</ol>
<p><strong>Inference</strong> can often be carried out by taking the empirical variance of the estimated influence function: <span class="math display">\[
   \hat{V} \;=\; \frac{1}{n}\sum_{i=1}^n \hat{\eta}_i^2,
\]</span> where <span class="math inline">\(\hat{\eta}_i\)</span> is the evaluator’s best estimate of the influence function for observation <span class="math inline">\(i\)</span>. Under certain “improved DR” constructions, the same <span class="math inline">\(\hat{\eta}_i\)</span> works regardless of which part of the model is correct.</p>
<hr>
<div class="sourceCode" id="cb819"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">'base_stagg'</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bcallaway11.github.io/did/">did</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">drdid_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bcallaway11.github.io/did/reference/att_gt.html">att_gt</a></span><span class="op">(</span></span>
<span>    yname <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    tname <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    idname <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    gname <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    xformla <span class="op">=</span> <span class="op">~</span> <span class="va">x1</span>,</span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://bcallaway11.github.io/did/reference/aggte.html">aggte</a></span><span class="op">(</span><span class="va">drdid_result</span>, type <span class="op">=</span> <span class="st">"simple"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; aggte(MP = drdid_result, type = "simple")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Reference: Callaway, Brantly and Pedro H.C. Sant'Anna.  "Difference-in-Differences with Multiple Time Periods." Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. &lt;https://doi.org/10.1016/j.jeconom.2020.12.001&gt;, &lt;https://arxiv.org/abs/1803.09015&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      ATT    Std. Error     [ 95%  Conf. Int.] </span></span>
<span><span class="co">#&gt;  -0.8636        0.5869     -2.014      0.2867 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: `*' confidence band does not cover 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Control Group:  Never Treated,  Anticipation Periods:  0</span></span>
<span><span class="co">#&gt; Estimation Method:  Doubly Robust</span></span>
<span><span class="va">agg.es</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bcallaway11.github.io/did/reference/aggte.html">aggte</a></span><span class="op">(</span><span class="va">drdid_result</span>, type <span class="op">=</span> <span class="st">"dynamic"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://bcallaway11.github.io/did/reference/ggdid.html">ggdid</a></span><span class="op">(</span><span class="va">agg.es</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.2-did-other_files/figure-html/unnamed-chunk-33-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb820"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">agg.gs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bcallaway11.github.io/did/reference/aggte.html">aggte</a></span><span class="op">(</span><span class="va">drdid_result</span>, type <span class="op">=</span> <span class="st">"group"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://bcallaway11.github.io/did/reference/ggdid.html">ggdid</a></span><span class="op">(</span><span class="va">agg.gs</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.2-did-other_files/figure-html/unnamed-chunk-33-2.png" width="90%" style="display: block; margin: auto;"></div>
<hr>
</div>
</div>
<div id="nonlinear-difference-in-differences" class="section level3" number="30.8.13">
<h3>
<span class="header-section-number">30.8.13</span> Nonlinear Difference-in-Differences<a class="anchor" aria-label="anchor" href="#nonlinear-difference-in-differences"><i class="fas fa-link"></i></a>
</h3>
<p>Traditional Difference-in-Differences methods typically rely on linear models with strong assumptions like constant treatment effects and homogeneous trends across treatment groups. These assumptions often fail in real-world data — especially when outcomes are <strong>binary</strong>, <strong>fractional</strong>, or <strong>counts</strong>, such as:</p>
<ul>
<li>Employment status (binary),</li>
<li>Proportion of customers who churned (fraction),</li>
<li>Number of crimes in a neighborhood (count).</li>
</ul>
<p>In these cases, the <strong>linear parallel trends</strong> assumption may be inappropriate. This section develops an advanced, flexible framework for nonlinear DiD estimation with staggered interventions <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-wooldridge2023simple">Wooldridge 2023</a>)</span>.</p>
<hr>
<div id="overview-of-framework" class="section level4" number="30.8.13.1">
<h4>
<span class="header-section-number">30.8.13.1</span> Overview of Framework<a class="anchor" aria-label="anchor" href="#overview-of-framework"><i class="fas fa-link"></i></a>
</h4>
<p>We consider a panel dataset where units are observed over <span class="math inline">\(T\)</span> time periods. Units become treated at various times (staggered rollout), and the goal is to estimate <a href="sec-causal-inference.html#sec-average-treatment-effect-on-the-treated">Average Treatment Effect on the Treated</a> (ATT) at different times.</p>
<p>Let <span class="math inline">\(Y_{it}(g)\)</span> denote the potential outcome at time <span class="math inline">\(t\)</span> if unit <span class="math inline">\(i\)</span> were first treated in period <span class="math inline">\(g\)</span>, with <span class="math inline">\(g = q, \ldots, T\)</span> or <span class="math inline">\(g = \infty\)</span> (never treated). Define the ATT for cohort <span class="math inline">\(g\)</span> at time <span class="math inline">\(r \geq g\)</span> as:</p>
<p><span class="math display">\[
\tau_{gr} = \mathbb{E}\left[Y_{ir}(g) - Y_{ir}(\infty) \mid D_g = 1\right]
\]</span></p>
<p>Here, <span class="math inline">\(D_g = 1\)</span> indicates that unit <span class="math inline">\(i\)</span> was first treated in period <span class="math inline">\(g\)</span>.</p>
<p>Rather than assuming linear conditional expectations of untreated outcomes, we posit a <strong>nonlinear conditional mean</strong> using a known, strictly increasing function <span class="math inline">\(G(\cdot)\)</span>:</p>
<p><span class="math display">\[
\mathbb{E}[Y_{it}(0) \mid D, X] = G\left( \alpha + \sum_{g=q}^{T} \beta_g D_g + X \kappa + \sum_{g=q}^{T} (D_g \cdot X)\eta_g + \gamma_t + X \pi_t \right)
\]</span></p>
<p>This formulation nests logistic and Poisson mean structures, and allows us to handle various limited dependent variables.</p>
<hr>
</div>
<div id="assumptions-2" class="section level4" number="30.8.13.2">
<h4>
<span class="header-section-number">30.8.13.2</span> Assumptions<a class="anchor" aria-label="anchor" href="#assumptions-2"><i class="fas fa-link"></i></a>
</h4>
<p>We require the following identification assumptions:</p>
<ul>
<li><p><strong>Conditional No Anticipation:</strong> <span class="math display">\[
\mathbb{E}[Y_{it}(g) \mid D_g = 1, X] = \mathbb{E}[Y_{it}(\infty) \mid D_g = 1, X], \quad \forall t &lt; g
\]</span></p></li>
<li>
<p><strong>Conditional Index Parallel Trends:</strong> The untreated mean trends are parallel in a transformed index space: <span class="math display">\[
\mathbb{E}[Y_{it}(\infty) \mid D, X] = G(\text{linear index in } D, X, t)
\]</span></p>
<ul>
<li>
<span class="math inline">\(G(\cdot)\)</span> is a <strong>known</strong>, strictly increasing function (e.g., <span class="math inline">\(\exp(\cdot)\)</span> for Poisson)</li>
</ul>
</li>
</ul>
<p>These assumptions are weaker and more realistic than linear Parallel Trends, especially when outcomes are constrained.</p>
<hr>
</div>
<div id="estimation-2" class="section level4" number="30.8.13.3">
<h4>
<span class="header-section-number">30.8.13.3</span> Estimation<a class="anchor" aria-label="anchor" href="#estimation-2"><i class="fas fa-link"></i></a>
</h4>
<p><strong>Step 1: Imputation Estimator</strong></p>
<ol style="list-style-type: decimal">
<li>Estimate Parameters Using Untreated Observations Only:</li>
</ol>
<p>Use all <span class="math inline">\((i,t)\)</span> such that unit <span class="math inline">\(i\)</span> is untreated at <span class="math inline">\(t\)</span> (i.e., <span class="math inline">\(W_{it} = 0\)</span>). Fit the nonlinear regression model: <span class="math display">\[ Y_{it} = G\left(\alpha + \sum_g \beta_g D_g + X_i \kappa + D_g X_i \eta_g + \gamma_t + X_i \pi_t\right) + \varepsilon_{it} \]</span></p>
<ol start="2" style="list-style-type: decimal">
<li>Impute Counterfactual Outcomes for Treated Observations:</li>
</ol>
<p>For treated observations <span class="math inline">\((i,t)\)</span> with <span class="math inline">\(W_{it}=1\)</span>, predict <span class="math inline">\(\widehat{Y}_{it}(0)\)</span> using the model from Step 1.</p>
<ol start="3" style="list-style-type: decimal">
<li>Compute ATT for Each Cohort <span class="math inline">\(g\)</span> and Time <span class="math inline">\(r\)</span>:</li>
</ol>
<p><span class="math display">\[ \hat{\tau}_{gr} = \frac{1}{N_{gr}} \sum_{i: D_g=1} \left( Y_{ir} - \widehat{Y}_{ir}(0) \right) \]</span></p>
<hr>
<p><strong>Step 2: Pooled QMLE Estimator (Equivalent When Using Canonical Link)</strong></p>
<ol style="list-style-type: decimal">
<li>Fit Model Using All Observations:</li>
</ol>
<p>Fit the pooled nonlinear model across all units and time: <span class="math display">\[ Y_{it} = G\left(\alpha + \sum_g \beta_g D_g + X_i \kappa + D_g X_i \eta_g + \gamma_t + X_i \pi_t + \delta_r \cdot W_{it} + W_{it} X_i \xi \right) + \varepsilon_{it} \]</span></p>
<p>Where:</p>
<ul>
<li><p><span class="math inline">\(W_{it} = 1\)</span> if unit <span class="math inline">\(i\)</span> is treated at time <span class="math inline">\(t\)</span></p></li>
<li><p><span class="math inline">\(W_{it} = 0\)</span> otherwise</p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Estimate <span class="math inline">\(\delta_r\)</span> as the ATT for cohort <span class="math inline">\(g\)</span> in period <span class="math inline">\(r\)</span>:</li>
</ol>
<ul>
<li>
<span class="math inline">\(\delta_r\)</span> is interpreted as an event-time ATT</li>
<li>This estimator is consistent when <span class="math inline">\(G^{-1}(\cdot)\)</span> is the canonical link (e.g., log link for Poisson)</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>Average Partial Effect (APE) for ATT:</li>
</ol>
<p><span class="math display">\[ \hat{\tau}_{gr} = \frac{1}{N_g} \sum_{i: D_g=1} \left[ G\left( X_i\beta + \delta_r + \ldots \right) - G\left( X_i\beta + \ldots \right) \right] \]</span></p>
<p><strong>Canonical Links in Practice</strong></p>
<div class="inline-table"><table style="width:99%;" class="table table-sm">
<colgroup>
<col width="34%">
<col width="16%">
<col width="48%">
</colgroup>
<thead><tr class="header">
<th>Conditional Mean</th>
<th>LEF Density</th>
<th>Suitable For</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(G(z) = z\)</span></td>
<td>Normal</td>
<td>Any response</td>
</tr>
<tr class="even">
<td><span class="math inline">\(G(z) = \exp(z)\)</span></td>
<td>Poisson</td>
<td>Nonnegative/counts, no natural upper bound</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(G(z) = \text{logit}^{-1}(z)\)</span></td>
<td>Binomial</td>
<td>Nonnegative, known upper bound</td>
</tr>
<tr class="even">
<td><span class="math inline">\(G(z) = \text{logit}^{-1}(z)\)</span></td>
<td>Bernoulli</td>
<td>Binary or fractional responses</td>
</tr>
</tbody>
</table></div>
<hr>
</div>
<div id="inference-2" class="section level4" number="30.8.13.4">
<h4>
<span class="header-section-number">30.8.13.4</span> Inference<a class="anchor" aria-label="anchor" href="#inference-2"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>Standard errors can be obtained via the delta method or bootstrap</li>
<li>Cluster-robust standard errors by unit are preferred</li>
<li>When using QMLE, the estimates are valid under correct mean specification, regardless of higher moments</li>
</ul>
<p>When Do Imputation and Pooled Methods Match?</p>
<ul>
<li>They are numerically identical when:
<ul>
<li>Estimating with the canonical link function</li>
<li>Model is correctly specified</li>
<li>Same data used for both (i.e., <code>W_it = 0</code> and pooled)</li>
</ul>
</li>
</ul>
<hr>
</div>
<div id="application-using-etwfe" class="section level4" number="30.8.13.5">
<h4>
<span class="header-section-number">30.8.13.5</span> Application Using <code>etwfe</code><a class="anchor" aria-label="anchor" href="#application-using-etwfe"><i class="fas fa-link"></i></a>
</h4>
<p>The <code>etwfe</code> package provides a unified, user-friendly interface for estimating staggered treatment effects using <strong>generalized linear models</strong>. It is particularly well-suited for nonlinear outcomes, such as <strong>binary</strong>, <strong>fractional</strong>, or <strong>count</strong> data.</p>
<p>We’ll now demonstrate how to apply <code>etwfe</code> to estimate <a href="sec-causal-inference.html#sec-average-treatment-effect-on-the-treated">Average Treatment Effect on the Treated</a> (ATT) under a nonlinear DiD framework using a Poisson model. This aligns with the exponential conditional mean assumption discussed earlier.</p>
<ol style="list-style-type: decimal">
<li>Install and load packages</li>
</ol>
<div class="sourceCode" id="cb821"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># --- 1) Load packages ---</span></span>
<span><span class="co"># install.packages("fixest")</span></span>
<span><span class="co"># install.packages("marginaleffects")</span></span>
<span><span class="co"># install.packages("etwfe")</span></span>
<span><span class="co"># install.packages("ggplot2")</span></span>
<span><span class="co"># install.packages("modelsummary")</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://grantmcdermott.com/etwfe/">etwfe</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/">marginaleffects</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://modelsummary.com">modelsummary</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Simulate a known data-generating process</li>
</ol>
<p>Imagine a <strong>multi-period business panel</strong> where each “unit” is a <em>regional store</em> or <em>branch</em> of a large retail chain. Half of these stores eventually receive a new <em>marketing analytics platform</em> at some known time, which in principle changes their performance metric (e.g., weekly log sales). The other half <em>never</em> receive the platform, functioning as a “never-treated” control group.</p>
<ul>
<li><p>We have <span class="math inline">\(N=200\)</span> stores (half eventually treated, half never treated).</p></li>
<li><p>Each store is observed over <span class="math inline">\(T=10\)</span> time periods (e.g., quarters or years).</p></li>
<li><p>The <em>true</em> “treatment effect on the treated” is constant at <span class="math inline">\(\delta = -0.05\)</span> for all <em>post</em>-treatment times. (Interpretation: the new marketing platform <em>reduced</em> log-sales by about 5 percent, though in real life one might expect a positive effect!)</p></li>
<li><p>Some stores are “staggered” in the sense that they adopt in different periods. We’ll randomly draw their adoption date from <span class="math inline">\(\{4,5,6\}\)</span>. Others never adopt at all.</p></li>
<li><p>We include store-level intercepts, time intercepts, and idiosyncratic noise to make it more realistic.</p></li>
</ul>
<div class="sourceCode" id="cb822"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># --- 2) Simulate Data ---</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">200</span>   <span class="co"># number of stores</span></span>
<span><span class="cn">T</span> <span class="op">&lt;-</span> <span class="fl">10</span>    <span class="co"># number of time periods</span></span>
<span><span class="va">id</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span>, each <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="cn">T</span>, times <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mark half of them as eventually treated, half never</span></span>
<span><span class="va">treated_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span>, size <span class="op">=</span> <span class="va">N</span><span class="op">/</span><span class="fl">2</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">is_treated</span>  <span class="op">&lt;-</span> <span class="va">id</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html">%in%</a></span> <span class="va">treated_ids</span></span>
<span></span>
<span><span class="co"># Among the treated, pick an adoption time 4,5, or 6 at random</span></span>
<span><span class="va">adopt_time_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">5</span>,<span class="fl">6</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">treated_ids</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">adopt_time</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">N</span><span class="op">)</span> <span class="co"># 0 means "never"</span></span>
<span><span class="va">adopt_time</span><span class="op">[</span><span class="va">treated_ids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">adopt_time_vec</span></span>
<span></span>
<span><span class="co"># Store effects, time effects, control variable, noise</span></span>
<span><span class="va">alpha_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, mean <span class="op">=</span> <span class="fl">2</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">[</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">gamma_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="cn">T</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">[</span><span class="va">time</span><span class="op">]</span></span>
<span><span class="va">xvar</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">*</span><span class="cn">T</span>, mean <span class="op">=</span> <span class="fl">1</span>, sd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="va">beta</span>    <span class="op">&lt;-</span> <span class="fl">0.10</span></span>
<span><span class="va">noise</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">*</span><span class="cn">T</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># True treatment effect = -0.05 for time &gt;= adopt_time</span></span>
<span><span class="va">true_ATT</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">0.05</span></span>
<span><span class="va">D_it</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">(</span><span class="va">adopt_time</span><span class="op">[</span><span class="va">id</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">time</span> <span class="op">&gt;=</span> <span class="va">adopt_time</span><span class="op">[</span><span class="va">id</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Final outcome in logs:</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">alpha_i</span> <span class="op">+</span> <span class="va">gamma_t</span> <span class="op">+</span> <span class="va">beta</span><span class="op">*</span><span class="va">xvar</span> <span class="op">+</span> <span class="va">true_ATT</span><span class="op">*</span><span class="va">D_it</span> <span class="op">+</span> <span class="va">noise</span></span>
<span></span>
<span><span class="co"># Put it all in a data frame</span></span>
<span><span class="va">simdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    id         <span class="op">=</span> <span class="va">id</span>,</span>
<span>    time       <span class="op">=</span> <span class="va">time</span>,</span>
<span>    adopt_time <span class="op">=</span> <span class="va">adopt_time</span><span class="op">[</span><span class="va">id</span><span class="op">]</span>,</span>
<span>    treat      <span class="op">=</span> <span class="va">D_it</span>,</span>
<span>    xvar       <span class="op">=</span> <span class="va">xvar</span>,</span>
<span>    logY       <span class="op">=</span> <span class="va">y</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id time adopt_time treat      xvar     logY</span></span>
<span><span class="co">#&gt; 1  1    1          6     0 1.4024608 1.317343</span></span>
<span><span class="co">#&gt; 2  1    2          6     0 0.5226395 2.273805</span></span>
<span><span class="co">#&gt; 3  1    3          6     0 1.3357914 1.517705</span></span>
<span><span class="co">#&gt; 4  1    4          6     0 1.2101680 1.759481</span></span>
<span><span class="co">#&gt; 5  1    5          6     0 0.9953143 1.771928</span></span>
<span><span class="co">#&gt; 6  1    6          6     1 0.8893066 1.439206</span></span></code></pre></div>
<p>In this business setting, you can imagine that <code>logY</code> is the natural log of revenue, sales, or another KPI, and <code>xvar</code> is a log of local population, number of competitor stores in the region, or similar.</p>
<ol start="3" style="list-style-type: decimal">
<li>Estimate with <code>etwfe</code>
</li>
</ol>
<p>We want to test whether the new marketing analytics platform has changed the log outcome. We will use <code>etwfe</code>:</p>
<ul>
<li><p><code>fml = logY ~ xvar</code> says that <code>logY</code> is the outcome, <code>xvar</code> is a control.</p></li>
<li><p><code>tvar = time</code> is the time variable.</p></li>
<li><p><code>gvar = adopt_time</code> is the <em>group/cohort</em> variable (the “first treatment time” or 0 if never).</p></li>
<li><p><code>vcov = ~id</code> clusters standard errors at the store level.</p></li>
<li><p><code>cgroup = "never"</code>: We specify that the never-treated units form our comparison group. This ensures we can see <em>pre-treatment</em> and <em>post-treatment</em> dynamic effects in an event-study plot.</p></li>
</ul>
<div class="sourceCode" id="cb823"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># --- 3) Estimate with etwfe ---</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://grantmcdermott.com/etwfe/reference/etwfe.html">etwfe</a></span><span class="op">(</span></span>
<span>    fml    <span class="op">=</span> <span class="va">logY</span> <span class="op">~</span> <span class="va">xvar</span>,</span>
<span>    tvar   <span class="op">=</span> <span class="va">time</span>,</span>
<span>    gvar   <span class="op">=</span> <span class="va">adopt_time</span>,</span>
<span>    data   <span class="op">=</span> <span class="va">simdat</span>,</span>
<span>    <span class="co"># xvar   = moderator, # Heterogenous Treatment Effects</span></span>
<span>    vcov   <span class="op">=</span> <span class="op">~</span><span class="va">id</span>,</span>
<span>    cgroup <span class="op">=</span> <span class="st">"never"</span>  <span class="co"># so that never-treated are the baseline</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Nothing fancy will appear in the raw coefficient list because it’s fully “saturated” with interactions. The real prize is in the aggregated treatment effects, which we’ll obtain next.</p>
<ol start="4" style="list-style-type: decimal">
<li>Recover the <a href="sec-causal-inference.html#sec-average-treatment-effect-on-the-treated">ATT</a>
</li>
</ol>
<p>Here’s a <em>single-number</em> estimate of the overall average effect on the treated, across all times and cohorts:</p>
<div class="sourceCode" id="cb824"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># --- 4) Single-number ATT ---</span></span>
<span><span class="va">ATT_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://grantmcdermott.com/etwfe/reference/emfx.html">emfx</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"simple"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/print.html">print</a></span><span class="op">(</span><span class="va">ATT_est</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  .Dtreat Estimate Std. Error     z Pr(&gt;|z|)    S  2.5 %  97.5 %</span></span>
<span><span class="co">#&gt;     TRUE  -0.0707     0.0178 -3.97   &lt;0.001 13.8 -0.106 -0.0358</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Term: .Dtreat</span></span>
<span><span class="co">#&gt; Type:  response </span></span>
<span><span class="co">#&gt; Comparison: TRUE - FALSE</span></span></code></pre></div>
<p>You should see an estimate near the <em>true</em> <span class="math inline">\(-0.05\)</span>.</p>
<ol start="5" style="list-style-type: decimal">
<li>Recover an event-study pattern of dynamic effects</li>
</ol>
<p>To check pre- and post-treatment dynamics, we ask for an <strong>event study</strong> via <code>type = "event"</code>. This shows how the outcome evolves <em>around</em> the adoption time. Negative “event” values correspond to pre-treatment, while nonnegative “event” values are post-treatment.</p>
<div class="sourceCode" id="cb825"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># --- 5) Event-study estimates ---</span></span>
<span><span class="va">mod_es</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://grantmcdermott.com/etwfe/reference/emfx.html">emfx</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"event"</span><span class="op">)</span></span>
<span><span class="va">mod_es</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  event Estimate Std. Error      z Pr(&gt;|z|)    S   2.5 %   97.5 %</span></span>
<span><span class="co">#&gt;     -5 -0.04132     0.0467 -0.885  0.37628  1.4 -0.1329  0.05022</span></span>
<span><span class="co">#&gt;     -4 -0.01120     0.0282 -0.396  0.69180  0.5 -0.0666  0.04416</span></span>
<span><span class="co">#&gt;     -3  0.01747     0.0226  0.772  0.43999  1.2 -0.0269  0.06180</span></span>
<span><span class="co">#&gt;     -2 -0.00912     0.0193 -0.472  0.63686  0.7 -0.0470  0.02873</span></span>
<span><span class="co">#&gt;     -1  0.00000         NA     NA       NA   NA      NA       NA</span></span>
<span><span class="co">#&gt;      0 -0.08223     0.0206 -3.995  &lt; 0.001 13.9 -0.1226 -0.04188</span></span>
<span><span class="co">#&gt;      1 -0.06108     0.0209 -2.926  0.00344  8.2 -0.1020 -0.02016</span></span>
<span><span class="co">#&gt;      2 -0.07094     0.0225 -3.159  0.00158  9.3 -0.1150 -0.02692</span></span>
<span><span class="co">#&gt;      3 -0.07383     0.0189 -3.906  &lt; 0.001 13.4 -0.1109 -0.03679</span></span>
<span><span class="co">#&gt;      4 -0.07330     0.0334 -2.196  0.02808  5.2 -0.1387 -0.00788</span></span>
<span><span class="co">#&gt;      5 -0.06527     0.0285 -2.294  0.02178  5.5 -0.1210 -0.00951</span></span>
<span><span class="co">#&gt;      6 -0.05661     0.0402 -1.407  0.15953  2.6 -0.1355  0.02227</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Term: .Dtreat</span></span>
<span><span class="co">#&gt; Type:  response </span></span>
<span><span class="co">#&gt; Comparison: TRUE - FALSE</span></span>
<span></span>
<span></span>
<span><span class="co"># Renaming function to replace ".Dtreat" with something more meaningful</span></span>
<span><span class="va">rename_fn</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">old_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">new_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">".Dtreat"</span>, <span class="st">"Period post treatment ="</span>, <span class="va">old_names</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">new_names</span>, <span class="va">old_names</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://modelsummary.com/man/modelsummary.html">modelsummary</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="va">mod_es</span><span class="op">)</span>,</span>
<span>  shape       <span class="op">=</span> <span class="va">term</span><span class="op">:</span><span class="va">event</span><span class="op">:</span><span class="va">statistic</span> <span class="op">~</span> <span class="va">model</span>,</span>
<span>  coef_rename <span class="op">=</span> <span class="va">rename_fn</span>,</span>
<span>  gof_omit    <span class="op">=</span> <span class="st">"Adj|Within|IC|RMSE"</span>,</span>
<span>  stars       <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  title       <span class="op">=</span> <span class="st">"Event study"</span>,</span>
<span>  notes       <span class="op">=</span> <span class="st">"Std. errors are clustered at the id level"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<!-- preamble start -->

    <script>

      function styleCell_80043twey8ariertttmj(i, j, css_id) {
          var table = document.getElementById("tinytable_80043twey8ariertttmj");
          var cell = table.rows[i]?.cells[j];  // Safe navigation to avoid errors
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_80043twey8ariertttmj');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_80043twey8ariertttmj(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_80043twey8ariertttmj");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: 27, j: 1 },  ], css_id: 'tinytable_css_5t12qi7qz3m3xx62317t',}, 
          { positions: [ { i: 23, j: 1 },  ], css_id: 'tinytable_css_1x9wsbu4y5x2j8n1qvnk',}, 
          { positions: [ { i: 1, j: 1 }, { i: 2, j: 1 }, { i: 3, j: 1 }, { i: 4, j: 1 }, { i: 5, j: 1 }, { i: 6, j: 1 }, { i: 7, j: 1 }, { i: 8, j: 1 }, { i: 9, j: 1 }, { i: 10, j: 1 }, { i: 11, j: 1 }, { i: 12, j: 1 }, { i: 13, j: 1 }, { i: 14, j: 1 }, { i: 15, j: 1 }, { i: 16, j: 1 }, { i: 17, j: 1 }, { i: 18, j: 1 }, { i: 19, j: 1 }, { i: 20, j: 1 }, { i: 21, j: 1 }, { i: 22, j: 1 }, { i: 24, j: 1 }, { i: 25, j: 1 }, { i: 26, j: 1 },  ], css_id: 'tinytable_css_x2fc96xpgrl9xynrqt4y',}, 
          { positions: [ { i: 0, j: 1 },  ], css_id: 'tinytable_css_q19o1lv0k43caqv9jrwy',}, 
          { positions: [ { i: 27, j: 0 },  ], css_id: 'tinytable_css_d7l1huj5c06j9l4pcs82',}, 
          { positions: [ { i: 23, j: 0 },  ], css_id: 'tinytable_css_si9yxwen8zi5ryfpy76w',}, 
          { positions: [ { i: 1, j: 0 }, { i: 2, j: 0 }, { i: 3, j: 0 }, { i: 4, j: 0 }, { i: 5, j: 0 }, { i: 6, j: 0 }, { i: 7, j: 0 }, { i: 8, j: 0 }, { i: 9, j: 0 }, { i: 10, j: 0 }, { i: 11, j: 0 }, { i: 12, j: 0 }, { i: 13, j: 0 }, { i: 14, j: 0 }, { i: 15, j: 0 }, { i: 16, j: 0 }, { i: 17, j: 0 }, { i: 18, j: 0 }, { i: 19, j: 0 }, { i: 20, j: 0 }, { i: 21, j: 0 }, { i: 22, j: 0 }, { i: 24, j: 0 }, { i: 25, j: 0 }, { i: 26, j: 0 },  ], css_id: 'tinytable_css_q7jtsqc1o5qi594xmgz8',}, 
          { positions: [ { i: 0, j: 0 },  ], css_id: 'tinytable_css_n6i215vp9gl7hmx3w4w3',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_80043twey8ariertttmj(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script><style>
      /* tinytable css entries after */
      .table td.tinytable_css_5t12qi7qz3m3xx62317t, .table th.tinytable_css_5t12qi7qz3m3xx62317t { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_1x9wsbu4y5x2j8n1qvnk, .table th.tinytable_css_1x9wsbu4y5x2j8n1qvnk { text-align: center; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_x2fc96xpgrl9xynrqt4y, .table th.tinytable_css_x2fc96xpgrl9xynrqt4y { text-align: center; }
      .table td.tinytable_css_q19o1lv0k43caqv9jrwy, .table th.tinytable_css_q19o1lv0k43caqv9jrwy { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_d7l1huj5c06j9l4pcs82, .table th.tinytable_css_d7l1huj5c06j9l4pcs82 { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_si9yxwen8zi5ryfpy76w, .table th.tinytable_css_si9yxwen8zi5ryfpy76w { text-align: left; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_q7jtsqc1o5qi594xmgz8, .table th.tinytable_css_q7jtsqc1o5qi594xmgz8 { text-align: left; }
      .table td.tinytable_css_n6i215vp9gl7hmx3w4w3, .table th.tinytable_css_n6i215vp9gl7hmx3w4w3 { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
<div class="container">
      <div class="inline-table"><table class="table table-borderless" id="tinytable_80043twey8ariertttmj" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
<thead>
<caption>Event study</caption>
              <tr>
<th scope="col"> </th>
                <th scope="col">(1)</th>
              </tr>
</thead>
<tfoot>
<tr><td colspan="2">+ p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001</td></tr>
<tr><td colspan="2">Std. errors are clustered at the id level</td></tr>
</tfoot>
<tbody>
<tr>
<td>Period post treatment = -5</td>
                  <td>-0.041</td>
                </tr>
<tr>
<td></td>
                  <td>(0.047)</td>
                </tr>
<tr>
<td>Period post treatment = -4</td>
                  <td>-0.011</td>
                </tr>
<tr>
<td></td>
                  <td>(0.028)</td>
                </tr>
<tr>
<td>Period post treatment = -3</td>
                  <td>0.017</td>
                </tr>
<tr>
<td></td>
                  <td>(0.023)</td>
                </tr>
<tr>
<td>Period post treatment = -2</td>
                  <td>-0.009</td>
                </tr>
<tr>
<td></td>
                  <td>(0.019)</td>
                </tr>
<tr>
<td>Period post treatment = -1</td>
                  <td>0.000</td>
                </tr>
<tr>
<td>Period post treatment = 0</td>
                  <td>-0.082***</td>
                </tr>
<tr>
<td></td>
                  <td>(0.021)</td>
                </tr>
<tr>
<td>Period post treatment = 1</td>
                  <td>-0.061**</td>
                </tr>
<tr>
<td></td>
                  <td>(0.021)</td>
                </tr>
<tr>
<td>Period post treatment = 2</td>
                  <td>-0.071**</td>
                </tr>
<tr>
<td></td>
                  <td>(0.022)</td>
                </tr>
<tr>
<td>Period post treatment = 3</td>
                  <td>-0.074***</td>
                </tr>
<tr>
<td></td>
                  <td>(0.019)</td>
                </tr>
<tr>
<td>Period post treatment = 4</td>
                  <td>-0.073*</td>
                </tr>
<tr>
<td></td>
                  <td>(0.033)</td>
                </tr>
<tr>
<td>Period post treatment = 5</td>
                  <td>-0.065*</td>
                </tr>
<tr>
<td></td>
                  <td>(0.028)</td>
                </tr>
<tr>
<td>Period post treatment = 6</td>
                  <td>-0.057</td>
                </tr>
<tr>
<td></td>
                  <td>(0.040)</td>
                </tr>
<tr>
<td>Num.Obs.</td>
                  <td>2000</td>
                </tr>
<tr>
<td>R2</td>
                  <td>0.235</td>
                </tr>
<tr>
<td>FE..adopt_time</td>
                  <td>X</td>
                </tr>
<tr>
<td>FE..time</td>
                  <td>X</td>
                </tr>
</tbody>
</table></div>
</div>
<!-- hack to avoid NA insertion in last line -->
<ul>
<li><p>By default, this will return events from (roughly) the earliest pre-treatment period up to the maximum possible post-treatment period in your data, using <em>never-treated</em> as the comparison group.</p></li>
<li><p>Inspect the estimates and confidence intervals. Ideally, pre-treatment estimates should be near 0, and post-treatment estimates near <span class="math inline">\(-0.05\)</span>.</p></li>
</ul>
<ol start="6" style="list-style-type: decimal">
<li>Plot the estimated event-study vs. the true effect</li>
</ol>
<p>In a business or marketing study, a useful final step is a chart showing the point estimates (with confidence bands) plus the known <em>true</em> effect as a reference.</p>
<p>Construct the “true” dynamic effect curve</p>
<ul>
<li><p>Pre-treatment periods: effect = 0</p></li>
<li><p>Post-treatment periods: effect = <span class="math inline">\(\delta=-0.05\)</span></p></li>
</ul>
<p>Below we will:</p>
<ol style="list-style-type: decimal">
<li><p>Extract the estimated event effects from <code>mod_es</code>.</p></li>
<li><p>Build a <strong>reference</strong> dataset with the same event times.</p></li>
<li><p>Plot both on the same figure.</p></li>
</ol>
<div class="sourceCode" id="cb826"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># --- 6) Plot results vs. known effect ---</span></span>
<span><span class="va">est_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">mod_es</span><span class="op">)</span></span>
<span></span>
<span><span class="va">range_of_event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">est_df</span><span class="op">$</span><span class="va">event</span><span class="op">)</span></span>
<span><span class="va">event_breaks</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">range_of_event</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">range_of_event</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">true_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">e</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">event_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">range_of_event</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">range_of_event</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">true_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    event       <span class="op">=</span> <span class="va">event_grid</span>,</span>
<span>    true_effect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html">sapply</a></span><span class="op">(</span><span class="va">event_grid</span>, <span class="va">true_fun</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Confidence interval ribbon (put it first so it's behind everything)</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">est_df</span>,</span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">event</span>, ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>        fill <span class="op">=</span> <span class="st">"grey60"</span>,   <span class="co"># light gray fill</span></span>
<span>        alpha <span class="op">=</span> <span class="fl">0.3</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Estimated effect line</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">est_df</span>,</span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">event</span>, y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>        size <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Estimated effect points</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">est_df</span>,</span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">event</span>, y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>        size <span class="op">=</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Known true effect (dashed red line)</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">true_df</span>,</span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">event</span>, y <span class="op">=</span> <span class="va">true_effect</span><span class="op">)</span>,</span>
<span>        color <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>        linetype <span class="op">=</span> <span class="st">"dashed"</span>,</span>
<span>        linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Horizontal zero line</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dotted"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Vertical line at event = 0 for clarity</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"gray40"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Make sure x-axis breaks are integers</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">event_breaks</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"Event-Study Plot vs. Known True Effect"</span>,</span>
<span>        subtitle <span class="op">=</span> <span class="st">"Business simulation with new marketing platform adoption"</span>,</span>
<span>        x <span class="op">=</span> <span class="st">"Event time (periods relative to adoption)"</span>,</span>
<span>        y <span class="op">=</span> <span class="st">"Effect on log-outcome (ATT)"</span>,</span>
<span>        caption <span class="op">=</span> <span class="st">"Dashed red line = known true effect; Shaded area = 95% CI"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.4-nolinear-did_files/figure-html/unnamed-chunk-6-1.png" width="90%" style="display: block; margin: auto;"></div>
<ul>
<li><p><strong>Solid line</strong> and shaded region: the ETWFE <em>point estimates</em> and their 95% confidence intervals, for each event time relative to adoption.</p></li>
<li><p><strong>Dashed red line</strong>: the <em>true</em> effect that we built into the DGP.</p></li>
</ul>
<p>If the estimation works well (and your sample is big enough), the estimated event-study effects should hover near the dashed red line <em>post</em>-treatment, and near zero <em>pre</em>-treatment.</p>
<p>Alternatively, we could also the <code>plot</code> function to produce a quick plot.</p>
<div class="sourceCode" id="cb827"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span></span>
<span>    <span class="va">mod_es</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"ribbon"</span>,</span>
<span>    <span class="co"># col  = "",# color</span></span>
<span>    xlab <span class="op">=</span> <span class="st">""</span>,</span>
<span>    main <span class="op">=</span> <span class="st">""</span>,</span>
<span>    sub  <span class="op">=</span> <span class="st">""</span>,</span>
<span>    <span class="co"># file = "event-study.png", width = 8, height = 5. # save file</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.4-nolinear-did_files/figure-html/unnamed-chunk-7-1.png" width="90%" style="display: block; margin: auto;"></div>
<ol start="7" style="list-style-type: decimal">
<li>Double-check in a regression table (optional)</li>
</ol>
<p>If you like to see a clean numeric summary of the <em>dynamic</em> estimates by period, you can pipe your event-study object into <code>modelsummary</code>:</p>
<div class="sourceCode" id="cb828"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># --- 7) Optional table for dynamic estimates ---</span></span>
<span><span class="fu"><a href="https://modelsummary.com/man/modelsummary.html">modelsummary</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"Event-Study"</span> <span class="op">=</span> <span class="va">mod_es</span><span class="op">)</span>,</span>
<span>    shape     <span class="op">=</span> <span class="va">term</span> <span class="op">+</span> <span class="va">statistic</span> <span class="op">~</span> <span class="va">model</span> <span class="op">+</span> <span class="va">event</span>,</span>
<span>    gof_map   <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    coef_map  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">".Dtreat"</span> <span class="op">=</span> <span class="st">"ATT"</span><span class="op">)</span>,</span>
<span>    title     <span class="op">=</span> <span class="st">"ETWFE Event-Study by Relative Adoption Period"</span>,</span>
<span>    notes     <span class="op">=</span> <span class="st">"Std. errors are clustered by store ID"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
</div>
<div id="multiple-treatments" class="section level2" number="30.9">
<h2>
<span class="header-section-number">30.9</span> Multiple Treatments<a class="anchor" aria-label="anchor" href="#multiple-treatments"><i class="fas fa-link"></i></a>
</h2>
<p>In some settings, researchers encounter <strong>two (or more) treatments</strong> rather than a single treatment and control group. This complicates standard DiD estimation, but a properly structured model ensures accurate identification.</p>
<p><strong>Additional References</strong></p>
<ul>
<li>
<span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-fricke2017identification">Fricke 2017</a>)</span>: Discusses identification challenges in multiple treatment settings.</li>
<li>
<span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-de2023two">Clement De Chaisemartin and D’haultfœuille 2023</a>)</span>: Provides a <strong>video tutorial</strong> (<a href="https://www.youtube.com/watch?v=UHeJoc27qEM&amp;ab_channel=TaylorWright">YouTube</a>) and <strong>code</strong> (<a href="https://drive.google.com/file/d/156Fu73avBvvV_H64wePm7eW04V0jEG3K/view">Google Drive</a>) for implementing multiple-treatment DiD models.</li>
</ul>
<p><strong>Key Principles When Dealing with Multiple Treatments</strong></p>
<ol style="list-style-type: decimal">
<li>
<p><strong>Always include all treatment groups in a single regression model.</strong></p>
<ul>
<li>This ensures proper identification of treatment-specific effects while maintaining a clear comparison against the control group.</li>
</ul>
</li>
<li>
<p><strong>Never use one treated group as a control for the other.</strong></p>
<ul>
<li>Running separate regressions for each treatment group can lead to biased estimates because each treatment group may differ systematically from the control group in ways that a separate model cannot fully capture.</li>
</ul>
</li>
<li>
<p><strong>Compare the significance of treatment effects</strong> (<span class="math inline">\(\delta_1\)</span> vs. <span class="math inline">\(\delta_2\)</span>).</p>
<ul>
<li>Instead of assuming equal effects, we should formally test whether the effects of the two treatments are statistically different using an F-test or Wald test:</li>
</ul>
<p><span class="math display">\[
H_0: \delta_1 = \delta_2
\]</span></p>
<ul>
<li>If we reject <span class="math inline">\(H_0\)</span>, we conclude that the two treatments have significantly different effects.</li>
</ul>
</li>
</ol>
<hr>
<div id="multiple-treatment-groups-model-specification" class="section level3" number="30.9.1">
<h3>
<span class="header-section-number">30.9.1</span> Multiple Treatment Groups: Model Specification<a class="anchor" aria-label="anchor" href="#multiple-treatment-groups-model-specification"><i class="fas fa-link"></i></a>
</h3>
<p>A properly specified DiD regression model with two treatments takes the following form:</p>
<p><span class="math display">\[
\begin{aligned}
Y_{it} &amp;= \alpha + \gamma_1 Treat1_{i} + \gamma_2 Treat2_{i} + \lambda Post_t  \\
&amp;+ \delta_1(Treat1_i \times Post_t) + \delta_2(Treat2_i \times Post_t) + \epsilon_{it}
\end{aligned}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(Y_{it}\)</span> = Outcome variable for individual <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span>.</li>
<li>
<span class="math inline">\(Treat1_i\)</span> = 1 if individual <span class="math inline">\(i\)</span> is in <strong>Treatment Group 1</strong>, 0 otherwise.</li>
<li>
<span class="math inline">\(Treat2_i\)</span> = 1 if individual <span class="math inline">\(i\)</span> is in <strong>Treatment Group 2</strong>, 0 otherwise.</li>
<li>
<span class="math inline">\(Post_t\)</span> = 1 for post-treatment period, 0 otherwise.</li>
<li>
<strong>DiD coefficients</strong>:
<ul>
<li>
<span class="math inline">\(\delta_1\)</span> = Effect of Treatment 1.</li>
<li>
<span class="math inline">\(\delta_2\)</span> = Effect of Treatment 2.</li>
</ul>
</li>
<li>
<span class="math inline">\(\epsilon_{it}\)</span> = Error term.</li>
</ul>
<hr>
</div>
<div id="understanding-the-control-group-in-multiple-treatment-did" class="section level3" number="30.9.2">
<h3>
<span class="header-section-number">30.9.2</span> Understanding the Control Group in Multiple Treatment DiD<a class="anchor" aria-label="anchor" href="#understanding-the-control-group-in-multiple-treatment-did"><i class="fas fa-link"></i></a>
</h3>
<p>One common concern in multiple-treatment DiD models is how to properly define the control group. A well-specified model ensures that:</p>
<ul>
<li>The control group consists only of untreated individuals, not individuals from another treatment group.</li>
<li>The reference category in the regression represents the control group (i.e., individuals with <span class="math inline">\(Treat1_i = 0\)</span> and <span class="math inline">\(Treat2_i = 0\)</span>).</li>
<li>If <span class="math inline">\(Treat1_i = 1\)</span>, then <span class="math inline">\(Treat2_i = 0\)</span> and vice versa.</li>
</ul>
<p>Failing to correctly specify the control group could lead to incorrect estimates of treatment effects. For example, omitting one of the treatment indicators could unintentionally redefine the control group as a mix of treated and untreated individuals.</p>
<hr>
</div>
<div id="alternative-approaches-separate-regressions-vs.-one-model" class="section level3" number="30.9.3">
<h3>
<span class="header-section-number">30.9.3</span> Alternative Approaches: Separate Regressions vs. One Model<a class="anchor" aria-label="anchor" href="#alternative-approaches-separate-regressions-vs.-one-model"><i class="fas fa-link"></i></a>
</h3>
<p>A common question is whether to run one large regression including all treatment groups or to run separate DiD models on subsets of the data. Each approach has implications:</p>
<ol style="list-style-type: decimal">
<li><strong>One Model Approach (Preferred)</strong></li>
</ol>
<ul>
<li>Running one comprehensive regression allows for direct comparison between treatment effects in a statistically valid way.</li>
<li>The interaction terms (<span class="math inline">\(\delta_1, \delta_2\)</span>) ensure that each treatment effect is estimated relative to a common control group.</li>
<li>The F-test (or Wald test) enables a formal test of whether the two treatments have significantly different effects.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><strong>Separate Regressions Approach</strong></li>
</ol>
<ul>
<li>Running separate DiD models for each treatment group can still be valid, but:
<ul>
<li>The estimated treatment effects are less efficient because they come from separate samples.</li>
<li>Comparisons become less straightforward, as they rely on confidence interval overlap rather than direct hypothesis testing.</li>
<li>If homoscedasticity holds (i.e., equal error variances across groups), the separate regressions approach is unnecessary. The combined model is more efficient.</li>
</ul>
</li>
</ul>
<p>Thus, unless there is strong justification for separate regressions (e.g., significant heterogeneity in error variance), the one-model approach is preferred.</p>
<hr>
</div>
<div id="handling-treatment-intensity" class="section level3" number="30.9.4">
<h3>
<span class="header-section-number">30.9.4</span> Handling Treatment Intensity<a class="anchor" aria-label="anchor" href="#handling-treatment-intensity"><i class="fas fa-link"></i></a>
</h3>
<p>In some cases, treatments differ <strong>not just in type, but also in intensity</strong> (e.g., low vs. high treatment exposure). If we observe different levels of treatment intensity, we can model it using a <strong>single categorical variable</strong> rather than multiple treatment dummies:</p>
<p>Rather than coding separate dummies for each treatment group, we define a <strong>multi-valued treatment variable</strong>:</p>
<p><span class="math display">\[
Y_{it} = \alpha + \sum_{j=1}^{J} \beta_j (Treatment_j \times Post_t) + \lambda Post_t + \epsilon_{it}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(Treatment_j\)</span> is a categorical variable indicating whether an individual belongs to the control group, low-intensity treatment, or high-intensity treatment.</li>
<li>This approach allows for cleaner implementation and avoids excessive interaction terms.</li>
</ul>
<p>This approach has the advantage of:</p>
<ul>
<li><p>Automatically setting the control group as the reference category.</p></li>
<li><p>Ensuring correct interpretation of coefficients for different treatment levels.</p></li>
</ul>
</div>
<div id="considerations-when-individuals-can-move-between-treatment-groups" class="section level3" number="30.9.5">
<h3>
<span class="header-section-number">30.9.5</span> Considerations When Individuals Can Move Between Treatment Groups<a class="anchor" aria-label="anchor" href="#considerations-when-individuals-can-move-between-treatment-groups"><i class="fas fa-link"></i></a>
</h3>
<p>One potential complication in multiple-treatment DiD settings is when individuals can switch treatment groups over time (e.g., moving from low-intensity to high-intensity treatment after policy implementation).</p>
<ul>
<li><p>If movement is rare, it may not significantly affect estimates.</p></li>
<li><p>If movement is frequent, it creates a challenge in causal identification because treatment effects might be confounded by self-selection.</p></li>
</ul>
<p>A possible solution is to use an intention-to-treat (ITT) approach, where treatment assignment is based on the initially assigned group, regardless of whether individuals later switch.</p>
</div>
<div id="parallel-trends-assumption-in-multiple-treatment-did" class="section level3" number="30.9.6">
<h3>
<span class="header-section-number">30.9.6</span> Parallel Trends Assumption in Multiple-Treatment DiD<a class="anchor" aria-label="anchor" href="#parallel-trends-assumption-in-multiple-treatment-did"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>Just as in standard DiD, a key assumption in multiple-treatment DiD models is that the treatment and control groups would have followed parallel trends in the absence of treatment.</p></li>
<li><p>With multiple treatments, we must check pre-trends separately for each treated group against the control group.</p></li>
<li><p>If pre-treatment trends are not parallel, we may need to adopt alternative methods such as <a href="(#sec-synthetic-control)">synthetic control</a> models or event study analyses.</p></li>
</ul>
<hr>
</div>
</div>
<div id="mediation-under-did" class="section level2" number="30.10">
<h2>
<span class="header-section-number">30.10</span> Mediation Under DiD<a class="anchor" aria-label="anchor" href="#mediation-under-did"><i class="fas fa-link"></i></a>
</h2>
<p>Mediation analysis helps determine whether a treatment affects the outcome directly or through an intermediate variable (mediator). In a DiD framework, this allows us to separate:</p>
<ol style="list-style-type: decimal">
<li>Direct effects: The effect of the treatment on the outcome independent of the mediator.</li>
<li>Indirect (mediated) effects: The effect of the treatment that operates through the mediator.</li>
</ol>
<p>This is useful when a treatment consists of multiple components or when we want to understand mechanisms behind an observed effect.</p>
<hr>
<div id="mediation-model-in-did" class="section level3" number="30.10.1">
<h3>
<span class="header-section-number">30.10.1</span> Mediation Model in DiD<a class="anchor" aria-label="anchor" href="#mediation-model-in-did"><i class="fas fa-link"></i></a>
</h3>
<p>To incorporate mediation, we estimate two equations:</p>
<p><strong>Step 1: Effect of Treatment on the Mediator</strong></p>
<p><span class="math display">\[
M_{it} = \alpha + \gamma Treat_i + \lambda Post_t + \delta (Treat_i \times Post_t) + \epsilon_{it}
\]</span> where:</p>
<ul>
<li>
<span class="math inline">\(M_{it}\)</span> = Mediator variable (e.g., job search intensity, firm investment, police presence).</li>
<li>
<span class="math inline">\(\delta\)</span> = Effect of the treatment on the mediator (capturing how the treatment changes <span class="math inline">\(M\)</span>).</li>
</ul>
<p><strong>Step 2: Effect of Treatment and Mediator on the Outcome</strong></p>
<p><span class="math display">\[
Y_{it} = \alpha' + \gamma' Treat_i + \lambda' Post_t + \delta' (Treat_i \times Post_t) + \theta M_{it} + \epsilon'_{it}
\]</span> where:</p>
<ul>
<li>
<span class="math inline">\(Y_{it}\)</span> = Outcome variable (e.g., employment, crime rate, firm performance).</li>
<li>
<span class="math inline">\(\theta\)</span> = Effect of the mediator on the outcome.</li>
<li>
<span class="math inline">\(\delta'\)</span> = <strong>Direct effect</strong> of the treatment (controlling for the mediator).</li>
</ul>
<hr>
</div>
<div id="interpreting-the-results" class="section level3" number="30.10.2">
<h3>
<span class="header-section-number">30.10.2</span> Interpreting the Results<a class="anchor" aria-label="anchor" href="#interpreting-the-results"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>If <span class="math inline">\(\theta\)</span> is statistically significant, it suggests that mediation is occurring—that is, the treatment affects the outcome partly through the mediator.</li>
<li>If <span class="math inline">\(\delta'\)</span> is smaller than <span class="math inline">\(\delta\)</span>, this indicates that part of the treatment effect is explained by the mediator. The remaining portion of <span class="math inline">\(\delta'\)</span> represents the direct effect.</li>
</ul>
<p>Thus, we can decompose the total treatment effect as:</p>
<p><span class="math display">\[
\text{Total Effect} = \delta' + (\theta \times \delta)
\]</span></p>
<p>where:</p>
<ul>
<li><p><span class="math inline">\(\delta'\)</span> = Direct effect (holding the mediator constant).</p></li>
<li><p><span class="math inline">\(\theta \times \delta\)</span> = Indirect (mediated) effect.</p></li>
</ul>
<hr>
</div>
<div id="challenges-in-mediation-analysis-for-did" class="section level3" number="30.10.3">
<h3>
<span class="header-section-number">30.10.3</span> Challenges in Mediation Analysis for DiD<a class="anchor" aria-label="anchor" href="#challenges-in-mediation-analysis-for-did"><i class="fas fa-link"></i></a>
</h3>
<p>Mediation in a DiD setting introduces several challenges that require careful consideration:</p>
<ol style="list-style-type: decimal">
<li><strong>Potential Confounding of the Mediator</strong></li>
</ol>
<ul>
<li>A key assumption is that no unmeasured confounders affect both the mediator and the outcome.</li>
<li>If such confounders exist, estimates of <span class="math inline">\(\theta\)</span> may be biased.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><strong>Mediator-Outcome Endogeneity</strong></li>
</ol>
<ul>
<li>If the mediator is itself influenced by unobserved factors correlated with the outcome, it introduces endogeneity, making direct OLS estimates of <span class="math inline">\(\theta\)</span> problematic.</li>
<li>For example, in a crime policy evaluation:
<ul>
<li>The number of police officers (mediator) may be influenced by crime rates (outcome), leading to reverse causality.</li>
</ul>
</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><strong>Interaction Between Multiple Mediators</strong></li>
</ol>
<ul>
<li>If there are multiple mediators (e.g., a policy that increases both police presence and surveillance cameras), they may interact with each other.</li>
<li>A useful test is to regress each mediator on treatment and other mediators. If a mediator predicts another, their effects are not independent, complicating interpretation.</li>
</ul>
<hr>
</div>
<div id="alternative-approach-instrumental-variables-for-mediation" class="section level3" number="30.10.4">
<h3>
<span class="header-section-number">30.10.4</span> Alternative Approach: Instrumental Variables for Mediation<a class="anchor" aria-label="anchor" href="#alternative-approach-instrumental-variables-for-mediation"><i class="fas fa-link"></i></a>
</h3>
<p>One way to address mediator endogeneity is to use <strong>instrumental variables</strong>, where treatment serves as an instrument for the mediator:</p>
<p><strong>Two-Stage Estimation:</strong></p>
<ol style="list-style-type: decimal">
<li>
<strong>First Stage: Predict the Mediator Using the Treatment</strong> <span class="math display">\[
M_{it} = \alpha + \pi Treat_i + \lambda Post_t + \delta (Treat_i \times Post_t) + \nu_{it}
\]</span>
</li>
<li>
<strong>Second Stage: Predict the Outcome Using the Instrumented Mediator</strong> <span class="math display">\[
Y_{it} = \alpha' + \gamma' Treat_i + \lambda' Post_t + \phi \hat{M}_{it} + \epsilon'_{it}
\]</span>
</li>
</ol>
<ul>
<li>Here, <span class="math inline">\(\hat{M}_{it}\)</span> (predicted values from the first stage) replaces <span class="math inline">\(M_{it}\)</span>, eliminating endogeneity concerns if the exclusion restriction holds (i.e., treatment only affects <span class="math inline">\(Y\)</span> through <span class="math inline">\(M\)</span>).</li>
</ul>
<p><strong>Key Limitation of IV Approach</strong></p>
<ul>
<li>The IV strategy assumes that treatment affects the outcome only through the mediator, which may be too strong of an assumption in complex policy settings.</li>
</ul>
<hr>
</div>
</div>
<div id="assumptions-3" class="section level2" number="30.11">
<h2>
<span class="header-section-number">30.11</span> Assumptions<a class="anchor" aria-label="anchor" href="#assumptions-3"><i class="fas fa-link"></i></a>
</h2>
<ol style="list-style-type: decimal">
<li><strong>Parallel Trends Assumption</strong></li>
</ol>
<p>The Difference-in-Differences estimator relies on a key identifying assumption: the parallel trends assumption. This assumption states that, in the absence of treatment, the average outcome for the treated group would have evolved over time in the same way as for the control group.</p>
<p>Let:</p>
<ul>
<li><p><span class="math inline">\(Y_{it}(0)\)</span> denote the potential outcome without treatment for unit <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span></p></li>
<li><p><span class="math inline">\(D_i = 1\)</span> if unit <span class="math inline">\(i\)</span> is in the treatment group, and <span class="math inline">\(D_i = 0\)</span> if in the control group</p></li>
</ul>
<p>Then, the parallel trends assumption can be written as:</p>
<p><span class="math display">\[
E[Y_{it}(0) \mid D_i = 1] - E[Y_{it}(0) \mid D_i = 0] = \Delta_0 \quad \text{for all } t,
\]</span></p>
<p>where <span class="math inline">\(\Delta_0\)</span> is a constant difference over time in the untreated potential outcomes between the two groups. This assumption does not require the levels of outcomes to be the same between groups—only that the difference remains constant over time.</p>
<p>In other words, the gap between treatment and control groups in the absence of treatment must remain stable. If this holds, any deviation from that stable difference after the treatment is attributed to the causal effect of the treatment.</p>
<hr>
<p>It is important to understand how the parallel trends assumption compares to other, stronger assumptions:</p>
<ul>
<li>
<p><strong>Same untreated levels across groups</strong>:<br>
A stronger assumption would require that the treated and control groups have <strong>identical untreated outcomes at all times</strong>:</p>
<p><span class="math display">\[
E[Y_{it}(0) \mid D_i = 1] = E[Y_{it}(0) \mid D_i = 0] \quad \text{for all } t
\]</span></p>
<p>This is often unrealistic in observational settings, where baseline characteristics typically differ between groups.</p>
</li>
<li>
<p><strong>No change in untreated outcomes over time</strong>:<br>
Another strong assumption is that <strong>untreated outcomes remain constant over time</strong>, for both groups:</p>
<p><span class="math display">\[
E[Y_{it}(0)] = E[Y_{i,t'}(0)] \quad \text{for all } i \text{ and times } t, t'
\]</span></p>
<p>This implies no secular trends, which is rarely plausible in real-world applications where outcomes (e.g., sales, earnings, health metrics) naturally evolve over time.</p>
</li>
</ul>
<p>The <strong>parallel trends assumption is weaker</strong> than both of these and is generally more defensible, especially when supported by pre-treatment data.</p>
<hr>
<p>DiD is appropriate when:</p>
<ul>
<li><p>You have pre-treatment and post-treatment outcome data</p></li>
<li><p>You have clearly defined treatment and control groups</p></li>
<li><p>The parallel trends assumption is plausible</p></li>
</ul>
<p>Avoid using DiD when:</p>
<ul>
<li><p>Treatment assignment is not random or quasi-random</p></li>
<li><p>Unobserved confounders may cause the groups to evolve differently over time</p></li>
</ul>
<p>Testing Parallel Trends: <a href="sec-difference-in-differences.html#prior-parallel-trends-test">Prior Parallel Trends Test</a>.</p>
<hr>
<ol start="2" style="list-style-type: decimal">
<li><strong>No Anticipation Effect (Pre-Treatment Exogeneity)</strong></li>
</ol>
<ul>
<li><p>Individuals or groups should not change their behavior before the treatment is implemented in expectation of the treatment.</p></li>
<li><p>If units anticipate the treatment and adjust their behavior beforehand, it can introduce bias in the estimates.</p></li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><strong>Exogenous Treatment Assignment</strong></li>
</ol>
<ul>
<li>Treatment should not be assigned based on potential outcomes.</li>
<li>Ideally, assignment should be as good as random, conditional on observables.</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li><strong>Stable Composition of Groups (No Attrition or Spillover)</strong></li>
</ol>
<ul>
<li>Treatment and control groups should remain stable over time.</li>
<li>There should be no selective attrition (where individuals enter/leave due to treatment).</li>
<li>No spillover effects: Control units should not be indirectly affected by treatment.</li>
</ul>
<ol start="5" style="list-style-type: decimal">
<li><strong>No Simultaneous Confounding Events (Exogeneity of Shocks)</strong></li>
</ol>
<ul>
<li>There should be no other major shocks that affect treatment/control groups differently at the same time as treatment implementation.</li>
</ul>
<hr>
<p><strong>Limitations and Common Issues</strong></p>
<ol style="list-style-type: decimal">
<li><strong>Functional Form Dependence</strong></li>
</ol>
<ul>
<li>If the response to treatment is nonlinear, compare high- vs. low-intensity groups.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><strong>Selection on (Time-Varying) Unobservables</strong></li>
</ol>
<ul>
<li>Use <a href="sec-matching-methods.html#sec-rosenbaum-bounds">Rosenbaum Bounds</a> to check the sensitivity of estimates to unobserved confounders.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><strong>Long-Term Effects</strong></li>
</ol>
<ul>
<li>Parallel trends are more reliable in short time windows.</li>
<li>Over long periods, other confounding factors may emerge.</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li><strong>Heterogeneous Effects</strong></li>
</ol>
<ul>
<li>Treatment intensity (e.g., different doses) may vary across groups, leading to different effects.</li>
</ul>
<ol start="5" style="list-style-type: decimal">
<li>
<strong>Ashenfelter’s Dip</strong> <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-ashenfelter1978estimating">Ashenfelter 1978</a>)</span>
</li>
</ol>
<ul>
<li>Participants in job training programs often experience earnings drops before enrolling, making them systematically different from nonparticipants.</li>
<li>
<strong>Fix</strong>: Compute long-run differences, excluding periods around treatment, to test for sustained impact <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-proserpio2017online">Proserpio and Zervas 2017</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-heckman1999economics">J. J. Heckman, LaLonde, and Smith 1999</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-jepsen2014labor">Jepsen, Troske, and Coomes 2014</a>)</span>.</li>
</ul>
<ol start="6" style="list-style-type: decimal">
<li><strong>Lagged Treatment Effects</strong></li>
</ol>
<ul>
<li>If effects are not immediate, using a lagged dependent variable <span class="math inline">\(Y_{it-1}\)</span> may be more appropriate <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-blundell1998initial">Blundell and Bond 1998</a>)</span>.</li>
</ul>
<ol start="7" style="list-style-type: decimal">
<li><strong>Bias from Unobserved Factors Affecting Trends</strong></li>
</ol>
<ul>
<li>If external shocks influence treatment and control groups differently, this biases DiD estimates.</li>
</ul>
<ol start="8" style="list-style-type: decimal">
<li><strong>Correlated Observations</strong></li>
</ol>
<ul>
<li>Standard errors should be clustered appropriately.</li>
</ul>
<ol start="9" style="list-style-type: decimal">
<li><strong>Incidental Parameters Problem <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-lancaster2000incidental">Lancaster 2000</a>)</span></strong></li>
</ol>
<ul>
<li>Always prefer individual and time fixed effects to reduce bias.</li>
</ul>
<ol start="10" style="list-style-type: decimal">
<li><strong>Treatment Timing and Negative Weights</strong></li>
</ol>
<ul>
<li>If treatment timing varies across units, negative weights can arise in standard DiD estimators when treatment effects are heterogeneous <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-athey2022design">Athey and Imbens 2022</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-borusyak2024revisiting">Borusyak, Jaravel, and Spiess 2024</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-goodman2021difference">Goodman-Bacon 2021</a>)</span>.</li>
<li>
<strong>Fix:</strong> Use estimators from <span class="citation">Callaway and Sant’Anna (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-callaway2021difference">2021</a>)</span> and <span class="citation">Clément De Chaisemartin and d’Haultfoeuille (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-de2020two">2020</a>)</span> (<code>did</code> package).</li>
<li>If expecting lags and leads, see <span class="citation">L. Sun and Abraham (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sun2021estimating">2021</a>)</span>.</li>
</ul>
<ol start="11" style="list-style-type: decimal">
<li><strong>Treatment Effect Heterogeneity Across Groups</strong></li>
</ol>
<ul>
<li>If treatment effects vary across groups and interact with treatment variance, standard estimators may be invalid <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-gibbons2018broken">Gibbons, Suárez Serrato, and Urbancic 2018</a>)</span>.</li>
</ul>
<ol start="12" style="list-style-type: decimal">
<li><strong>Endogenous Timing</strong></li>
</ol>
<p>If the timing of units can be influenced by strategic decisions in a DID analysis, an instrumental variable approach with a control function can be used to control for endogeneity in timing.</p>
<ol start="13" style="list-style-type: decimal">
<li><strong>Questionable Counterfactuals</strong></li>
</ol>
<p>In situations where the control units may not serve as a reliable counterfactual for the treated units, matching methods such as propensity score matching or generalized random forest can be utilized. Additional methods can be found in <a href="sec-matching-methods.html#sec-matching-methods">Matching Methods</a>.</p>
<hr>
<div id="prior-parallel-trends-test" class="section level3" number="30.11.1">
<h3>
<span class="header-section-number">30.11.1</span> Prior Parallel Trends Test<a class="anchor" aria-label="anchor" href="#prior-parallel-trends-test"><i class="fas fa-link"></i></a>
</h3>
<p>The parallel trends assumption ensures that, absent treatment, the treated and control groups would have followed similar outcome trajectories. Testing this assumption involves visualization and statistical analysis.</p>
<p><span class="citation">Marcus and Sant’Anna (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-marcus2021role">2021</a>)</span> discuss pre-trend testing in staggered DiD.</p>
<ol style="list-style-type: decimal">
<li><strong>Visual Inspection: Outcome Trends and Treatment Rollout</strong></li>
</ol>
<ul>
<li>Plot raw outcome trends for both groups before and after treatment.</li>
<li>Use <strong>event-study plots</strong> to check for pre-trend violations and anticipation effects.</li>
<li>Visualization tools like <code>ggplot2</code> or <code>panelView</code> help illustrate treatment timing and trends.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><strong>Event-Study Regressions</strong></li>
</ol>
<p>A formal test for pre-trends uses the event-study model:</p>
<p><span class="math display">\[ Y_{it} = \alpha + \sum_{k=-K}^{K} \beta_k 1(T = k) + X_{it} \gamma + \lambda_i + \delta_t + \epsilon_{it} \]</span></p>
<p>where:</p>
<ul>
<li><p><span class="math inline">\(1(T = k)\)</span> are time dummies for periods before and after treatment.</p></li>
<li><p><span class="math inline">\(\beta_k\)</span> captures deviations in outcomes before treatment; these should be <strong>statistically indistinguishable from zero</strong> if parallel trends hold.</p></li>
<li><p><span class="math inline">\(\lambda_i\)</span> and <span class="math inline">\(\delta_t\)</span> are unit and time fixed effects.</p></li>
<li><p><span class="math inline">\(X_{it}\)</span> are optional covariates.</p></li>
</ul>
<p><strong>Violation of parallel trends</strong> occurs if pre-treatment coefficients (<span class="math inline">\(\beta_k\)</span> for <span class="math inline">\(k &lt; 0\)</span>) are statistically significant.</p>
<ol start="3" style="list-style-type: decimal">
<li><strong>Statistical Test for Pre-Treatment Trend Differences</strong></li>
</ol>
<p>Using only pre-treatment data, estimate:</p>
<p><span class="math display">\[
Y = \alpha_g + \beta_1 T + \beta_2 (T \times G) + \epsilon
\]</span></p>
<p>where:</p>
<ul>
<li><p><span class="math inline">\(\beta_2\)</span> measures differences in time trends between groups.</p></li>
<li><p>If <span class="math inline">\(\beta_2 = 0\)</span>, trends are parallel before treatment.</p></li>
</ul>
<p><strong>Considerations:</strong></p>
<ul>
<li>Alternative functional forms (e.g., polynomials or nonlinear trends) can be tested.</li>
<li>If <span class="math inline">\(\beta_2 \neq 0\)</span>, potential explanations include:
<ul>
<li>Large sample size driving statistical significance.</li>
<li>Small deviations in one period disrupting an otherwise stable trend.</li>
</ul>
</li>
</ul>
<p>While time fixed effects can partially address violations of parallel trends (and are commonly used in modern research), they may also absorb part of the treatment effect, especially when treatment effects vary over time <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-wolfers2003business">Wolfers 2003</a>)</span>.</p>
<hr>
<p><strong>Debate on Parallel Trends</strong></p>
<ul>
<li>
<strong>Levels vs. Trends</strong>: <span class="citation">Kahn-Lang and Lang (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-kahn2020promise">2020</a>)</span> argue that <strong>similarity in levels</strong> is also crucial. If treatment and control groups start at <strong>different levels</strong>, why assume their trends will be the same?
<ul>
<li>
<strong>Solution</strong>:
<ul>
<li>Plot time series for the treated and control groups.</li>
<li>Use matched samples to improve comparability <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-ryan2019now">Ryan et al. 2019</a>)</span> (useful when parallel trends assumption is questionable).</li>
</ul>
</li>
<li>If levels differ significantly, functional form assumptions become more critical and must be justified.</li>
</ul>
</li>
<li>
<strong>Power of Pre-Trend Tests</strong>:
<ul>
<li>Pre-trend tests often lack statistical power, making false negatives common <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-roth2022pretest">Roth 2022</a>)</span>.</li>
<li>See: <a href="https://github.com/jonathandroth/PretrendsPower">PretrendsPower</a> and <a href="https://github.com/jonathandroth/pretrends">pretrends</a> (for adjustments).</li>
</ul>
</li>
<li>
<strong>Outcome Transformations Matter</strong>:
<ul>
<li>The parallel trends assumption is specific to both the transformation and units of the outcome variable <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-roth2023parallel">Roth and Sant’Anna 2023</a>)</span>.</li>
<li>Conduct falsification tests to check whether the assumption holds under different functional forms.</li>
</ul>
</li>
</ul>
<hr>
<div class="sourceCode" id="cb829"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="va">od</span> <span class="op">&lt;-</span> <span class="fu">causaldata</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/causaldata/man/organ_donations.html">organ_donations</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># Use only pre-treatment data</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Quarter_Num</span> <span class="op">&lt;=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co"># Treatment variable</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>California <span class="op">=</span> <span class="va">State</span> <span class="op">==</span> <span class="st">'California'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># use my package</span></span>
<span><span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/plot_par_trends.html">plot_par_trends</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">od</span>,</span>
<span>    metrics_and_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"Rate"</span> <span class="op">=</span> <span class="st">"Rate"</span><span class="op">)</span>,</span>
<span>    treatment_status_var <span class="op">=</span> <span class="st">"California"</span>,</span>
<span>    time_var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span>Quarter_Num <span class="op">=</span> <span class="st">"Time"</span><span class="op">)</span>,</span>
<span>    display_CI <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span></code></pre></div>
<div class="inline-figure"><img src="30.5-did-concerns_files/figure-html/unnamed-chunk-1-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb830"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># do it manually</span></span>
<span><span class="co"># always good but plot the dependent out</span></span>
<span><span class="va">od</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># group by treatment status and time</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">California</span>, <span class="va">Quarter</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarize_all</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># view()</span></span>
<span>    </span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Quarter_Num</span>, y <span class="op">=</span> <span class="va">Rate</span>, color <span class="op">=</span> <span class="va">California</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.5-did-concerns_files/figure-html/unnamed-chunk-1-2.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb831"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co"># but it's also important to use statistical test</span></span>
<span><span class="va">prior_trend</span> <span class="op">&lt;-</span> <span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">Rate</span> <span class="op">~</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/i.html">i</a></span><span class="op">(</span><span class="va">Quarter_Num</span>, <span class="va">California</span><span class="op">)</span> <span class="op">|</span></span>
<span>                                 <span class="va">State</span> <span class="op">+</span> <span class="va">Quarter</span>,</span>
<span>                             data <span class="op">=</span> <span class="va">od</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">coefplot</a></span><span class="op">(</span><span class="va">prior_trend</span>, grid <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.5-did-concerns_files/figure-html/unnamed-chunk-1-3.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb832"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">iplot</a></span><span class="op">(</span><span class="va">prior_trend</span>, grid <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.5-did-concerns_files/figure-html/unnamed-chunk-1-4.png" width="90%" style="display: block; margin: auto;"></div>
<p>This is alarming since one of the periods is significantly different from 0, which means that our parallel trends assumption is not plausible.</p>
<p>In cases where the parallel trends assumption is questionable, researchers should consider methods for assessing and addressing potential violations. Some key approaches are discussed in <span class="citation">Rambachan and Roth (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-rambachan2023more">2023</a>)</span>:</p>
<ul>
<li><p><strong>Imposing Restrictions</strong>: Constrain how different the post-treatment violations of parallel trends can be relative to pre-treatment deviations.</p></li>
<li><p><a href="sec-difference-in-differences.html#sec-partial-identification-did"><strong>Partial Identification</strong></a>: Rather than assuming a single causal effect, derive bounds on the ATT.</p></li>
<li><p><strong>Sensitivity Analysis</strong>: Evaluate how sensitive the results are to potential deviations from parallel trends.</p></li>
</ul>
<p>To implement these approaches, the <code>HonestDiD</code> package by <span class="citation">Rambachan and Roth (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-rambachan2023more">2023</a>)</span> provides robust statistical tools:</p>
<div class="sourceCode" id="cb833"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># https://github.com/asheshrambachan/HonestDiD</span></span>
<span><span class="co"># remotes::install_github("asheshrambachan/HonestDiD")</span></span>
<span><span class="co"># library(HonestDiD)</span></span></code></pre></div>
<p>Alternatively, <span class="citation">Ban and Kedagni (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-ban2022generalized">2022</a>)</span> propose a method that incorporates pre-treatment covariates as an information set and makes an assumption about the selection bias in the post-treatment period. Specifically, they assume that the selection bias lies within the convex hull of all pre-treatment selection biases. Under this assumption:</p>
<ul>
<li><p>They identify a set of possible ATT values.</p></li>
<li><p>With a stronger assumption on selection bias—grounded in policymakers’ perspectives—they can estimate a point estimate of ATT.</p></li>
</ul>
<p>Another useful tool for assessing parallel trends is the <code>pretrends</code> package by <span class="citation">Roth (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-roth2022pretest">2022</a>)</span>, which provides formal pre-trend tests:</p>
<div class="sourceCode" id="cb834"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install and load the pretrends package</span></span>
<span><span class="co"># install.packages("pretrends")</span></span>
<span><span class="co"># library(pretrends)</span></span></code></pre></div>
<hr>
</div>
<div id="sec-placebo-test-did" class="section level3" number="30.11.2">
<h3>
<span class="header-section-number">30.11.2</span> Placebo Test<a class="anchor" aria-label="anchor" href="#sec-placebo-test-did"><i class="fas fa-link"></i></a>
</h3>
<p>A placebo test is a diagnostic tool used in Difference-in-Differences analysis to assess whether the estimated treatment effect is driven by pre-existing trends rather than the treatment itself. The idea is to estimate a treatment effect in a scenario where no actual treatment occurred. If a significant effect is found, it suggests that the parallel trends assumption may not hold, casting doubt on the validity of the causal inference.</p>
<p><strong>Types of Placebo DiD Tests</strong></p>
<ol style="list-style-type: decimal">
<li><strong>Group-Based Placebo Test</strong></li>
</ol>
<ul>
<li>Assign treatment to a group that was never actually treated and rerun the DiD model.</li>
<li>If the estimated treatment effect is statistically significant, this suggests that differences between groups—not the treatment—are driving results.</li>
<li>This test helps rule out the possibility that the estimated effect is an artifact of unobserved systematic differences.</li>
</ul>
<p>A valid treatment effect should be consistent across different reasonable control groups. To assess this:</p>
<ul>
<li><p>Rerun the DiD model using an alternative but comparable control group.</p></li>
<li><p>Compare the estimated treatment effects across multiple control groups.</p></li>
<li><p>If results vary significantly, this suggests that the choice of control group may be influencing the estimated effect, indicating potential selection bias or unobserved confounding.</p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><strong>Time-Based Placebo Test</strong></li>
</ol>
<ul>
<li>Conduct DiD using only pre-treatment data, pretending that treatment occurred at an earlier period.</li>
<li>A significant estimated treatment effect implies that differences in pre-existing trends—not treatment—are responsible for observed post-treatment effects.</li>
<li>This test is particularly useful when concerns exist about unobserved shocks or anticipatory effects.</li>
</ul>
<p><strong>Random Reassignment of Treatment</strong></p>
<ul>
<li>Keep the same treatment and control periods but randomly assign treatment to units that were not actually treated.</li>
<li>If a significant DiD effect still emerges, it suggests the presence of biases, unobserved confounding, or systematic differences between groups that violate the parallel trends assumption.</li>
</ul>
<hr>
<p><strong>Procedure for a Placebo Test</strong></p>
<ol style="list-style-type: decimal">
<li><strong>Using Pre-Treatment Data Only</strong></li>
</ol>
<p>A robust placebo test often involves analyzing only pre-treatment periods to check whether spurious treatment effects appear. The procedure includes:</p>
<ul>
<li><p>Restricting the sample to pre-treatment periods only.</p></li>
<li><p>Assigning a fake treatment period before the actual intervention.</p></li>
<li><p>Testing a sequence of placebo cutoffs over time to examine whether different assumed treatment timings yield significant effects.</p></li>
<li><p>Generating random treatment periods and using randomization inference to assess the sampling distribution of the placebo effect.</p></li>
<li><p>Estimating the DiD model using the fake post-treatment period (<code>post_time = 1</code>).</p></li>
<li><p><strong>Interpretation</strong>: If the estimated treatment effect is statistically significant, this indicates that pre-existing trends (not treatment) might be influencing results, violating the parallel trends assumption.</p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><strong>Using Control Groups for a Placebo Test</strong></li>
</ol>
<p>If multiple control groups are available, a placebo test can also be conducted by:</p>
<ul>
<li><p>Dropping the actual treated group from the analysis.</p></li>
<li><p>Assigning one of the control groups as a fake treated group.</p></li>
<li><p>Estimating the DiD model and checking whether a significant effect is detected.</p></li>
<li>
<p><strong>Interpretation</strong>:</p>
<ul>
<li><p>If a placebo effect appears (i.e., the estimated treatment effect is significant), it suggests that even among control groups, systematic differences exist over time.</p></li>
<li><p>However, this result is not necessarily disqualifying. Some methods, such as <a href="sec-synthetic-control.html#sec-synthetic-control">Synthetic Control</a>, explicitly model such differences while maintaining credibility.</p></li>
</ul>
</li>
</ul>
<hr>
<div class="sourceCode" id="cb835"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load necessary libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/NickCH-K/causaldata">causaldata</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the dataset</span></span>
<span><span class="va">od</span> <span class="op">&lt;-</span> <span class="fu">causaldata</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/causaldata/man/organ_donations.html">organ_donations</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># Use only pre-treatment data</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Quarter_Num</span> <span class="op">&lt;=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span>    <span class="co"># Create fake (placebo) treatment variables</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        FakeTreat1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">State</span> <span class="op">==</span> <span class="st">'California'</span> <span class="op">&amp;</span></span>
<span>                                    <span class="va">Quarter</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Q12011'</span>, <span class="st">'Q22011'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        FakeTreat2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">State</span> <span class="op">==</span> <span class="st">'California'</span> <span class="op">&amp;</span></span>
<span>                                    <span class="va">Quarter</span> <span class="op">==</span> <span class="st">'Q22011'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the placebo effects using fixed effects regression</span></span>
<span><span class="va">clfe1</span> <span class="op">&lt;-</span> <span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">Rate</span> <span class="op">~</span> <span class="va">FakeTreat1</span> <span class="op">|</span> <span class="va">State</span> <span class="op">+</span> <span class="va">Quarter</span>, data <span class="op">=</span> <span class="va">od</span><span class="op">)</span></span>
<span><span class="va">clfe2</span> <span class="op">&lt;-</span> <span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">Rate</span> <span class="op">~</span> <span class="va">FakeTreat2</span> <span class="op">|</span> <span class="va">State</span> <span class="op">+</span> <span class="va">Quarter</span>, data <span class="op">=</span> <span class="va">od</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display the regression results</span></span>
<span><span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/etable.html">etable</a></span><span class="op">(</span><span class="va">clfe1</span>, <span class="va">clfe2</span><span class="op">)</span></span>
<span><span class="co">#&gt;                           clfe1            clfe2</span></span>
<span><span class="co">#&gt; Dependent Var.:            Rate             Rate</span></span>
<span><span class="co">#&gt;                                                 </span></span>
<span><span class="co">#&gt; FakeTreat1      0.0061 (0.0051)                 </span></span>
<span><span class="co">#&gt; FakeTreat2                      -0.0017 (0.0028)</span></span>
<span><span class="co">#&gt; Fixed-Effects:  --------------- ----------------</span></span>
<span><span class="co">#&gt; State                       Yes              Yes</span></span>
<span><span class="co">#&gt; Quarter                     Yes              Yes</span></span>
<span><span class="co">#&gt; _______________ _______________ ________________</span></span>
<span><span class="co">#&gt; S.E.: Clustered       by: State        by: State</span></span>
<span><span class="co">#&gt; Observations                 81               81</span></span>
<span><span class="co">#&gt; R2                      0.99377          0.99376</span></span>
<span><span class="co">#&gt; Within R2               0.00192          0.00015</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span></span>
<span><span class="co"># Extract coefficients and confidence intervals</span></span>
<span><span class="va">coef_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    Model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"FakeTreat1"</span>, <span class="st">"FakeTreat2"</span><span class="op">)</span>,</span>
<span>    Estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">clfe1</span><span class="op">)</span><span class="op">[</span><span class="st">"FakeTreat1"</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">clfe2</span><span class="op">)</span><span class="op">[</span><span class="st">"FakeTreat2"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    SE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">clfe1</span><span class="op">)</span><span class="op">$</span><span class="va">coeftable</span><span class="op">[</span><span class="st">"FakeTreat1"</span>, <span class="st">"Std. Error"</span><span class="op">]</span>, </span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">clfe2</span><span class="op">)</span><span class="op">$</span><span class="va">coeftable</span><span class="op">[</span><span class="st">"FakeTreat2"</span>, <span class="st">"Std. Error"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    Lower <span class="op">=</span> <span class="va">Estimate</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">SE</span>,</span>
<span>    Upper <span class="op">=</span> <span class="va">Estimate</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">SE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the placebo effects</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">coef_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Model</span>, y <span class="op">=</span> <span class="va">Estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">Lower</span>, ymax <span class="op">=</span> <span class="va">Upper</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">0.2</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"Placebo Treatment Effects"</span>,</span>
<span>        y <span class="op">=</span> <span class="st">"Estimated Effect on Organ Donation Rate"</span>,</span>
<span>        x <span class="op">=</span> <span class="st">"Placebo Treatment"</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.5-did-concerns_files/figure-html/unnamed-chunk-4-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>We would like the “supposed” DiD to be insignificant.</p>
</div>
</div>
<div id="robustness-checks-4" class="section level2" number="30.12">
<h2>
<span class="header-section-number">30.12</span> Robustness Checks<a class="anchor" aria-label="anchor" href="#robustness-checks-4"><i class="fas fa-link"></i></a>
</h2>
<p>A well-executed Difference-in-Differences analysis requires <strong>robustness checks</strong> to verify the validity of estimated treatment effects and <strong>best practices</strong> to ensure methodological rigor.</p>
<hr>
<div id="robustness-checks-to-strengthen-causal-interpretation" class="section level3" number="30.12.1">
<h3>
<span class="header-section-number">30.12.1</span> Robustness Checks to Strengthen Causal Interpretation<a class="anchor" aria-label="anchor" href="#robustness-checks-to-strengthen-causal-interpretation"><i class="fas fa-link"></i></a>
</h3>
<p>Once the parallel trends assumption is assessed, additional <strong>robustness tests</strong> ensure that treatment effects are not driven by confounding factors or modeling choices.</p>
<ol style="list-style-type: decimal">
<li><strong>Varying the Time Window</strong></li>
</ol>
<ul>
<li>Shorter time windows reduce exposure to long-term confounders but risk losing statistical power.</li>
<li>Longer time windows capture persistent effects but may introduce unrelated policy changes.</li>
<li>Solution: Estimate the DiD model across different time horizons and check if results are stable.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><strong>Higher-Order Polynomial Time Trends</strong></li>
</ol>
<ul>
<li>Standard DiD models assume a linear time trend.</li>
<li>If trends are nonlinear, this assumption may be too restrictive.</li>
<li>Solution: Introduce quadratic or cubic time trends and verify whether results hold.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><strong>Testing Alternative Dependent Variables</strong></li>
</ol>
<ul>
<li>The treatment should only affect the expected dependent variable.</li>
<li>A robustness check involves running the DiD on unrelated dependent variables.</li>
<li>If treatment effects appear where they should not, this signals a possible identification problem.</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li><strong>Triple-Difference (DDD) Strategy</strong></li>
</ol>
<p>A Triple-Difference (DDD) model adds an additional comparison group to address remaining biases:</p>
<p><span class="math display">\[
\begin{aligned}
Y_{ijt} &amp;= \alpha + \gamma Treat_{i} + \lambda Post_t + \theta Group_j + \delta_1 (Treat_i \times Post_t) \\
&amp;+ \delta_2 (Treat_i \times Group_j) + \delta_3 (Post_t \times Group_j) \\
&amp;+ \delta_4 (Treat_i \times Post_t \times Group_j) + \epsilon_{ijt}
\end{aligned}
\]</span></p>
<p>where:</p>
<ul>
<li><p><span class="math inline">\(Group_j\)</span> represents a subgroup within treatment/control (e.g., high- vs. low-intensity exposure).</p></li>
<li><p><span class="math inline">\(\delta_4\)</span> captures the DDD effect, which removes residual biases present in the standard DiD model.</p></li>
</ul>
<hr>
</div>
<div id="best-practices-for-reliable-did-implementation" class="section level3" number="30.12.2">
<h3>
<span class="header-section-number">30.12.2</span> Best Practices for Reliable DiD Implementation<a class="anchor" aria-label="anchor" href="#best-practices-for-reliable-did-implementation"><i class="fas fa-link"></i></a>
</h3>
<p>To improve the credibility and transparency of DiD estimates, researchers should adhere to the following best practices:</p>
<ol style="list-style-type: decimal">
<li><strong>Documenting Treatment Cohorts</strong></li>
</ol>
<ul>
<li>Clearly report the number of treated and control units over time.</li>
<li>If treatment is staggered, adjust for different exposure durations.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><strong>Checking Covariate Balance &amp; Overlap</strong></li>
</ol>
<ul>
<li>Verify whether the distribution of covariates is similar across treatment and control groups.</li>
<li>If treatment and control groups differ significantly, consider using matching methods.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><strong>Conducting Sensitivity Analyses for Parallel Trends</strong></li>
</ol>
<ul>
<li>Apply alternative weighting schemes (e.g., entropy balancing) to reduce dependence on model assumptions.</li>
<li>Use <code>honestDiD</code> to test robustness under different parallel trends violations.</li>
</ul>
</div>
</div>
<div id="concerns-in-did" class="section level2" number="30.13">
<h2>
<span class="header-section-number">30.13</span> Concerns in DID<a class="anchor" aria-label="anchor" href="#concerns-in-did"><i class="fas fa-link"></i></a>
</h2>
<div id="matching-methods-in-did" class="section level3" number="30.13.1">
<h3>
<span class="header-section-number">30.13.1</span> Matching Methods in DID<a class="anchor" aria-label="anchor" href="#matching-methods-in-did"><i class="fas fa-link"></i></a>
</h3>
<p>Matching methods are often used in <strong>causal inference</strong> to balance treated and control units based on <strong>pre-treatment observables</strong>. In the context of Difference-in-Differences, matching helps:</p>
<ul>
<li>Reduce selection bias by ensuring that treated and control units are comparable before treatment.</li>
<li>Improve parallel trends validity by selecting control units with similar pre-treatment trajectories.</li>
<li>Enhance robustness when treatment assignment is non-random across groups.</li>
</ul>
<p><strong>Key Considerations in Matching</strong></p>
<ul>
<li>
<strong>Standard Errors Need Adjustment</strong>
<ul>
<li>Standard errors should account for the fact that matching reduces variance <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-heckman1997matching">J. J. Heckman, Ichimura, and Todd 1997</a>)</span>.</li>
<li>A more robust alternative is Doubly Robust DID <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-sant2020doubly">Sant’Anna and Zhao 2020</a>)</span>, where either matching or regression suffices for unbiased treatment effect identification.</li>
</ul>
</li>
<li>
<strong>Group Fixed Effects Alone Do Not Eliminate Selection Bias</strong>
<ul>
<li>Fixed effects absorb time-invariant heterogeneity, but do not correct for selection into treatment.</li>
<li>Matching helps close the “backdoor path” between:
<ol style="list-style-type: decimal">
<li>Propensity to be treated</li>
<li>Dynamics of outcome evolution post-treatment</li>
</ol>
</li>
</ul>
</li>
<li>
<strong>Matching on Time-Varying Covariates</strong>
<ul>
<li>Beware of regression to the mean: extreme pre-treatment outcomes may artificially bias post-treatment estimates <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-daw2018matching">Daw and Hatfield 2018</a>)</span>.</li>
<li>This issue is less concerning for time-invariant covariates.</li>
</ul>
</li>
<li>
<strong>Comparing Matching vs. DID Performance</strong>
<ul>
<li>Matching and DID both use pre-treatment outcomes to mitigate selection bias.</li>
<li>Simulations <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-chabe2015analysis">Chabé-Ferret 2015</a>)</span> show that:
<ul>
<li>Matching tends to underestimate the true treatment effect but improves with more pre-treatment periods.</li>
<li>When selection bias is symmetric, Symmetric DID (equal pre- and post-treatment periods) performs well.</li>
<li>When selection bias is asymmetric, DID generally outperforms Matching.</li>
</ul>
</li>
</ul>
</li>
<li>
<strong>Forward DID as a Control Unit Selection Algorithm</strong>
<ul>
<li>An efficient way to select control units is Forward DID <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-li2024frontiers">K. T. Li 2024</a>)</span>.</li>
</ul>
</li>
</ul>
<hr>
</div>
<div id="control-variables-in-did" class="section level3" number="30.13.2">
<h3>
<span class="header-section-number">30.13.2</span> Control Variables in DID<a class="anchor" aria-label="anchor" href="#control-variables-in-did"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Always report results with and without controls:
<ul>
<li>If controls are fixed within groups or time periods, they should be absorbed in fixed effects.</li>
<li>If controls vary across both groups and time, this suggests the parallel trends assumption is questionable.</li>
</ul>
</li>
<li>
<span class="math inline">\(R^2\)</span> is not crucial in causal inference:
<ul>
<li>Unlike predictive models, causal models do not prioritize explanatory power (<span class="math inline">\(R^2\)</span>), but rather unbiased identification of treatment effects.</li>
</ul>
</li>
</ul>
<hr>
</div>
<div id="did-for-count-data-fixed-effects-poisson-model" class="section level3" number="30.13.3">
<h3>
<span class="header-section-number">30.13.3</span> DID for Count Data: Fixed-Effects Poisson Model<a class="anchor" aria-label="anchor" href="#did-for-count-data-fixed-effects-poisson-model"><i class="fas fa-link"></i></a>
</h3>
<p>For count data, one can use the fixed-effects Poisson pseudo-maximum likelihood estimator (PPML) <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-athey2006identification">Athey and Imbens 2006</a>; <a href="chapter-cluster-randomization-and-interference-bias.html#ref-puhani2012treatment">Puhani 2012</a>)</span>. Applications of this method can be found in management <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-burtch2018can">Burtch, Carnahan, and Greenwood 2018</a>)</span> and marketing <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-he2021end">C. He et al. 2021</a>)</span>.</p>
<p>This approach offers robust standard errors under over-dispersion <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-wooldridge1999quasi">Wooldridge 1999</a>)</span> and is particularly useful when dealing with excess zeros in the data.</p>
<p>Key advantages of PPML:</p>
<ul>
<li>Handles zero-inflated data better than log-OLS: A log-OLS regression may produce biased estimates <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-o2010not">O’Hara and Kotze 2010</a>)</span> when heteroskedasticity is present <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-silva2006log">Silva and Tenreyro 2006</a>)</span>, especially in datasets with many zeros <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-silva2011further">Silva and Tenreyro 2011</a>)</span>.</li>
<li>Avoids the limitations of negative binomial fixed effects: Unlike Poisson, there is no widely accepted fixed-effects estimator for the negative binomial model <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-allison20027">Allison and Waterman 2002</a>)</span>.</li>
</ul>
<hr>
</div>
<div id="handling-zero-valued-outcomes-in-did" class="section level3" number="30.13.4">
<h3>
<span class="header-section-number">30.13.4</span> Handling Zero-Valued Outcomes in DID<a class="anchor" aria-label="anchor" href="#handling-zero-valued-outcomes-in-did"><i class="fas fa-link"></i></a>
</h3>
<p>When dealing with <strong>zero-valued outcomes</strong>, it is crucial to separate the <strong>intensive margin effect</strong> (e.g., outcome changes from 10 to 11) from the <strong>extensive margin effect</strong> (e.g., outcome changes from 0 to 1).</p>
<p>A common issue is that the treatment coefficient from a <strong>log-transformed regression</strong> cannot be directly interpreted as a percentage change when zeros are present <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-chen2024logs">J. Chen and Roth 2024</a>)</span>. To address this, we can consider two alternative approaches:</p>
<ol style="list-style-type: decimal">
<li><strong>Proportional Treatment Effects</strong></li>
</ol>
<p>We define the percentage change in the treated group’s post-treatment outcome as:</p>
<p><span class="math display">\[
\theta_{ATT\%} = \frac{E[Y_{it}(1) \mid D_i = 1, Post_t = 1] - E[Y_{it}(0) \mid D_i = 1, Post_t = 1]}{E[Y_{it}(0) \mid D_i = 1, Post_t = 1]}
\]</span></p>
<p>Instead of assuming parallel trends in levels, we can rely on a parallel trends assumption in ratios <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-wooldridge2023simple">Wooldridge 2023</a>)</span>.</p>
<p>The Poisson QMLE model is:</p>
<p><span class="math display">\[
Y_{it} = \exp(\beta_0 + \beta_1 D_i \times Post_t + \beta_2 D_i + \beta_3 Post_t + X_{it}) \epsilon_{it}
\]</span></p>
<p>The treatment effect is estimated as:</p>
<p><span class="math display">\[
\hat{\theta}_{ATT\%} = \exp(\hat{\beta}_1) - 1
\]</span></p>
<p>To validate the parallel trends in ratios assumption, we can estimate a dynamic Poisson QMLE model:</p>
<p><span class="math display">\[
Y_{it} = \exp(\lambda_t + \beta_2 D_i + \sum_{r \neq -1} \beta_r D_i \times (RelativeTime_t = r))
\]</span></p>
<p>If the assumption holds, we expect:</p>
<p><span class="math display">\[
\exp(\hat{\beta}_r) - 1 = 0 \quad \text{for} \quad r &lt; 0.
\]</span></p>
<p>Even if the pre-treatment estimates appear close to zero, we should still conduct a sensitivity analysis <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-rambachan2023more">Rambachan and Roth 2023</a>)</span> to assess robustness (see <a href="sec-difference-in-differences.html#prior-parallel-trends-test">Prior Parallel Trends Test</a>).</p>
<div class="sourceCode" id="cb836"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span> <span class="co"># For reproducibility</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span> <span class="co"># Number of observations per group (treated and control)</span></span>
<span><span class="co"># Generating IDs for a panel setup</span></span>
<span><span class="va">ID</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, times <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Defining groups and periods</span></span>
<span><span class="va">Group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="st">"Treated"</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Before"</span>, <span class="st">"After"</span><span class="op">)</span>, times <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">Treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Group</span> <span class="op">==</span> <span class="st">"Treated"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">Post</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Time</span> <span class="op">==</span> <span class="st">"After"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 1: Generate baseline outcomes with a zero-inflated model</span></span>
<span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">20</span> <span class="co"># Average rate of occurrence</span></span>
<span><span class="va">zero_inflation</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># Proportion of zeros</span></span>
<span><span class="va">Y_baseline</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">zero_inflation</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">n</span>, <span class="va">lambda</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 2: Apply DiD treatment effect on the treated group in the post-treatment period</span></span>
<span><span class="va">Treatment_Effect</span> <span class="op">&lt;-</span> <span class="va">Treatment</span> <span class="op">*</span> <span class="va">Post</span></span>
<span><span class="va">Y_treatment</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Treatment_Effect</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">n</span>, lambda <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Incorporating a simple time trend, ensuring outcomes are non-negative</span></span>
<span><span class="va">Time_Trend</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Time</span> <span class="op">==</span> <span class="st">"After"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">n</span>, lambda <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 3: Combine to get the observed outcomes</span></span>
<span><span class="va">Y_observed</span> <span class="op">&lt;-</span> <span class="va">Y_baseline</span> <span class="op">+</span> <span class="va">Y_treatment</span> <span class="op">+</span> <span class="va">Time_Trend</span></span>
<span></span>
<span><span class="co"># Ensure no negative outcomes after the time trend</span></span>
<span><span class="va">Y_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Y_observed</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="va">Y_observed</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the final dataset</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>        ID <span class="op">=</span> <span class="va">ID</span>,</span>
<span>        Treatment <span class="op">=</span> <span class="va">Treatment</span>,</span>
<span>        Period <span class="op">=</span> <span class="va">Post</span>,</span>
<span>        Outcome <span class="op">=</span> <span class="va">Y_observed</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># Viewing the first few rows of the dataset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ID Treatment Period Outcome</span></span>
<span><span class="co">#&gt; 1  1         0      0       0</span></span>
<span><span class="co">#&gt; 2  2         0      1      25</span></span>
<span><span class="co">#&gt; 3  3         0      0       0</span></span>
<span><span class="co">#&gt; 4  4         0      1      20</span></span>
<span><span class="co">#&gt; 5  5         0      0      19</span></span>
<span><span class="co">#&gt; 6  6         0      1       0</span></span></code></pre></div>
<div class="sourceCode" id="cb837"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="va">res_pois</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feglm.html">fepois</a></span><span class="op">(</span><span class="va">Outcome</span> <span class="op">~</span> <span class="va">Treatment</span> <span class="op">+</span> <span class="va">Period</span> <span class="op">+</span> <span class="va">Treatment</span> <span class="op">*</span> <span class="va">Period</span>,</span>
<span>           data <span class="op">=</span> <span class="va">data</span>,</span>
<span>           vcov <span class="op">=</span> <span class="st">"hetero"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/etable.html">etable</a></span><span class="op">(</span><span class="va">res_pois</span><span class="op">)</span></span>
<span><span class="co">#&gt;                             res_pois</span></span>
<span><span class="co">#&gt; Dependent Var.:              Outcome</span></span>
<span><span class="co">#&gt;                                     </span></span>
<span><span class="co">#&gt; Constant           2.249*** (0.0717)</span></span>
<span><span class="co">#&gt; Treatment           0.1743. (0.0932)</span></span>
<span><span class="co">#&gt; Period               0.0662 (0.0960)</span></span>
<span><span class="co">#&gt; Treatment x Period   0.0314 (0.1249)</span></span>
<span><span class="co">#&gt; __________________ _________________</span></span>
<span><span class="co">#&gt; S.E. type          Heteroskeda.-rob.</span></span>
<span><span class="co">#&gt; Observations                   1,000</span></span>
<span><span class="co">#&gt; Squared Cor.                 0.01148</span></span>
<span><span class="co">#&gt; Pseudo R2                    0.00746</span></span>
<span><span class="co">#&gt; BIC                         15,636.8</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span></span>
<span><span class="co"># Average percentage change</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coefficients</a></span><span class="op">(</span><span class="va">res_pois</span><span class="op">)</span><span class="op">[</span><span class="st">"Treatment:Period"</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="co">#&gt; Treatment:Period </span></span>
<span><span class="co">#&gt;       0.03191643</span></span>
<span></span>
<span><span class="co"># SE using delta method</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coefficients</a></span><span class="op">(</span><span class="va">res_pois</span><span class="op">)</span><span class="op">[</span><span class="st">"Treatment:Period"</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">res_pois</span><span class="op">$</span><span class="va">cov.scaled</span><span class="op">[</span><span class="st">"Treatment:Period"</span>, <span class="st">"Treatment:Period"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; Treatment:Period </span></span>
<span><span class="co">#&gt;        0.1288596</span></span></code></pre></div>
<p>In this example, the DID coefficient is not significant. However, say that it’s significant, we can interpret the coefficient as 3 percent increase in post-treatment period due to the treatment.</p>
<div class="sourceCode" id="cb838"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">base_did_log0</span> <span class="op">&lt;-</span> <span class="va">base_did</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">y</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">y</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res_pois_es</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feglm.html">fepois</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/i.html">i</a></span><span class="op">(</span><span class="va">period</span>, <span class="va">treat</span>, <span class="fl">5</span><span class="op">)</span> <span class="op">|</span> <span class="va">id</span> <span class="op">+</span> <span class="va">period</span>,</span>
<span>           data <span class="op">=</span> <span class="va">base_did_log0</span>,</span>
<span>           vcov <span class="op">=</span> <span class="st">"hetero"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/etable.html">etable</a></span><span class="op">(</span><span class="va">res_pois_es</span><span class="op">)</span></span>
<span><span class="co">#&gt;                            res_pois_es</span></span>
<span><span class="co">#&gt; Dependent Var.:                      y</span></span>
<span><span class="co">#&gt;                                       </span></span>
<span><span class="co">#&gt; x1                  0.1895*** (0.0108)</span></span>
<span><span class="co">#&gt; treat x period = 1    -0.2769 (0.3545)</span></span>
<span><span class="co">#&gt; treat x period = 2    -0.2699 (0.3533)</span></span>
<span><span class="co">#&gt; treat x period = 3     0.1737 (0.3520)</span></span>
<span><span class="co">#&gt; treat x period = 4    -0.2381 (0.3249)</span></span>
<span><span class="co">#&gt; treat x period = 6     0.3724 (0.3086)</span></span>
<span><span class="co">#&gt; treat x period = 7    0.7739* (0.3117)</span></span>
<span><span class="co">#&gt; treat x period = 8    0.5028. (0.2962)</span></span>
<span><span class="co">#&gt; treat x period = 9   0.9746** (0.3092)</span></span>
<span><span class="co">#&gt; treat x period = 10  1.310*** (0.3193)</span></span>
<span><span class="co">#&gt; Fixed-Effects:      ------------------</span></span>
<span><span class="co">#&gt; id                                 Yes</span></span>
<span><span class="co">#&gt; period                             Yes</span></span>
<span><span class="co">#&gt; ___________________ __________________</span></span>
<span><span class="co">#&gt; S.E. type           Heteroskedas.-rob.</span></span>
<span><span class="co">#&gt; Observations                     1,080</span></span>
<span><span class="co">#&gt; Squared Cor.                   0.51131</span></span>
<span><span class="co">#&gt; Pseudo R2                      0.34836</span></span>
<span><span class="co">#&gt; BIC                            5,868.8</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">iplot</a></span><span class="op">(</span><span class="va">res_pois_es</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.5-did-concerns_files/figure-html/estiamte%20teh%20proprortion%20treatment%20effects%20for%20event-study%20form-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>This parallel trend is the “ratio” version as in <span class="citation">Wooldridge (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-wooldridge2023simple">2023</a>)</span> :</p>
<p><span class="math display">\[
\frac{E(Y_{it}(0) |D_i = 1, Post_t = 1)}{E(Y_{it}(0) |D_i = 1, Post_t = 0)} = \frac{E(Y_{it}(0) |D_i = 0, Post_t = 1)}{E(Y_{it}(0) |D_i =0, Post_t = 0)}
\]</span></p>
<p>which means without treatment, the average percentage change in the mean outcome for treated group is identical to that of the control group.</p>
<ol start="2" style="list-style-type: decimal">
<li><strong>Log Effects with Calibrated Extensive-Margin Value</strong></li>
</ol>
<p>A potential limitation of proportional treatment effects is that they may not be well-suited for heavy-tailed outcomes. In such cases, we may prefer to explicitly model the extensive margin effect.</p>
<p>Following <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-chen2024logs">J. Chen and Roth 2024, 39</a>)</span>, we can calibrate the weight placed on the intensive vs. extensive margin to ensure meaningful interpretation of the treatment effect.</p>
<p>If we want to study the treatment effect on a concave transformation of the outcome that is less influenced by those in the distribution’s tail, then we can perform this analysis.</p>
<p>Steps:</p>
<ol style="list-style-type: decimal">
<li>Normalize the outcomes such that 1 represents the minimum non-zero and positive value (i.e., divide the outcome by its minimum non-zero and positive value).</li>
<li>Estimate the treatment effects for the new outcome</li>
</ol>
<p><span class="math display">\[
m(y) =
\begin{cases}
\log(y) &amp; \text{for } y &gt;0 \\
-x &amp; \text{for } y = 0
\end{cases}
\]</span></p>
<p>The choice of <span class="math inline">\(x\)</span> depends on what the researcher is interested in:</p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="7%">
<col width="92%">
</colgroup>
<thead><tr class="header">
<th>Value of <span class="math inline">\(x\)</span>
</th>
<th>Interest</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(x = 0\)</span></td>
<td>The treatment effect in logs where all zero-valued outcomes are set to equal the minimum non-zero value (i.e., we exclude the extensive-margin change between 0 and <span class="math inline">\(y_{min}\)</span> )</td>
</tr>
<tr class="even">
<td><span class="math inline">\(x&gt;0\)</span></td>
<td>Setting the change between 0 and <span class="math inline">\(y_{min}\)</span> to be valued as the equivalent of a <span class="math inline">\(x\)</span> log point change along the intensive margin.</td>
</tr>
</tbody>
</table></div>
<div class="sourceCode" id="cb839"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="va">base_did_log0_cali</span> <span class="op">&lt;-</span> <span class="va">base_did_log0</span> <span class="op">|&gt;</span> </span>
<span>    <span class="co"># get min </span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>min_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">y</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    </span>
<span>    <span class="co"># normalized the outcome </span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>y_norm <span class="op">=</span> <span class="va">y</span> <span class="op">/</span> <span class="va">min_y</span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_regression</span> <span class="op">&lt;-</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">base_did_log0_cali</span> <span class="op">&lt;-</span></span>
<span>            <span class="va">base_did_log0_cali</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>my <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">y_norm</span> <span class="op">==</span> <span class="fl">0</span>,<span class="op">-</span><span class="va">x</span>,</span>
<span>                                                      <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">y_norm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">my_reg</span> <span class="op">&lt;-</span></span>
<span>            <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span></span>
<span>                fml <span class="op">=</span> <span class="va">my</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/i.html">i</a></span><span class="op">(</span><span class="va">period</span>, <span class="va">treat</span>, <span class="fl">5</span><span class="op">)</span> <span class="op">|</span> <span class="va">id</span> <span class="op">+</span> <span class="va">period</span>,</span>
<span>                data <span class="op">=</span> <span class="va">base_did_log0_cali</span>,</span>
<span>                vcov <span class="op">=</span> <span class="st">"hetero"</span></span>
<span>            <span class="op">)</span></span>
<span>        </span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">my_reg</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span><span class="va">xvec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.1</span>, <span class="fl">.5</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">reg_list</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="va">xvec</span>, .f <span class="op">=</span> <span class="va">my_regression</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">iplot</a></span><span class="op">(</span><span class="va">reg_list</span>, </span>
<span>      pt.col <span class="op">=</span>  <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">xvec</span><span class="op">)</span>,</span>
<span>      pt.pch <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">xvec</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, </span>
<span>       col <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">xvec</span><span class="op">)</span>,</span>
<span>       pch <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">xvec</span><span class="op">)</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">xvec</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30.5-did-concerns_files/figure-html/unnamed-chunk-5-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb840"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/etable.html">etable</a></span><span class="op">(</span></span>
<span>    <span class="va">reg_list</span>,</span>
<span>    headers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"Extensive-margin value (x)"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">xvec</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    digits <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    digits.stats <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;                                   model 1        model 2        model 3</span></span>
<span><span class="co">#&gt; Extensive-margin value (x)              0            0.1            0.5</span></span>
<span><span class="co">#&gt; Dependent Var.:                        my             my             my</span></span>
<span><span class="co">#&gt;                                                                        </span></span>
<span><span class="co">#&gt; x1                         0.43*** (0.02) 0.44*** (0.02) 0.46*** (0.03)</span></span>
<span><span class="co">#&gt; treat x period = 1           -0.92 (0.67)   -0.94 (0.69)    -1.0 (0.73)</span></span>
<span><span class="co">#&gt; treat x period = 2           -0.41 (0.66)   -0.42 (0.67)   -0.43 (0.71)</span></span>
<span><span class="co">#&gt; treat x period = 3           -0.34 (0.67)   -0.35 (0.68)   -0.38 (0.73)</span></span>
<span><span class="co">#&gt; treat x period = 4            -1.0 (0.67)    -1.0 (0.68)    -1.1 (0.73)</span></span>
<span><span class="co">#&gt; treat x period = 6            0.44 (0.66)    0.44 (0.67)    0.45 (0.72)</span></span>
<span><span class="co">#&gt; treat x period = 7            1.1. (0.64)    1.1. (0.65)    1.2. (0.70)</span></span>
<span><span class="co">#&gt; treat x period = 8            1.1. (0.64)    1.1. (0.65)     1.1 (0.69)</span></span>
<span><span class="co">#&gt; treat x period = 9           1.7** (0.65)   1.7** (0.66)    1.8* (0.70)</span></span>
<span><span class="co">#&gt; treat x period = 10         2.4*** (0.62)  2.4*** (0.63)  2.5*** (0.68)</span></span>
<span><span class="co">#&gt; Fixed-Effects:             -------------- -------------- --------------</span></span>
<span><span class="co">#&gt; id                                    Yes            Yes            Yes</span></span>
<span><span class="co">#&gt; period                                Yes            Yes            Yes</span></span>
<span><span class="co">#&gt; __________________________ ______________ ______________ ______________</span></span>
<span><span class="co">#&gt; S.E. type                  Heterosk.-rob. Heterosk.-rob. Heterosk.-rob.</span></span>
<span><span class="co">#&gt; Observations                        1,080          1,080          1,080</span></span>
<span><span class="co">#&gt; R2                                   0.43           0.43           0.43</span></span>
<span><span class="co">#&gt; Within R2                            0.26           0.26           0.25</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                                   model 4        model 5</span></span>
<span><span class="co">#&gt; Extensive-margin value (x)              1              3</span></span>
<span><span class="co">#&gt; Dependent Var.:                        my             my</span></span>
<span><span class="co">#&gt;                                                         </span></span>
<span><span class="co">#&gt; x1                         0.49*** (0.03) 0.62*** (0.04)</span></span>
<span><span class="co">#&gt; treat x period = 1            -1.1 (0.79)     -1.5 (1.0)</span></span>
<span><span class="co">#&gt; treat x period = 2           -0.44 (0.77)   -0.51 (0.99)</span></span>
<span><span class="co">#&gt; treat x period = 3           -0.43 (0.78)    -0.60 (1.0)</span></span>
<span><span class="co">#&gt; treat x period = 4            -1.2 (0.78)     -1.5 (1.0)</span></span>
<span><span class="co">#&gt; treat x period = 6            0.45 (0.77)     0.46 (1.0)</span></span>
<span><span class="co">#&gt; treat x period = 7             1.2 (0.75)     1.3 (0.97)</span></span>
<span><span class="co">#&gt; treat x period = 8             1.2 (0.74)     1.3 (0.96)</span></span>
<span><span class="co">#&gt; treat x period = 9            1.8* (0.75)    2.1* (0.97)</span></span>
<span><span class="co">#&gt; treat x period = 10         2.7*** (0.73)  3.2*** (0.94)</span></span>
<span><span class="co">#&gt; Fixed-Effects:             -------------- --------------</span></span>
<span><span class="co">#&gt; id                                    Yes            Yes</span></span>
<span><span class="co">#&gt; period                                Yes            Yes</span></span>
<span><span class="co">#&gt; __________________________ ______________ ______________</span></span>
<span><span class="co">#&gt; S.E. type                  Heterosk.-rob. Heterosk.-rob.</span></span>
<span><span class="co">#&gt; Observations                        1,080          1,080</span></span>
<span><span class="co">#&gt; R2                                   0.42           0.41</span></span>
<span><span class="co">#&gt; Within R2                            0.25           0.24</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre></div>
<p>We have the dynamic treatment effects for different hypothesized extensive-margin value of <span class="math inline">\(x \in (0, .1, .5, 1, 3, 5)\)</span></p>
<p>The first column is when the zero-valued outcome equal to <span class="math inline">\(y_{min, y&gt;0}\)</span> (i.e., there is no different between the minimum outcome and zero outcome - <span class="math inline">\(x = 0\)</span>)</p>
<p>For this particular example, as the extensive margin increases, we see an increase in the effect magnitude. The second column is when we assume an extensive-margin change from 0 to <span class="math inline">\(y_{min, y &gt;0}\)</span> is equivalent to a 10 (i.e., <span class="math inline">\(0.1 \times 100\)</span>) log point change along the intensive margin.</p>
<hr>
</div>
<div id="standard-errors-1" class="section level3" number="30.13.5">
<h3>
<span class="header-section-number">30.13.5</span> Standard Errors<a class="anchor" aria-label="anchor" href="#standard-errors-1"><i class="fas fa-link"></i></a>
</h3>
<p>One of the major statistical challenges in DiD estimation is serial correlation in the error terms. This issue is particularly problematic because it can lead to underestimated standard errors, inflating the likelihood of Type I errors (false positives). As discussed in <span class="citation">Bertrand, Duflo, and Mullainathan (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-bertrand2004much">2004</a>)</span>, serial correlation arises in DiD settings due to several factors:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Long time series</strong>: Many DiD studies use multiple time periods, increasing the risk of correlated errors.</li>
<li>
<strong>Highly positively serially correlated outcomes</strong>: Many economic and business variables (e.g., GDP, sales, employment rates) exhibit strong persistence over time.</li>
<li>
<strong>Minimal within-group variation in treatment timing</strong>: For example, in a state-level policy change, all individuals in a state receive treatment at the same time, leading to correlation within state-time clusters.</li>
</ol>
<p>To correct for serial correlation, various methods can be employed. However, some approaches work better than others:</p>
<ul>
<li>
<strong>Avoid standard parametric corrections</strong>: A common approach is to model the error term using an autoregressive (AR) process. However, <span class="citation">Bertrand, Duflo, and Mullainathan (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-bertrand2004much">2004</a>)</span> show that this often fails in DiD settings because it does not fully account for within-group correlation.</li>
<li>
<strong>Nonparametric solutions (preferred when the number of groups is large)</strong>:
<ul>
<li>
<strong>Block bootstrap</strong>: Resampling entire groups (e.g., states) rather than individual observations maintains the correlation structure and provides robust standard errors.</li>
</ul>
</li>
<li>
<strong>Collapsing data into two periods (Pre vs. Post)</strong>:
<ul>
<li>Aggregating the data into a single pre-treatment and single post-treatment period can mitigate serial correlation issues. This approach is particularly useful when the number of groups is small <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-donald2007inference">Donald and Lang 2007</a>)</span>.</li>
<li>Note: While this reduces the power of the analysis by discarding variation across time, it ensures that standard errors are not artificially deflated.</li>
</ul>
</li>
<li>
<strong>Variance-covariance matrix corrections</strong>:
<ul>
<li>Empirical corrections (e.g., cluster-robust standard errors) and arbitrary variance-covariance matrix adjustments (e.g., Newey-West) can work well, but they are reliable only in large samples.</li>
</ul>
</li>
</ul>
<p>Overall, selecting the appropriate correction method depends on the sample size and structure of the data. When possible, block bootstrapping and collapsing data into pre/post periods are among the most effective approaches.</p>
<hr>
</div>
<div id="sec-partial-identification-did" class="section level3" number="30.13.6">
<h3>
<span class="header-section-number">30.13.6</span> Partial Identification<a class="anchor" aria-label="anchor" href="#sec-partial-identification-did"><i class="fas fa-link"></i></a>
</h3>
<p>Classical DiD delivers a <strong>point‑identified</strong> estimate of the <a href="sec-causal-inference.html#sec-average-treatment-effect-on-the-treated">average treatment effect on the treated</a> (ATT) only when the <a href="sec-difference-in-differences.html#prior-parallel-trends-test">parallel‑trends assumption</a> is exact. Yet in practice pre‑trends often deviate or post‑treatment shocks differ across groups (e.g., the famous <span class="citation">Ashenfelter (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-ashenfelter1978estimating">1978</a>)</span>). Partial‑identification (PI) methods shift the question from <em>“Is the estimate unbiased?”</em> to <em>“How much would the identifying assumption have to fail before I reverse my conclusion?”</em></p>
<p>PI approaches for DiD</p>
<ul>
<li>
<span class="citation">Manski and Pepper (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-manski2018right">2018</a>)</span> propose bounding the treatment effect parameter <span class="math inline">\(\delta\)</span> across time and space in the presence of violations to the parallel trends assumption.</li>
<li>
<span class="citation">L. J. Keele et al. (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-keele2019patterns">2019</a>)</span> introduce a Rosenbaum-style sensitivity parameter that quantifies the magnitude of hidden bias necessary to reverse the sign of the estimated effect.</li>
<li>
<span class="citation">L. Keele, Hasegawa, and Small (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-keele2019bracketing">2019</a>)</span> extends this framework to settings where the treated group may be simultaneously exposed to another event, using the Rosenbaum-style sensitivity analysis to assess the robustness of causal claims under such compound treatments.</li>
<li>
<span class="citation">Ye et al. (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-ye2024negative">2024</a>)</span> utilize two control groups subjected to negatively correlated shocks to non-parametrically bracket the counterfactual trend, offering bounds on treatment effects without relying on the parallel trends assumption.</li>
<li>
<span class="citation">Leavitt (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-leavitt2020beyond">2020</a>)</span> adopts an Empirical Bayes approach that places a hierarchical prior over <span class="math inline">\(\delta\)</span>, shrinking extreme violations of parallel trends while providing posterior credible intervals that explicitly account for trend heterogeneity.</li>
<li>Two bounding strategies in <span class="citation">Rambachan and Roth (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-rambachan2023more">2023</a>)</span> —(i) <a href="#sec-relative%E2%80%91magnitude-restriction-honestdid">Relative magnitude bounds</a>: <span class="math inline">\(|\delta| \leq M \cdot \max\)</span> pre-period jumps; (ii) <a href="sec-difference-in-differences.html#sec-smoothness-restriction-honestdid">Smoothness bounds</a>: allow <span class="math inline">\(\delta\)</span>’s slope to shift by at most <span class="math inline">\(M\)</span> per period.</li>
</ul>
<hr>
<div id="canonical-did-notation-and-the-source-of-bias" class="section level4" number="30.13.6.1">
<h4>
<span class="header-section-number">30.13.6.1</span> Canonical DiD notation and the source of bias<a class="anchor" aria-label="anchor" href="#canonical-did-notation-and-the-source-of-bias"><i class="fas fa-link"></i></a>
</h4>
<p>Let</p>
<ul>
<li>
<span class="math inline">\(Y_{it}^{1}\)</span> and <span class="math inline">\(Y_{it}^{0}\)</span> be potential outcomes for unit <span class="math inline">\(i\)</span> in period <span class="math inline">\(t\)</span> under treatment and no treatment;</li>
<li>
<span class="math inline">\(D_i\in\{0,1\}\)</span> indicate ever‑treated units;</li>
<li>
<span class="math inline">\(\texttt{Post}_t\)</span> mark periods after the policy shock.</li>
</ul>
<p>For two periods (pre, post) and two groups (T = treated, U = untreated) the simple DiD estimator is</p>
<p><span class="math display">\[
\hat\beta_{DD}= \Bigl[E(Y_T^{1}\mid \texttt{Post})-E(Y_T^{0}\mid \texttt{Pre})\Bigr]\;-\;\Bigl[E(Y_U^{0}\mid \texttt{Post})-E(Y_U^{0}\mid \texttt{Pre})\Bigr].
\]</span></p>
<p>Add–subtract the <strong>counterfactual trend</strong> <span class="math inline">\(E(Y_T^{0}\mid \texttt{Post})\)</span> and rearrange:</p>
<p><span class="math display">\[
\begin{aligned}
\hat\beta_{DD} &amp;= \underbrace{E(Y_T^{1}\mid\texttt{Post})-E(Y_T^{0}\mid\texttt{Post})}_{\text{ATT}} \\
&amp;+
\underbrace{\bigl[E(Y_T^{0}\mid\texttt{Post})-E(Y_T^{0}\mid\texttt{Pre})\bigr]
-\bigl[E(Y_U^{0}\mid\texttt{Post})-E(Y_U^{0}\mid\texttt{Pre})\bigr]}_{\delta}
\end{aligned}
\]</span></p>
<p>Hence</p>
<p><span class="math display">\[
\hat\beta_{DD}= \text{ATT}+\delta .
\]</span></p>
<p>When <a href="sec-difference-in-differences.html#prior-parallel-trends-test">parallel trends</a> hold, <span class="math inline">\(\delta=0\)</span>; any violation translates <strong>one‑for‑one</strong> into bias <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-frake2025partial">Frake et al. 2025</a>)</span>.</p>
<hr>
</div>
<div id="bounding-the-att-when-deltaneq-0" class="section level4" number="30.13.6.2">
<h4>
<span class="header-section-number">30.13.6.2</span> Bounding the ATT when <span class="math inline">\(\delta\neq 0\)</span><a class="anchor" aria-label="anchor" href="#bounding-the-att-when-deltaneq-0"><i class="fas fa-link"></i></a>
</h4>
<p>The core PI idea is simple: <em>derive credible bounds on</em> <span class="math inline">\(\delta\)</span>, then translate those into bounds on the ATT.</p>
<p>Two families of restrictions—both operationalized by <span class="citation">Rambachan and Roth (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-rambachan2023more">2023</a>)</span> and implemented in the <code>honestdid</code> package—are now widely used:</p>
<ol style="list-style-type: decimal">
<li>
<a href="#sec-relative%E2%80%91magnitude-restriction-honestdid">Relative‑magnitude (RM) bounds</a>: the post‑treatment gap <span class="math inline">\(|\delta|\)</span> cannot exceed <span class="math inline">\(M\)</span> times the largest <em>period‑to‑period</em> deviation observed in the <em>pre‑treatment</em> event‑study.</li>
<li>
<a href="sec-difference-in-differences.html#sec-smoothness-restriction-honestdid">Smoothness (SM) bounds</a>: the <em>slope</em> of the treated‑minus‑control gap can change by at most <span class="math inline">\(M\)</span> units each period after treatment.</li>
</ol>
<p>Because <span class="math inline">\(M\)</span> is researcher‑chosen, inference is reported across a grid of plausible <span class="math inline">\(M\)</span> values, revealing the <em>breakdown</em> threshold where the confidence set first touches zero <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-frake2025partial">Frake et al. 2025, 14</a>)</span>.</p>
<hr>
</div>
<div id="relativemagnitude-restriction-sec-relativemagnitude-restriction-honestdid" class="section level4" number="30.13.6.3">
<h4>
<span class="header-section-number">30.13.6.3</span> Relative‑Magnitude Restriction {#sec-relative‑magnitude-restriction-honestdid}}<a class="anchor" aria-label="anchor" href="#relativemagnitude-restriction-sec-relativemagnitude-restriction-honestdid"><i class="fas fa-link"></i></a>
</h4>
<p><em>Let</em> <span class="math inline">\(\hat g_t\)</span> be the event‑study coefficient at time <span class="math inline">\(t\)</span> (normalized to zero at <span class="math inline">\(t=-1\)</span>).</p>
<ul>
<li><p><strong>Step 1 — calibrate the worst pre‑trend</strong>:<br><span class="math inline">\(M_0 = \max_{s&lt;0} |\hat g_s-\hat g_{s-1}|\)</span>.</p></li>
<li><p><strong>Step 2 — allow proportional violations post‑treatment</strong>:<br>
Impose <span class="math inline">\(|\delta_t|\le M\cdot M_0\)</span> for every <span class="math inline">\(t\ge 0\)</span>.</p></li>
<li><p><strong>Step 3 — construct “honest” confidence sets</strong> for the ATT or for period‑specific effects by solving a constrained least‑squares problem <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-rambachan2023more">Rambachan and Roth 2023</a>)</span>.</p></li>
</ul>
<hr>
</div>
<div id="sec-smoothness-restriction-honestdid" class="section level4" number="30.13.6.4">
<h4>
<span class="header-section-number">30.13.6.4</span> Smoothness Restriction<a class="anchor" aria-label="anchor" href="#sec-smoothness-restriction-honestdid"><i class="fas fa-link"></i></a>
</h4>
<p>When violations evolve gradually—e.g., treated units drift upward over time—the SM bound is more credible.</p>
<ul>
<li><p><strong>Step 1 — estimate the pre‑treatment slope</strong>:<br><span class="math inline">\(s_0 = \hat g_{-1}-\hat g_{-2}\)</span>.</p></li>
<li><p><strong>Step 2 — restrict post‑treatment slopes</strong>:<br>
The counterfactual slope in period <span class="math inline">\(k\)</span> may vary within<br><span class="math inline">\([s_0-M,\; s_0+M]\)</span>.</p></li>
<li><p><strong>Step 3 — propagate forward</strong> to obtain an admissible path for <span class="math inline">\(\delta_t\)</span>; compute the least‑favorable path, then derive confidence sets <span class="citation">(<a href="chapter-cluster-randomization-and-interference-bias.html#ref-rambachan2023more">Rambachan and Roth 2023</a>)</span>.</p></li>
</ul>
<hr>
</div>
<div id="stepbystep-empirical-workflow" class="section level4" number="30.13.6.5">
<h4>
<span class="header-section-number">30.13.6.5</span> Step‑by‑step Empirical Workflow<a class="anchor" aria-label="anchor" href="#stepbystep-empirical-workflow"><i class="fas fa-link"></i></a>
</h4>
<p>See <span class="citation">Frake et al. (<a href="chapter-cluster-randomization-and-interference-bias.html#ref-frake2025partial">2025</a>)</span>, p. 15 for a decision tree that guides the choice of method.</p>
<ol style="list-style-type: decimal">
<li>
<strong>Graph the event‑study.</strong> Are any pre‑trends visible? Quantify their magnitude and/or slope.</li>
<li>
<strong>Choose a restriction family</strong> (RM for episodic shocks, SM for trending deviations). Justify the choice theoretically (e.g., anticipation effects vs. gradual selection).</li>
<li>
<strong>Select a grid of</strong> <span class="math inline">\(M\)</span>. Always display the break‑even <span class="math inline">\(M^{*}\)</span> where the CI first covers zero; interpret <span class="math inline">\(M^{*}\)</span> in real‑world units.</li>
<li>
<strong>Report the full set, not only the “robust” interval.</strong> Transparency trumps opportunistic suppression.</li>
<li>
<strong>Complement with falsification tests</strong> (placebo policy dates, placebo outcomes) to discipline the plausible range of <span class="math inline">\(M\)</span>.</li>
<li>
<strong>Document software and code.</strong> <code>honestdid</code> (R/Stata) includes convenient wrappers for both restrictions and automatic figures.</li>
</ol>
<hr>
</div>
<div id="worked-example-stylized" class="section level4" number="30.13.6.6">
<h4>
<span class="header-section-number">30.13.6.6</span> Worked Example (Stylized)<a class="anchor" aria-label="anchor" href="#worked-example-stylized"><i class="fas fa-link"></i></a>
</h4>
<p>Suppose pre‑policy trends exhibit at most a 0.8‑point swing. Setting <span class="math inline">\(M\in\{0,0.5,1,1.5\}\)</span>:</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th><span class="math inline">\(M\)</span></th>
<th>95 % CI for ATT</th>
<th>Conclusion</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>[0.85, 1.25]</td>
<td>Positive, robust</td>
</tr>
<tr class="even">
<td>0.5</td>
<td>[0.60, 1.50]</td>
<td>Positive</td>
</tr>
<tr class="odd">
<td>1</td>
<td>[‑0.05, 1.85]</td>
<td>Sign flips plausible</td>
</tr>
<tr class="even">
<td>1.5</td>
<td>[‑0.45, 2.25]</td>
<td>Cannot rule out zero</td>
</tr>
</tbody>
</table></div>
<p>Thus the causal claim survives unless the unobserved counterfactual deviations are <span class="math inline">\(\ge 1 \times\)</span> the worst pre‑treatment kink—an interpretation far clearer than a single <span class="math inline">\(p\)</span>‑value.</p>
<hr>
</div>
<div id="common-pitfalls-and-best-practices" class="section level4" number="30.13.6.7">
<h4>
<span class="header-section-number">30.13.6.7</span> Common Pitfalls and Best Practices<a class="anchor" aria-label="anchor" href="#common-pitfalls-and-best-practices"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>
<strong>Mistaking absence of significant pre‑trends for proof of parallel‑trends.</strong> Under‑powered tests can miss economically large differences.</li>
<li>
<strong>Choosing</strong> <span class="math inline">\(M\)</span> post‑hoc. Decide the grid <em>before</em> looking at results.</li>
<li>
<strong>Ignoring sign.</strong> If theory predicts the treated counterfactual would have <strong>fallen</strong>, impose a one‑sided bound; doing otherwise wastes power.</li>
<li>
<strong>Forgetting heterogeneous timing or staggered adoption.</strong> Apply PI to group‑time ATT estimates from modern DiD estimators before aggregation.</li>
</ul>
<p>Partial‑identification transforms DiD from a “take‑it‑or‑leave‑it” enterprise into a transparent sensitivity analysis. By explicitly parameterizing—and visually communicating—the extent of permissible departures from parallel trends, researchers allow readers to map their own priors onto empirical conclusions. Used thoughtfully, PI techniques enhance credibility without demanding the impossible.</p>

</div>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="sec-synthetic-difference-in-differences.html"><span class="header-section-number">29</span> Synthetic Difference-in-Differences</a></div>
<div class="next"><a href="sec-changes-in-changes.html"><span class="header-section-number">31</span> Changes-in-Changes</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec-difference-in-differences"><span class="header-section-number">30</span> Difference-in-Differences</a></li>
<li>
<a class="nav-link" href="#empirical-studies"><span class="header-section-number">30.1</span> Empirical Studies</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#applications-of-did-in-marketing"><span class="header-section-number">30.1.1</span> Applications of DID in Marketing</a></li>
<li><a class="nav-link" href="#applications-of-did-in-economics"><span class="header-section-number">30.1.2</span> Applications of DID in Economics</a></li>
</ul>
</li>
<li><a class="nav-link" href="#sec-visualization-did"><span class="header-section-number">30.2</span> Visualization</a></li>
<li>
<a class="nav-link" href="#sec-simple-difference-in-differences"><span class="header-section-number">30.3</span> Simple Difference-in-Differences</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#basic-setup-of-did"><span class="header-section-number">30.3.1</span> Basic Setup of DID</a></li>
<li><a class="nav-link" href="#extensions-of-did"><span class="header-section-number">30.3.2</span> Extensions of DID</a></li>
<li><a class="nav-link" href="#goals-of-did"><span class="header-section-number">30.3.3</span> Goals of DID</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#empirical-research-walkthrough"><span class="header-section-number">30.4</span> Empirical Research Walkthrough</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#example-the-unintended-consequences-of-ban-the-box-policies"><span class="header-section-number">30.4.1</span> Example: The Unintended Consequences of “Ban the Box” Policies</a></li>
<li><a class="nav-link" href="#example-minimum-wage-and-employment"><span class="header-section-number">30.4.2</span> Example: Minimum Wage and Employment</a></li>
<li><a class="nav-link" href="#example-the-effects-of-grade-policies-on-major-choice"><span class="header-section-number">30.4.3</span> Example: The Effects of Grade Policies on Major Choice</a></li>
</ul>
</li>
<li><a class="nav-link" href="#one-difference"><span class="header-section-number">30.5</span> One Difference</a></li>
<li>
<a class="nav-link" href="#sec-two-way-fixed-effects"><span class="header-section-number">30.6</span> Two-Way Fixed Effects</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#canonical-twfe-model"><span class="header-section-number">30.6.1</span> Canonical TWFE Model</a></li>
<li><a class="nav-link" href="#limitations-of-twfe"><span class="header-section-number">30.6.2</span> Limitations of TWFE</a></li>
<li><a class="nav-link" href="#diagnosing-and-addressing-bias-in-twfe"><span class="header-section-number">30.6.3</span> Diagnosing and Addressing Bias in TWFE</a></li>
<li><a class="nav-link" href="#remedies-for-twfes-shortcomings"><span class="header-section-number">30.6.4</span> Remedies for TWFE’s Shortcomings</a></li>
<li><a class="nav-link" href="#best-practices-and-recommendations"><span class="header-section-number">30.6.5</span> Best Practices and Recommendations</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec-multiple-periods-and-variation-in-treatment-timing"><span class="header-section-number">30.7</span> Multiple Periods and Variation in Treatment Timing</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#sec-staggered-difference-in-differences"><span class="header-section-number">30.7.1</span> Staggered Difference-in-Differences</a></li></ul>
</li>
<li>
<a class="nav-link" href="#sec-modern-estimators-for-staggered-adoption"><span class="header-section-number">30.8</span> Modern Estimators for Staggered Adoption</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec-group-time-average-treatment-effects-callaway2021difference"><span class="header-section-number">30.8.1</span> Group-Time Average Treatment Effects (Callaway and Sant’Anna 2021)</a></li>
<li><a class="nav-link" href="#sec-cohort-average-treatment-effects-sun2021estimating"><span class="header-section-number">30.8.2</span> Cohort Average Treatment Effects (L. Sun and Abraham 2021)</a></li>
<li><a class="nav-link" href="#sec-stacked-difference-in-differences"><span class="header-section-number">30.8.3</span> Stacked Difference-in-Differences</a></li>
<li><a class="nav-link" href="#sec-panel-match-did-estimator-with-in-and-out-treatment-conditions"><span class="header-section-number">30.8.4</span> Panel Match DiD Estimator with In-and-Out Treatment Conditions</a></li>
<li><a class="nav-link" href="#counterfactual-estimators"><span class="header-section-number">30.8.5</span> Counterfactual Estimators</a></li>
<li><a class="nav-link" href="#sec-matrix-completion-estimator"><span class="header-section-number">30.8.6</span> Matrix Completion Estimator</a></li>
<li><a class="nav-link" href="#sec-reshaped-inverse-probability-weighting-twfe-estimator"><span class="header-section-number">30.8.7</span> Reshaped Inverse Probability Weighting - TWFE Estimator</a></li>
<li><a class="nav-link" href="#gardner2022two-and-borusyak2024revisiting"><span class="header-section-number">30.8.8</span> Gardner (2022) and Borusyak, Jaravel, and Spiess (2024)</a></li>
<li><a class="nav-link" href="#dynamic-treatment-effect-estimation-with-interactive-fixed-effects-and-short-panels"><span class="header-section-number">30.8.9</span> Dynamic Treatment Effect Estimation with Interactive Fixed Effects and Short Panels</a></li>
<li><a class="nav-link" href="#sec-switching-difference-in-differences-estimator-de2020two"><span class="header-section-number">30.8.10</span> Switching Difference-in-Differences Estimator (Clément De Chaisemartin and d’Haultfoeuille 2020)</a></li>
<li><a class="nav-link" href="#augmentedforward-did"><span class="header-section-number">30.8.11</span> Augmented/Forward DID</a></li>
<li><a class="nav-link" href="#doubly-robust-difference-in-differences-estimators"><span class="header-section-number">30.8.12</span> Doubly Robust Difference-in-Differences Estimators</a></li>
<li><a class="nav-link" href="#nonlinear-difference-in-differences"><span class="header-section-number">30.8.13</span> Nonlinear Difference-in-Differences</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#multiple-treatments"><span class="header-section-number">30.9</span> Multiple Treatments</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#multiple-treatment-groups-model-specification"><span class="header-section-number">30.9.1</span> Multiple Treatment Groups: Model Specification</a></li>
<li><a class="nav-link" href="#understanding-the-control-group-in-multiple-treatment-did"><span class="header-section-number">30.9.2</span> Understanding the Control Group in Multiple Treatment DiD</a></li>
<li><a class="nav-link" href="#alternative-approaches-separate-regressions-vs.-one-model"><span class="header-section-number">30.9.3</span> Alternative Approaches: Separate Regressions vs. One Model</a></li>
<li><a class="nav-link" href="#handling-treatment-intensity"><span class="header-section-number">30.9.4</span> Handling Treatment Intensity</a></li>
<li><a class="nav-link" href="#considerations-when-individuals-can-move-between-treatment-groups"><span class="header-section-number">30.9.5</span> Considerations When Individuals Can Move Between Treatment Groups</a></li>
<li><a class="nav-link" href="#parallel-trends-assumption-in-multiple-treatment-did"><span class="header-section-number">30.9.6</span> Parallel Trends Assumption in Multiple-Treatment DiD</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#mediation-under-did"><span class="header-section-number">30.10</span> Mediation Under DiD</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#mediation-model-in-did"><span class="header-section-number">30.10.1</span> Mediation Model in DiD</a></li>
<li><a class="nav-link" href="#interpreting-the-results"><span class="header-section-number">30.10.2</span> Interpreting the Results</a></li>
<li><a class="nav-link" href="#challenges-in-mediation-analysis-for-did"><span class="header-section-number">30.10.3</span> Challenges in Mediation Analysis for DiD</a></li>
<li><a class="nav-link" href="#alternative-approach-instrumental-variables-for-mediation"><span class="header-section-number">30.10.4</span> Alternative Approach: Instrumental Variables for Mediation</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#assumptions-3"><span class="header-section-number">30.11</span> Assumptions</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#prior-parallel-trends-test"><span class="header-section-number">30.11.1</span> Prior Parallel Trends Test</a></li>
<li><a class="nav-link" href="#sec-placebo-test-did"><span class="header-section-number">30.11.2</span> Placebo Test</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#robustness-checks-4"><span class="header-section-number">30.12</span> Robustness Checks</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#robustness-checks-to-strengthen-causal-interpretation"><span class="header-section-number">30.12.1</span> Robustness Checks to Strengthen Causal Interpretation</a></li>
<li><a class="nav-link" href="#best-practices-for-reliable-did-implementation"><span class="header-section-number">30.12.2</span> Best Practices for Reliable DiD Implementation</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#concerns-in-did"><span class="header-section-number">30.13</span> Concerns in DID</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#matching-methods-in-did"><span class="header-section-number">30.13.1</span> Matching Methods in DID</a></li>
<li><a class="nav-link" href="#control-variables-in-did"><span class="header-section-number">30.13.2</span> Control Variables in DID</a></li>
<li><a class="nav-link" href="#did-for-count-data-fixed-effects-poisson-model"><span class="header-section-number">30.13.3</span> DID for Count Data: Fixed-Effects Poisson Model</a></li>
<li><a class="nav-link" href="#handling-zero-valued-outcomes-in-did"><span class="header-section-number">30.13.4</span> Handling Zero-Valued Outcomes in DID</a></li>
<li><a class="nav-link" href="#standard-errors-1"><span class="header-section-number">30.13.5</span> Standard Errors</a></li>
<li><a class="nav-link" href="#sec-partial-identification-did"><span class="header-section-number">30.13.6</span> Partial Identification</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/mikenguyen13/data_analysis/blob/main/30-dif-in-dif.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/mikenguyen13/data_analysis/edit/main/30-dif-in-dif.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>A Guide on Data Analysis</strong>" was written by Mike Nguyen. It was last built on 2025-06-05.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
