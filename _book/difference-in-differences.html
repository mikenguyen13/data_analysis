<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 26 Difference-in-differences | A Guide on Data Analysis</title>
<meta name="author" content="Mike Nguyen">
<meta name="description" content="List of packages Examples in marketing (Liaukonyte, Teixeira, and Wilbur 2015): TV ad on online shopping (Wang, Lewis, and Schweidel 2018): political ad source and message tone on vote shares and...">
<meta name="generator" content="bookdown 0.35 with bs4_book()">
<meta property="og:title" content="Chapter 26 Difference-in-differences | A Guide on Data Analysis">
<meta property="og:type" content="book">
<meta property="og:url" content="https://bookdown.org/mike/data_analysis/difference-in-differences.html">
<meta property="og:image" content="https://bookdown.org/mike/data_analysis//images/cover.jpg">
<meta property="og:description" content="List of packages Examples in marketing (Liaukonyte, Teixeira, and Wilbur 2015): TV ad on online shopping (Wang, Lewis, and Schweidel 2018): political ad source and message tone on vote shares and...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 26 Difference-in-differences | A Guide on Data Analysis">
<meta name="twitter:description" content="List of packages Examples in marketing (Liaukonyte, Teixeira, and Wilbur 2015): TV ad on online shopping (Wang, Lewis, and Schweidel 2018): political ad source and message tone on vote shares and...">
<meta name="twitter:image" content="https://bookdown.org/mike/data_analysis//images/cover.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.6.1/transition.js"></script><script src="libs/bs3compat-0.6.1/tabs.js"></script><script src="libs/bs3compat-0.6.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){window.dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-DMNX2X65HQ');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">A Guide on Data Analysis</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="prerequisites.html"><span class="header-section-number">2</span> Prerequisites</a></li>
<li class="book-part">I. BASIC</li>
<li><a class="" href="descriptive-stat.html"><span class="header-section-number">3</span> Descriptive Statistics</a></li>
<li><a class="" href="basic-statistical-inference.html"><span class="header-section-number">4</span> Basic Statistical Inference</a></li>
<li class="book-part">II. REGRESSION</li>
<li><a class="" href="linear-regression.html"><span class="header-section-number">5</span> Linear Regression</a></li>
<li><a class="" href="non-linear-regression.html"><span class="header-section-number">6</span> Non-linear Regression</a></li>
<li><a class="" href="generalized-linear-models.html"><span class="header-section-number">7</span> Generalized Linear Models</a></li>
<li><a class="" href="linear-mixed-models.html"><span class="header-section-number">8</span> Linear Mixed Models</a></li>
<li><a class="" href="nonlinear-and-generalized-linear-mixed-models.html"><span class="header-section-number">9</span> Nonlinear and Generalized Linear Mixed Models</a></li>
<li class="book-part">III. RAMIFICATIONS</li>
<li><a class="" href="model-specification.html"><span class="header-section-number">10</span> Model Specification</a></li>
<li><a class="" href="imputation-missing-data.html"><span class="header-section-number">11</span> Imputation (Missing Data)</a></li>
<li><a class="" href="data.html"><span class="header-section-number">12</span> Data</a></li>
<li><a class="" href="variable-transformation.html"><span class="header-section-number">13</span> Variable Transformation</a></li>
<li><a class="" href="hypothesis-testing.html"><span class="header-section-number">14</span> Hypothesis Testing</a></li>
<li><a class="" href="marginal-effects.html"><span class="header-section-number">15</span> Marginal Effects</a></li>
<li><a class="" href="prediction-and-estimation.html"><span class="header-section-number">16</span> Prediction and Estimation</a></li>
<li><a class="" href="moderation.html"><span class="header-section-number">17</span> Moderation</a></li>
<li class="book-part">IV. CAUSAL INFERENCE</li>
<li><a class="" href="causal-inference.html"><span class="header-section-number">18</span> Causal Inference</a></li>
<li class="book-part">A. EXPERIMENTAL DESIGN</li>
<li><a class="" href="experimental-design.html"><span class="header-section-number">19</span> Experimental Design</a></li>
<li><a class="" href="sampling.html"><span class="header-section-number">20</span> Sampling</a></li>
<li><a class="" href="analysis-of-variance-anova.html"><span class="header-section-number">21</span> Analysis of Variance (ANOVA)</a></li>
<li><a class="" href="multivariate-methods.html"><span class="header-section-number">22</span> Multivariate Methods</a></li>
<li class="book-part">B. QUASI-EXPERIMENTAL DESIGN</li>
<li><a class="" href="quasi-experimental.html"><span class="header-section-number">23</span> Quasi-experimental</a></li>
<li><a class="" href="regression-discontinuity.html"><span class="header-section-number">24</span> Regression Discontinuity</a></li>
<li><a class="" href="synthetic-difference-in-differences.html"><span class="header-section-number">25</span> Synthetic Difference-in-Differences</a></li>
<li><a class="active" href="difference-in-differences.html"><span class="header-section-number">26</span> Difference-in-differences</a></li>
<li><a class="" href="synthetic-control.html"><span class="header-section-number">27</span> Synthetic Control</a></li>
<li><a class="" href="event-studies.html"><span class="header-section-number">28</span> Event Studies</a></li>
<li><a class="" href="matching-methods.html"><span class="header-section-number">29</span> Matching Methods</a></li>
<li><a class="" href="interrupted-time-series.html"><span class="header-section-number">30</span> Interrupted Time Series</a></li>
<li class="book-part">C. OTHER CONCERNS</li>
<li><a class="" href="endogeneity.html"><span class="header-section-number">31</span> Endogeneity</a></li>
<li><a class="" href="other-biases.html"><span class="header-section-number">32</span> Other Biases</a></li>
<li><a class="" href="controls.html"><span class="header-section-number">33</span> Controls</a></li>
<li class="book-part">V. MISCELLANEOUS</li>
<li><a class="" href="mediation.html"><span class="header-section-number">34</span> Mediation</a></li>
<li><a class="" href="directed-acyclic-graph.html"><span class="header-section-number">35</span> Directed Acyclic Graph</a></li>
<li><a class="" href="report.html"><span class="header-section-number">36</span> Report</a></li>
<li><a class="" href="exploratory-data-analysis.html"><span class="header-section-number">37</span> Exploratory Data Analysis</a></li>
<li><a class="" href="sensitivity-analysis-robustness-check.html"><span class="header-section-number">38</span> Sensitivity Analysis/ Robustness Check</a></li>
<li><a class="" href="replication-and-synthetic-data.html"><span class="header-section-number">39</span> Replication and Synthetic Data</a></li>
<li class="book-part">APPENDIX</li>
<li><a class="" href="appendix.html"><span class="header-section-number">A</span> Appendix</a></li>
<li><a class="" href="bookdown-cheat-sheet.html"><span class="header-section-number">B</span> Bookdown cheat sheet</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/mikenguyen13/data_analysis">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="difference-in-differences" class="section level1" number="26">
<h1>
<span class="header-section-number">26</span> Difference-in-differences<a class="anchor" aria-label="anchor" href="#difference-in-differences"><i class="fas fa-link"></i></a>
</h1>
<p><a href="https://github.com/lnsongxf/DiD-1">List of packages</a></p>
<p>Examples in marketing</p>
<ul>
<li>
<span class="citation">(<a href="references.html#ref-liaukonyte2015television">Liaukonyte, Teixeira, and Wilbur 2015</a>)</span>: TV ad on online shopping</li>
<li>
<span class="citation">(<a href="references.html#ref-wang2018border">Wang, Lewis, and Schweidel 2018</a>)</span>: political ad source and message tone on vote shares and turnout using discontinuities in the level of political ads at the borders</li>
<li>
<span class="citation">(<a href="references.html#ref-datta2018changing">Datta, Knox, and Bronnenberg 2018</a>)</span>: streaming service on total music consumption using timing of users adoption of a music streaming service</li>
<li>
<span class="citation">(<a href="references.html#ref-janakiraman2018effect">Janakiraman, Lim, and Rishika 2018</a>)</span>: data breach announcement affect customer spending using timing of data breach and variation whether customer info was breached in that event</li>
<li>
<span class="citation">(<a href="references.html#ref-israeli2018online">Israeli 2018</a>)</span>: digital monitoring and enforcement on violations using enforcement of min ad price policies</li>
<li>
<span class="citation">(<a href="references.html#ref-ramani2019effects">Ramani and Srinivasan 2019</a>)</span>: firms respond to foreign direct investment liberalization using India’s reform in 1991.</li>
<li>
<span class="citation">(<a href="references.html#ref-pattabhiramaiah2019paywalls">Pattabhiramaiah, Sriram, and Manchanda 2019</a>)</span>: paywall affects readership</li>
<li>
<span class="citation">(<a href="references.html#ref-akca2020value">Akca and Rao 2020</a>)</span>: aggregators for airlines business effect</li>
<li>
<span class="citation">(<a href="references.html#ref-lim2020competitive">Lim et al. 2020</a>)</span>: nutritional labels on nutritional quality for other brands in a category using variation in timing of adoption of nutritional labels across categories</li>
<li>
<span class="citation">(<a href="references.html#ref-guo2020let">Guo, Sriram, and Manchanda 2020</a>)</span>: payment disclosure laws effect on physician prescription behavior using Timing of the Massachusetts open payment law as the exogenous shock</li>
<li>
<span class="citation">(<a href="references.html#ref-he2022market">S. He, Hollenbeck, and Proserpio 2022</a>)</span>: using Amazon policy change to examine the causal impact of fake reviews on sales, average ratings.</li>
<li>
<span class="citation">(<a href="references.html#ref-peukert2022regulatory">Peukert et al. 2022</a>)</span>: using European General data protection Regulation, examine the impact of policy change on website usage.</li>
</ul>
<p>Show the mechanism via</p>
<ul>
<li><p><a href="difference-in-differences.html#mediation-under-did">Mediation Under DiD</a> analysis: see <span class="citation">(<a href="references.html#ref-habel2021variable">Habel, Alavi, and Linsenmayer 2021</a>)</span></p></li>
<li><p>Moderation analysis: see <span class="citation">(<a href="references.html#ref-goldfarb2011online">Goldfarb and Tucker 2011</a>)</span></p></li>
</ul>
<div id="visualization-1" class="section level2" number="26.1">
<h2>
<span class="header-section-number">26.1</span> Visualization<a class="anchor" aria-label="anchor" href="#visualization-1"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb420"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yiqingxu.org/packages/panelview/index.html">panelView</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="va">base_stagg</span> <span class="op">&lt;-</span> <span class="fu">fixest</span><span class="fu">::</span><span class="va"><a href="https://lrberge.github.io/fixest/reference/base_stagg.html">base_stagg</a></span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># treatment status</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>treat_stat <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">time_to_treatment</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">year</span>, <span class="va">treat_stat</span>, <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">base_stagg</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id year treat_stat           y</span></span>
<span><span class="co">#&gt; 2 90    1          0  0.01722971</span></span>
<span><span class="co">#&gt; 3 89    1          0 -4.58084528</span></span>
<span><span class="co">#&gt; 4 88    1          0  2.73817174</span></span>
<span><span class="co">#&gt; 5 87    1          0 -0.65103066</span></span>
<span><span class="co">#&gt; 6 86    1          0 -5.33381664</span></span>
<span><span class="co">#&gt; 7 85    1          0  0.49562631</span></span>
<span></span>
<span><span class="fu">panelView</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/panelView/man/panelView.html">panelview</a></span><span class="op">(</span></span>
<span>    <span class="va">y</span> <span class="op">~</span> <span class="va">treat_stat</span>,</span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"Unit"</span>,</span>
<span>    display.all <span class="op">=</span> <span class="cn">F</span>,</span>
<span>    gridOff <span class="op">=</span> <span class="cn">T</span>,</span>
<span>    by.timing <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-1-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb421"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># alternatively specification</span></span>
<span><span class="fu">panelView</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/panelView/man/panelView.html">panelview</a></span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    D <span class="op">=</span> <span class="st">"treat_stat"</span>,</span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"Unit"</span>,</span>
<span>    display.all <span class="op">=</span> <span class="cn">F</span>,</span>
<span>    gridOff <span class="op">=</span> <span class="cn">T</span>,</span>
<span>    by.timing <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-1-2.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb422"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Average outcomes for each cohort</span></span>
<span><span class="fu">panelView</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/panelView/man/panelView.html">panelview</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span>, </span>
<span>    Y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    D <span class="op">=</span> <span class="st">"treat_stat"</span>,</span>
<span>    index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>    by.timing <span class="op">=</span> <span class="cn">T</span>,</span>
<span>    display.all <span class="op">=</span> <span class="cn">F</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"outcome"</span>, </span>
<span>    by.cohort <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of unique treatment histories: 10</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-1-3.png" width="90%" style="display: block; margin: auto;"></div>
</div>
<div id="simple-dif-n-dif" class="section level2" number="26.2">
<h2>
<span class="header-section-number">26.2</span> Simple Dif-n-dif<a class="anchor" aria-label="anchor" href="#simple-dif-n-dif"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>A tool developed intuitively to study “natural experiment”, but its uses are much broader.</p></li>
<li><p><a href="data.html#fixed-effects-estimator">Fixed Effects Estimator</a> is the foundation for DID</p></li>
<li>
<p>Why is dif-in-dif attractive? Identification strategy: Inter-temporal variation between groups</p>
<ul>
<li><p><strong>Cross-sectional estimator</strong> helps avoid omitted (unobserved) <strong>common trends</strong></p></li>
<li><p><strong>Time-series estimator</strong> helps overcome omitted (unobserved) <strong>cross-sectional differences</strong></p></li>
</ul>
</li>
</ul>
<p>Consider</p>
<ul>
<li><p><span class="math inline">\(D_i = 1\)</span> treatment group</p></li>
<li><p><span class="math inline">\(D_i = 0\)</span> control group</p></li>
<li><p><span class="math inline">\(T= 1\)</span> After the treatment</p></li>
<li><p><span class="math inline">\(T =0\)</span> Before the treatment</p></li>
</ul>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th></th>
<th>After (T = 1)</th>
<th>Before (T = 0)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Treated <span class="math inline">\(D_i =1\)</span>
</td>
<td><span class="math inline">\(E[Y_{1i}(1)|D_i = 1]\)</span></td>
<td><span class="math inline">\(E[Y_{0i}(0)|D)i=1]\)</span></td>
</tr>
<tr class="even">
<td>Control <span class="math inline">\(D_i = 0\)</span>
</td>
<td><span class="math inline">\(E[Y_{0i}(1) |D_i =0]\)</span></td>
<td><span class="math inline">\(E[Y_{0i}(0)|D_i=0]\)</span></td>
</tr>
</tbody>
</table></div>
<p>missing <span class="math inline">\(E[Y_{0i}(1)|D=1]\)</span></p>
<p><strong>The Average Treatment Effect on Treated (ATT)</strong></p>
<p><span class="math display">\[
\begin{aligned}
E[Y_1(1) - Y_0(1)|D=1] &amp;= \{E[Y(1)|D=1] - E[Y(1)|D=0] \} \\
&amp;- \{E[Y(0)|D=1] - E[Y(0)|D=0] \}
\end{aligned}
\]</span></p>
<p>More elaboration:</p>
<ul>
<li>For the treatment group, we isolate the difference between being treated and not being treated. If the untreated group would have been affected in a different way, the DiD design and estimate would tell us nothing.</li>
<li>Alternatively, because we can’t observe treatment variation in the control group, we can’t say anything about the treatment effect on this group.</li>
</ul>
<p><strong>Extension</strong></p>
<ol style="list-style-type: decimal">
<li>
<strong>More than 2 groups</strong> (multiple treatments and multiple controls), and more than 2 period (pre and post)</li>
</ol>
<p><span class="math display">\[
Y_{igt} = \alpha_g + \gamma_t + \beta I_{gt} + \delta X_{igt} + \epsilon_{igt}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(\alpha_g\)</span> is the group-specific fixed effect</p></li>
<li><p><span class="math inline">\(\gamma_t\)</span> = time specific fixed effect</p></li>
<li><p><span class="math inline">\(\beta\)</span> = dif-in-dif effect</p></li>
<li><p><span class="math inline">\(I_{gt}\)</span> = interaction terms (n treatment indicators x n post-treatment dummies) (capture effect heterogeneity over time)</p></li>
</ul>
<p>This specification is the “two-way fixed effects DiD” - <strong>TWFE</strong> (i.e., 2 sets of fixed effects: group + time).</p>
<ul>
<li>However, if you have <a href="difference-in-differences.html#staggered-dif-n-dif">Staggered Dif-n-dif</a> (i.e., treatment is applied at different times to different groups). TWFE is really bad.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><strong>Long-term Effects</strong></li>
</ol>
<p>To examine the dynamic treatment effects (that are not under rollout/staggered design), we can create a centered time variable,</p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="33%">
<col width="66%">
</colgroup>
<thead><tr class="header">
<th>Centered Time Variable</th>
<th>Period</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>…</td>
<td></td>
</tr>
<tr class="even">
<td><span class="math inline">\(t = -1\)</span></td>
<td>2 periods before treatment period</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(t = 0\)</span></td>
<td>
<p>Last period right before treatment period</p>
<p>Remember to use this period as reference group</p>
</td>
</tr>
<tr class="even">
<td><span class="math inline">\(t = 1\)</span></td>
<td>Treatment period</td>
</tr>
<tr class="odd">
<td>…</td>
<td></td>
</tr>
</tbody>
</table></div>
<p>By interacting this factor variable, we can examine the dynamic effect of treatment (i.e., whether it’s fading or intensifying)</p>
<p><span class="math display">\[
\begin{aligned}
Y &amp;= \alpha_0 + \alpha_1 Group + \alpha_2 Time  \\
&amp;+ \beta_{-T_1} Treatment+  \beta_{-(T_1 -1)} Treatment + \dots +  \beta_{-1} Treatment \\
&amp;+ \beta_1 + \dots + \beta_{T_2} Treatment
\end{aligned}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(\beta_0\)</span> is used as the reference group (i.e., drop from the model)</p></li>
<li><p><span class="math inline">\(T_1\)</span> is the pre-treatment period</p></li>
<li><p><span class="math inline">\(T_2\)</span> is the post-treatment period</p></li>
</ul>
<p>With more variables (i.e., interaction terms), coefficients estimates can be less precise (i.e., higher SE).</p>
<ol start="3" style="list-style-type: decimal">
<li>DiD on the relationship, not levels. Technically, we can apply DiD research design not only on variables, but also on coefficients estimates of some other regression models with before and after a policy is implemented.</li>
</ol>
<p>Goal:</p>
<ol style="list-style-type: decimal">
<li>Pre-treatment coefficients should be non-significant <span class="math inline">\(\beta_{-T_1}, \dots, \beta_{-1} = 0\)</span> (similar to the <a href="difference-in-differences.html#placebo-test">Placebo Test</a>)</li>
<li>Post-treatment coefficients are expected to be significant <span class="math inline">\(\beta_1, \dots, \beta_{T_2} \neq0\)</span>
<ul>
<li>You can now examine the trend in post-treatment coefficients (i.e., increasing or decreasing)</li>
</ul>
</li>
</ol>
<div class="sourceCode" id="cb423"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">od</span> <span class="op">&lt;-</span> <span class="fu">causaldata</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/causaldata/man/organ_donations.html">organ_donations</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span>    <span class="co"># Treatment variable</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>California <span class="op">=</span> <span class="va">State</span> <span class="op">==</span> <span class="st">'California'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># centered time variable</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>center_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">Quarter_Num</span> <span class="op">-</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>  </span>
<span><span class="co"># where 3 is the reference period precedes the treatment period</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">od</span><span class="op">$</span><span class="va">California</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "logical"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">od</span><span class="op">$</span><span class="va">State</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "character"</span></span>
<span></span>
<span><span class="va">cali</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">Rate</span> <span class="op">~</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/i.html">i</a></span><span class="op">(</span><span class="va">center_time</span>, <span class="va">California</span>, ref <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|</span></span>
<span>                  <span class="va">State</span> <span class="op">+</span> <span class="va">center_time</span>,</span>
<span>              data <span class="op">=</span> <span class="va">od</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/etable.html">etable</a></span><span class="op">(</span><span class="va">cali</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                              cali</span></span>
<span><span class="co">#&gt; Dependent Var.:                              Rate</span></span>
<span><span class="co">#&gt;                                                  </span></span>
<span><span class="co">#&gt; California x center_time = -2    -0.0029 (0.0051)</span></span>
<span><span class="co">#&gt; California x center_time = -1   0.0063** (0.0023)</span></span>
<span><span class="co">#&gt; California x center_time = 1  -0.0216*** (0.0050)</span></span>
<span><span class="co">#&gt; California x center_time = 2  -0.0203*** (0.0045)</span></span>
<span><span class="co">#&gt; California x center_time = 3    -0.0222* (0.0100)</span></span>
<span><span class="co">#&gt; Fixed-Effects:                -------------------</span></span>
<span><span class="co">#&gt; State                                         Yes</span></span>
<span><span class="co">#&gt; center_time                                   Yes</span></span>
<span><span class="co">#&gt; _____________________________ ___________________</span></span>
<span><span class="co">#&gt; S.E.: Clustered                         by: State</span></span>
<span><span class="co">#&gt; Observations                                  162</span></span>
<span><span class="co">#&gt; R2                                        0.97934</span></span>
<span><span class="co">#&gt; Within R2                                 0.00979</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">iplot</a></span><span class="op">(</span><span class="va">cali</span>, pt.join <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-2-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb424"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">coefplot</a></span><span class="op">(</span><span class="va">cali</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-2-2.png" width="90%" style="display: block; margin: auto;"></div>
</div>
<div id="notes-1" class="section level2" number="26.3">
<h2>
<span class="header-section-number">26.3</span> Notes<a class="anchor" aria-label="anchor" href="#notes-1"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>
<p><a href="matching-methods.html#matching-methods">Matching Methods</a></p>
<ul>
<li><p>Match treatment and control based on pre-treatment observables</p></li>
<li><p>Modify SEs appropriately <span class="citation">(<a href="references.html#ref-heckman1997matching">James J. Heckman, Ichimura, and Todd 1997</a>)</span>. It’s might be easier to just use the <a href="difference-in-differences.html#doubly-robust-did">Doubly Robust DiD</a> <span class="citation">(<a href="references.html#ref-sant2020doubly">Sant’Anna and Zhao 2020</a>)</span> where you just need either matching or regression to work in order to identify your treatment effect</p></li>
<li><p>Whereas the group fixed effects control for the group time-invariant effects, it does not control for selection bias (i.e., certain groups are more likely to be treated than others). Hence, with these backdoor open (i.e., selection bias) between (1) propensity to be treated and (2) dynamics evolution of the outcome post-treatment, matching can potential close these backdoor.</p></li>
<li><p>Be careful when matching time-varying covariates because you might encounter “regression to the mean” problem, where pre-treatment periods can have an unusually bad or good time (that is out of the ordinary), then the post-treatment period outcome can just be an artifact of the regression to the mean <span class="citation">(<a href="references.html#ref-daw2018matching">Daw and Hatfield 2018</a>)</span>. This problem is not of concern to time-invariant variables.</p></li>
<li><p>Matching and DiD can use pre-treatment outcomes to correct for selection bias. From real world data and simulation, <span class="citation">(<a href="references.html#ref-chabe2015analysis">Chabé-Ferret 2015</a>)</span> found that matching generally underestimates the average causal effect and gets closer to the true effect with more number of pre-treatment outcomes. When selection bias is symmetric around the treatment date, DID is still consistent when implemented symmetrically (i.e., the same number of period before and after treatment). In cases where selection bias is asymmetric, the MC simulations show that Symmetric DiD still performs better than Matching.</p></li>
</ul>
</li>
<li>
<p>It’s always good to show results with and without controls because</p>
<ul>
<li><p>If the controls are fixed within group or within time, then those should be absorbed under those fixed effects</p></li>
<li><p>If the controls are dynamic across group and across, then your parallel trends assumption is not plausible.</p></li>
</ul>
</li>
<li><p>Under causal inference, <span class="math inline">\(R^2\)</span> is not so important.</p></li>
</ul>
<p>For count data, one can use the fixed-effects Poisson pseudo-maximum likelihood estimator (PPML) <span class="citation">Puhani (<a href="references.html#ref-puhani2012treatment">2012</a>)</span> (For applied papers, see <span class="citation">Burtch, Carnahan, and Greenwood (<a href="references.html#ref-burtch2018can">2018</a>)</span> in management and <span class="citation">C. He et al. (<a href="references.html#ref-he2021end">2021</a>)</span> in marketing). This also allows for robust standard errors under over-dispersion <span class="citation">(<a href="references.html#ref-wooldridge1999quasi">Wooldridge 1999</a>)</span>.</p>
<ul>
<li><p>This estimator outperforms a log OLS when data have many 0s<span class="citation">(<a href="references.html#ref-silva2011further">Silva and Tenreyro 2011</a>)</span>, since log-OLS can produce biased estimates <span class="citation">(<a href="references.html#ref-o2010not">O’Hara and Kotze 2010</a>)</span> under heteroskedascity <span class="citation">(<a href="references.html#ref-silva2006log">Silva and Tenreyro 2006</a>)</span>.</p></li>
<li><p>For those thinking of negative binomial with fixed effects, there isn’t an estimator right now <span class="citation">(<a href="references.html#ref-allison20027">Allison and Waterman 2002</a>)</span>.</p></li>
</ul>
<p>For [Zero-valued Outcomes], we have to distinguish the treatment effect on the intensive (outcome: 10 to 11) vs. extensive margins (outcome: 0 to 1), and we can’t readily interpret the treatment coefficient of log-transformed outcome regression as percentage change <span class="citation">(<a href="references.html#ref-chen2023logs">J. Chen and Roth 2023</a>)</span>. Alternatively, we can either focus on</p>
<ul>
<li>
<p><strong>Proportional treatment effects</strong>: <span class="math inline">\(\theta_{ATT\%} = \frac{E(Y_{it}(1) | D_i = 1, Post_t = 1) - E(Y_{it}(0) |D_i = 1, Post_t = 1)}{E(Y_{it}(0) | D_i = 1 , Post_t = 1}\)</span> (i.e., percentage change in treated group’s average post-treatment outcome). Instead of relying on the parallel trends assumption in levels, we could also rely on parallel trends assumption in ratio <span class="citation">(<a href="references.html#ref-wooldridge2023simple">Wooldridge 2023</a>)</span>.</p>
<ul>
<li><p>We can use Poisson QMLE to estimate the treatment effect: <span class="math inline">\(Y_{it} = \exp(\beta_0 + D_i \times \beta_1 Post_t + \beta_2 D_i + \beta_3 Post_t + X_{it}) \epsilon_{it}\)</span> and <span class="math inline">\(\hat{\theta}_{ATT \%} = \exp(\hat{\beta}_1-1)\)</span>.</p></li>
<li><p>To examine the parallel trends assumption in ratio holds, we can also estimate a dynamic version of the Poisson QMLE: <span class="math inline">\(Y_{it} = \exp(\lambda_t + \beta_2 D_i + \sum_{r \neq -1} \beta_r D_i \times (RelativeTime_t = r)\)</span>, we would expect <span class="math inline">\(\exp(\hat{\beta_r}) - 1 = 0\)</span> for <span class="math inline">\(r &lt; 0\)</span>.</p></li>
<li><p>Even if we see the plot of these coefficients are 0, we still should run sensitivity analysis <span class="citation">(<a href="references.html#ref-rambachan2023more">Rambachan and Roth 2023</a>)</span> to examine violation of this assumption (see <a href="difference-in-differences.html#prior-parallel-trends-test">Prior Parallel Trends Test</a>).</p></li>
</ul>
</li>
<li><p><strong>Log Effects with Calibrated Extensive-margin value</strong>: due to problem with the mean value interpretation of the proportional treatment effects with outcomes that are heavy-tailed, we might be interested in the extensive margin effect. Then, we can explicit model how much weight we put on the intensive vs. extensive margin <span class="citation">(<a href="references.html#ref-chen2023logs">J. Chen and Roth 2023, 39</a>)</span>.</p></li>
</ul>
<div class="sourceCode" id="cb425"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span> <span class="co"># For reproducibility</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span> <span class="co"># Number of observations per group (treated and control)</span></span>
<span><span class="co"># Generating IDs for a panel setup</span></span>
<span><span class="va">ID</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, times <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Defining groups and periods</span></span>
<span><span class="va">Group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="st">"Treated"</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Before"</span>, <span class="st">"After"</span><span class="op">)</span>, times <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">Treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Group</span> <span class="op">==</span> <span class="st">"Treated"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">Post</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Time</span> <span class="op">==</span> <span class="st">"After"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 1: Generate baseline outcomes with a zero-inflated model</span></span>
<span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">20</span> <span class="co"># Average rate of occurrence</span></span>
<span><span class="va">zero_inflation</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># Proportion of zeros</span></span>
<span><span class="va">Y_baseline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">n</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">zero_inflation</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">n</span>, <span class="va">lambda</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 2: Apply DiD treatment effect on the treated group in the post-treatment period</span></span>
<span><span class="va">Treatment_Effect</span> <span class="op">&lt;-</span> <span class="va">Treatment</span> <span class="op">*</span> <span class="va">Post</span></span>
<span><span class="va">Y_treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Treatment_Effect</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">n</span>, lambda <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Incorporating a simple time trend, ensuring outcomes are non-negative</span></span>
<span><span class="va">Time_Trend</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Time</span> <span class="op">==</span> <span class="st">"After"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">n</span>, lambda <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 3: Combine to get the observed outcomes</span></span>
<span><span class="va">Y_observed</span> <span class="op">&lt;-</span> <span class="va">Y_baseline</span> <span class="op">+</span> <span class="va">Y_treatment</span> <span class="op">+</span> <span class="va">Time_Trend</span></span>
<span></span>
<span><span class="co"># Ensure no negative outcomes after the time trend</span></span>
<span><span class="va">Y_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Y_observed</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="va">Y_observed</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the final dataset</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="va">ID</span>, Treatment <span class="op">=</span> <span class="va">Treatment</span>, Period <span class="op">=</span> <span class="va">Post</span>, Outcome <span class="op">=</span> <span class="va">Y_observed</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Viewing the first few rows of the dataset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ID Treatment Period Outcome</span></span>
<span><span class="co">#&gt; 1  1         0      0       0</span></span>
<span><span class="co">#&gt; 2  2         0      1      25</span></span>
<span><span class="co">#&gt; 3  3         0      0       0</span></span>
<span><span class="co">#&gt; 4  4         0      1      20</span></span>
<span><span class="co">#&gt; 5  5         0      0      19</span></span>
<span><span class="co">#&gt; 6  6         0      1       0</span></span></code></pre></div>
<div class="sourceCode" id="cb426"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="va">res_pois</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feglm.html">fepois</a></span><span class="op">(</span><span class="va">Outcome</span> <span class="op">~</span> <span class="va">Treatment</span> <span class="op">+</span> <span class="va">Period</span> <span class="op">+</span> <span class="va">Treatment</span> <span class="op">*</span> <span class="va">Period</span>,</span>
<span>           data <span class="op">=</span> <span class="va">data</span>,</span>
<span>           vcov <span class="op">=</span> <span class="st">"hetero"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/etable.html">etable</a></span><span class="op">(</span><span class="va">res_pois</span><span class="op">)</span></span>
<span><span class="co">#&gt;                             res_pois</span></span>
<span><span class="co">#&gt; Dependent Var.:              Outcome</span></span>
<span><span class="co">#&gt;                                     </span></span>
<span><span class="co">#&gt; Constant           2.249*** (0.0717)</span></span>
<span><span class="co">#&gt; Treatment           0.1743. (0.0932)</span></span>
<span><span class="co">#&gt; Period               0.0662 (0.0960)</span></span>
<span><span class="co">#&gt; Treatment x Period   0.0314 (0.1249)</span></span>
<span><span class="co">#&gt; __________________ _________________</span></span>
<span><span class="co">#&gt; S.E. type          Heteroskeda.-rob.</span></span>
<span><span class="co">#&gt; Observations                   1,000</span></span>
<span><span class="co">#&gt; Squared Cor.                 0.01148</span></span>
<span><span class="co">#&gt; Pseudo R2                    0.00746</span></span>
<span><span class="co">#&gt; BIC                         15,636.8</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre></div>
</div>
<div id="standard-errors-2" class="section level2" number="26.4">
<h2>
<span class="header-section-number">26.4</span> Standard Errors<a class="anchor" aria-label="anchor" href="#standard-errors-2"><i class="fas fa-link"></i></a>
</h2>
<p>Serial correlation is a big problem in DiD because <span class="citation">(<a href="references.html#ref-bertrand2004much">Bertrand, Duflo, and Mullainathan 2004</a>)</span></p>
<ol style="list-style-type: decimal">
<li>DiD often uses long time series</li>
<li>Outcomes are often highly positively serially correlated</li>
<li>Minimal variation in the treatment variable over time within a group (e.g., state).</li>
</ol>
<p>To overcome this problem:</p>
<ul>
<li>Using parametric correction (standard AR correction) is not good.</li>
<li>Using nonparametric (e.g., <strong>block bootstrap</strong>- keep all obs from the same group such as state together) is good when number of groups is large.</li>
<li>Remove time series dimension (i.e., aggregate data into 2 periods: pre and post). This still works with small number of groups (See <span class="citation">(<a href="references.html#ref-donald2007inference">Donald and Lang 2007</a>)</span> for more notes on small-sample aggregation).</li>
<li>Empirical and arbitrary variance-covariance matrix corrections work only in large samples.</li>
</ul>
</div>
<div id="examples" class="section level2" number="26.5">
<h2>
<span class="header-section-number">26.5</span> Examples<a class="anchor" aria-label="anchor" href="#examples"><i class="fas fa-link"></i></a>
</h2>
<p>Example by <a href="https://rpubs.com/phle/r_tutorial_difference_in_differences">Philipp Leppert</a> replicating <a href="https://davidcard.berkeley.edu/data_sets.html">Card and Krueger (1994)</a></p>
<p>Example by <a href="https://bookdown.org/aschmi11/causal_inf/difference-in-differences.html">Anthony Schmidt</a></p>
<div id="example-by-doleac2020unintended" class="section level3" number="26.5.1">
<h3>
<span class="header-section-number">26.5.1</span> Example by <span class="citation">Doleac and Hansen (<a href="references.html#ref-doleac2020unintended">2020</a>)</span><a class="anchor" aria-label="anchor" href="#example-by-doleac2020unintended"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>The purpose of banning a checking box for ex-criminal was banned because we thought that it gives more access to felons</p></li>
<li><p>Even if we ban the box, employers wouldn’t just change their behaviors. But then the unintended consequence is that employers statistically discriminate based on race</p></li>
</ul>
<p>3 types of ban the box</p>
<ol style="list-style-type: decimal">
<li>Public employer only</li>
<li>Private employer with government contract</li>
<li>All employers</li>
</ol>
<p>Main identification strategy</p>
<ul>
<li>If any county in the Metropolitan Statistical Area (MSA) adopts ban the box, it means the whole MSA is treated. Or if the state adopts “ban the ban,” every county is treated</li>
</ul>
<p>Under <a href="difference-in-differences.html#simple-dif-n-dif">Simple Dif-n-dif</a></p>
<p><span class="math display">\[ Y_{it} = \beta_0 + \beta_1 Post_t + \beta_2 treat_i + \beta_2 (Post_t \times Treat_i) + \epsilon_{it} \]</span></p>
<p>But if there is no common post time, then we should use <a href="difference-in-differences.html#staggered-dif-n-dif">Staggered Dif-n-dif</a></p>
<p><span class="math display">\[ \begin{aligned} E_{imrt} &amp;= \alpha + \beta_1 BTB_{imt} W_{imt} + \beta_2 BTB_{mt} + \beta_3 BTB_{mt} H_{imt}\\  &amp;+ \delta_m + D_{imt} \beta_5 + \lambda_{rt} + \delta_m\times f(t) \beta_7 + e_{imrt} \end{aligned} \]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(i\)</span> = person; <span class="math inline">\(m\)</span> = MSA; <span class="math inline">\(r\)</span> = region (US regions e.g., Midwest) ; <span class="math inline">\(r\)</span> = region; <span class="math inline">\(t\)</span> = year</p></li>
<li><p><span class="math inline">\(W\)</span> = White; <span class="math inline">\(B\)</span> = Black; <span class="math inline">\(H\)</span> = Hispanic</p></li>
<li><p><span class="math inline">\(\beta_1 BTB_{imt} W_{imt} + \beta_2 BTB_{mt} + \beta_3 BTB_{mt} H_{imt}\)</span> are the 3 dif-n-dif variables (<span class="math inline">\(BTB\)</span> = “ban the box”)</p></li>
<li><p><span class="math inline">\(\delta_m\)</span> = dummy for MSI</p></li>
<li><p><span class="math inline">\(D_{imt}\)</span> = control for people</p></li>
<li><p><span class="math inline">\(\lambda_{rt}\)</span> = region by time fixed effect</p></li>
<li><p><span class="math inline">\(\delta_m \times f(t)\)</span> = linear time trend within MSA (but we should not need this if we have good pre-trend)</p></li>
</ul>
<p>If we put <span class="math inline">\(\lambda_r - \lambda_t\)</span> (separately) we will more broad fixed effect, while <span class="math inline">\(\lambda_{rt}\)</span> will give us deeper and narrower fixed effect.</p>
<p>Before running this model, we have to drop all other races. And <span class="math inline">\(\beta_1, \beta_2, \beta_3\)</span> are not collinear because there are all interaction terms with <span class="math inline">\(BTB_{mt}\)</span></p>
<p>If we just want to estimate the model for black men, we will modify it to be</p>
<p><span class="math display">\[ E_{imrt} = \alpha + BTB_{mt} \beta_1 + \delta_m + D_{imt} \beta_5 + \lambda_{rt} + (\delta_m \times f(t)) \beta_7 + e_{imrt} \]</span></p>
<p><span class="math display">\[ \begin{aligned} E_{imrt} &amp;= \alpha + BTB_{m (t - 3t)} \theta_1 + BTB_{m(t-2)} \theta_2 + BTB_{mt} \theta_4 \\ &amp;+ BTB_{m(t+1)}\theta_5 + BTB_{m(t+2)}\theta_6 + BTB_{m(t+3t)}\theta_7 \\ &amp;+ [\delta_m + D_{imt}\beta_5 + \lambda_r + (\delta_m \times (f(t))\beta_7 + e_{imrt}] \end{aligned} \]</span></p>
<p>We have to leave <span class="math inline">\(BTB_{m(t-1)}\theta_3\)</span> out for the category would not be perfect collinearity</p>
<p>So the year before BTB (<span class="math inline">\(\theta_1, \theta_2, \theta_3\)</span>) should be similar to each other (i.e., same pre-trend). Remember, we only run for places with BTB.</p>
<p>If <span class="math inline">\(\theta_2\)</span> is statistically different from <span class="math inline">\(\theta_3\)</span> (baseline), then there could be a problem, but it could also make sense if we have pre-trend announcement.</p>
</div>
<div id="example-from-princeton" class="section level3" number="26.5.2">
<h3>
<span class="header-section-number">26.5.2</span> Example from <a href="https://www.princeton.edu/~otorres/DID101R.pdf">Princeton</a><a class="anchor" aria-label="anchor" href="#example-from-princeton"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb427"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://svn.r-project.org/R-packages/trunk/foreign/">foreign</a></span><span class="op">)</span></span>
<span><span class="va">mydata</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/foreign/man/read.dta.html">read.dta</a></span><span class="op">(</span><span class="st">"http://dss.princeton.edu/training/Panel101.dta"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># create a dummy variable to indicate the time when the treatment started</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">1994</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># create a dummy variable to identify the treatment group</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>treated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">country</span> <span class="op">==</span> <span class="st">"E"</span> <span class="op">|</span></span>
<span>                                <span class="va">country</span> <span class="op">==</span> <span class="st">"F"</span> <span class="op">|</span> <span class="va">country</span> <span class="op">==</span> <span class="st">"G"</span> ,</span>
<span>                            <span class="fl">1</span>,</span>
<span>                            <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># create an interaction between time and treated</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>did <span class="op">=</span> <span class="va">time</span> <span class="op">*</span> <span class="va">treated</span><span class="op">)</span></span></code></pre></div>
<p>estimate the DID estimator</p>
<div class="sourceCode" id="cb428"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">didreg</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">treated</span> <span class="op">+</span> <span class="va">time</span> <span class="op">+</span> <span class="va">did</span>, data <span class="op">=</span> <span class="va">mydata</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">didreg</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = y ~ treated + time + did, data = mydata)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;        Min         1Q     Median         3Q        Max </span></span>
<span><span class="co">#&gt; -9.768e+09 -1.623e+09  1.167e+08  1.393e+09  6.807e+09 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;               Estimate Std. Error t value Pr(&gt;|t|)  </span></span>
<span><span class="co">#&gt; (Intercept)  3.581e+08  7.382e+08   0.485   0.6292  </span></span>
<span><span class="co">#&gt; treated      1.776e+09  1.128e+09   1.575   0.1200  </span></span>
<span><span class="co">#&gt; time         2.289e+09  9.530e+08   2.402   0.0191 *</span></span>
<span><span class="co">#&gt; did         -2.520e+09  1.456e+09  -1.731   0.0882 .</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 2.953e+09 on 66 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.08273,    Adjusted R-squared:  0.04104 </span></span>
<span><span class="co">#&gt; F-statistic: 1.984 on 3 and 66 DF,  p-value: 0.1249</span></span></code></pre></div>
<p>The <code>did</code> coefficient is the differences-in-differences estimator. Treat has a negative effect</p>
</div>
<div id="example-by-card1993minimum" class="section level3" number="26.5.3">
<h3>
<span class="header-section-number">26.5.3</span> Example by <span class="citation">Card and Krueger (<a href="references.html#ref-card1993minimum">1993</a>)</span><a class="anchor" aria-label="anchor" href="#example-by-card1993minimum"><i class="fas fa-link"></i></a>
</h3>
<p>found that increase in minimum wage increases employment</p>
<p>Experimental Setting:</p>
<ul>
<li><p>New Jersey (treatment) increased minimum wage</p></li>
<li><p>Penn (control) did not increase minimum wage</p></li>
</ul>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th></th>
<th></th>
<th>After</th>
<th>Before</th>
<th></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Treatment</td>
<td>NJ</td>
<td>A</td>
<td>B</td>
<td>A - B</td>
</tr>
<tr class="even">
<td>Control</td>
<td>PA</td>
<td>C</td>
<td>D</td>
<td>C - D</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>A - C</td>
<td>B - D</td>
<td>(A - B) - (C - D)</td>
</tr>
</tbody>
</table></div>
<p>where</p>
<ul>
<li><p>A - B = treatment effect + effect of time (additive)</p></li>
<li><p>C - D = effect of time</p></li>
<li><p>(A - B) - (C - D) = dif-n-dif</p></li>
</ul>
<p><strong>The identifying assumptions</strong>:</p>
<ul>
<li><p>Can’t have <strong>switchers</strong></p></li>
<li>
<p>PA is the control group</p>
<ul>
<li><p>is a good counter factual</p></li>
<li><p>is what NJ would look like if they hadn’t had the treatment</p></li>
</ul>
</li>
</ul>
<p><span class="math display">\[
Y_{jt} = \beta_0 + NJ_j \beta_1 + POST_t \beta_2 + (NJ_j \times POST_t)\beta_3+ X_{jt}\beta_4 + \epsilon_{jt}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(j\)</span> = restaurant</p></li>
<li><p><span class="math inline">\(NJ\)</span> = dummy where <span class="math inline">\(1 = NJ\)</span>, and <span class="math inline">\(0 = PA\)</span></p></li>
<li><p><span class="math inline">\(POST\)</span> = dummy where <span class="math inline">\(1 = post\)</span>, and <span class="math inline">\(0 = pre\)</span></p></li>
</ul>
<p>Notes:</p>
<ul>
<li><p>We don’t need <span class="math inline">\(\beta_4\)</span> in our model to have unbiased <span class="math inline">\(\beta_3\)</span>, but including it would give our coefficients efficiency</p></li>
<li><p>If we use <span class="math inline">\(\Delta Y_{jt}\)</span> as the dependent variable, we don’t need <span class="math inline">\(POST_t \beta_2\)</span> anymore</p></li>
<li><p>Alternative model specification is that the authors use NJ high wage restaurant as control group (still choose those that are close to the border)</p></li>
<li><p>The reason why they can’t control for everything (PA + NJ high wage) is because it’s hard to interpret the causal treatment</p></li>
<li>
<p>Dif-n-dif utilizes similarity in pretrend of the dependent variables. However, this is neither a necessary nor sufficient for the identifying assumption.</p>
<ul>
<li><p>It’s not sufficient because they can have multiple treatments (technically, you could include more control, but your treatment can’t interact)</p></li>
<li><p>It’s not necessary because trends can be parallel after treatment</p></li>
</ul>
</li>
<li><p>However, we can’t never be certain; we just try to find evidence consistent with our theory so that dif-n-dif can work.</p></li>
<li><p>Notice that we don’t need before treatment the <strong>levels of the dependent variable</strong> to be the same (e.g., same wage average in both NJ and PA), dif-n-dif only needs <strong>pre-trend (i.e., slope)</strong> to be the same for the two groups.</p></li>
</ul>
</div>
<div id="example-by-butcher2014effects" class="section level3" number="26.5.4">
<h3>
<span class="header-section-number">26.5.4</span> Example by <span class="citation">Butcher, McEwan, and Weerapana (<a href="references.html#ref-butcher2014effects">2014</a>)</span><a class="anchor" aria-label="anchor" href="#example-by-butcher2014effects"><i class="fas fa-link"></i></a>
</h3>
<p>Theory:</p>
<ul>
<li>
<p>Highest achieving students are usually in hard science. Why?</p>
<ul>
<li><p>Hard to give students students the benefit of doubt for hard science</p></li>
<li><p>How unpleasant and how easy to get a job. Degrees with lower market value typically want to make you feel more pleasant</p></li>
</ul>
</li>
</ul>
<p>Under OLS</p>
<p><span class="math display">\[
E_{ij} = \beta_0 + X_i \beta_1 + G_j \beta_2 + \epsilon_{ij}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(X_i\)</span> = student attributes</p></li>
<li><p><span class="math inline">\(\beta_2\)</span> = causal estimate (from grade change)</p></li>
<li><p><span class="math inline">\(E_{ij}\)</span> = Did you choose to enroll in major <span class="math inline">\(j\)</span></p></li>
<li><p><span class="math inline">\(G_j\)</span> = grade given in major <span class="math inline">\(j\)</span></p></li>
</ul>
<p>Examine <span class="math inline">\(\hat{\beta}_2\)</span></p>
<ul>
<li><p>Negative bias: Endogenous response because department with lower enrollment rate will give better grade</p></li>
<li><p>Positive bias: hard science is already having best students (i.e., ability), so if they don’t their grades can be even lower</p></li>
</ul>
<p>Under dif-n-dif</p>
<p><span class="math display">\[
Y_{idt} = \beta_0 + POST_t \beta_1 + Treat_d \beta_2 + (POST_t \times Treat_d)\beta_3 + X_{idt} + \epsilon_{idt}
\]</span></p>
<p>where</p>
<ul>
<li>
<span class="math inline">\(Y_{idt}\)</span> = grade average</li>
</ul>
<div class="inline-table"><table style="width:97%;" class="table table-sm">
<colgroup>
<col width="16%">
<col width="40%">
<col width="12%">
<col width="12%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th></th>
<th>Intercept</th>
<th>Treat</th>
<th>Post</th>
<th>Treat*Post</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Treat Pre</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>Treat Post</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td>Control Pre</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>Control Post</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td></td>
<td>Average for pre-control <span class="math inline">\(\beta_0\)</span>
</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table></div>
<p>A more general specification of the dif-n-dif is that</p>
<p><span class="math display">\[
Y_{idt} = \alpha_0 + (POST_t \times Treat_d) \alpha_1 + \theta_d + \delta_t + X_{idt} + u_{idt}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\((\theta_d + \delta_t)\)</span> richer , more df than <span class="math inline">\(Treat_d \beta_2 + Post_t \beta_1\)</span> (because fixed effects subsume Post and treat)</p></li>
<li><p><span class="math inline">\(\alpha_1\)</span> should be equivalent to <span class="math inline">\(\beta_3\)</span> (if your model assumptions are correct)</p></li>
</ul>
</div>
</div>
<div id="one-difference" class="section level2" number="26.6">
<h2>
<span class="header-section-number">26.6</span> One Difference<a class="anchor" aria-label="anchor" href="#one-difference"><i class="fas fa-link"></i></a>
</h2>
<p>The regression formula is as follows <span class="citation">(<a href="references.html#ref-liaukonyte2023frontiers">Liaukonytė, Tuchman, and Zhu 2023</a>)</span>:</p>
<p><span class="math display">\[
y_{ut} = \beta \text{Post}_t + \gamma_u + \gamma_w(t) + \gamma_l + \gamma_g(u)p(t) + \epsilon_{ut}
\]</span></p>
<p>where</p>
<ul>
<li>
<span class="math inline">\(y_{ut}\)</span>: Outcome of interest for unit u in time t.</li>
<li>
<span class="math inline">\(\text{Post}_t\)</span>: Dummy variable representing a specific post-event period.</li>
<li>
<span class="math inline">\(\beta\)</span>: Coefficient measuring the average change in the outcome after the event relative to the pre-period.</li>
<li>
<span class="math inline">\(\gamma_u\)</span>: Fixed effects for each unit.</li>
<li>
<span class="math inline">\(\gamma_w(t)\)</span>: Time-specific fixed effects to account for periodic variations.</li>
<li>
<span class="math inline">\(\gamma_l\)</span>: Dummy variable for a specific significant period (e.g., a major event change).</li>
<li>
<span class="math inline">\(\gamma_g(u)p(t)\)</span>: Group x period fixed effects for flexible trends that may vary across different categories (e.g., geographical regions) and periods.</li>
<li>
<span class="math inline">\(\epsilon_{ut}\)</span>: Error term.</li>
</ul>
<p>This model can be used to analyze the impact of an event on the outcome of interest while controlling for various fixed effects and time-specific variations, but using units themselves pre-treatment as controls.</p>
</div>
<div id="two-way-fixed-effects" class="section level2" number="26.7">
<h2>
<span class="header-section-number">26.7</span> Two-way Fixed-effects<a class="anchor" aria-label="anchor" href="#two-way-fixed-effects"><i class="fas fa-link"></i></a>
</h2>
<p>A generalization of the dif-n-dif model is the two-way fixed-effects models where you have multiple groups and time effects. But this is not a designed-based, non-parametric causal estimator <span class="citation">(<a href="references.html#ref-imai2021use">Imai and Kim 2021</a>)</span></p>
<p>When applying TWFE to multiple groups and multiple periods, the supposedly causal coefficient is the weighted average of all two-group/two-period DiD estimators in the data where some of the weights can be negative. More specifically, the weights are proportional to group sizes and treatment indicator’s variation in each pair, where units in the middle of the panel have the highest weight.</p>
<p>The canonical/standard TWFE only works when</p>
<ul>
<li>
<p>Effects are homogeneous across units and across time periods (i.e., no dynamic changes in the effects of treatment). See <span class="citation">(<a href="references.html#ref-goodman2021difference">Goodman-Bacon 2021</a>; <a href="references.html#ref-de2020two">Clément De Chaisemartin and d’Haultfoeuille 2020</a>; <a href="references.html#ref-sun2021estimating">L. Sun and Abraham 2021</a>; <a href="references.html#ref-borusyak2021revisiting">Borusyak, Jaravel, and Spiess 2021</a>)</span> for details. Similarly, it relies on the assumption of <strong>linear additive effects</strong> <span class="citation">(<a href="references.html#ref-imai2021use">Imai and Kim 2021</a>)</span></p>
<ul>
<li><p>Have to argue why treatment heterogeneity is not a problem (e.g., plot treatment timing and decompose treatment coefficient using <a href="difference-in-differences.html#goodman-bacon-decomposition">Goodman-Bacon Decomposition</a>) know the percentage of observation are never treated (because as the never-treated group increases, the bias of TWFE decreases, with 80% sample to be never-treated, bias is negligible). The problem is worsen when you have long-run effects.</p></li>
<li><p>Need to manually drop two relative time periods if everyone is eventually treated (to avoid multicollinearity). Programs might do this randomly and if it chooses to drop a post-treatment period, it will create biases. The choice usually -1, and -2 periods.</p></li>
<li><p>Treatment heterogeneity can come in because (1) it might take some time for a treatment to have measurable changes in outcomes or (2) for each period after treatment, the effect can be different (phase in or increasing effects).</p></li>
</ul>
</li>
<li><p>2 time periods.</p></li>
</ul>
<p>Within this setting, TWFE works because, using the baseline (e.g., control units where their treatment status is unchanged across time periods), the comparison can be</p>
<ul>
<li>
<p>Good for</p>
<ul>
<li><p>Newly treated units vs. control</p></li>
<li><p>Newly treated units vs not-yet treated</p></li>
</ul>
</li>
<li>
<p>Bad for</p>
<ul>
<li>Newly treated vs. already treated (because already treated cannot serve as the potential outcome for the newly treated).</li>
<li>Strict exogeneity (i.e., time-varying confounders, feedback from past outcome to treatment) <span class="citation">(<a href="references.html#ref-imai2019should">Imai and Kim 2019</a>)</span>
</li>
<li>Specific functional forms (i.e., treatment effect homogeneity and no carryover effects or anticipation effects) <span class="citation">(<a href="references.html#ref-imai2019should">Imai and Kim 2019</a>)</span>
</li>
</ul>
</li>
</ul>
<p>Note: Notation for this section is consistent with <span class="citation">(<a href="references.html#ref-arkhangelsky2021double">2020</a>)</span></p>
<p><span class="math display">\[
Y_{it} = \alpha_i + \lambda_t + \tau W_{it} + \beta X_{it} + \epsilon_{it}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(Y_{it}\)</span> is the outcome</p></li>
<li><p><span class="math inline">\(\alpha_i\)</span> is the unit FE</p></li>
<li><p><span class="math inline">\(\lambda_t\)</span> is the time FE</p></li>
<li><p><span class="math inline">\(\tau\)</span> is the causal effect of treatment</p></li>
<li><p><span class="math inline">\(W_{it}\)</span> is the treatment indicator</p></li>
<li><p><span class="math inline">\(X_{it}\)</span> are covariates</p></li>
</ul>
<p>When <span class="math inline">\(T = 2\)</span>, the TWFE is the traditional DiD model</p>
<p>Under the following assumption, <span class="math inline">\(\hat{\tau}_{OLS}\)</span> is unbiased:</p>
<ol style="list-style-type: decimal">
<li>homogeneous treatment effect</li>
<li>parallel trends assumptions</li>
<li>linear additive effects <span class="citation">(<a href="references.html#ref-imai2021use">Imai and Kim 2021</a>)</span>
</li>
</ol>
<p><strong>Remedies for TWFE’s shortcomings</strong></p>
<ul>
<li><p><span class="citation">(<a href="references.html#ref-goodman2021difference">Goodman-Bacon 2021</a>)</span>: diagnostic robustness tests of the TWFE DiD and identify influential observations to the DiD estimate (<a href="difference-in-differences.html#goodman-bacon-decomposition">Goodman-Bacon Decomposition</a>)</p></li>
<li>
<p><span class="citation">(<a href="references.html#ref-callaway2021difference">Callaway and Sant’Anna 2021</a>)</span>: 2-step estimation with a bootstrap procedure that can account for autocorrelation and clustering,</p>
<ul>
<li><p>the parameters of interest are the group-time average treatment effects, where each group is defined by when it was first treated (<a href="difference-in-differences.html#multiple-periods-and-variation-in-treatment-timing">Multiple periods and variation in treatment timing</a>)</p></li>
<li><p>Comparing post-treatment outcomes fo groups treated in a period against a similar group that is never treated (using matching).</p></li>
<li><p>Treatment status cannot switch (once treated, stay treated for the rest of the panel)</p></li>
<li><p>Package: <code>did</code></p></li>
</ul>
</li>
<li>
<p><span class="citation">(<a href="references.html#ref-sun2021estimating">L. Sun and Abraham 2021</a>)</span>: a specialization of <span class="citation">(<a href="references.html#ref-callaway2021difference">Callaway and Sant’Anna 2021</a>)</span> in the event-study context.</p>
<ul>
<li><p>They include lags and leads in their design</p></li>
<li><p>have cohort-specific estimates (similar to group-time estimates in <span class="citation">(<a href="references.html#ref-callaway2021difference">Callaway and Sant’Anna 2021</a>)</span></p></li>
<li><p>They propose the “interaction-weighted” estimator.</p></li>
<li><p>Package: <code>fixest</code></p></li>
</ul>
</li>
<li>
<p><span class="citation">(<a href="references.html#ref-imai2021use">Imai and Kim 2021</a>)</span></p>
<ul>
<li><p>Different from <span class="citation">(<a href="references.html#ref-callaway2021difference">Callaway and Sant’Anna 2021</a>)</span> because they allow units to switch in and out of treatment.</p></li>
<li><p>Based on matching methods, to have weighted TWFE</p></li>
<li><p>Package: <code>wfe</code> and <code>PanelMatch</code></p></li>
</ul>
</li>
<li>
<p><span class="citation">(<a href="references.html#ref-gardner2022two">Gardner 2022</a>)</span>: two-stage DiD</p>
<ul>
<li><code>did2s</code></li>
</ul>
</li>
<li><p>In cases with an unaffected unit (i.e., never-treated), using the exposure-adjusted difference-in-differences estimators can recover the average treatment effect <span class="citation">(<a href="references.html#ref-de2020two">Clément De Chaisemartin and d’Haultfoeuille 2020</a>)</span>. However, if you want to see the treatment effect heterogeneity (in cases where the true heterogeneous treatment effects vary by the exposure rate), exposure-adjusted did still fails <span class="citation">(<a href="references.html#ref-sun2022linear">L. Sun and Shapiro 2022</a>)</span>.</p></li>
<li><p><span class="citation">(<a href="references.html#ref-arkhangelsky2021double">2020</a>)</span>: see below</p></li>
</ul>
<p>To be robust against</p>
<ol style="list-style-type: decimal">
<li>time- and unit-varying effects</li>
</ol>
<p>We can use the reshaped inverse probability weighting (RIPW)- TWFE estimator</p>
<p>With the following assumptions:</p>
<ul>
<li><p>SUTVA</p></li>
<li><p>Binary treatment: <span class="math inline">\(\mathbf{W}_i = (W_{i1}, \dots, W_{it})\)</span> where <span class="math inline">\(\mathbf{W}_i \sim \mathbf{\pi}_i\)</span> generalized propensity score (i.e., each person treatment likelihood follow <span class="math inline">\(\pi\)</span> regardless of the period)</p></li>
</ul>
<p>Then, the unit-time specific effect is <span class="math inline">\(\tau_{it} = Y_{it}(1) - Y_{it}(0)\)</span></p>
<p>Then the Doubly Average Treatment Effect (DATE) is</p>
<p><span class="math display">\[
\tau(\xi) = \sum_{T=1}^T \xi_t \left(\frac{1}{n} \sum_{i = 1}^n \tau_{it} \right)
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(\frac{1}{n} \sum_{i = 1}^n \tau_{it}\)</span> is the unweighted effect of treatment across units (i.e., time-specific ATE).</p></li>
<li><p><span class="math inline">\(\xi = (\xi_1, \dots, \xi_t)\)</span> are user-specific weights for each time period.</p></li>
<li><p>This estimand is called DATE because it’s weighted (averaged) across both time and units.</p></li>
</ul>
<p>A special case of DATE is when both time and unit-weights are equal</p>
<p><span class="math display">\[
\tau_{eq} = \frac{1}{nT} \sum_{t=1}^T \sum_{i = 1}^n \tau_{it}
\]</span></p>
<p>Borrowing the idea of inverse propensity-weighted least squares estimator in the cross-sectional case that we reweight the objective function via the treatment assignment mechanism:</p>
<p><span class="math display">\[
\hat{\tau} \triangleq \arg \min_{\tau} \sum_{i = 1}^n (Y_i -\mu - W_i \tau)^2 \frac{1}{\pi_i (W_i)}
\]</span></p>
<p>where</p>
<ul>
<li><p>the first term is the least squares objective</p></li>
<li><p>the second term is the propensity score</p></li>
</ul>
<p>In the panel data case, the IPW estimator will be</p>
<p><span class="math display">\[
\hat{\tau}_{IPW} \triangleq \arg \min_{\tau} \sum_{i = 1}^n \sum_{t =1}^T (Y_{i t}-\alpha_i - \lambda_t - W_{it} \tau)^2 \frac{1}{\pi_i (W_i)}
\]</span></p>
<p>Then, to have DATE that users can specify the structure of time weight, we use reshaped IPW estimator <span class="citation">(<a href="references.html#ref-arkhangelsky2021double">2020</a>)</span></p>
<p><span class="math display">\[
\hat{\tau}_{RIPW} (\Pi) \triangleq \arg \min_{\tau} \sum_{i = 1}^n \sum_{t =1}^T (Y_{i t}-\alpha_i - \lambda_t - W_{it} \tau)^2 \frac{\Pi(W_i)}{\pi_i (W_i)}
\]</span></p>
<p>where it’s a function of a data-independent distribution <span class="math inline">\(\Pi\)</span> that depends on the support of the treatment path <span class="math inline">\(\mathbb{S} = \cup_i Supp(W_i)\)</span></p>
<p>This generalization can transform to</p>
<ul>
<li><p>IPW-TWFE estimator when <span class="math inline">\(\Pi \sim Unif(\mathbb{S})\)</span></p></li>
<li><p>randomized experiment when <span class="math inline">\(\Pi = \pi_i\)</span></p></li>
</ul>
<p>To choose <span class="math inline">\(\Pi\)</span>, we don’t need to data, we just need possible assignments in your setting.</p>
<ul>
<li><p>For most practical problems (DiD, staggered, transient), we have closed form solutions</p></li>
<li><p>For generic solver, we can use nonlinear programming (e..g, BFGS algorithm)</p></li>
</ul>
<p>As argued in <span class="citation">(<a href="references.html#ref-imai2021use">Imai and Kim 2021</a>)</span> that TWFE is not a non-parametric approach, it can be subjected to incorrect model assumption (i.e., model dependence).</p>
<ul>
<li><p>Hence, they advocate for matching methods for time-series cross-sectional data <span class="citation">(<a href="references.html#ref-imai2021use">Imai and Kim 2021</a>)</span></p></li>
<li><p>Use <code>wfe</code> and <code>PanelMatch</code> to apply their paper.</p></li>
</ul>
<p>This package is based on <span class="citation">(<a href="references.html#ref-somaini2016algorithm">Somaini and Wolak 2016</a>)</span></p>
<div class="sourceCode" id="cb429"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># dataset</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">bacondecomp</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">bacondecomp</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/bacondecomp/man/castle.html">castle</a></span></span></code></pre></div>
<div class="sourceCode" id="cb430"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("paulosomaini/xtreg2way")</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paulosomaini/xtreg2way">xtreg2way</a></span><span class="op">)</span></span>
<span><span class="co"># output &lt;- xtreg2way(y,</span></span>
<span><span class="co">#                     data.frame(x1, x2),</span></span>
<span><span class="co">#                     iid,</span></span>
<span><span class="co">#                     tid,</span></span>
<span><span class="co">#                     w,</span></span>
<span><span class="co">#                     noise = "1",</span></span>
<span><span class="co">#                     se = "1")</span></span>
<span></span>
<span><span class="co"># equilvalently</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xtreg2way/man/xtreg2way.html">xtreg2way</a></span><span class="op">(</span><span class="va">l_homicide</span> <span class="op">~</span> <span class="va">post</span>,</span>
<span>                    <span class="va">df</span>,</span>
<span>                    iid <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">state</span>, <span class="co"># group id</span></span>
<span>                    tid <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">year</span>, <span class="co"># time id</span></span>
<span>                    <span class="co"># w, # vector of weight</span></span>
<span>                    se <span class="op">=</span> <span class="st">"1"</span><span class="op">)</span></span>
<span><span class="va">output</span><span class="op">$</span><span class="va">betaHat</span></span>
<span><span class="co">#&gt;                  [,1]</span></span>
<span><span class="co">#&gt; l_homicide 0.08181162</span></span>
<span><span class="va">output</span><span class="op">$</span><span class="va">aVarHat</span></span>
<span><span class="co">#&gt;             [,1]</span></span>
<span><span class="co">#&gt; [1,] 0.003396724</span></span>
<span></span>
<span><span class="co"># to save time, you can use your structure in the </span></span>
<span><span class="co"># last output for a new set of variables</span></span>
<span><span class="co"># output2 &lt;- xtreg2way(y, x1, struc=output$struc)</span></span></code></pre></div>
<p>Standard errors estimation options</p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="19%">
<col width="80%">
</colgroup>
<thead><tr class="header">
<th>Set</th>
<th>Estimation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>se = "0"</code></td>
<td>Assume homoskedasticity and no within group correlation or serial correlation</td>
</tr>
<tr class="even">
<td>
<code>se = "1"</code> (default)</td>
<td>robust to heteroskadasticity and serial correlation <span class="citation">(<a href="references.html#ref-arellano1987computing">Arellano 1987</a>)</span>
</td>
</tr>
<tr class="odd">
<td><code>se = "2"</code></td>
<td>robust to heteroskedasticity, but assumes no correlation within group or serial correlation</td>
</tr>
<tr class="even">
<td><code>se = "11"</code></td>
<td>Aerllano SE with df correction performed by Stata xtreg <span class="citation">(<a href="references.html#ref-somaini2021twfem">Somaini and Wolak 2021</a>)</span>
</td>
</tr>
</tbody>
</table></div>
<p>Alternatively, you can also do it manually or with the <code>plm</code> package, but you have to be careful with how the SEs are estimated</p>
<div class="sourceCode" id="cb431"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://sites.google.com/site/npgraham1/research/code">multiwayvcov</a></span><span class="op">)</span> <span class="co"># get vcov matrix </span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">lmtest</span><span class="op">)</span> <span class="co"># robust SEs estimation</span></span>
<span></span>
<span><span class="co"># manual</span></span>
<span><span class="va">output3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">l_homicide</span> <span class="op">~</span> <span class="va">post</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>,</span>
<span>              data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get variance-covariance matrix</span></span>
<span><span class="va">vcov_tw</span> <span class="op">&lt;-</span> <span class="fu">multiwayvcov</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/multiwayvcov/man/cluster.vcov.html">cluster.vcov</a></span><span class="op">(</span><span class="va">output3</span>,</span>
<span>                        <span class="fu"><a href="https://amices.org/mice/reference/cbind.html">cbind</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">state</span>, <span class="va">df</span><span class="op">$</span><span class="va">year</span><span class="op">)</span>,</span>
<span>                        use_white <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                        df_correction <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get coefficients</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coeftest</a></span><span class="op">(</span><span class="va">output3</span>, <span class="va">vcov_tw</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span> </span>
<span><span class="co">#&gt;   Estimate Std. Error    t value   Pr(&gt;|t|) </span></span>
<span><span class="co">#&gt; 0.08181162 0.05671410 1.44252696 0.14979397</span></span></code></pre></div>
<div class="sourceCode" id="cb432"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># using the plm package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://cran.r-project.org/package=plm">plm</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">output4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plm/man/plm.html">plm</a></span><span class="op">(</span><span class="va">l_homicide</span> <span class="op">~</span> <span class="va">post</span>, </span>
<span>               data <span class="op">=</span> <span class="va">df</span>, </span>
<span>               index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"year"</span><span class="op">)</span>, </span>
<span>               model <span class="op">=</span> <span class="st">"within"</span>, </span>
<span>               effect <span class="op">=</span> <span class="st">"twoways"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get coefficients</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coeftest</a></span><span class="op">(</span><span class="va">output4</span>, vcov <span class="op">=</span> <span class="va">vcovHC</span>, type <span class="op">=</span> <span class="st">"HC1"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; t test of coefficients:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">#&gt; post 0.081812   0.057748  1.4167   0.1572</span></span></code></pre></div>
<p>As you can see, differences stem from SE estimation, not the coefficient estimate.</p>
</div>
<div id="multiple-periods-and-variation-in-treatment-timing" class="section level2" number="26.8">
<h2>
<span class="header-section-number">26.8</span> Multiple periods and variation in treatment timing<a class="anchor" aria-label="anchor" href="#multiple-periods-and-variation-in-treatment-timing"><i class="fas fa-link"></i></a>
</h2>
<p>This is an extension of the DiD framework to settings where you have</p>
<ul>
<li><p>more than 2 time periods</p></li>
<li><p>different treatment timing</p></li>
</ul>
<p>When treatment effects are heterogeneous across time or units, the standard <a href="difference-in-differences.html#two-way-fixed-effects">Two-way Fixed-effects</a> is inappropriate.</p>
<p>Notation is consistent with <code>did</code> <a href="https://cran.r-project.org/web/packages/did/vignettes/multi-period-did.html">package</a> <span class="citation">(<a href="references.html#ref-callaway2021difference">Callaway and Sant’Anna 2021</a>)</span></p>
<ul>
<li><p><span class="math inline">\(Y_{it}(0)\)</span> is the potential outcome for unit <span class="math inline">\(i\)</span></p></li>
<li><p><span class="math inline">\(Y_{it}(g)\)</span> is the potential outcome for unit <span class="math inline">\(i\)</span> in time period <span class="math inline">\(t\)</span> if it’s treated in period <span class="math inline">\(g\)</span></p></li>
<li><p><span class="math inline">\(Y_{it}\)</span> is the observed outcome for unit <span class="math inline">\(i\)</span> in time period <span class="math inline">\(t\)</span></p></li>
</ul>
<p><span class="math display">\[
Y_{it} =
\begin{cases}
Y_{it} = Y_{it}(0) &amp; \forall i \in \text{never-treated group} \\
Y_{it} = 1\{G_i &gt; t\} Y_{it}(0) +  1\{G_i \le t \}Y_{it}(G_i) &amp; \forall i \in \text{other groups}
\end{cases}
\]</span></p>
<ul>
<li><p><span class="math inline">\(G_i\)</span> is the time period when <span class="math inline">\(i\)</span> is treated</p></li>
<li><p><span class="math inline">\(C_i\)</span> is a dummy when <span class="math inline">\(i\)</span> belongs to the <strong>never-treated</strong> group</p></li>
<li><p><span class="math inline">\(D_{it}\)</span> is a dummy for whether <span class="math inline">\(i\)</span> is treated in period <span class="math inline">\(t\)</span></p></li>
</ul>
<p><strong>Assumptions</strong>:</p>
<ul>
<li><p>Staggered treatment adoption: once treated, a unit cannot be untreated (revert)</p></li>
<li>
<p>Parallel trends assumptions (conditional on covariates):</p>
<ul>
<li>
<p>Based on never-treated units: <span class="math inline">\(E[Y_t(0)- Y_{t-1}(0)|G= g] = E[Y_t(0) - Y_{t-1}(0)|C=1]\)</span></p>
<ul>
<li>Without treatment, the average potential outcomes for group <span class="math inline">\(g\)</span> equals the average potential outcomes for the never-treated group (i.e., control group), which means that we have (1) enough data on the never-treated group (2) the control group is similar to the eventually treated group.</li>
</ul>
</li>
<li>
<p>Based on not-yet treated units: <span class="math inline">\(E[Y_t(0) - Y_{t-1}(0)|G = g] = E[Y_t(0) - Y_{t-1}(0)|D_s = 0, G \neq g]\)</span></p>
<ul>
<li><p>Not-yet treated units by time <span class="math inline">\(s\)</span> ( <span class="math inline">\(s \ge t\)</span>) can be used as comparison groups to calculate the average treatment effects for the group first treated in time <span class="math inline">\(g\)</span></p></li>
<li><p>Additional assumption: pre-treatment trends across groups <span class="citation">(<a href="references.html#ref-marcus2021role">Marcus and Sant’Anna 2021</a>)</span></p></li>
</ul>
</li>
</ul>
</li>
<li><p>Random sampling</p></li>
<li><p>Irreversibility of treatment (once treated, cannot be untreated)</p></li>
<li><p>Overlap (the treatment propensity <span class="math inline">\(e \in [0,1]\)</span>)</p></li>
</ul>
<p>Group-Time ATE</p>
<ul>
<li>This is the equivalent of the average treatment effect in the standard case (2 groups, 2 periods) under multiple time periods.</li>
</ul>
<p><span class="math display">\[
ATT(g,t) = E[Y_t(g) - Y_t(0) |G = g]
\]</span></p>
<p>which is the average treatment effect for group <span class="math inline">\(g\)</span> in period <span class="math inline">\(t\)</span></p>
<ul>
<li>
<p>Identification: When the parallel trends assumption based on</p>
<ul>
<li><p>Never-treated units: <span class="math inline">\(ATT(g,t) = E[Y_t - Y_{g-1} |G = g] - E[Y_t - Y_{g-1}|C=1] \forall t \ge g\)</span></p></li>
<li><p>Not-yet-treated units: <span class="math inline">\(ATT(g,t) = E[Y_t - Y_{g-1}|G= g] - E[Y_t - Y_{g-1}|D_t = 0, G \neq g] \forall t \ge g\)</span></p></li>
</ul>
</li>
<li>
<p>Identification: when the parallel trends assumption only holds conditional on covariates and based on</p>
<ul>
<li><p>Never-treated units: <span class="math inline">\(ATT(g,t) = E[Y_t - Y_{g-1} |X, G = g] - E[Y_t - Y_{g-1}|X, C=1] \forall t \ge g\)</span></p></li>
<li><p>Not-yet-treated units: <span class="math inline">\(ATT(g,t) = E[Y_t - Y_{g-1}|X, G= g] - E[Y_t - Y_{g-1}|X, D_t = 0, G \neq g] \forall t \ge g\)</span></p></li>
<li><p>This is plausible when you have suspected selection bias that can be corrected by using covariates (i.e., very much similar to matching methods to have plausible parallel trends).</p></li>
</ul>
</li>
</ul>
<p>Possible parameters of interest are:</p>
<ol style="list-style-type: decimal">
<li>Average treatment effect per group</li>
</ol>
<p><span class="math display">\[
\theta_S(g) = \frac{1}{\tau - g + 1} \sum_{t = 2}^\tau \mathbb{1} \{ \le t \} ATT(g,t)
\]</span></p>
<ol start="2" style="list-style-type: decimal">
<li>Average treatment effect across groups (that were treated) (similar to average treatment effect on the treated in the canonical case)</li>
</ol>
<p><span class="math display">\[
\theta_S^O := \sum_{g=2}^\tau \theta_S(g) P(G=g)
\]</span></p>
<ol start="3" style="list-style-type: decimal">
<li>Average treatment effect dynamics (i.e., average treatment effect for groups that have been exposed to the treatment for <span class="math inline">\(e\)</span> time periods):</li>
</ol>
<p><span class="math display">\[
\theta_D(e) := \sum_{g=2}^\tau \mathbb{1} \{g + e \le \tau \}ATT(g,g + e) P(G = g|G + e \le \tau)
\]</span></p>
<ol start="4" style="list-style-type: decimal">
<li>Average treatment effect in period <span class="math inline">\(t\)</span> for all groups that have treated by period <span class="math inline">\(t\)</span>)</li>
</ol>
<p><span class="math display">\[
\theta_C(t) = \sum_{g=2}^\tau \mathbb{1}\{g \le t\} ATT(g,t) P(G = g|g \le t)
\]</span></p>
<ol start="5" style="list-style-type: decimal">
<li>Average treatment effect by calendar time</li>
</ol>
<p><span class="math display">\[
\theta_C = \frac{1}{\tau-1}\sum_{t=2}^\tau \theta_C(t)
\]</span></p>
</div>
<div id="staggered-dif-n-dif" class="section level2" number="26.9">
<h2>
<span class="header-section-number">26.9</span> Staggered Dif-n-dif<a class="anchor" aria-label="anchor" href="#staggered-dif-n-dif"><i class="fas fa-link"></i></a>
</h2>
<p>Recommendations by <span class="citation">Baker, Larcker, and Wang (<a href="references.html#ref-baker2022much">2022</a>)</span></p>
<ul>
<li><p>TWFE DiD regressions are suitable for single treatment periods or when treatment effects are homogeneous, provided there’s a solid rationale for effect homogeneity.</p></li>
<li><p>For TWFE staggered DiD, researchers should evaluate bias risks, plot treatment timings to check for variations, and use decompositions like <span class="citation">Goodman-Bacon (<a href="references.html#ref-goodman2021difference">2021</a>)</span> when possible. If decompositions aren’t feasible (e.g., unbalanced panel), the percentage of never-treated units can indicate bias severity. Expected treatment effect variability should also be discussed.</p></li>
<li><p>In TWFE staggered DiD event studies, avoid binning time periods without evidence of uniform effects. Use full relative-time indicators, justify reference periods, and be wary of multicollinearity causing bias.</p></li>
<li><p>To address treatment timing and bias concerns, use alternative estimators like stacked regressions, <span class="citation">L. Sun and Abraham (<a href="references.html#ref-sun2021estimating">2021</a>)</span>, <span class="citation">Callaway and Sant’Anna (<a href="references.html#ref-callaway2021difference">2021</a>)</span>, or separate regressions for each event with “clean” controls.</p></li>
<li><p>Justify the selection of comparison groups (not-yet treated, last treated, never treated) and ensure the parallel-trends assumption holds, especially when anticipating no effects for certain groups.</p></li>
</ul>
<p>Notes:</p>
<ul>
<li>When subjects are treated at different point in time (variation in treatment timing across units), we have to use staggered DiD (also known as DiD event study or dynamic DiD).</li>
<li>For design where a treatment is applied and units are exposed to this treatment at all time afterward, see <span class="citation">(<a href="references.html#ref-athey2022design">Athey and Imbens 2022</a>)</span>
</li>
</ul>
<p>For example, basic design <span class="citation">(<a href="references.html#ref-stevenson2006bargaining">Stevenson and Wolfers 2006</a>)</span></p>
<p><span class="math display">\[
\begin{aligned}
Y_{it} &amp;= \sum_k \beta_k Treatment_{it}^k + \sum_i \eta_i  State_i \\
&amp;+ \sum_t \lambda_t Year_t + Controls_{it} + \epsilon_{it}
\end{aligned}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(Treatment_{it}^k\)</span> is a series of dummy variables equal to 1 if state <span class="math inline">\(i\)</span> is treated <span class="math inline">\(k\)</span> years ago in period <span class="math inline">\(t\)</span></p></li>
<li><p>SE is usually clustered at the group level (occasionally time level).</p></li>
<li><p>To avoid collinearity, the period right before treatment is usually chosen to drop.</p></li>
</ul>
<p>The more general form of TWFE <span class="citation">(<a href="references.html#ref-sun2021estimating">L. Sun and Abraham 2021</a>)</span>:</p>
<p>First, define the relative period bin indicator as</p>
<p><span class="math display">\[
D_{it}^l = \mathbf{1}(t - E_i = l)
\]</span></p>
<p>where it’s an indicator function of unit <span class="math inline">\(i\)</span> being <span class="math inline">\(l\)</span> periods from its first treatment at time <span class="math inline">\(t\)</span></p>
<ol style="list-style-type: decimal">
<li>
<strong>Static</strong> specificaiton</li>
</ol>
<p><span class="math display">\[
Y_{it} = \alpha_i + \lambda_t + \mu_g \sum_{l \ge0} D_{it}^l + \epsilon_{it}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(\alpha_i\)</span> is the the unit FE</p></li>
<li><p><span class="math inline">\(\lambda_t\)</span> is the time FE</p></li>
<li><p><span class="math inline">\(\mu_g\)</span> is the coefficient of interest <span class="math inline">\(g = [0,T)\)</span></p></li>
<li><p>we exclude all periods before first adoption.</p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>
<strong>Dynamic</strong> specification</li>
</ol>
<p><span class="math display">\[
Y_{it} = \alpha_i + \lambda_t + \sum_{\substack{l = -K \\ l \neq -1}}^{L} \mu_l D_{it}^l + \epsilon_{it}
\]</span></p>
<p>where we have to exclude some relative peridos to avoid multicollinearity problem (e.g., either period right before treatment, or the treatment period).</p>
<p>In this setting, we try to show that the treatment and control groups are not statistically different (i.e., the coefficient estimates before treatment are not different from 0) to show pre-treatment parallel trends.</p>
<p>However, this two-way fixed effects design has been criticized by <span class="citation">L. Sun and Abraham (<a href="references.html#ref-sun2021estimating">2021</a>)</span>; <span class="citation">Callaway and Sant’Anna (<a href="references.html#ref-callaway2021difference">2021</a>)</span>; <span class="citation">Goodman-Bacon (<a href="references.html#ref-goodman2021difference">2021</a>)</span>. When researchers include leads and lags of the treatment to see the long-term effects of the treatment, these leads and lags can be biased by effects from other periods, and pre-trends can falsely arise due to treatment effects heterogeneity.</p>
<p>Applying the new proposed method, finance and accounting researchers find that in many cases, the causal estimates turn out to be null <span class="citation">(<a href="references.html#ref-baker2022much">Baker, Larcker, and Wang 2022</a>)</span>.</p>
<p>Robustness Check</p>
<ul>
<li>The <strong>triple-difference strategy</strong> involves examining the interaction between the <strong>treatment variable</strong> and <strong>the probability of being affected by the program</strong>, and the group-level participation rate. The identification assumption is that there are no differential trends between high and low participation groups in early versus late implementing countries.</li>
</ul>
<div id="assumptions-2" class="section level3" number="26.9.1">
<h3>
<span class="header-section-number">26.9.1</span> Assumptions<a class="anchor" aria-label="anchor" href="#assumptions-2"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>
<p><strong>Rollout Exogeneity</strong> (i.e., exogeneity of treatment adoption): if the treatment is randomly implemented over time (i.e., unrelated to variables that could also affect our dependent variables)</p>
<ul>
<li>Evidence: Regress adoption on pre-treatment variables. And if you find evidence of correlation, include linear trends interacted with pre-treatment variables <span class="citation">(<a href="references.html#ref-hoynes2009consumption">Hoynes and Schanzenbach 2009</a>)</span>
</li>
<li>Evidence: <span class="citation">(<a href="references.html#ref-deshpande2019screened">Deshpande and Li 2019, 223</a>)</span>
<ul>
<li>Treatment is random: Regress treatment status at the unit level to all pre-treatment observables. If you have some that are predictive of treatment status, you might have to argue why it’s not a worry. At best, you want this.</li>
<li>Treatment timing is random: Conditional on treatment, regress timing of the treatment on pre-treatment observables. At least, you want this.</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>No confounding events</strong></p></li>
<li>
<p><strong>Exclusion restrictions</strong></p>
<ul>
<li><p><strong><em>No-anticipation assumption</em></strong>: future treatment time do not affect current outcomes</p></li>
<li><p><strong><em>Invariance-to-history assumption</em></strong>: the time a unit under treatment does not affect the outcome (i.e., the time exposed does not matter, just whether exposed or not). This presents causal effect of early or late adoption on the outcome.</p></li>
</ul>
</li>
<li><p>And all the assumptions in listed in the <a href="difference-in-differences.html#multiple-periods-and-variation-in-treatment-timing">Multiple periods and variation in treatment timing</a></p></li>
<li>
<p>Auxiliary assumptions:</p>
<ul>
<li><p>Constant treatment effects across units</p></li>
<li><p>Constant treatment effect over time</p></li>
<li><p>Random sampling</p></li>
<li><p>Effect Additivity</p></li>
</ul>
</li>
</ul>
<p>Remedies for staggered DiD <span class="citation">(<a href="references.html#ref-baker2022much">Baker, Larcker, and Wang 2022</a>)</span>:</p>
<ul>
<li>
<p>Each treated cohort is compared to appropriate controls (not-yet-treated, never-treated)</p>
<ul>
<li><p><span class="citation">(<a href="references.html#ref-goodman2021difference">Goodman-Bacon 2021</a>)</span></p></li>
<li>
<p><span class="citation">(<a href="references.html#ref-callaway2021difference">Callaway and Sant’Anna 2021</a>)</span> consistent for average ATT. more complicated but also more flexible than <span class="citation">(<a href="references.html#ref-sun2021estimating">L. Sun and Abraham 2021</a>)</span></p>
<ul>
<li>
<span class="citation">(<a href="references.html#ref-sun2021estimating">L. Sun and Abraham 2021</a>)</span> (a special case of <span class="citation">(<a href="references.html#ref-callaway2021difference">Callaway and Sant’Anna 2021</a>)</span>)</li>
</ul>
</li>
<li><p><span class="citation">(<a href="references.html#ref-de2020two">Clément De Chaisemartin and d’Haultfoeuille 2020</a>)</span></p></li>
<li><p><span class="citation">(<a href="references.html#ref-borusyak2021revisiting">Borusyak, Jaravel, and Spiess 2021</a>)</span></p></li>
</ul>
</li>
<li>
<p><a href="difference-in-differences.html#stacked-did">Stacked DID</a> (biased but simple):</p>
<ul>
<li><p><span class="citation">(<a href="references.html#ref-gormley2011growing">Gormley and Matsa 2011</a>)</span></p></li>
<li><p><span class="citation">(<a href="references.html#ref-cengiz2019effect">Cengiz et al. 2019</a>)</span></p></li>
<li><p><span class="citation">(<a href="references.html#ref-deshpande2019screened">Deshpande and Li 2019</a>)</span></p></li>
</ul>
</li>
</ul>
</div>
<div id="stacked-did" class="section level3" number="26.9.2">
<h3>
<span class="header-section-number">26.9.2</span> Stacked DID<a class="anchor" aria-label="anchor" href="#stacked-did"><i class="fas fa-link"></i></a>
</h3>
<p>Notations following <a href="https://scholarworks.iu.edu/dspace/bitstream/handle/2022/26875/2021-10-22_wim_wing_did_slides.pdf?sequence=1&amp;isAllowed=y">these slides</a></p>
<p><span class="math display">\[
Y_{it} = \beta_{FE} D_{it} + A_i + B_t + \epsilon_{it}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(A_i\)</span> is the group fixed effects</p></li>
<li><p><span class="math inline">\(B_t\)</span> is the period fixed effects</p></li>
</ul>
<p>Steps</p>
<ol style="list-style-type: decimal">
<li>Choose Event Window</li>
<li>Enumerate Sub-experiments</li>
<li>Define Inclusion Criteria</li>
<li>Stack Data</li>
<li>Specify Estimating Equation</li>
</ol>
<p><strong>Event Window</strong></p>
<p>Let</p>
<ul>
<li><p><span class="math inline">\(\kappa_a\)</span> be the length of the pre-event window</p></li>
<li><p><span class="math inline">\(\kappa_b\)</span> be the length of the post-event window</p></li>
</ul>
<p>By setting a common event window for the analysis, we essentially exclude all those events that do not meet this criteria.</p>
<p><strong>Sub-experiments</strong></p>
<p>Let <span class="math inline">\(T_1\)</span> be the earliest period in the dataset</p>
<p><span class="math inline">\(T_T\)</span> be the last period in the dataset</p>
<p>Then, the collection of all policy adoption periods that are under our event window is</p>
<p><span class="math display">\[
\Omega_A = \{ A_i |T_1 + \kappa_a \le A_i \le T_T - \kappa_b\}
\]</span></p>
<p>where these events exist</p>
<ul>
<li><p>at least <span class="math inline">\(\kappa_a\)</span> periods after the earliest period</p></li>
<li><p>at least <span class="math inline">\(\kappa_b\)</span> periods before the last period</p></li>
</ul>
<p>Let <span class="math inline">\(d = 1, \dots, D\)</span> be the index column of the sub-experiments in <span class="math inline">\(\Omega_A\)</span></p>
<p>and <span class="math inline">\(\omega_d\)</span> be the event date of the d-th sub-experiment (e.g., <span class="math inline">\(\omega_1\)</span> = adoption date of the 1st experiment)</p>
<p><strong>Inclusion Criteria</strong></p>
<ol style="list-style-type: decimal">
<li>Valid treated Units
<ul>
<li><p>Within sub-experiment <span class="math inline">\(d\)</span>, all treated units have the same adoption date</p></li>
<li><p>This makes sure a unit can only serve as a treated unit in only 1 sub-experiment</p></li>
</ul>
</li>
<li>Clean controls
<ul>
<li><p>Only units satisfying <span class="math inline">\(A_i &gt;\omega_d + \kappa_b\)</span> are included as controls in sub-experiment d</p></li>
<li>
<p>This ensures controls are only</p>
<ul>
<li><p>never treated units</p></li>
<li><p>units that are treated in far future</p></li>
</ul>
</li>
<li><p>But a unit can be control unit in multiple sub-experiments (need to correct SE)</p></li>
</ul>
</li>
<li>Valid Time Periods
<ul>
<li><p>All observations within sub-experiment d are from time periods within the sub-experiment’s event window</p></li>
<li><p>This ensures in sub-experiment d, only observations satisfying <span class="math inline">\(\omega_d - \kappa_a \le t \le \omega_d + \kappa_b\)</span> are included</p></li>
</ul>
</li>
</ol>
<div class="sourceCode" id="cb433"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bcallaway11.github.io/did/">did</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">base_stagg</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># first make the stacked datasets</span></span>
<span><span class="co"># get the treatment cohorts</span></span>
<span><span class="va">cohorts</span> <span class="op">&lt;-</span> <span class="va">base_stagg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year_treated</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># exclude never-treated group</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">year_treated</span> <span class="op">!=</span> <span class="fl">10000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make formula to create the sub-datasets</span></span>
<span><span class="va">getdata</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span>, <span class="va">window</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co">#keep what we need</span></span>
<span>    <span class="va">base_stagg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="co"># keep treated units and all units not treated within -5 to 5</span></span>
<span>        <span class="co"># keep treated units and all units not treated within -window to window</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">year_treated</span> <span class="op">==</span> <span class="va">j</span> <span class="op">|</span> <span class="va">year_treated</span> <span class="op">&gt;</span> <span class="va">j</span> <span class="op">+</span> <span class="va">window</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="co"># keep just year -window to window</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="va">j</span> <span class="op">-</span> <span class="va">window</span> <span class="op">&amp;</span> <span class="va">year</span> <span class="op">&lt;=</span> <span class="va">j</span> <span class="op">+</span> <span class="va">window</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="co"># create an indicator for the dataset</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>df <span class="op">=</span> <span class="va">j</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># get data stacked</span></span>
<span><span class="va">stacked_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_df</a></span><span class="op">(</span><span class="va">cohorts</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/sampling/man/getdata.html">getdata</a></span><span class="op">(</span><span class="va">.</span>, window <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rel_year <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">df</span> <span class="op">==</span> <span class="va">year_treated</span>, <span class="va">time_to_treatment</span>, <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">fastDummies</span><span class="fu">::</span><span class="fu"><a href="https://jacobkap.github.io/fastDummies/reference/dummy_cols.html">dummy_cols</a></span><span class="op">(</span><span class="st">"rel_year"</span>, ignore_na <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"rel_year_"</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get stacked value</span></span>
<span><span class="va">stacked</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span></span>
<span>        <span class="va">y</span> <span class="op">~</span> <span class="va">`rel_year_-5`</span> <span class="op">+</span> <span class="va">`rel_year_-4`</span> <span class="op">+</span> <span class="va">`rel_year_-3`</span> <span class="op">+</span></span>
<span>            <span class="va">`rel_year_-2`</span> <span class="op">+</span> <span class="va">rel_year_0</span> <span class="op">+</span> <span class="va">rel_year_1</span> <span class="op">+</span> <span class="va">rel_year_2</span> <span class="op">+</span> <span class="va">rel_year_3</span> <span class="op">+</span></span>
<span>            <span class="va">rel_year_4</span> <span class="op">+</span> <span class="va">rel_year_5</span> <span class="op">|</span></span>
<span>            <span class="va">id</span> <span class="op">^</span> <span class="va">df</span> <span class="op">+</span> <span class="va">year</span> <span class="op">^</span> <span class="va">df</span>,</span>
<span>        data <span class="op">=</span> <span class="va">stacked_data</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">coefficients</span></span>
<span></span>
<span><span class="va">stacked_se</span> <span class="op">=</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span></span>
<span>    <span class="va">y</span> <span class="op">~</span> <span class="va">`rel_year_-5`</span> <span class="op">+</span> <span class="va">`rel_year_-4`</span> <span class="op">+</span> <span class="va">`rel_year_-3`</span> <span class="op">+</span></span>
<span>        <span class="va">`rel_year_-2`</span> <span class="op">+</span> <span class="va">rel_year_0</span> <span class="op">+</span> <span class="va">rel_year_1</span> <span class="op">+</span> <span class="va">rel_year_2</span> <span class="op">+</span> <span class="va">rel_year_3</span> <span class="op">+</span></span>
<span>        <span class="va">rel_year_4</span> <span class="op">+</span> <span class="va">rel_year_5</span> <span class="op">|</span></span>
<span>        <span class="va">id</span> <span class="op">^</span> <span class="va">df</span> <span class="op">+</span> <span class="va">year</span> <span class="op">^</span> <span class="va">df</span>,</span>
<span>    data <span class="op">=</span> <span class="va">stacked_data</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">se</span></span>
<span></span>
<span><span class="co"># add in 0 for omitted -1</span></span>
<span><span class="va">stacked</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">stacked</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">0</span>, <span class="va">stacked</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">stacked_se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">stacked_se</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">0</span>, <span class="va">stacked_se</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">cs_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bcallaway11.github.io/did/reference/att_gt.html">att_gt</a></span><span class="op">(</span></span>
<span>    yname <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    gname <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    idname <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    <span class="co"># xformla = "~x1",</span></span>
<span>    tname <span class="op">=</span> <span class="st">"year"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cs</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://bcallaway11.github.io/did/reference/aggte.html">aggte</a></span><span class="op">(</span></span>
<span>        <span class="va">cs_out</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"dynamic"</span>,</span>
<span>        min_e <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>,</span>
<span>        max_e <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        bstrap <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        cband <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">res_sa20</span> <span class="op">=</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu">sunab</span><span class="op">(</span><span class="va">year_treated</span>, <span class="va">year</span><span class="op">)</span> <span class="op">|</span></span>
<span>                     <span class="va">id</span> <span class="op">+</span> <span class="va">year</span>, <span class="va">base_stagg</span><span class="op">)</span></span>
<span><span class="va">sa</span> <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">res_sa20</span><span class="op">)</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">14</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span></span>
<span><span class="va">sa</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sa</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">0</span>, <span class="va">sa</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sa_se</span> <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">res_sa20</span><span class="op">)</span><span class="op">[</span><span class="fl">6</span><span class="op">:</span><span class="fl">15</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">std.error</span><span class="op">)</span></span>
<span><span class="va">sa_se</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sa_se</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">0</span>, <span class="va">sa_se</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">compare_df_est</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    period <span class="op">=</span> <span class="op">-</span><span class="fl">5</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>    cs <span class="op">=</span> <span class="va">cs</span><span class="op">$</span><span class="va">att.egt</span>,</span>
<span>    sa <span class="op">=</span> <span class="va">sa</span>,</span>
<span>    stacked <span class="op">=</span> <span class="va">stacked</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">compare_df_se</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    period <span class="op">=</span> <span class="op">-</span><span class="fl">5</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>    cs <span class="op">=</span> <span class="va">cs</span><span class="op">$</span><span class="va">se.egt</span>,</span>
<span>    sa <span class="op">=</span> <span class="va">sa_se</span>,</span>
<span>    stacked <span class="op">=</span> <span class="va">stacked_se</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">compare_df_longer</span> <span class="op">&lt;-</span> <span class="va">compare_df_est</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">!</span><span class="va">period</span>, names_to <span class="op">=</span> <span class="st">"estimator"</span>, values_to <span class="op">=</span> <span class="st">"est"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">compare_df_se</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">!</span><span class="va">period</span>, names_to <span class="op">=</span> <span class="st">"estimator"</span>, values_to <span class="op">=</span> <span class="st">"se"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>upper <span class="op">=</span> <span class="va">est</span> <span class="op">+</span>  <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span>,</span>
<span>           lower <span class="op">=</span> <span class="va">est</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">compare_df_longer</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">period</span>,</span>
<span>        ymin <span class="op">=</span> <span class="va">lower</span>,</span>
<span>        ymax <span class="op">=</span> <span class="va">upper</span>,</span>
<span>        group <span class="op">=</span> <span class="va">estimator</span></span>
<span>    <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">period</span>,</span>
<span>        y <span class="op">=</span> <span class="va">est</span>,</span>
<span>        group <span class="op">=</span> <span class="va">estimator</span>,</span>
<span>        col <span class="op">=</span> <span class="va">estimator</span></span>
<span>    <span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-11-1.png" width="90%" style="display: block; margin: auto;"></div>
<p><strong>Stack Data</strong></p>
<p>Estimating Equation</p>
<p><span class="math display">\[
Y_{itd} = \beta_0 + \beta_1 T_{id} + \beta_2 P_{td} + \beta_3 (T_{id} \times P_{td}) + \epsilon_{itd}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(T_{id}\)</span> = 1 if unit <span class="math inline">\(i\)</span> is treated in sub-experiment <span class="math inline">\(d\)</span>, 0 if control</p></li>
<li><p><span class="math inline">\(P_{td}\)</span> = 1 if it’s the period after the treatment in sub-experiment <span class="math inline">\(d\)</span></p></li>
</ul>
<p>Equivalently,</p>
<p><span class="math display">\[
Y_{itd} = \beta_3 (T_{id} \times P_{td}) + \theta_{id} + \gamma_{td} + \epsilon_{itd}
\]</span></p>
<p><span class="math inline">\(\beta_3\)</span> averages all the time-varying effects into a single number (can’t see the time-varying effects)</p>
<p><strong>Stacked Event Study</strong></p>
<p>Let <span class="math inline">\(YSE_{td} = t - \omega_d\)</span> be the “time since event” variable in sub-experiment <span class="math inline">\(d\)</span></p>
<p>Then, <span class="math inline">\(YSE_{td} = -\kappa_a, \dots, 0, \dots, \kappa_b\)</span> in every sub-experiment</p>
<p>In each sub-experiment, we can fit</p>
<p><span class="math display">\[
Y_{it}^d = \sum_{j = -\kappa_a}^{\kappa_b} \beta_j^d \times 1(TSE_{td} = j) + \sum_{m = -\kappa_a}^{\kappa_b} \delta_j^d (T_{id} \times 1 (TSE_{td} = j)) + \theta_i^d + \epsilon_{it}^d
\]</span></p>
<ul>
<li>Different set of event study coefficients in each sub-experiment</li>
</ul>
<p><span class="math display">\[
Y_{itd} = \sum_{j = -\kappa_a}^{\kappa_b} \beta_j \times 1(TSE_{td} = j) + \sum_{m = -\kappa_a}^{\kappa_b} \delta_j (T_{id} \times 1 (TSE_{td} = j)) + \theta_{id} + \epsilon_{itd}
\]</span></p>
<p><strong>Clustering</strong></p>
<ul>
<li><p>Clustered at the unit x sub-experiment level <span class="citation">(<a href="references.html#ref-cengiz2019effect">Cengiz et al. 2019</a>)</span></p></li>
<li><p>Clustered at the unit level <span class="citation">(<a href="references.html#ref-deshpande2019screened">Deshpande and Li 2019</a>)</span></p></li>
</ul>
</div>
<div id="goodman-bacon-decomposition" class="section level3" number="26.9.3">
<h3>
<span class="header-section-number">26.9.3</span> Goodman-Bacon Decomposition<a class="anchor" aria-label="anchor" href="#goodman-bacon-decomposition"><i class="fas fa-link"></i></a>
</h3>
<p>Paper: <span class="citation">(<a href="references.html#ref-goodman2021difference">Goodman-Bacon 2021</a>)</span></p>
<p>For an excellent explanation slides by the author, <a href="https://www.stata.com/meeting/chicago19/slides/chicago19_Goodman-Bacon.pdf">see</a></p>
<p>Takeaways:</p>
<ul>
<li><p>A pairwise DID (<span class="math inline">\(\tau\)</span>) gets more weight if the change is close to the middle of the study window</p></li>
<li><p>A pairwise DID (<span class="math inline">\(\tau\)</span>) gets more weight if it includes more observations.</p></li>
</ul>
<p>Code from <code>bacondecomp</code> vignette</p>
<div class="sourceCode" id="cb434"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">bacondecomp</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"castle"</span><span class="op">)</span></span>
<span><span class="va">castle</span> <span class="op">&lt;-</span> <span class="fu">bacondecomp</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/bacondecomp/man/castle.html">castle</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"l_homicide"</span>, <span class="st">"post"</span>, <span class="st">"state"</span>, <span class="st">"year"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">castle</span><span class="op">)</span></span>
<span><span class="co">#&gt;   l_homicide post   state year</span></span>
<span><span class="co">#&gt; 1   2.027356    0 Alabama 2000</span></span>
<span><span class="co">#&gt; 2   2.164867    0 Alabama 2001</span></span>
<span><span class="co">#&gt; 3   1.936334    0 Alabama 2002</span></span>
<span><span class="co">#&gt; 4   1.919567    0 Alabama 2003</span></span>
<span><span class="co">#&gt; 5   1.749841    0 Alabama 2004</span></span>
<span><span class="co">#&gt; 6   2.130440    0 Alabama 2005</span></span>
<span></span>
<span></span>
<span><span class="va">df_bacon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/bacondecomp/man/bacon.html">bacon</a></span><span class="op">(</span></span>
<span>    <span class="va">l_homicide</span> <span class="op">~</span> <span class="va">post</span>,</span>
<span>    data <span class="op">=</span> <span class="va">castle</span>,</span>
<span>    id_var <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>    time_var <span class="op">=</span> <span class="st">"year"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;                       type  weight  avg_est</span></span>
<span><span class="co">#&gt; 1 Earlier vs Later Treated 0.05976 -0.00554</span></span>
<span><span class="co">#&gt; 2 Later vs Earlier Treated 0.03190  0.07032</span></span>
<span><span class="co">#&gt; 3     Treated vs Untreated 0.90834  0.08796</span></span>
<span></span>
<span><span class="co"># weighted average of the decomposition</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">df_bacon</span><span class="op">$</span><span class="va">estimate</span> <span class="op">*</span> <span class="va">df_bacon</span><span class="op">$</span><span class="va">weight</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.08181162</span></span></code></pre></div>
<p>Two-way Fixed effect estimate</p>
<div class="sourceCode" id="cb435"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span><span class="op">)</span></span>
<span><span class="va">fit_tw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">l_homicide</span> <span class="op">~</span> <span class="va">post</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>,</span>
<span>             data <span class="op">=</span> <span class="fu">bacondecomp</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/bacondecomp/man/castle.html">castle</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">fit_tw</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 5</span></span>
<span><span class="co">#&gt;   term                    estimate std.error statistic   p.value</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 (Intercept)               1.95      0.0624    31.2   2.84e-118</span></span>
<span><span class="co">#&gt; 2 post                      0.0818    0.0317     2.58  1.02e-  2</span></span>
<span><span class="co">#&gt; 3 factor(state)Alaska      -0.373     0.0797    -4.68  3.77e-  6</span></span>
<span><span class="co">#&gt; 4 factor(state)Arizona      0.0158    0.0797     0.198 8.43e-  1</span></span>
<span><span class="co">#&gt; 5 factor(state)Arkansas    -0.118     0.0810    -1.46  1.44e-  1</span></span>
<span><span class="co">#&gt; 6 factor(state)California  -0.108     0.0810    -1.34  1.82e-  1</span></span></code></pre></div>
<p>Hence, naive TWFE fixed effect equals the weighted average of the Bacon decomposition (= 0.08).</p>
<div class="sourceCode" id="cb436"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_bacon</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">weight</span>,</span>
<span>        y <span class="op">=</span> <span class="va">estimate</span>,</span>
<span>        <span class="co"># shape = factor(type),</span></span>
<span>        color <span class="op">=</span> <span class="va">type</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Weight"</span>, y <span class="op">=</span> <span class="st">"Estimate"</span>, shape <span class="op">=</span> <span class="st">"Type"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-14-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>With time-varying controls that can identify variation within-treatment timing group, the”early vs. late” and “late vs. early” estimates collapse to just one estimate (i.e., both treated).</p>
</div>
<div id="did-with-in-and-out-treatment-condition" class="section level3" number="26.9.4">
<h3>
<span class="header-section-number">26.9.4</span> DID with in and out treatment condition<a class="anchor" aria-label="anchor" href="#did-with-in-and-out-treatment-condition"><i class="fas fa-link"></i></a>
</h3>
<div id="panel-match" class="section level4" number="26.9.4.1">
<h4>
<span class="header-section-number">26.9.4.1</span> Panel Match<a class="anchor" aria-label="anchor" href="#panel-match"><i class="fas fa-link"></i></a>
</h4>
<p><span class="citation">Imai and Kim (<a href="references.html#ref-imai2021use">2021</a>)</span></p>
<p>This case generalizes the staggered adoption setting, allowing units to vary in treatment over time. For <span class="math inline">\(N\)</span> units across <span class="math inline">\(T\)</span> time periods (with potentially unbalanced panels), let <span class="math inline">\(X_{it}\)</span> represent treatment and <span class="math inline">\(Y_{it}\)</span> the outcome for unit <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span>. We use the two-way linear fixed effects model:</p>
<p><span class="math display">\[
Y_{it} = \alpha_i + \gamma_t + \beta X_{it} + \epsilon_{it}
\]</span></p>
<p>for <span class="math inline">\(i = 1, \dots, N\)</span> and <span class="math inline">\(t = 1, \dots, T\)</span>. Here, <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\gamma_t\)</span> are unit and time fixed effects. They capture time-invariant unit-specific and unit-invariant time-specific unobserved confounders, respectively. We can express these as <span class="math inline">\(\alpha_i = h(\mathbf{U}_i)\)</span> and <span class="math inline">\(\gamma_t = f(\mathbf{V}_t)\)</span>, with <span class="math inline">\(\mathbf{U}_i\)</span> and <span class="math inline">\(\mathbf{V}_t\)</span> being the confounders. The model doesn’t assume a specific form for <span class="math inline">\(h(.)\)</span> and <span class="math inline">\(f(.)\)</span>, but that they’re additive and separable given binary treatment.</p>
<p>The least squares estimate of <span class="math inline">\(\beta\)</span> leverages the covariance in outcome and treatment <span class="citation">(<a href="references.html#ref-imai2021use">Imai and Kim 2021, 406</a>)</span>. Specifically, it uses the within-unit and within-time variations. Many researchers prefer the two fixed effects (2FE) estimator because it adjusts for both types of unobserved confounders without specific functional-form assumptions, but this is wrong <span class="citation">(<a href="references.html#ref-imai2019should">Imai and Kim 2019</a>)</span>. We do need functional-form assumption (i.e., linearity assumption) for the 2FE to work <span class="citation">(<a href="references.html#ref-imai2021use">Imai and Kim 2021, 406</a>)</span></p>
<ul>
<li>
<p><strong>Two-Way Matching Estimator</strong>:</p>
<ul>
<li><p>It can lead to mismatches; units with the same treatment status get matched when estimating counterfactual outcomes.</p></li>
<li><p>Observations need to be matched with opposite treatment status for correct causal effects estimation.</p></li>
<li><p>Mismatches can cause attenuation bias.</p></li>
<li><p>The 2FE estimator adjusts for this bias using the factor <span class="math inline">\(K\)</span>, which represents the net proportion of proper matches between observations with opposite treatment status.</p></li>
</ul>
</li>
<li>
<p><strong>Weighting in 2FE</strong>:</p>
<ul>
<li><p>Observation <span class="math inline">\((i,t)\)</span> is weighted based on how often it acts as a control unit.</p></li>
<li><p>The weighted 2FE estimator still has mismatches, but fewer than the standard 2FE estimator.</p></li>
<li><p>Adjustments are made based on observations that neither belong to the same unit nor the same time period as the matched observation.</p></li>
<li><p>This means there are challenges in adjusting for unit-specific and time-specific unobserved confounders under the two-way fixed effect framework.</p></li>
</ul>
</li>
<li>
<p><strong>Equivalence &amp; Assumptions</strong>:</p>
<ul>
<li><p>Equivalence between the 2FE estimator and the DID estimator is dependent on the linearity assumption.</p></li>
<li><p>The multi-period DiD estimator is described as an average of two-time-period, two-group DiD estimators applied during changes from control to treatment.</p></li>
</ul>
</li>
<li>
<p><strong>Comparison with DiD</strong>:</p>
<ul>
<li><p>In simple settings (two time periods, treatment given to one group in the second period), the standard nonparametric DiD estimator equals the 2FE estimator.</p></li>
<li><p>This doesn’t hold in multi-period DiD designs where units change treatment status multiple times at different intervals.</p></li>
<li><p>Contrary to popular belief, the unweighted 2FE estimator isn’t generally equivalent to the multi-period DiD estimator.</p></li>
<li><p>While the multi-period DiD can be equivalent to the weighted 2FE, some control observations may have negative regression weights.</p></li>
</ul>
</li>
<li>
<p><strong>Conclusion</strong>:</p>
<ul>
<li>Justifying the 2FE estimator as the DID estimator isn’t warranted without imposing the linearity assumption.</li>
</ul>
</li>
</ul>
<p><strong>Application <span class="citation">(<a href="references.html#ref-imai2021matching">Imai, Kim, and Wang 2021</a>)</span></strong></p>
<ul>
<li>
<p><strong>Matching Methods</strong>:</p>
<ul>
<li><p>Enhance the validity of causal inference.</p></li>
<li><p>Reduce model dependence and provide intuitive diagnostics <span class="citation">(<a href="references.html#ref-ho2007matching">Ho et al. 2007</a>)</span></p></li>
<li><p>Rarely utilized in analyzing time series cross-sectional data.</p></li>
<li><p>The proposed matching estimators are more robust than the standard two-way fixed effects estimator, which can be biased if mis-specified</p></li>
<li><p>Better than synthetic controls (e.g., <span class="citation">(<a href="references.html#ref-xu2017generalized">Xu 2017</a>)</span>) because it needs less data to achieve good performance and and adapt the the context of unit switching treatment status multiple times.</p></li>
</ul>
</li>
<li>
<p>Notes:</p>
<ul>
<li>Potential carryover effects (treatment may have a long-term effect), leading to post-treatment bias.</li>
</ul>
</li>
<li>
<p><strong>Proposed Approach</strong>:</p>
<ol style="list-style-type: decimal">
<li><p>Treated observations are matched with control observations from other units in the same time period with the same treatment history up to a specified number of lags.</p></li>
<li><p>Standard matching and weighting techniques are employed to further refine the matched set.</p></li>
<li><p>Apply a DiD estimator to adjust for time trend.</p></li>
<li><p>The goal is to have treated and matched control observations with similar covariate values.</p></li>
</ol>
</li>
<li>
<p><strong>Assessment</strong>:</p>
<ul>
<li>The quality of matches is evaluated through covariate balancing.</li>
</ul>
</li>
<li>
<p><strong>Estimation</strong>:</p>
<ul>
<li>Both short-term and long-term average treatment effects on the treated (ATT) are estimated.</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb437"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">PanelMatch</span><span class="op">)</span></span></code></pre></div>
<p><strong>Treatment Variation plot</strong></p>
<ul>
<li><p>Visualize the variation of the treatment across space and time</p></li>
<li><p>Aids in discerning whether the treatment fluctuates adequately over time and units or if the variation is primarily clustered in a subset of data.</p></li>
</ul>
<div class="sourceCode" id="cb438"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/DisplayTreatment.html">DisplayTreatment</a></span><span class="op">(</span></span>
<span>    unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>    time.id <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"Country Code"</span>,</span>
<span>    treatment <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>    </span>
<span>    hide.x.tick.label <span class="op">=</span> <span class="cn">TRUE</span>, hide.y.tick.label <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>    <span class="co"># dense.plot = TRUE,</span></span>
<span>    data <span class="op">=</span> <span class="va">dem</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-16-1.png" width="90%" style="display: block; margin: auto;"></div>
<ol style="list-style-type: decimal">
<li>Select <span class="math inline">\(F\)</span> (i.e., the number of leads - time periods after treatment). Driven by what authors are interested in estimating:</li>
</ol>
<ul>
<li><p><span class="math inline">\(F = 0\)</span> is the contemporaneous effect (short-term effect)</p></li>
<li><p><span class="math inline">\(F = n\)</span> is the the treatment effect on the outcome two time periods after the treatment. (cumulative or long-term effect)</p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Select <span class="math inline">\(L\)</span> (number of lags to adjust).</li>
</ol>
<ul>
<li><p>Driven by the identification assumption.</p></li>
<li><p>Balances bias-variance tradeoff.</p></li>
<li><p>Higher <span class="math inline">\(L\)</span> values increase credibility but reduce efficiency by limiting potential matches.</p></li>
</ul>
<p><strong>Model assumption</strong>:</p>
<ul>
<li><p>No spillover effect assumed.</p></li>
<li><p>Carryover effect allowed up to <span class="math inline">\(L\)</span> periods.</p></li>
<li><p>Potential outcome for a unit depends neither on others’ treatment status nor on its past treatment after <span class="math inline">\(L\)</span> periods.</p></li>
</ul>
<p>After defining causal quantity with parameters <span class="math inline">\(L\)</span> and <span class="math inline">\(F\)</span>.</p>
<ul>
<li>Focus on the average treatment effect of treatment status change.</li>
<li>
<span class="math inline">\(\delta(F,L)\)</span> is the average causal effect of treatment change (ATT), <span class="math inline">\(F\)</span> periods post-treatment, considering treatment history up to <span class="math inline">\(L\)</span> periods.</li>
<li>Causal quantity considers potential future treatment reversals, meaning treatment could revert to control before outcome measurement.</li>
</ul>
<p>Also possible to estimate the average treatment effect of treatment reversal on the reversed (ART).</p>
<p>Choose <span class="math inline">\(L,F\)</span> based on specific needs.</p>
<ul>
<li>
<p>A large <span class="math inline">\(L\)</span> value:</p>
<ul>
<li><p>Increases the credibility of the limited carryover effect assumption.</p></li>
<li><p>Allows more past treatments (up to <span class="math inline">\(t−L\)</span>) to influence the outcome <span class="math inline">\(Y_{i,t+F}\)</span>.</p></li>
<li><p>Might reduce the number of matches and lead to less precise estimates.</p></li>
</ul>
</li>
<li>
<p>Selecting an appropriate number of lags</p>
<ul>
<li><p>Researchers should base this choice on substantive knowledge.</p></li>
<li><p>Sensitivity of empirical results to this choice should be examined.</p></li>
</ul>
</li>
<li>
<p>The choice of <span class="math inline">\(F\)</span> should be:</p>
<ul>
<li><p>Substantively motivated.</p></li>
<li><p>Decides whether the interest lies in short-term or long-term causal effects.</p></li>
<li><p>A large <span class="math inline">\(F\)</span> value can complicate causal effect interpretation, especially if many units switch treatment status during the <span class="math inline">\(F\)</span> lead time period.</p></li>
</ul>
</li>
</ul>
<p><strong>Identification Assumption</strong></p>
<ul>
<li><p>Parallel trend assumption conditioned on treatment, outcome (excluding immediate lag), and covariate histories.</p></li>
<li><p>Doesn’t require strong unconfoundedness assumption.</p></li>
<li><p>Cannot account for unobserved time-varying confounders.</p></li>
<li>
<p>Essential to examine outcome time trends.</p>
<ul>
<li>Check if they’re parallel between treated and matched control units using pre-treatment data</li>
</ul>
</li>
<li>
<p><strong>Constructing the Matched Sets</strong>:</p>
<ul>
<li><p>For each treated observation, create matched control units with identical treatment history from <span class="math inline">\(t−L\)</span> to <span class="math inline">\(t−1\)</span>.</p></li>
<li><p>Matching based on treatment history helps control for carryover effects.</p></li>
<li><p>Past treatments often act as major confounders, but this method can correct for it.</p></li>
<li><p>Exact matching on time period adjusts for time-specific unobserved confounders.</p></li>
<li><p>Unlike staggered adoption methods, units can change treatment status multiple times.</p></li>
<li><p>Matched set allows treatment switching in and out of treatment</p></li>
</ul>
</li>
<li>
<p><strong>Refining the Matched Sets</strong>:</p>
<ul>
<li><p>Initially, matched sets adjust only for treatment history.</p></li>
<li><p>Parallel trend assumption requires adjustments for other confounders like past outcomes and covariates.</p></li>
<li>
<p>Matching methods:</p>
<ul>
<li><p>Match each treated observation with up to <span class="math inline">\(J\)</span> control units.</p></li>
<li><p>Distance measures like Mahalanobis distance or propensity score can be used.</p></li>
<li><p>Match based on estimated propensity score, considering pretreatment covariates.</p></li>
<li><p>Refined matched set selects most similar control units based on observed confounders.</p></li>
</ul>
</li>
<li>
<p>Weighting methods:</p>
<ul>
<li><p>Assign weight to each control unit in a matched set.</p></li>
<li><p>Weights prioritize more similar units.</p></li>
<li><p>Inverse propensity score weighting method can be applied.</p></li>
<li><p>Weighting is a more generalized method than matching.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>The Difference-in-Differences Estimator</strong>:</p>
<ul>
<li><p>Using refined matched sets, the ATT (Average Treatment Effect on the Treated) of policy change is estimated.</p></li>
<li><p>For each treated observation, estimate the counterfactual outcome using the weighted average of control units in the refined set.</p></li>
<li><p>The DiD estimate of the ATT is computed for each treated observation, then averaged across all such observations.</p></li>
<li>
<p>For noncontemporaneous treatment effects where <span class="math inline">\(F &gt; 0\)</span>:</p>
<ul>
<li><p>The ATT doesn’t specify future treatment sequence.</p></li>
<li><p>Matched control units might have units receiving treatment between time <span class="math inline">\(t\)</span> and <span class="math inline">\(t + F\)</span>.</p></li>
<li><p>Some treated units could return to control conditions between these times.</p></li>
</ul>
</li>
</ul>
<p><strong>Checking Covariate Balance</strong>:</p>
<ul>
<li><p>The proposed methodology offers the advantage of checking covariate balance between treated and matched control observations.</p></li>
<li><p>This check helps to see if treated and matched control observations are comparable with respect to observed confounders.</p></li>
<li><p>Once matched sets are refined, covariate balance examination becomes straightforward.</p></li>
<li><p>Examine the mean difference of each covariate between a treated observation and its matched controls for each pretreatment time period.</p></li>
<li><p>Standardize this difference using the standard deviation of each covariate across all treated observations in the dataset.</p></li>
<li><p>Aggregate this covariate balance measure across all treated observations for each covariate and pretreatment time period.</p></li>
<li>
<p>Examine balance for lagged outcome variables over multiple pretreatment periods and time-varying covariates.</p>
<ul>
<li>This helps evaluate the validity of the parallel trend assumption underlying the proposed DiD estimator.</li>
</ul>
</li>
</ul>
<p><strong>Relations with Linear Fixed Effects Regression Estimators</strong>:</p>
<ul>
<li>
<p>The standard DiD estimator is equivalent to the linear two-way fixed effects regression estimator when:</p>
<ul>
<li><p>Only two time periods exist.</p></li>
<li><p>Treatment is given to some units exclusively in the second period.</p></li>
</ul>
</li>
<li>
<p>This equivalence doesn’t extend to multiperiod DiD designs, where:</p>
<ul>
<li><p>More than two time periods are considered.</p></li>
<li><p>Units might receive treatment multiple times.</p></li>
</ul>
</li>
<li><p>Despite this, many researchers relate the use of the two-way fixed effects estimator to the DiD design.</p></li>
</ul>
<p><strong>Standard Error Calculation</strong>:</p>
<ul>
<li>
<p>Approach:</p>
<ul>
<li><p>Condition on the weights implied by the matching process.</p></li>
<li><p>These weights denote how often an observation is utilized in matching <span class="citation">(<a href="references.html#ref-imbens2015causal">G. W. Imbens and Rubin 2015</a>)</span></p></li>
</ul>
</li>
<li>
<p>Context:</p>
<ul>
<li><p>Analogous to the conditional variance seen in regression models.</p></li>
<li><p>Resulting standard errors don’t factor in uncertainties around the matching procedure.</p></li>
<li><p>They can be viewed as a measure of uncertainty conditional upon the matching process <span class="citation">(<a href="references.html#ref-ho2007matching">Ho et al. 2007</a>)</span>.</p></li>
</ul>
</li>
</ul>
<p><strong>Key Findings</strong>:</p>
<ul>
<li><p>Even in conditions favoring OLS, the proposed matching estimator displayed higher robustness to omitted relevant lags than the linear regression model with fixed effects.</p></li>
<li><p>The robustness offered by matching came at a cost - reduced statistical power.</p></li>
<li><p>This emphasizes the classic statistical tradeoff between bias (where matching has an advantage) and variance (where regression models might be more efficient).</p></li>
</ul>
<p><strong>Data Requirements</strong></p>
<ul>
<li>
<p>The treatment variable is binary:</p>
<ul>
<li><p>0 signifies “assignment” to control.</p></li>
<li><p>1 signifies assignment to treatment.</p></li>
</ul>
</li>
<li><p>Variables identifying units in the data must be: Numeric or integer.</p></li>
<li><p>Variables identifying time periods should be: Consecutive numeric/integer data.</p></li>
<li><p>Data format requirement: Must be provided as a standard <code>data.frame</code> object.</p></li>
</ul>
<p>Basic functions:</p>
<ol style="list-style-type: decimal">
<li><p>Utilize treatment histories to create matching sets of treated and control units.</p></li>
<li>
<p>Refine these matched sets by determining weights for each control unit in the set.</p>
<ul>
<li>Units with higher weights have a larger influence during estimations.</li>
</ul>
</li>
</ol>
<p><strong>Matching on Treatment History</strong>:</p>
<ul>
<li><p>Goal is to match units transitioning from untreated to treated status with control units that have similar past treatment histories.</p></li>
<li>
<p>Setting the Quantity of Interest (<code>qoi =</code>)</p>
<ul>
<li><p><code>att</code> average treatment effect on treated units</p></li>
<li><p><code>atc</code> average treatment effect of treatment on the control units</p></li>
<li><p><code>art</code> average effect of treatment reversal for units that experience treatment reversal</p></li>
<li><p><code>ate</code> average treatment effect</p></li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb439"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">PanelMatch</span><span class="op">)</span></span>
<span><span class="co"># All examples follow the package's vignette</span></span>
<span><span class="co"># Create the matched sets</span></span>
<span><span class="va">PM.results.none</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        time.id <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>        treatment <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        refinement.method <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>        data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>        match.missing <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        size.match <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi <span class="op">=</span> <span class="st">"att"</span>,</span>
<span>        outcome.var <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        use.diagonal.variance.matrix <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># visualize the treated unit and matched controls</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/DisplayTreatment.html">DisplayTreatment</a></span><span class="op">(</span></span>
<span>    unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>    time.id <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"Country Code"</span>,</span>
<span>    treatment <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>    data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    matched.set <span class="op">=</span> <span class="va">PM.results.none</span><span class="op">$</span><span class="va">att</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>    <span class="co"># highlight the particular set</span></span>
<span>    show.set.only <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-17-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>Control units and the treated unit have identical treatment histories over the lag window (1988-1991)</p>
<div class="sourceCode" id="cb440"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/DisplayTreatment.html">DisplayTreatment</a></span><span class="op">(</span></span>
<span>    unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>    time.id <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"Country Code"</span>,</span>
<span>    treatment <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>    data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    matched.set <span class="op">=</span> <span class="va">PM.results.none</span><span class="op">$</span><span class="va">att</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>    <span class="co"># highlight the particular set</span></span>
<span>    show.set.only <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-18-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>This set is more limited than the first one, but we can still see that we have exact past histories.</p>
<ul>
<li>
<p><strong>Refining Matched Sets</strong></p>
<ul>
<li><p>Refinement involves assigning weights to control units.</p></li>
<li>
<p>Users must:</p>
<ol style="list-style-type: decimal">
<li><p>Specify a method for calculating unit similarity/distance.</p></li>
<li><p>Choose variables for similarity/distance calculations.</p></li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>Select a Refinement Method</strong></p>
<ul>
<li><p>Users determine the refinement method via the <strong><code>refinement.method</code></strong> argument.</p></li>
<li>
<p>Options include:</p>
<ul>
<li><p><code>mahalanobis</code></p></li>
<li><p><code>ps.match</code></p></li>
<li><p><code>CBPS.match</code></p></li>
<li><p><code>ps.weight</code></p></li>
<li><p><code>CBPS.weight</code></p></li>
<li><p><code>ps.msm.weight</code></p></li>
<li><p><code>CBPS.msm.weight</code></p></li>
<li><p><code>none</code></p></li>
</ul>
</li>
<li><p>Methods with “match” in the name and Mahalanobis will assign equal weights to similar control units.</p></li>
<li><p>“Weighting” methods give higher weights to control units more similar to treated units.</p></li>
</ul>
</li>
<li>
<p><strong>Variable Selection</strong></p>
<ul>
<li><p>Users need to define which covariates will be used through the <strong><code>covs.formula</code></strong> argument, a one-sided formula object.</p></li>
<li><p>Variables on the right side of the formula are used for calculations.</p></li>
<li><p>“Lagged” versions of variables can be included using the format: <strong><code>I(lag(name.of.var, 0:n))</code></strong>.</p></li>
</ul>
</li>
<li>
<p><strong>Understanding <code>PanelMatch</code> and <code>matched.set</code> objects</strong></p>
<ul>
<li><p>The <strong><code>PanelMatch</code> function</strong> returns a <strong><code>PanelMatch</code> object</strong>.</p></li>
<li><p>The most crucial element within the <code>PanelMatch</code> object is the <strong>matched.set object</strong>.</p></li>
<li><p>Within the <code>PanelMatch</code> object, the matched.set object will have names like att, art, or atc.</p></li>
<li><p>If <strong><code>qoi = ate</code></strong>, there will be two matched.set objects: att and atc.</p></li>
</ul>
</li>
<li>
<p><strong>Matched.set Object Details</strong></p>
<ul>
<li><p>matched.set is a named list with added attributes.</p></li>
<li>
<p>Attributes include:</p>
<ul>
<li><p>Lag</p></li>
<li><p>Names of treatment</p></li>
<li><p>Unit and time variables</p></li>
</ul>
</li>
<li><p>Each list entry represents a matched set of treated and control units.</p></li>
<li><p>Naming follows a structure: <strong><code>[id variable].[time variable]</code></strong>.</p></li>
<li><p>Each list element is a vector of control unit ids that match the treated unit mentioned in the element name.</p></li>
<li><p>Since it’s a matching method, weights are only given to the <strong><code>size.match</code></strong> most similar control units based on distance calculations.</p></li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb441"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># PanelMatch without any refinement</span></span>
<span><span class="va">PM.results.none</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        time.id <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>        treatment <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        refinement.method <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>        data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>        match.missing <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        size.match <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi <span class="op">=</span> <span class="st">"att"</span>,</span>
<span>        outcome.var <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        use.diagonal.variance.matrix <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract the matched.set object</span></span>
<span><span class="va">msets.none</span> <span class="op">&lt;-</span> <span class="va">PM.results.none</span><span class="op">$</span><span class="va">att</span></span>
<span></span>
<span><span class="co"># PanelMatch with refinement</span></span>
<span><span class="va">PM.results.maha</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        time.id <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>        treatment <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        refinement.method <span class="op">=</span> <span class="st">"mahalanobis"</span>, <span class="co"># use Mahalanobis distance</span></span>
<span>        data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>        match.missing <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        covs.formula <span class="op">=</span> <span class="op">~</span> <span class="va">tradewb</span>,</span>
<span>        size.match <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi <span class="op">=</span> <span class="st">"att"</span> ,</span>
<span>        outcome.var <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        use.diagonal.variance.matrix <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span><span class="va">msets.maha</span> <span class="op">&lt;-</span> <span class="va">PM.results.maha</span><span class="op">$</span><span class="va">att</span></span></code></pre></div>
<div class="sourceCode" id="cb442"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># these 2 should be identical because weights are not shown</span></span>
<span><span class="va">msets.none</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   wbcode2 year matched.set.size</span></span>
<span><span class="co">#&gt; 1       4 1992               74</span></span>
<span><span class="co">#&gt; 2       4 1997                2</span></span>
<span><span class="co">#&gt; 3       6 1973               63</span></span>
<span><span class="co">#&gt; 4       6 1983               73</span></span>
<span><span class="co">#&gt; 5       7 1991               81</span></span>
<span><span class="co">#&gt; 6       7 1998                1</span></span>
<span><span class="va">msets.maha</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   wbcode2 year matched.set.size</span></span>
<span><span class="co">#&gt; 1       4 1992               74</span></span>
<span><span class="co">#&gt; 2       4 1997                2</span></span>
<span><span class="co">#&gt; 3       6 1973               63</span></span>
<span><span class="co">#&gt; 4       6 1983               73</span></span>
<span><span class="co">#&gt; 5       7 1991               81</span></span>
<span><span class="co">#&gt; 6       7 1998                1</span></span>
<span><span class="co"># summary(msets.none)</span></span>
<span><span class="co"># summary(msets.maha)</span></span></code></pre></div>
<p><strong>Visualizing Matched Sets with the plot method</strong></p>
<ul>
<li><p>Users can visualize the distribution of the matched set sizes.</p></li>
<li><p>A red line, by default, indicates the count of matched sets where treated units had no matching control units (i.e., empty matched sets).</p></li>
<li><p>Plot adjustments can be made using <strong><code><a href="https://rdrr.io/r/graphics/plot.default.html">graphics::plot</a></code></strong>.</p></li>
</ul>
<div class="sourceCode" id="cb443"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">msets.none</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-21-1.png" width="90%" style="display: block; margin: auto;"></div>
<p><strong>Comparing Methods of Refinement</strong></p>
<ul>
<li>
<p>Users are encouraged to:</p>
<ul>
<li><p>Use substantive knowledge for experimentation and evaluation.</p></li>
<li>
<p>Consider the following when configuring <code>PanelMatch</code>:</p>
<ol style="list-style-type: decimal">
<li><p>The number of matched sets.</p></li>
<li><p>The number of controls matched to each treated unit.</p></li>
<li><p>Achieving covariate balance.</p></li>
</ol>
</li>
<li><p><strong>Note</strong>: Large numbers of small matched sets can lead to larger standard errors during the estimation stage.</p></li>
<li><p>Covariates that aren’t well balanced can lead to undesirable comparisons between treated and control units.</p></li>
<li>
<p>Aspects to consider include:</p>
<ul>
<li><p>Refinement method.</p></li>
<li><p>Variables for weight calculation.</p></li>
<li><p>Size of the lag window.</p></li>
<li><p>Procedures for addressing missing data (refer to <strong><code>match.missing</code></strong> and <strong><code>listwise.delete</code></strong> arguments).</p></li>
<li><p>Maximum size of matched sets (for matching methods).</p></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Supportive Features:</strong></p>
<ul>
<li><p><strong><code>print</code></strong>, <strong><code>plot</code></strong>, and <strong><code>summary</code></strong> methods assist in understanding matched sets and their sizes.</p></li>
<li>
<p><strong><code>get_covariate_balance</code></strong> helps evaluate covariate balance:</p>
<ul>
<li>Lower values in the covariate balance calculations are preferred.</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb444"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PM.results.none</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        time.id <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>        treatment <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        refinement.method <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>        data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>        match.missing <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        size.match <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi <span class="op">=</span> <span class="st">"att"</span>,</span>
<span>        outcome.var <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        use.diagonal.variance.matrix <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span><span class="va">PM.results.maha</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        time.id <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>        treatment <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        refinement.method <span class="op">=</span> <span class="st">"mahalanobis"</span>,</span>
<span>        data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>        match.missing <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        covs.formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">tradewb</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        size.match <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi <span class="op">=</span> <span class="st">"att"</span>,</span>
<span>        outcome.var <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        use.diagonal.variance.matrix <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># listwise deletion used for missing data</span></span>
<span><span class="va">PM.results.listwise</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        time.id <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>        treatment <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        refinement.method <span class="op">=</span> <span class="st">"mahalanobis"</span>,</span>
<span>        data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>        match.missing <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        listwise.delete <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        covs.formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">tradewb</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        size.match <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi <span class="op">=</span> <span class="st">"att"</span>,</span>
<span>        outcome.var <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        use.diagonal.variance.matrix <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># propensity score based weighting method</span></span>
<span><span class="va">PM.results.ps.weight</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        time.id <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>        treatment <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        refinement.method <span class="op">=</span> <span class="st">"ps.weight"</span>,</span>
<span>        data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>        match.missing <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        listwise.delete <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        covs.formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">tradewb</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        size.match <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi <span class="op">=</span> <span class="st">"att"</span>,</span>
<span>        outcome.var <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/get_covariate_balance.html">get_covariate_balance</a></span><span class="op">(</span></span>
<span>    <span class="va">PM.results.none</span><span class="op">$</span><span class="va">att</span>,</span>
<span>    data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tradewb"</span>, <span class="st">"y"</span><span class="op">)</span>,</span>
<span>    plot <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;         tradewb            y</span></span>
<span><span class="co">#&gt; t_4 -0.07245466  0.291871990</span></span>
<span><span class="co">#&gt; t_3 -0.20930129  0.208654876</span></span>
<span><span class="co">#&gt; t_2 -0.24425207  0.107736647</span></span>
<span><span class="co">#&gt; t_1 -0.10806125 -0.004950238</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/get_covariate_balance.html">get_covariate_balance</a></span><span class="op">(</span></span>
<span>    <span class="va">PM.results.maha</span><span class="op">$</span><span class="va">att</span>,</span>
<span>    data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tradewb"</span>, <span class="st">"y"</span><span class="op">)</span>,</span>
<span>    plot <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;         tradewb          y</span></span>
<span><span class="co">#&gt; t_4  0.04558637 0.09701606</span></span>
<span><span class="co">#&gt; t_3 -0.03312750 0.10844046</span></span>
<span><span class="co">#&gt; t_2 -0.01396793 0.08890753</span></span>
<span><span class="co">#&gt; t_1  0.10474894 0.06618865</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/get_covariate_balance.html">get_covariate_balance</a></span><span class="op">(</span></span>
<span>    <span class="va">PM.results.listwise</span><span class="op">$</span><span class="va">att</span>,</span>
<span>    data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tradewb"</span>, <span class="st">"y"</span><span class="op">)</span>,</span>
<span>    plot <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;         tradewb          y</span></span>
<span><span class="co">#&gt; t_4  0.05634922 0.05223623</span></span>
<span><span class="co">#&gt; t_3 -0.01104797 0.05217896</span></span>
<span><span class="co">#&gt; t_2  0.01411473 0.03094133</span></span>
<span><span class="co">#&gt; t_1  0.06850180 0.02092209</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/get_covariate_balance.html">get_covariate_balance</a></span><span class="op">(</span></span>
<span>    <span class="va">PM.results.ps.weight</span><span class="op">$</span><span class="va">att</span>,</span>
<span>    data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tradewb"</span>, <span class="st">"y"</span><span class="op">)</span>,</span>
<span>    plot <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;         tradewb          y</span></span>
<span><span class="co">#&gt; t_4 0.014362590 0.04035905</span></span>
<span><span class="co">#&gt; t_3 0.005529734 0.04188731</span></span>
<span><span class="co">#&gt; t_2 0.009410044 0.04195008</span></span>
<span><span class="co">#&gt; t_1 0.027907540 0.03975173</span></span></code></pre></div>
<p><strong>get_covariate_balance Function Options:</strong></p>
<ul>
<li><p>Allows for the generation of plots displaying covariate balance using <strong><code>plot = TRUE</code></strong>.</p></li>
<li><p>Plots can be customized using arguments typically used with the base R <strong><code>plot</code></strong> method.</p></li>
<li>
<p>Option to set <strong><code>use.equal.weights = TRUE</code></strong> for:</p>
<ul>
<li><p>Obtaining the balance of unrefined sets.</p></li>
<li><p>Facilitating understanding of the refinement’s impact.</p></li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb445"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use equal weights</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/get_covariate_balance.html">get_covariate_balance</a></span><span class="op">(</span></span>
<span>    <span class="va">PM.results.ps.weight</span><span class="op">$</span><span class="va">att</span>,</span>
<span>    data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    use.equal.weights <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tradewb"</span>, <span class="st">"y"</span><span class="op">)</span>,</span>
<span>    plot <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    <span class="co"># visualize by setting plot to TRUE</span></span>
<span>    ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-23-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb446"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Compare covariate balance to refined sets</span></span>
<span><span class="co"># See large improvement in balance</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/get_covariate_balance.html">get_covariate_balance</a></span><span class="op">(</span></span>
<span>    <span class="va">PM.results.ps.weight</span><span class="op">$</span><span class="va">att</span>,</span>
<span>    data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tradewb"</span>, <span class="st">"y"</span><span class="op">)</span>,</span>
<span>    plot <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    <span class="co"># visualize by setting plot to TRUE</span></span>
<span>    ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-23-2.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb447"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/balance_scatter.html">balance_scatter</a></span><span class="op">(</span></span>
<span>    matched_set_list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">PM.results.maha</span><span class="op">$</span><span class="va">att</span>,</span>
<span>                            <span class="va">PM.results.ps.weight</span><span class="op">$</span><span class="va">att</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="st">"tradewb"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-23-3.png" width="90%" style="display: block; margin: auto;"></div>
<p><strong><code>PanelEstimate</code></strong></p>
<ul>
<li>
<p><strong>Standard Error Calculation Methods</strong></p>
<ul>
<li>
<p>There are different methods available:</p>
<ul>
<li><p><strong>Bootstrap</strong> (default method with 1000 iterations).</p></li>
<li><p><strong>Conditional</strong>: Assumes independence across units, but not time.</p></li>
<li><p><strong>Unconditional</strong>: Doesn’t make assumptions of independence across units or time.</p></li>
</ul>
</li>
<li>
<p>For <strong><code>qoi</code></strong> values set to <code>att</code>, <code>art</code>, or <code>atc</code> <span class="citation">(<a href="references.html#ref-imai2021matching">Imai, Kim, and Wang 2021</a>)</span>:</p>
<ul>
<li>You can use analytical methods for calculating standard errors, which include both “conditional” and “unconditional” methods.</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb448"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PE.results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelEstimate.html">PanelEstimate</a></span><span class="op">(</span></span>
<span>    sets              <span class="op">=</span> <span class="va">PM.results.ps.weight</span>,</span>
<span>    data              <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    se.method         <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>    number.iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    confidence.level  <span class="op">=</span> <span class="fl">.95</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># point estimates</span></span>
<span><span class="va">PE.results</span><span class="op">[[</span><span class="st">"estimates"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt;       t+0       t+1       t+2       t+3       t+4 </span></span>
<span><span class="co">#&gt; 0.2609565 0.9630847 1.2851017 1.7370930 1.4871846</span></span>
<span></span>
<span><span class="co"># standard errors</span></span>
<span><span class="va">PE.results</span><span class="op">[[</span><span class="st">"standard.error"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt;       t+0       t+1       t+2       t+3       t+4 </span></span>
<span><span class="co">#&gt; 0.6399349 1.0304938 1.3825265 1.7625951 2.1672629</span></span>
<span></span>
<span></span>
<span><span class="co"># use conditional method</span></span>
<span><span class="va">PE.results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelEstimate.html">PanelEstimate</a></span><span class="op">(</span></span>
<span>    sets             <span class="op">=</span> <span class="va">PM.results.ps.weight</span>,</span>
<span>    data             <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    se.method        <span class="op">=</span> <span class="st">"conditional"</span>,</span>
<span>    confidence.level <span class="op">=</span> <span class="fl">.95</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># point estimates</span></span>
<span><span class="va">PE.results</span><span class="op">[[</span><span class="st">"estimates"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt;       t+0       t+1       t+2       t+3       t+4 </span></span>
<span><span class="co">#&gt; 0.2609565 0.9630847 1.2851017 1.7370930 1.4871846</span></span>
<span></span>
<span><span class="co"># standard errors</span></span>
<span><span class="va">PE.results</span><span class="op">[[</span><span class="st">"standard.error"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt;       t+0       t+1       t+2       t+3       t+4 </span></span>
<span><span class="co">#&gt; 0.4844805 0.8170604 1.1171942 1.4116879 1.7172143</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">PE.results</span><span class="op">)</span></span>
<span><span class="co">#&gt; Weighted Difference-in-Differences with Propensity Score</span></span>
<span><span class="co">#&gt; Matches created with 4 lags</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Standard errors computed with conditional  method</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate of Average Treatment Effect on the Treated (ATT) by Period:</span></span>
<span><span class="co">#&gt; $summary</span></span>
<span><span class="co">#&gt;      estimate std.error       2.5%    97.5%</span></span>
<span><span class="co">#&gt; t+0 0.2609565 0.4844805 -0.6886078 1.210521</span></span>
<span><span class="co">#&gt; t+1 0.9630847 0.8170604 -0.6383243 2.564494</span></span>
<span><span class="co">#&gt; t+2 1.2851017 1.1171942 -0.9045586 3.474762</span></span>
<span><span class="co">#&gt; t+3 1.7370930 1.4116879 -1.0297644 4.503950</span></span>
<span><span class="co">#&gt; t+4 1.4871846 1.7172143 -1.8784937 4.852863</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $lag</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $qoi</span></span>
<span><span class="co">#&gt; [1] "att"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">PE.results</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-24-1.png" width="90%" style="display: block; margin: auto;"></div>
<p><strong>Moderating Variables</strong></p>
<div class="sourceCode" id="cb449"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># moderating variable</span></span>
<span><span class="va">dem</span><span class="op">$</span><span class="va">moderator</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">dem</span><span class="op">$</span><span class="va">moderator</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dem</span><span class="op">$</span><span class="va">wbcode2</span> <span class="op">&gt;</span> <span class="fl">100</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">PM.results</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag                          <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        time.id                      <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        unit.id                      <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>        treatment                    <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        refinement.method            <span class="op">=</span> <span class="st">"mahalanobis"</span>,</span>
<span>        data                         <span class="op">=</span> <span class="va">dem</span>,</span>
<span>        match.missing                <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        covs.formula                 <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">tradewb</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        size.match                   <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        qoi                          <span class="op">=</span> <span class="st">"att"</span>,</span>
<span>        outcome.var                  <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        lead                         <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal    <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        use.diagonal.variance.matrix <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span><span class="va">PE.results</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelEstimate.html">PanelEstimate</a></span><span class="op">(</span>sets      <span class="op">=</span> <span class="va">PM.results</span>,</span>
<span>                  data      <span class="op">=</span> <span class="va">dem</span>,</span>
<span>                  moderator <span class="op">=</span> <span class="st">"moderator"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Each element in the list corresponds to a level in the moderator</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">PE.results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-25-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb450"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">PE.results</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-25-2.png" width="90%" style="display: block; margin: auto;"></div>
<p>To write up for journal submission, you can follow the following report:</p>
<p>In this study, closely aligned with the research by <span class="citation">(<a href="references.html#ref-acemoglu2019democracy">Acemoglu et al. 2019</a>)</span>, two key effects of democracy on economic growth are estimated: the impact of democratization and that of authoritarian reversal. The treatment variable, <span class="math inline">\(X_{it}\)</span>, is defined to be one if country <span class="math inline">\(i\)</span> is democratic in year <span class="math inline">\(t\)</span>, and zero otherwise.</p>
<p>The Average Treatment Effect for the Treated (ATT) under democratization is formulated as follows:</p>
<p><span class="math display">\[
\begin{aligned}
\delta(F, L) &amp;= \mathbb{E} \left\{ Y_{i, t + F} (X_{it} = 1, X_{i, t - 1} = 0, \{X_{i,t-l}\}_{l=2}^L) \right. \\
&amp;\left. - Y_{i, t + F} (X_{it} = 0, X_{i, t - 1} = 0, \{X_{i,t-l}\}_{l=2}^L) | X_{it} = 1, X_{i, t - 1} = 0 \right\}
\end{aligned}
\]</span></p>
<p>In this framework, the treated observations are countries that transition from an authoritarian regime <span class="math inline">\(X_{it-1} = 0\)</span> to a democratic one <span class="math inline">\(X_{it} = 1\)</span>. The variable <span class="math inline">\(F\)</span> represents the number of leads, denoting the time periods following the treatment, and <span class="math inline">\(L\)</span> signifies the number of lags, indicating the time periods preceding the treatment.</p>
<p>The ATT under authoritarian reversal is given by:</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\mathbb{E} \left[ Y_{i, t + F} (X_{it} = 0, X_{i, t - 1} = 1, \{ X_{i, t - l}\}_{l=2}^L ) \right. \\
&amp;\left. - Y_{i, t + F} (X_{it} = 1, X_{it-1} = 1, \{X_{i, t - l} \}_{l=2}^L ) | X_{it} = 0, X_{i, t - 1} = 1 \right]
\end{aligned}
\]</span></p>
<p>The ATT is calculated conditioning on 4 years of lags (<span class="math inline">\(L = 4\)</span>) and up to 4 years following the policy change <span class="math inline">\(F = 1, 2, 3, 4\)</span>. Matched sets for each treated observation are constructed based on its treatment history, with the number of matched control units generally decreasing when considering a 4-year treatment history as compared to a 1-year history.</p>
<p>To enhance the quality of matched sets, methods such as Mahalanobis distance matching, propensity score matching, and propensity score weighting are utilized. These approaches enable us to evaluate the effectiveness of each refinement method. In the process of matching, we employ both up-to-five and up-to-ten matching to investigate how sensitive our empirical results are to the maximum number of allowed matches. For more information on the refinement process, please see the Web Appendix</p>
<blockquote>
<p>The Mahalanobis distance is expressed through a specific formula. We aim to pair each treated unit with a maximum of <span class="math inline">\(J\)</span> control units, permitting replacement, denoted as <span class="math inline">\(| \mathcal{M}_{it} \le J|\)</span>. The average Mahalanobis distance between a treated and each control unit over time is computed as:</p>
<p><span class="math display">\[ S_{it} (i') = \frac{1}{L} \sum_{l = 1}^L \sqrt{(\mathbf{V}_{i, t - l} - \mathbf{V}_{i', t -l})^T \mathbf{\Sigma}_{i, t - l}^{-1} (\mathbf{V}_{i, t - l} - \mathbf{V}_{i', t -l})} \]</span></p>
<p>For a matched control unit <span class="math inline">\(i' \in \mathcal{M}_{it}\)</span>, <span class="math inline">\(\mathbf{V}_{it'}\)</span> represents the time-varying covariates to adjust for, and <span class="math inline">\(\mathbf{\Sigma}_{it'}\)</span> is the sample covariance matrix for <span class="math inline">\(\mathbf{V}_{it'}\)</span>. Essentially, we calculate a standardized distance using time-varying covariates and average this across different time intervals.</p>
<p>In the context of propensity score matching, we employ a logistic regression model with balanced covariates to derive the propensity score. Defined as the conditional likelihood of treatment given pre-treatment covariates <span class="citation">(<a href="references.html#ref-rosenbaum1983central">Rosenbaum and Rubin 1983</a>)</span>, the propensity score is estimated by first creating a data subset comprised of all treated and their matched control units from the same year. This logistic regression model is then fitted as follows:</p>
<p><span class="math display">\[ \begin{aligned} &amp; e_{it} (\{\mathbf{U}_{i, t - l} \}^L_{l = 1}) \\ &amp;= Pr(X_{it} = 1| \mathbf{U}_{i, t -1}, \ldots, \mathbf{U}_{i, t - L}) \\ &amp;= \frac{1}{1 = \exp(- \sum_{l = 1}^L \beta_l^T \mathbf{U}_{i, t - l})} \end{aligned} \]</span></p>
<p>where <span class="math inline">\(\mathbf{U}_{it'} = (X_{it'}, \mathbf{V}_{it'}^T)^T\)</span>. Given this model, the estimated propensity score for all treated and matched control units is then computed. This enables the adjustment for lagged covariates via matching on the calculated propensity score, resulting in the following distance measure:</p>
<p><span class="math display">\[ S_{it} (i') = | \text{logit} \{ \hat{e}_{it} (\{ \mathbf{U}_{i, t - l}\}^L_{l = 1})\} - \text{logit} \{ \hat{e}_{i't}( \{ \mathbf{U}_{i', t - l} \}^L_{l = 1})\} | \]</span></p>
<p>Here, <span class="math inline">\(\hat{e}_{i't} (\{ \mathbf{U}_{i, t - l}\}^L_{l = 1})\)</span> represents the estimated propensity score for each matched control unit <span class="math inline">\(i' \in \mathcal{M}_{it}\)</span>.</p>
<p>Once the distance measure <span class="math inline">\(S_{it} (i')\)</span> has been determined for all control units in the original matched set, we fine-tune this set by selecting up to <span class="math inline">\(J\)</span> closest control units, which meet a researcher-defined caliper constraint <span class="math inline">\(C\)</span>. All other control units receive zero weight. This results in a refined matched set for each treated unit <span class="math inline">\((i, t)\)</span>:</p>
<p><span class="math display">\[ \mathcal{M}_{it}^* = \{i' : i' \in \mathcal{M}_{it}, S_{it} (i') &lt; C, S_{it} \le S_{it}^{(J)}\} \]</span></p>
<p><span class="math inline">\(S_{it}^{(J)}\)</span> is the <span class="math inline">\(J\)</span>th smallest distance among the control units in the original set <span class="math inline">\(\mathcal{M}_{it}\)</span>.</p>
<p>For further refinement using weighting, a weight is assigned to each control unit <span class="math inline">\(i'\)</span> in a matched set corresponding to a treated unit <span class="math inline">\((i, t)\)</span>, with greater weight accorded to more similar units. We utilize inverse propensity score weighting, based on the propensity score model mentioned earlier:</p>
<p><span class="math display">\[ w_{it}^{i'} \propto \frac{\hat{e}_{i't} (\{ \mathbf{U}_{i, t-l} \}^L_{l = 1} )}{1 - \hat{e}_{i't} (\{ \mathbf{U}_{i, t-l} \}^L_{l = 1} )} \]</span></p>
<p>In this model, <span class="math inline">\(\sum_{i' \in \mathcal{M}_{it}} w_{it}^{i'} = 1\)</span> and <span class="math inline">\(w_{it}^{i'} = 0\)</span> for <span class="math inline">\(i' \notin \mathcal{M}_{it}\)</span>. The model is fitted to the complete sample of treated and matched control units.</p>
</blockquote>
<blockquote>
<p>Checking Covariate Balance A distinct advantage of the proposed methodology over regression methods is the ability it offers researchers to inspect the covariate balance between treated and matched control observations. This facilitates the evaluation of whether treated and matched control observations are comparable regarding observed confounders. To investigate the mean difference of each covariate (e.g., <span class="math inline">\(V_{it'j}\)</span>, representing the <span class="math inline">\(j\)</span>-th variable in <span class="math inline">\(\mathbf{V}_{it'}\)</span>) between the treated observation and its matched control observation at each pre-treatment time period (i.e., <span class="math inline">\(t' &lt; t\)</span>), we further standardize this difference. For any given pretreatment time period, we adjust by the standard deviation of each covariate across all treated observations in the dataset. Thus, the mean difference is quantified in terms of standard deviation units. Formally, for each treated observation <span class="math inline">\((i,t)\)</span> where <span class="math inline">\(D_{it} = 1\)</span>, we define the covariate balance for variable <span class="math inline">\(j\)</span> at the pretreatment time period <span class="math inline">\(t - l\)</span> as: <span class="math display">\[\begin{equation}
B_{it}(j, l) = \frac{V_{i, t- l,j}- \sum_{i' \in \mathcal{M}_{it}}w_{it}^{i'}V_{i', t-l,j}}{\sqrt{\frac{1}{N_1 - 1} \sum_{i'=1}^N \sum_{t' = L+1}^{T-F}D_{i't'}(V_{i', t'-l, j} - \bar{V}_{t' - l, j})^2}}
\label{eq:covbalance}
\end{equation}\]</span> where <span class="math inline">\(N_1 = \sum_{i'= 1}^N \sum_{t' = L+1}^{T-F} D_{i't'}\)</span> denotes the total number of treated observations and <span class="math inline">\(\bar{V}_{t-l,j} = \sum_{i=1}^N D_{i,t-l,j}/N\)</span>. We then aggregate this covariate balance measure across all treated observations for each covariate and pre-treatment time period: <span class="math display">\[\begin{equation}
\bar{B}(j, l) = \frac{1}{N_1} \sum_{i=1}^N \sum_{t = L+ 1}^{T-F}D_{it} B_{it}(j,l)
\label{eq:aggbalance}
\end{equation}\]</span> Lastly, we evaluate the balance of lagged outcome variables over several pre-treatment periods and that of time-varying covariates. This examination aids in assessing the validity of the parallel trend assumption integral to the DiD estimator justification.</p>
</blockquote>
<p>In Figure <a href="#fig:balancescatter"><strong>??</strong></a>, we demonstrate the enhancement of covariate balance thank to the refinement of matched sets. Each scatter plot contrasts the absolute standardized mean difference, as detailed in Equation <a href="#eq:aggbalance">(<strong>??</strong>)</a>, before (horizontal axis) and after (vertical axis) this refinement. Points below the 45-degree line indicate an improved standardized mean balance for certain time-varying covariates post-refinement. The majority of variables benefit from this refinement process. Notably, the propensity score weighting (bottom panel) shows the most significant improvement, whereas Mahalanobis matching (top panel) yields a more modest improvement.</p>
<div class="sourceCode" id="cb451"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">PanelMatch</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">causalverse</span><span class="op">)</span></span>
<span></span>
<span><span class="va">runPanelMatch</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">method</span>, <span class="va">lag</span>, <span class="va">size.match</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">qoi</span><span class="op">=</span><span class="st">"att"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># Default parameters for PanelMatch</span></span>
<span>    <span class="va">common.args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        lag <span class="op">=</span> <span class="va">lag</span>,</span>
<span>        time.id <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        unit.id <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>        treatment <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>        covs.formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">tradewb</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        qoi <span class="op">=</span> <span class="va">qoi</span>,</span>
<span>        outcome.var <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        lead <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        size.match <span class="op">=</span> <span class="va">size.match</span>  <span class="co"># setting size.match here for all methods</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"mahalanobis"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">refinement.method</span> <span class="op">&lt;-</span> <span class="st">"mahalanobis"</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">match.missing</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">use.diagonal.variance.matrix</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"ps.match"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">refinement.method</span> <span class="op">&lt;-</span> <span class="st">"ps.match"</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">match.missing</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">listwise.delete</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"ps.weight"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">refinement.method</span> <span class="op">&lt;-</span> <span class="st">"ps.weight"</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">match.missing</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>        <span class="va">common.args</span><span class="op">$</span><span class="va">listwise.delete</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">PanelMatch</span>, <span class="va">common.args</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mahalanobis"</span>, <span class="st">"ps.match"</span>, <span class="st">"ps.weight"</span><span class="op">)</span></span>
<span><span class="va">lags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>You can either do it sequentailly</p>
<div class="sourceCode" id="cb452"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_pm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">method</span> <span class="kw">in</span> <span class="va">methods</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">lag</span> <span class="kw">in</span> <span class="va">lags</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">for</span><span class="op">(</span><span class="va">size</span> <span class="kw">in</span> <span class="va">sizes</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">method</span>, <span class="st">"."</span>, <span class="va">lag</span>, <span class="st">"lag."</span>, <span class="va">size</span>, <span class="st">"m"</span><span class="op">)</span></span>
<span>            <span class="va">res_pm</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">runPanelMatch</span><span class="op">(</span><span class="va">method</span>, <span class="va">lag</span>, <span class="va">size</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Now, you can access res_pm using res_pm[["mahalanobis.1lag.5m"]] etc.</span></span>
<span></span>
<span><span class="co"># for treatment reversal</span></span>
<span><span class="va">res_pm_rev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">method</span> <span class="kw">in</span> <span class="va">methods</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">lag</span> <span class="kw">in</span> <span class="va">lags</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">for</span><span class="op">(</span><span class="va">size</span> <span class="kw">in</span> <span class="va">sizes</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">method</span>, <span class="st">"."</span>, <span class="va">lag</span>, <span class="st">"lag."</span>, <span class="va">size</span>, <span class="st">"m"</span><span class="op">)</span></span>
<span>            <span class="va">res_pm_rev</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">runPanelMatch</span><span class="op">(</span><span class="va">method</span>, <span class="va">lag</span>, <span class="va">size</span>, qoi <span class="op">=</span> <span class="st">"art"</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>or in parallel</p>
<div class="sourceCode" id="cb453"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach">foreach</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel">doParallel</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co"># Initialize an empty list to store results</span></span>
<span><span class="va">res_pm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Replace nested for-loops with foreach</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="va">methods</span>,</span>
<span>    .combine <span class="op">=</span> <span class="st">'c'</span>,</span>
<span>    .multicombine <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PanelMatch"</span>, <span class="st">"causalverse"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span></span>
<span>    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">lag</span> <span class="kw">in</span> <span class="va">lags</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">size</span> <span class="kw">in</span> <span class="va">sizes</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">method</span>, <span class="st">"."</span>, <span class="va">lag</span>, <span class="st">"lag."</span>, <span class="va">size</span>, <span class="st">"m"</span><span class="op">)</span></span>
<span>        <span class="va">tmp</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">runPanelMatch</span><span class="op">(</span><span class="va">method</span>, <span class="va">lag</span>, <span class="va">size</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">tmp</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="co"># Collate results</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">name</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res_pm</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Treatment reversal</span></span>
<span><span class="co"># Initialize an empty list to store results</span></span>
<span><span class="va">res_pm_rev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Replace nested for-loops with foreach</span></span>
<span><span class="va">results_rev</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="va">methods</span>,</span>
<span>    .combine <span class="op">=</span> <span class="st">'c'</span>,</span>
<span>    .multicombine <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PanelMatch"</span>, <span class="st">"causalverse"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span></span>
<span>    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">lag</span> <span class="kw">in</span> <span class="va">lags</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">size</span> <span class="kw">in</span> <span class="va">sizes</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">method</span>, <span class="st">"."</span>, <span class="va">lag</span>, <span class="st">"lag."</span>, <span class="va">size</span>, <span class="st">"m"</span><span class="op">)</span></span>
<span>        <span class="va">tmp</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>          <span class="fu">runPanelMatch</span><span class="op">(</span><span class="va">method</span>, <span class="va">lag</span>, <span class="va">size</span>, qoi <span class="op">=</span> <span class="st">"art"</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">tmp</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="co"># Collate results</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">name</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">results_rev</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res_pm_rev</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">results_rev</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">stopImplicitCluster</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb454"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Updated plotting function</span></span>
<span><span class="va">create_balance_plot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">method</span>, <span class="va">lag</span>, <span class="va">sizes</span>, <span class="va">res_pm</span>, <span class="va">dem</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">matched_set_lists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">sizes</span>, <span class="kw">function</span><span class="op">(</span><span class="va">size</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">res_pm</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">method</span>, <span class="st">"."</span>, <span class="va">lag</span>, <span class="st">"lag."</span>, <span class="va">size</span>, <span class="st">"m"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">att</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/balance_scatter_custom.html">balance_scatter_custom</a></span><span class="op">(</span></span>
<span>            matched_set_list <span class="op">=</span> <span class="va">matched_set_lists</span>,</span>
<span>            legend.title <span class="op">=</span> <span class="st">"Possible Matches"</span>,</span>
<span>            set.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">sizes</span><span class="op">)</span>,</span>
<span>            legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.8</span><span class="op">)</span>,</span>
<span>            </span>
<span>            <span class="co"># for compiled plot, you don't need x,y, or main labs</span></span>
<span>            x.axis.label <span class="op">=</span> <span class="st">""</span>,</span>
<span>            y.axis.label <span class="op">=</span> <span class="st">""</span>,</span>
<span>            main <span class="op">=</span> <span class="st">""</span>,</span>
<span>            data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>            dot.size <span class="op">=</span> <span class="fl">5</span>,</span>
<span>            <span class="co"># show.legend = F,</span></span>
<span>            them_use <span class="op">=</span> <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">32</span><span class="op">)</span>,</span>
<span>            covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="st">"tradewb"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">method</span> <span class="kw">in</span> <span class="va">methods</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">lag</span> <span class="kw">in</span> <span class="va">lags</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">plots</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">method</span>, <span class="st">"."</span>, <span class="va">lag</span>, <span class="st">"lag"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>            <span class="fu">create_balance_plot</span><span class="op">(</span><span class="va">method</span>, <span class="va">lag</span>, <span class="va">sizes</span>, <span class="va">res_pm</span>, <span class="va">dem</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># # Arranging plots in a 3x2 grid</span></span>
<span><span class="co"># grid.arrange(plots[["mahalanobis.1lag"]],</span></span>
<span><span class="co">#              plots[["mahalanobis.4lag"]],</span></span>
<span><span class="co">#              plots[["ps.match.1lag"]],</span></span>
<span><span class="co">#              plots[["ps.match.4lag"]],</span></span>
<span><span class="co">#              plots[["ps.weight.1lag"]],</span></span>
<span><span class="co">#              plots[["ps.weight.4lag"]],</span></span>
<span><span class="co">#              ncol=2, nrow=3)</span></span>
<span></span>
<span></span>
<span><span class="co"># Standardized Mean Difference of Covariates</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create column and row labels using textGrob</span></span>
<span><span class="va">col_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1-year Lag"</span>, <span class="st">"4-year Lag"</span><span class="op">)</span></span>
<span><span class="va">row_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Maha Matching"</span>, <span class="st">"PS Matching"</span>, <span class="st">"PS Weigthing"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">major.axes.fontsize</span> <span class="op">=</span> <span class="fl">40</span></span>
<span><span class="va">minor.axes.fontsize</span> <span class="op">=</span> <span class="fl">30</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/png.html">png</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"images"</span>, <span class="st">"did_balance_scatter.png"</span><span class="op">)</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">1200</span>,</span>
<span>    height <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a list-of-lists, where each inner list represents a row</span></span>
<span><span class="va">grid_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.null.html">nullGrob</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span></span>
<span>        <span class="va">row_labels</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>        gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span>,</span>
<span>        rot <span class="op">=</span> <span class="fl">90</span></span>
<span>    <span class="op">)</span>, <span class="va">plots</span><span class="op">[[</span><span class="st">"mahalanobis.1lag"</span><span class="op">]</span><span class="op">]</span>, <span class="va">plots</span><span class="op">[[</span><span class="st">"mahalanobis.4lag"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span></span>
<span>        <span class="va">row_labels</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>        gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span>,</span>
<span>        rot <span class="op">=</span> <span class="fl">90</span></span>
<span>    <span class="op">)</span>, <span class="va">plots</span><span class="op">[[</span><span class="st">"ps.match.1lag"</span><span class="op">]</span><span class="op">]</span>, <span class="va">plots</span><span class="op">[[</span><span class="st">"ps.match.4lag"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span></span>
<span>        <span class="va">row_labels</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>        gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span>,</span>
<span>        rot <span class="op">=</span> <span class="fl">90</span></span>
<span>    <span class="op">)</span>, <span class="va">plots</span><span class="op">[[</span><span class="st">"ps.weight.1lag"</span><span class="op">]</span><span class="op">]</span>, <span class="va">plots</span><span class="op">[[</span><span class="st">"ps.weight.4lag"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># "Flatten" the list-of-lists into a single list of grobs</span></span>
<span><span class="va">grobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">c</span>, <span class="va">grid_list</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span></span>
<span>    grobs <span class="op">=</span> <span class="va">grobs</span>,</span>
<span>    ncol <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    nrow <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.42</span>, <span class="fl">0.42</span><span class="op">)</span>,</span>
<span>    heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.28</span>, <span class="fl">0.28</span>, <span class="fl">0.28</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span></span>
<span>    <span class="st">"Before Refinement"</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    y <span class="op">=</span> <span class="fl">0.03</span>,</span>
<span>    gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">major.axes.fontsize</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span></span>
<span>    <span class="st">"After Refinement"</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">0.03</span>,</span>
<span>    y <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    rot <span class="op">=</span> <span class="fl">90</span>,</span>
<span>    gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">major.axes.fontsize</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; png </span></span>
<span><span class="co">#&gt;   2</span></span></code></pre></div>
<p>Note: Scatter plots display the standardized mean difference of each covariate <span class="math inline">\(j\)</span> and lag year <span class="math inline">\(l\)</span> as defined in Equation <a href="#eq:aggbalance">(<strong>??</strong>)</a> before (x-axis) and after (y-axis) matched set refinement. Each plot includes varying numbers of possible matches for each matching method. Rows represent different matching/weighting methods, while columns indicate adjustments for various lag lengths.</p>
<div class="sourceCode" id="cb455"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Step 1: Define configurations</span></span>
<span><span class="va">configurations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"none"</span>, qoi <span class="op">=</span> <span class="st">"att"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"none"</span>, qoi <span class="op">=</span> <span class="st">"art"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"mahalanobis"</span>, qoi <span class="op">=</span> <span class="st">"att"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"mahalanobis"</span>, qoi <span class="op">=</span> <span class="st">"art"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"ps.match"</span>, qoi <span class="op">=</span> <span class="st">"att"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"ps.match"</span>, qoi <span class="op">=</span> <span class="st">"art"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"ps.weight"</span>, qoi <span class="op">=</span> <span class="st">"att"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>refinement.method <span class="op">=</span> <span class="st">"ps.weight"</span>, qoi <span class="op">=</span> <span class="st">"art"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 2: Use lapply or loop to generate results</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">configurations</span>, <span class="kw">function</span><span class="op">(</span><span class="va">config</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelMatch.html">PanelMatch</a></span><span class="op">(</span></span>
<span>        lag                       <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        time.id                   <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        unit.id                   <span class="op">=</span> <span class="st">"wbcode2"</span>,</span>
<span>        treatment                 <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        data                      <span class="op">=</span> <span class="va">dem</span>,</span>
<span>        match.missing             <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        listwise.delete           <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        size.match                <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        outcome.var               <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        lead                      <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>        forbid.treatment.reversal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        refinement.method         <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">refinement.method</span>,</span>
<span>        covs.formula              <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">tradewb</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        qoi                       <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">qoi</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 3: Get covariate balance and plot</span></span>
<span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">result</span>, <span class="va">config</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/get_covariate_balance.html">get_covariate_balance</a></span><span class="op">(</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">qoi</span> <span class="op">==</span> <span class="st">"att"</span><span class="op">)</span></span>
<span>            <span class="va">result</span><span class="op">$</span><span class="va">att</span></span>
<span>        <span class="kw">else</span></span>
<span>            <span class="va">result</span><span class="op">$</span><span class="va">art</span>,</span>
<span>        data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>        covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tradewb"</span>, <span class="st">"y"</span><span class="op">)</span>,</span>
<span>        plot <span class="op">=</span> <span class="cn">F</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/plot_covariate_balance_pretrend.html">plot_covariate_balance_pretrend</a></span><span class="op">(</span><span class="va">df</span>, main <span class="op">=</span> <span class="st">""</span>, show_legend <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="op">}</span>, <span class="va">results</span>, <span class="va">configurations</span>, SIMPLIFY <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set names for plots</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">plots</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">configurations</span>, <span class="kw">function</span><span class="op">(</span><span class="va">config</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">qoi</span>, <span class="va">config</span><span class="op">$</span><span class="va">refinement.method</span>, sep <span class="op">=</span> <span class="st">"."</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>To export</p>
<div class="sourceCode" id="cb456"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Column and row labels</span></span>
<span><span class="va">col_labels</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>,</span>
<span>      <span class="st">"Mahalanobis"</span>,</span>
<span>      <span class="st">"Propensity Score Matching"</span>,</span>
<span>      <span class="st">"Propensity Score Weighting"</span><span class="op">)</span></span>
<span><span class="va">row_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ATT"</span>, <span class="st">"ART"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify your desired fontsize for labels</span></span>
<span><span class="va">minor.axes.fontsize</span> <span class="op">&lt;-</span> <span class="fl">16</span></span>
<span><span class="va">major.axes.fontsize</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/png.html">png</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"images"</span>, <span class="st">"p_covariate_balance.png"</span><span class="op">)</span>, width<span class="op">=</span><span class="fl">1200</span>, height<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a list-of-lists, where each inner list represents a row</span></span>
<span><span class="va">grid_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.null.html">nullGrob</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span></span>
<span>            <span class="va">row_labels</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>            gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span>,</span>
<span>            rot <span class="op">=</span> <span class="fl">90</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">att.none</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">att.mahalanobis</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">att.ps.match</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">att.ps.weight</span></span>
<span>    <span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span></span>
<span>            <span class="va">row_labels</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>            gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span>,</span>
<span>            rot <span class="op">=</span> <span class="fl">90</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">art.none</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">art.mahalanobis</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">art.ps.match</span>,</span>
<span>        <span class="va">plots</span><span class="op">$</span><span class="va">art.ps.weight</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># "Flatten" the list-of-lists into a single list of grobs</span></span>
<span><span class="va">grobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">c</span>, <span class="va">grid_list</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Arrange your plots with text labels</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span></span>
<span>    grobs   <span class="op">=</span> <span class="va">grobs</span>,</span>
<span>    ncol    <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    nrow    <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    widths  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.225</span>, <span class="fl">0.225</span>, <span class="fl">0.225</span>, <span class="fl">0.225</span><span class="op">)</span>,</span>
<span>    heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.45</span>, <span class="fl">0.45</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add main x and y axis titles</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span></span>
<span>    <span class="st">"Refinement Methods"</span>,</span>
<span>    x  <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    y  <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>    gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">major.axes.fontsize</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span></span>
<span>    <span class="st">"Quantities of Interest"</span>,</span>
<span>    x   <span class="op">=</span> <span class="fl">0.02</span>,</span>
<span>    y   <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    rot <span class="op">=</span> <span class="fl">90</span>,</span>
<span>    gp  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">major.axes.fontsize</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb457"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html">include_graphics</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"images"</span>, <span class="st">"p_covariate_balance.png"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="images/p_covariate_balance.png" width="90%" style="display: block; margin: auto;"></div>
<p>Note: Each graph displays the standardized mean difference, as outlined in Equation <a href="#eq:aggbalance">(<strong>??</strong>)</a>, plotted on the vertical axis across a pre-treatment duration of four years represented on the horizontal axis. The leftmost column illustrates the balance prior to refinement, while the subsequent three columns depict the covariate balance post the application of distinct refinement techniques. Each individual line signifies the balance of a specific variable during the pre-treatment phase.The red line is tradewb and blue line is the lagged outcome variable.</p>
<p>In Figure <a href="#fig:balancepretreat"><strong>??</strong></a>, we observe a marked improvement in covariate balance due to the implemented matching procedures during the pre-treatment period. Our analysis prioritizes methods that adjust for time-varying covariates over a span of four years preceding the treatment initiation. The two rows delineate the standardized mean balance for both treatment modalities, with individual lines representing the balance for each covariate.</p>
<p>Across all scenarios, the refinement attributed to matched sets significantly enhances balance. Notably, using propensity score weighting considerably mitigates imbalances in confounders. While some degree of imbalance remains evident in the Mahalanobis distance and propensity score matching techniques, the standardized mean difference for the lagged outcome remains stable throughout the pre-treatment phase. This consistency lends credence to the validity of the proposed DiD estimator.</p>
<p><strong>Estimation Results</strong></p>
<p>We now detail the estimated ATTs derived from the matching techniques. Figure below offers visual representations of the impacts of treatment initiation (upper panel) and treatment reversal (lower panel) on the outcome variable for a duration of 5 years post-transition, specifically, (F = 0, 1, …, 4). Across the five methods (columns), it becomes evident that the point estimates of effects associated with treatment initiation consistently approximate zero over the 5-year window. In contrast, the estimated outcomes of treatment reversal are notably negative and maintain statistical significance through all refinement techniques during the initial year of transition and the 1 to 4 years that follow, provided treatment reversal is permissible. These effects are notably pronounced, pointing to an estimated reduction of roughly X% in the outcome variable.</p>
<p>Collectively, these findings indicate that the transition into the treated state from its absence doesn’t invariably lead to a heightened outcome. Instead, the transition from the treated state back to its absence exerts a considerable negative effect on the outcome variable in both the short and intermediate terms. Hence, the positive effect of the treatment (if we were to use traditional DiD) is actually driven by the negative effect of treatment reversal.</p>
<div class="sourceCode" id="cb458"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># sequential</span></span>
<span><span class="co"># Step 1: Apply PanelEstimate function</span></span>
<span></span>
<span><span class="co"># Initialize an empty list to store results</span></span>
<span><span class="va">res_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_pm</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Iterate over each element in res_pm</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_pm</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res_est</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelEstimate.html">PanelEstimate</a></span><span class="op">(</span></span>
<span>    <span class="va">res_pm</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    se.method <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>    number.iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    confidence.level <span class="op">=</span> <span class="fl">.95</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># Transfer the name of the current element to the res_est list</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_pm</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Step 2: Apply plot_PanelEstimate function</span></span>
<span></span>
<span><span class="co"># Initialize an empty list to store plot results</span></span>
<span><span class="va">res_est_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Iterate over each element in res_est</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">res_est_plot</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/plot_PanelEstimate.html">plot_PanelEstimate</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                           main <span class="op">=</span> <span class="st">""</span>,</span>
<span>                           theme_use <span class="op">=</span> <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co"># Transfer the name of the current element to the res_est_plot list</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_plot</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># check results</span></span>
<span><span class="co"># res_est_plot$mahalanobis.1lag.5m</span></span>
<span></span>
<span></span>
<span><span class="co"># Step 1: Apply PanelEstimate function for res_pm_rev</span></span>
<span></span>
<span><span class="co"># Initialize an empty list to store results</span></span>
<span><span class="va">res_est_rev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_pm_rev</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Iterate over each element in res_pm_rev</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_pm_rev</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res_est_rev</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelEstimate.html">PanelEstimate</a></span><span class="op">(</span></span>
<span>    <span class="va">res_pm_rev</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>    se.method <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>    number.iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    confidence.level <span class="op">=</span> <span class="fl">.95</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># Transfer the name of the current element to the res_est_rev list</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_pm_rev</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Step 2: Apply plot_PanelEstimate function for res_est_rev</span></span>
<span></span>
<span><span class="co"># Initialize an empty list to store plot results</span></span>
<span><span class="va">res_est_plot_rev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Iterate over each element in res_est_rev</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">res_est_plot_rev</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/plot_PanelEstimate.html">plot_PanelEstimate</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                           main <span class="op">=</span> <span class="st">""</span>,</span>
<span>                           theme_use <span class="op">=</span> <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Transfer the name of the current element to the res_est_plot_rev list</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_plot_rev</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb459"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># parallel</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel">doParallel</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach">foreach</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Detect the number of cores to use for parallel processing</span></span>
<span><span class="va">num_cores</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span></span>
<span><span class="co"># Register the parallel backend</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span><span class="op">(</span><span class="va">num_cores</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 1: Apply PanelEstimate function in parallel</span></span>
<span><span class="va">res_est</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_pm</span><span class="op">)</span>, .packages <span class="op">=</span> <span class="st">"PanelMatch"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelEstimate.html">PanelEstimate</a></span><span class="op">(</span></span>
<span>            <span class="va">res_pm</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>            data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>            se.method <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>            number.iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>            confidence.level <span class="op">=</span> <span class="fl">.95</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span><span class="co"># Transfer names from res_pm to res_est</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_pm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 2: Apply plot_PanelEstimate function in parallel</span></span>
<span><span class="va">res_est_plot</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span></span>
<span>        i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">)</span>,</span>
<span>        .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PanelMatch"</span>, <span class="st">"causalverse"</span>, <span class="st">"ggplot2"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/plot_PanelEstimate.html">plot_PanelEstimate</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                           main <span class="op">=</span> <span class="st">""</span>,</span>
<span>                           theme_use <span class="op">=</span> <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span><span class="co"># Transfer names from res_est to res_est_plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_plot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># Step 1: Apply PanelEstimate function for res_pm_rev in parallel</span></span>
<span><span class="va">res_est_rev</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_pm_rev</span><span class="op">)</span>, .packages <span class="op">=</span> <span class="st">"PanelMatch"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/PanelMatch/man/PanelEstimate.html">PanelEstimate</a></span><span class="op">(</span></span>
<span>            <span class="va">res_pm_rev</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>            data <span class="op">=</span> <span class="va">dem</span>,</span>
<span>            se.method <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>            number.iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>            confidence.level <span class="op">=</span> <span class="fl">.95</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span><span class="co"># Transfer names from res_pm_rev to res_est_rev</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_pm_rev</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 2: Apply plot_PanelEstimate function for res_est_rev in parallel</span></span>
<span><span class="va">res_est_plot_rev</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span></span>
<span>        i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">)</span>,</span>
<span>        .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PanelMatch"</span>, <span class="st">"causalverse"</span>, <span class="st">"ggplot2"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">%dopar%</a></span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/plot_PanelEstimate.html">plot_PanelEstimate</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                           main <span class="op">=</span> <span class="st">""</span>,</span>
<span>                           theme_use <span class="op">=</span> <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span><span class="co"># Transfer names from res_est_rev to res_est_plot_rev</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_plot_rev</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res_est_rev</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Stop the cluster</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>To export</p>
<div class="sourceCode" id="cb460"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Column and row labels</span></span>
<span><span class="va">col_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Mahalanobis 5m"</span>, </span>
<span>                <span class="st">"Mahalanobis 10m"</span>, </span>
<span>                <span class="st">"PS Matching 5m"</span>, </span>
<span>                <span class="st">"PS Matching 10m"</span>, </span>
<span>                <span class="st">"PS Weighting 5m"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">row_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ATT"</span>, <span class="st">"ART"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify your desired fontsize for labels</span></span>
<span><span class="va">minor.axes.fontsize</span> <span class="op">&lt;-</span> <span class="fl">16</span></span>
<span><span class="va">major.axes.fontsize</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/png.html">png</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"images"</span>, <span class="st">"p_did_est_in_n_out.png"</span><span class="op">)</span>, width<span class="op">=</span><span class="fl">1200</span>, height<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a list-of-lists, where each inner list represents a row</span></span>
<span><span class="va">grid_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.null.html">nullGrob</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">col_labels</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">row_labels</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span>, rot <span class="op">=</span> <span class="fl">90</span><span class="op">)</span>,</span>
<span>    <span class="va">res_est_plot</span><span class="op">$</span><span class="va">mahalanobis.1lag.5m</span>,</span>
<span>    <span class="va">res_est_plot</span><span class="op">$</span><span class="va">mahalanobis.1lag.10m</span>,</span>
<span>    <span class="va">res_est_plot</span><span class="op">$</span><span class="va">ps.match.1lag.5m</span>,</span>
<span>    <span class="va">res_est_plot</span><span class="op">$</span><span class="va">ps.match.1lag.10m</span>,</span>
<span>    <span class="va">res_est_plot</span><span class="op">$</span><span class="va">ps.weight.1lag.5m</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span><span class="op">(</span><span class="va">row_labels</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">minor.axes.fontsize</span><span class="op">)</span>, rot <span class="op">=</span> <span class="fl">90</span><span class="op">)</span>,</span>
<span>    <span class="va">res_est_plot_rev</span><span class="op">$</span><span class="va">mahalanobis.1lag.5m</span>,</span>
<span>    <span class="va">res_est_plot_rev</span><span class="op">$</span><span class="va">mahalanobis.1lag.10m</span>,</span>
<span>    <span class="va">res_est_plot_rev</span><span class="op">$</span><span class="va">ps.match.1lag.5m</span>,</span>
<span>    <span class="va">res_est_plot_rev</span><span class="op">$</span><span class="va">ps.match.1lag.10m</span>,</span>
<span>    <span class="va">res_est_plot_rev</span><span class="op">$</span><span class="va">ps.weight.1lag.5m</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># "Flatten" the list-of-lists into a single list of grobs</span></span>
<span><span class="va">grobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">c</span>, <span class="va">grid_list</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Arrange your plots with text labels</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span></span>
<span>  grobs   <span class="op">=</span> <span class="va">grobs</span>,</span>
<span>  ncol    <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  nrow    <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  widths  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.18</span>, <span class="fl">0.18</span>, <span class="fl">0.18</span>, <span class="fl">0.18</span>, <span class="fl">0.18</span><span class="op">)</span>,</span>
<span>  heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.45</span>, <span class="fl">0.45</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add main x and y axis titles</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span></span>
<span>  <span class="st">"Methods"</span>,</span>
<span>  x  <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  y  <span class="op">=</span> <span class="fl">0.02</span>,</span>
<span>  gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">major.axes.fontsize</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">grid.text</a></span><span class="op">(</span></span>
<span>  <span class="st">""</span>,</span>
<span>  x   <span class="op">=</span> <span class="fl">0.02</span>,</span>
<span>  y   <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  rot <span class="op">=</span> <span class="fl">90</span>,</span>
<span>  gp  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">major.axes.fontsize</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb461"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html">include_graphics</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"images"</span>, <span class="st">"p_did_est_in_n_out.png"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="counterfactual-estimators" class="section level4" number="26.9.4.2">
<h4>
<span class="header-section-number">26.9.4.2</span> Counterfactual Estimators<a class="anchor" aria-label="anchor" href="#counterfactual-estimators"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>Also known as <strong>imputation approach</strong> <span class="citation">(<a href="references.html#ref-liu2022practical">Liu, Wang, and Xu 2022</a>)</span>
</li>
<li>This class of estimator consider observation treatment as missing data. Models are built using data from the control units to impute conterfactuals for the treated observations.</li>
<li>It’s called counterfactual estimators because they predict outcomes as if the treated observations had not received the treatment.</li>
<li>Advantages:
<ul>
<li>Avoids negative weights and biases by not using treated observations for modeling and applying uniform weights.</li>
<li>Supports various models, including those that may relax strict exogeneity assumptions.</li>
</ul>
</li>
<li>Methods including
<ul>
<li>Fixed-effects conterfactual estimator (FEct) (DiD is a special case):
<ul>
<li>Based on the <a href="difference-in-differences.html#two-way-fixed-effects">Two-way Fixed-effects</a>, where assumes linear additive functional form of unobservables based on unit and time FEs. But FEct fixes the improper weighting of TWFE by comparing within each matched pair (where each pair is the treated observation and its predicted counterfactual that is the weighted sum of all untreated observations).</li>
</ul>
</li>
<li>Interactive Fixed Effects conterfactual estimator (IFEct) <span class="citation">Xu (<a href="references.html#ref-xu2017generalized">2017</a>)</span>:
<ul>
<li>When we suspect unobserved time-varying confounder, FEct fails. Instead, IFEct uses the factor-augmented models to relax the strict exogeneity assumption where the effects of unobservables can be decomposed to unit FE + time FE + unit x time FE.</li>
<li>Generalized Synthetic Controls are a subset of IFEct when treatments don’t revert.</li>
</ul>
</li>
<li>
<a href="imputation-missing-data.html#matrix-completion">Matrix completion</a> (MC) <span class="citation">(<a href="references.html#ref-athey2021matrix">Athey et al. 2021</a>)</span>:
<ul>
<li>Generalization of factor-augmented models. Different from IFEct which uses hard impute, MC uses soft impute to regularize the singular values when decomposing the residual matrix.</li>
<li>Only when latent factors (of unobservables) are strong and sparse, IFEct outperforms MC.</li>
</ul>
</li>
<li>[Synthetic Controls] (case studies)</li>
</ul>
</li>
</ul>
<p><strong>Identifying Assumptions</strong>:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Function Form</strong>: Additive separability of observables, unobservables, and idiosyncratic error term.
<ul>
<li>Hence, these models are scale dependent <span class="citation">(<a href="references.html#ref-athey2006identification">Athey and Imbens 2006</a>)</span> (e.g., log-transform outcome can invadiate this assumption).</li>
</ul>
</li>
<li>
<strong>Strict Exogeneity</strong>: Conditional on observables and unobservables, potential outcomes are independent of treatment assignment (i.e., baseline quasi-randomization)
<ul>
<li>In DiD, where unobservables = unit + time FEs, this assumption is the parallel trends assumption</li>
</ul>
</li>
<li>
<strong>Low-dimensional Decomposition (Feasibility Assumption)</strong>: Unobservable effects can be decomposed in low-dimension.
<ul>
<li>For the case that <span class="math inline">\(U_{it} = f_t \times \lambda_i\)</span> where <span class="math inline">\(f_t\)</span> = common time trend (time FE), and <span class="math inline">\(\lambda_i\)</span> = unit heterogeneity (unit FE). If <span class="math inline">\(U_{it} = f_t \times \lambda_i\)</span> , DiD can satisfy this assumption. But this assumption is weaker than that of DID, and allows us to control for unobservables based on data.</li>
</ul>
</li>
</ol>
<p><strong>Estimation Procedure</strong>:</p>
<ol style="list-style-type: decimal">
<li>Using all control observations, estimate the functions of both observable and unobservable variables (relying on Assumptions 1 and 3).</li>
<li>Predict the counterfactual outcomes for each treated unit using the obtained functions.</li>
<li>Calculate the difference in treatment effect for each treated individual.</li>
<li>By averaging over all treated individuals, you can obtain the Average Treatment Effect on the Treated (ATT).</li>
</ol>
<p>Notes:</p>
<ul>
<li>Use jackknife when number of treated units is small <span class="citation">(<a href="references.html#ref-liu2022practical">Liu, Wang, and Xu 2022, 166</a>)</span>.</li>
</ul>
<div id="imputation-method" class="section level5" number="26.9.4.2.1">
<h5>
<span class="header-section-number">26.9.4.2.1</span> Imputation Method<a class="anchor" aria-label="anchor" href="#imputation-method"><i class="fas fa-link"></i></a>
</h5>
<p><span class="citation">Liu, Wang, and Xu (<a href="references.html#ref-liu2022practical">2022</a>)</span> can also account for treatment reversals and heterogeneous treatment effects.</p>
<p>Other imputation estimators include</p>
<ul>
<li><p>[@gardner2022two and @borusyak2021revisiting]</p></li>
<li><p><span class="citation">N. Brown, Butts, and Westerlund (<a href="references.html#ref-RePEc:arx:papers:2301.11358">2023</a>)</span></p></li>
</ul>
<div class="sourceCode" id="cb462"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yiqingxu.org/packages/fect/articles/tutorial.html">fect</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">PanelMatch</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/PanelMatch/man/dem.html">dem</a></span></span>
<span></span>
<span><span class="va">model.fect</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/fect/man/fect.html">fect</a></span><span class="op">(</span></span>
<span>        Y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        D <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        X <span class="op">=</span> <span class="st">"tradewb"</span>,</span>
<span>        data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="fu">PanelMatch</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/PanelMatch/man/dem.html">dem</a></span><span class="op">)</span>,</span>
<span>        method <span class="op">=</span> <span class="st">"fe"</span>,</span>
<span>        index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"wbcode2"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>        se <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        parallel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>        <span class="co"># twfe</span></span>
<span>        force <span class="op">=</span> <span class="st">"two-way"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">model.fect</span><span class="op">$</span><span class="va">est.avg</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model.fect</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model.fect</span>, stats <span class="op">=</span> <span class="st">"F.p"</span><span class="op">)</span></span></code></pre></div>
<p>F-test <span class="math inline">\(H_0\)</span>: residual averages in the pre-treatment periods = 0</p>
<p>To see treatment reversal effects</p>
<div class="sourceCode" id="cb463"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">model.fect</span>, stats <span class="op">=</span> <span class="st">"F.p"</span>, type <span class="op">=</span> <span class="st">'exit'</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="placebo-test" class="section level5" number="26.9.4.2.2">
<h5>
<span class="header-section-number">26.9.4.2.2</span> Placebo Test<a class="anchor" aria-label="anchor" href="#placebo-test"><i class="fas fa-link"></i></a>
</h5>
<p>By selecting a part of the data and excluding observations within a specified range to improve the model fitting, we then evaluate whether the estimated Average Treatment Effect (ATT) within this range significantly differs from zero. This approach helps us analyze the periods before treatment.</p>
<p>If this test fails, either the functional form or strict exogeneity assumption is problematic.</p>
<div class="sourceCode" id="cb464"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out.fect.p</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/fect/man/fect.html">fect</a></span><span class="op">(</span></span>
<span>        Y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        D <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        X <span class="op">=</span> <span class="st">"tradewb"</span>,</span>
<span>        data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="fu">PanelMatch</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/PanelMatch/man/dem.html">dem</a></span><span class="op">)</span>,</span>
<span>        method <span class="op">=</span> <span class="st">"fe"</span>,</span>
<span>        index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"wbcode2"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>        se <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        placeboTest <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        <span class="co"># using 3 periods</span></span>
<span>        placebo.period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">out.fect.p</span>, proportion <span class="op">=</span> <span class="fl">0.1</span>, stats <span class="op">=</span> <span class="st">"placebo.p"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="no-carryover-effects-test" class="section level5" number="26.9.4.2.3">
<h5>
<span class="header-section-number">26.9.4.2.3</span> (No) Carryover Effects Test<a class="anchor" aria-label="anchor" href="#no-carryover-effects-test"><i class="fas fa-link"></i></a>
</h5>
<p>The placebo test can be adapted to assess carryover effects by masking several post-treatment periods instead of pre-treatment ones. If no carryover effects are present, the average prediction error should approximate zero. For the carryover test, set <code>carryoverTest = TRUE</code>. Specify a post-treatment period range in carryover.period to exclude observations for model fitting, then evaluate if the estimated ATT significantly deviates from zero.</p>
<p>Even if we have carryover effects, in most cases of the staggered adoption setting, researchers are interested in the cumulative effects, or aggregated treatment effects, so it’s okay.</p>
<div class="sourceCode" id="cb465"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out.fect.c</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/fect/man/fect.html">fect</a></span><span class="op">(</span></span>
<span>        Y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        D <span class="op">=</span> <span class="st">"dem"</span>,</span>
<span>        X <span class="op">=</span> <span class="st">"tradewb"</span>,</span>
<span>        data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="fu">PanelMatch</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/PanelMatch/man/dem.html">dem</a></span><span class="op">)</span>,</span>
<span>        method <span class="op">=</span> <span class="st">"fe"</span>,</span>
<span>        index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"wbcode2"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>        se <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        carryoverTest <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        <span class="co"># how many periods of carryover</span></span>
<span>        carryover.period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">out.fect.c</span>,  stats <span class="op">=</span> <span class="st">"carryover.p"</span><span class="op">)</span></span></code></pre></div>
<p>We have evidence of carryover effects.</p>
</div>
</div>
<div id="matrix-completion-1" class="section level4" number="26.9.4.3">
<h4>
<span class="header-section-number">26.9.4.3</span> Matrix Completion<a class="anchor" aria-label="anchor" href="#matrix-completion-1"><i class="fas fa-link"></i></a>
</h4>
<p>To estimate average causal effects in panel data with units exposed to treatment intermittently, two literatures are pivotal:</p>
<ul>
<li><p><strong>Unconfoundedness</strong> <span class="citation">(<a href="references.html#ref-imbens2015causal">G. W. Imbens and Rubin 2015</a>)</span>: Imputes missing potential control outcomes for treated units using observed outcomes from similar control units in previous periods.</p></li>
<li><p><strong>Synthetic Control</strong> <span class="citation">(<a href="references.html#ref-abadie2010synthetic">Abadie, Diamond, and Hainmueller 2010</a>)</span>: Imputes missing control outcomes for treated units using weighted averages from control units, matching lagged outcomes between treated and control units.</p></li>
</ul>
<p>Both exploit missing potential outcomes under different assumptions:</p>
<ul>
<li><p>Unconfoundedness assumes time patterns are stable across units.</p></li>
<li><p>Synthetic control assumes unit patterns are stable over time.</p></li>
</ul>
<p>Once regularization is applied, both approaches are applicable in similar settings <span class="citation">(<a href="references.html#ref-athey2021matrix">Athey et al. 2021</a>)</span>.</p>
<p><strong>Matrix Completion</strong> method, nesting both, is based on matrix factorization, focusing on imputing missing matrix elements assuming:</p>
<ol style="list-style-type: decimal">
<li>Complete matrix = low-rank matrix + noise.</li>
<li>Missingness is completely at random.</li>
</ol>
<p>It’s distinguished by not imposing factorization restrictions but utilizing regularization to define the estimator, particularly effective with the nuclear norm as a regularizer for complex missing patterns <span class="citation">(<a href="references.html#ref-athey2021matrix">Athey et al. 2021</a>)</span>.</p>
<p>Contributions of <span class="citation">Athey et al. (<a href="references.html#ref-athey2021matrix">2021</a>)</span> matrix completion include:</p>
<ol style="list-style-type: decimal">
<li>Recognizing structured missing patterns allowing time correlation, enabling staggered adoption.</li>
<li>Modifying estimators for unregularized unit and time fixed effects.</li>
<li>Performing well across various <span class="math inline">\(T\)</span> and <span class="math inline">\(N\)</span> sizes, unlike unconfoundedness and synthetic control, which falter when <span class="math inline">\(T &gt;&gt; N\)</span> or <span class="math inline">\(N &gt;&gt; T\)</span>, respectively.</li>
</ol>
<p>Identifying Assumptions:</p>
<ol style="list-style-type: decimal">
<li>SUTVA: Potential outcomes indexed only by the unit’s contemporaneous treatment.</li>
<li>No dynamic effects (it’s okay under staggered adoption, it gives a different interpretation of estimand).</li>
</ol>
<p>Setup:</p>
<ul>
<li>
<span class="math inline">\(Y_{it}(0)\)</span> and <span class="math inline">\(Y_{it}(1)\)</span> represent potential outcomes of <span class="math inline">\(Y_{it}\)</span>.</li>
<li>
<span class="math inline">\(W_{it}\)</span> is a binary treatment indicator.</li>
</ul>
<p>Aim to estimate the average effect for the treated:</p>
<p><span class="math display">\[
\tau = \frac{\sum_{(i,t): W_{it} = 1}[Y_{it}(1) - Y_{it}(0)]}{\sum_{i,t}W_{it}}
\]</span></p>
<p>We observe all relevant values for <span class="math inline">\(Y_{it}(1)\)</span></p>
<p>We want to impute missing entries in the <span class="math inline">\(Y(0)\)</span> matrix for treated units with <span class="math inline">\(W_{it} = 1\)</span>.</p>
<p>Define <span class="math inline">\(\mathcal{M}\)</span> as the set of pairs of indices <span class="math inline">\((i,t)\)</span>, where <span class="math inline">\(i \in N\)</span> and <span class="math inline">\(t \in T\)</span>, corresponding to missing entries with <span class="math inline">\(W_{it} = 1\)</span>; <span class="math inline">\(\mathcal{O}\)</span> as the set of pairs of indices corresponding to observed entries in <span class="math inline">\(Y(0)\)</span> with <span class="math inline">\(W_{it} = 0\)</span>.</p>
<p>Data is conceptualized as two <span class="math inline">\(N \times T\)</span> matrices, one incomplete and one complete:</p>
<p><span class="math display">\[
Y = \begin{pmatrix}
Y_{11} &amp; Y_{12} &amp; ? &amp; \cdots &amp; Y_{1T} \\
? &amp; ? &amp; Y_{23} &amp; \cdots &amp; ? \\
Y_{31} &amp; ? &amp; Y_{33} &amp; \cdots &amp; ? \\
\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
Y_{N1} &amp; ? &amp; Y_{N3} &amp; \cdots &amp; ?
\end{pmatrix},
\]</span></p>
<p>and</p>
<p><span class="math display">\[
W = \begin{pmatrix}
0 &amp; 0 &amp; 1 &amp; \cdots &amp; 0 \\
1 &amp; 1 &amp; 0 &amp; \cdots &amp; 1 \\
0 &amp; 1 &amp; 0 &amp; \cdots &amp; 1 \\
\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
0 &amp; 1 &amp; 0 &amp; \cdots &amp; 1
\end{pmatrix},
\]</span></p>
<p>where</p>
<p><span class="math display">\[
W_{it} =
\begin{cases}
1 &amp; \text{if } (i,t) \in \mathcal{M}, \\
0 &amp; \text{if } (i,t) \in \mathcal{O},
\end{cases}
\]</span></p>
<p>is an indicator for the event that the corresponding component of <span class="math inline">\(Y\)</span>, that is <span class="math inline">\(Y_{it}\)</span>, is missing.</p>
<p>Patterns of missing data in <span class="math inline">\(\mathbf{Y}\)</span>:</p>
<ul>
<li>
<p>Block (treatment) structure with 2 special cases</p>
<ul>
<li><p>Single-treated-period block structure <span class="citation">(<a href="references.html#ref-imbens2015causal">G. W. Imbens and Rubin 2015</a>)</span></p></li>
<li><p>Single-treated-unit block structure <span class="citation">(<a href="references.html#ref-abadie2010synthetic">Abadie, Diamond, and Hainmueller 2010</a>)</span></p></li>
</ul>
</li>
<li><p>Staggered Adoption</p></li>
</ul>
<p>Shape of matrix <span class="math inline">\(\mathbf{Y}\)</span>:</p>
<ul>
<li><p>Thin (<span class="math inline">\(N &gt;&gt; T\)</span>)</p></li>
<li><p>Fat (<span class="math inline">\(T &gt;&gt; N\)</span>)</p></li>
<li><p>Square (<span class="math inline">\(N \approx T\)</span>)</p></li>
</ul>
<p>Combinations of patterns of missingness and shape create different literatures:</p>
<ul>
<li><p>Horizontal Regression = Thin matrix + single-treated-period block (focusing on cross-section correlation patterns)</p></li>
<li><p>Vertical Regression = Fat matrix + single-treated-unit block (focusing on time-series correlation patterns)</p></li>
<li><p>TWFE = Square matrix</p></li>
</ul>
<p>To combine, we can exploit both stable patterns over time, and across units (e.g., TWFE, interactive FEs or matrix completion).</p>
<p>For the same factor model</p>
<p><span class="math display">\[
\mathbf{Y = UV}^T + \mathbf{\epsilon}
\]</span></p>
<p>where <span class="math inline">\(\mathbf{U}\)</span> is <span class="math inline">\(N \times R\)</span> and <span class="math inline">\(\mathbf{V}\)</span> is <span class="math inline">\(T\times R\)</span></p>
<p>The interactive FE literature focuses on a fixed number of factors <span class="math inline">\(R\)</span> in <span class="math inline">\(\mathbf{U, V}\)</span>, while matrix completion focuses on impute <span class="math inline">\(\mathbf{Y}\)</span> using some forms regularization (e.g., nuclear norm).</p>
<ul>
<li>We can also estimate the number of factors <span class="math inline">\(R\)</span> <span class="citation">Moon and Weidner (<a href="references.html#ref-moon2015linear">2015</a>)</span>
</li>
</ul>
<p>To use the nuclear norm minimization estimator, we must add a penalty term to regularize the objective function. However, before doing so, we need to explicitly estimate the time (<span class="math inline">\(\lambda_t\)</span>) and unit (<span class="math inline">\(\mu_i\)</span>) fixed effects implicitly embedded in the missing data matrix to reduce the bias of the regularization term.</p>
<p><a href="https://bookdown.org/stanfordgsbsilab/ml-ci-tutorial/matrix-completion-methods.html">Specifically</a>,</p>
<p><span class="math display">\[
Y_{it}  =L_{it} + \sum_{p = 1}^P \sum_{q= 1}^Q X_{ip} H_{pq}Z_{qt} + \mu_i + \lambda_t + V_{it} \beta + \epsilon_{it}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(X_{ip}\)</span> is a matrix of <span class="math inline">\(p\)</span> variables for unit <span class="math inline">\(i\)</span></p></li>
<li><p><span class="math inline">\(Z_{qt}\)</span> is a matrix of <span class="math inline">\(q\)</span> variables for time <span class="math inline">\(t\)</span></p></li>
<li><p><span class="math inline">\(V_{it}\)</span> is a matrix of time-varying variables.</p></li>
</ul>
<p>Lasso-type <span class="math inline">\(l_1\)</span> norm (<span class="math inline">\(||H|| = \sum_{p = 1}^p \sum_{q = 1}^Q |H_{pq}|\)</span>) is used to shrink <span class="math inline">\(H \to 0\)</span></p>
<p>There are several options to regularize <span class="math inline">\(L\)</span>:</p>
<ol style="list-style-type: decimal">
<li>Frobenius (i.e., Ridge): not informative since it imputes missing values as 0.</li>
<li>Nuclear Norm (i.e., Lasso): computationally feasible (using SOFT-IMPUTE algorithm <span class="citation">(<a href="references.html#ref-Mazumder2010SpectralRA">Mazumder, Hastie, and Tibshirani 2010</a>)</span>).</li>
<li>Rank (i.e., Subset selection): not computationally feasible</li>
</ol>
<p>This methods allows to</p>
<ul>
<li><p>use more covariates</p></li>
<li><p>leverage data from treated units (can be used when treatment effect is constant and pattern of missing is not complex).</p></li>
<li><p>have autocorrelated errors</p></li>
<li><p>have weighted loss function (i.e., take into account the probability of outcomes for a unit being missing)</p></li>
</ul>
</div>
</div>
<div id="gardner2022two-and-borusyak2021revisiting" class="section level3" number="26.9.5">
<h3>
<span class="header-section-number">26.9.5</span> <span class="citation">Gardner (<a href="references.html#ref-gardner2022two">2022</a>)</span> and <span class="citation">Borusyak, Jaravel, and Spiess (<a href="references.html#ref-borusyak2021revisiting">2021</a>)</span><a class="anchor" aria-label="anchor" href="#gardner2022two-and-borusyak2021revisiting"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>Estimate the time and unit fixed effects separately</p></li>
<li><p>Known as the imputation method <span class="citation">(<a href="references.html#ref-borusyak2021revisiting">Borusyak, Jaravel, and Spiess 2021</a>)</span> or two-stage DiD <span class="citation">(<a href="references.html#ref-gardner2022two">Gardner 2022</a>)</span></p></li>
</ul>
<div class="sourceCode" id="cb466"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># remotes::install_github("kylebutts/did2s")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://kylebutts.github.io/did2s/">did2s</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">base_stagg</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kylebutts.github.io/did2s/reference/did2s.html">did2s</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>treat <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">time_to_treatment</span> <span class="op">&gt;=</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    yname <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    first_stage <span class="op">=</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">|</span> <span class="va">id</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>    second_stage <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/i.html">i</a></span><span class="op">(</span><span class="va">time_to_treatment</span>, ref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    treatment <span class="op">=</span> <span class="st">"treat"</span> ,</span>
<span>    cluster_var <span class="op">=</span> <span class="st">"id"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/etable.html">esttable</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                       est</span></span>
<span><span class="co">#&gt; Dependent Var.:                         y</span></span>
<span><span class="co">#&gt;                                          </span></span>
<span><span class="co">#&gt; time_to_treatment = -9  0.3518** (0.1332)</span></span>
<span><span class="co">#&gt; time_to_treatment = -8  -0.3130* (0.1213)</span></span>
<span><span class="co">#&gt; time_to_treatment = -7    0.0894 (0.2367)</span></span>
<span><span class="co">#&gt; time_to_treatment = -6    0.0312 (0.2176)</span></span>
<span><span class="co">#&gt; time_to_treatment = -5   -0.2079 (0.1519)</span></span>
<span><span class="co">#&gt; time_to_treatment = -4   -0.1152 (0.1438)</span></span>
<span><span class="co">#&gt; time_to_treatment = -3   -0.0127 (0.1483)</span></span>
<span><span class="co">#&gt; time_to_treatment = -2    0.1503 (0.1440)</span></span>
<span><span class="co">#&gt; time_to_treatment = 0  -5.139*** (0.3680)</span></span>
<span><span class="co">#&gt; time_to_treatment = 1  -3.480*** (0.3784)</span></span>
<span><span class="co">#&gt; time_to_treatment = 2  -2.021*** (0.3055)</span></span>
<span><span class="co">#&gt; time_to_treatment = 3   -0.6965. (0.3947)</span></span>
<span><span class="co">#&gt; time_to_treatment = 4    1.070** (0.3501)</span></span>
<span><span class="co">#&gt; time_to_treatment = 5   2.173*** (0.4456)</span></span>
<span><span class="co">#&gt; time_to_treatment = 6   4.449*** (0.3680)</span></span>
<span><span class="co">#&gt; time_to_treatment = 7   4.864*** (0.3698)</span></span>
<span><span class="co">#&gt; time_to_treatment = 8   6.187*** (0.2702)</span></span>
<span><span class="co">#&gt; ______________________ __________________</span></span>
<span><span class="co">#&gt; S.E. type                          Custom</span></span>
<span><span class="co">#&gt; Observations                          950</span></span>
<span><span class="co">#&gt; R2                                0.62486</span></span>
<span><span class="co">#&gt; Adj. R2                           0.61843</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span></span>
<span><span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">iplot</a></span><span class="op">(</span></span>
<span>    <span class="va">est</span>,</span>
<span>    main <span class="op">=</span> <span class="st">"Event study"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"Time to treatment"</span>,</span>
<span>    ref.line <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-40-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb467"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">coefplot</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-40-2.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb468"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mult_est</span> <span class="op">&lt;-</span> <span class="fu">did2s</span><span class="fu">::</span><span class="fu"><a href="https://kylebutts.github.io/did2s/reference/event_study.html">event_study</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu">fixest</span><span class="fu">::</span><span class="va"><a href="https://lrberge.github.io/fixest/reference/base_stagg.html">base_stagg</a></span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year_treated <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">year_treated</span> <span class="op">==</span> <span class="fl">10000</span>, <span class="fl">0</span>, <span class="va">year_treated</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    gname <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    idname <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    tname <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    yname <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimator <span class="op">=</span> <span class="st">"all"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in purrr::map(., function(y) { : ℹ In index: 1.</span></span>
<span><span class="co">#&gt; ℹ With name: y.</span></span>
<span><span class="co">#&gt; Caused by error in `.subset2()`:</span></span>
<span><span class="co">#&gt; ! no such index at level 1</span></span>
<span><span class="fu">did2s</span><span class="fu">::</span><span class="fu"><a href="https://kylebutts.github.io/did2s/reference/event_study.html">plot_event_study</a></span><span class="op">(</span><span class="va">mult_est</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-41-1.png" width="90%" style="display: block; margin: auto;"></div>
<p><span class="citation">Borusyak, Jaravel, and Spiess (<a href="references.html#ref-borusyak2021revisiting">2021</a>)</span> <code>didimputation</code></p>
<p>This version is currently not working</p>
<div class="sourceCode" id="cb469"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">didimputation</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"base_stagg"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/didimputation/man/did_imputation.html">did_imputation</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    yname <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    gname <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    tname <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    idname <span class="op">=</span> <span class="st">"id"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div id="de2020two" class="section level3" number="26.9.6">
<h3>
<span class="header-section-number">26.9.6</span> <span class="citation">Clément De Chaisemartin and d’Haultfoeuille (<a href="references.html#ref-de2020two">2020</a>)</span><a class="anchor" aria-label="anchor" href="#de2020two"><i class="fas fa-link"></i></a>
</h3>
<p>use <code>twowayfeweights</code> from <a href="https://github.com/shuo-zhang-ucsb/twowayfeweights">GitHub</a> <span class="citation">(<a href="references.html#ref-de2020two">Clément De Chaisemartin and d’Haultfoeuille 2020</a>)</span></p>
<ul>
<li>
<p>Average instant treatment effect of changes in the treatment</p>
<ul>
<li>This relaxes the no-carryover-effect assumption.</li>
</ul>
</li>
<li>
<p>Drawbacks:</p>
<ul>
<li>Cannot observe treatment effects that manifest over time.</li>
</ul>
</li>
</ul>
<p>There still isn’t a good package for this estimator.</p>
<div class="sourceCode" id="cb470"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># remotes::install_github("shuo-zhang-ucsb/did_multiplegt") </span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">DIDmultiplegt</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"base_stagg"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/DIDmultiplegt/man/did_multiplegt.html">did_multiplegt</a></span><span class="op">(</span></span>
<span>        df <span class="op">=</span> <span class="va">base_stagg</span> <span class="op">|&gt;</span></span>
<span>            <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">time_to_treatment</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        Y        <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        G        <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>        T        <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        D        <span class="op">=</span> <span class="st">"treatment"</span>,</span>
<span>        controls <span class="op">=</span> <span class="st">"x1"</span>,</span>
<span>        <span class="co"># brep     = 20, # getting SE will take forever</span></span>
<span>        placebo  <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        dynamic  <span class="op">=</span> <span class="fl">5</span>, </span>
<span>        average_effect <span class="op">=</span> <span class="st">"simple"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="co">#&gt; $effect</span></span>
<span><span class="co">#&gt; treatment </span></span>
<span><span class="co">#&gt; -5.214207 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $N_effect</span></span>
<span><span class="co">#&gt; [1] 675</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $N_switchers_effect</span></span>
<span><span class="co">#&gt; [1] 45</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dynamic_1</span></span>
<span><span class="co">#&gt; [1] -3.63556</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $N_dynamic_1</span></span>
<span><span class="co">#&gt; [1] 580</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $N_switchers_effect_1</span></span>
<span><span class="co">#&gt; [1] 40</span></span></code></pre></div>
<p>I don’t recommend the <code>TwoWayFEWeights</code> since it only gives the aggregated average treatment effect over all post-treatment periods, but not for each period.</p>
<div class="sourceCode" id="cb471"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">TwoWayFEWeights</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/TwoWayFEWeights/man/twowayfeweights.html">twowayfeweights</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">base_stagg</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">time_to_treatment</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    G <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    T <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    D <span class="op">=</span> <span class="st">"treatment"</span>, </span>
<span>    summary_measures <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="co">#&gt; Under the common trends assumption, beta estimates a weighted sum of 45 ATTs.</span></span>
<span><span class="co">#&gt; 41 ATTs receive a positive weight, and 4 receive a negative weight.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ────────────────────────────────────────── </span></span>
<span><span class="co">#&gt; Treat. var: treatment    ATTs    Σ weights </span></span>
<span><span class="co">#&gt; ────────────────────────────────────────── </span></span>
<span><span class="co">#&gt; Positive weights           41       1.0238 </span></span>
<span><span class="co">#&gt; Negative weights            4      -0.0238 </span></span>
<span><span class="co">#&gt; ────────────────────────────────────────── </span></span>
<span><span class="co">#&gt; Total                      45            1 </span></span>
<span><span class="co">#&gt; ──────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary Measures:</span></span>
<span><span class="co">#&gt;   TWFE Coefficient (β_fe): -3.4676</span></span>
<span><span class="co">#&gt;   min σ(Δ) compatible with β_fe and Δ_TR = 0: 4.8357</span></span>
<span><span class="co">#&gt;   min σ(Δ) compatible with β_fe and Δ_TR of a different sign: 36.1549</span></span>
<span><span class="co">#&gt;   Reference: Corollary 1, de Chaisemartin, C and D'Haultfoeuille, X (2020a)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The development of this package was funded by the European Union (ERC, REALLYCREDIBLE,GA N. 101043899).</span></span></code></pre></div>
</div>
<div id="callaway2021difference" class="section level3" number="26.9.7">
<h3>
<span class="header-section-number">26.9.7</span> <span class="citation">Callaway and Sant’Anna (<a href="references.html#ref-callaway2021difference">2021</a>)</span><a class="anchor" aria-label="anchor" href="#callaway2021difference"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p><code>staggered</code> <a href="https://github.com/jonathandroth/staggered">package</a></p></li>
<li><p>Group-time average treatment effect</p></li>
</ul>
<div class="sourceCode" id="cb472"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">staggered</span><span class="op">)</span> </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"base_stagg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simple weighted average</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/staggered/man/staggered.html">staggered</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    i <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    t <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    g <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"simple"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     estimate        se se_neyman</span></span>
<span><span class="co">#&gt; 1 -0.7110941 0.2211943 0.2214245</span></span>
<span></span>
<span><span class="co"># cohort weighted average</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/staggered/man/staggered.html">staggered</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    i <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    t <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    g <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"cohort"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;    estimate        se se_neyman</span></span>
<span><span class="co">#&gt; 1 -2.724242 0.2701093 0.2701745</span></span>
<span></span>
<span><span class="co"># calendar weighted average</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/staggered/man/staggered.html">staggered</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    i <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    t <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    g <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"calendar"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     estimate        se se_neyman</span></span>
<span><span class="co">#&gt; 1 -0.5861831 0.1768297 0.1770729</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/staggered/man/staggered.html">staggered</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    i <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    t <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    g <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"eventstudy"</span>, </span>
<span>    eventTime <span class="op">=</span> <span class="op">-</span><span class="fl">9</span><span class="op">:</span><span class="fl">8</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="co">#&gt;      estimate        se se_neyman eventTime</span></span>
<span><span class="co">#&gt; 1  0.20418779 0.1045821 0.1045821        -9</span></span>
<span><span class="co">#&gt; 2 -0.06215104 0.1669703 0.1670886        -8</span></span>
<span><span class="co">#&gt; 3  0.02744671 0.1413273 0.1420377        -7</span></span>
<span><span class="co">#&gt; 4 -0.02131747 0.2203695 0.2206338        -6</span></span>
<span><span class="co">#&gt; 5 -0.30690897 0.2015697 0.2036412        -5</span></span>
<span><span class="co">#&gt; 6  0.05594029 0.1908101 0.1921745        -4</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="va">res</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        ymin_ptwise <span class="op">=</span> <span class="va">estimate</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span>,</span>
<span>        ymax_ptwise <span class="op">=</span> <span class="va">estimate</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">eventTime</span>, y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ymin_ptwise</span>, ymax <span class="op">=</span> <span class="va">ymax_ptwise</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Event Time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Estimate"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-45-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb473"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Callaway and Sant'Anna estimator for the simple weighted average</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/staggered/man/staggered_cs.html">staggered_cs</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    i <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    t <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    g <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"simple"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     estimate        se se_neyman</span></span>
<span><span class="co">#&gt; 1 -0.7994889 0.4484987 0.4486122</span></span>
<span></span>
<span><span class="co"># Sun and Abraham estimator for the simple weighted average</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/staggered/man/staggered_sa.html">staggered_sa</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    i <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    t <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    g <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"simple"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     estimate        se se_neyman</span></span>
<span><span class="co">#&gt; 1 -0.7551901 0.4407818 0.4409525</span></span></code></pre></div>
<p>Fisher’s Randomization Test (i.e., permutation test)</p>
<p><span class="math inline">\(H_0\)</span>: <span class="math inline">\(TE = 0\)</span></p>
<div class="sourceCode" id="cb474"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/staggered/man/staggered.html">staggered</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="va">base_stagg</span>,</span>
<span>    i <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    t <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>    g <span class="op">=</span> <span class="st">"year_treated"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"simple"</span>,</span>
<span>    compute_fisher <span class="op">=</span> <span class="cn">T</span>,</span>
<span>    num_fisher_permutations <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     estimate        se se_neyman fisher_pval fisher_pval_se_neyman</span></span>
<span><span class="co">#&gt; 1 -0.7110941 0.2211943 0.2214245           0                     0</span></span>
<span><span class="co">#&gt;   num_fisher_permutations</span></span>
<span><span class="co">#&gt; 1                     100</span></span></code></pre></div>
</div>
<div id="sun2021estimating" class="section level3" number="26.9.8">
<h3>
<span class="header-section-number">26.9.8</span> <span class="citation">L. Sun and Abraham (<a href="references.html#ref-sun2021estimating">2021</a>)</span><a class="anchor" aria-label="anchor" href="#sun2021estimating"><i class="fas fa-link"></i></a>
</h3>
<p>This paper utilizes the Cohort Average Treatment Effects on the Treated (CATT), which measures the cohort-specific average difference in outcomes relative to those never treated, offering a more detailed analysis than <span class="citation">Goodman-Bacon (<a href="references.html#ref-goodman2021difference">2021</a>)</span>. In scenarios lacking a never-treated group, this method designates the last cohort to be treated as the control group.</p>
<p>Parameter of interest is the cohort-specific ATT <span class="math inline">\(l\)</span> periods from intital treatment period <span class="math inline">\(e\)</span></p>
<p><span class="math display">\[
CATT = E[Y_{i, e + I} - Y_{i, e + I}^\infty|E_i = e]
\]</span></p>
<p>This paper uses an <strong>interaction-weighted estimator</strong> in a panel data setting, where the original paper <span class="citation">Gibbons, Suárez Serrato, and Urbancic (<a href="references.html#ref-gibbons2018broken">2018</a>)</span> used the same idea in a cross-sectional setting.</p>
<ul>
<li><p><span class="citation">Callaway and Sant’Anna (<a href="references.html#ref-callaway2021difference">2021</a>)</span> explores group-time average treatment effects, employing cohorts that have not yet been treated as controls, and permits conditioning on time-varying covariates.</p></li>
<li><p><span class="citation">Athey and Imbens (<a href="references.html#ref-athey2022design">2022</a>)</span> examines the treatment effect in relation to the counterfactual outcome of the always-treated group, diverging from the conventional focus on the never-treated.</p></li>
<li><p><span class="citation">Borusyak, Jaravel, and Spiess (<a href="references.html#ref-borusyak2021revisiting">2021</a>)</span> presumes a uniform treatment effect across cohorts, effectively simplifying CATT to ATT.</p></li>
</ul>
<p>Identifying Assumptions for dynamic TWFE:</p>
<ol style="list-style-type: decimal">
<li>
<p><strong>Parallel Trends</strong>: Baseline outcomes follow parallel trends across cohorts before treatment.</p>
<ul>
<li>This gives us all CATT (including own, included bins, and excluded bins)</li>
</ul>
</li>
<li><p><strong>No Anticipatory Behavior</strong>: There is no effect of the treatment during pre-treatment periods, indicating that outcomes are not influenced by the anticipation of treatment.</p></li>
<li>
<p><strong>Treatment Effect Homogeneity</strong>: The treatment effect is consistent across cohorts for each relative period. Each adoption cohort should have the same path of treatment effects. In other words, the trajectory of each treatment cohort is similar. Compare to other designs:</p>
<ol style="list-style-type: decimal">
<li><p><span class="citation">Athey and Imbens (<a href="references.html#ref-athey2022design">2022</a>)</span> assume heterogeneity of treatment effects vary over adoption cohorts, but not over time.</p></li>
<li><p><span class="citation">Borusyak, Jaravel, and Spiess (<a href="references.html#ref-borusyak2021revisiting">2021</a>)</span> assume heterogeneity of treatment effects vary over time, but not over adoption cohorts.</p></li>
<li><p><span class="citation">Callaway and Sant’Anna (<a href="references.html#ref-callaway2021difference">2021</a>)</span> assume heterogeneity of treatment effects vary over time and across cohorts.</p></li>
<li><p><span class="citation">Clement De Chaisemartin and D’haultfœuille (<a href="references.html#ref-de2023two">2023</a>)</span> assume heterogeneity of treatment effects vary across groups and over time.</p></li>
<li><p><span class="citation">Goodman-Bacon (<a href="references.html#ref-goodman2021difference">2021</a>)</span> assume heterogeneity either “vary across units but not over time” or “vary over time but not across units”.</p></li>
<li><p><span class="citation">L. Sun and Abraham (<a href="references.html#ref-sun2021estimating">2021</a>)</span> allows for treatment effect heterogeneity across units and time.</p></li>
</ol>
</li>
</ol>
<p>Sources of Heterogeneous Treatment Effects</p>
<ul>
<li><p>Adoption cohorts can differ based on certain covariates. Similarly, composition of units within each adoption cohort is different.</p></li>
<li><p>The response to treatment varies among cohorts if units self-select their initial treatment timing based on anticipated treatment effects. However, this self-selection is still compatible with the parallel trends assumption. This is true if units choose based on an evaluation of baseline outcomes - that is, if baseline outcomes are similar (following parallel trends), then we might not see selection into treatment based on the evaluation of the baseline outcome.</p></li>
<li><p>Treatment effects can vary across cohorts due to calendar time-varying effects, such as changes in economic conditions.</p></li>
</ul>
<p>Notes:</p>
<ul>
<li>
<p>If you do TWFE, you actually have to drop 2 terms to avoid multicollinearity:</p>
<ul>
<li><p>Period right before treatment (this one was known before this paper)</p></li>
<li><p>Drop or bin or trim a distant lag period (this one was clarified by the paper). The reason is before of the multicollinearity in the linear relationship between TWFE and the relative period indicators.</p></li>
</ul>
</li>
<li>
<p>Contamination of the treatment effect estimates from excluded periods is a type of “normalization”. To avoid this, we have to assume that all pre-treatment periods have the same CATT.</p>
<ul>
<li>
<span class="citation">L. Sun and Abraham (<a href="references.html#ref-sun2021estimating">2021</a>)</span> estimation method gives reasonable weights to CATT (i..e, weights that sum to 1, and are non negative). They estimate the weighted average of CATT where the weights are shares of cohorts that experience at least <span class="math inline">\(l\)</span> periods after to treatment, normalized by the size of total periods <span class="math inline">\(g\)</span>.</li>
</ul>
</li>
<li><p>Aggregation of CATT is similar to that of <span class="citation">Callaway and Sant’Anna (<a href="references.html#ref-callaway2021difference">2021</a>)</span></p></li>
</ul>
<p><strong>Application</strong></p>
<p>can use <code>fixest</code> in r with <code>sunab</code> function</p>
<div class="sourceCode" id="cb475"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"base_stagg"</span><span class="op">)</span></span>
<span><span class="va">res_sa20</span> <span class="op">=</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="fu">sunab</span><span class="op">(</span><span class="va">year_treated</span>, <span class="va">year</span><span class="op">)</span> <span class="op">|</span> <span class="va">id</span> <span class="op">+</span> <span class="va">year</span>, <span class="va">base_stagg</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">iplot</a></span><span class="op">(</span><span class="va">res_sa20</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-48-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb476"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">res_sa20</span>, agg <span class="op">=</span> <span class="st">"att"</span><span class="op">)</span></span>
<span><span class="co">#&gt; OLS estimation, Dep. Var.: y</span></span>
<span><span class="co">#&gt; Observations: 950 </span></span>
<span><span class="co">#&gt; Fixed-effects: id: 95,  year: 10</span></span>
<span><span class="co">#&gt; Standard-errors: Clustered (id) </span></span>
<span><span class="co">#&gt;      Estimate Std. Error  t value  Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; x1   0.994678   0.018378 54.12293 &lt; 2.2e-16 ***</span></span>
<span><span class="co">#&gt; ATT -1.133749   0.205070 -5.52858 2.882e-07 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; RMSE: 0.921817     Adj. R2: 0.887984</span></span>
<span><span class="co">#&gt;                  Within R2: 0.876406</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">res_sa20</span>, agg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"att"</span> <span class="op">=</span> <span class="st">"year::[^-]"</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="co">#&gt; OLS estimation, Dep. Var.: y</span></span>
<span><span class="co">#&gt; Observations: 950 </span></span>
<span><span class="co">#&gt; Fixed-effects: id: 95,  year: 10</span></span>
<span><span class="co">#&gt; Standard-errors: Clustered (id) </span></span>
<span><span class="co">#&gt;                      Estimate Std. Error   t value   Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; x1                   0.994678   0.018378 54.122928  &lt; 2.2e-16 ***</span></span>
<span><span class="co">#&gt; year::-9:cohort::10  0.351766   0.359073  0.979649 3.2977e-01    </span></span>
<span><span class="co">#&gt; year::-8:cohort::9   0.033914   0.471437  0.071937 9.4281e-01    </span></span>
<span><span class="co">#&gt; year::-8:cohort::10 -0.191932   0.352896 -0.543876 5.8781e-01    </span></span>
<span><span class="co">#&gt; year::-7:cohort::8  -0.589387   0.736910 -0.799809 4.2584e-01    </span></span>
<span><span class="co">#&gt; year::-7:cohort::9   0.872995   0.493427  1.769249 8.0096e-02 .  </span></span>
<span><span class="co">#&gt; year::-7:cohort::10  0.019512   0.603411  0.032336 9.7427e-01    </span></span>
<span><span class="co">#&gt; year::-6:cohort::7  -0.042147   0.865736 -0.048683 9.6127e-01    </span></span>
<span><span class="co">#&gt; year::-6:cohort::8  -0.657571   0.573257 -1.147078 2.5426e-01    </span></span>
<span><span class="co">#&gt; year::-6:cohort::9   0.877743   0.533331  1.645775 1.0315e-01    </span></span>
<span><span class="co">#&gt; year::-6:cohort::10 -0.403635   0.347412 -1.161832 2.4825e-01    </span></span>
<span><span class="co">#&gt; year::-5:cohort::6  -0.658034   0.913407 -0.720418 4.7306e-01    </span></span>
<span><span class="co">#&gt; year::-5:cohort::7  -0.316974   0.697939 -0.454158 6.5076e-01    </span></span>
<span><span class="co">#&gt; year::-5:cohort::8  -0.238213   0.469744 -0.507113 6.1326e-01    </span></span>
<span><span class="co">#&gt; year::-5:cohort::9   0.301477   0.604201  0.498968 6.1897e-01    </span></span>
<span><span class="co">#&gt; year::-5:cohort::10 -0.564801   0.463214 -1.219308 2.2578e-01    </span></span>
<span><span class="co">#&gt; year::-4:cohort::5  -0.983453   0.634492 -1.549984 1.2451e-01    </span></span>
<span><span class="co">#&gt; year::-4:cohort::6   0.360407   0.858316  0.419900 6.7552e-01    </span></span>
<span><span class="co">#&gt; year::-4:cohort::7  -0.430610   0.661356 -0.651102 5.1657e-01    </span></span>
<span><span class="co">#&gt; year::-4:cohort::8  -0.895195   0.374901 -2.387816 1.8949e-02 *  </span></span>
<span><span class="co">#&gt; year::-4:cohort::9  -0.392478   0.439547 -0.892914 3.7418e-01    </span></span>
<span><span class="co">#&gt; year::-4:cohort::10  0.519001   0.597880  0.868069 3.8757e-01    </span></span>
<span><span class="co">#&gt; year::-3:cohort::4   0.591288   0.680169  0.869324 3.8688e-01    </span></span>
<span><span class="co">#&gt; year::-3:cohort::5  -1.000650   0.971741 -1.029749 3.0577e-01    </span></span>
<span><span class="co">#&gt; year::-3:cohort::6   0.072188   0.652641  0.110609 9.1216e-01    </span></span>
<span><span class="co">#&gt; year::-3:cohort::7  -0.836820   0.804275 -1.040465 3.0079e-01    </span></span>
<span><span class="co">#&gt; year::-3:cohort::8  -0.783148   0.701312 -1.116691 2.6697e-01    </span></span>
<span><span class="co">#&gt; year::-3:cohort::9   0.811285   0.564470  1.437251 1.5397e-01    </span></span>
<span><span class="co">#&gt; year::-3:cohort::10  0.527203   0.320051  1.647250 1.0285e-01    </span></span>
<span><span class="co">#&gt; year::-2:cohort::3   0.036941   0.673771  0.054828 9.5639e-01    </span></span>
<span><span class="co">#&gt; year::-2:cohort::4   0.832250   0.859544  0.968246 3.3541e-01    </span></span>
<span><span class="co">#&gt; year::-2:cohort::5  -1.574086   0.525563 -2.995051 3.5076e-03 ** </span></span>
<span><span class="co">#&gt; year::-2:cohort::6   0.311758   0.832095  0.374666 7.0875e-01    </span></span>
<span><span class="co">#&gt; year::-2:cohort::7  -0.558631   0.871993 -0.640638 5.2332e-01    </span></span>
<span><span class="co">#&gt; year::-2:cohort::8   0.429591   0.305270  1.407250 1.6265e-01    </span></span>
<span><span class="co">#&gt; year::-2:cohort::9   1.201899   0.819186  1.467188 1.4566e-01    </span></span>
<span><span class="co">#&gt; year::-2:cohort::10 -0.002429   0.682087 -0.003562 9.9717e-01    </span></span>
<span><span class="co">#&gt; att                 -1.133749   0.205070 -5.528584 2.8820e-07 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; RMSE: 0.921817     Adj. R2: 0.887984</span></span>
<span><span class="co">#&gt;                  Within R2: 0.876406</span></span>
<span></span>
<span><span class="co"># alternatively</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">res_sa20</span>, agg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"att"</span> <span class="op">=</span> <span class="st">"year::[012345678]"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://lrberge.github.io/fixest/reference/etable.html">etable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         summary(res_..</span></span>
<span><span class="co">#&gt; Dependent Var.:                      y</span></span>
<span><span class="co">#&gt;                                       </span></span>
<span><span class="co">#&gt; x1                      0.99*** (0.02)</span></span>
<span><span class="co">#&gt; year = -9 x cohort = 10    0.35 (0.36)</span></span>
<span><span class="co">#&gt; year = -8 x cohort = 9     0.03 (0.47)</span></span>
<span><span class="co">#&gt; year = -8 x cohort = 10   -0.19 (0.35)</span></span>
<span><span class="co">#&gt; year = -7 x cohort = 8    -0.59 (0.74)</span></span>
<span><span class="co">#&gt; year = -7 x cohort = 9    0.87. (0.49)</span></span>
<span><span class="co">#&gt; year = -7 x cohort = 10    0.02 (0.60)</span></span>
<span><span class="co">#&gt; year = -6 x cohort = 7    -0.04 (0.87)</span></span>
<span><span class="co">#&gt; year = -6 x cohort = 8    -0.66 (0.57)</span></span>
<span><span class="co">#&gt; year = -6 x cohort = 9     0.88 (0.53)</span></span>
<span><span class="co">#&gt; year = -6 x cohort = 10   -0.40 (0.35)</span></span>
<span><span class="co">#&gt; year = -5 x cohort = 6    -0.66 (0.91)</span></span>
<span><span class="co">#&gt; year = -5 x cohort = 7    -0.32 (0.70)</span></span>
<span><span class="co">#&gt; year = -5 x cohort = 8    -0.24 (0.47)</span></span>
<span><span class="co">#&gt; year = -5 x cohort = 9     0.30 (0.60)</span></span>
<span><span class="co">#&gt; year = -5 x cohort = 10   -0.56 (0.46)</span></span>
<span><span class="co">#&gt; year = -4 x cohort = 5    -0.98 (0.63)</span></span>
<span><span class="co">#&gt; year = -4 x cohort = 6     0.36 (0.86)</span></span>
<span><span class="co">#&gt; year = -4 x cohort = 7    -0.43 (0.66)</span></span>
<span><span class="co">#&gt; year = -4 x cohort = 8   -0.90* (0.37)</span></span>
<span><span class="co">#&gt; year = -4 x cohort = 9    -0.39 (0.44)</span></span>
<span><span class="co">#&gt; year = -4 x cohort = 10    0.52 (0.60)</span></span>
<span><span class="co">#&gt; year = -3 x cohort = 4     0.59 (0.68)</span></span>
<span><span class="co">#&gt; year = -3 x cohort = 5     -1.0 (0.97)</span></span>
<span><span class="co">#&gt; year = -3 x cohort = 6     0.07 (0.65)</span></span>
<span><span class="co">#&gt; year = -3 x cohort = 7    -0.84 (0.80)</span></span>
<span><span class="co">#&gt; year = -3 x cohort = 8    -0.78 (0.70)</span></span>
<span><span class="co">#&gt; year = -3 x cohort = 9     0.81 (0.56)</span></span>
<span><span class="co">#&gt; year = -3 x cohort = 10    0.53 (0.32)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 3     0.04 (0.67)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 4     0.83 (0.86)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 5   -1.6** (0.53)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 6     0.31 (0.83)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 7    -0.56 (0.87)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 8     0.43 (0.31)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 9      1.2 (0.82)</span></span>
<span><span class="co">#&gt; year = -2 x cohort = 10  -0.002 (0.68)</span></span>
<span><span class="co">#&gt; att                     -1.1*** (0.21)</span></span>
<span><span class="co">#&gt; Fixed-Effects:          --------------</span></span>
<span><span class="co">#&gt; id                                 Yes</span></span>
<span><span class="co">#&gt; year                               Yes</span></span>
<span><span class="co">#&gt; _______________________ ______________</span></span>
<span><span class="co">#&gt; S.E.: Clustered                 by: id</span></span>
<span><span class="co">#&gt; Observations                       950</span></span>
<span><span class="co">#&gt; R2                             0.90982</span></span>
<span><span class="co">#&gt; Within R2                      0.87641</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre></div>
<p>Using the same syntax as <code>fixest</code></p>
<div class="sourceCode" id="cb477"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("kylebutts/fwlplot")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">fwlplot</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/fwlplot/man/fwl_plot.html">fwl_plot</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span>, data <span class="op">=</span> <span class="va">base_stagg</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/plot%20residuals-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb478"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/fwlplot/man/fwl_plot.html">fwl_plot</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">|</span> <span class="va">id</span> <span class="op">+</span> <span class="va">year</span>, data <span class="op">=</span> <span class="va">base_stagg</span>, n_sample <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/plot%20residuals-2.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb479"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/fwlplot/man/fwl_plot.html">fwl_plot</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">|</span> <span class="va">id</span> <span class="op">+</span> <span class="va">year</span>, data <span class="op">=</span> <span class="va">base_stagg</span>, n_sample <span class="op">=</span> <span class="fl">100</span>, fsplit <span class="op">=</span> <span class="op">~</span> <span class="va">treated</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/plot%20residuals-3.png" width="90%" style="display: block; margin: auto;"></div>
</div>
<div id="wooldridge2022simple" class="section level3" number="26.9.9">
<h3>
<span class="header-section-number">26.9.9</span> <span class="citation">Wooldridge (<a href="references.html#ref-wooldridge2022simple">2022</a>)</span><a class="anchor" aria-label="anchor" href="#wooldridge2022simple"><i class="fas fa-link"></i></a>
</h3>
<p>use <a href="https://grantmcdermott.com/etwfe/">etwfe</a>(Extended two-way Fixed Effects) <span class="citation">(<a href="references.html#ref-wooldridge2022simple">Wooldridge 2022</a>)</span></p>
</div>
<div id="doubly-robust-did" class="section level3" number="26.9.10">
<h3>
<span class="header-section-number">26.9.10</span> Doubly Robust DiD<a class="anchor" aria-label="anchor" href="#doubly-robust-did"><i class="fas fa-link"></i></a>
</h3>
<p>Also known as the locally efficient doubly robust DiD <span class="citation">(<a href="references.html#ref-sant2020doubly">Sant’Anna and Zhao 2020</a>)</span></p>
<p><a href="https://psantanna.com/DRDID/index.html">Code example by the authors</a></p>
<p>The package (not method) is rather limited application:</p>
<ul>
<li><p>Use OLS (cannot handle <code>glm</code>)</p></li>
<li><p>Canonical DiD only (cannot handle DDD).</p></li>
</ul>
<div class="sourceCode" id="cb480"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://psantanna.com/DRDID/">DRDID</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"nsw_long"</span><span class="op">)</span></span>
<span><span class="va">eval_lalonde_cps</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">nsw_long</span>, <span class="va">nsw_long</span><span class="op">$</span><span class="va">treated</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">nsw_long</span><span class="op">$</span><span class="va">sample</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">eval_lalonde_cps</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id year treated age educ black married nodegree dwincl      re74 hisp</span></span>
<span><span class="co">#&gt; 1  1 1975      NA  42   16     0       1        0     NA     0.000    0</span></span>
<span><span class="co">#&gt; 2  1 1978      NA  42   16     0       1        0     NA     0.000    0</span></span>
<span><span class="co">#&gt; 3  2 1975      NA  20   13     0       0        0     NA  2366.794    0</span></span>
<span><span class="co">#&gt; 4  2 1978      NA  20   13     0       0        0     NA  2366.794    0</span></span>
<span><span class="co">#&gt; 5  3 1975      NA  37   12     0       1        0     NA 25862.322    0</span></span>
<span><span class="co">#&gt; 6  3 1978      NA  37   12     0       1        0     NA 25862.322    0</span></span>
<span><span class="co">#&gt;   early_ra sample experimental         re</span></span>
<span><span class="co">#&gt; 1       NA      2            0     0.0000</span></span>
<span><span class="co">#&gt; 2       NA      2            0   100.4854</span></span>
<span><span class="co">#&gt; 3       NA      2            0  3317.4678</span></span>
<span><span class="co">#&gt; 4       NA      2            0  4793.7451</span></span>
<span><span class="co">#&gt; 5       NA      2            0 22781.8555</span></span>
<span><span class="co">#&gt; 6       NA      2            0 25564.6699</span></span>
<span></span>
<span></span>
<span><span class="co"># locally efficient doubly robust DiD Estimators for the ATT</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://psantanna.com/DRDID/reference/drdid.html">drdid</a></span><span class="op">(</span></span>
<span>        yname <span class="op">=</span> <span class="st">"re"</span>,</span>
<span>        tname <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>        idname <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>        dname <span class="op">=</span> <span class="st">"experimental"</span>,</span>
<span>        xformla <span class="op">=</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">black</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span> <span class="va">hisp</span> <span class="op">+</span> <span class="va">re74</span>,</span>
<span>        data <span class="op">=</span> <span class="va">eval_lalonde_cps</span>,</span>
<span>        panel <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Call:</span></span>
<span><span class="co">#&gt; drdid(yname = "re", tname = "year", idname = "id", dname = "experimental", </span></span>
<span><span class="co">#&gt;     xformla = ~age + educ + black + married + nodegree + hisp + </span></span>
<span><span class="co">#&gt;         re74, data = eval_lalonde_cps, panel = TRUE)</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------------</span></span>
<span><span class="co">#&gt;  Further improved locally efficient DR DID estimator for the ATT:</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;    ATT     Std. Error  t value    Pr(&gt;|t|)  [95% Conf. Interval] </span></span>
<span><span class="co">#&gt; -901.2703   393.6247   -2.2897     0.022    -1672.7747  -129.766 </span></span>
<span><span class="co">#&gt; ------------------------------------------------------------------</span></span>
<span><span class="co">#&gt;  Estimator based on panel data.</span></span>
<span><span class="co">#&gt;  Outcome regression est. method: weighted least squares.</span></span>
<span><span class="co">#&gt;  Propensity score est. method: inverse prob. tilting.</span></span>
<span><span class="co">#&gt;  Analytical standard error.</span></span>
<span><span class="co">#&gt; ------------------------------------------------------------------</span></span>
<span><span class="co">#&gt;  See Sant'Anna and Zhao (2020) for details.</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># Improved locally efficient doubly robust DiD estimator </span></span>
<span><span class="co"># for the ATT, with panel data</span></span>
<span><span class="co"># drdid_imp_panel()</span></span>
<span></span>
<span><span class="co"># Locally efficient doubly robust DiD estimator for the ATT, </span></span>
<span><span class="co"># with panel data</span></span>
<span><span class="co"># drdid_panel()</span></span>
<span></span>
<span><span class="co"># Locally efficient doubly robust DiD estimator for the ATT, </span></span>
<span><span class="co"># with repeated cross-section data</span></span>
<span><span class="co"># drdid_rc()</span></span>
<span></span>
<span><span class="co"># Improved locally efficient doubly robust DiD estimator for the ATT, </span></span>
<span><span class="co"># with repeated cross-section data</span></span>
<span><span class="co"># drdid_imp_rc()</span></span></code></pre></div>
</div>
</div>
<div id="multiple-treatment" class="section level2" number="26.10">
<h2>
<span class="header-section-number">26.10</span> Multiple Treatment<a class="anchor" aria-label="anchor" href="#multiple-treatment"><i class="fas fa-link"></i></a>
</h2>
<p>When you have 2 treatments in a setting, you should always try to model both of them under one regression to see whether they are significantly different.</p>
<ul>
<li>Never use one treated groups as control for the other, and run separate regression.</li>
<li>Could check this <a href="https://stats.stackexchange.com/questions/474533/difference-in-difference-with-two-treatment-groups-and-one-control-group-classi">answer</a>
</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
Y_{it} &amp;= \alpha + \gamma_1 Treat1_{i} + \gamma_2 Treat2_{i} + \lambda Post_t  \\
&amp;+ \delta_1(Treat1_i \times Post_t) + \delta_2(Treat2_i \times Post_t) + \epsilon_{it}
\end{aligned}
\]</span></p>
<p><span class="citation">(<a href="references.html#ref-fricke2017identification">Fricke 2017</a>)</span></p>
<p><span class="citation">(<a href="references.html#ref-de2023two">Clement De Chaisemartin and D’haultfœuille 2023</a>)</span> <a href="https://www.youtube.com/watch?v=UHeJoc27qEM&amp;ab_channel=TaylorWright">video</a> <a href="https://drive.google.com/file/d/156Fu73avBvvV_H64wePm7eW04V0jEG3K/view">code</a></p>
</div>
<div id="assumption-violation" class="section level2" number="26.11">
<h2>
<span class="header-section-number">26.11</span> Assumption Violation<a class="anchor" aria-label="anchor" href="#assumption-violation"><i class="fas fa-link"></i></a>
</h2>
<div id="endogenous-timing" class="section level3" number="26.11.1">
<h3>
<span class="header-section-number">26.11.1</span> Endogenous Timing<a class="anchor" aria-label="anchor" href="#endogenous-timing"><i class="fas fa-link"></i></a>
</h3>
<p>If the timing of units can be influenced by strategic decisions in a DID analysis, an instrumental variable approach with a control function can be used to control for endogeneity in timing.</p>
</div>
<div id="questionable-counterfactuals" class="section level3" number="26.11.2">
<h3>
<span class="header-section-number">26.11.2</span> Questionable Counterfactuals<a class="anchor" aria-label="anchor" href="#questionable-counterfactuals"><i class="fas fa-link"></i></a>
</h3>
<p>In situations where the control units may not serve as a reliable counterfactual for the treated units, matching methods such as propensity score matching or generalized random forest can be utilized. Additional methods can be found in <a href="matching-methods.html#matching-methods">Matching Methods</a>.</p>
</div>
</div>
<div id="mediation-under-did" class="section level2" number="26.12">
<h2>
<span class="header-section-number">26.12</span> Mediation Under DiD<a class="anchor" aria-label="anchor" href="#mediation-under-did"><i class="fas fa-link"></i></a>
</h2>
<p>Check this <a href="https://stats.stackexchange.com/questions/261218/difference-in-difference-model-with-mediators-estimating-the-effect-of-differen">post</a></p>
</div>
<div id="assumptions-3" class="section level2" number="26.13">
<h2>
<span class="header-section-number">26.13</span> Assumptions<a class="anchor" aria-label="anchor" href="#assumptions-3"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>
<p><strong>Parallel Trends</strong>: Difference between the treatment and control groups remain constant if there were no treatment.</p>
<ul>
<li>
<p>should be used in cases where</p>
<ul>
<li><p>you observe before and after an event</p></li>
<li><p>you have treatment and control groups</p></li>
</ul>
</li>
<li>
<p>not in cases where</p>
<ul>
<li><p>treatment is not random</p></li>
<li><p>confounders.</p></li>
</ul>
</li>
<li>
<p>To support we use</p>
<ul>
<li><p><a href="difference-in-differences.html#placebo-test">Placebo test</a></p></li>
<li><p><a href="difference-in-differences.html#prior-parallel-trends-test">Prior Parallel Trends Test</a></p></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Linear additive effects</strong> (of group/unit specific and time-specific):</p>
<ul>
<li><p>If they are not additively interact, we have to use the weighted 2FE estimator <span class="citation">(<a href="references.html#ref-imai2021use">Imai and Kim 2021</a>)</span></p></li>
<li><p>Typically seen in the <a href="difference-in-differences.html#staggered-dif-n-dif">Staggered Dif-n-dif</a></p></li>
</ul>
</li>
<li><p>No anticipation: There is no causal effect of the treatment before its implementation.</p></li>
</ul>
<p><strong>Possible issues</strong></p>
<ul>
<li>
<p>Estimate dependent on functional form:</p>
<ul>
<li>When the size of the response depends (nonlinearly) on the size of the intervention, we might want to look at the the difference in the group with high intensity vs. low.</li>
</ul>
</li>
<li>
<p>Selection on (time–varying) unobservables</p>
<ul>
<li>Can use the overall sensitivity of coefficient estimates to hidden bias using <a href="matching-methods.html#rosenbaum-bounds">Rosenbaum Bounds</a>
</li>
</ul>
</li>
<li>
<p>Long-term effects</p>
<ul>
<li>Parallel trends are more likely to be observed over shorter period (window of observation)</li>
</ul>
</li>
<li>
<p>Heterogeneous effects</p>
<ul>
<li>Different intensity (e.g., doses) for different groups.</li>
</ul>
</li>
<li>
<p>Ashenfelter dip <span class="citation">(<a href="references.html#ref-ashenfelter1985">Ashenfelter and Card 1985</a>)</span> (job training program participant are more likely to experience an earning drop prior enrolling in these programs)</p>
<ul>
<li>Participants are systemically different from nonparticipants before the treatment, leading to the question of permanent or transitory changes.</li>
<li>A fix to this transient endogeneity is to calculate long-run differences (exclude a number of periods symmetrically around the adoption/ implementation date). If we see a sustained impact, then we have strong evidence for the causal impact of a policy. <span class="citation">(<a href="references.html#ref-proserpio2017">Proserpio and Zervas 2017b</a>)</span> <span class="citation">(<a href="references.html#ref-heckman1999c">James J. Heckman and Smith 1999</a>)</span> <span class="citation">(<a href="references.html#ref-jepsen2014">Jepsen, Troske, and Coomes 2014</a>)</span> <span class="citation">(<a href="references.html#ref-li2011">X. Li, Gan, and Hu 2011</a>)</span>
</li>
</ul>
</li>
<li>
<p>Response to event might not be immediate (can’t be observed right away in the dependent variable)</p>
<ul>
<li>Using lagged dependent variable <span class="math inline">\(Y_{it-1}\)</span> might be more appropriate <span class="citation">(<a href="references.html#ref-blundell1998initial">Blundell and Bond 1998</a>)</span>
</li>
</ul>
</li>
<li><p>Other factors that affect the difference in trends between the two groups (i.e., treatment and control) will bias your estimation.</p></li>
<li><p>Correlated observations within a group or time</p></li>
<li><p>Incidental parameters problems <span class="citation">(<a href="references.html#ref-lancaster2000incidental">Lancaster 2000</a>)</span>: it’s always better to use individual and time fixed effect.</p></li>
<li><p>When examining the effects of variation in treatment timing, we have to be careful because negative weights (per group) can be negative if there is a heterogeneity in the treatment effects over time. Example: [<span class="citation">Athey and Imbens (<a href="references.html#ref-athey2022design">2022</a>)</span>]<span class="citation">(<a href="references.html#ref-borusyak2021revisiting">Borusyak, Jaravel, and Spiess 2021</a>)</span><span class="citation">(<a href="references.html#ref-goodman2021difference">Goodman-Bacon 2021</a>)</span>. In this case you should use new estimands proposed by <a href="difference-in-differences.html#callaway2021difference">@callaway2021difference</a><span class="citation">(<a href="references.html#ref-de2020two">Clément De Chaisemartin and d’Haultfoeuille 2020</a>)</span>, in the <code>did</code> package. If you expect lags and leads, see <span class="citation">(<a href="references.html#ref-sun2021estimating">L. Sun and Abraham 2021</a>)</span></p></li>
<li><p><span class="citation">(<a href="references.html#ref-gibbons2018broken">Gibbons, Suárez Serrato, and Urbancic 2018</a>)</span> caution when we suspect the treatment effect and treatment variance vary across groups</p></li>
</ul>
<div id="prior-parallel-trends-test" class="section level3" number="26.13.1">
<h3>
<span class="header-section-number">26.13.1</span> Prior Parallel Trends Test<a class="anchor" aria-label="anchor" href="#prior-parallel-trends-test"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>Plot the average outcomes over time for both treatment and control group before and after the treatment in time.</li>
<li>Statistical test for difference in trends (<strong>using data from before the treatment period</strong>)</li>
</ol>
<p><span class="math display">\[
Y = \alpha_g + \beta_1 T + \beta_2 T\times G + \epsilon
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(Y\)</span> = the outcome variable</p></li>
<li><p><span class="math inline">\(\alpha_g\)</span> = group fixed effects</p></li>
<li><p><span class="math inline">\(T\)</span> = time (e.g., specific year, or month)</p></li>
<li><p><span class="math inline">\(\beta_2\)</span> = different time trends for each group</p></li>
</ul>
<p>Hence, if <span class="math inline">\(\beta_2 =0\)</span> provides evidence that there are no differences in the trend for the two groups prior the time treatment.</p>
<p>You can also use different functional forms (e..g, polynomial or nonlinear).</p>
<p>If <span class="math inline">\(\beta_2 \neq 0\)</span> statistically, possible reasons can be:</p>
<ul>
<li><p>Statistical significance can be driven by large sample</p></li>
<li><p>Or the trends are so consistent, and just one period deviation can throw off the trends. Hence, statistical statistical significance.</p></li>
</ul>
<p>Technically, we can still salvage the research by including time fixed effects, instead of just the before-and-after time fixed effect (actually, most researchers do this mechanically anyway nowadays). However, a side effect can be that the time fixed effects can also absorb some part your treatment effect as well, especially in cases where the treatment effects vary with time (i.e., stronger or weaker over time) <span class="citation">(<a href="references.html#ref-wolfers2003business">Wolfers 2003</a>)</span>.</p>
<p>Debate:</p>
<ul>
<li>
<p><span class="citation">(<a href="references.html#ref-kahn2020promise">Kahn-Lang and Lang 2020</a>)</span> argue that DiD will be more plausible when the treatment and control groups are similar not only in <strong>trends</strong>, but also in <strong>levels</strong>. Because when we observe dissimilar in levels prior to the treatment, why is it okay to think that this will not affect future trends?</p>
<ul>
<li><p>Show a plot of the dependent variable’s time series for treated and control groups and also a similar plot with matched sample. <span class="citation">(<a href="references.html#ref-ryan2019now">Ryan et al. 2019</a>)</span> show evidence of matched DiD did well in the setting of non-parallel trends (at least in health care setting).</p></li>
<li><p>In the case that we don’t have similar levels ex ante between treatment and control groups, functional form assumptions matter and we need justification for our choice.</p></li>
</ul>
</li>
<li>
<p>Pre-trend statistical tests: <span class="citation">(<a href="references.html#ref-roth2022pretest">Roth 2022</a>)</span> provides evidence that these test are usually under powered.</p>
<ul>
<li>See <a href="https://github.com/jonathandroth/PretrendsPower">PretrendsPower</a> and <a href="https://github.com/jonathandroth/pretrends">pretrends</a> packages for correcting this.</li>
</ul>
</li>
<li>
<p>Parallel trends assumption is specific to both the transformation and units of the outcome <span class="citation">(<a href="references.html#ref-roth2023parallel">Roth and Sant’Anna 2023</a>)</span></p>
<ul>
<li>See falsification test (<span class="math inline">\(H_0\)</span>: parallel trends is insensitive to functional form).</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb481"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="va">od</span> <span class="op">&lt;-</span> <span class="fu">causaldata</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/causaldata/man/organ_donations.html">organ_donations</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># Use only pre-treatment data</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Quarter_Num</span> <span class="op">&lt;=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co"># Treatment variable</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>California <span class="op">=</span> <span class="va">State</span> <span class="op">==</span> <span class="st">'California'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># use my package</span></span>
<span><span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/plot_par_trends.html">plot_par_trends</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">od</span>,</span>
<span>    metrics_and_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"Rate"</span> <span class="op">=</span> <span class="st">"Rate"</span><span class="op">)</span>,</span>
<span>    treatment_status_var <span class="op">=</span> <span class="st">"California"</span>,</span>
<span>    time_var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Quarter_Num <span class="op">=</span> <span class="st">"Time"</span><span class="op">)</span>,</span>
<span>    display_CI <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-50-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb482"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># do it manually</span></span>
<span><span class="co"># always good but plot the dependent out</span></span>
<span><span class="va">od</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># group by treatment status and time</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">California</span>, <span class="va">Quarter</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarize_all</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># view()</span></span>
<span>    </span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Quarter_Num</span>, y <span class="op">=</span> <span class="va">Rate</span>, color <span class="op">=</span> <span class="va">California</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">causalverse</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/causalverse/man/ama_theme.html">ama_theme</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-50-2.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb483"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co"># but it's also important to use statistical test</span></span>
<span><span class="va">prior_trend</span> <span class="op">&lt;-</span> <span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">Rate</span> <span class="op">~</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/i.html">i</a></span><span class="op">(</span><span class="va">Quarter_Num</span>, <span class="va">California</span><span class="op">)</span> <span class="op">|</span> <span class="va">State</span> <span class="op">+</span> <span class="va">Quarter</span>,</span>
<span>               data <span class="op">=</span> <span class="va">od</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">coefplot</a></span><span class="op">(</span><span class="va">prior_trend</span>, grid <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-50-3.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb484"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">iplot</a></span><span class="op">(</span><span class="va">prior_trend</span>, grid <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="26-dif-in-dif_files/figure-html/unnamed-chunk-50-4.png" width="90%" style="display: block; margin: auto;"></div>
<p>This is alarming since one of the periods is significantly different from 0, which means that our parallel trends assumption is not plausible.</p>
<p>In cases where you might have violations of parallel trends assumption, check <span class="citation">(<a href="references.html#ref-rambachan2023more">Rambachan and Roth 2023</a>)</span></p>
<ul>
<li><p>Impose restrictions on how different the post-treatment violations of parallel trends can be from the pre-trends.</p></li>
<li><p>Partial identification of causal parameter</p></li>
<li><p>Sensitivity analysis</p></li>
</ul>
<div class="sourceCode" id="cb485"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># https://github.com/asheshrambachan/HonestDiD</span></span>
<span><span class="co"># remotes::install_github("asheshrambachan/HonestDiD")</span></span>
<span><span class="co"># library(HonestDiD)</span></span></code></pre></div>
<p>Alternatively, <span class="citation">Ban and Kedagni (<a href="references.html#ref-ban2022generalized">2022</a>)</span> propose a method that with an information set (i.e., pre-treatment covariates), and an assumption on the selection bias in the post-treatment period (i.e., lies within the convex hull of all selection biases), they can still identify a set of ATT, and with stricter assumption on selection bias from the policymakers perspective, they can also have a point estimate.</p>
<p>Alternatively, we can use the <code>pretrends</code> package to examine our assumptions <span class="citation">(<a href="references.html#ref-roth2022pretest">Roth 2022</a>)</span></p>
</div>
<div id="placebo-test-1" class="section level3" number="26.13.2">
<h3>
<span class="header-section-number">26.13.2</span> Placebo Test<a class="anchor" aria-label="anchor" href="#placebo-test-1"><i class="fas fa-link"></i></a>
</h3>
<p>Procedure:</p>
<ol style="list-style-type: decimal">
<li>Sample data only in the period before the treatment in time.</li>
<li>Consider different fake cutoff in time, either
<ol style="list-style-type: decimal">
<li><p>Try the whole sequence in time</p></li>
<li><p>Generate random treatment period, and use <strong>randomization inference</strong> to account for sampling distribution of the fake effect.</p></li>
</ol>
</li>
<li>Estimate the DiD model but with the post-time = 1 with the fake cutoff</li>
<li>A significant DiD coefficient means that you violate the parallel trends! You have a big problem.</li>
</ol>
<p>Alternatively,</p>
<ul>
<li>When data have multiple control groups, drop the treated group, and assign another control group as a “fake” treated group. But even if it fails (i.e., you find a significant DiD effect) among the control groups, it can still be fine. However, this method is used under <a href="synthetic-control.html#synthetic-control">Synthetic Control</a>
</li>
</ul>
<p><a href="https://theeffectbook.net/ch-DifferenceinDifference.html">Code by theeffectbook.net</a></p>
<div class="sourceCode" id="cb486"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">od</span> <span class="op">&lt;-</span> <span class="fu">causaldata</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/causaldata/man/organ_donations.html">organ_donations</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># Use only pre-treatment data</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Quarter_Num</span> <span class="op">&lt;=</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span>    <span class="co"># Create fake treatment variables</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        FakeTreat1 <span class="op">=</span> <span class="va">State</span> <span class="op">==</span> <span class="st">'California'</span> <span class="op">&amp;</span></span>
<span>            <span class="va">Quarter</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Q12011'</span>, <span class="st">'Q22011'</span><span class="op">)</span>,</span>
<span>        FakeTreat2 <span class="op">=</span> <span class="va">State</span> <span class="op">==</span> <span class="st">'California'</span> <span class="op">&amp;</span></span>
<span>            <span class="va">Quarter</span> <span class="op">==</span> <span class="st">'Q22011'</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">clfe1</span> <span class="op">&lt;-</span> <span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">Rate</span> <span class="op">~</span> <span class="va">FakeTreat1</span> <span class="op">|</span> <span class="va">State</span> <span class="op">+</span> <span class="va">Quarter</span>,</span>
<span>               data <span class="op">=</span> <span class="va">od</span><span class="op">)</span></span>
<span><span class="va">clfe2</span> <span class="op">&lt;-</span> <span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">Rate</span> <span class="op">~</span> <span class="va">FakeTreat2</span> <span class="op">|</span> <span class="va">State</span> <span class="op">+</span> <span class="va">Quarter</span>,</span>
<span>               data <span class="op">=</span> <span class="va">od</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/etable.html">etable</a></span><span class="op">(</span><span class="va">clfe1</span>,<span class="va">clfe2</span><span class="op">)</span></span>
<span><span class="co">#&gt;                           clfe1            clfe2</span></span>
<span><span class="co">#&gt; Dependent Var.:            Rate             Rate</span></span>
<span><span class="co">#&gt;                                                 </span></span>
<span><span class="co">#&gt; FakeTreat1TRUE  0.0061 (0.0051)                 </span></span>
<span><span class="co">#&gt; FakeTreat2TRUE                  -0.0017 (0.0028)</span></span>
<span><span class="co">#&gt; Fixed-Effects:  --------------- ----------------</span></span>
<span><span class="co">#&gt; State                       Yes              Yes</span></span>
<span><span class="co">#&gt; Quarter                     Yes              Yes</span></span>
<span><span class="co">#&gt; _______________ _______________ ________________</span></span>
<span><span class="co">#&gt; S.E.: Clustered       by: State        by: State</span></span>
<span><span class="co">#&gt; Observations                 81               81</span></span>
<span><span class="co">#&gt; R2                      0.99377          0.99376</span></span>
<span><span class="co">#&gt; Within R2               0.00192          0.00015</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre></div>
<p>We would like the “supposed” DiD to be insignificant.</p>
<p><strong>Robustness Check</strong></p>
<ul>
<li>
<p>Placebo DiD (if the DiD estimate <span class="math inline">\(\neq 0\)</span>, parallel trend is violated, and original DiD is biased):</p>
<ul>
<li><p>Group: Use fake treatment groups: A population that was <strong>not</strong> affect by the treatment</p></li>
<li><p>Time: Redo the DiD analysis for period before the treatment (expected treatment effect is 0) (e..g, for previous year or period).</p></li>
</ul>
</li>
<li><p>Possible alternative control group: Expected results should be similar</p></li>
<li><p>Try different windows (further away from the treatment point, other factors can creep in and nullify your effect).</p></li>
<li><p>Treatment Reversal (what if we don’t see the treatment event)</p></li>
<li><p>Higher-order polynomial time trend (to relax linearity assumption)</p></li>
<li>
<p>Test whether other dependent variables that should not be affected by the event are indeed unaffected.</p>
<ul>
<li>Use the same control and treatment period (DiD <span class="math inline">\(\neq0\)</span>, there is a problem)</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="synthetic-difference-in-differences.html"><span class="header-section-number">25</span> Synthetic Difference-in-Differences</a></div>
<div class="next"><a href="synthetic-control.html"><span class="header-section-number">27</span> Synthetic Control</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#difference-in-differences"><span class="header-section-number">26</span> Difference-in-differences</a></li>
<li><a class="nav-link" href="#visualization-1"><span class="header-section-number">26.1</span> Visualization</a></li>
<li><a class="nav-link" href="#simple-dif-n-dif"><span class="header-section-number">26.2</span> Simple Dif-n-dif</a></li>
<li><a class="nav-link" href="#notes-1"><span class="header-section-number">26.3</span> Notes</a></li>
<li><a class="nav-link" href="#standard-errors-2"><span class="header-section-number">26.4</span> Standard Errors</a></li>
<li>
<a class="nav-link" href="#examples"><span class="header-section-number">26.5</span> Examples</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#example-by-doleac2020unintended"><span class="header-section-number">26.5.1</span> Example by Doleac and Hansen (2020)</a></li>
<li><a class="nav-link" href="#example-from-princeton"><span class="header-section-number">26.5.2</span> Example from Princeton</a></li>
<li><a class="nav-link" href="#example-by-card1993minimum"><span class="header-section-number">26.5.3</span> Example by Card and Krueger (1993)</a></li>
<li><a class="nav-link" href="#example-by-butcher2014effects"><span class="header-section-number">26.5.4</span> Example by Butcher, McEwan, and Weerapana (2014)</a></li>
</ul>
</li>
<li><a class="nav-link" href="#one-difference"><span class="header-section-number">26.6</span> One Difference</a></li>
<li><a class="nav-link" href="#two-way-fixed-effects"><span class="header-section-number">26.7</span> Two-way Fixed-effects</a></li>
<li><a class="nav-link" href="#multiple-periods-and-variation-in-treatment-timing"><span class="header-section-number">26.8</span> Multiple periods and variation in treatment timing</a></li>
<li>
<a class="nav-link" href="#staggered-dif-n-dif"><span class="header-section-number">26.9</span> Staggered Dif-n-dif</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#assumptions-2"><span class="header-section-number">26.9.1</span> Assumptions</a></li>
<li><a class="nav-link" href="#stacked-did"><span class="header-section-number">26.9.2</span> Stacked DID</a></li>
<li><a class="nav-link" href="#goodman-bacon-decomposition"><span class="header-section-number">26.9.3</span> Goodman-Bacon Decomposition</a></li>
<li><a class="nav-link" href="#did-with-in-and-out-treatment-condition"><span class="header-section-number">26.9.4</span> DID with in and out treatment condition</a></li>
<li><a class="nav-link" href="#gardner2022two-and-borusyak2021revisiting"><span class="header-section-number">26.9.5</span> Gardner (2022) and Borusyak, Jaravel, and Spiess (2021)</a></li>
<li><a class="nav-link" href="#de2020two"><span class="header-section-number">26.9.6</span> Clément De Chaisemartin and d’Haultfoeuille (2020)</a></li>
<li><a class="nav-link" href="#callaway2021difference"><span class="header-section-number">26.9.7</span> Callaway and Sant’Anna (2021)</a></li>
<li><a class="nav-link" href="#sun2021estimating"><span class="header-section-number">26.9.8</span> L. Sun and Abraham (2021)</a></li>
<li><a class="nav-link" href="#wooldridge2022simple"><span class="header-section-number">26.9.9</span> Wooldridge (2022)</a></li>
<li><a class="nav-link" href="#doubly-robust-did"><span class="header-section-number">26.9.10</span> Doubly Robust DiD</a></li>
</ul>
</li>
<li><a class="nav-link" href="#multiple-treatment"><span class="header-section-number">26.10</span> Multiple Treatment</a></li>
<li>
<a class="nav-link" href="#assumption-violation"><span class="header-section-number">26.11</span> Assumption Violation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#endogenous-timing"><span class="header-section-number">26.11.1</span> Endogenous Timing</a></li>
<li><a class="nav-link" href="#questionable-counterfactuals"><span class="header-section-number">26.11.2</span> Questionable Counterfactuals</a></li>
</ul>
</li>
<li><a class="nav-link" href="#mediation-under-did"><span class="header-section-number">26.12</span> Mediation Under DiD</a></li>
<li>
<a class="nav-link" href="#assumptions-3"><span class="header-section-number">26.13</span> Assumptions</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#prior-parallel-trends-test"><span class="header-section-number">26.13.1</span> Prior Parallel Trends Test</a></li>
<li><a class="nav-link" href="#placebo-test-1"><span class="header-section-number">26.13.2</span> Placebo Test</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/mikenguyen13/data_analysis/blob/main/26-dif-in-dif.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/mikenguyen13/data_analysis/edit/main/26-dif-in-dif.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>A Guide on Data Analysis</strong>" was written by Mike Nguyen. It was last built on 2024-04-11.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
