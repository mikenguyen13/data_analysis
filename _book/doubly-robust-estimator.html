<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 30 Doubly Robust Estimator | A Guide on Data Analysis</title>
<meta name="author" content="Mike Nguyen">
<meta name="description" content="Without random assignment, we can either use Inverse propensity weighting estimator linear regression Intuition (based on a logistic regression of the likelihood of receiving the treatment). In...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 30 Doubly Robust Estimator | A Guide on Data Analysis">
<meta property="og:type" content="book">
<meta property="og:url" content="https://bookdown.org/mike/data_analysis/doubly-robust-estimator.html">
<meta property="og:image" content="https://bookdown.org/mike/data_analysis//images/cover.jpg">
<meta property="og:description" content="Without random assignment, we can either use Inverse propensity weighting estimator linear regression Intuition (based on a logistic regression of the likelihood of receiving the treatment). In...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 30 Doubly Robust Estimator | A Guide on Data Analysis">
<meta name="twitter:description" content="Without random assignment, we can either use Inverse propensity weighting estimator linear regression Intuition (based on a logistic regression of the likelihood of receiving the treatment). In...">
<meta name="twitter:image" content="https://bookdown.org/mike/data_analysis//images/cover.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><script src="libs/proj4js-2.3.15/proj4.js"></script><link href="libs/highcharts-9.3.1/css/motion.css" rel="stylesheet">
<script src="libs/highcharts-9.3.1/highcharts.js"></script><script src="libs/highcharts-9.3.1/highcharts-3d.js"></script><script src="libs/highcharts-9.3.1/highcharts-more.js"></script><script src="libs/highcharts-9.3.1/modules/stock.js"></script><script src="libs/highcharts-9.3.1/modules/map.js"></script><script src="libs/highcharts-9.3.1/modules/data.js"></script><script src="libs/highcharts-9.3.1/modules/exporting.js"></script><script src="libs/highcharts-9.3.1/modules/offline-exporting.js"></script><script src="libs/highcharts-9.3.1/modules/drilldown.js"></script><script src="libs/highcharts-9.3.1/modules/item-series.js"></script><script src="libs/highcharts-9.3.1/modules/overlapping-datalabels.js"></script><script src="libs/highcharts-9.3.1/modules/annotations.js"></script><script src="libs/highcharts-9.3.1/modules/export-data.js"></script><script src="libs/highcharts-9.3.1/modules/funnel.js"></script><script src="libs/highcharts-9.3.1/modules/heatmap.js"></script><script src="libs/highcharts-9.3.1/modules/treemap.js"></script><script src="libs/highcharts-9.3.1/modules/sankey.js"></script><script src="libs/highcharts-9.3.1/modules/dependency-wheel.js"></script><script src="libs/highcharts-9.3.1/modules/organization.js"></script><script src="libs/highcharts-9.3.1/modules/solid-gauge.js"></script><script src="libs/highcharts-9.3.1/modules/streamgraph.js"></script><script src="libs/highcharts-9.3.1/modules/sunburst.js"></script><script src="libs/highcharts-9.3.1/modules/vector.js"></script><script src="libs/highcharts-9.3.1/modules/wordcloud.js"></script><script src="libs/highcharts-9.3.1/modules/xrange.js"></script><script src="libs/highcharts-9.3.1/modules/tilemap.js"></script><script src="libs/highcharts-9.3.1/modules/venn.js"></script><script src="libs/highcharts-9.3.1/modules/gantt.js"></script><script src="libs/highcharts-9.3.1/modules/timeline.js"></script><script src="libs/highcharts-9.3.1/modules/parallel-coordinates.js"></script><script src="libs/highcharts-9.3.1/modules/bullet.js"></script><script src="libs/highcharts-9.3.1/modules/coloraxis.js"></script><script src="libs/highcharts-9.3.1/modules/dumbbell.js"></script><script src="libs/highcharts-9.3.1/modules/lollipop.js"></script><script src="libs/highcharts-9.3.1/modules/series-label.js"></script><script src="libs/highcharts-9.3.1/plugins/motion.js"></script><script src="libs/highcharts-9.3.1/custom/reset.js"></script><script src="libs/highcharts-9.3.1/modules/boost.js"></script><script src="libs/highchart-binding-0.9.4/highchart.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){window.dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-DMNX2X65HQ');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">A Guide on Data Analysis</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="prerequisites.html"><span class="header-section-number">2</span> Prerequisites</a></li>
<li class="book-part">I. BASIC</li>
<li><a class="" href="descriptive-stat.html"><span class="header-section-number">3</span> Descriptive Statistics</a></li>
<li><a class="" href="basic-statistical-inference.html"><span class="header-section-number">4</span> Basic Statistical Inference</a></li>
<li class="book-part">II. REGRESSION</li>
<li><a class="" href="linear-regression.html"><span class="header-section-number">5</span> Linear Regression</a></li>
<li><a class="" href="non-linear-regression.html"><span class="header-section-number">6</span> Non-linear Regression</a></li>
<li><a class="" href="generalized-linear-models.html"><span class="header-section-number">7</span> Generalized Linear Models</a></li>
<li><a class="" href="linear-mixed-models.html"><span class="header-section-number">8</span> Linear Mixed Models</a></li>
<li><a class="" href="nonlinear-and-generalized-linear-mixed-models.html"><span class="header-section-number">9</span> Nonlinear and Generalized Linear Mixed Models</a></li>
<li class="book-part">III. RAMIFICATIONS</li>
<li><a class="" href="model-specification.html"><span class="header-section-number">10</span> Model Specification</a></li>
<li><a class="" href="imputation-missing-data.html"><span class="header-section-number">11</span> Imputation (Missing Data)</a></li>
<li><a class="" href="data.html"><span class="header-section-number">12</span> Data</a></li>
<li><a class="" href="hypothesis-testing.html"><span class="header-section-number">13</span> Hypothesis Testing</a></li>
<li><a class="" href="prediction-and-estimation.html"><span class="header-section-number">14</span> Prediction and Estimation</a></li>
<li><a class="" href="moderation.html"><span class="header-section-number">15</span> Moderation</a></li>
<li><a class="" href="bootstrap.html"><span class="header-section-number">16</span> Bootstrap</a></li>
<li class="book-part">IV. CAUSAL INFERENCE</li>
<li><a class="" href="causal-inference.html"><span class="header-section-number">17</span> Causal Inference</a></li>
<li class="book-part">A. EXPERIMENTAL DESIGN</li>
<li><a class="" href="experimental-design.html"><span class="header-section-number">18</span> Experimental Design</a></li>
<li><a class="" href="sampling.html"><span class="header-section-number">19</span> Sampling</a></li>
<li><a class="" href="analysis-of-variance-anova.html"><span class="header-section-number">20</span> Analysis of Variance (ANOVA)</a></li>
<li><a class="" href="multivariate-methods.html"><span class="header-section-number">21</span> Multivariate Methods</a></li>
<li class="book-part">B. QUASI-EXPERIMENTAL DESIGN</li>
<li><a class="" href="quasi-experimental.html"><span class="header-section-number">22</span> Quasi-experimental</a></li>
<li><a class="" href="regression-discontinuity.html"><span class="header-section-number">23</span> Regression Discontinuity</a></li>
<li><a class="" href="difference-in-differences.html"><span class="header-section-number">24</span> Difference-in-differences</a></li>
<li><a class="" href="synthetic-control.html"><span class="header-section-number">25</span> Synthetic Control</a></li>
<li><a class="" href="panel-data-methods.html"><span class="header-section-number">26</span> Panel Data Methods</a></li>
<li><a class="" href="event-studies.html"><span class="header-section-number">27</span> Event Studies</a></li>
<li><a class="" href="matching-methods.html"><span class="header-section-number">28</span> Matching Methods</a></li>
<li><a class="" href="interrupted-time-series.html"><span class="header-section-number">29</span> Interrupted Time Series</a></li>
<li class="book-part">C. OTHER CONCERNS</li>
<li><a class="active" href="doubly-robust-estimator.html"><span class="header-section-number">30</span> Doubly Robust Estimator</a></li>
<li><a class="" href="endogeneity.html"><span class="header-section-number">31</span> Endogeneity</a></li>
<li><a class="" href="mediation.html"><span class="header-section-number">32</span> Mediation</a></li>
<li><a class="" href="directed-acyclic-graph.html"><span class="header-section-number">33</span> Directed Acyclic Graph</a></li>
<li class="book-part">V. MISCELLANEOUS</li>
<li><a class="" href="report.html"><span class="header-section-number">34</span> Report</a></li>
<li><a class="" href="exploratory-data-analysis.html"><span class="header-section-number">35</span> Exploratory Data Analysis</a></li>
<li><a class="" href="sensitivity-analysis-robustness-check.html"><span class="header-section-number">36</span> Sensitivity Analysis/ Robustness Check</a></li>
<li class="book-part">APPENDIX</li>
<li><a class="" href="appendix.html"><span class="header-section-number">A</span> Appendix</a></li>
<li><a class="" href="bookdown-cheat-sheet.html"><span class="header-section-number">B</span> Bookdown cheat sheet</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/mikenguyen13/data_analysis">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="doubly-robust-estimator" class="section level1" number="30">
<h1>
<span class="header-section-number">30</span> Doubly Robust Estimator<a class="anchor" aria-label="anchor" href="#doubly-robust-estimator"><i class="fas fa-link"></i></a>
</h1>
<p>Without random assignment, we can either use</p>
<div class="inline-table"><table style="width:100%;" class="table table-sm">
<colgroup>
<col width="5%">
<col width="65%">
<col width="28%">
</colgroup>
<thead><tr class="header">
<th></th>
<th>Inverse propensity weighting estimator</th>
<th>linear regression</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Intuition</td>
<td>(based on a logistic regression of the likelihood of receiving the treatment). In words, we try to reweight each observation based on its probability of receiving the treatment to make your sample as close to a randomized experiment.</td>
<td>linear regression with some variables and treatment assignment variable to model the outcome directly</td>
</tr>
<tr class="even">
<td>Leverage</td>
<td>Logistic Regression</td>
<td>Linear Regression</td>
</tr>
<tr class="odd">
<td>When does it fail?</td>
<td>When the propensity score model is incorrectly specified (e.g., missing variables)</td>
<td>When the outcome model is incorrectly specified (e.g., missing variables)</td>
</tr>
</tbody>
</table></div>
<p>But in both cases if you miss some variables (i.e., omitted variable bias) will bias your estimates.</p>
<p>The solution is to combine both approaches to form doubly robust estimator.</p>
<p>In this case you only need one of them to work, not both (known as the doubly robustness property)</p>
<p>To read a more technical introduction, see <span class="citation">(<a href="references.html#ref-funk2011" role="doc-biblioref">Funk et al. 2011</a>)</span> and <span class="citation">(<a href="references.html#ref-lunceford2017" role="doc-biblioref">Lunceford 2017</a>)</span></p>
<p>Extension include:</p>
<ul>
<li><p>Panel data: <span class="citation">(<a href="references.html#ref-arkhangelsky2021" role="doc-biblioref">Arkhangelsky and Imbens 2021</a>)</span></p></li>
<li><p>Instrumental variable: <span class="citation">(<a href="references.html#ref-okui2012" role="doc-biblioref">Okui et al. 2012</a>)</span></p></li>
<li><p>Dif-n-dif: <span class="citation">(<a href="references.html#ref-santanna2020" role="doc-biblioref">Santâ€™Anna and Zhao 2020</a>)</span></p></li>
</ul>
<div id="regression-adjustments" class="section level2" number="30.1">
<h2>
<span class="header-section-number">30.1</span> Regression Adjustments<a class="anchor" aria-label="anchor" href="#regression-adjustments"><i class="fas fa-link"></i></a>
</h2>
<p>With the unconfoundedness assumption (i.e., potential outcomes given some characteristics are independent of the treatment)</p>
<p><span class="math display">\[
[\{Y_i(0)), Y_i(1)\} \perp T_i] | X_i
\]</span></p>
<p>then the <a href="causal-inference.html#average-treatment-effects">Average Treatment Effects</a> will be</p>
<p><span class="math display">\[
\begin{aligned}
\tau &amp;= E[Y_i(1) - Y_i(0)] \\
&amp;= E[E[Y_i(1) |X_i - E[Y_i(0)|X_i]] \\
&amp;= E[E[Y_i |X_i, T= 1] - E[Y_i|X_i, T_1 = 0]] &amp;&amp; \text{unconfoundedness}\\
&amp;= E[\mu_1(X_i) - \mu_0(X_i)]
\end{aligned}
\]</span></p>
<p>With <strong>linearity assumption</strong>, we can use OLS to estimate <span class="math inline">\(\mu_1(X_i)\)</span> and <span class="math inline">\(\mu_0(X_i)\)</span> by</p>
<p><span class="math display">\[
Y_i = \mathbf{\beta}_0 X_i \text{ subset } T_i = 0 \\
Y_i = \mathbf{\beta}_1 X_i \text{ subset } T_i = 1
\]</span></p>
<p>and the estimate of <span class="math inline">\(\tau\)</span> becomes</p>
<p><span class="math display">\[
\begin{aligned}
\hat{\tau} &amp;= \frac{1}{n} \sum_{i=1}^n (\hat{\mu}_1 (X_i) - \hat{\mu}_0(X_i)) \\
&amp;= (\hat{\beta}_1 - \hat{\beta}_0 ) \bar{X}
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(\bar{X} = \frac{\sum_{i=1}^n X_i}{n}\)</span> (including an intercept)</p>
<p>Alternatively, to avoid the <strong>linearity assumption</strong>, we can use non-parametric approach (i.e., machine learning) to estimate <span class="math inline">\(\mu_1(X_i)\)</span> and <span class="math inline">\(\mu_0(X_i)\)</span></p>
<p><strong>Simulation</strong></p>
<p>Create functions to generate linear, nonlinear and experimental (random) data</p>
<div class="sourceCode" id="cb450"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># linear setting</span>
<span class="va">simu_ob_linear_df</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">{</span>
    <span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
    <span class="va">x2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
    <span class="va">xb</span> <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">x1</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">x2</span> 
    <span class="co"># probability of treatment is dependent on x1 and x2</span>
    <span class="va">prob_treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">xb</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">xb</span><span class="op">)</span><span class="op">)</span>
    <span class="va">treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="va">prob_treatment</span><span class="op">)</span>
    
    <span class="va">outcome</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="fl">5</span> <span class="op">*</span> <span class="va">treatment</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span>, <span class="va">prob_treatment</span>,  <span class="va">treatment</span>, <span class="va">outcome</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># experimental setting (random treatment assignment)</span>
<span class="va">simu_exp_df</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">{</span>
    <span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
    <span class="va">x2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
    <span class="va">xb</span> <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">x1</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">x2</span> 
    <span class="co"># probability of treatment is not dependent on x1 and x2</span>
    <span class="va">treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span> <span class="co"># prob treatment = random = 0.5</span>
    
    <span class="va">outcome</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="fl">5</span> <span class="op">*</span> <span class="va">treatment</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span>, <span class="va">treatment</span>, <span class="va">outcome</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># non-linear setting</span>
<span class="va">simu_exp_nonlinear_df</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">{</span>
    <span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
    <span class="va">x2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
    <span class="va">xb</span> <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">x1</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">x2</span> 
    <span class="co"># probability of treatment is  dependent on x1 and x2 nonlinearly</span>
    <span class="va">prob_treatment</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">xb</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span>
    <span class="va">treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="va">prob_treatment</span><span class="op">)</span>
    
    
    <span class="va">outcome</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="op">+</span> <span class="va">x1</span><span class="op">^</span><span class="fl">3</span> <span class="op">+</span> <span class="va">x2</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">5</span> <span class="op">*</span> <span class="va">treatment</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span>, <span class="va">treatment</span>, <span class="va">outcome</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">linear_df</span> <span class="op">&lt;-</span> <span class="fu">simu_ob_linear_df</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>
<span class="va">nonlinear_df</span> <span class="op">&lt;-</span> <span class="fu">simu_exp_nonlinear_df</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></code></pre></div>
<p>See OLS result as an example</p>
<div class="sourceCode" id="cb451"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sandwich.R-Forge.R-project.org/">sandwich</a></span><span class="op">)</span>
<span class="va">ols.fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span>, data <span class="op">=</span> <span class="va">linear_df</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">summary</a></span><span class="op">(</span><span class="va">ols.fit</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = outcome ~ treatment + x1 + x2, data = linear_df)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;      Min       1Q   Median       3Q      Max </span>
<span class="co">#&gt; -2.52037 -0.62298  0.02196  0.63963  2.40354 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)  10.1763     0.1378  73.838  &lt; 2e-16 ***</span>
<span class="co">#&gt; treatment     4.8630     0.2013  24.160  &lt; 2e-16 ***</span>
<span class="co">#&gt; x1            0.9524     0.1101   8.649 1.18e-13 ***</span>
<span class="co">#&gt; x2            1.1411     0.1050  10.870  &lt; 2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 0.9789 on 96 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.9101, Adjusted R-squared:  0.9073 </span>
<span class="co">#&gt; F-statistic: 323.8 on 3 and 96 DF,  p-value: &lt; 2.2e-16</span>

<span class="va">treatment_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">ols.fit</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>
<span class="va">treatment_se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html">vcovHC</a></span><span class="op">(</span><span class="va">ols.fit</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span>,<span class="st">"treatment"</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"95% CI:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">treatment_est</span>, <span class="fl">4</span><span class="op">)</span>,<span class="st">" +/ -"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">1.96</span> <span class="op">*</span> <span class="va">treatment_se</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "95% CI:4.863 +/ -0.3968"</span></code></pre></div>
<p>Create dataframes to store results</p>
<div class="sourceCode" id="cb452"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">500</span>, <span class="fl">1000</span>, <span class="fl">2000</span><span class="op">)</span>
<span class="va">plot_df_linear_ols</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">n_list</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>tau <span class="op">=</span> <span class="cn">NA</span>, lower <span class="op">=</span> <span class="cn">NA</span>, upper <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>
<span class="va">plot_df_linear_ml</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">n_list</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>tau <span class="op">=</span> <span class="cn">NA</span>, lower <span class="op">=</span> <span class="cn">NA</span>, upper <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>
<span class="va">plot_df_nonlinear_ols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">n_list</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>tau <span class="op">=</span> <span class="cn">NA</span>, lower <span class="op">=</span> <span class="cn">NA</span>, upper <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>
<span class="va">plot_df_nonlinear_ml</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">n_list</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>tau <span class="op">=</span> <span class="cn">NA</span>, lower <span class="op">=</span> <span class="cn">NA</span>, upper <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></code></pre></div>
<p>Check <a href="bootstrap.html#bootstrap">Bootstrap</a> section for estimating confidence intervals</p>
<div class="sourceCode" id="cb453"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/grf-labs/grf">grf</a></span><span class="op">)</span>

<span class="co"># create function to get tau (resemble function in the bootstrap section)</span>
<span class="va">get_tau</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data1</span>,<span class="va">i</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">data</span> <span class="op">=</span> <span class="va">data1</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>
    
    <span class="va">rf.0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/grf/man/regression_forest.html">regression_forest</a></span><span class="op">(</span>
        X <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lm.ridge.html">select</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span>,
        Y <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lm.ridge.html">select</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/as_vector.html">as_vector</a></span><span class="op">(</span><span class="op">)</span>
    <span class="op">)</span>
    <span class="va">mu.hat.0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf.0</span>, <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lm.ridge.html">select</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span>
    <span class="va">mu.hat.0</span><span class="op">[</span><span class="st">"treatment"</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf.0</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span>
    
    <span class="va">rf.1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/grf/man/regression_forest.html">regression_forest</a></span><span class="op">(</span>
        X <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lm.ridge.html">select</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span>,
        Y <span class="op">=</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lm.ridge.html">select</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/as_vector.html">as_vector</a></span><span class="op">(</span><span class="op">)</span>
    <span class="op">)</span>
    <span class="va">mu.hat.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf.1</span>, <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lm.ridge.html">select</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span>
    <span class="va">mu.hat.1</span><span class="op">[</span><span class="st">"treatment"</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf.1</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span>
    
    <span class="va">tau.hat.rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mu.hat.1</span> <span class="op">-</span> <span class="va">mu.hat.0</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">tau.hat.rf</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb454"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">boot</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="co"># linear setting using ML</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">plot_df_linear_ml</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">linear_df</span> <span class="op">&lt;-</span> <span class="fu">simu_ob_linear_df</span><span class="op">(</span><span class="va">plot_df_linear_ml</span><span class="op">$</span><span class="va">n_list</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
    
    <span class="va">bootstat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span><span class="op">(</span><span class="va">linear_df</span>, 
                 <span class="va">get_tau</span>,    <span class="co"># function to calculate the statistic of interest</span>
                 R <span class="op">=</span> <span class="fl">200</span><span class="op">)</span>    <span class="co"># number of replicates</span>
    <span class="va">plot_df_linear_ml</span><span class="op">$</span><span class="va">tau</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">bootstat</span><span class="op">$</span><span class="va">t0</span>
    <span class="va">plot_df_linear_ml</span><span class="op">$</span><span class="va">lower</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html">boot.ci</a></span><span class="op">(</span>boot.out <span class="op">=</span> <span class="va">bootstat</span>, type <span class="op">=</span> <span class="st">"norm"</span><span class="op">)</span><span class="op">$</span><span class="va">normal</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
    <span class="va">plot_df_linear_ml</span><span class="op">$</span><span class="va">upper</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html">boot.ci</a></span><span class="op">(</span>boot.out <span class="op">=</span> <span class="va">bootstat</span>, type <span class="op">=</span> <span class="st">"norm"</span><span class="op">)</span><span class="op">$</span><span class="va">normal</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
    <span class="co"># print(i)</span>
<span class="op">}</span>

<span class="co"># nonlinear setting using ML</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">plot_df_nonlinear_ml</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">nonlinear_df</span> <span class="op">&lt;-</span> <span class="fu">simu_exp_nonlinear_df</span><span class="op">(</span><span class="va">plot_df_nonlinear_ml</span><span class="op">$</span><span class="va">n_list</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
    
    <span class="va">bootstat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span><span class="op">(</span><span class="va">nonlinear_df</span>, 
                 <span class="va">get_tau</span>,    <span class="co"># function to calculate the statistic of interest</span>
                 R <span class="op">=</span> <span class="fl">200</span><span class="op">)</span>    <span class="co"># number of replicates</span>
    <span class="va">plot_df_nonlinear_ml</span><span class="op">$</span><span class="va">tau</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">bootstat</span><span class="op">$</span><span class="va">t0</span>
    <span class="va">plot_df_nonlinear_ml</span><span class="op">$</span><span class="va">lower</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html">boot.ci</a></span><span class="op">(</span>boot.out <span class="op">=</span> <span class="va">bootstat</span>, type <span class="op">=</span> <span class="st">"norm"</span><span class="op">)</span><span class="op">$</span><span class="va">normal</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
    <span class="va">plot_df_nonlinear_ml</span><span class="op">$</span><span class="va">upper</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html">boot.ci</a></span><span class="op">(</span>boot.out <span class="op">=</span> <span class="va">bootstat</span>, type <span class="op">=</span> <span class="st">"norm"</span><span class="op">)</span><span class="op">$</span><span class="va">normal</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
    <span class="co"># print(i)</span>
<span class="op">}</span>

<span class="co"># linear setting using OLS</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">plot_df_linear_ols</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">linear_df</span> <span class="op">&lt;-</span> <span class="fu">simu_ob_linear_df</span><span class="op">(</span><span class="va">plot_df_linear_ols</span><span class="op">$</span><span class="va">n_list</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
    
    <span class="va">ols.fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span>, data <span class="op">=</span> <span class="va">linear_df</span><span class="op">)</span>
    
    <span class="va">plot_df_linear_ols</span><span class="op">$</span><span class="va">tau</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">ols.fit</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>
    <span class="va">plot_df_linear_ols</span><span class="op">$</span><span class="va">lower</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">ols.fit</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html">vcovHC</a></span><span class="op">(</span><span class="va">ols.fit</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span>, <span class="st">"treatment"</span><span class="op">]</span><span class="op">)</span>
    <span class="va">plot_df_linear_ols</span><span class="op">$</span><span class="va">upper</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">ols.fit</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html">vcovHC</a></span><span class="op">(</span><span class="va">ols.fit</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span>, <span class="st">"treatment"</span><span class="op">]</span><span class="op">)</span>
    <span class="co"># print(i)</span>
<span class="op">}</span>

<span class="co"># non-linear setting using OLS</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">plot_df_nonlinear_ols</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">nonlinear_df</span> <span class="op">&lt;-</span> <span class="fu">simu_exp_nonlinear_df</span><span class="op">(</span><span class="va">plot_df_nonlinear_ols</span><span class="op">$</span><span class="va">n_list</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
    
    <span class="va">ols.fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span>, data <span class="op">=</span> <span class="va">nonlinear_df</span><span class="op">)</span>
    
    <span class="va">plot_df_nonlinear_ols</span><span class="op">$</span><span class="va">tau</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">ols.fit</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span>
    <span class="va">plot_df_nonlinear_ols</span><span class="op">$</span><span class="va">lower</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">ols.fit</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html">vcovHC</a></span><span class="op">(</span><span class="va">ols.fit</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span>, <span class="st">"treatment"</span><span class="op">]</span><span class="op">)</span>
    <span class="va">plot_df_nonlinear_ols</span><span class="op">$</span><span class="va">upper</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">ols.fit</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html">vcovHC</a></span><span class="op">(</span><span class="va">ols.fit</span><span class="op">)</span><span class="op">[</span><span class="st">"treatment"</span>, <span class="st">"treatment"</span><span class="op">]</span><span class="op">)</span>
    <span class="co"># print(i)</span>
<span class="op">}</span></code></pre></div>
<p>Plot</p>
<div class="sourceCode" id="cb455"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Evaluating OLS</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plot_df_linear_ols</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n_list <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">n_list</span><span class="op">)</span>, <span class="fl">4</span>, pad <span class="op">=</span> <span class="st">"0"</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">n_list</span>, <span class="va">tau</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"linear setting"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="30_doubly_robust_files/figure-html/unnamed-chunk-6-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb456"><pre class="downlit sourceCode r">
<code class="sourceCode R">

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plot_df_nonlinear_ols</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n_list <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">n_list</span><span class="op">)</span>, <span class="fl">4</span>, pad <span class="op">=</span> <span class="st">"0"</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">n_list</span>, <span class="va">tau</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"non-linear setting"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="30_doubly_robust_files/figure-html/unnamed-chunk-6-2.png" width="90%" style="display: block; margin: auto;"></div>
<ul>
<li><p>Using OLS regression under the linear setting, the treatment effect is always unbiased and approaches the true treatment effect as the sample size increases.</p></li>
<li><p>Using OLS regression under the nonlinear setting, the treatment effect is biased and as <span class="math inline">\(n \to \infty\)</span>, it approaches a biased estimate.</p></li>
</ul>
<div class="sourceCode" id="cb457"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Evaluating ML</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plot_df_linear_ml</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n_list <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">n_list</span><span class="op">)</span>, <span class="fl">4</span>, pad <span class="op">=</span> <span class="st">"0"</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">n_list</span>, <span class="va">tau</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"linear setting"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="30_doubly_robust_files/figure-html/unnamed-chunk-7-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb458"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plot_df_nonlinear_ml</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n_list <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">n_list</span><span class="op">)</span>, <span class="fl">4</span>, pad <span class="op">=</span> <span class="st">"0"</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">n_list</span>, <span class="va">tau</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"non-linear setting"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="30_doubly_robust_files/figure-html/unnamed-chunk-7-2.png" width="90%" style="display: block; margin: auto;"></div>
<ul>
<li><p>Using ML, as <span class="math inline">\(n \to \infty\)</span> under both linear and non-linear settings, your estimate converges to the true treatment effect</p></li>
<li><p>But ML under the linear setting, in a finite sample case, you donâ€™t have efficiency as in OLS. And for non-linear case, it performs much better but only at large sample sizes.</p></li>
</ul>
<p>In summary,</p>
<ul>
<li><p>With OLS, you are only good when your assumption is valid (<span class="math inline">\(\hat{\mu}_1(X_i), \hat{\mu}_0(X_i)\)</span> are linear)</p></li>
<li><p>With ML, you never quite wrong or quite right, you can always expect that as <span class="math inline">\(n \to \infty\)</span>, you can have the right answer.</p></li>
</ul>
</div>
<div id="inverse-propensity-weighting" class="section level2" number="30.2">
<h2>
<span class="header-section-number">30.2</span> Inverse Propensity Weighting<a class="anchor" aria-label="anchor" href="#inverse-propensity-weighting"><i class="fas fa-link"></i></a>
</h2>
<p>The goal is that each unit has the same probability of receiving the treatment (i.e., 50%).</p>
<ul>
<li><p>Units that are likely to receive the treatment are weighted down</p></li>
<li><p>Unit that are unlikely to receive the treatment are weighted up</p></li>
</ul>
<p>By definition, the propensity score is</p>
<p><span class="math display">\[
e(X) = P(T_i = 1 |X_i = x)
\]</span></p>
<p>which measures the probability of being treated conditional on <span class="math inline">\(X_i\)</span></p>
<p>Under random assignment, the propensity score is constant <span class="math inline">\(e(X) = e_0 \in (0,1)\)</span>. Hence, the variability of the propensity can be considered a measure of how far we are from random assignment.</p>
<p>Similar to <a href="doubly-robust-estimator.html#regression-adjustments">Regression Adjustments</a>, we still need the unconfoundedness assumption</p>
<p><span class="math display">\[
[\{Y_i(0)), Y_i(1)\} \perp T_1] | X_i
\]</span></p>
<p>However, this time, the ATE is formulated differently</p>
<p><span class="math display">\[
\begin{aligned}
\tau &amp;= E[Y_i(1) - Y_i(0)] \\
&amp;= E[E[Y_i(1) |X_i ] - E[Y_i(0) |X_i]]\\
&amp;= E \left[ \frac{E[T_i |X_i ] E[Y_i(1) |X_i]}{e(X_i)} - \frac{E[1 - T_i |X_i] E[Y_i(0) |X_i]}{1 - e(X_i)} \right] \\
&amp;= E \left[ \frac{E[ T_i Y_i(1) |X_i]}{e(X_i)} - \frac{E[(1-T_i) Y_i(0)|X_i]}{1 - e(X_i)} \right] &amp;&amp; \text{unconfoundedness} \\
&amp;= E\left[\frac{T_i Y_i}{e(X_i)} - \frac{(1-T_i) Y_i}{1 - e(X_i)} \right] &amp;&amp; \text{consistency of potential outcomes}
\end{aligned}
\]</span></p>
<p>which means that the last equality can give an unbiased estimator of the <a href="causal-inference.html#average-treatment-effects">ATE</a></p>
<p><span class="math display">\[
\hat{\tau} = \frac{1}{n} \sum_{i = 1}^n \left( \frac{T_i Y_i}{e(X_i)} - \frac{(1 - T_i) Y_i}{1 - e(X_i)} \right)
\]</span></p>
<p>However, this estimator is unbiased (i.e., <span class="math inline">\(E(\hat{\tau}) = \tau\)</span>) only when we have the correct propensity score <span class="math inline">\(e(.)\)</span></p>
<p>But since in almost all cases, we do not know the data generating process (i.e., assignment process), we have to use an estimate of the propensity score <span class="math inline">\(\hat{e}(.)\)</span> from either:</p>
<ul>
<li><p>Parametric approach: logistic regression</p></li>
<li><p>Non-parametric approach: machine learning</p></li>
</ul>
<p>But both approaches would not be ideal, because the error from using the estimated propensity score would overwhelm the sampling error of the <span class="math inline">\(\hat{\tau}\)</span></p>
<p>Moreover, if you have the wrong model for the propensity score estimate, it would bias your treatment effect estimate.</p>
<div class="sourceCode" id="cb459"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linear_df</span> <span class="op">&lt;-</span> <span class="fu">simu_ob_linear_df</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>
<span class="va">nonlinear_df</span> <span class="op">&lt;-</span> <span class="fu">simu_exp_nonlinear_df</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></code></pre></div>
<p>Linear setting</p>
<div class="sourceCode" id="cb460"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prop_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">~</span>  <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span>, data <span class="op">=</span> <span class="va">linear_df</span>, family <span class="op">=</span> <span class="st">'binomial'</span><span class="op">)</span>
<span class="va">linear_df</span> <span class="op">&lt;-</span> <span class="va">linear_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>propensity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">prop_mod</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span>,
           weight <span class="op">=</span> <span class="fl">1</span><span class="op">/</span> <span class="va">propensity</span> <span class="op">*</span> <span class="va">treatment</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span> <span class="va">propensity</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">treatment</span><span class="op">)</span><span class="op">)</span>
<span class="va">linear_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>weighted_outcome<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">outcome</span>, <span class="va">weight</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   treatment weighted_outcome</span>
<span class="co">#&gt;       &lt;int&gt;            &lt;dbl&gt;</span>
<span class="co">#&gt; 1         0             10.0</span>
<span class="co">#&gt; 2         1             15.1</span>

<span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">treatment</span>, data <span class="op">=</span> <span class="va">linear_df</span>, weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">linear_df</span><span class="op">$</span><span class="va">weight</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = outcome ~ x1 + x2 + treatment, data = linear_df, </span>
<span class="co">#&gt;     weights = as.vector(linear_df$weight))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Weighted Residuals:</span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -4.7444 -0.9197 -0.0181  0.8544  6.0037 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)  9.99164    0.04504  221.84   &lt;2e-16 ***</span>
<span class="co">#&gt; x1           0.98957    0.03269   30.27   &lt;2e-16 ***</span>
<span class="co">#&gt; x2           1.06540    0.03088   34.51   &lt;2e-16 ***</span>
<span class="co">#&gt; treatment    5.02141    0.06389   78.60   &lt;2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 1.428 on 996 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.8941, Adjusted R-squared:  0.8938 </span>
<span class="co">#&gt; F-statistic:  2803 on 3 and 996 DF,  p-value: &lt; 2.2e-16</span></code></pre></div>
<p>Non-linear setting</p>
<div class="sourceCode" id="cb461"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prop_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">~</span>  <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span>, data <span class="op">=</span> <span class="va">nonlinear_df</span>, family <span class="op">=</span> <span class="st">'binomial'</span><span class="op">)</span>
<span class="va">nonlinear_df</span> <span class="op">&lt;-</span> <span class="va">nonlinear_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>propensity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">prop_mod</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span>,
           weight <span class="op">=</span> <span class="fl">1</span><span class="op">/</span> <span class="va">propensity</span> <span class="op">*</span> <span class="va">treatment</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span> <span class="va">propensity</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">treatment</span><span class="op">)</span><span class="op">)</span>
<span class="va">nonlinear_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>weighted_outcome<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">outcome</span>, <span class="va">weight</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;   treatment weighted_outcome</span>
<span class="co">#&gt;       &lt;int&gt;            &lt;dbl&gt;</span>
<span class="co">#&gt; 1         0             10.2</span>
<span class="co">#&gt; 2         1             15.8</span>

<span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">treatment</span>, data <span class="op">=</span> <span class="va">nonlinear_df</span>, weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">nonlinear_df</span><span class="op">$</span><span class="va">weight</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = outcome ~ x1 + x2 + treatment, data = nonlinear_df, </span>
<span class="co">#&gt;     weights = as.vector(nonlinear_df$weight))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Weighted Residuals:</span>
<span class="co">#&gt;      Min       1Q   Median       3Q      Max </span>
<span class="co">#&gt; -19.3724  -1.5572   0.2344   1.5983  13.8459 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept) 10.30332    0.08899 115.775   &lt;2e-16 ***</span>
<span class="co">#&gt; x1           2.49504    0.06534  38.183   &lt;2e-16 ***</span>
<span class="co">#&gt; x2          -0.05043    0.06685  -0.754    0.451    </span>
<span class="co">#&gt; treatment    5.33245    0.12632  42.214   &lt;2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 2.784 on 996 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.7746, Adjusted R-squared:  0.7739 </span>
<span class="co">#&gt; F-statistic:  1141 on 3 and 996 DF,  p-value: &lt; 2.2e-16</span></code></pre></div>
</div>
<div id="augmented-inverse-propensity-weighting" class="section level2" number="30.3">
<h2>
<span class="header-section-number">30.3</span> Augmented Inverse Propensity Weighting<a class="anchor" aria-label="anchor" href="#augmented-inverse-propensity-weighting"><i class="fas fa-link"></i></a>
</h2>
<p>To leverage the best of both worlds (<a href="doubly-robust-estimator.html#regression-adjustments">Regression Adjustments</a> and <a href="doubly-robust-estimator.html#inverse-propensity-weighting">Inverse Propensity Weighting</a>), we have the <a href="doubly-robust-estimator.html#augmented-inverse-propensity-weighting">Augmented Inverse Propensity Weighting</a> (known as the doubly robust estimator):</p>
<p><span class="math display">\[
\hat{\tau} = \frac{1}{n} \sum_{n=1}^n \left(\hat{\mu}_1 (X_i) - \hat{\mu}_0(X_i) \\
+ \frac{T_i}{\hat{e}(X_i)} (Y_i - \hat{\mu}_1 (X_i)) - \frac{1 - T_i }{1 - \hat{e}(X_i)} (Y_i - \hat{\mu}_0 (X_i)) \right)
\]</span></p>
<p>where the first part is <a href="doubly-robust-estimator.html#regression-adjustments">Regression Adjustments</a> and the second part is the <a href="doubly-robust-estimator.html#inverse-propensity-weighting">Inverse Propensity Weighting</a> estimator applied to the residuals, where it debiases the direct estimate.</p>
<p>When implementing this estimator, we assume</p>
<ol style="list-style-type: decimal">
<li><a href="causal-inference.html#unconfoundedness">Unconfoundedness</a></li>
<li>ML method is reasonable accurate (i.e., good prediction)</li>
<li>
<a href="causal-inference.html#bounded-propensity-score">Bounded propensity score</a> (i.e., Overlap): <span class="math inline">\(e(X) \in (0,1)\)</span> (i.e., the propensity scores are bounded for all possible value of <span class="math inline">\(X\)</span>). You can check your estimated <span class="math inline">\(\hat{e}(X) \in (0,1)\)</span> (e.g., histogram)</li>
</ol>
<div class="sourceCode" id="cb462"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># data</span>
<span class="va">linear_df</span> <span class="op">&lt;-</span> <span class="fu">simu_ob_linear_df</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>
<span class="va">nonlinear_df</span> <span class="op">&lt;-</span> <span class="fu">simu_exp_nonlinear_df</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>

<span class="co"># package</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/grf-labs/grf">grf</a></span><span class="op">)</span>

<span class="co"># linear case</span>
<span class="va">cf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/grf/man/causal_forest.html">causal_forest</a></span><span class="op">(</span><span class="va">linear_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lm.ridge.html">select</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span>, <span class="va">linear_df</span><span class="op">$</span><span class="va">outcome</span>, <span class="va">linear_df</span><span class="op">$</span><span class="va">treatment</span><span class="op">)</span>
<span class="va">ate.est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/grf/man/average_treatment_effect.html">average_treatment_effect</a></span><span class="op">(</span><span class="va">cf</span><span class="op">)</span>
<span class="va">ate.est</span>
<span class="co">#&gt;  estimate   std.err </span>
<span class="co">#&gt; 5.1683733 0.2391832</span>

<span class="co"># non-linear case</span>
<span class="va">cf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/grf/man/causal_forest.html">causal_forest</a></span><span class="op">(</span><span class="va">nonlinear_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lm.ridge.html">select</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span>, <span class="va">nonlinear_df</span><span class="op">$</span><span class="va">outcome</span>, <span class="va">nonlinear_df</span><span class="op">$</span><span class="va">treatment</span><span class="op">)</span>
<span class="va">ate.est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/grf/man/average_treatment_effect.html">average_treatment_effect</a></span><span class="op">(</span><span class="va">cf</span>, target.sample <span class="op">=</span> <span class="st">"overlap"</span><span class="op">)</span>
<span class="va">ate.est</span>
<span class="co">#&gt;  estimate   std.err </span>
<span class="co">#&gt; 5.4827965 0.3732939</span></code></pre></div>
<p>We can see in both cases, the estimates contain the true treatment effect</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="interrupted-time-series.html"><span class="header-section-number">29</span> Interrupted Time Series</a></div>
<div class="next"><a href="endogeneity.html"><span class="header-section-number">31</span> Endogeneity</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#doubly-robust-estimator"><span class="header-section-number">30</span> Doubly Robust Estimator</a></li>
<li><a class="nav-link" href="#regression-adjustments"><span class="header-section-number">30.1</span> Regression Adjustments</a></li>
<li><a class="nav-link" href="#inverse-propensity-weighting"><span class="header-section-number">30.2</span> Inverse Propensity Weighting</a></li>
<li><a class="nav-link" href="#augmented-inverse-propensity-weighting"><span class="header-section-number">30.3</span> Augmented Inverse Propensity Weighting</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/mikenguyen13/data_analysis/blob/main/30_doubly_robust.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/mikenguyen13/data_analysis/edit/main/30_doubly_robust.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>A Guide on Data Analysis</strong>" was written by Mike Nguyen. It was last built on 2022-09-16.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
