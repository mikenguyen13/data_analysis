<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 42 Sensitivity Analysis/ Robustness Check | A Guide on Data Analysis</title>
<meta name="author" content="Mike Nguyen">
<meta name="description" content="42.1 Specification curve also known as Specification robustness graph or coefficient stability plot Resources In Stata or speccurve (Simonsohn, Simmons, and Nelson 2020)  42.1.1 starbility...">
<meta name="generator" content="bookdown 0.43 with bs4_book()">
<meta property="og:title" content="Chapter 42 Sensitivity Analysis/ Robustness Check | A Guide on Data Analysis">
<meta property="og:type" content="book">
<meta property="og:url" content="https://bookdown.org/mike/data_analysis/sensitivity-analysis-robustness-check.html">
<meta property="og:image" content="https://bookdown.org/mike/data_analysis//images/cover.jpg">
<meta property="og:description" content="42.1 Specification curve also known as Specification robustness graph or coefficient stability plot Resources In Stata or speccurve (Simonsohn, Simmons, and Nelson 2020)  42.1.1 starbility...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 42 Sensitivity Analysis/ Robustness Check | A Guide on Data Analysis">
<meta name="twitter:description" content="42.1 Specification curve also known as Specification robustness graph or coefficient stability plot Resources In Stata or speccurve (Simonsohn, Simmons, and Nelson 2020)  42.1.1 starbility...">
<meta name="twitter:image" content="https://bookdown.org/mike/data_analysis//images/cover.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.9.0/transition.js"></script><script src="libs/bs3compat-0.9.0/tabs.js"></script><script src="libs/bs3compat-0.9.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){window.dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-DMNX2X65HQ');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">A Guide on Data Analysis</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="prerequisites.html"><span class="header-section-number">2</span> Prerequisites</a></li>
<li class="book-part">I. BASIC</li>
<li><a class="" href="descriptive-statistics.html"><span class="header-section-number">3</span> Descriptive Statistics</a></li>
<li><a class="" href="basic-statistical-inference.html"><span class="header-section-number">4</span> Basic Statistical Inference</a></li>
<li class="book-part">II. REGRESSION</li>
<li><a class="" href="linear-regression.html"><span class="header-section-number">5</span> Linear Regression</a></li>
<li><a class="" href="non-linear-regression.html"><span class="header-section-number">6</span> Non-Linear Regression</a></li>
<li><a class="" href="generalized-linear-models.html"><span class="header-section-number">7</span> Generalized Linear Models</a></li>
<li><a class="" href="sec-linear-mixed-models.html"><span class="header-section-number">8</span> Linear Mixed Models</a></li>
<li><a class="" href="sec-nonlinear-and-generalized-linear-mixed-models.html"><span class="header-section-number">9</span> Nonlinear and Generalized Linear Mixed Models</a></li>
<li><a class="" href="sec-nonparametric-regression.html"><span class="header-section-number">10</span> Nonparametric Regression</a></li>
<li class="book-part">III. RAMIFICATIONS</li>
<li><a class="" href="data.html"><span class="header-section-number">11</span> Data</a></li>
<li><a class="" href="variable-transformation.html"><span class="header-section-number">12</span> Variable Transformation</a></li>
<li><a class="" href="imputation-missing-data.html"><span class="header-section-number">13</span> Imputation (Missing Data)</a></li>
<li><a class="" href="model-specification-tests.html"><span class="header-section-number">14</span> Model Specification Tests</a></li>
<li><a class="" href="variable-selection.html"><span class="header-section-number">15</span> Variable Selection</a></li>
<li><a class="" href="hypothesis-testing.html"><span class="header-section-number">16</span> Hypothesis Testing</a></li>
<li><a class="" href="sec-marginal-effects.html"><span class="header-section-number">17</span> Marginal Effects</a></li>
<li><a class="" href="moderation.html"><span class="header-section-number">18</span> Moderation</a></li>
<li><a class="" href="mediation.html"><span class="header-section-number">19</span> Mediation</a></li>
<li><a class="" href="prediction-and-estimation.html"><span class="header-section-number">20</span> Prediction and Estimation</a></li>
<li class="book-part">IV. CAUSAL INFERENCE</li>
<li><a class="" href="sec-causal-inference.html"><span class="header-section-number">21</span> Causal Inference</a></li>
<li class="book-part">A. EXPERIMENTAL DESIGN</li>
<li><a class="" href="sec-experimental-design.html"><span class="header-section-number">22</span> Experimental Design</a></li>
<li><a class="" href="sampling.html"><span class="header-section-number">23</span> Sampling</a></li>
<li><a class="" href="sec-analysis-of-variance-anova.html"><span class="header-section-number">24</span> Analysis of Variance</a></li>
<li><a class="" href="sec-multivariate-methods.html"><span class="header-section-number">25</span> Multivariate Methods</a></li>
<li class="book-part">B. QUASI-EXPERIMENTAL DESIGN</li>
<li><a class="" href="sec-quasi-experimental.html"><span class="header-section-number">26</span> Quasi-Experimental Methods</a></li>
<li><a class="" href="sec-regression-discontinuity.html"><span class="header-section-number">27</span> Regression Discontinuity</a></li>
<li><a class="" href="temporal-discontinuity-designs.html"><span class="header-section-number">28</span> Temporal Discontinuity Designs</a></li>
<li><a class="" href="sec-synthetic-difference-in-differences.html"><span class="header-section-number">29</span> Synthetic Difference-in-Differences</a></li>
<li><a class="" href="sec-difference-in-differences.html"><span class="header-section-number">30</span> Difference-in-Differences</a></li>
<li><a class="" href="sec-changes-in-changes.html"><span class="header-section-number">31</span> Changes-in-Changes</a></li>
<li><a class="" href="sec-synthetic-control.html"><span class="header-section-number">32</span> Synthetic Control</a></li>
<li><a class="" href="sec-event-studies.html"><span class="header-section-number">33</span> Event Studies</a></li>
<li><a class="" href="sec-instrumental-variables.html"><span class="header-section-number">34</span> Instrumental Variables</a></li>
<li><a class="" href="sec-matching-methods.html"><span class="header-section-number">35</span> Matching Methods</a></li>
<li class="book-part">C. OTHER CONCERNS</li>
<li><a class="" href="sec-endogeneity.html"><span class="header-section-number">36</span> Endogeneity</a></li>
<li><a class="" href="other-biases.html"><span class="header-section-number">37</span> Other Biases</a></li>
<li><a class="" href="sec-directed-acyclic-graphs.html"><span class="header-section-number">38</span> Directed Acyclic Graphs</a></li>
<li><a class="" href="sec-controls.html"><span class="header-section-number">39</span> Controls</a></li>
<li class="book-part">V. MISCELLANEOUS</li>
<li><a class="" href="report.html"><span class="header-section-number">40</span> Report</a></li>
<li><a class="" href="exploratory-data-analysis.html"><span class="header-section-number">41</span> Exploratory Data Analysis</a></li>
<li><a class="active" href="sensitivity-analysis-robustness-check.html"><span class="header-section-number">42</span> Sensitivity Analysis/ Robustness Check</a></li>
<li><a class="" href="replication-and-synthetic-data.html"><span class="header-section-number">43</span> Replication and Synthetic Data</a></li>
<li><a class="" href="high-performance-computing.html"><span class="header-section-number">44</span> High-Performance Computing</a></li>
<li class="book-part">APPENDIX</li>
<li><a class="" href="appendix.html"><span class="header-section-number">A</span> Appendix</a></li>
<li><a class="" href="bookdown-cheat-sheet.html"><span class="header-section-number">B</span> Bookdown cheat sheet</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/mikenguyen13/data_analysis">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="sensitivity-analysis-robustness-check" class="section level1" number="42">
<h1>
<span class="header-section-number">42</span> Sensitivity Analysis/ Robustness Check<a class="anchor" aria-label="anchor" href="#sensitivity-analysis-robustness-check"><i class="fas fa-link"></i></a>
</h1>
<div id="specification-curve" class="section level2" number="42.1">
<h2>
<span class="header-section-number">42.1</span> Specification curve<a class="anchor" aria-label="anchor" href="#specification-curve"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>also known as Specification robustness graph or coefficient stability plot</li>
</ul>
<p>Resources</p>
<ul>
<li><p><a href="https://github.com/hhsievertsen/speccurve">In Stata</a> or <a href="https://github.com/martin-andresen/speccurve">speccurve</a></p></li>
<li><p><span class="citation">(<a href="references.html#ref-simonsohn2020specification">Simonsohn, Simmons, and Nelson 2020</a>)</span></p></li>
</ul>
<div id="starbility" class="section level3" number="42.1.1">
<h3>
<span class="header-section-number">42.1.1</span> starbility<a class="anchor" aria-label="anchor" href="#starbility"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Recommend</li>
</ul>
<p>Installation</p>
<div class="sourceCode" id="cb1072"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">'https://github.com/AakaashRao/starbility'</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">starbility</span><span class="op">)</span></span></code></pre></div>
<p>Example by the <a href="https://htmlpreview.github.io/?https://github.com/AakaashRao/starbility/blob/master/doc/starbility.html">package’s author</a></p>
<div class="sourceCode" id="cb1073"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">starbility</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-econometrics/lfe">lfe</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"diamonds"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">43</span><span class="op">)</span></span>
<span><span class="va">indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html">nrow</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">)</span>,</span>
<span>                 replace <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                 size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html">nrow</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">)</span> <span class="op">/</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">diamonds</span> <span class="op">=</span> <span class="va">diamonds</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span></span></code></pre></div>
<p>Plot different combinations of controls</p>
<div class="sourceCode" id="cb1074"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># If you want to make the diamond dimensions as base control</span></span>
<span><span class="va">base_controls</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="st">'Diamond dimensions'</span> <span class="op">=</span> <span class="st">'x + y + z'</span> <span class="co"># include all variables under 1 dimension</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">perm_controls</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="st">'Depth'</span> <span class="op">=</span> <span class="st">'depth'</span>,</span>
<span>  <span class="st">'Table width'</span> <span class="op">=</span> <span class="st">'table'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">nonperm_fe_controls</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="st">'Clarity FE (granular)'</span> <span class="op">=</span> <span class="st">'clarity'</span>,</span>
<span>  <span class="st">'Clarity FE (binary)'</span> <span class="op">=</span> <span class="st">'high_clarity'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Adding fixed effects</span></span>
<span><span class="va">nonperm_fe_controls</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="st">'Clarity FE (granular)'</span> <span class="op">=</span> <span class="st">'clarity'</span>,</span>
<span>  <span class="st">'Clarity FE (binary)'</span> <span class="op">=</span> <span class="st">'high_clarity'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Adding instrumental variables </span></span>
<span><span class="va">instruments</span> <span class="op">=</span> <span class="st">'x+y+z'</span></span>
<span></span>
<span><span class="co"># clustering and weights </span></span>
<span><span class="va">diamonds</span><span class="op">$</span><span class="va">sample_weights</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html">nrow</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># robust standard errors </span></span>
<span><span class="va">starb_felm_custom</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">spec</span>, <span class="va">data</span>, <span class="va">rhs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">spec</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">=</span> <span class="fu">lfe</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lfe/man/felm.html">felm</a></span><span class="op">(</span><span class="va">spec</span>, data<span class="op">=</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">row</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html">which</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">term</span><span class="op">==</span><span class="va">rhs</span><span class="op">)</span></span>
<span>  <span class="va">coef</span> <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'estimate'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">se</span>   <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'std.error'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">p</span>    <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'p.value'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># 99% confidence interval</span></span>
<span>  <span class="va">z</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="fl">0.995</span><span class="op">)</span> </span>
<span>  <span class="co"># one-tailed test</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">coef</span>, <span class="va">p</span><span class="op">/</span><span class="fl">2</span>, <span class="va">coef</span><span class="op">+</span><span class="va">z</span><span class="op">*</span><span class="va">se</span>, <span class="va">coef</span><span class="op">-</span><span class="va">z</span><span class="op">*</span><span class="va">se</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">plots</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/starbility/man/stability_plot.html">stability_plot</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">diamonds</span>,</span>
<span>    lhs <span class="op">=</span> <span class="st">'price'</span>,</span>
<span>    rhs <span class="op">=</span> <span class="st">'carat'</span>,</span>
<span>    error_geom <span class="op">=</span> <span class="st">'ribbon'</span>, <span class="co"># make the plot more aesthetics</span></span>
<span>    <span class="co"># error_geom = 'none', # if you don't want ribbon (i.e., error bar)</span></span>
<span>    model <span class="op">=</span> <span class="va">starb_felm_custom</span>,</span>
<span>    cluster <span class="op">=</span> <span class="st">'cut'</span>,</span>
<span>    weights <span class="op">=</span> <span class="st">'sample_weights'</span>,</span>
<span>    <span class="co"># iv = instruments,</span></span>
<span>    perm <span class="op">=</span> <span class="va">perm_controls</span>,</span>
<span>    base <span class="op">=</span> <span class="va">base_controls</span>,</span>
<span>    <span class="co"># perm_fe = perm_fe_controls,</span></span>
<span>    </span>
<span>    <span class="co"># if you want to include fixed effects sequentially (not all combinations) </span></span>
<span>    <span class="co"># (e.g., you want to test country or state fixed effect, not both )</span></span>
<span>    <span class="co"># nonperm_fe = nonperm_fe_controls, </span></span>
<span>    <span class="co"># fe_always = F,  # if you want to have a model without any Fixed Effects</span></span>
<span>    </span>
<span>    <span class="co"># sort "asc", "desc", or by fixed effects: "asc-by-fe" or "desc-by-fe"</span></span>
<span>    sort <span class="op">=</span> <span class="st">"asc-by-fe"</span>, </span>
<span>    </span>
<span>    <span class="co"># if you have less variables and want more aesthetics </span></span>
<span>    <span class="co"># control_geom = 'circle',</span></span>
<span>    <span class="co"># point_size = 2,</span></span>
<span>    <span class="co"># control_spacing = 0.3,</span></span>
<span>    </span>
<span>    </span>
<span>    <span class="co"># error_alpha = 0.2, # change alpha of the error geom</span></span>
<span>    <span class="co"># point_size = 1.5, # change the size of the coefficient points</span></span>
<span>    <span class="co"># control_text_size = 10, # change the size of the control labels</span></span>
<span>    <span class="co"># coef_ylim = c(-5000, 35000), # change the endpoints of the y-axis</span></span>
<span>    <span class="co"># trip_top = 3, # change the spacing between the two panels</span></span>
<span>    </span>
<span>    rel_height <span class="op">=</span> <span class="fl">0.6</span></span>
<span><span class="op">)</span></span>
<span><span class="va">plots</span></span></code></pre></div>
<div class="inline-figure"><img src="42-sensitivity-robustness_files/figure-html/unnamed-chunk-3-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb1075"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># add comments</span></span>
<span><span class="co"># replacement_coef_panel = plots[[1]] +</span></span>
<span><span class="co">#   scale_y_reverse() +</span></span>
<span><span class="co">#   theme(panel.grid.minor = element_blank()) +</span></span>
<span><span class="co">#   geom_vline(xintercept = 41,</span></span>
<span><span class="co">#              linetype = 'dashed',</span></span>
<span><span class="co">#              alpha = 0.4) +</span></span>
<span><span class="co">#   annotate(</span></span>
<span><span class="co">#     geom = 'label',</span></span>
<span><span class="co">#     x = 52,</span></span>
<span><span class="co">#     y = 30000,</span></span>
<span><span class="co">#     label = 'What a great\nspecification!',</span></span>
<span><span class="co">#     alpha = 0.75</span></span>
<span><span class="co">#   )</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># combine_plots(replacement_coef_panel,</span></span>
<span><span class="co">#               plots[[2]],</span></span>
<span><span class="co">#               rel_height = 0.6)</span></span></code></pre></div>
<p>Note:</p>
<ul>
<li>
<span class="math inline">\(p &lt; 0.01\)</span>: red</li>
<li>
<span class="math inline">\(p &lt; 0.05\)</span>: green</li>
<li>
<span class="math inline">\(p &lt; 0.1\)</span>: blue</li>
<li>
<span class="math inline">\(p &gt; 0.1\)</span>: black</li>
</ul>
<p><a href="https://htmlpreview.github.io/?https://github.com/AakaashRao/starbility/blob/master/doc/starbility-advanced.html">More Advanced Stuff</a></p>
<div class="sourceCode" id="cb1076"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Step 1: Control Grid</span></span>
<span></span>
<span><span class="va">diamonds</span><span class="op">$</span><span class="va">high_clarity</span> <span class="op">=</span> <span class="va">diamonds</span><span class="op">$</span><span class="va">clarity</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'VS1'</span>,<span class="st">'VVS2'</span>,<span class="st">'VVS1'</span>,<span class="st">'IF'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">base_controls</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="st">'Diamond dimensions'</span> <span class="op">=</span> <span class="st">'x + y + z'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">perm_controls</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="st">'Depth'</span> <span class="op">=</span> <span class="st">'depth'</span>,</span>
<span>  <span class="st">'Table width'</span> <span class="op">=</span> <span class="st">'table'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">perm_fe_controls</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="st">'Cut FE'</span> <span class="op">=</span> <span class="st">'cut'</span>,</span>
<span>  <span class="st">'Color FE'</span> <span class="op">=</span> <span class="st">'color'</span></span>
<span><span class="op">)</span></span>
<span><span class="va">nonperm_fe_controls</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="st">'Clarity FE (granular)'</span> <span class="op">=</span> <span class="st">'clarity'</span>,</span>
<span>  <span class="st">'Clarity FE (binary)'</span> <span class="op">=</span> <span class="st">'high_clarity'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">grid1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/starbility/man/stability_plot.html">stability_plot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">diamonds</span>, </span>
<span>                      lhs <span class="op">=</span> <span class="st">'price'</span>, </span>
<span>                      rhs <span class="op">=</span> <span class="st">'carat'</span>, </span>
<span>                      perm <span class="op">=</span> <span class="va">perm_controls</span>,</span>
<span>                      base <span class="op">=</span> <span class="va">base_controls</span>, </span>
<span>                      perm_fe <span class="op">=</span> <span class="va">perm_fe_controls</span>, </span>
<span>                      nonperm_fe <span class="op">=</span> <span class="va">nonperm_fe_controls</span>, </span>
<span>                      run_to<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">grid1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="right">Diamond dimensions</th>
<th align="right">Depth</th>
<th align="right">Table width</th>
<th align="right">Cut FE</th>
<th align="right">Color FE</th>
<th align="left">np_fe</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left"></td>
</tr>
</tbody>
</table></div>
<div class="sourceCode" id="cb1077"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Step 2: Get model expression</span></span>
<span></span>
<span><span class="va">grid2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/starbility/man/stability_plot.html">stability_plot</a></span><span class="op">(</span>grid <span class="op">=</span> <span class="va">grid1</span>,</span>
<span>                      data<span class="op">=</span><span class="va">diamonds</span>, </span>
<span>                      lhs<span class="op">=</span><span class="st">'price'</span>, </span>
<span>                      rhs<span class="op">=</span><span class="st">'carat'</span>, </span>
<span>                      perm<span class="op">=</span><span class="va">perm_controls</span>, </span>
<span>                      base<span class="op">=</span><span class="va">base_controls</span>,</span>
<span>                      run_from<span class="op">=</span><span class="fl">2</span>,</span>
<span>                      run_to<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">grid2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table style="width:100%;" class="table table-sm">
<colgroup>
<col width="20%">
<col width="6%">
<col width="12%">
<col width="6%">
<col width="54%">
</colgroup>
<thead><tr class="header">
<th align="right">Diamond dimensions</th>
<th align="right">Depth</th>
<th align="right">Table width</th>
<th align="left">np_fe</th>
<th align="left">expr</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z|0|0|0</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth|0|0|0</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+table|0|0|0</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth+table|0|0|0</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z|0|0|0</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth|0|0|0</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+table|0|0|0</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth+table|0|0|0</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z|0|0|0</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth|0|0|0</td>
</tr>
</tbody>
</table></div>
<div class="sourceCode" id="cb1078"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Step 3: Estimate models</span></span>
<span><span class="va">grid3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/starbility/man/stability_plot.html">stability_plot</a></span><span class="op">(</span>grid <span class="op">=</span> <span class="va">grid2</span>,</span>
<span>                      data<span class="op">=</span><span class="va">diamonds</span>, </span>
<span>                      lhs<span class="op">=</span><span class="st">'price'</span>, </span>
<span>                      rhs<span class="op">=</span><span class="st">'carat'</span>, </span>
<span>                      perm<span class="op">=</span><span class="va">perm_controls</span>, </span>
<span>                      base<span class="op">=</span><span class="va">base_controls</span>,</span>
<span>                      run_from<span class="op">=</span><span class="fl">3</span>,</span>
<span>                      run_to<span class="op">=</span><span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">grid3</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="14%">
<col width="4%">
<col width="9%">
<col width="4%">
<col width="38%">
<col width="6%">
<col width="5%">
<col width="8%">
<col width="7%">
</colgroup>
<thead><tr class="header">
<th align="right">Diamond dimensions</th>
<th align="right">Depth</th>
<th align="right">Table width</th>
<th align="left">np_fe</th>
<th align="left">expr</th>
<th align="right">coef</th>
<th align="left">p</th>
<th align="right">error_high</th>
<th align="right">error_low</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z|0|0|0</td>
<td align="right">10461.86</td>
<td align="left">p&lt;0.01</td>
<td align="right">11031.84</td>
<td align="right">9891.876</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth|0|0|0</td>
<td align="right">10808.25</td>
<td align="left">p&lt;0.01</td>
<td align="right">11388.81</td>
<td align="right">10227.683</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+table|0|0|0</td>
<td align="right">10423.42</td>
<td align="left">p&lt;0.01</td>
<td align="right">10992.00</td>
<td align="right">9854.849</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth+table|0|0|0</td>
<td align="right">10851.31</td>
<td align="left">p&lt;0.01</td>
<td align="right">11428.58</td>
<td align="right">10274.037</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z|0|0|0</td>
<td align="right">10461.86</td>
<td align="left">p&lt;0.01</td>
<td align="right">11031.84</td>
<td align="right">9891.876</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth|0|0|0</td>
<td align="right">10808.25</td>
<td align="left">p&lt;0.01</td>
<td align="right">11388.81</td>
<td align="right">10227.683</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+table|0|0|0</td>
<td align="right">10423.42</td>
<td align="left">p&lt;0.01</td>
<td align="right">10992.00</td>
<td align="right">9854.849</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth+table|0|0|0</td>
<td align="right">10851.31</td>
<td align="left">p&lt;0.01</td>
<td align="right">11428.58</td>
<td align="right">10274.037</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z|0|0|0</td>
<td align="right">10461.86</td>
<td align="left">p&lt;0.01</td>
<td align="right">11031.84</td>
<td align="right">9891.876</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth|0|0|0</td>
<td align="right">10808.25</td>
<td align="left">p&lt;0.01</td>
<td align="right">11388.81</td>
<td align="right">10227.683</td>
</tr>
</tbody>
</table></div>
<div class="sourceCode" id="cb1079"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Step 4: Get dataframe to draw</span></span>
<span><span class="va">dfs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/starbility/man/stability_plot.html">stability_plot</a></span><span class="op">(</span>grid <span class="op">=</span> <span class="va">grid3</span>,</span>
<span>                      data<span class="op">=</span><span class="va">diamonds</span>, </span>
<span>                      lhs<span class="op">=</span><span class="st">'price'</span>, </span>
<span>                      rhs<span class="op">=</span><span class="st">'carat'</span>, </span>
<span>                      perm<span class="op">=</span><span class="va">perm_controls</span>, </span>
<span>                      base<span class="op">=</span><span class="va">base_controls</span>,</span>
<span>                      run_from<span class="op">=</span><span class="fl">4</span>,</span>
<span>                      run_to<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">coef_grid</span> <span class="op">=</span> <span class="va">dfs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">control_grid</span> <span class="op">=</span> <span class="va">dfs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">coef_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table style="width:100%;" class="table table-sm">
<colgroup>
<col width="13%">
<col width="4%">
<col width="8%">
<col width="4%">
<col width="37%">
<col width="6%">
<col width="5%">
<col width="8%">
<col width="7%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th align="right">Diamond dimensions</th>
<th align="right">Depth</th>
<th align="right">Table width</th>
<th align="left">np_fe</th>
<th align="left">expr</th>
<th align="right">coef</th>
<th align="left">p</th>
<th align="right">error_high</th>
<th align="right">error_low</th>
<th align="right">model</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z|0|0|0</td>
<td align="right">10461.86</td>
<td align="left">p&lt;0.01</td>
<td align="right">11031.84</td>
<td align="right">9891.876</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth|0|0|0</td>
<td align="right">10808.25</td>
<td align="left">p&lt;0.01</td>
<td align="right">11388.81</td>
<td align="right">10227.683</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+table|0|0|0</td>
<td align="right">10423.42</td>
<td align="left">p&lt;0.01</td>
<td align="right">10992.00</td>
<td align="right">9854.849</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth+table|0|0|0</td>
<td align="right">10851.31</td>
<td align="left">p&lt;0.01</td>
<td align="right">11428.58</td>
<td align="right">10274.037</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z|0|0|0</td>
<td align="right">10461.86</td>
<td align="left">p&lt;0.01</td>
<td align="right">11031.84</td>
<td align="right">9891.876</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth|0|0|0</td>
<td align="right">10808.25</td>
<td align="left">p&lt;0.01</td>
<td align="right">11388.81</td>
<td align="right">10227.683</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+table|0|0|0</td>
<td align="right">10423.42</td>
<td align="left">p&lt;0.01</td>
<td align="right">10992.00</td>
<td align="right">9854.849</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth+table|0|0|0</td>
<td align="right">10851.31</td>
<td align="left">p&lt;0.01</td>
<td align="right">11428.58</td>
<td align="right">10274.037</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z|0|0|0</td>
<td align="right">10461.86</td>
<td align="left">p&lt;0.01</td>
<td align="right">11031.84</td>
<td align="right">9891.876</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left">0</td>
<td align="left">price~carat+x+y+z+depth|0|0|0</td>
<td align="right">10808.25</td>
<td align="left">p&lt;0.01</td>
<td align="right">11388.81</td>
<td align="right">10227.683</td>
<td align="right">10</td>
</tr>
</tbody>
</table></div>
<div class="sourceCode" id="cb1080"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Step 5: plot the sensitivity graph </span></span>
<span><span class="va">panels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/starbility/man/stability_plot.html">stability_plot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">diamonds</span>, </span>
<span>                      lhs<span class="op">=</span><span class="st">'price'</span>, </span>
<span>                      rhs<span class="op">=</span><span class="st">'carat'</span>, </span>
<span>                      coef_grid <span class="op">=</span> <span class="va">coef_grid</span>,</span>
<span>                      control_grid <span class="op">=</span> <span class="va">control_grid</span>,</span>
<span>                      run_from<span class="op">=</span><span class="fl">5</span>,</span>
<span>                      run_to<span class="op">=</span><span class="fl">6</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/starbility/man/stability_plot.html">stability_plot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">diamonds</span>,</span>
<span>               lhs<span class="op">=</span><span class="st">'price'</span>, </span>
<span>               rhs<span class="op">=</span><span class="st">'carat'</span>, </span>
<span>               coef_panel <span class="op">=</span> <span class="va">panels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>               control_panel <span class="op">=</span> <span class="va">panels</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>,</span>
<span>               run_from <span class="op">=</span> <span class="fl">6</span>,</span>
<span>               run_to <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="42-sensitivity-robustness_files/figure-html/unnamed-chunk-4-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>In step 2, we can modify to use other function (e.g., <code>glm</code>)</p>
<div class="sourceCode" id="cb1081"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diamonds</span><span class="op">$</span><span class="va">above_med_price</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">$</span><span class="va">price</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">$</span><span class="va">price</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">base_controls</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Diamond dimensions'</span> <span class="op">=</span> <span class="st">'x + y + z'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">perm_controls</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Depth'</span> <span class="op">=</span> <span class="st">'depth'</span>,</span>
<span>                  <span class="st">'Table width'</span> <span class="op">=</span> <span class="st">'table'</span>,</span>
<span>                  <span class="st">'Clarity'</span> <span class="op">=</span> <span class="st">'clarity'</span><span class="op">)</span></span>
<span><span class="va">lhs_var</span> <span class="op">=</span> <span class="st">'above_med_price'</span></span>
<span><span class="va">rhs_var</span> <span class="op">=</span> <span class="st">'carat'</span></span>
<span></span>
<span><span class="va">grid1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/starbility/man/stability_plot.html">stability_plot</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">diamonds</span>,</span>
<span>    lhs <span class="op">=</span> <span class="va">lhs_var</span>,</span>
<span>    rhs <span class="op">=</span> <span class="va">rhs_var</span>,</span>
<span>    perm <span class="op">=</span> <span class="va">perm_controls</span>,</span>
<span>    base <span class="op">=</span> <span class="va">base_controls</span>,</span>
<span>    fe_always <span class="op">=</span> <span class="cn">F</span>,</span>
<span>    run_to <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create control part of formula</span></span>
<span><span class="va">base_perm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">base_controls</span>, <span class="va">perm_controls</span><span class="op">)</span></span>
<span><span class="va">grid1</span><span class="op">$</span><span class="va">expr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">grid1</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">base_perm</span><span class="op">)</span><span class="op">]</span>, <span class="fl">1</span>,</span>
<span>                   <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html">paste</a></span><span class="op">(</span><span class="va">base_perm</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">base_perm</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html">which</a></span><span class="op">(</span><span class="va">x</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">]</span>, </span>
<span>                           collapse <span class="op">=</span> <span class="st">'+'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Complete formula with LHS and RHS variables</span></span>
<span><span class="va">grid1</span><span class="op">$</span><span class="va">expr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html">paste</a></span><span class="op">(</span><span class="va">lhs_var</span>, <span class="st">'~'</span>, <span class="va">rhs_var</span>, <span class="st">'+'</span>, <span class="va">grid1</span><span class="op">$</span><span class="va">expr</span>, sep <span class="op">=</span> <span class="st">''</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">grid1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="18%">
<col width="5%">
<col width="11%">
<col width="7%">
<col width="5%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th align="right">Diamond dimensions</th>
<th align="right">Depth</th>
<th align="right">Table width</th>
<th align="right">Clarity</th>
<th align="left">np_fe</th>
<th align="left">expr</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left"></td>
<td align="left">above_med_price~carat+x + y + z</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="left"></td>
<td align="left">above_med_price~carat+x + y + z+depth</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left"></td>
<td align="left">above_med_price~carat+x + y + z+table</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left"></td>
<td align="left">above_med_price~carat+x + y + z+depth+table</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left"></td>
<td align="left">above_med_price~carat+x + y + z+clarity</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left"></td>
<td align="left">above_med_price~carat+x + y + z+depth+clarity</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left"></td>
<td align="left">above_med_price~carat+x + y + z+table+clarity</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left"></td>
<td align="left">above_med_price~carat+x + y + z+depth+table+clarity</td>
</tr>
</tbody>
</table></div>
<div class="sourceCode" id="cb1082"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># customer function for the logit model</span></span>
<span><span class="va">starb_logit</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">spec</span>, <span class="va">data</span>, <span class="va">rhs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">spec</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">spec</span>, data<span class="op">=</span><span class="va">data</span>, family<span class="op">=</span><span class="st">'binomial'</span>, weights<span class="op">=</span><span class="va">data</span><span class="op">$</span><span class="va">weight</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">row</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html">which</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">term</span><span class="op">==</span><span class="va">rhs</span><span class="op">)</span></span>
<span>  <span class="va">coef</span> <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'estimate'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">se</span>   <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'std.error'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">p</span>    <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'p.value'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">coef</span>, <span class="va">p</span>, <span class="va">coef</span><span class="op">+</span><span class="fl">1.96</span><span class="op">*</span><span class="va">se</span>, <span class="va">coef</span><span class="op">-</span><span class="fl">1.96</span><span class="op">*</span><span class="va">se</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/starbility/man/stability_plot.html">stability_plot</a></span><span class="op">(</span>grid <span class="op">=</span> <span class="va">grid1</span>,</span>
<span>               data <span class="op">=</span> <span class="va">diamonds</span>, </span>
<span>               lhs <span class="op">=</span> <span class="va">lhs_var</span>, </span>
<span>               rhs <span class="op">=</span> <span class="va">rhs_var</span>,</span>
<span>               model <span class="op">=</span> <span class="va">starb_logit</span>,</span>
<span>               perm <span class="op">=</span> <span class="va">perm_controls</span>,</span>
<span>               base <span class="op">=</span> <span class="va">base_controls</span>,</span>
<span>               fe_always <span class="op">=</span> <span class="cn">F</span>,</span>
<span>               run_from<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="42-sensitivity-robustness_files/figure-html/unnamed-chunk-5-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>For getting other specification (e.g., different CI)</p>
<div class="sourceCode" id="cb1083"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/margins">margins</a></span><span class="op">)</span></span>
<span><span class="va">starb_logit_enhanced</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">spec</span>, <span class="va">data</span>, <span class="va">rhs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Unpack ...</span></span>
<span>  <span class="va">l</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>  <span class="va">get_mfx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">l</span><span class="op">$</span><span class="va">get_mfx</span><span class="op">)</span>, <span class="cn">F</span>, <span class="cn">T</span><span class="op">)</span> <span class="co"># Set a default to F</span></span>
<span>  </span>
<span>  <span class="va">spec</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">get_mfx</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">spec</span>, data<span class="op">=</span><span class="va">data</span>, family<span class="op">=</span><span class="st">'binomial'</span>, weights<span class="op">=</span><span class="va">data</span><span class="op">$</span><span class="va">weight</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/margins/man/margins.html">margins</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="va">summary</span></span>
<span>    <span class="va">row</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html">which</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">factor</span><span class="op">==</span><span class="va">rhs</span><span class="op">)</span></span>
<span>    <span class="va">coef</span> <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'AME'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">se</span>   <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'SE'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">p</span>    <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'p'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">spec</span>, data<span class="op">=</span><span class="va">data</span>, family<span class="op">=</span><span class="st">'binomial'</span>, weights<span class="op">=</span><span class="va">data</span><span class="op">$</span><span class="va">weight</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">row</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html">which</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">term</span><span class="op">==</span><span class="va">rhs</span><span class="op">)</span></span>
<span>    <span class="va">coef</span> <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'estimate'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">se</span>   <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'std.error'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">p</span>    <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'p.value'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">z</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="fl">0.995</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">coef</span>, <span class="va">p</span>, <span class="va">coef</span><span class="op">+</span><span class="va">z</span><span class="op">*</span><span class="va">se</span>, <span class="va">coef</span><span class="op">-</span><span class="va">z</span><span class="op">*</span><span class="va">se</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/starbility/man/stability_plot.html">stability_plot</a></span><span class="op">(</span>grid <span class="op">=</span> <span class="va">grid1</span>,</span>
<span>               data <span class="op">=</span> <span class="va">diamonds</span>, </span>
<span>               lhs <span class="op">=</span> <span class="va">lhs_var</span>, </span>
<span>               rhs <span class="op">=</span> <span class="va">rhs_var</span>,</span>
<span>               model <span class="op">=</span> <span class="va">starb_logit_enhanced</span>,</span>
<span>               get_mfx <span class="op">=</span> <span class="cn">T</span>,</span>
<span>               perm <span class="op">=</span> <span class="va">perm_controls</span>,</span>
<span>               base <span class="op">=</span> <span class="va">base_controls</span>,</span>
<span>               fe_always <span class="op">=</span> <span class="cn">F</span>,</span>
<span>               run_from <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="42-sensitivity-robustness_files/figure-html/unnamed-chunk-6-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>To get your customized plot</p>
<div class="sourceCode" id="cb1084"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dfs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/starbility/man/stability_plot.html">stability_plot</a></span><span class="op">(</span>grid <span class="op">=</span> <span class="va">grid1</span>,</span>
<span>               data <span class="op">=</span> <span class="va">diamonds</span>, </span>
<span>               lhs <span class="op">=</span> <span class="va">lhs_var</span>, </span>
<span>               rhs <span class="op">=</span> <span class="va">rhs_var</span>,</span>
<span>               model <span class="op">=</span> <span class="va">starb_logit_enhanced</span>,</span>
<span>               get_mfx <span class="op">=</span> <span class="cn">T</span>,</span>
<span>               perm <span class="op">=</span> <span class="va">perm_controls</span>,</span>
<span>               base <span class="op">=</span> <span class="va">base_controls</span>,</span>
<span>               fe_always <span class="op">=</span> <span class="cn">F</span>,</span>
<span>               run_from <span class="op">=</span> <span class="fl">3</span>,</span>
<span>               run_to <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">coef_grid_logit</span> <span class="op">=</span> <span class="va">dfs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">control_grid_logit</span> <span class="op">=</span> <span class="va">dfs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">min_space</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span></span>
<span><span class="va">coef_plot</span> <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">coef_grid_logit</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">model</span>,</span>
<span>  y <span class="op">=</span> <span class="va">coef</span>,</span>
<span>  shape <span class="op">=</span> <span class="va">p</span>,</span>
<span>  group <span class="op">=</span> <span class="va">p</span></span>
<span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_linerange</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">error_low</span>, ymax <span class="op">=</span> <span class="va">error_high</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">p</span>, fill <span class="op">=</span> <span class="va">p</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">viridis</span><span class="fu">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html">scale_color_viridis</a></span><span class="op">(</span>discrete <span class="op">=</span> <span class="cn">TRUE</span>, option <span class="op">=</span> <span class="st">"D"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_shape_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">17</span>, <span class="fl">18</span>, <span class="fl">19</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">'dotted'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">'A custom coefficient stability plot!'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Error bars represent 99% confidence intervals"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">min_space</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">coef_grid_logit</span><span class="op">$</span><span class="va">model</span><span class="op">)</span> <span class="op">+</span> <span class="va">min_space</span><span class="op">)</span>,</span>
<span>                  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1</span>, <span class="fl">1.6</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">F</span>, shape <span class="op">=</span> <span class="cn">F</span>, col <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">control_plot</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">control_grid_logit</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">model</span>, y <span class="op">=</span> <span class="va">y</span>, fill<span class="op">=</span><span class="va">value</span><span class="op">)</span>, shape<span class="op">=</span><span class="fl">23</span>, size<span class="op">=</span><span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'#FFFFFF'</span>, <span class="st">'#000000'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html">unique</a></span><span class="op">(</span><span class="va">control_grid_logit</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, </span>
<span>                     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html">unique</a></span><span class="op">(</span><span class="va">control_grid_logit</span><span class="op">$</span><span class="va">key</span><span class="op">)</span>,</span>
<span>                     limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">control_grid_logit</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">control_grid_logit</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">control_grid_logit</span><span class="op">$</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">min_space</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">control_grid_logit</span><span class="op">$</span><span class="va">model</span><span class="op">)</span><span class="op">+</span><span class="va">min_space</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.grid.major.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.minor.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>        axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html">plot_grid</a></span><span class="op">(</span><span class="va">coef_plot</span>, <span class="va">control_plot</span>, rel_heights<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.5</span><span class="op">)</span>, </span>
<span>                   align<span class="op">=</span><span class="st">'v'</span>, ncol<span class="op">=</span><span class="fl">1</span>, axis<span class="op">=</span><span class="st">'b'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="42-sensitivity-robustness_files/figure-html/unnamed-chunk-7-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>To get different model specification (e.g., probit vs. logit)</p>
<div class="sourceCode" id="cb1085"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">starb_probit</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">spec</span>, <span class="va">data</span>, <span class="va">rhs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Unpack ...</span></span>
<span>    <span class="va">l</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">get_mfx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">l</span><span class="op">$</span><span class="va">get_mfx</span><span class="op">)</span>, <span class="cn">F</span>, <span class="cn">T</span><span class="op">)</span> <span class="co"># Set a default to F</span></span>
<span>    </span>
<span>    <span class="va">spec</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">get_mfx</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>            <span class="va">spec</span>,</span>
<span>            data <span class="op">=</span> <span class="va">data</span>,</span>
<span>            family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'probit'</span><span class="op">)</span>,</span>
<span>            weights <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">weight</span></span>
<span>        <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/margins/man/margins.html">margins</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>            <span class="va">summary</span></span>
<span>        <span class="va">row</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html">which</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">factor</span> <span class="op">==</span> <span class="va">rhs</span><span class="op">)</span></span>
<span>        <span class="va">coef</span> <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'AME'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">se</span>   <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'SE'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">p</span>    <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'p'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>            <span class="va">spec</span>,</span>
<span>            data <span class="op">=</span> <span class="va">data</span>,</span>
<span>            family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'probit'</span><span class="op">)</span>,</span>
<span>            weights <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">weight</span></span>
<span>        <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>            <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">row</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html">which</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">term</span> <span class="op">==</span> <span class="va">rhs</span><span class="op">)</span></span>
<span>        <span class="va">coef</span> <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'estimate'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">se</span>   <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'std.error'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">p</span>    <span class="op">=</span> <span class="va">model</span><span class="op">[</span><span class="va">row</span>, <span class="st">'p.value'</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">z</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="fl">0.995</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">coef</span>, <span class="va">p</span>, <span class="va">coef</span> <span class="op">+</span> <span class="va">z</span> <span class="op">*</span> <span class="va">se</span>, <span class="va">coef</span> <span class="op">-</span> <span class="va">z</span> <span class="op">*</span> <span class="va">se</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">probit_dfs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/starbility/man/stability_plot.html">stability_plot</a></span><span class="op">(</span></span>
<span>    grid <span class="op">=</span> <span class="va">grid1</span>,</span>
<span>    data <span class="op">=</span> <span class="va">diamonds</span>,</span>
<span>    lhs <span class="op">=</span> <span class="va">lhs_var</span>,</span>
<span>    rhs <span class="op">=</span> <span class="va">rhs_var</span>,</span>
<span>    model <span class="op">=</span> <span class="va">starb_probit</span>,</span>
<span>    get_mfx <span class="op">=</span> <span class="cn">T</span>,</span>
<span>    perm <span class="op">=</span> <span class="va">perm_controls</span>,</span>
<span>    base <span class="op">=</span> <span class="va">base_controls</span>,</span>
<span>    fe_always <span class="op">=</span> <span class="cn">F</span>,</span>
<span>    run_from <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    run_to <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We'll put the probit DFs on the left, </span></span>
<span> <span class="co">#so we need to adjust the model numbers accordingly</span></span>
<span><span class="co"># so the probit and logit DFs don't plot on top of one another!</span></span>
<span><span class="va">coef_grid_probit</span> <span class="op">=</span> <span class="va">probit_dfs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">model</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">coef_grid_logit</span><span class="op">$</span><span class="va">model</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">control_grid_probit</span> <span class="op">=</span> <span class="va">probit_dfs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">model</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">control_grid_logit</span><span class="op">$</span><span class="va">model</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">coef_grid</span>    <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">coef_grid_logit</span>, <span class="va">coef_grid_probit</span><span class="op">)</span></span>
<span><span class="va">control_grid</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">control_grid_logit</span>, <span class="va">control_grid_probit</span><span class="op">)</span></span>
<span></span>
<span><span class="va">panels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/starbility/man/stability_plot.html">stability_plot</a></span><span class="op">(</span></span>
<span>    coef_grid <span class="op">=</span> <span class="va">coef_grid</span>,</span>
<span>    control_grid <span class="op">=</span> <span class="va">control_grid</span>,</span>
<span>    data <span class="op">=</span> <span class="va">diamonds</span>,</span>
<span>    lhs <span class="op">=</span> <span class="va">lhs_var</span>,</span>
<span>    rhs <span class="op">=</span> <span class="va">rhs_var</span>,</span>
<span>    perm <span class="op">=</span> <span class="va">perm_controls</span>,</span>
<span>    base <span class="op">=</span> <span class="va">base_controls</span>,</span>
<span>    fe_always <span class="op">=</span> <span class="cn">F</span>,</span>
<span>    run_from <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    run_to <span class="op">=</span> <span class="fl">6</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">coef_plot</span> <span class="op">=</span> <span class="va">panels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">8.5</span>,</span>
<span>                                     linetype <span class="op">=</span> <span class="st">'dashed'</span>,</span>
<span>                                     alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span></span>
<span>        geom <span class="op">=</span> <span class="st">'label'</span>,</span>
<span>        x <span class="op">=</span> <span class="fl">4.25</span>,</span>
<span>        y <span class="op">=</span> <span class="fl">1.8</span>,</span>
<span>        label <span class="op">=</span> <span class="st">'Logit models'</span>,</span>
<span>        size <span class="op">=</span> <span class="fl">6</span>,</span>
<span>        fill <span class="op">=</span> <span class="st">'#D3D3D3'</span>,</span>
<span>        alpha <span class="op">=</span> <span class="fl">0.7</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span></span>
<span>        geom <span class="op">=</span> <span class="st">'label'</span>,</span>
<span>        x <span class="op">=</span> <span class="fl">12.75</span>,</span>
<span>        y <span class="op">=</span> <span class="fl">1.8</span>,</span>
<span>        label <span class="op">=</span> <span class="st">'Probit models'</span>,</span>
<span>        size <span class="op">=</span> <span class="fl">6</span>,</span>
<span>        fill <span class="op">=</span> <span class="st">'#D3D3D3'</span>,</span>
<span>        alpha <span class="op">=</span> <span class="fl">0.7</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">1.9</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">control_plot</span> <span class="op">=</span> <span class="va">panels</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">8.5</span>,</span>
<span>                                        linetype <span class="op">=</span> <span class="st">'dashed'</span>,</span>
<span>                                        alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html">plot_grid</a></span><span class="op">(</span></span>
<span>    <span class="va">coef_plot</span>,</span>
<span>    <span class="va">control_plot</span>,</span>
<span>    rel_heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    align <span class="op">=</span> <span class="st">'v'</span>,</span>
<span>    ncol <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    axis <span class="op">=</span> <span class="st">'b'</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="42-sensitivity-robustness_files/figure-html/unnamed-chunk-8-1.png" width="90%" style="display: block; margin: auto;"></div>
</div>
<div id="rdfanalysis" class="section level3" number="42.1.2">
<h3>
<span class="header-section-number">42.1.2</span> rdfanalysis<a class="anchor" aria-label="anchor" href="#rdfanalysis"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Not recommend</li>
</ul>
<p>Installation</p>
<div class="sourceCode" id="cb1086"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"joachim-gassen/rdfanalysis"</span><span class="op">)</span></span></code></pre></div>
<p>Example by the <a href="https://joachim-gassen.github.io/rdfanalysis/">package’s author</a></p>
<div class="sourceCode" id="cb1087"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://joachim-gassen.github.io/rdfanalysis">rdfanalysis</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span><span class="op">(</span><span class="st">"https://joachim-gassen.github.io/data/rdf_ests.RData"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rdfanalysis/man/plot_rdf_spec_curve.html">plot_rdf_spec_curve</a></span><span class="op">(</span><span class="va">ests</span>, <span class="st">"est"</span>, <span class="st">"lb"</span>, <span class="st">"ub"</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="42-sensitivity-robustness_files/figure-html/unnamed-chunk-10-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>Shiny app for readers to explore</p>
<div class="sourceCode" id="cb1088"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rdfanalysis/man/define_design.html">define_design</a></span><span class="op">(</span>steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"read_data"</span>,</span>
<span>                                  <span class="st">"select_idvs"</span>,</span>
<span>                                  <span class="st">"treat_extreme_obs"</span>,</span>
<span>                                  <span class="st">"specify_model"</span>,</span>
<span>                                  <span class="st">"est_model"</span><span class="op">)</span>,</span>
<span>                        rel_dir <span class="op">=</span> <span class="st">"vignettes/case_study_code"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rdfanalysis/man/shiny_rdf_spec_curve.html">shiny_rdf_spec_curve</a></span><span class="op">(</span><span class="va">ests</span>, <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"est"</span>, <span class="st">"lb"</span>, <span class="st">"ub"</span><span class="op">)</span>,</span>
<span>                     <span class="va">design</span>, <span class="st">"vignettes/case_study_code"</span>,</span>
<span>                     <span class="st">"https://joachim-gassen.github.io/data/wb_new.csv"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="coefficient-stability" class="section level2" number="42.2">
<h2>
<span class="header-section-number">42.2</span> Coefficient stability<a class="anchor" aria-label="anchor" href="#coefficient-stability"><i class="fas fa-link"></i></a>
</h2>
<p><span class="citation">(<a href="references.html#ref-oster2019unobservable">Oster 2019</a>)</span></p>
<ul>
<li><p>Coefficient stability can be evident against omitted variable bias.</p></li>
<li><p>But coefficient stability alone can be misleading, but combing with <span class="math inline">\(R^2\)</span> movement, it can become informative.</p></li>
</ul>
<p>Packages</p>
<ul>
<li><p><code>mplot</code>: graphical Model stability and Variable Selection</p></li>
<li><p><code>robomit</code>: Robustness checks for omitted variable bias (implementation of</p></li>
</ul>
<div class="sourceCode" id="cb1089"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">robomit</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># estimate beta </span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/robomit/man/o_beta.html">o_beta</a></span><span class="op">(</span></span>
<span>  y     <span class="op">=</span> <span class="st">"mpg"</span>,       <span class="co"># dependent variable</span></span>
<span>  x     <span class="op">=</span> <span class="st">"wt"</span>,        <span class="co"># independent treatment variable</span></span>
<span>  con   <span class="op">=</span> <span class="st">"hp + qsec"</span>, <span class="co"># related control variables</span></span>
<span>  delta <span class="op">=</span> <span class="fl">1</span>,           <span class="co"># delta</span></span>
<span>  R2max <span class="op">=</span> <span class="fl">0.9</span>,         <span class="co"># maximum R-square</span></span>
<span>  type  <span class="op">=</span> <span class="st">"lm"</span>,        <span class="co"># model type</span></span>
<span>  data  <span class="op">=</span> <span class="va">mtcars</span>       <span class="co"># dataset</span></span>
<span><span class="op">)</span> </span>
<span><span class="co">#&gt; # A tibble: 10 × 2</span></span>
<span><span class="co">#&gt;    Name                           Value</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;                          &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 beta*                         -2.00 </span></span>
<span><span class="co">#&gt;  2 (beta*-beta controlled)^2      5.56 </span></span>
<span><span class="co">#&gt;  3 Alternative Solution 1        -7.01 </span></span>
<span><span class="co">#&gt;  4 (beta[AS1]-beta controlled)^2  7.05 </span></span>
<span><span class="co">#&gt;  5 Uncontrolled Coefficient      -5.34 </span></span>
<span><span class="co">#&gt;  6 Controlled Coefficient        -4.36 </span></span>
<span><span class="co">#&gt;  7 Uncontrolled R-square          0.753</span></span>
<span><span class="co">#&gt;  8 Controlled R-square            0.835</span></span>
<span><span class="co">#&gt;  9 Max R-square                   0.9  </span></span>
<span><span class="co">#&gt; 10 delta                          1</span></span></code></pre></div>
</div>
<div id="omitted-variable-bias-quantification" class="section level2" number="42.3">
<h2>
<span class="header-section-number">42.3</span> Omitted Variable Bias Quantification<a class="anchor" aria-label="anchor" href="#omitted-variable-bias-quantification"><i class="fas fa-link"></i></a>
</h2>
<p>To quantify the bias needed to change the substantive conclusion from a causal inference study.</p>
<div class="sourceCode" id="cb1090"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/konfound-project/konfound">konfound</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://konfound-it.org/konfound/reference/pkonfound.html">pkonfound</a></span><span class="op">(</span></span>
<span>    est_eff <span class="op">=</span> <span class="fl">5</span>, </span>
<span>    std_err <span class="op">=</span> <span class="fl">2</span>, </span>
<span>    n_obs <span class="op">=</span> <span class="fl">1000</span>, </span>
<span>    n_covariates <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Robustness of Inference to Replacement (RIR):</span></span>
<span><span class="co">#&gt; RIR = 215</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; To invalidate the inference of an effect using the threshold of 3.925 for</span></span>
<span><span class="co">#&gt; statistical significance (with null hypothesis = 0 and alpha = 0.05), 21.506%</span></span>
<span><span class="co">#&gt; of the (5) estimate would have to be due to bias. This implies that to</span></span>
<span><span class="co">#&gt; invalidate the inference one would expect to have to replace 215 (21.506%)</span></span>
<span><span class="co">#&gt; observations with data points for which the effect is 0 (RIR = 215).</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See Frank et al. (2013) for a description of the method.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Citation: Frank, K.A., Maroulis, S., Duong, M., and Kelcey, B. (2013).</span></span>
<span><span class="co">#&gt; What would it take to change an inference?</span></span>
<span><span class="co">#&gt; Using Rubin's causal model to interpret the robustness of causal inferences.</span></span>
<span><span class="co">#&gt; Education, Evaluation and Policy Analysis, 35 437-460.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Accuracy of results increases with the number of decimals reported.</span></span>
<span></span>
<span><span class="fu"><a href="https://konfound-it.org/konfound/reference/pkonfound.html">pkonfound</a></span><span class="op">(</span></span>
<span>    est_eff <span class="op">=</span> <span class="fl">5</span>, </span>
<span>    std_err <span class="op">=</span> <span class="fl">2</span>, </span>
<span>    n_obs <span class="op">=</span> <span class="fl">1000</span>, </span>
<span>    n_covariates <span class="op">=</span> <span class="fl">5</span>, </span>
<span>    to_return <span class="op">=</span> <span class="st">"thresh_plot"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="42-sensitivity-robustness_files/figure-html/unnamed-chunk-13-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb1091"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://konfound-it.org/konfound/reference/pkonfound.html">pkonfound</a></span><span class="op">(</span></span>
<span>    est_eff <span class="op">=</span> <span class="fl">5</span>, </span>
<span>    std_err <span class="op">=</span> <span class="fl">2</span>, </span>
<span>    n_obs <span class="op">=</span> <span class="fl">1000</span>, </span>
<span>    n_covariates <span class="op">=</span> <span class="fl">5</span>, </span>
<span>    to_return <span class="op">=</span> <span class="st">"corr_plot"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="42-sensitivity-robustness_files/figure-html/unnamed-chunk-13-2.png" width="90%" style="display: block; margin: auto;"></div>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="exploratory-data-analysis.html"><span class="header-section-number">41</span> Exploratory Data Analysis</a></div>
<div class="next"><a href="replication-and-synthetic-data.html"><span class="header-section-number">43</span> Replication and Synthetic Data</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#sensitivity-analysis-robustness-check"><span class="header-section-number">42</span> Sensitivity Analysis/ Robustness Check</a></li>
<li>
<a class="nav-link" href="#specification-curve"><span class="header-section-number">42.1</span> Specification curve</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#starbility"><span class="header-section-number">42.1.1</span> starbility</a></li>
<li><a class="nav-link" href="#rdfanalysis"><span class="header-section-number">42.1.2</span> rdfanalysis</a></li>
</ul>
</li>
<li><a class="nav-link" href="#coefficient-stability"><span class="header-section-number">42.2</span> Coefficient stability</a></li>
<li><a class="nav-link" href="#omitted-variable-bias-quantification"><span class="header-section-number">42.3</span> Omitted Variable Bias Quantification</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/mikenguyen13/data_analysis/blob/main/42-sensitivity-robustness.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/mikenguyen13/data_analysis/edit/main/42-sensitivity-robustness.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>A Guide on Data Analysis</strong>" was written by Mike Nguyen. It was last built on 2025-05-14.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
